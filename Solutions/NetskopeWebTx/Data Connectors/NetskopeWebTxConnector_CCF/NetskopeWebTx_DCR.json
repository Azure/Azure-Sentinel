{
    "name": "NetskopeWebTx",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "[parameters('workspace-location')]",
    "properties": {
        "dataCollectionEndpointId": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
        "streamDeclarations": {
            "Custom-NetskopeWebTx": {
                "columns": [
                    { "name": "date", "type": "string", "description": "Event date" },
                    { "name": "time", "type": "string", "description": "Event time" },
                    { "name": "time-taken", "type": "string", "description": "Time taken for request" },
                    { "name": "cs-bytes", "type": "string", "description": "Client to server bytes" },
                    { "name": "sc-bytes", "type": "string", "description": "Server to client bytes" },
                    { "name": "bytes", "type": "string", "description": "Total bytes" },
                    { "name": "c-ip", "type": "string", "description": "Client IP address" },
                    { "name": "s-ip", "type": "string", "description": "Server IP address" },
                    { "name": "cs-username", "type": "string", "description": "Username" },
                    { "name": "cs-method", "type": "string", "description": "HTTP method" },
                    { "name": "cs-uri-scheme", "type": "string", "description": "URI scheme" },
                    { "name": "cs-uri-query", "type": "string", "description": "URI query string" },
                    { "name": "cs-user-agent", "type": "string", "description": "User agent" },
                    { "name": "cs-content-type", "type": "string", "description": "Request content type" },
                    { "name": "sc-status", "type": "string", "description": "HTTP status code" },
                    { "name": "sc-content-type", "type": "string", "description": "Response content type" },
                    { "name": "cs-dns", "type": "string", "description": "DNS name" },
                    { "name": "cs-host", "type": "string", "description": "Host name" },
                    { "name": "cs-uri", "type": "string", "description": "URI" },
                    { "name": "cs-uri-port", "type": "string", "description": "URI port" },
                    { "name": "cs-referer", "type": "string", "description": "Referer" },
                    { "name": "x-cs-session-id", "type": "string", "description": "Session ID" },
                    { "name": "x-cs-access-method", "type": "string", "description": "Access method" },
                    { "name": "x-cs-app", "type": "string", "description": "Application name" },
                    { "name": "x-s-country", "type": "string", "description": "Server country" },
                    { "name": "x-s-latitude", "type": "string", "description": "Server latitude" },
                    { "name": "x-s-longitude", "type": "string", "description": "Server longitude" },
                    { "name": "x-s-location", "type": "string", "description": "Server location" },
                    { "name": "x-s-region", "type": "string", "description": "Server region" },
                    { "name": "x-s-zipcode", "type": "string", "description": "Server zipcode" },
                    { "name": "x-c-country", "type": "string", "description": "Client country" },
                    { "name": "x-c-latitude", "type": "string", "description": "Client latitude" },
                    { "name": "x-c-longitude", "type": "string", "description": "Client longitude" },
                    { "name": "x-c-location", "type": "string", "description": "Client location" },
                    { "name": "x-c-region", "type": "string", "description": "Client region" },
                    { "name": "x-c-zipcode", "type": "string", "description": "Client zipcode" },
                    { "name": "x-c-os", "type": "string", "description": "Client OS" },
                    { "name": "x-c-browser", "type": "string", "description": "Client browser" },
                    { "name": "x-c-browser-version", "type": "string", "description": "Client browser version" },
                    { "name": "x-c-device", "type": "string", "description": "Client device type" },
                    { "name": "x-cs-site", "type": "string", "description": "Site" },
                    { "name": "x-cs-timestamp", "type": "string", "description": "Event timestamp (epoch)" },
                    { "name": "x-cs-page-id", "type": "string", "description": "Page ID" },
                    { "name": "x-cs-userip", "type": "string", "description": "User IP" },
                    { "name": "x-cs-traffic-type", "type": "string", "description": "Traffic type" },
                    { "name": "x-cs-tunnel-id", "type": "string", "description": "Tunnel ID" },
                    { "name": "x-category", "type": "string", "description": "URL category" },
                    { "name": "x-other-category", "type": "string", "description": "Other URL category" },
                    { "name": "x-type", "type": "string", "description": "Event type" },
                    { "name": "x-server-ssl-err", "type": "string", "description": "Server SSL error" },
                    { "name": "x-client-ssl-err", "type": "string", "description": "Client SSL error" },
                    { "name": "x-transaction-id", "type": "string", "description": "Transaction ID" },
                    { "name": "x-request-id", "type": "string", "description": "Request ID" },
                    { "name": "x-cs-sni", "type": "string", "description": "SNI" },
                    { "name": "x-cs-domain-fronted-sni", "type": "string", "description": "Domain fronted SNI" },
                    { "name": "x-category-id", "type": "string", "description": "Category ID" },
                    { "name": "x-other-category-id", "type": "string", "description": "Other category ID" },
                    { "name": "x-sr-headers-name", "type": "string", "description": "Response headers name" },
                    { "name": "x-sr-headers-value", "type": "string", "description": "Response headers value" },
                    { "name": "x-cs-ssl-ja3", "type": "string", "description": "SSL JA3 fingerprint" },
                    { "name": "x-sr-ssl-ja3s", "type": "string", "description": "SSL JA3S fingerprint" },
                    { "name": "x-ssl-bypass", "type": "string", "description": "SSL bypass flag" },
                    { "name": "x-ssl-bypass-reason", "type": "string", "description": "SSL bypass reason" },
                    { "name": "x-r-cert-subject-cn", "type": "string", "description": "Remote cert subject CN" },
                    { "name": "x-r-cert-issuer-cn", "type": "string", "description": "Remote cert issuer CN" },
                    { "name": "x-r-cert-startdate", "type": "string", "description": "Remote cert start date" },
                    { "name": "x-r-cert-enddate", "type": "string", "description": "Remote cert end date" },
                    { "name": "x-r-cert-valid", "type": "string", "description": "Remote cert valid" },
                    { "name": "x-r-cert-expired", "type": "string", "description": "Remote cert expired" },
                    { "name": "x-r-cert-untrusted-root", "type": "string", "description": "Remote cert untrusted root" },
                    { "name": "x-r-cert-incomplete-chain", "type": "string", "description": "Remote cert incomplete chain" },
                    { "name": "x-r-cert-self-signed", "type": "string", "description": "Remote cert self-signed" },
                    { "name": "x-r-cert-revoked", "type": "string", "description": "Remote cert revoked" },
                    { "name": "x-r-cert-revocation-check", "type": "string", "description": "Remote cert revocation check" },
                    { "name": "x-r-cert-mismatch", "type": "string", "description": "Remote cert mismatch" },
                    { "name": "x-cs-ssl-fronting-error", "type": "string", "description": "SSL fronting error" },
                    { "name": "x-cs-ssl-handshake-error", "type": "string", "description": "Client SSL handshake error" },
                    { "name": "x-sr-ssl-handshake-error", "type": "string", "description": "Server SSL handshake error" },
                    { "name": "x-sr-ssl-client-certificate-error", "type": "string", "description": "Server SSL client cert error" },
                    { "name": "x-sr-ssl-malformed-ssl", "type": "string", "description": "Server SSL malformed" },
                    { "name": "x-s-custom-signing-ca-error", "type": "string", "description": "Custom signing CA error" },
                    { "name": "x-cs-ssl-engine-action", "type": "string", "description": "Client SSL engine action" },
                    { "name": "x-cs-ssl-engine-action-reason", "type": "string", "description": "Client SSL engine action reason" },
                    { "name": "x-sr-ssl-engine-action", "type": "string", "description": "Server SSL engine action" },
                    { "name": "x-sr-ssl-engine-action-reason", "type": "string", "description": "Server SSL engine action reason" },
                    { "name": "x-ssl-policy-src-ip", "type": "string", "description": "SSL policy source IP" },
                    { "name": "x-ssl-policy-dst-ip", "type": "string", "description": "SSL policy destination IP" },
                    { "name": "x-ssl-policy-dst-host", "type": "string", "description": "SSL policy destination host" },
                    { "name": "x-ssl-policy-dst-host-source", "type": "string", "description": "SSL policy destination host source" },
                    { "name": "x-ssl-policy-categories", "type": "string", "description": "SSL policy categories" },
                    { "name": "x-ssl-policy-action", "type": "string", "description": "SSL policy action" },
                    { "name": "x-ssl-policy-name", "type": "string", "description": "SSL policy name" },
                    { "name": "x-cs-ssl-version", "type": "string", "description": "Client SSL version" },
                    { "name": "x-cs-ssl-cipher", "type": "string", "description": "Client SSL cipher" },
                    { "name": "x-sr-ssl-version", "type": "string", "description": "Server SSL version" },
                    { "name": "x-sr-ssl-cipher", "type": "string", "description": "Server SSL cipher" },
                    { "name": "x-cs-src-ip-egress", "type": "string", "description": "Client source IP egress" },
                    { "name": "x-s-dp-name", "type": "string", "description": "Data plane name" },
                    { "name": "x-cs-src-ip", "type": "string", "description": "Client source IP" },
                    { "name": "x-cs-src-port", "type": "string", "description": "Client source port" },
                    { "name": "x-cs-dst-ip", "type": "string", "description": "Client destination IP" },
                    { "name": "x-cs-dst-port", "type": "string", "description": "Client destination port" },
                    { "name": "x-sr-src-ip", "type": "string", "description": "Server source IP" },
                    { "name": "x-sr-src-port", "type": "string", "description": "Server source port" },
                    { "name": "x-sr-dst-ip", "type": "string", "description": "Server destination IP" },
                    { "name": "x-sr-dst-port", "type": "string", "description": "Server destination port" },
                    { "name": "x-cs-ip-connect-xff", "type": "string", "description": "Connect X-Forwarded-For" },
                    { "name": "x-cs-ip-xff", "type": "string", "description": "X-Forwarded-For" },
                    { "name": "x-cs-connect-host", "type": "string", "description": "Connect host" },
                    { "name": "x-cs-connect-port", "type": "string", "description": "Connect port" },
                    { "name": "x-cs-connect-user-agent", "type": "string", "description": "Connect user agent" },
                    { "name": "x-cs-url", "type": "string", "description": "Full URL" },
                    { "name": "x-cs-uri-path", "type": "string", "description": "URI path" },
                    { "name": "x-cs-http-version", "type": "string", "description": "HTTP version" },
                    { "name": "rs-status", "type": "string", "description": "Real server status" },
                    { "name": "x-cs-app-category", "type": "string", "description": "App category" },
                    { "name": "x-cs-app-cci", "type": "string", "description": "App Cloud Confidence Index" },
                    { "name": "x-cs-app-ccl", "type": "string", "description": "App Cloud Confidence Level" },
                    { "name": "x-cs-app-tags", "type": "string", "description": "App tags" },
                    { "name": "x-cs-app-suite", "type": "string", "description": "App suite" },
                    { "name": "x-cs-app-instance-id", "type": "string", "description": "App instance ID" },
                    { "name": "x-cs-app-instance-name", "type": "string", "description": "App instance name" },
                    { "name": "x-cs-app-instance-tag", "type": "string", "description": "App instance tag" },
                    { "name": "x-cs-app-activity", "type": "string", "description": "App activity" },
                    { "name": "x-cs-app-from-user", "type": "string", "description": "App from user" },
                    { "name": "x-cs-app-to-user", "type": "string", "description": "App to user" },
                    { "name": "x-cs-app-object-type", "type": "string", "description": "App object type" },
                    { "name": "x-cs-app-object-name", "type": "string", "description": "App object name" },
                    { "name": "x-cs-app-object-id", "type": "string", "description": "App object ID" },
                    { "name": "x-rs-file-type", "type": "string", "description": "File type" },
                    { "name": "x-rs-file-category", "type": "string", "description": "File category" },
                    { "name": "x-rs-file-language", "type": "string", "description": "File language" },
                    { "name": "x-rs-file-size", "type": "string", "description": "File size" },
                    { "name": "x-rs-file-md5", "type": "string", "description": "File MD5 hash" },
                    { "name": "x-rs-file-sha256", "type": "string", "description": "File SHA256 hash" },
                    { "name": "x-error", "type": "string", "description": "Error message" },
                    { "name": "x-c-local-time", "type": "string", "description": "Client local time" },
                    { "name": "x-policy-action", "type": "string", "description": "Policy action" },
                    { "name": "x-policy-name", "type": "string", "description": "Policy name" },
                    { "name": "x-policy-src-ip", "type": "string", "description": "Policy source IP" },
                    { "name": "x-policy-dst-ip", "type": "string", "description": "Policy destination IP" },
                    { "name": "x-policy-dst-host", "type": "string", "description": "Policy destination host" },
                    { "name": "x-policy-dst-host-source", "type": "string", "description": "Policy destination host source" },
                    { "name": "x-policy-justification-type", "type": "string", "description": "Policy justification type" },
                    { "name": "x-policy-justification-reason", "type": "string", "description": "Policy justification reason" },
                    { "name": "x-sc-notification-name", "type": "string", "description": "Notification name" }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "[variables('workspaceResourceId')]",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": ["Custom-NetskopeWebTx"],
                "destinations": ["clv2ws1"],
                "transformKql": "source | project TimeGenerated = datetime(1970-01-01) + totimespan(tolong(['x-cs-timestamp']) * 1sec), Date = ['date'], Time = ['time'], XCsTimestamp = tolong(['x-cs-timestamp']), TimeTaken = toint(['time-taken']), CsBytes = toint(['cs-bytes']), ScBytes = toint(['sc-bytes']), Bytes = toint(['bytes']), CIp = ['c-ip'], SIp = ['s-ip'], CsUsername = ['cs-username'], CsMethod = ['cs-method'], CsUriScheme = ['cs-uri-scheme'], CsUriQuery = ['cs-uri-query'], CsUserAgent = ['cs-user-agent'], CsContentType = ['cs-content-type'], ScStatus = toint(['sc-status']), ScContentType = ['sc-content-type'], CsDns = ['cs-dns'], CsHost = ['cs-host'], CsUri = ['cs-uri'], CsUriPort = toint(['cs-uri-port']), CsReferer = ['cs-referer'], XCsSessionId = ['x-cs-session-id'], XCsAccessMethod = ['x-cs-access-method'], XCsApp = ['x-cs-app'], XSCountry = ['x-s-country'], XSLatitude = toreal(['x-s-latitude']), XSLongitude = toreal(['x-s-longitude']), XSLocation = ['x-s-location'], XSRegion = ['x-s-region'], XSZipcode = toint(['x-s-zipcode']), XCCountry = ['x-c-country'], XCLatitude = toreal(['x-c-latitude']), XCLongitude = toreal(['x-c-longitude']), XCLocation = ['x-c-location'], XCRegion = ['x-c-region'], XCZipcode = toint(['x-c-zipcode']), XCOs = ['x-c-os'], XCBrowser = ['x-c-browser'], XCBrowserVersion = toint(['x-c-browser-version']), XCDevice = ['x-c-device'], XCsSite = ['x-cs-site'], XCsPageId = ['x-cs-page-id'], XCsUserIp = ['x-cs-userip'], XCsTrafficType = ['x-cs-traffic-type'], XCsTunnelId = ['x-cs-tunnel-id'], XCategory = ['x-category'], XOtherCategory = ['x-other-category'], XType = ['x-type'], XServerSslErr = ['x-server-ssl-err'], XClientSslErr = ['x-client-ssl-err'], XTransactionId = ['x-transaction-id'], XRequestId = ['x-request-id'], XCsSni = ['x-cs-sni'], XCsDomainFrontedSni = ['x-cs-domain-fronted-sni'], XCategoryId = toint(['x-category-id']), XOtherCategoryId = ['x-other-category-id'], XSrHeadersName = ['x-sr-headers-name'], XSrHeadersValue = ['x-sr-headers-value'], XCsSslJa3 = ['x-cs-ssl-ja3'], XSrSslJa3S = ['x-sr-ssl-ja3s'], XSslBypass = ['x-ssl-bypass'], XSslBypassReason = ['x-ssl-bypass-reason'], XRCertSubjectCn = ['x-r-cert-subject-cn'], XRCertIssuerCn = ['x-r-cert-issuer-cn'], XRCertStartdate = ['x-r-cert-startdate'], XRCertEnddate = ['x-r-cert-enddate'], XRCertValid = ['x-r-cert-valid'], XRCertExpired = ['x-r-cert-expired'], XRCertUntrustedRoot = ['x-r-cert-untrusted-root'], XRCertIncompleteChain = ['x-r-cert-incomplete-chain'], XRCertSelfSigned = ['x-r-cert-self-signed'], XRCertRevoked = ['x-r-cert-revoked'], XRCertRevocationCheck = ['x-r-cert-revocation-check'], XRCertMismatch = ['x-r-cert-mismatch'], XCsSslFrontingError = ['x-cs-ssl-fronting-error'], XCsSslHandshakeError = ['x-cs-ssl-handshake-error'], XSrSslHandshakeError = ['x-sr-ssl-handshake-error'], XSrSslClientCertificateError = ['x-sr-ssl-client-certificate-error'], XSrSslMalformedSsl = ['x-sr-ssl-malformed-ssl'], XSCustomSigningCaError = ['x-s-custom-signing-ca-error'], XCsSslEngineAction = ['x-cs-ssl-engine-action'], XCsSslEngineActionReason = ['x-cs-ssl-engine-action-reason'], XSrSslEngineAction = ['x-sr-ssl-engine-action'], XSrSslEngineActionReason = ['x-sr-ssl-engine-action-reason'], XSslPolicySrcIp = ['x-ssl-policy-src-ip'], XSslPolicyDstIp = ['x-ssl-policy-dst-ip'], XSslPolicyDstHost = ['x-ssl-policy-dst-host'], XSslPolicyDstHostSource = ['x-ssl-policy-dst-host-source'], XSslPolicyCategories = ['x-ssl-policy-categories'], XSslPolicyAction = ['x-ssl-policy-action'], XSslPolicyName = ['x-ssl-policy-name'], XCsSslVersion = ['x-cs-ssl-version'], XCsSslCipher = ['x-cs-ssl-cipher'], XSrSslVersion = ['x-sr-ssl-version'], XSrSslCipher = ['x-sr-ssl-cipher'], XCsSrcIpEgress = ['x-cs-src-ip-egress'], XSDpName = ['x-s-dp-name'], XCsSrcIp = ['x-cs-src-ip'], XCsSrcPort = toint(['x-cs-src-port']), XCsDstIp = ['x-cs-dst-ip'], XCsDstPort = toint(['x-cs-dst-port']), XSrSrcIp = ['x-sr-src-ip'], XSrSrcPort = ['x-sr-src-port'], XSrDstIp = ['x-sr-dst-ip'], XSrDstPort = toint(['x-sr-dst-port']), XCsIpConnectXff = ['x-cs-ip-connect-xff'], XCsIpXff = ['x-cs-ip-xff'], XCsConnectHost = ['x-cs-connect-host'], XCsConnectPort = ['x-cs-connect-port'], XCsConnectUserAgent = ['x-cs-connect-user-agent'], XCsUrl = ['x-cs-url'], XCsUriPath = ['x-cs-uri-path'], XCsHttpVersion = ['x-cs-http-version'], RsStatus = toint(['rs-status']), XCsAppCategory = ['x-cs-app-category'], XCsAppCci = toint(['x-cs-app-cci']), XCsAppCcl = ['x-cs-app-ccl'], XCsAppTags = ['x-cs-app-tags'], XCsAppSuite = ['x-cs-app-suite'], XCsAppInstanceId = ['x-cs-app-instance-id'], XCsAppInstanceName = ['x-cs-app-instance-name'], XCsAppInstanceTag = ['x-cs-app-instance-tag'], XCsAppActivity = ['x-cs-app-activity'], XCsAppFromUser = ['x-cs-app-from-user'], XCsAppToUser = ['x-cs-app-to-user'], XCsAppObjectType = ['x-cs-app-object-type'], XCsAppObjectName = ['x-cs-app-object-name'], XCsAppObjectId = ['x-cs-app-object-id'], XRsFileType = ['x-rs-file-type'], XRsFileCategory = ['x-rs-file-category'], XRsFileLanguage = ['x-rs-file-language'], XRsFileSize = toint(['x-rs-file-size']), XRsFileMd5 = ['x-rs-file-md5'], XRsFileSha256 = ['x-rs-file-sha256'], XError = ['x-error'], XCLocalTime = ['x-c-local-time'], XPolicyAction = ['x-policy-action'], XPolicyName = ['x-policy-name'], XPolicySrcIp = ['x-policy-src-ip'], XPolicyDstIp = ['x-policy-dst-ip'], XPolicyDstHost = ['x-policy-dst-host'], XPolicyDstHostSource = ['x-policy-dst-host-source'], XPolicyJustificationType = ['x-policy-justification-type'], XPolicyJustificationReason = ['x-policy-justification-reason'], XScNotificationName = ['x-sc-notification-name']",
                "outputStream": "Custom-NetskopeWebTransactions_CL"
            }
        ]
    }
}
