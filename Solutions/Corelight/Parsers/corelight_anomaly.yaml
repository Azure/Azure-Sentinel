id: d3c08d98-7099-48cc-898c-ab9fc5d510ad
Function:
  Title: Corelight Connection Events
  Version: '1.0.0'
  LastUpdated: '2025-09-23'
Category: Microsoft Sentinel Parser
FunctionName: corelight_anomaly
FunctionAlias: corelight_anomaly
FunctionQuery: |
    let dummy_table = datatable(TimeGenerated: datetime, uid_s: string) [];
    let corelight_anomaly = view () {
        union isfuzzy=true
            Corelight_v2_anomaly_CL,
            dummy_table
        | summarize arg_max(TimeGenerated, *) by uid_s
        | join kind=leftouter 
            (corelight_conn
            | project uid, local_orig, local_resp
            )
            on $left.uid_s == $right.uid
        | project-away uid
        | extend
            path = column_ifexists("_path_s", ""),
            system_name = column_ifexists("_system_name_s", ""),
            write_ts = column_ifexists("_write_ts_t", datetime(null)),
            uid = column_ifexists("uid_s", ""),
            entity = column_ifexists("entity_s", ""),
            original_entity = column_ifexists("original_entity_s", ""),
            entity_training_items = column_ifexists("entity_training_items_s", ""),
            item = column_ifexists("item_s", ""),
            item_score = column_ifexists("item_score_d", real(null)),
            item_assoc_entities = column_ifexists("item_assoc_entities_s", ""),
            item_assoc_entities_similarity = coalesce(tostring(column_ifexists("item_assoc_entities_similarity_d", real(null))), column_ifexists("item_assoc_entities_similarity_s", "")),
            ignorable = column_ifexists("ignorable_b", bool(null)),
            history_days = column_ifexists("history_days_d", real(null)),
            history = column_ifexists("history_d", real(null)),
            nn1_entities = column_ifexists("nn1_entities_s", ""),
            nn1_entity_similarity = column_ifexists("nn1_entity_similarity_d", real(null)),
            nn1_train_items = column_ifexists("nn1_train_items_s", ""),
            nn1_pred_items = column_ifexists("nn1_pred_items_s", ""),
            nn2_entities = column_ifexists("nn2_entities_s", ""),
            nn2_entity_similarity = column_ifexists("nn2_entity_similarity_d", real(null)),
            nn2_train_items = column_ifexists("nn2_train_items_s", ""),
            nn2_pred_items = column_ifexists("nn2_pred_items_s", ""),
            nn3_entities = column_ifexists("nn3_entities_s", ""),
            nn3_entity_similarity = column_ifexists("nn3_entity_similarity_d", real(null)),
            nn3_train_items = column_ifexists("nn3_train_items_s", ""),
            nn3_pred_items = column_ifexists("nn3_pred_items_s", ""),
            nn4_entities = column_ifexists("nn4_entities_s", ""),
            nn4_entity_similarity = column_ifexists("nn4_entity_similarity_d", real(null)),
            nn4_train_items = column_ifexists("nn4_train_items_s", ""),
            nn4_pred_items = column_ifexists("nn4_pred_items_s", ""),
            nn5_entities = column_ifexists("nn5_entities_s", ""),
            nn5_entity_similarity = column_ifexists("nn5_entity_similarity_d", real(null)),
            nn5_train_items = column_ifexists("nn5_train_items_s", ""),
            nn5_pred_items = column_ifexists("nn5_pred_items_s", ""),
            nn6_entities = column_ifexists("nn6_entities_s", ""),
            nn6_entity_similarity = column_ifexists("nn6_entity_similarity_d", real(null)),
            nn6_train_items = column_ifexists("nn6_train_items_s", ""),
            nn6_pred_items = column_ifexists("nn6_pred_items_s", ""),
            nn7_entities = column_ifexists("nn7_entities_s", ""),
            nn7_entity_similarity = column_ifexists("nn7_entity_similarity_d", real(null)),
            nn7_train_items = column_ifexists("nn7_train_items_s", ""),
            nn7_pred_items = column_ifexists("nn7_pred_items_s", ""),
            nn8_entities = column_ifexists("nn8_entities_s", ""),
            nn8_entity_similarity = column_ifexists("nn8_entity_similarity_d", real(null)),
            nn8_train_items = column_ifexists("nn8_train_items_s", ""),
            nn8_pred_items = column_ifexists("nn8_pred_items_s", ""),
            nn9_entities = column_ifexists("nn9_entities_s", ""),
            nn9_entity_similarity = column_ifexists("nn9_entity_similarity_d", real(null)),
            nn9_train_items = column_ifexists("nn9_train_items_s", ""),
            nn9_pred_items = column_ifexists("nn9_pred_items_s", ""),
            nn10_entities = column_ifexists("nn10_entities_s", ""),
            nn10_entity_similarity = column_ifexists("nn10_entity_similarity_d", real(null)),
            nn10_train_items = column_ifexists("nn10_train_items_s", ""),
            nn10_pred_items = column_ifexists("nn10_pred_items_s", ""),
            anomaly_type = column_ifexists("anomaly_type_s", ""),
            timestamp = column_ifexists("_timestamp_s", ""),
            version = column_ifexists("_version_s", ""),
            usecase_description = coalesce(column_ifexists("usecase_description_s", ""), column_ifexists("use_case_description_s", "")),
            usecase = coalesce(column_ifexists("usecase_s", ""), column_ifexists("use_case_s", ""))
        | extend
            EventVendor = "Corelight",
            EventProduct = "CorelightSensor",
            EventType = "anomaly",
            ts = TimeGenerated
        | extend
            is_dest_internal_ip = iff(local_resp == true, "true", "false"),
            is_src_internal_ip = iff(local_orig == true, "true", "false"),
            direction = case(
                    local_orig == "true" and local_resp == "true",
                    "internal", 
                    local_orig == "true" and local_resp == "false",
                    "outbound", 
                    local_orig == "false" and local_resp == "false",
                    "external", 
                    local_orig == "false" and local_resp == "true",
                    "inbound", 
                    "unknown"
                )
        | project
            TimeGenerated,
            path,
            system_name,
            write_ts,
            uid,
            entity,
            original_entity,
            entity_training_items,
            item,
            item_score,
            item_assoc_entities,
            item_assoc_entities_similarity,
            ignorable,
            history_days,
            history,
            nn1_entities,
            nn1_entity_similarity,
            nn1_train_items,
            nn1_pred_items,
            nn2_entities,
            nn2_entity_similarity,
            nn2_train_items,
            nn2_pred_items,
            nn3_entities,
            nn3_entity_similarity,
            nn3_train_items,
            nn3_pred_items,
            nn4_entities,
            nn4_entity_similarity,
            nn4_train_items,
            nn4_pred_items,
            nn5_entities,
            nn5_entity_similarity,
            nn5_train_items,
            nn5_pred_items,
            nn6_entities,
            nn6_entity_similarity,
            nn6_train_items,
            nn6_pred_items,
            nn7_entities,
            nn7_entity_similarity,
            nn7_train_items,
            nn7_pred_items,
            nn8_entities,
            nn8_entity_similarity,
            nn8_train_items,
            nn8_pred_items,
            nn9_entities,
            nn9_entity_similarity,
            nn9_train_items,
            nn9_pred_items,
            nn10_entities,
            nn10_entity_similarity,
            nn10_train_items,
            nn10_pred_items,
            anomaly_type,
            timestamp,
            version,
            usecase_description,
            usecase,
            EventVendor,
            EventProduct,
            EventType,
            ts,
            is_dest_internal_ip,
            is_src_internal_ip,
            direction
    };
    corelight_anomaly