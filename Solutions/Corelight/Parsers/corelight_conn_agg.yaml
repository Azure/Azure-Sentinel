id: 13f9b742-0060-4920-92fa-37942f2b157f
Function:
  Title: Corelight Connection Aggregated Events
  Version: '1.1.0'
  LastUpdated: '2025-11-26'
Category: Microsoft Sentinel Parser
FunctionName: corelight_conn_agg
FunctionAlias: corelight_conn_agg
FunctionQuery: |
    let ConnStateLookup = datatable(
        conn_state: string,
        conn_state_desc: string,
        action: string
    )[
        "S0","Connection attempt seen, no reply.","teardown",
        "S1","Connection established, not terminated.","allowed",
        "SF","Normal establishment and termination.","allowed",
        "REJ","Connection attempt rejected.","blocked",
        "S2","Connection established and close attempt by originator seen (but no reply from responder).","allowed",
        "S3","Connection established and close attempt by responder seen (but no reply from originator).","allowed",
        "RSTO","Connection established, originator aborted (sent a RST).","allowed",
        "RSTR","Established, responder aborted.","allowed",
        "RSTOS0","Originator sent a SYN followed by a RST, we never saw a SYN-ACK from the responder.","teardown",
        "RSTRH","Responder sent a SYN ACK followed by a RST, we never saw a SYN from the (purported) originator.","teardown",
        "SH","Originator sent a SYN followed by a FIN, we never saw a SYN ACK from the responder (hence the connection was 'half' open).","teardown",
        "SHR","Responder sent a SYN ACK followed by a FIN, we never saw a SYN from the originator.","teardown",
        "OTH","No SYN seen, just midstream traffic (a 'partial connection' that was not later closed).","allowed"
    ];
    let dummy_table = datatable(TimeGenerated: datetime, uid_s: string) [];
    let corelight_conn_agg = view () {
        union isfuzzy=true
            Corelight_v2_conn_agg_CL,
            dummy_table
        | summarize arg_max(TimeGenerated, *) by uid_s
        | extend
            path=column_ifexists("_path_s", ""),
            system_name=column_ifexists("_system_name_s", ""),
            id_orig_h=column_ifexists("id_orig_h_s", ""),
            id_orig_p=column_ifexists("id_orig_p_d", real(null)),
            id_resp_h=column_ifexists("id_resp_h_s", ""),
            id_resp_p=column_ifexists("id_resp_p_d", real(null)),
            proto=column_ifexists("proto_s", ""),
            suri_ids=column_ifexists("suri_ids_s", ""),
            local_orig=column_ifexists("local_orig_b", ""),
            local_resp=column_ifexists("local_resp_b", ""),
            id_orig_h_n=column_ifexists("id_orig_h_n_s", ""),
            id_resp_h_n=column_ifexists("id_resp_h_n_s", ""),
            write_ts=column_ifexists("_write_ts_t", datetime(null)),
            uid=column_ifexists("uid_s", ""),
            community_id=column_ifexists("community_id_s",""),
            spcap_url=column_ifexists("spcap_url_s", ""),
            service=column_ifexists("service_s", ""),
            apps=column_ifexists("app_s", ""),
            corelight_shunted=column_ifexists("corelight_shunted_b", ""),
            duration=column_ifexists("duration_d", real(null)),
            orig_bytes=column_ifexists("orig_bytes_d", real(null)),
            resp_bytes=column_ifexists("resp_bytes_d", real(null)),
            missed_bytes=column_ifexists("missed_bytes_d", real(null)),
            orig_shunted_pkts=column_ifexists("orig_shunted_pkts_d", real(null)),
            orig_shunted_bytes=column_ifexists("orig_shunted_bytes_d", real(null)),
            resp_shunted_pkts=column_ifexists("resp_shunted_pkts_d", real(null)),
            resp_shunted_bytes=column_ifexists("resp_shunted_bytes_d", real(null)),
            orig_pkts=column_ifexists("orig_pkts_d", real(null)),
            orig_ip_bytes=column_ifexists("orig_ip_bytes_d", real(null)),
            resp_pkts=column_ifexists("resp_pkts_d", real(null)),
            resp_ip_bytes=column_ifexists("resp_ip_bytes_d", real(null)),
            conn_state=column_ifexists("conn_state_s", ""),
            history=column_ifexists("history_s", ""),
            tunnel_parents=column_ifexists("tunnel_parents_s", ""),
            netskope_site_id=column_ifexists("netskope_site_id_s", ""),
            netskope_user_id=column_ifexists("netskope_user_id_s", ""),
            id_vlan=column_ifexists("id_vlan_d", real(null)),
            vlan=column_ifexists("vlan_d", real(null)),
            inner_vlan=column_ifexists("inner_vlan_d", real(null)),
            orig_inst_org_id=column_ifexists("orig_inst_org_id_s", ""),
            orig_inst_name=column_ifexists("orig_inst_name_s", ""),
            orig_inst_az=column_ifexists("orig_inst_az_s", ""),
            orig_inst_vpc_id=column_ifexists("orig_inst_vpc_id_s", ""),
            orig_inst_subnet_id=column_ifexists("orig_inst_subnet_id_s", ""),
            orig_inst_sg_ids=column_ifexists("orig_inst_sg_ids_s", ""),
            orig_inst_project=column_ifexists("orig_inst_project_s", ""),
            orig_inst_network=column_ifexists("orig_inst_network_s", ""),
            orig_inst_network_tags=column_ifexists("orig_inst_network_tags_s", ""),
            orig_inst_id=column_ifexists("orig_inst_id_s", ""),
            orig_inst_resource_group=column_ifexists("orig_inst_resource_group_s", ""),
            orig_inst_subscription=column_ifexists("orig_inst_subscription_s", ""),
            orig_inst_os=column_ifexists("orig_inst_os_s", ""),
            orig_inst_location=column_ifexists("orig_inst_location_s", ""),
            orig_inst_nsg=column_ifexists("orig_inst_nsg_s", ""),
            resp_inst_org_id=column_ifexists("resp_inst_org_id_s", ""),
            resp_inst_name=column_ifexists("resp_inst_name_s", ""),
            resp_inst_az=column_ifexists("resp_inst_az_s", ""),
            resp_inst_vpc_id=column_ifexists("resp_inst_vpc_id_s", ""),
            resp_inst_subnet_id=column_ifexists("resp_inst_subnet_id_s", ""),
            resp_inst_sg_ids=column_ifexists("resp_inst_sg_ids_s", ""),
            resp_inst_project=column_ifexists("resp_inst_project_s", ""),
            resp_inst_network=column_ifexists("resp_inst_network_s", ""),
            resp_inst_network_tags=column_ifexists("resp_inst_network_tags_s", ""),
            resp_inst_id=column_ifexists("resp_inst_id_s", ""),
            resp_inst_resource_group=column_ifexists("resp_inst_resource_group_s", ""),
            resp_inst_subscription=column_ifexists("resp_inst_subscription_s", ""),
            resp_inst_os=column_ifexists("resp_inst_os_s", ""),
            resp_inst_location=column_ifexists("resp_inst_location_s", ""),
            resp_inst_nsg=column_ifexists("resp_inst_nsg_s", "")
        | lookup ConnStateLookup on conn_state
        | extend
            EventVendor = "Corelight",
            EventProduct = "CorelightSensor",
            EventType = "conn_agg",
            ts = TimeGenerated,
            src=id_orig_h,
            src_ip=id_orig_h,
            src_port=id_orig_p,
            dest=id_resp_h,
            dest_ip=id_resp_h,
            dest_port=id_resp_p,
            bytes_out=orig_ip_bytes,
            packets_out=orig_pkts,
            bytes_in=resp_ip_bytes,
            packets_in=resp_pkts,
            session_id=uid,
            bytes=resp_ip_bytes + orig_ip_bytes,
            sensor_name = coalesce(system_name, "unknown"),
            transport=iff(proto=='icmp' and id_orig_h matches regex ".*:.*", "icmp6", proto),
            app=split(service, ",")
        | extend
            is_dest_internal_ip = iff(local_resp == true, "true", "false"),
            is_src_internal_ip = iff(local_orig == true, "true", "false"),
            direction = case(
                    local_orig == "true" and local_resp == "true",
                    "internal", 
                    local_orig == "true" and local_resp == "false",
                    "outbound", 
                    local_orig == "false" and local_resp == "false",
                    "external", 
                    local_orig == "false" and local_resp == "true",
                    "inbound", 
                    "unknown"
                )
        | project
            TimeGenerated,
            path,
            system_name,
            id_orig_h,
            id_orig_p,
            id_resp_h,
            id_resp_p,
            proto,
            suri_ids,
            local_orig,
            local_resp,
            id_orig_h_n,
            id_resp_h_n,
            write_ts,
            uid,
            community_id,
            spcap_url,
            service,
            app,
            apps,
            corelight_shunted,
            duration,
            orig_bytes,
            resp_bytes,
            missed_bytes,
            orig_shunted_pkts,
            orig_shunted_bytes,
            resp_shunted_pkts,
            resp_shunted_bytes,
            orig_pkts,
            orig_ip_bytes,
            resp_pkts,
            resp_ip_bytes,
            conn_state,
            history,
            tunnel_parents,
            netskope_site_id,
            netskope_user_id,
            id_vlan,
            vlan,
            inner_vlan,
            orig_inst_org_id,
            orig_inst_name,
            orig_inst_az,
            orig_inst_vpc_id,
            orig_inst_subnet_id,
            orig_inst_sg_ids,
            orig_inst_project,
            orig_inst_network,
            orig_inst_network_tags,
            orig_inst_id,
            orig_inst_resource_group,
            orig_inst_subscription,
            orig_inst_os,
            orig_inst_location,
            orig_inst_nsg,
            resp_inst_org_id,
            resp_inst_name,
            resp_inst_az,
            resp_inst_vpc_id,
            resp_inst_subnet_id,
            resp_inst_sg_ids,
            resp_inst_project,
            resp_inst_network,
            resp_inst_network_tags,
            resp_inst_id,
            resp_inst_resource_group,
            resp_inst_subscription,
            resp_inst_os,
            resp_inst_location,
            resp_inst_nsg,
            EventVendor,
            EventProduct,
            EventType,
            ts,
            is_dest_internal_ip,
            is_src_internal_ip,
            direction,
            conn_state_desc,
            action,
            src,
            src_ip,
            src_port,
            dest,
            dest_ip,
            dest_port,
            bytes_out,
            packets_out,
            bytes_in,
            packets_in,
            session_id,
            bytes,
            sensor_name,
            transport
    };
    corelight_conn_agg