{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Web Access log Assessment Playbook Name": {
      "defaultValue": "SlashNextWebAccessLogAssessment",
      "type": "string",
      "metadata": {
        "description": "Name of the Playbook"
      }
    },
      "Subscription Id": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "subscription id"
      }
    },
      "Workspace Id": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "workspace id"
      }
    },
     "Resource Group": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "resource group"
      }
    },
     "Workspace Name": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "workspace name"
      }
    },
    "Phishing Incident Investigation Playbook Name": {
      "defaultValue": "SlashNextPhishingIncidentInvestigation",
      "type": "string",
      "metadata": {
        "description": "Name of the Playbook"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "name": "SlashNextURLInvestigationConnector_LinkedTemplate",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
          },
          "variables": {
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "SlashNext",
              "location": "[resourceGroup().location]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API key used to authenticate with SlashNext cloud.",
                      "tooltip": "Provide your API key. If you don't have a valid API key, please reach us at support@slashnext.com",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "backendService": {
                  "serviceUrl": "https://rpd.slashnext.cloud"
                },
                "brandColor": "#FFFFFF",
                "description": "This is SlashNext URL Investigation Connector",
                "displayName": "SlashNext",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOYAAADmCAIAAABOCG7sAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAA5qADAAQAAAABAAAA5gAAAACKLWacAAAYuUlEQVR4Ae2dedxWw/vHs+8ie9mj7GTJUl6obCklP4SiSMoeWUq0UPbyQiIqUSGyRL5ZsmaXLWuyRNnJvvP7vX9NruY7c8657+d+lnqe87n/eJ45c66Zc+73ue4511xzzUytWvqIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIQDUlULdu3VtuueWTTz754osv7r777oYNG1bTL6LbzgWBevXqff311//rfX755Zdtt902F19eX7I6Erj11ls9dZ2ffOaZZ6rjd9E954LAZ599FqvsX3/9tdhii+Xi+1fJl1y8Sq6ii4hAhRGQylYYSip67LHH4uqef/55mt44XzkisPAJ0P366quvfNtA3a+F/1TyfAerrLLKBhtskE1g7bXXHj169KxZs7BrJ0yYsOmmm2bLr7XWWhTJltFZESgzga233vrZZ591zeeXX3557LHHlrmKqECLFi1mzJjh6pw5c+a+++4biShDBEoisP7663/33Xf+65509+7dS6psfqGmTZv+/ffffp3//PPPnnvuWZ46VVYE5hO44YYbfN1y6R9//BFVLpkRztq4zhdffLHkClVQBBYQeP3112P1Iue+++5bIFSW1JJLLvn777/Hdf75559LL710WWqSrAgkEcB1FauXyznkkEOSShTOwyCO6/z2228Ll8y9hPyyhVVg4sSJaUI33XRTad2mxDpLbrbTbk/5NZnARhtt1Lhx4+WWWy7+kkssscTkyZPjRtHl0G0aOnToTjvthJgru+qqq24377PUUkvFtbkc/GVvvvmmX+c777xTp06dWB4rgsCaLbfc0uqPZZSTLwJoqmnPH3/8MWDAALQkQECQAI6tO+6446233vrggw9oIx944IGXXnrJ7/X/9NNPBBzSLbPM77//vkuXLkFVdrjsssueeeaZtKz333//2Wefnfhr6dy589y5c51mf/755+3atbPiSuSUAL1+FMtv7UgPHDiwSByrr756r1696DYFNfiHRxxxRJG1BWKHHnqoXw9pWvS99torENNhvghcc801gVpwSOzVyiuvXDyI3XbbLbE75Wr+8MMPi6/Kl7SBBv8Op06d6ssonTsCif5RVARXf5lY7LjjjpgEvm75aazbMtWG8EorreTXYOmff/65rFXVMPm8ewyIBEh8omn5icJkYtceeeSRiWdRsh9++CHxVEYmlnFiKSzajFI6VfMJHH744daAWWLatGmlfXMXZ2j1uARTwUqrbdSoUUFVHF588cWl1aZSNYfAdddd52sGMw232GKL+Ovx6u/du/dll11GryjN37TMMstMmTLFr+3VV19NdF25+rfffvuj53122GGH+Io4wl5++WW/tscffxw/QyyZqxxN8Pj/x81wQKtWrej+oyLDhw/HhxAowaWXXtqzZ0+bD4MZgDwurUCMQ2RwERDgwtArhvLIkSPxJ8Ri+NFwNdBvs1O00HgqAmHE8HM1adKEHuETTzwxZswYNNiK5DMhlS383A877LDbbrstkMM126ZNmyCz+MOOHTvGzq/x48djDBRfST4lpbKFn/ukSZNatmwZy/HGx88f5GMzNGrUaN1116WVpQ/3yiuv0JEKZDgkDHzNNdcM8okxSOvDBZJ5PgyHefLMIu27M5abeIoZCr7KMrmgT58+9Od845WILQZ7+/fvj+5aJag1RogdWoKCKDojcJajREwg706umEicM3369DgT45KoAMs/+OCD33vvvRNPPNHXV87SIcN+wAUxaNCgxRefT5sR3dmzZ1tZS8yZM0f6ajTSElLZNDIL8jExGSldcDwvNWTIkN9++81ldurUifCDFVdcMZCxQ/pkdLZGjBhhObfffrulLZGYaWeVcATmBx8JRwaBt99+m8Gw+vXrmwyrGBGh4lpELNd77703jqRBGFuWAWEmjW222WbLL788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8z7EVLhQLzpkLN1MSEZa8UUnfyEbBj4IGgC8hgD1M4tPM3hD34X+kw3zxGWxDbAZjj/++OJV1m3uVUKrFl89O4evT0AZnT9e31g4GLjZ8mU6i33cu3dvVwTjFZeIS2P2NGjQgOgcPC0IAKfkzczKdD/lEa46vywj9dn+P54Tn+wR3YyvyggFg6ujR4/OkHGdsPbt27tRdSS5JXpXGUXc2ZLvKqPm+BR+q6OPPhrd5RSj/7FAaTlYq7xe3AgwAzq+2YrHhh85ng1qZkQDra3sEY3SvoJfqupUFncsLgIcAonuTEZTGVHE3oo7+/7tpqV5cdPp5n3qPPNpYuTT0LIREp0w0rRnGKl0+2h341BdBAg+pCdE94heS0adFXiKrh4WQsEK0T/cCxkf03jsJfy+derUoc5Zs2axTa77Sdgl8NOhxG58AYzOZWtnc53An0WAPbzwCfDLZsoAxGnteDExLkXoCadifS2y+0XsKcXpHxRE7DphFhLK4AIPkrI43mlx6VqxLz0PGBcB2szV6VnTKvvVVlL3yy6BknF73JL7+I0iP+x/swv8txBvBmOdKP4BjHi7SpBga2nrivE+DM66w0Wk+5V4b5WYyePHJxDzRmXxg8YXRmmwbnnjp33q1q1bVldAoN8U79evn1Pc4MZwjeHHCO6qslWWy2Fc8sXdzZRHZelm2TcKHH/Bl6LZ5ifqtJbBSGyJQIDDRURlKzLCLf6SaTkQoRlj3IUpAHgJsBTxQyXuLci0rYw95Kkf/aPXxS9h6tSpxfjtKYLFHMvzzBjkZO4XvwEsPCK8CLZyo/DBt2A6CkMM9GBQ6OBUcEhkY8eOHfEKT5s2zZ1ivNq1YZS1PlBQyh0ywuIidbgNBrpdJg1wz549E+WDTGxWqDLPwplhdKoKeqOxl4DJq4+qcEIzPSEYX4AMHUTO4iPDwx1cscoOF47KVtnX04XKRICYZjobbqIEDi9ChRin5FOwh1Cmq5RTWCpbToA1rTjGPcEe9DuZnWvhYDgfiRxy6kuCWIjEV2LVsJDKVg3n6ncV9BXLjXaXDxrMBy8E25kzHs4IoraMrH5PVHcsAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAiIgAjWWwP8BIbRNsbNUaBAAAAAASUVORK5CYII=",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "version": "1.0.0",
                    "title": "SlashNext",
                    "description": "SlashNext URL Investigation Connector is based upon its Real-time Phishing Defense (RPD) APIs which are connected to SlashNext real-time threat intelligence database, continuously updated with the latest phishing threats. SlashNext RPD APIs are designed to be very fast and give accurate binary verdict on each enrichment request to ease its integration in any phishing Incident Response (IR) or SOAR environment."
                  },
                  "host": "rpd.slashnext.cloud",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": [
                  ],
                  "produces": [
                    "application/json"
                  ],
                  "paths": {
                    "/api/v1/urls/repute": {
                      "post": {
                        "summary": "Repute",
                        "description": "This will get verdict of urls",
                        "operationId": "Repute",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "urls": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "urls"
                                }
                              },
                              "default": {
                                "urls": [
                                  ""
                                ]
                              }
                            },
                            "required": true
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "total_received_urls": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "total_received_urls"
                                },
                                "total_benign_urls": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "total_benign_urls"
                                },
                                "total_malicious_urls": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "total_malicious_urls"
                                },
                                "total_invalid_urls": {
                                  "type": "array",
                                  "items": {
                                  },
                                  "description": "total_invalid_urls"
                                },
                                "malicious_urls_details": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "scanned_url": {
                                        "type": "string",
                                        "description": "scanned_url"
                                      },
                                      "scanned_url_type": {
                                        "type": "string",
                                        "description": "scanned_url_type"
                                      },
                                      "active": {
                                        "type": "string",
                                        "description": "active"
                                      },
                                      "match_type": {
                                        "type": "string",
                                        "description": "match_type"
                                      },
                                      "associated_urls": {
                                        "type": "array",
                                        "items": {
                                        },
                                        "description": "associated_urls"
                                      }
                                    }
                                  },
                                  "description": "malicious_urls_details"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "definitions": {
                  },
                  "parameters": {
                  },
                  "responses": {
                  },
                  "securityDefinitions": {
                    "api_key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "key"
                    }
                  },
                  "security": [
                  ],
                  "tags": [
                  ]
                }
              }
            }
          ]
        },
        "parameters": {
        }
      }
    },
    {
      "name": "SlashNextWebAccessLogAssessment_LinkedTemplate",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'SlashNextURLInvestigationConnector_LinkedTemplate')]"
      ],
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"PlaybookName": {
			"defaultValue": "",
			"type": "string"
		},
		"Subscription Id": {
			"defaultValue": "",
			"type": "string"
		},
		"Workspace Id": {
			"defaultValue": "",
			"type": "string"
		},
		"Resource Group": {
			"defaultValue": "",
			"type": "string"
		},
		"Workspace Name": {
			"defaultValue": "",
			"type": "string"
		}

	},
	"variables": {
		"slashnext_connection_name": "[concat('slashnext-connection-', parameters('PlaybookName'))]",
		"customApis_slashnext_name": "SlashNext",
		"parent_suffix": "[substring(toLower(uniqueString(resourceGroup().id, resourceGroup().location)),0,5)]",
		"azureFunction": "[concat('slashnext-azure-function-',variables('parent_suffix'))]"
	},
	"resources": [{
			"name": "SlashNext_azure_LinkedTemplate",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2020-06-01",
			"properties": {
				"mode": "Incremental",
				"expressionEvaluationOptions": {
					"scope": "inner"
				},
				"template": {
					"$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {},
					"variables": {
						"suffix": "[substring(toLower(uniqueString(resourceGroup().id, resourceGroup().location)),0,5)]",
						"funcAppName": "[concat('slashnext-azure-function-',variables('suffix'))]",
						"funcStorageName": "[concat('slashnextstorage', variables('suffix'))]",
						"serverFarmName": "[concat('slashnextfarm', variables('suffix'))]",
						"repoURL": "https://github.com/slashnext/processlogs",
						"srcControlsName": "web",
						"GitHubBranch": "master"
					},
					"resources": [{
							"type": "Microsoft.Web/sites",
							"apiVersion": "2018-11-01",
							"name": "[variables('funcAppName')]",
							"location": "[resourceGroup().location]",
							"dependsOn": [
								"[resourceId('Microsoft.Web/serverfarms',variables('serverFarmName'))]",
								"[resourceId('Microsoft.Storage/storageAccounts', variables('funcStorageName'))]"
							],
							"kind": "functionapp,linux",
							"properties": {
								"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverFarmName'))]",
								"siteConfig": {
									"alwaysOn": true,
									"appSettings": [{
											"name": "AzureWebJobsDashboard",
											"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2019-06-01').keys[0].value,';EndpointSuffix=core.windows.net')]"
										},
										{
											"name": "AzureWebJobsStorage",
											"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2019-06-01').keys[0].value,';EndpointSuffix=core.windows.net')]"
										},
										{
											"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
											"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2019-06-01').keys[0].value,';EndpointSuffix=core.windows.net')]"
										},
										{
											"name": "FUNCTIONS_EXTENSION_VERSION",
											"value": "~4"
										},
										{
											"name": "FUNCTIONS_WORKER_RUNTIME",
											"value": "python"
										}
									],
									"linuxFxVersion": "python|3.10"
								}
							},
							"resources": [{
								"type": "sourcecontrols",
								"apiVersion": "2018-11-01",
								"name": "[variables('srcControlsName')]",
								"dependsOn": [
									"[resourceId('Microsoft.Web/sites/', variables('funcAppName'))]"
								],
								"properties": {
									"RepoUrl": "[variables('repoURL')]",
									"branch": "[variables('GitHubBranch')]",
									"IsManualIntegration": true
								}
							}]
						},
						{
							"type": "Microsoft.Storage/storageAccounts",
							"apiVersion": "2018-07-01",
							"name": "[variables('funcStorageName')]",
							"location": "[resourceGroup().location]",
							"tags": {
								"displayName": "funStorageName"
							},
							"sku": {
								"name": "Standard_LRS"
							},
							"kind": "StorageV2"
						},
						{
							"type": "Microsoft.Web/serverfarms",
							"apiVersion": "2018-02-01",
							"name": "[variables('serverFarmName')]",
							"location": "[resourceGroup().location]",
							"sku": {
								"name": "P0V3",
								"tier": "Premium v3"
							},
							"kind": "elastic",
							"properties": {
								"kind": "functionapp",
								"name": "[variables('serverFarmName')]",
								"computeMode": "Dynamic",
								"reserved": true
							}
						}
					],
					"outputs": {}
				},
				"parameters": {}
			}
		},
		{
			"name": "[variables('slashnext_connection_name')]",
			"type": "Microsoft.Web/connections",
			"apiVersion": "2016-06-01",
			"location": "[resourceGroup().location]",
			"kind": "V1",
			"properties": {
				"displayName": "[variables('slashnext_connection_name')]",
				"customParameterValues": {},
				"api": {
					"id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('customApis_slashnext_name'))]"
				}
			}
		},
		{
			"properties": {
				"state": "Disabled",
				"definition": {
					"$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
					"contentVersion": "1.0.0.0",
					"parameters": {
						"$connections": {
							"defaultValue": {},
							"type": "Object"
						}
					},
					"triggers": {
						"Recurrence": {
							"recurrence": {
								"frequency": "Minute",
								"interval": 5
							},
							"evaluatedRecurrence": {
								"frequency": "Minute",
								"interval": 5
							},
							"type": "Recurrence"
						}
					},
					"actions": {
						"Current_time": {
							"runAfter": {},
							"type": "Expression",
							"kind": "CurrentTime",
							"inputs": {}
						},
						"Get_past_time": {
							"runAfter": {
								"Current_time": [
									"Succeeded"
								]
							},
							"type": "Expression",
							"kind": "GetPastTime",
							"inputs": {
								"interval": 5,
								"timeUnit": "Minute"
							}
						},
						"Incident_Id": {
							"runAfter": {
								"Malicious_urls": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "IncidentId",
									"type": "string",
									"value": "''"
								}]
							}
						},
						"Log_Query_API": {
							"runAfter": {
								"Incident_Id": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "Query API",
									"type": "string",
									"value": "https://api.loganalytics.io/v1/workspaces/@{variables('workspace_id')}/query"
								}]
							}
						},
						"Malicious_urls": {
							"runAfter": {
								"Workspace_Name": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "malicious_urls",
									"type": "array",
									"value": []
								}]
							}
						},
						"Parse_JSON": {
							"runAfter": {
								"Query_for_table_names": [
									"Succeeded"
								]
							},
							"type": "ParseJson",
							"inputs": {
								"content": "@body('Query_for_table_names')",
								"schema": {
									"properties": {
										"tables": {
											"items": {
												"properties": {
													"columns": {
														"items": {
															"properties": {
																"name": {
																	"type": "string"
																},
																"type": {
																	"type": "string"
																}
															},
															"required": [
																"name",
																"type"
															],
															"type": "object"
														},
														"type": "array"
													},
													"name": {
														"type": "string"
													},
													"rows": {
														"items": {
															"items": {
																"type": "string"
															},
															"type": "array"
														},
														"type": "array"
													}
												},
												"required": [
													"name",
													"columns",
													"rows"
												],
												"type": "object"
											},
											"type": "array"
										}
									},
									"type": "object"
								}
							}
						},
						"Query_for_table_names": {
							"runAfter": {
								"Log_Query_API": [
									"Succeeded"
								]
							},
							"type": "Http",
							"inputs": {
								"authentication": {
									"audience": "https://api.loganalytics.io",
									"type": "ManagedServiceIdentity"
								},
								"body": {
									"query": "search * | where TimeGenerated > ago(2h)|distinct $table"
								},
								"method": "POST",
								"uri": "@variables('Query API')"
							}
						},
						"Resource_Group": {
							"runAfter": {
								"Workspace_Id": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "resource_group",
									"type": "string",
									"value": "[parameters('Resource Group')]"
								}]
							}
						},
						"Subscription_Id": {
							"runAfter": {
								"Get_past_time": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "subscription_id",
									"type": "string",
									"value": "[parameters('subscription Id')]"
								}]
							}
						},
						"Traverse_Table_Names": {
							"foreach": "@body('Parse_JSON')?['tables']",
							"actions": {
								"For_each": {
									"foreach": "@items('Traverse_Table_Names')?['rows']",
									"actions": {
										"Fetch_Data_from_Each_Table_": {
											"foreach": "@body('Parse_Table_Names')",
											"actions": {
												"Ignore_Tables": {
													"actions": {
														"Clear_Incident_Id_for_Next_Table": {
															"runAfter": {
																"Traverse_Split_Lists": [
																	"Succeeded"
																]
															},
															"type": "SetVariable",
															"inputs": {
																"name": "IncidentId",
																"value": "''"
															}
														},
														"Extract_List_of_URLs": {
															"runAfter": {
																"Query_data_from_each_table": [
																	"Succeeded"
																]
															},
															"type": "Function",
															"inputs": {
																"body": "@body('Query_data_from_each_table')",
																"function": {
																	"id": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/', resourceGroup().name,'/providers/Microsoft.Web/sites/',variables('azureFunction'),'/functions/processlogs')]"
																},
																"queries": {
																	"label": "extract"
																},
																"retryPolicy": {
																	"type": "none"
																}
															}
														},
														"Query_data_from_each_table": {
															"runAfter": {},
															"type": "Http",
															"inputs": {
																"authentication": {
																	"audience": "https://api.loganalytics.io",
																	"type": "ManagedServiceIdentity"
																},
																"body": {
																	"query": "@{items('Fetch_Data_from_Each_Table_')} |where ingestion_time() >= todatetime(format_datetime(datetime(@{body('Get_past_time')}),'yyyy-MM-dd HH:mm')) and ingestion_time() <todatetime(format_datetime(datetime(@{body('Current_time')}),'yyyy-MM-dd HH:mm')) "
																},
																"method": "POST",
																"uri": "@variables('Query API')"
															}
														},
														"Split_List_of_URLs": {
															"runAfter": {
																"Extract_List_of_URLs": [
																	"Succeeded"
																]
															},
															"type": "ParseJson",
															"inputs": {
																"content": "@body('Extract_List_of_URLs')",
																"schema": {
																	"items": {
																		"items": {
																			"type": "string"
																		},
																		"type": "array"
																	},
																	"type": "array"
																}
															}
														},
														"Traverse_Split_Lists": {
															"foreach": "@body('Split_List_of_URLs')",
															"actions": {
																"Empty_List_Check": {
																	"actions": {
																		"Clear_Malicious_URLs_List": {
																			"runAfter": {
																				"Incident_Creating_Loop": [
																					"Succeeded"
																				]
																			},
																			"type": "SetVariable",
																			"inputs": {
																				"name": "malicious_urls",
																				"value": []
																			}
																		},
																		"Generate_URL_Mapping": {
																			"runAfter": {},
																			"type": "Function",
																			"inputs": {
																				"body": "@variables('malicious_urls')",
																				"function": {
																					"id": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/', resourceGroup().name,'/providers/Microsoft.Web/sites/',variables('azureFunction'),'/functions/processlogs')]"
																				},
																				"queries": {
																					"label": "mapping"
																				}
																			}
																		},
																		"Incident_Creating_Loop": {
																			"foreach": "@body('Parse_Mapping_Repsonse')",
																			"actions": {
																				"Incident_Already_Exists": {
																					"actions": {
																						"Add_Comment_in_Existing_Incident": {
																							"runAfter": {},
																							"type": "Http",
																							"inputs": {
																								"authentication": {
																									"audience": "https://management.azure.com",
																									"type": "ManagedServiceIdentity"
																								},
																								"body": {
																									"properties": {
																										"message": "Event spotted again in @{items('Fetch_Data_from_Each_Table_')} at @{body('Current_time')}"
																									}
																								},
																								"method": "PUT",
																								"uri": "https://management.azure.com/subscriptions/@{variables('subscription_id')}/resourceGroups/@{variables('resource_group')}/providers/Microsoft.OperationalInsights/workspaces/@{variables('workspace_name')}/providers/Microsoft.SecurityInsights/incidents/@{items('Incident_Creating_Loop')['hash']}/comments/@{guid()}?api-version=2021-10-01\n"
																							}
																						}
																					},
																					"runAfter": {
																						"Insert_Incident": [
																							"Succeeded",
																							"Failed"
																						]
																					},
																					"expression": {
																						"and": [{
																							"equals": [
																								"@outputs('Insert_Incident')['statusCode']",
																								409
																							]
																						}]
																					},
																					"type": "If"
																				},
																				"Insert_Incident": {
																					"runAfter": {
																						"Parse_URL_Mapping": [
																							"Succeeded"
																						]
																					},
																					"type": "Http",
																					"inputs": {
																						"authentication": {
																							"audience": "https://management.azure.com",
																							"type": "ManagedServiceIdentity"
																						},
																						"body": {
																							"etag": "@{guid()}",
																							"properties": {
																								"description": "@{items('Fetch_Data_from_Each_Table_')} table contains malicious url @{body('Parse_URL_Mapping')?['url']}",
																								"severity": "High",
																								"status": "New",
																								"title": "Malicious Incident"
																							}
																						},
																						"method": "PUT",
																						"uri": "https://management.azure.com/subscriptions/@{variables('subscription_id')}/resourceGroups/@{variables('resource_group')}/providers/Microsoft.OperationalInsights/workspaces/@{variables('workspace_name')}/providers/Microsoft.SecurityInsights/incidents/@{body('Parse_URL_Mapping')?['hash']}?api-version=2021-10-01-preview"
																					}
																				},
																				"Parse_URL_Mapping": {
																					"runAfter": {},
																					"type": "ParseJson",
																					"inputs": {
																						"content": "@items('Incident_Creating_Loop')",
																						"schema": {
																							"properties": {
																								"hash": {
																									"type": "string"
																								},
																								"url": {
																									"type": "string"
																								}
																							},
																							"type": "object"
																						}
																					}
																				}
																			},
																			"runAfter": {
																				"Parse_Mapping_Repsonse": [
																					"Succeeded"
																				]
																			},
																			"type": "Foreach"
																		},
																		"Parse_Mapping_Repsonse": {
																			"runAfter": {
																				"Generate_URL_Mapping": [
																					"Succeeded"
																				]
																			},
																			"type": "ParseJson",
																			"inputs": {
																				"content": "@body('Generate_URL_Mapping')",
																				"schema": {
																					"items": {
																						"properties": {
																							"hash": {
																								"type": "string"
																							},
																							"url": {
																								"type": "string"
																							}
																						},
																						"required": [
																							"hash",
																							"url"
																						],
																						"type": "object"
																					},
																					"type": "array"
																				}
																			}
																		}
																	},
																	"runAfter": {
																		"Traverse_List_of_Malicious_URLs": [
																			"Succeeded"
																		]
																	},
																	"expression": {
																		"and": [{
																			"greaterOrEquals": [
																				"@length(variables('malicious_urls'))",
																				1
																			]
																		}]
																	},
																	"type": "If"
																},
																"Parse_List_of_URLs": {
																	"runAfter": {},
																	"type": "ParseJson",
																	"inputs": {
																		"content": "@items('Traverse_Split_Lists')",
																		"schema": {
																			"items": {
																				"type": "string"
																			},
																			"type": "array"
																		}
																	}
																},
																"Repute": {
																	"runAfter": {
																		"Parse_List_of_URLs": [
																			"Succeeded"
																		]
																	},
																	"type": "ApiConnection",
																	"inputs": {
																		"body": {
																			"urls": "@body('Parse_List_of_URLs')"
																		},
																		"host": {
																			"connection": {
																				"name": "@parameters('$connections')['SlashNext']['connectionId']"
																			}
																		},
																		"method": "post",
																		"path": "/api/v1/urls/repute"
																	}
																},
																"Traverse_List_of_Malicious_URLs": {
																	"foreach": "@body('Repute')?['malicious_urls_details']",
																	"actions": {
																		"Add_Malicious_URL": {
																			"runAfter": {
																				"Parse_Malicious_URL_Details": [
																					"Succeeded"
																				]
																			},
																			"type": "AppendToArrayVariable",
																			"inputs": {
																				"name": "malicious_urls",
																				"value": "@body('Parse_Malicious_URL_Details')?['scanned_url']"
																			}
																		},
																		"Parse_Malicious_URL_Details": {
																			"runAfter": {},
																			"type": "ParseJson",
																			"inputs": {
																				"content": "@items('Traverse_List_of_Malicious_URLs')",
																				"schema": {
																					"properties": {
																						"active": {
																							"type": "string"
																						},
																						"associated_urls": {
																							"type": "array"
																						},
																						"match_type": {
																							"type": "string"
																						},
																						"scanned_url": {
																							"type": "string"
																						},
																						"scanned_url_type": {
																							"type": "string"
																						}
																					},
																					"type": "object"
																				}
																			}
																		}
																	},
																	"runAfter": {
																		"Repute": [
																			"Succeeded"
																		]
																	},
																	"type": "Foreach"
																}
															},
															"runAfter": {
																"Split_List_of_URLs": [
																	"Succeeded"
																]
															},
															"type": "Foreach"
														}
													},
													"runAfter": {},
													"expression": {
														"and": [{
															"not": {
																"equals": [
																	"@items('Fetch_Data_from_Each_Table_')",
																	"SecurityIncident"
																]
															}
														}]
													},
													"type": "If"
												}
											},
											"runAfter": {
												"Parse_Table_Names": [
													"Succeeded"
												]
											},
											"type": "Foreach"
										},
										"Parse_Table_Names": {
											"runAfter": {},
											"type": "ParseJson",
											"inputs": {
												"content": "@items('For_each')",
												"schema": {
													"items": {
														"type": "string"
													},
													"type": "array"
												}
											}
										}
									},
									"runAfter": {},
									"type": "Foreach"
								}
							},
							"runAfter": {
								"Parse_JSON": [
									"Succeeded"
								]
							},
							"type": "Foreach"
						},
						"Workspace_Id": {
							"runAfter": {
								"Subscription_Id": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "workspace_id",
									"type": "string",
									"value": "[parameters('Workspace Id')]"
								}]
							}
						},
						"Workspace_Name": {
							"runAfter": {
								"Resource_Group": [
									"Succeeded"
								]
							},
							"type": "InitializeVariable",
							"inputs": {
								"variables": [{
									"name": "workspace_name",
									"type": "string",
									"value": "[parameters('Workspace Name')]"
								}]
							}
						}
					},
					"outputs": {}
				},
				"parameters": {
					"$connections": {
						"value": {
							"SlashNext": {
								"connectionId": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/connections/',variables('slashnext_connection_name'))]",
								"connectionName": "[variables('slashnext_connection_name')]",
								"id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', 'SlashNext')]"
							}
						}
					}
				}
			},
			"name": "[parameters('PlaybookName')]",
			"type": "Microsoft.Logic/workflows",
			"location": "[resourceGroup().location]",
			"tags": {
				"hidden-SentinelTemplateName": "SlashnextProcessLogs",
				"hidden-SentinelTemplateVersion": "1.0"
			},
			"identity": {
				"type": "SystemAssigned"
			},
			"apiVersion": "2017-07-01",
			"dependsOn": [
				"[resourceId('Microsoft.Web/connections', variables('slashnext_connection_name'))]",
				"[resourceId('Microsoft.Resources/deployments', 'SlashNext_azure_LinkedTemplate')]"
			]
		}
	]
},
        "parameters": {
                      "PlaybookName": {
                          "Value": "[parameters('Web Access log Assessment Playbook Name')]"
                      },
                      "Subscription Id": {
                          "Value": "[parameters('Subscription Id')]"
                      },
                      "Workspace Id": {
                          "Value": "[parameters('Workspace Id')]"
                      },
                      "Resource Group": {
                          "Value": "[parameters('Resource Group')]"
                      },
                      "Workspace Name": {
                          "Value": "[parameters('Workspace Name')]"
                      }

                      }
      }
    },
    {
      "name": "SlashNextPhishingIncidentInvestigation_LinkedTemplate",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'SlashNextURLInvestigationConnector_LinkedTemplate')]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "SlashNextPhishingIncidentInvestigation",
              "type": "string"
            }
          },
          "variables": {
            "slashnext_connection_name": "[concat('slashnext-connection-', parameters('PlaybookName'))]",
            "MicrosoftSentinelConnectionName": "[concat('sentinel-connection-', parameters('PlaybookName'))]",
            "customApis_slashnext_name": "SlashNext"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "defaultValue": {
                      },
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                      "Add_comment_to_incident": {
                          "inputs": {
                              "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "message": "<p>@{variables('message')}</p>"
                              },
                              "host": {
                                  "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                              },
                              "method": "post",
                              "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                              "If_Incident_has_both_Malicious_and_Benign_URLs": [
                                  "Succeeded"
                              ]
                          },
                          "type": "ApiConnection"
                      },
                      "Benign_URLs": {
                          "inputs": {
                              "variables": [
                                  {
                                      "name": "benign_urls",
                                      "type": "array",
                                      "value": []
                                  }
                              ]
                          },
                          "runAfter": {
                              "Malicious_URLs": [
                                  "Succeeded"
                              ]
                          },
                          "type": "InitializeVariable"
                      },
                      "Entities_-_Get_URLs": {
                          "inputs": {
                              "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                              "host": {
                                  "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                              },
                              "method": "post",
                              "path": "/entities/url"
                          },
                          "runAfter": {},
                          "type": "ApiConnection"
                      },
                      "If_Incident_has_both_Malicious_and_Benign_URLs": {
                          "actions": {
                              "Prepare_message": {
                                  "inputs": {
                                      "name": "message",
                                      "value": "According to SlashNext connector below mentioned URLs are \nMalicious: @{variables('malicious_urls')}\nBenign: @{variables('benign_urls')}"
                                  },
                                  "runAfter": {},
                                  "type": "SetVariable"
                              }
                          },
                          "expression": {
                              "and": [
                                  {
                                      "greaterOrEquals": [
                                          "@length(variables('malicious_urls'))",
                                          1
                                      ]
                                  },
                                  {
                                      "greaterOrEquals": [
                                          "@length(variables('benign_urls'))",
                                          1
                                      ]
                                  }
                              ]
                          },
                          "runAfter": {
                              "Malicious_Comment_Condition": [
                                  "Succeeded"
                              ]
                          },
                          "type": "If"
                      },
                      "Iterate_each_URL_in_the_incident": {
                          "actions": {
                              "If_Benign": {
                                  "actions": {
                                      "Append_Benign_URL": {
                                          "inputs": {
                                              "name": "benign_urls",
                                              "value": "@items('Iterate_each_URL_in_the_incident')?['Url']"
                                          },
                                          "runAfter": {},
                                          "type": "AppendToArrayVariable"
                                      }
                                  },
                                  "expression": {
                                      "and": [
                                          {
                                              "greaterOrEquals": [
                                                  "@body('Repute')?['total_benign_urls']",
                                                  1
                                              ]
                                          }
                                      ]
                                  },
                                  "runAfter": {
                                      "Repute": [
                                          "Succeeded"
                                      ]
                                  },
                                  "type": "If"
                              },
                              "If_Malicious": {
                                  "actions": {
                                      "Append_Malicious_URL": {
                                          "inputs": {
                                              "name": "malicious_urls",
                                              "value": "@items('Iterate_each_URL_in_the_incident')?['Url']"
                                          },
                                          "runAfter": {},
                                          "type": "AppendToArrayVariable"
                                      }
                                  },
                                  "expression": {
                                      "and": [
                                          {
                                              "greaterOrEquals": [
                                                  "@body('Repute')?['total_malicious_urls']",
                                                  1
                                              ]
                                          }
                                      ]
                                  },
                                  "runAfter": {
                                      "Repute": [
                                          "Succeeded"
                                      ]
                                  },
                                  "type": "If"
                              },
                              "Repute": {
                                  "inputs": {
                                      "body": {
                                          "urls": [
                                              "@items('Iterate_each_URL_in_the_incident')?['Url']"
                                          ]
                                      },
                                      "host": {
                                          "connection": {
                                              "name": "@parameters('$connections')['SlashNext']['connectionId']"
                                          }
                                      },
                                      "method": "post",
                                      "path": "/api/v1/urls/repute"
                                  },
                                  "runAfter": {},
                                  "type": "ApiConnection"
                              }
                          },
                          "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                          "runAfter": {
                              "Message": [
                                  "Succeeded"
                              ]
                          },
                          "type": "Foreach"
                      },
                      "Malicious_Comment_Condition": {
                          "actions": {
                              "Message_For_Malicious_Incident(s)": {
                                  "inputs": {
                                      "name": "message",
                                      "value": "According to SlashNext connector below mentioned URLs are malicious\n@{variables('malicious_urls')}"
                                  },
                                  "runAfter": {},
                                  "type": "SetVariable"
                              }
                          },
                          "else": {
                              "actions": {
                                  "Benign_Comment_Condition": {
                                      "actions": {
                                          "Message_For_Benign_Incident(s)": {
                                              "inputs": {
                                                  "name": "message",
                                                  "value": "According to SlashNext connector below mentioned URL(s) are benign\n@{variables('benign_urls')}"
                                              },
                                              "runAfter": {},
                                              "type": "SetVariable"
                                          }
                                      },
                                      "expression": {
                                          "and": [
                                              {
                                                  "greaterOrEquals": [
                                                      "@length(variables('benign_urls'))",
                                                      1
                                                  ]
                                              }
                                          ]
                                      },
                                      "runAfter": {},
                                      "type": "If"
                                  }
                              }
                          },
                          "expression": {
                              "and": [
                                  {
                                      "greaterOrEquals": [
                                          "@length(variables('malicious_urls'))",
                                          1
                                      ]
                                  }
                              ]
                          },
                          "runAfter": {
                              "Iterate_each_URL_in_the_incident": [
                                  "Succeeded"
                              ]
                          },
                          "type": "If"
                      },
                      "Malicious_URLs": {
                          "inputs": {
                              "variables": [
                                  {
                                      "name": "malicious_urls",
                                      "type": "array",
                                      "value": []
                                  }
                              ]
                          },
                          "runAfter": {
                              "Entities_-_Get_URLs": [
                                  "Succeeded"
                              ]
                          },
                          "type": "InitializeVariable"
                      },
                      "Message": {
                          "inputs": {
                              "variables": [
                                  {
                                      "name": "message",
                                      "type": "string",
                                      "value": "No URL extracted from Entities"
                                  }
                              ]
                          },
                          "runAfter": {
                              "Benign_URLs": [
                                  "Succeeded"
                              ]
                          },
                          "type": "InitializeVariable"
                      }
                  },
                  "outputs": {
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "SlashNext": {
                        "connectionId": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/connections/',variables('slashnext_connection_name'))]",
                        "connectionName": "[variables('slashnext_connection_name')]",
                        "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', 'SlashNext')]"
                      },
                      "azuresentinel": {
                        "connectionId": "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[resourceGroup().location]",
              "tags": {
                "hidden-SentinelTemplateName": "incidentenrichment",
                "hidden-SentinelTemplateVersion": "1.0"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('slashnext_connection_name'))]",
                "[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ]
            },
            {
              "name": "[variables('slashnext_connection_name')]",
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "location": "[resourceGroup().location]",
              "kind": "V1",
              "properties": {
                "displayName": "[variables('slashnext_connection_name')]",
                "customParameterValues": {},
                "api": {
                  "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('customApis_slashnext_name'))]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[variables('MicrosoftSentinelConnectionName')]",
              "location": "[resourceGroup().location]",
              "kind": "V1",
              "properties": {
                "displayName": "[variables('MicrosoftSentinelConnectionName')]",
                "customParameterValues": {
                },
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/Azuresentinel')]"
                }
              }
            }
          ]
        },
        "parameters": {
          "PlaybookName": {
            "Value": "[parameters('Phishing Incident Investigation Playbook Name')]"
          }
        }
      }
    }
  ]
}

