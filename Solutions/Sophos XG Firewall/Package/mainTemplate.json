{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "SophosXGFirewall",
    "comments": "Solution template for Sophos XG Firewall"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Sophos XG Firewall",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "_solutionName": "Sophos XG Firewall",
    "_solutionVersion": "3.0.1",
    "solutionId": "azuresentinel.azure-sentinel-solution-sophosxgfirewall",
    "_solutionId": "[variables('solutionId')]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.4",
      "_analyticRulecontentId1": "3d645a88-2724-41a7-adea-db74c439cf79",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3d645a88-2724-41a7-adea-db74c439cf79')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3d645a88-2724-41a7-adea-db74c439cf79')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3d645a88-2724-41a7-adea-db74c439cf79','-', '1.0.4')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.4",
      "_analyticRulecontentId2": "427e4c9e-8cf4-4094-a684-a2d060dbca38",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '427e4c9e-8cf4-4094-a684-a2d060dbca38')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('427e4c9e-8cf4-4094-a684-a2d060dbca38')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','427e4c9e-8cf4-4094-a684-a2d060dbca38','-', '1.0.4')))]"
    },
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "SophosXGFirewallWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "parserObject1": {
      "_parserName1": "[concat(parameters('workspace'),'/','SophosXGFirewall')]",
      "_parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SophosXGFirewall')]",
      "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('SophosXGFirewall-Parser')))]",
      "parserVersion1": "1.1.0",
      "parserContentId1": "SophosXGFirewall-Parser"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ExcessiveAmountofDeniedConnectionsfromASingleSource_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This creates an incident in the event that a single source IP address generates a excessive amount of denied connections.",
                "displayName": "Excessive Amount of Denied Connections from a Single Source",
                "enabled": false,
                "query": "let threshold = 5000;\nSophosXGFirewall\n| where Log_Type =~ \"Firewall\" and Status =~ \"Deny\"\n| summarize count() by Src_IP, bin(TimeGenerated,5m)\n| where count_ > threshold\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SyslogAma",
                    "datatypes": [
                      "Syslog"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1499"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "Src_IP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Sophos XG Firewall Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Sophos XG Firewall",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SophosXGFirewall"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Excessive Amount of Denied Connections from a Single Source",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "PortScanDetected_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This alert creates an incident when a source IP addresses attempt to communicate with a large amount of distinct ports within a short period.",
                "displayName": "Port Scan Detected",
                "enabled": false,
                "query": "let threshold = 50;\nSophosXGFirewall\n| where Log_Type =~ \"Firewall\"\n| where not(ipv4_is_match(\"10.0.0.0\",Src_IP,8) or ipv4_is_match(\"172.16.0.0\",Src_IP,12) or ipv4_is_match(\"192.168.0.0\",Src_IP,16))\n| summarize dcount(Dst_Port) by Src_IP, bin(TimeGenerated, 5m)\n| where dcount_Dst_Port > threshold\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SyslogAma",
                    "datatypes": [
                      "Syslog"
                    ]
                  }
                ],
                "tactics": [
                  "Discovery"
                ],
                "techniques": [
                  "T1046"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "Src_IP",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Sophos XG Firewall Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Sophos XG Firewall",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SophosXGFirewall"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "Port Scan Detected",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SophosXGFirewall Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insight into Sophos XG Firewall by analyzing, collecting and correlating firewall data.\nThis workbook provides visibility into network traffic"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3a1905da-e863-4fb1-a4cc-373bfa047344\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"resourceType\":\"microsoft.insights/components\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\"\\r\\n| summarize inbound = countif(not(ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))), outbound = countif((ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))), deny = countif(Status == \\\"Deny\\\"), count() by bin(TimeGenerated, {TimeRange:grain})\\r\\n| project-away count_\",\"size\":0,\"title\":\"Network Traffic by Direction\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"customWidth\":\"50\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\"\\r\\n| where Status in (\\\"Allow\\\",\\\"Deny\\\") or Log_Subtype in (\\\"Allowed\\\",\\\"Denied\\\")\\r\\n| summarize count() by Status, bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"title\":\"Events by Action\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Allow\",\"color\":\"green\"},{\"seriesName\":\"Deny\",\"color\":\"red\"}]}},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and (Status =~ \\\"Deny\\\" or Log_Subtype =~ \\\"Denied\\\")\\r\\n| where not(ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| summarize Total = count() by ['Source IP'] = Src_IP\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Denied Inbound Source IPs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2}}}]},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Allow\",\"color\":\"green\"},{\"seriesName\":\"Deny\",\"color\":\"red\"}]}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and (Status =~ \\\"Deny\\\" or Log_Subtype =~ \\\"Denied\\\")\\r\\n| where (ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| summarize Total = count() by ['Destination IP'] = Dst_IP\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Denied Outbound Destination IPs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Allow\",\"color\":\"green\"},{\"seriesName\":\"Deny\",\"color\":\"red\"}]}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and (Status =~ \\\"Deny\\\" or Log_Subtype =~ \\\"Denied\\\")\\r\\n| where not(ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| summarize Total = count() by Port = Src_Port\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Denied Inbound Ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Allow\",\"color\":\"green\"},{\"seriesName\":\"Deny\",\"color\":\"red\"}]}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and Status == \\\"Deny\\\"\\r\\n| where (ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| summarize Total = count() by Port = Dst_Port\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Denied Outbound Ports\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"}}]},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Allow\",\"color\":\"green\"},{\"seriesName\":\"Deny\",\"color\":\"red\"}]}},\"customWidth\":\"50\",\"name\":\"query - 1 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and Status == \\\"Deny\\\"\\r\\n| where not(ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| where isnotempty(Src_Country_Code)\\r\\n| summarize Total = count() by ['Source Country'] = Src_Country_Code\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Denied Inbound Traffic by Country\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Dst_Country_Code\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\"\\r\\n| where not(ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| where isnotempty(Src_Country_Code)\\r\\n| summarize count() by Src_Country_Code, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",\"size\":0,\"title\":\"Denied Inbound Traffic by Country\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Dst_Country_Code\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 5 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\" and Status == \\\"Deny\\\"\\r\\n| where (ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| where isnotempty(Dst_Country_Code)\\r\\n| summarize Total = count() by  ['Source Country'] = Dst_Country_Code\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top Denied Outbound Traffic by Country\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Dst_Country_Code\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 5 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SophosXGFirewall\\r\\n| where Log_Type == \\\"Firewall\\\"\\r\\n| where (ipv4_is_match(\\\"10.0.0.0\\\",Src_IP,8) or ipv4_is_match(\\\"172.16.0.0\\\",Src_IP,12) or ipv4_is_match(\\\"192.168.0.0\\\",Src_IP,16))\\r\\n| where isnotempty(Dst_Country_Code)\\r\\n| summarize count() by Dst_Country_Code, bin(TimeGenerated, {TimeRange:grain})\\r\\n\",\"size\":0,\"title\":\"Denied Outbound Traffic by Country\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"coldHot\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}]},\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"Dst_Country_Code\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"50\",\"name\":\"query - 5 - Copy - Copy - Copy\"}],\"fromTemplateId\":\"sentinel-SophosXGFirewall\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=SophosXGFirewallWorkbook; logoFileName=sophos_logo.svg; description=Gain insight into Sophos XG Firewall by analyzing, collecting and correlating firewall data.\nThis workbook provides visibility into network traffic; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Sophos XG Firewall; templateRelativePath=SophosXGFirewall.json; subtitle=; provider=Sophos}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Sophos XG Firewall",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SophosXGFirewall"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "Syslog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SophosXGFirewall",
                      "kind": "DataConnector"
                    },
                    {
                      "contentId": "SyslogAma",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserObject1').parserTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SophosXGFirewall Data Parser with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserObject1').parserVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('parserObject1')._parserName1]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "SophosXGFirewall",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "SophosXGFirewall",
                "query": "let datasource = union isfuzzy=true  (datatable(Source: string)[]), (_GetWatchlist('ASimSourceType') | where SearchKey == 'SophosXGFirewall' | project Source);\nlet forwarder_host_names = dynamic([\"hostname1\", \"hostname2\"]);\nSyslog\n| where Facility == \"local0\"\n| where CollectorHostName in (forwarder_host_names) or Computer in (forwarder_host_names) or CollectorHostName in (datasource) or Computer in (datasource) \n| extend Device = extract(@'device=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDate = extract(@'date=(\\S+)', 1, SyslogMessage),\nTime = extract(@'time=(\\S+)', 1, SyslogMessage),\nTimezone = extract(@'timezone=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDevice_Name = extract(@'device_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDevice_ID = extract(@'device_id=(\\S+)', 1, SyslogMessage),\nLog_ID = extract(@'(log_id|messageid)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nLog_Type = extract(@'log_type=\\\"?([\\w\\s]+)\\\"?', 1, SyslogMessage),\nLog_Component = extract(@'log_component=\\\"([\\w\\s]+)\\\"', 1, SyslogMessage),\nLog_Subtype = extract(@'log_subtype=\\\"([\\w]+)\\\"', 1, SyslogMessage),\nStatus = extract(@'status=\\\"?(\\w+)\\\"?', 1, SyslogMessage),\nPriority = extract(@'priority=(\\S+)', 1, SyslogMessage),\nDuration = extract(@'(con_duration|duration)=(\\S+)', 2, SyslogMessage),\nFW_Rule_ID = extract(@'fw_rule_id=\\\"?(\\S+)\\\"?', 1, SyslogMessage),\nPolicy_Type = extract(@'policy_type=(\\S+)', 1, SyslogMessage),\nUser_Name = extract(@'(user_name|user)=\\\"(\\S+)\\\"',2, SyslogMessage),\nUser_GP = extract(@'(user_gp|user_group)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nIAP = extract(@'iap=(\\S+)', 1, SyslogMessage),\nIPS_Policy_ID = extract(@'ips_policy_id=(\\S+)', 1, SyslogMessage),\nAppfilter_Policy_ID = extract(@'appfilter_policy_id=(\\S+)', 1, SyslogMessage),\nApplication = extract(@'(application|app_name)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nApplication_Risk = extract(@'(application_risk|app_risk)=(\\S+)', 2, SyslogMessage),\nApplication_Technology = extract(@'(application_technology|app_technology)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nApplication_Category = extract(@'(application_category|app_category)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nIn_Interface = extract(@'in_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nOut_Interface = extract(@'out_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nSrc_MAC = extract(@'src_mac=\\\"?([\\w\\:]+)\\\"?', 1, SyslogMessage),\nSrc_IP = extract(@'src_ip=\\\"?([\\w\\.]+)\\\"?', 1, SyslogMessage),\nSrc_Country_Code = extract(@'(src_country|src_country_code)=\\\"?(\\w+)\\\"?', 2, SyslogMessage),\nDst_MAC = extract(@'dst_mac=\\\"?([\\w\\:]+)\\\"?', 1, SyslogMessage),\nDst_IP = extract(@'dst_ip=\\\"?([\\w\\.]+)\\\"?', 1, SyslogMessage),\nDst_Country_Code = extract(@'(dst_country|dst_country_code)=\\\"?(\\w+)\\\"?', 2, SyslogMessage),\nProtocol = extract(@'protocol=\\\"?(\\w+)\\\"?', 1, SyslogMessage),\nSrc_Port = extract(@'src_port=\\\"?(\\d+)\\\"?', 1, SyslogMessage),\nDst_Port = extract(@'dst_port=\\\"?(\\d+)\\\"?', 1, SyslogMessage),\nSent_Pkts = extract(@'(packets_sent|sent_pkts)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nRecv_Pkts = extract(@'(packets_received|recv_pkts)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nSent_Bytes = extract(@'(bytes_sent|sent_bytes)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nRecv_Bytes = extract(@'(bytes_received|recv_bytes)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nTran_Src_IP = extract(@'(src_trans_ip|tran_src_ip)=(\\S+)', 2, SyslogMessage),\nTran_Src_Port = extract(@'(src_trans_port|tran_src_port)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nTran_Dst_IP = extract(@'(dst_trans_ip|tran_dst_ip)=(\\S+)', 2, SyslogMessage),\nTran_Dst_Port = extract(@'(dst_trans_port|tran_dst_port)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nSrczonetype = extract(@'(src_zone_type|srczonetype)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nSrczone = extract(@'(src_zone|srczone)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDstzonetype = extract(@'(dst_zone_type|dstzonetype)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDstzone = extract(@'(dst_zone|dstzone)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDir_Disp = extract(@'dir_disp=\\\"(\\S+)\\\"', 1, SyslogMessage),\nConnevent = extract(@'connevent=\\\"(\\S+)\\\"', 1, SyslogMessage),\nConnID = extract(@'(con_id|connid)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nVconnID = extract(@'(virt_con_id|vconnid)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nHB_Health = extract(@'(hb_status|hb_health)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nMessage = extract(@'message=\\\"([\\S\\s]+)\\.\\\"', 1, SyslogMessage),\nAppResolvedBy = extract(@'appresolvedby=\\\"(\\S+)\\\"', 1, SyslogMessage),\nNat_Rule_ID = extract(@'nat_rule_id=(\\S+)', 1, SyslogMessage),\nVlan_ID = extract(@'vlan_id=\\\"(\\S+)\\\"', 1, SyslogMessage),\nEther_Type = extract(@'ether_type=\\\"(\\S+)\\\"', 1, SyslogMessage),\nBridge_Name = extract(@'bridge_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nWeb_Policy_ID = extract(@'web_policy_id=\\\"(\\S+)\\\"', 1, SyslogMessage),\nApp_IS_Cloud = extract(@'app_is_cloud=\\\"(\\S+)\\\"', 1, SyslogMessage),\nBridge_Display_Name = extract(@'bridge_display_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nIn_Display_Interface = extract(@'in_display_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nOut_Display_Interface = extract(@'out_display_interface=\\\"(\\S+)\\\"', 1, SyslogMessage)\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
              "dependsOn": [
                "[variables('parserObject1')._parserId1]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SophosXGFirewall')]",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "kind": "Parser",
                "version": "[variables('parserObject1').parserVersion1]",
                "source": {
                  "name": "Sophos XG Firewall",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "SophosXGFirewall"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "contentKind": "Parser",
        "displayName": "SophosXGFirewall",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.1.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.1.0')))]",
        "version": "[variables('parserObject1').parserVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('parserObject1')._parserName1]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "SophosXGFirewall",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "SophosXGFirewall",
        "query": "let datasource = union isfuzzy=true  (datatable(Source: string)[]), (_GetWatchlist('ASimSourceType') | where SearchKey == 'SophosXGFirewall' | project Source);\nlet forwarder_host_names = dynamic([\"hostname1\", \"hostname2\"]);\nSyslog\n| where Facility == \"local0\"\n| where CollectorHostName in (forwarder_host_names) or Computer in (forwarder_host_names) or CollectorHostName in (datasource) or Computer in (datasource) \n| extend Device = extract(@'device=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDate = extract(@'date=(\\S+)', 1, SyslogMessage),\nTime = extract(@'time=(\\S+)', 1, SyslogMessage),\nTimezone = extract(@'timezone=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDevice_Name = extract(@'device_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nDevice_ID = extract(@'device_id=(\\S+)', 1, SyslogMessage),\nLog_ID = extract(@'(log_id|messageid)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nLog_Type = extract(@'log_type=\\\"?([\\w\\s]+)\\\"?', 1, SyslogMessage),\nLog_Component = extract(@'log_component=\\\"([\\w\\s]+)\\\"', 1, SyslogMessage),\nLog_Subtype = extract(@'log_subtype=\\\"([\\w]+)\\\"', 1, SyslogMessage),\nStatus = extract(@'status=\\\"?(\\w+)\\\"?', 1, SyslogMessage),\nPriority = extract(@'priority=(\\S+)', 1, SyslogMessage),\nDuration = extract(@'(con_duration|duration)=(\\S+)', 2, SyslogMessage),\nFW_Rule_ID = extract(@'fw_rule_id=\\\"?(\\S+)\\\"?', 1, SyslogMessage),\nPolicy_Type = extract(@'policy_type=(\\S+)', 1, SyslogMessage),\nUser_Name = extract(@'(user_name|user)=\\\"(\\S+)\\\"',2, SyslogMessage),\nUser_GP = extract(@'(user_gp|user_group)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nIAP = extract(@'iap=(\\S+)', 1, SyslogMessage),\nIPS_Policy_ID = extract(@'ips_policy_id=(\\S+)', 1, SyslogMessage),\nAppfilter_Policy_ID = extract(@'appfilter_policy_id=(\\S+)', 1, SyslogMessage),\nApplication = extract(@'(application|app_name)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nApplication_Risk = extract(@'(application_risk|app_risk)=(\\S+)', 2, SyslogMessage),\nApplication_Technology = extract(@'(application_technology|app_technology)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nApplication_Category = extract(@'(application_category|app_category)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nIn_Interface = extract(@'in_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nOut_Interface = extract(@'out_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nSrc_MAC = extract(@'src_mac=\\\"?([\\w\\:]+)\\\"?', 1, SyslogMessage),\nSrc_IP = extract(@'src_ip=\\\"?([\\w\\.]+)\\\"?', 1, SyslogMessage),\nSrc_Country_Code = extract(@'(src_country|src_country_code)=\\\"?(\\w+)\\\"?', 2, SyslogMessage),\nDst_MAC = extract(@'dst_mac=\\\"?([\\w\\:]+)\\\"?', 1, SyslogMessage),\nDst_IP = extract(@'dst_ip=\\\"?([\\w\\.]+)\\\"?', 1, SyslogMessage),\nDst_Country_Code = extract(@'(dst_country|dst_country_code)=\\\"?(\\w+)\\\"?', 2, SyslogMessage),\nProtocol = extract(@'protocol=\\\"?(\\w+)\\\"?', 1, SyslogMessage),\nSrc_Port = extract(@'src_port=\\\"?(\\d+)\\\"?', 1, SyslogMessage),\nDst_Port = extract(@'dst_port=\\\"?(\\d+)\\\"?', 1, SyslogMessage),\nSent_Pkts = extract(@'(packets_sent|sent_pkts)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nRecv_Pkts = extract(@'(packets_received|recv_pkts)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nSent_Bytes = extract(@'(bytes_sent|sent_bytes)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nRecv_Bytes = extract(@'(bytes_received|recv_bytes)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nTran_Src_IP = extract(@'(src_trans_ip|tran_src_ip)=(\\S+)', 2, SyslogMessage),\nTran_Src_Port = extract(@'(src_trans_port|tran_src_port)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nTran_Dst_IP = extract(@'(dst_trans_ip|tran_dst_ip)=(\\S+)', 2, SyslogMessage),\nTran_Dst_Port = extract(@'(dst_trans_port|tran_dst_port)=\\\"?(\\d+)\\\"?', 2, SyslogMessage),\nSrczonetype = extract(@'(src_zone_type|srczonetype)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nSrczone = extract(@'(src_zone|srczone)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDstzonetype = extract(@'(dst_zone_type|dstzonetype)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDstzone = extract(@'(dst_zone|dstzone)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nDir_Disp = extract(@'dir_disp=\\\"(\\S+)\\\"', 1, SyslogMessage),\nConnevent = extract(@'connevent=\\\"(\\S+)\\\"', 1, SyslogMessage),\nConnID = extract(@'(con_id|connid)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nVconnID = extract(@'(virt_con_id|vconnid)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nHB_Health = extract(@'(hb_status|hb_health)=\\\"(\\S+)\\\"', 2, SyslogMessage),\nMessage = extract(@'message=\\\"([\\S\\s]+)\\.\\\"', 1, SyslogMessage),\nAppResolvedBy = extract(@'appresolvedby=\\\"(\\S+)\\\"', 1, SyslogMessage),\nNat_Rule_ID = extract(@'nat_rule_id=(\\S+)', 1, SyslogMessage),\nVlan_ID = extract(@'vlan_id=\\\"(\\S+)\\\"', 1, SyslogMessage),\nEther_Type = extract(@'ether_type=\\\"(\\S+)\\\"', 1, SyslogMessage),\nBridge_Name = extract(@'bridge_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nWeb_Policy_ID = extract(@'web_policy_id=\\\"(\\S+)\\\"', 1, SyslogMessage),\nApp_IS_Cloud = extract(@'app_is_cloud=\\\"(\\S+)\\\"', 1, SyslogMessage),\nBridge_Display_Name = extract(@'bridge_display_name=\\\"(\\S+)\\\"', 1, SyslogMessage),\nIn_Display_Interface = extract(@'in_display_interface=\\\"(\\S+)\\\"', 1, SyslogMessage),\nOut_Display_Interface = extract(@'out_display_interface=\\\"(\\S+)\\\"', 1, SyslogMessage)\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
      "dependsOn": [
        "[variables('parserObject1')._parserId1]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SophosXGFirewall')]",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "kind": "Parser",
        "version": "[variables('parserObject1').parserVersion1]",
        "source": {
          "kind": "Solution",
          "name": "Sophos XG Firewall",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "SophosXGFirewall"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Sophos XG Firewall",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Sophos%20XG%20Firewall/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.sophos.com/products/next-gen-firewall\">Sophos XG Firewall</a> solution for Microsoft Sentinel enables you to ingest Sophos XG Firewall logs into Microsoft Sentinel.</p>\n<p>This solution is dependent on the Syslog solution containing the Syslog via AMA connector to collect the logs. The Syslog  solution will be installed as part of this solution installation.</p>\n<p><strong>NOTE</strong>: Microsoft recommends installation of Syslog via AMA Connector. Legacy connector uses the Log Analytics agent which were deprecated on <strong>Aug 31, 2024.</strong>. Using MMA and AMA on same machine can cause log duplication and extra ingestion cost <a href=\"https://learn.microsoft.com/en-us/azure/sentinel/ama-migrate\">more details</a>.</p>\n<p><strong>Parsers:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/sophos_logo.svg\"width=\"75px\"height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Sophos XG Firewall",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "SophosXGFirewall"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('parserObject1').parserContentId1]",
              "version": "[variables('parserObject1').parserVersion1]"
            },
            {
              "kind": "Solution",
              "contentId": "azuresentinel.azure-sentinel-solution-syslog"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "Sophos"
        ],
        "categories": {
          "domains": [
            "Security - Network"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
