{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Cloudflare"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Cloudflare",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "cloudflare.cloudflare_sentinel",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "CloudflareDataConnector",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "CloudflareDataConnector",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "parserVersion1": "1.0.0",
    "parserContentId1": "Cloudflare-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "Cloudflare",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "CloudflareWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "huntingQueryVersion1": "1.0.0",
    "huntingQuerycontentId1": "5d72f483-929a-498a-b840-dff7deed2116",
    "_huntingQuerycontentId1": "[variables('huntingQuerycontentId1')]",
    "huntingQueryId1": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId1'))]",
    "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId1')))]",
    "huntingQueryVersion2": "1.0.0",
    "huntingQuerycontentId2": "20ef3865-fd1f-44a4-ac8f-8d026cf954e0",
    "_huntingQuerycontentId2": "[variables('huntingQuerycontentId2')]",
    "huntingQueryId2": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId2'))]",
    "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId2')))]",
    "huntingQueryVersion3": "1.0.0",
    "huntingQuerycontentId3": "d72d0055-ae52-43b5-859e-db72e5ef183a",
    "_huntingQuerycontentId3": "[variables('huntingQuerycontentId3')]",
    "huntingQueryId3": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId3'))]",
    "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId3')))]",
    "huntingQueryVersion4": "1.0.0",
    "huntingQuerycontentId4": "a6f1938f-2f87-446c-83ac-624c277cfd32",
    "_huntingQuerycontentId4": "[variables('huntingQuerycontentId4')]",
    "huntingQueryId4": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId4'))]",
    "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId4')))]",
    "huntingQueryVersion5": "1.0.0",
    "huntingQuerycontentId5": "7c8f0bed-b25c-4d48-9afa-c505e141bf4b",
    "_huntingQuerycontentId5": "[variables('huntingQuerycontentId5')]",
    "huntingQueryId5": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId5'))]",
    "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId5')))]",
    "huntingQueryVersion6": "1.0.0",
    "huntingQuerycontentId6": "e1a9febc-6b37-47e6-b5a7-0eec7638ba82",
    "_huntingQuerycontentId6": "[variables('huntingQuerycontentId6')]",
    "huntingQueryId6": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId6'))]",
    "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId6')))]",
    "huntingQueryVersion7": "1.0.0",
    "huntingQuerycontentId7": "eb7b88ab-47b1-483f-95b3-2b315d98d465",
    "_huntingQuerycontentId7": "[variables('huntingQuerycontentId7')]",
    "huntingQueryId7": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId7'))]",
    "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId7')))]",
    "huntingQueryVersion8": "1.0.0",
    "huntingQuerycontentId8": "8a72cdb0-97d9-4547-9eca-1bdea2ccd796",
    "_huntingQuerycontentId8": "[variables('huntingQuerycontentId8')]",
    "huntingQueryId8": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId8'))]",
    "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId8')))]",
    "huntingQueryVersion9": "1.0.0",
    "huntingQuerycontentId9": "9fc7d945-0e82-4664-aca0-dc121a5cd7be",
    "_huntingQuerycontentId9": "[variables('huntingQuerycontentId9')]",
    "huntingQueryId9": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId9'))]",
    "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId9')))]",
    "huntingQueryVersion10": "1.0.0",
    "huntingQuerycontentId10": "0be3ddc1-99db-4153-ba3c-2c1e5c82560d",
    "_huntingQuerycontentId10": "[variables('huntingQuerycontentId10')]",
    "huntingQueryId10": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId10'))]",
    "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId10')))]",
    "analyticRuleVersion1": "1.0.0",
    "analyticRulecontentId1": "a7ce6135-9d55-4f14-b058-adc2e920a4fa",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "1.0.0",
    "analyticRulecontentId2": "729c6d21-fad9-4a6a-9c7f-482393c95957",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "analyticRuleVersion3": "1.0.0",
    "analyticRulecontentId3": "ef877d68-755f-4cf1-ac1d-f336e395667c",
    "_analyticRulecontentId3": "[variables('analyticRulecontentId3')]",
    "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId3')))]",
    "analyticRuleVersion4": "1.0.0",
    "analyticRulecontentId4": "fc50076a-0275-43d5-b9dd-38346c061f67",
    "_analyticRulecontentId4": "[variables('analyticRulecontentId4')]",
    "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId4'))]",
    "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId4')))]",
    "analyticRuleVersion5": "1.0.0",
    "analyticRulecontentId5": "40554544-6e4a-4413-8d14-bf2de939c5d9",
    "_analyticRulecontentId5": "[variables('analyticRulecontentId5')]",
    "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId5'))]",
    "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId5')))]",
    "analyticRuleVersion6": "1.0.0",
    "analyticRulecontentId6": "7313352a-09f6-4a84-88bd-6f17f1cbeb8f",
    "_analyticRulecontentId6": "[variables('analyticRulecontentId6')]",
    "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId6'))]",
    "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId6')))]",
    "analyticRuleVersion7": "1.0.1",
    "analyticRulecontentId7": "f32142b1-4bcb-45c0-92e4-2ddc18768522",
    "_analyticRulecontentId7": "[variables('analyticRulecontentId7')]",
    "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId7'))]",
    "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId7')))]",
    "analyticRuleVersion8": "1.0.0",
    "analyticRulecontentId8": "dcb797cd-a4cd-4306-897b-7991f71d7e27",
    "_analyticRulecontentId8": "[variables('analyticRulecontentId8')]",
    "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId8'))]",
    "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId8')))]",
    "analyticRuleVersion9": "1.0.0",
    "analyticRulecontentId9": "f53fe2a9-96b5-454c-827e-cf1764a67fb0",
    "_analyticRulecontentId9": "[variables('analyticRulecontentId9')]",
    "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId9'))]",
    "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId9')))]",
    "analyticRuleVersion10": "1.0.0",
    "analyticRulecontentId10": "4d9d00b9-31a6-49e4-88c1-9e68277053ac",
    "_analyticRulecontentId10": "[variables('analyticRulecontentId10')]",
    "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId10'))]",
    "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId10')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Cloudflare data connector with template",
        "displayName": "Cloudflare template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Cloudflare data connector with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cloudflare (Preview) (using Azure Functions)",
                  "publisher": "Cloudflare",
                  "descriptionMarkdown": "The Cloudflare data connector provides the capability to ingest [Cloudflare logs](https://developers.cloudflare.com/logs/) into Microsoft Sentinel using the Cloudflare Logpush and Azure Blob Storage. Refer to [Cloudflare  documentation](https://developers.cloudflare.com/logs/logpush) for more information.",
                  "additionalRequirementBanner": ">This data connector depends on a parser based on a Kusto Function to work as expected [**Cloudflare**](https://aka.ms/sentinel-CloudflareDataConnector-parser) which is deployed with the Microsoft Sentinel Solution.",
                  "graphQueries": [
                    {
                      "metricName": "Cloudflare logs",
                      "legend": "Cloudflare_CL",
                      "baseQuery": "Cloudflare_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All Cloudflare logs",
                      "query": "Cloudflare_CL\n| sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "Cloudflare_CL",
                      "lastDataReceivedQuery": "Cloudflare_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "Cloudflare_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Azure Blob Storage connection string and container name",
                        "description": "Azure Blob Storage connection string and container name where the logs are pushed to by Cloudflare Logpush. [See the documentation to learn more about creating Azure Blob Storage container.](https://learn.microsoft.com/azure/storage/blobs/storage-quickstart-blobs-portal)"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Azure Blob Storage API to pull logs into Microsoft Sentinel. This might result in additional costs for data ingestion and for storing data in Azure Blob Storage costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) and [Azure Blob Storage pricing page](https://azure.microsoft.com/pricing/details/storage/blobs/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**Cloudflare**](https://aka.ms/sentinel-CloudflareDataConnector-parser) which is deployed with the Microsoft Sentinel Solution."
                    },
                    {
                      "description": "**STEP 1 - Configuration of the Cloudflare Logpush**\n\nSee documentation to [setup Cloudflare Logpush to Microsoft Azure](https://developers.cloudflare.com/logs/logpush/logpush-dashboard)"
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Cloudflare data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as Azure Blob Storage connection string and container name, readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the Cloudflare data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-CloudflareDataConnector-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Azure Blob Storage Container Name**, **Azure Blob Storage Connection String**, **Microsoft Sentinel Workspace Id**, **Microsoft Sentinel Shared Key**\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the Cloudflare data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-CloudflareDataConnector-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. CloudflareXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tCONTAINER_NAME\n\t\tAZURE_STORAGE_CONNECTION_STRING\n\t\tWORKSPACE_ID\n\t\tSHARED_KEY\n\t\tlogAnalyticsUri (Optional)\n - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://WORKSPACE_ID.ods.opinsights.azure.us`. \n4. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cloudflare",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cloudflare (Preview) (using Azure Functions)",
          "publisher": "Cloudflare",
          "descriptionMarkdown": "The Cloudflare data connector provides the capability to ingest [Cloudflare logs](https://developers.cloudflare.com/logs/) into Microsoft Sentinel using the Cloudflare Logpush and Azure Blob Storage. Refer to [Cloudflare  documentation](https://developers.cloudflare.com/logs/logpush) for more information.",
          "graphQueries": [
            {
              "metricName": "Cloudflare logs",
              "legend": "Cloudflare_CL",
              "baseQuery": "Cloudflare_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "Cloudflare_CL",
              "lastDataReceivedQuery": "Cloudflare_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "Cloudflare_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "All Cloudflare logs",
              "query": "Cloudflare_CL\n| sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Azure Blob Storage connection string and container name",
                "description": "Azure Blob Storage connection string and container name where the logs are pushed to by Cloudflare Logpush. [See the documentation to learn more about creating Azure Blob Storage container.](https://learn.microsoft.com/azure/storage/blobs/storage-quickstart-blobs-portal)"
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Azure Blob Storage API to pull logs into Microsoft Sentinel. This might result in additional costs for data ingestion and for storing data in Azure Blob Storage costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) and [Azure Blob Storage pricing page](https://azure.microsoft.com/pricing/details/storage/blobs/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**Cloudflare**](https://aka.ms/sentinel-CloudflareDataConnector-parser) which is deployed with the Microsoft Sentinel Solution."
            },
            {
              "description": "**STEP 1 - Configuration of the Cloudflare Logpush**\n\nSee documentation to [setup Cloudflare Logpush to Microsoft Azure](https://developers.cloudflare.com/logs/logpush/logpush-dashboard)"
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Cloudflare data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as Azure Blob Storage connection string and container name, readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Cloudflare data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-CloudflareDataConnector-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Azure Blob Storage Container Name**, **Azure Blob Storage Connection String**, **Microsoft Sentinel Workspace Id**, **Microsoft Sentinel Shared Key**\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Cloudflare data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-CloudflareDataConnector-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. CloudflareXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tCONTAINER_NAME\n\t\tAZURE_STORAGE_CONNECTION_STRING\n\t\tWORKSPACE_ID\n\t\tSHARED_KEY\n\t\tlogAnalyticsUri (Optional)\n - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://WORKSPACE_ID.ods.opinsights.azure.us`. \n4. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": ">This data connector depends on a parser based on a Kusto Function to work as expected [**Cloudflare**](https://aka.ms/sentinel-CloudflareDataConnector-parser) which is deployed with the Microsoft Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "Cloudflare Data Parser with template",
        "displayName": "Cloudflare Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Cloudflare Data Parser with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare",
                "category": "Samples",
                "functionAlias": "Cloudflare",
                "query": "\nCloudflare_CL\r\n| extend\r\n    BotScore_d=column_ifexists('BotScore_d', ''),\r\n    BotScoreSrc_s=column_ifexists('BotScoreSrc_s', ''),\r\n    CacheCacheStatus_s=column_ifexists('CacheCacheStatus_s', ''),\r\n    CacheResponseBytes_d=column_ifexists('CacheResponseBytes_d', ''),\r\n    CacheResponseStatus_d=column_ifexists('CacheResponseStatus_d', ''),\r\n    CacheTieredFill_b=column_ifexists('CacheTieredFill_b', ''),\r\n    ClientASN_d=column_ifexists('ClientASN_d', ''),\r\n    ClientCountry_s=column_ifexists('ClientCountry_s', ''),\r\n    ClientDeviceType_s=column_ifexists('ClientDeviceType_s', ''),\r\n    ClientIP_s=column_ifexists('ClientIP_s', ''),\r\n    ClientIPClass_s=column_ifexists('ClientIPClass_s', ''),\r\n    ClientRequestHost_s=column_ifexists('ClientRequestHost_s', ''),\r\n    ClientRequestMethod_s=column_ifexists('ClientRequestMethod_s', ''),\r\n    ClientRequestPath_s=column_ifexists('ClientRequestPath_s', ''),\r\n    ClientRequestProtocol_s=column_ifexists('ClientRequestProtocol_s', ''),\r\n    ClientRequestReferer_s=column_ifexists('ClientRequestReferer_s', ''),\r\n    ClientRequestURI_s=column_ifexists('ClientRequestURI_s', ''),\r\n    ClientRequestUserAgent_s=column_ifexists('ClientRequestUserAgent_s', ''),\r\n    ClientSSLCipher_s=column_ifexists('ClientSSLCipher_s', ''),\r\n    ClientSSLProtocol_s=column_ifexists('ClientSSLProtocol_s', ''),\r\n    ClientXRequestedWith_s=column_ifexists('ClientXRequestedWith_s', ''),\r\n    EdgeColoCode_s=column_ifexists('EdgeColoCode_s', ''),\r\n    EdgeColoID_d=column_ifexists('EdgeColoID_d', ''),\r\n    EdgeEndTimestamp_t=column_ifexists('EdgeEndTimestamp_t', ''),\r\n    EdgePathingOp_s=column_ifexists('EdgePathingOp_s', ''),\r\n    EdgePathingSrc_s=column_ifexists('EdgePathingSrc_s', ''),\r\n    EdgePathingStatus_s=column_ifexists('EdgePathingStatus_s', ''),\r\n    EdgeRateLimitAction_s=column_ifexists('EdgeRateLimitAction_s', ''),\r\n    EdgeRateLimitID_d=column_ifexists('EdgeRateLimitID_d', ''),\r\n    EdgeRequestHost_s=column_ifexists('EdgeRequestHost_s', ''),\r\n    EdgeResponseBytes_d=column_ifexists('EdgeResponseBytes_d', ''),\r\n    EdgeResponseCompressionRatio_d=column_ifexists('EdgeResponseCompressionRatio_d', ''),\r\n    EdgeResponseContentType_s=column_ifexists('EdgeResponseContentType_s', ''),\r\n    EdgeResponseStatus_d=column_ifexists('EdgeResponseStatus_d', ''),\r\n    EdgeServerIP_s=column_ifexists('EdgeServerIP_s', ''),\r\n    EdgeStartTimestamp_t=column_ifexists('EdgeStartTimestamp_t', ''),\r\n    FirewallMatchesActions_s=column_ifexists('FirewallMatchesActions_s', ''),\r\n    FirewallMatchesRuleIDs_s=column_ifexists('FirewallMatchesRuleIDs_s', ''),\r\n    FirewallMatchesSources_s=column_ifexists('FirewallMatchesSources_s', ''),\r\n    OriginIP_s=column_ifexists('OriginIP_s', ''),\r\n    OriginResponseBytes_d=column_ifexists('OriginResponseBytes_d', ''),\r\n    OriginResponseHTTPExpires_s=column_ifexists('OriginResponseHTTPExpires_s', ''),\r\n    OriginResponseHTTPLastModified_s=column_ifexists('OriginResponseHTTPLastModified_s', ''),\r\n    OriginResponseStatus_d=column_ifexists('OriginResponseStatus_d', ''),\r\n    OriginResponseTime_d=column_ifexists('OriginResponseTime_d', ''),\r\n    OriginSSLProtocol_s=column_ifexists('OriginSSLProtocol_s', ''),\r\n    ParentRayID_s=column_ifexists('ParentRayID_s', ''),\r\n    RayID_s=column_ifexists('RayID_s', ''),\r\n    SecurityLevel_s=column_ifexists('SecurityLevel_s', ''),\r\n    WAFAction_s=column_ifexists('WAFAction_s', ''),\r\n    WAFFlags_s=column_ifexists('WAFFlags_s', ''),\r\n    WAFMatchedVar_s=column_ifexists('WAFMatchedVar_s', ''),\r\n    WAFProfile_s=column_ifexists('WAFProfile_s', ''),\r\n    WAFRuleID_s=column_ifexists('WAFRuleID_s', ''),\r\n    WAFRuleMessage_s=column_ifexists('WAFRuleMessage_s', ''),\r\n    WorkerCPUTime_d=column_ifexists('WorkerCPUTime_d', ''),\r\n    WorkerStatus_s=column_ifexists('WorkerStatus_s', ''),\r\n    WorkerSubrequest_b=column_ifexists('WorkerSubrequest_b', ''),\r\n    WorkerSubrequestCount_d=column_ifexists('WorkerSubrequestCount_d', ''),\r\n    ZoneID_d=column_ifexists('ZoneID_d', ''),\r\n    Application_s=column_ifexists('Application_s', ''),\r\n    ClientMatchedIpFirewall_s=column_ifexists('ClientMatchedIpFirewall_s', ''),\r\n    ClientProto_s=column_ifexists('ClientProto_s', ''),\r\n    ClientTcpRtt_d=column_ifexists('ClientTcpRtt_d', ''),\r\n    ClientTlsCipher_s=column_ifexists('ClientTlsCipher_s', ''),\r\n    ClientTlsClientHelloServerName_s=column_ifexists('ClientTlsClientHelloServerName_s', ''),\r\n    ClientTlsProtocol_s=column_ifexists('ClientTlsProtocol_s', ''),\r\n    ClientTlsStatus_s=column_ifexists('ClientTlsStatus_s', ''),\r\n    ColoCode_s=column_ifexists('ColoCode_s', ''),\r\n    ConnectTimestamp_t=column_ifexists('ConnectTimestamp_t', ''),\r\n    DisconnectTimestamp_t=column_ifexists('DisconnectTimestamp_t', ''),\r\n    Event_s=column_ifexists('Event_s', ''),\r\n    IpFirewall_b=column_ifexists('IpFirewall_b', ''),\r\n    OriginBytes_d=column_ifexists('OriginBytes_d', ''),\r\n    OriginPort_d=column_ifexists('OriginPort_d', ''),\r\n    OriginProto_s=column_ifexists('OriginProto_s', ''),\r\n    OriginTcpRtt_d=column_ifexists('OriginTcpRtt_d', ''),\r\n    OriginTlsCipher_s=column_ifexists('OriginTlsCipher_s', ''),\r\n    OriginTlsFingerprint_s=column_ifexists('OriginTlsFingerprint_s', ''),\r\n    OriginTlsMode_s=column_ifexists('OriginTlsMode_s', ''),\r\n    OriginTlsProtocol_s=column_ifexists('OriginTlsProtocol_s', ''),\r\n    OriginTlsStatus_s=column_ifexists('OriginTlsStatus_s', ''),\r\n    ProxyProtocol_s=column_ifexists('ProxyProtocol_s', ''),\r\n    Status_d=column_ifexists('Status_d', ''),\r\n    Timestamp_t=column_ifexists('Timestamp_t', ''),\r\n    Action_s=column_ifexists('Action_s', ''),\r\n    ClientASNDescription_s=column_ifexists('ClientASNDescription_s', ''),\r\n    ClientRefererHost_s=column_ifexists('ClientRefererHost_s', ''),\r\n    ClientRefererPath_s=column_ifexists('ClientRefererPath_s', ''),\r\n    ClientRefererQuery_s=column_ifexists('ClientRefererQuery_s', ''),\r\n    ClientRefererScheme_s=column_ifexists('ClientRefererScheme_s', ''),\r\n    ClientRequestQuery_s=column_ifexists('ClientRequestQuery_s', ''),\r\n    ClientRequestScheme_s=column_ifexists('ClientRequestScheme_s', ''),\r\n    Datetime_t=column_ifexists('Datetime_t', ''),\r\n    Kind_s=column_ifexists('Kind_s', ''),\r\n    MatchIndex_d=column_ifexists('MatchIndex_d', ''),\r\n    OriginatorRayID_s=column_ifexists('OriginatorRayID_s', ''),\r\n    RuleID_s=column_ifexists('RuleID_s', ''),\r\n    Source_s=column_ifexists('Source_s', '')\r\n| extend\r\n    SrcDvcType=iff(isempty(ClientDeviceType_s), iff(isempty(Source_s), '', Source_s), ClientDeviceType_s),\r\n    TlsCipher=iff(isempty(ClientSSLCipher_s), iff(isempty(ClientTlsCipher_s), '', ClientTlsCipher_s), ClientSSLCipher_s),\r\n    TlsVersion=iff(isempty(ClientSSLProtocol_s), iff(isempty(ClientTlsProtocol_s), '', ClientTlsProtocol_s), ClientSSLProtocol_s),\r\n    DvcAction=iff(isempty(FirewallMatchesActions_s), iff(isempty(Event_s), iff(isempty(Action_s), '', Action_s), Event_s), FirewallMatchesActions_s),\r\n    NetworkRuleName=iff(isempty(FirewallMatchesRuleIDs_s), iff(isempty(RuleID_s), '', RuleID_s), FirewallMatchesRuleIDs_s),\r\n    ClientRequestBytes_d=column_ifexists('ClientRequestBytes_d', column_ifexists('ClientBytes_d', '')),\r\n    ClientSrcPort_d=column_ifexists('ClientSrcPort_d', column_ifexists('ClientPort_d', '')),\r\n    EdgeResponseBytes_d=column_ifexists('EdgeResponseBytes_d', column_ifexists('OriginBytes_d', ''))\r\n| project-rename\r\n    SrcBytes=ClientRequestBytes_d,\r\n    SrcPortNumber=ClientSrcPort_d,\r\n    DstBytes=EdgeResponseBytes_d,\r\n    BotScore=BotScore_d,\r\n    BotScoreSrc=BotScoreSrc_s,\r\n    CacheCacheStatus=CacheCacheStatus_s,\r\n    CacheResponseBytes=CacheResponseBytes_d,\r\n    CacheResponseStatus=CacheResponseStatus_d,\r\n    CacheTieredFill=CacheTieredFill_b,\r\n    ClientASN=ClientASN_d,\r\n    SrcGeoCountry=ClientCountry_s,\r\n    SrcIpAddr=ClientIP_s,\r\n    ClientIPClass=ClientIPClass_s,\r\n    HttpRequestHeaderHost=ClientRequestHost_s,\r\n    HttpRequestMethod=ClientRequestMethod_s,\r\n    ClientRequestPath=ClientRequestPath_s,\r\n    ClientRequestProtocol=ClientRequestProtocol_s,\r\n    HttpReferrerOriginal=ClientRequestReferer_s,\r\n    ClientRequestURI=ClientRequestURI_s,\r\n    HttpUserAgentOriginal=ClientRequestUserAgent_s,\r\n    ClientXRequestedWith=ClientXRequestedWith_s,\r\n    EdgeColoCode=EdgeColoCode_s,\r\n    EdgeColoID=EdgeColoID_d,\r\n    EdgeEndTimestamp=EdgeEndTimestamp_t,\r\n    EdgePathingOp=EdgePathingOp_s,\r\n    EdgePathingSrc=EdgePathingSrc_s,\r\n    EdgePathingStatus=EdgePathingStatus_s,\r\n    EdgeRateLimitAction=EdgeRateLimitAction_s,\r\n    EdgeRateLimitID=EdgeRateLimitID_d,\r\n    EdgeRequestHost=EdgeRequestHost_s,\r\n    EdgeResponseCompressionRatio=EdgeResponseCompressionRatio_d,\r\n    HttpContentType=EdgeResponseContentType_s,\r\n    EdgeResponseStatus=EdgeResponseStatus_d,\r\n    EdgeServerIP=EdgeServerIP_s,\r\n    EdgeStartTimestamp=EdgeStartTimestamp_t,\r\n    FirewallMatchesSources=FirewallMatchesSources_s,\r\n    DstIpAddr=OriginIP_s,\r\n    OriginResponseBytes=OriginResponseBytes_d,\r\n    OriginResponseHTTPExpires=OriginResponseHTTPExpires_s,\r\n    OriginResponseHTTPLastModified=OriginResponseHTTPLastModified_s,\r\n    HttpStatusCode=OriginResponseStatus_d,\r\n    OriginResponseTime=OriginResponseTime_d,\r\n    OriginSSLProtocol=OriginSSLProtocol_s,\r\n    ParentRayID=ParentRayID_s,\r\n    RayID=RayID_s,\r\n    SecurityLevel=SecurityLevel_s,\r\n    WAFAction=WAFAction_s,\r\n    WAFFlags=WAFFlags_s,\r\n    WAFMatchedVar=WAFMatchedVar_s,\r\n    WAFProfile=WAFProfile_s,\r\n    WAFRuleID=WAFRuleID_s,\r\n    WAFRuleMessage=WAFRuleMessage_s,\r\n    WorkerCPUTime=WorkerCPUTime_d,\r\n    WorkerStatus=WorkerStatus_s,\r\n    WorkerSubrequest=WorkerSubrequest_b,\r\n    WorkerSubrequestCount=WorkerSubrequestCount_d,\r\n    ZoneID=ZoneID_d,\r\n    Application=Application_s,\r\n    ClientMatchedIpFirewall=ClientMatchedIpFirewall_s,\r\n    NetworkProtocol=ClientProto_s,\r\n    ClientTcpRtt=ClientTcpRtt_d,\r\n    ClientTlsClientHelloServerName=ClientTlsClientHelloServerName_s,\r\n    ClientTlsStatus=ClientTlsStatus_s,\r\n    ColoCode=ColoCode_s,\r\n    ConnectTimestamp=ConnectTimestamp_t,\r\n    DisconnectTimestamp=DisconnectTimestamp_t,\r\n    IpFirewall=IpFirewall_b,\r\n    DstPortNumber=OriginPort_d,\r\n    OriginProto=OriginProto_s,\r\n    OriginTcpRtt=OriginTcpRtt_d,\r\n    OriginTlsCipher=OriginTlsCipher_s,\r\n    OriginTlsFingerprint=OriginTlsFingerprint_s,\r\n    OriginTlsMode=OriginTlsMode_s,\r\n    OriginTlsProtocol=OriginTlsProtocol_s,\r\n    OriginTlsStatus=OriginTlsStatus_s,\r\n    ProxyProtocol=ProxyProtocol_s,\r\n    EventResult=Status_d,\r\n    Timestamp=Timestamp_t,\r\n    ClientASNDescription=ClientASNDescription_s,\r\n    ClientRefererHost=ClientRefererHost_s,\r\n    ClientRefererPath=ClientRefererPath_s,\r\n    ClientRefererQuery=ClientRefererQuery_s,\r\n    ClientRefererScheme=ClientRefererScheme_s,\r\n    ClientRequestQuery=ClientRequestQuery_s,\r\n    ClientRequestScheme=ClientRequestScheme_s,\r\n    Datetime=Datetime_t,\r\n    EventSubType=Kind_s,\r\n    MatchIndex=MatchIndex_d,\r\n    OriginatorRayID=OriginatorRayID_s\r\n| project-away \r\n    ClientDeviceType_s,\r\n    Source_s,\r\n    ClientSSLCipher_s,\r\n    ClientTlsCipher_s,\r\n    ClientSSLProtocol_s,\r\n    ClientTlsProtocol_s,\r\n    FirewallMatchesActions_s,\r\n    Event_s,\r\n    Action_s,\r\n    FirewallMatchesRuleIDs_s,\r\n    RuleID_s",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "Cloudflare"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Cloudflare",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Cloudflare",
        "category": "Samples",
        "functionAlias": "Cloudflare",
        "query": "\nCloudflare_CL\r\n| extend\r\n    BotScore_d=column_ifexists('BotScore_d', ''),\r\n    BotScoreSrc_s=column_ifexists('BotScoreSrc_s', ''),\r\n    CacheCacheStatus_s=column_ifexists('CacheCacheStatus_s', ''),\r\n    CacheResponseBytes_d=column_ifexists('CacheResponseBytes_d', ''),\r\n    CacheResponseStatus_d=column_ifexists('CacheResponseStatus_d', ''),\r\n    CacheTieredFill_b=column_ifexists('CacheTieredFill_b', ''),\r\n    ClientASN_d=column_ifexists('ClientASN_d', ''),\r\n    ClientCountry_s=column_ifexists('ClientCountry_s', ''),\r\n    ClientDeviceType_s=column_ifexists('ClientDeviceType_s', ''),\r\n    ClientIP_s=column_ifexists('ClientIP_s', ''),\r\n    ClientIPClass_s=column_ifexists('ClientIPClass_s', ''),\r\n    ClientRequestHost_s=column_ifexists('ClientRequestHost_s', ''),\r\n    ClientRequestMethod_s=column_ifexists('ClientRequestMethod_s', ''),\r\n    ClientRequestPath_s=column_ifexists('ClientRequestPath_s', ''),\r\n    ClientRequestProtocol_s=column_ifexists('ClientRequestProtocol_s', ''),\r\n    ClientRequestReferer_s=column_ifexists('ClientRequestReferer_s', ''),\r\n    ClientRequestURI_s=column_ifexists('ClientRequestURI_s', ''),\r\n    ClientRequestUserAgent_s=column_ifexists('ClientRequestUserAgent_s', ''),\r\n    ClientSSLCipher_s=column_ifexists('ClientSSLCipher_s', ''),\r\n    ClientSSLProtocol_s=column_ifexists('ClientSSLProtocol_s', ''),\r\n    ClientXRequestedWith_s=column_ifexists('ClientXRequestedWith_s', ''),\r\n    EdgeColoCode_s=column_ifexists('EdgeColoCode_s', ''),\r\n    EdgeColoID_d=column_ifexists('EdgeColoID_d', ''),\r\n    EdgeEndTimestamp_t=column_ifexists('EdgeEndTimestamp_t', ''),\r\n    EdgePathingOp_s=column_ifexists('EdgePathingOp_s', ''),\r\n    EdgePathingSrc_s=column_ifexists('EdgePathingSrc_s', ''),\r\n    EdgePathingStatus_s=column_ifexists('EdgePathingStatus_s', ''),\r\n    EdgeRateLimitAction_s=column_ifexists('EdgeRateLimitAction_s', ''),\r\n    EdgeRateLimitID_d=column_ifexists('EdgeRateLimitID_d', ''),\r\n    EdgeRequestHost_s=column_ifexists('EdgeRequestHost_s', ''),\r\n    EdgeResponseBytes_d=column_ifexists('EdgeResponseBytes_d', ''),\r\n    EdgeResponseCompressionRatio_d=column_ifexists('EdgeResponseCompressionRatio_d', ''),\r\n    EdgeResponseContentType_s=column_ifexists('EdgeResponseContentType_s', ''),\r\n    EdgeResponseStatus_d=column_ifexists('EdgeResponseStatus_d', ''),\r\n    EdgeServerIP_s=column_ifexists('EdgeServerIP_s', ''),\r\n    EdgeStartTimestamp_t=column_ifexists('EdgeStartTimestamp_t', ''),\r\n    FirewallMatchesActions_s=column_ifexists('FirewallMatchesActions_s', ''),\r\n    FirewallMatchesRuleIDs_s=column_ifexists('FirewallMatchesRuleIDs_s', ''),\r\n    FirewallMatchesSources_s=column_ifexists('FirewallMatchesSources_s', ''),\r\n    OriginIP_s=column_ifexists('OriginIP_s', ''),\r\n    OriginResponseBytes_d=column_ifexists('OriginResponseBytes_d', ''),\r\n    OriginResponseHTTPExpires_s=column_ifexists('OriginResponseHTTPExpires_s', ''),\r\n    OriginResponseHTTPLastModified_s=column_ifexists('OriginResponseHTTPLastModified_s', ''),\r\n    OriginResponseStatus_d=column_ifexists('OriginResponseStatus_d', ''),\r\n    OriginResponseTime_d=column_ifexists('OriginResponseTime_d', ''),\r\n    OriginSSLProtocol_s=column_ifexists('OriginSSLProtocol_s', ''),\r\n    ParentRayID_s=column_ifexists('ParentRayID_s', ''),\r\n    RayID_s=column_ifexists('RayID_s', ''),\r\n    SecurityLevel_s=column_ifexists('SecurityLevel_s', ''),\r\n    WAFAction_s=column_ifexists('WAFAction_s', ''),\r\n    WAFFlags_s=column_ifexists('WAFFlags_s', ''),\r\n    WAFMatchedVar_s=column_ifexists('WAFMatchedVar_s', ''),\r\n    WAFProfile_s=column_ifexists('WAFProfile_s', ''),\r\n    WAFRuleID_s=column_ifexists('WAFRuleID_s', ''),\r\n    WAFRuleMessage_s=column_ifexists('WAFRuleMessage_s', ''),\r\n    WorkerCPUTime_d=column_ifexists('WorkerCPUTime_d', ''),\r\n    WorkerStatus_s=column_ifexists('WorkerStatus_s', ''),\r\n    WorkerSubrequest_b=column_ifexists('WorkerSubrequest_b', ''),\r\n    WorkerSubrequestCount_d=column_ifexists('WorkerSubrequestCount_d', ''),\r\n    ZoneID_d=column_ifexists('ZoneID_d', ''),\r\n    Application_s=column_ifexists('Application_s', ''),\r\n    ClientMatchedIpFirewall_s=column_ifexists('ClientMatchedIpFirewall_s', ''),\r\n    ClientProto_s=column_ifexists('ClientProto_s', ''),\r\n    ClientTcpRtt_d=column_ifexists('ClientTcpRtt_d', ''),\r\n    ClientTlsCipher_s=column_ifexists('ClientTlsCipher_s', ''),\r\n    ClientTlsClientHelloServerName_s=column_ifexists('ClientTlsClientHelloServerName_s', ''),\r\n    ClientTlsProtocol_s=column_ifexists('ClientTlsProtocol_s', ''),\r\n    ClientTlsStatus_s=column_ifexists('ClientTlsStatus_s', ''),\r\n    ColoCode_s=column_ifexists('ColoCode_s', ''),\r\n    ConnectTimestamp_t=column_ifexists('ConnectTimestamp_t', ''),\r\n    DisconnectTimestamp_t=column_ifexists('DisconnectTimestamp_t', ''),\r\n    Event_s=column_ifexists('Event_s', ''),\r\n    IpFirewall_b=column_ifexists('IpFirewall_b', ''),\r\n    OriginBytes_d=column_ifexists('OriginBytes_d', ''),\r\n    OriginPort_d=column_ifexists('OriginPort_d', ''),\r\n    OriginProto_s=column_ifexists('OriginProto_s', ''),\r\n    OriginTcpRtt_d=column_ifexists('OriginTcpRtt_d', ''),\r\n    OriginTlsCipher_s=column_ifexists('OriginTlsCipher_s', ''),\r\n    OriginTlsFingerprint_s=column_ifexists('OriginTlsFingerprint_s', ''),\r\n    OriginTlsMode_s=column_ifexists('OriginTlsMode_s', ''),\r\n    OriginTlsProtocol_s=column_ifexists('OriginTlsProtocol_s', ''),\r\n    OriginTlsStatus_s=column_ifexists('OriginTlsStatus_s', ''),\r\n    ProxyProtocol_s=column_ifexists('ProxyProtocol_s', ''),\r\n    Status_d=column_ifexists('Status_d', ''),\r\n    Timestamp_t=column_ifexists('Timestamp_t', ''),\r\n    Action_s=column_ifexists('Action_s', ''),\r\n    ClientASNDescription_s=column_ifexists('ClientASNDescription_s', ''),\r\n    ClientRefererHost_s=column_ifexists('ClientRefererHost_s', ''),\r\n    ClientRefererPath_s=column_ifexists('ClientRefererPath_s', ''),\r\n    ClientRefererQuery_s=column_ifexists('ClientRefererQuery_s', ''),\r\n    ClientRefererScheme_s=column_ifexists('ClientRefererScheme_s', ''),\r\n    ClientRequestQuery_s=column_ifexists('ClientRequestQuery_s', ''),\r\n    ClientRequestScheme_s=column_ifexists('ClientRequestScheme_s', ''),\r\n    Datetime_t=column_ifexists('Datetime_t', ''),\r\n    Kind_s=column_ifexists('Kind_s', ''),\r\n    MatchIndex_d=column_ifexists('MatchIndex_d', ''),\r\n    OriginatorRayID_s=column_ifexists('OriginatorRayID_s', ''),\r\n    RuleID_s=column_ifexists('RuleID_s', ''),\r\n    Source_s=column_ifexists('Source_s', '')\r\n| extend\r\n    SrcDvcType=iff(isempty(ClientDeviceType_s), iff(isempty(Source_s), '', Source_s), ClientDeviceType_s),\r\n    TlsCipher=iff(isempty(ClientSSLCipher_s), iff(isempty(ClientTlsCipher_s), '', ClientTlsCipher_s), ClientSSLCipher_s),\r\n    TlsVersion=iff(isempty(ClientSSLProtocol_s), iff(isempty(ClientTlsProtocol_s), '', ClientTlsProtocol_s), ClientSSLProtocol_s),\r\n    DvcAction=iff(isempty(FirewallMatchesActions_s), iff(isempty(Event_s), iff(isempty(Action_s), '', Action_s), Event_s), FirewallMatchesActions_s),\r\n    NetworkRuleName=iff(isempty(FirewallMatchesRuleIDs_s), iff(isempty(RuleID_s), '', RuleID_s), FirewallMatchesRuleIDs_s),\r\n    ClientRequestBytes_d=column_ifexists('ClientRequestBytes_d', column_ifexists('ClientBytes_d', '')),\r\n    ClientSrcPort_d=column_ifexists('ClientSrcPort_d', column_ifexists('ClientPort_d', '')),\r\n    EdgeResponseBytes_d=column_ifexists('EdgeResponseBytes_d', column_ifexists('OriginBytes_d', ''))\r\n| project-rename\r\n    SrcBytes=ClientRequestBytes_d,\r\n    SrcPortNumber=ClientSrcPort_d,\r\n    DstBytes=EdgeResponseBytes_d,\r\n    BotScore=BotScore_d,\r\n    BotScoreSrc=BotScoreSrc_s,\r\n    CacheCacheStatus=CacheCacheStatus_s,\r\n    CacheResponseBytes=CacheResponseBytes_d,\r\n    CacheResponseStatus=CacheResponseStatus_d,\r\n    CacheTieredFill=CacheTieredFill_b,\r\n    ClientASN=ClientASN_d,\r\n    SrcGeoCountry=ClientCountry_s,\r\n    SrcIpAddr=ClientIP_s,\r\n    ClientIPClass=ClientIPClass_s,\r\n    HttpRequestHeaderHost=ClientRequestHost_s,\r\n    HttpRequestMethod=ClientRequestMethod_s,\r\n    ClientRequestPath=ClientRequestPath_s,\r\n    ClientRequestProtocol=ClientRequestProtocol_s,\r\n    HttpReferrerOriginal=ClientRequestReferer_s,\r\n    ClientRequestURI=ClientRequestURI_s,\r\n    HttpUserAgentOriginal=ClientRequestUserAgent_s,\r\n    ClientXRequestedWith=ClientXRequestedWith_s,\r\n    EdgeColoCode=EdgeColoCode_s,\r\n    EdgeColoID=EdgeColoID_d,\r\n    EdgeEndTimestamp=EdgeEndTimestamp_t,\r\n    EdgePathingOp=EdgePathingOp_s,\r\n    EdgePathingSrc=EdgePathingSrc_s,\r\n    EdgePathingStatus=EdgePathingStatus_s,\r\n    EdgeRateLimitAction=EdgeRateLimitAction_s,\r\n    EdgeRateLimitID=EdgeRateLimitID_d,\r\n    EdgeRequestHost=EdgeRequestHost_s,\r\n    EdgeResponseCompressionRatio=EdgeResponseCompressionRatio_d,\r\n    HttpContentType=EdgeResponseContentType_s,\r\n    EdgeResponseStatus=EdgeResponseStatus_d,\r\n    EdgeServerIP=EdgeServerIP_s,\r\n    EdgeStartTimestamp=EdgeStartTimestamp_t,\r\n    FirewallMatchesSources=FirewallMatchesSources_s,\r\n    DstIpAddr=OriginIP_s,\r\n    OriginResponseBytes=OriginResponseBytes_d,\r\n    OriginResponseHTTPExpires=OriginResponseHTTPExpires_s,\r\n    OriginResponseHTTPLastModified=OriginResponseHTTPLastModified_s,\r\n    HttpStatusCode=OriginResponseStatus_d,\r\n    OriginResponseTime=OriginResponseTime_d,\r\n    OriginSSLProtocol=OriginSSLProtocol_s,\r\n    ParentRayID=ParentRayID_s,\r\n    RayID=RayID_s,\r\n    SecurityLevel=SecurityLevel_s,\r\n    WAFAction=WAFAction_s,\r\n    WAFFlags=WAFFlags_s,\r\n    WAFMatchedVar=WAFMatchedVar_s,\r\n    WAFProfile=WAFProfile_s,\r\n    WAFRuleID=WAFRuleID_s,\r\n    WAFRuleMessage=WAFRuleMessage_s,\r\n    WorkerCPUTime=WorkerCPUTime_d,\r\n    WorkerStatus=WorkerStatus_s,\r\n    WorkerSubrequest=WorkerSubrequest_b,\r\n    WorkerSubrequestCount=WorkerSubrequestCount_d,\r\n    ZoneID=ZoneID_d,\r\n    Application=Application_s,\r\n    ClientMatchedIpFirewall=ClientMatchedIpFirewall_s,\r\n    NetworkProtocol=ClientProto_s,\r\n    ClientTcpRtt=ClientTcpRtt_d,\r\n    ClientTlsClientHelloServerName=ClientTlsClientHelloServerName_s,\r\n    ClientTlsStatus=ClientTlsStatus_s,\r\n    ColoCode=ColoCode_s,\r\n    ConnectTimestamp=ConnectTimestamp_t,\r\n    DisconnectTimestamp=DisconnectTimestamp_t,\r\n    IpFirewall=IpFirewall_b,\r\n    DstPortNumber=OriginPort_d,\r\n    OriginProto=OriginProto_s,\r\n    OriginTcpRtt=OriginTcpRtt_d,\r\n    OriginTlsCipher=OriginTlsCipher_s,\r\n    OriginTlsFingerprint=OriginTlsFingerprint_s,\r\n    OriginTlsMode=OriginTlsMode_s,\r\n    OriginTlsProtocol=OriginTlsProtocol_s,\r\n    OriginTlsStatus=OriginTlsStatus_s,\r\n    ProxyProtocol=ProxyProtocol_s,\r\n    EventResult=Status_d,\r\n    Timestamp=Timestamp_t,\r\n    ClientASNDescription=ClientASNDescription_s,\r\n    ClientRefererHost=ClientRefererHost_s,\r\n    ClientRefererPath=ClientRefererPath_s,\r\n    ClientRefererQuery=ClientRefererQuery_s,\r\n    ClientRefererScheme=ClientRefererScheme_s,\r\n    ClientRequestQuery=ClientRequestQuery_s,\r\n    ClientRequestScheme=ClientRequestScheme_s,\r\n    Datetime=Datetime_t,\r\n    EventSubType=Kind_s,\r\n    MatchIndex=MatchIndex_d,\r\n    OriginatorRayID=OriginatorRayID_s\r\n| project-away \r\n    ClientDeviceType_s,\r\n    Source_s,\r\n    ClientSSLCipher_s,\r\n    ClientTlsCipher_s,\r\n    ClientSSLProtocol_s,\r\n    ClientTlsProtocol_s,\r\n    FirewallMatchesActions_s,\r\n    Event_s,\r\n    Action_s,\r\n    FirewallMatchesRuleIDs_s,\r\n    RuleID_s",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cloudflare",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Cloudflare Workbook with template",
        "displayName": "Cloudflare workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CloudflareWorkbook Workbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Sets the time name for analysis"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This workbook depends on a parser based on a Kusto Function to work as expected [**Cloudflare**](https://aka.ms/sentinel-CloudflareDataConnector-parse) which is deployed with the Microsoft Sentinel Solution.\"},\"name\":\"text - 0\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"2088f290-65ee-4357-badb-55ce732a5004\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cloudflare Web Traffic Overview\",\"subTarget\":\"cloudflare_web_traffic_overview\",\"style\":\"link\"},{\"id\":\"25df6ee6-dcf7-4aa2-b90e-50f8a4b6548d\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cloudflare Security Overview\",\"subTarget\":\"cloudflare_security_overview\",\"style\":\"link\"},{\"id\":\"a2108bc6-5769-4c86-a5c0-201f531ed929\",\"cellValue\":\"tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Cloudflare Reliability Summary\",\"subTarget\":\"cloudflare_reliability_summary\",\"style\":\"link\"}]},\"name\":\"links - 1\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c64d5d3d-90c6-484a-ab88-c70652b75b6e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":172800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize count() by ClientDeviceType_s\",\"size\":0,\"title\":\"Traffic Type\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Traffic Type\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize count() by ClientRequestProtocol_s\",\"size\":0,\"title\":\"HTTP Protocols\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"HTTP Protocols\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize count() by ClientRequestMethod_s\",\"size\":0,\"title\":\"Request Methods\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Request Methods\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| extend EdgeResponseContentType = iif(isempty(EdgeResponseContentType_s),\\\"empty\\\",EdgeResponseContentType_s )\\n| summarize count() by EdgeResponseContentType\",\"size\":0,\"title\":\"Content Types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Content Types\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize Count=count() by ClientRequestURI_s\\n| sort by Count | project-rename ClientRequestURI=ClientRequestURI_s | take 50\",\"size\":0,\"title\":\"Top Requested URIs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Top Requested URIs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize Count=count() by ClientIP_s\\n| sort by Count | take 50 | project-rename  ClientIP=ClientIP_s\",\"size\":0,\"title\":\"Top Traffic IPs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Top Traffic IPs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| extend ClientRequestReferer = iif(isempty(ClientRequestReferer_s),\\\"empty\\\",ClientRequestReferer_s )\\n| summarize Count=count() by ClientRequestReferer\\n| sort by Count | take 50\\n\",\"size\":0,\"title\":\"Top Referer\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Top Referer\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize Count=count() by ClientIPClass_s | project-rename ClientIPClass=ClientIPClass_s\\n| sort by Count | take 50\\n\",\"size\":0,\"title\":\"Top Traffic Types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"customWidth\":\"25\",\"name\":\"Top Traffic Types\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL\\n| summarize Count=count() by ClientRequestUserAgent_s | project-rename ClientRequestUserAgent=ClientRequestUserAgent_s\\n| sort by Count | take 50\",\"size\":0,\"title\":\"Top User Agents\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ClientRequestUserAgent\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"75%\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_web_traffic_overview\"},\"name\":\"Top User Agents\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let total_number_of_requests =\\nCloudflare_CL\\n| summarize Count=count()\\n| extend title=\\\"Total Number Of Requests\\\";\\n\\nlet threats_stopped =\\nCloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat) | summarize Count=count()\\n| extend title=\\\"Stopped Threats\\\";\\n\\nlet result_table = union total_number_of_requests, threats_stopped; \\nresult_table \\n| sort by Count\\n\\n\",\"size\":0,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Req_Threats_title\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize Count=count() by threat\",\"size\":0,\"title\":\"Top Threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threats\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let total_number_of_requests =\\nCloudflare_CL\\n| summarize Count=count()\\n| extend title=\\\"Total Number Of Requests\\\";\\n\\nlet threats_stopped =\\nCloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat) | summarize Count=count()\\n| extend title=\\\"Stopped Threats\\\";\\n\\nlet result_table = union total_number_of_requests, threats_stopped; \\nresult_table \\n| sort by Count\\n\\n\",\"size\":0,\"title\":\"Requests vs Threats\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Requests vs Threats\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Threats Over Time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Threats Over Time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize count() by ClientCountry_s | project-rename Country=ClientCountry_s | take 20\",\"size\":0,\"title\":\"Top Threat Countries\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threat Countries\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize count() by ClientIP_s | project-rename ClientIP=ClientIP_s\",\"size\":0,\"title\":\"Top Threat Client IPs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threat Client IPs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize Count=count() by ClientRequestURI_s | project-rename ClientRequestURI=ClientRequestURI_s\",\"size\":0,\"title\":\"Top Threat URIs\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threat URIs\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize Count=count() by ClientRequestUserAgent_s | project-rename ClientRequestUserAgent=ClientRequestUserAgent_s\",\"size\":0,\"title\":\"Top Threat User Agents\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threat User Agents\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend threat=case(EdgePathingSrc_s ==\\\"user\\\" and EdgePathingOp_s == \\\"ban\\\" and EdgePathingStatus_s has \\\"ip\\\" ,\\\"IP Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\",\\\"Country Block\\\",EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"zl\\\", \\\"Routed by Zone Lockdown\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ua\\\", \\\"Blocked User Agent\\\", EdgePathingSrc_s==\\\"user\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"rateLimit\\\", \\\"Blocked by Rate Limiting\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Blocked by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"filterBasedFirewall\\\" and EdgePathingOp_s==\\\"chl\\\", \\\"Challenged by Filter Based Firewall\\\", EdgePathingSrc_s==\\\"bic\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"unknown\\\", \\\"Browser Integrity Check\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ctry\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"hot\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"ip\\\", \\\"Blocked Hotlink\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaErr\\\", \\\"CAPTCHA Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaFail\\\", \\\"CAPTCHA Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"captchaNew\\\", \\\"New CAPTCHA\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlErr\\\", \\\"Java Script Challenge Error\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlFail\\\", \\\"Java Script Challenge Failed\\\", EdgePathingSrc_s==\\\"macro\\\" and EdgePathingOp_s==\\\"chl\\\" and EdgePathingStatus_s==\\\"jschlNew\\\", \\\"New Java Script Challenge\\\", EdgePathingSrc_s==\\\"protect\\\" and EdgePathingOp_s==\\\"ban\\\" and EdgePathingStatus_s==\\\"17ddos\\\", \\\"L7 DDos Mitigation\\\",\\\"\\\")\\n| where isnotempty(threat)\\n| summarize Count=count() by EdgePathingStatus_s | project-rename EdgePathingStatus=EdgePathingStatus_s\",\"size\":0,\"title\":\"Top Threat User Agents\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_security_overview\"},\"customWidth\":\"33\",\"name\":\"Top Threat User Agents - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let 5xx = Cloudflare_CL \\n| where tostring(EdgeResponseStatus_d) startswith \\\"5\\\"\\n| summarize Count=count()\\n| extend title=\\\"5xx Errors (Edge)\\\";\\n\\nlet 4xx = Cloudflare_CL \\n| where tostring(EdgeResponseStatus_d) startswith \\\"4\\\"\\n| summarize Count=count()\\n| extend title=\\\"4xx Errors (Edge)\\\";\\n\\nlet 3xx = Cloudflare_CL \\n| where tostring(EdgeResponseStatus_d) startswith \\\"3\\\"\\n| summarize Count=count()\\n| extend title=\\\"3xx Errors (Edge)\\\";\\n\\nlet result_table = union 5xx, 4xx, 3xx; \\nresult_table \\n| sort by Count\\n\\n\",\"size\":0,\"title\":\"ERRORS Counts (Edge)\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_reliability_summary\"},\"customWidth\":\"33\",\"name\":\"Errors (Edge)\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend response_error_type= case(tostring(EdgeResponseStatus_d) startswith \\\"2\\\" , \\\"2xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"3\\\" , \\\"3xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"4\\\" , \\\"4xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"5\\\" , \\\"5xx\\\",\\\"\\\")\\n| where isnotempty(response_error_type)\\n| summarize Count=count() by response_error_type\",\"size\":0,\"title\":\"Edge Response Error Ratio\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_reliability_summary\"},\"customWidth\":\"33\",\"name\":\"Edge Response Error Ratio\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend response_error_type= case(tostring(OriginResponseStatus_d) startswith \\\"2\\\" , \\\"2xx\\\", tostring(OriginResponseStatus_d) startswith \\\"3\\\" , \\\"3xx\\\", tostring(OriginResponseStatus_d) startswith \\\"4\\\" , \\\"4xx\\\", tostring(OriginResponseStatus_d) startswith \\\"5\\\" , \\\"5xx\\\",\\\"\\\")\\n| where isnotempty(response_error_type)\\n| summarize Count=count() by response_error_type\",\"size\":0,\"title\":\"Origin Response Error Ratio\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_reliability_summary\"},\"customWidth\":\"33\",\"name\":\"Origin Response Error Ratio\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend response_error_type= case(tostring(EdgeResponseStatus_d) startswith \\\"2\\\" , \\\"2xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"3\\\" , \\\"3xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"4\\\" , \\\"4xx\\\", tostring(EdgeResponseStatus_d) startswith \\\"5\\\" , \\\"5xx\\\",\\\"\\\")\\n| where isnotempty(response_error_type)\\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by response_error_type;\",\"size\":0,\"title\":\"Edge Response Status Over Time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_reliability_summary\"},\"customWidth\":\"50\",\"name\":\"Edge Response Status Over Time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Cloudflare_CL \\n| extend response_error_type= case(tostring(OriginResponseStatus_d) startswith \\\"2\\\" , \\\"2xx\\\", tostring(OriginResponseStatus_d) startswith \\\"3\\\" , \\\"3xx\\\", tostring(OriginResponseStatus_d) startswith \\\"4\\\" , \\\"4xx\\\", tostring(OriginResponseStatus_d) startswith \\\"5\\\" , \\\"5xx\\\",\\\"\\\")\\n| where isnotempty(response_error_type)\\n| make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by response_error_type;\",\"size\":0,\"title\":\"Origin Response Status Over Time\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"tab\",\"comparison\":\"isEqualTo\",\"value\":\"cloudflare_reliability_summary\"},\"customWidth\":\"50\",\"name\":\"Origin Response Status Over Time\"}],\"fromTemplateId\":\"sentinel-CloudflareWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=CloudflareWorkbook; logoFileName=cloudflare.svg; description=Sets the time name for analysis; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Cloudflare; templateRelativePath=Cloudflare.json; subtitle=; provider=Cloudflare}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "Cloudflare_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "CloudflareDataConnector",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 1 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName1'),'/',variables('huntingQueryVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CloudflareClientErrors_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Client errors",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where HttpStatusCode startswith '4'\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for client related errors."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Impact"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133,T1498"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId1'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 1",
                "parentId": "[variables('huntingQueryId1')]",
                "contentId": "[variables('_huntingQuerycontentId1')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 2 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName2'),'/',variables('huntingQueryVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "CloudflareClientTlsErrors_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Client TLS errors",
                "category": "Hunting Queries",
                "query": "let err_tls = dynamic(['UNKNOWN', 'INTERNAL_ERROR', 'INVALID_CONFIG', 'INVALID_SNI', 'HANDSHAKE_FAILED']);\nCloudflare\n| where TimeGenerated > ago(24h)\n| where ClientTlsStatus in~ (err_tls)\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for client TLS errors."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Impact"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133,T1498"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId2'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 2",
                "parentId": "[variables('huntingQueryId2')]",
                "contentId": "[variables('_huntingQuerycontentId2')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 3 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName3'),'/',variables('huntingQueryVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "CloudflareFilesRequested_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Files requested",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| extend File = extract(@'\\/(\\w+\\.\\w+)', 1, ClientRequestURI)\n| summarize count() by File, SrcIpAddr\n| extend IPCustomEntity = SrcIpAddr\n| extend FileCustomEntity = File\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for files requested."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId3'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 3",
                "parentId": "[variables('huntingQueryId3')]",
                "contentId": "[variables('_huntingQuerycontentId3')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 4 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName4'),'/',variables('huntingQueryVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "CloudflareRareUAs_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Rare user agents",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where isnotempty(HttpUserAgentOriginal)\n| summarize count() by HttpUserAgentOriginal, SrcIpAddr\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches rare user agent strings."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId4'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 4",
                "parentId": "[variables('huntingQueryId4')]",
                "contentId": "[variables('_huntingQuerycontentId4')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 5 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName5'),'/',variables('huntingQueryVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "CloudflareServerErrors_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Server errors",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where HttpStatusCode startswith '5'\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for server related errors."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Impact"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133,T1498"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId5'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 5",
                "parentId": "[variables('huntingQueryId5')]",
                "contentId": "[variables('_huntingQuerycontentId5')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 6 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName6'),'/',variables('huntingQueryVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "CloudflareServerTlsErrors_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Server TLS errors",
                "category": "Hunting Queries",
                "query": "let err_tls = dynamic(['UNKNOWN', 'INTERNAL_ERROR', 'INVALID_CONFIG', 'INVALID_SNI', 'HANDSHAKE_FAILED']);\nCloudflare\n| where TimeGenerated > ago(24h)\n| where OriginTlsStatus in~ (err_tls)\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for server TLS errors."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess,Impact"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133,T1498"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId6'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 6",
                "parentId": "[variables('huntingQueryId6')]",
                "contentId": "[variables('_huntingQuerycontentId6')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 7 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName7'),'/',variables('huntingQueryVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "CloudflareTopNetworkRules_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Top Network rules",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where isnotempty(NetworkRuleName)\n| summarize count() by NetworkRuleName, EdgeRequestHost\n| order by count_\n| extend CloudAppCustomEntity = EdgeRequestHost\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches top network rules triggered."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId7'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 7",
                "parentId": "[variables('huntingQueryId7')]",
                "contentId": "[variables('_huntingQuerycontentId7')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 8 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName8'),'/',variables('huntingQueryVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "CloudflareTopWafRules_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Top WAF rules",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where isnotempty(WAFRuleID)\n| summarize count() by WAFRuleID, WAFRuleMessage, EdgeRequestHost\n| order by count_\n| extend CloudAppCustomEntity = EdgeRequestHost\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches top WAF rules triggered."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId8'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 8",
                "parentId": "[variables('huntingQueryId8')]",
                "contentId": "[variables('_huntingQuerycontentId8')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 9 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName9'),'/',variables('huntingQueryVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedCountries_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Unexpected countries",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| summarize count() by SrcGeoCountry, SrcIpAddr\n| extend IPCustomEntity = SrcIpAddr\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches requests by country and helps to identify requests coming from unexpected countries."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId9'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 9",
                "parentId": "[variables('huntingQueryId9')]",
                "contentId": "[variables('_huntingQuerycontentId9')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('huntingQueryTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Cloudflare Hunting Query 10 with template",
        "displayName": "Cloudflare Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName10'),'/',variables('huntingQueryVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedEdgeResponse_HuntingQueries Hunting Query with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Cloudflare_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Cloudflare - Unexpected edge response",
                "category": "Hunting Queries",
                "query": "Cloudflare\n| where TimeGenerated > ago(24h)\n| where HttpStatusCode != EdgeResponseStatus\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Query searches for unexpected EdgeResponseStatus values."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  },
                  {
                    "name": "techniques",
                    "value": "T1190,T1133"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId10'),'/'))))]",
              "properties": {
                "description": "Cloudflare Hunting Query 10",
                "parentId": "[variables('huntingQueryId10')]",
                "contentId": "[variables('_huntingQuerycontentId10')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 1 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "CloudflareBadClientIp_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects requests from IP with bad reputation index.",
                "displayName": "Cloudflare - Bad client IP",
                "enabled": false,
                "query": "let ip_reputation = dynamic(['unknown', 'badHost', 'greylist', 'securityScanner', 'scan', 'tor']);\nCloudflare\n| where ClientIPClass in~ (ip_reputation)\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 2 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "CloudflareEmptyUA_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects requests where user agent is empty.",
                "displayName": "Cloudflare - Empty user agent",
                "enabled": false,
                "query": "Cloudflare\n| where isempty(HttpUserAgentOriginal)\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 3 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName3'),'/',variables('analyticRuleVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "CloudflareMultipleErrorsSource_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId3')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects multiple failure requests from single source in short timeframe.",
                "displayName": "Cloudflare - Multiple error requests from single source",
                "enabled": false,
                "query": "let threshold = 100;\nCloudflare\n| where HttpRequestMethod =~ 'GET'\n| summarize err_cnt = count() by SrcIpAddr, bin(TimeGenerated, 5m)\n| where err_cnt > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId3'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 3",
                "parentId": "[variables('analyticRuleId3')]",
                "contentId": "[variables('_analyticRulecontentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 4 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName4'),'/',variables('analyticRuleVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "CloudflareMultipleUAs_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId4')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects requests with different user agents from one source in short timeframe.",
                "displayName": "Cloudflare - Multiple user agents for single source",
                "enabled": false,
                "query": "let threshold = 10;\nCloudflare\n| where isnotempty(HttpUserAgentOriginal)\n| summarize d_ua = dcount(HttpUserAgentOriginal) by SrcIpAddr, bin(TimeGenerated, 3m)\n| where d_ua > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId4'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 4",
                "parentId": "[variables('analyticRuleId4')]",
                "contentId": "[variables('_analyticRulecontentId4')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 5 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName5'),'/',variables('analyticRuleVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedCountry_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId5')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects requests from countries which are in blocklist.",
                "displayName": "Cloudflare - Client request from country in blocklist",
                "enabled": false,
                "query": "let bl_countries = dynamic(['cn', 'hk']);\nCloudflare\n| where SrcGeoCountry in~ (bl_countries)\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId5'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 5",
                "parentId": "[variables('analyticRuleId5')]",
                "contentId": "[variables('_analyticRulecontentId5')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 6 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName6'),'/',variables('analyticRuleVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedPost_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId6')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects post requests to unusual extensions.",
                "displayName": "Cloudflare - Unexpected POST requests",
                "enabled": false,
                "query": "Cloudflare\n| where HttpRequestMethod in~ ('POST', 'PUT')\n| where tostring(HttpStatusCode) startswith '2'\n| where DstBytes != 0 or SrcBytes != 0\n| extend fe = extract(@'.*(\\.\\w+)$', 1, ClientRequestURI)\n| where fe in~ ('.jpg', '.jpeg', '.gif', '.png', '.icon', '.ico', '.xml', '.swf', '.svg', '.ppt', '.pttx', '.doc', '.docx', '.rtf', '.pdf', '.tif', '.zip', '.mov')\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "Persistence",
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1505",
                  "T1071"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId6'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 6",
                "parentId": "[variables('analyticRuleId6')]",
                "contentId": "[variables('_analyticRulecontentId6')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 7 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName7'),'/',variables('analyticRuleVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedRequest_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId7')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects client requests to unusual client request.",
                "displayName": "Cloudflare - Unexpected client request",
                "enabled": false,
                "query": "Cloudflare\n| where HttpRequestMethod =~ 'GET'\n| where DstBytes != 0 or SrcBytes != 0\n| where ClientRequestURI has_any ('/admin', '/admin.php', 'wp-admin', '.htaccess', '/etc/shadow', '/etc/passwd', '/etc/hosts', '/etc/ssh/') \n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId7'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 7",
                "parentId": "[variables('analyticRuleId7')]",
                "contentId": "[variables('_analyticRulecontentId7')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 8 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName8'),'/',variables('analyticRuleVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "CloudflareUnexpectedUrl_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId8')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects client requests to unusual URI.",
                "displayName": "Cloudflare - Unexpected URI",
                "enabled": false,
                "query": "Cloudflare\n| where HttpRequestMethod =~ 'GET'\n| where DstBytes != 0 or SrcBytes != 0\n| where ClientRequestURI matches regex @'(127\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})|(10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})|(172\\.1[6-9]\\.\\d{1,3}\\.\\d{1,3})|(172\\.2[0-9]\\.\\d{1,3}\\.\\d{1,3})|(172\\.3[0-1]\\.\\d{1,3}\\.\\d{1,3})|(192\\.168\\.\\d{1,3}\\.\\d{1,3})'\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId8'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 8",
                "parentId": "[variables('analyticRuleId8')]",
                "contentId": "[variables('_analyticRulecontentId8')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 9 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName9'),'/',variables('analyticRuleVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "CloudflareWafThreatAllowed_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId9')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects WAF \"Allowed\" action on threat events.",
                "displayName": "Cloudflare - WAF Allowed threat",
                "enabled": false,
                "query": "Cloudflare\n| where isnotempty(WAFRuleID) or isnotempty(WAFRuleMessage)\n| where WAFAction =~ 'Allow'\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId9'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 9",
                "parentId": "[variables('analyticRuleId9')]",
                "contentId": "[variables('_analyticRulecontentId9')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('analyticRuleTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Cloudflare Analytics Rule 10 with template",
        "displayName": "Cloudflare Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName10'),'/',variables('analyticRuleVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "CloudflareXSSProbingPattern_AnalyticalRules Analytics Rule with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId10')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects XSS probing patterns.",
                "displayName": "Cloudflare - XSS probing pattern in request",
                "enabled": false,
                "query": "let s_threshold = 3;\nCloudflare\n| where HttpRequestMethod in~ ('POST', 'PUT')\n| extend susp_ch = countof(ClientRequestURI, '%00')\n| where ClientRequestURI matches regex @'(alert\\()|(alert\\%28)|(String\\.fromCharCode\\()|(expression\\(alert)' or susp_ch > s_threshold\n| extend IPCustomEntity = SrcIpAddr\n| extend UrlCustomEntity = ClientRequestURI\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Cloudflare"
                    ],
                    "connectorId": "CloudflareDataConnector"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1190",
                  "T1133"
                ],
                "entityMappings": [
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "columnName": "UrlCustomEntity",
                        "identifier": "Url"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId10'),'/'))))]",
              "properties": {
                "description": "Cloudflare Analytics Rule 10",
                "parentId": "[variables('analyticRuleId10')]",
                "contentId": "[variables('_analyticRulecontentId10')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cloudflare",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Cloudflare",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId1')]",
              "version": "[variables('huntingQueryVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId2')]",
              "version": "[variables('huntingQueryVersion2')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId3')]",
              "version": "[variables('huntingQueryVersion3')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId4')]",
              "version": "[variables('huntingQueryVersion4')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId5')]",
              "version": "[variables('huntingQueryVersion5')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId6')]",
              "version": "[variables('huntingQueryVersion6')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId7')]",
              "version": "[variables('huntingQueryVersion7')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId8')]",
              "version": "[variables('huntingQueryVersion8')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId9')]",
              "version": "[variables('huntingQueryVersion9')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId10')]",
              "version": "[variables('huntingQueryVersion10')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId3')]",
              "version": "[variables('analyticRuleVersion3')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId4')]",
              "version": "[variables('analyticRuleVersion4')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId5')]",
              "version": "[variables('analyticRuleVersion5')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId6')]",
              "version": "[variables('analyticRuleVersion6')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId7')]",
              "version": "[variables('analyticRuleVersion7')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId8')]",
              "version": "[variables('analyticRuleVersion8')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId9')]",
              "version": "[variables('analyticRuleVersion9')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId10')]",
              "version": "[variables('analyticRuleVersion10')]"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "Cloudflare"
        ],
        "categories": {
          "domains": [
            "Networking",
            "Security - Network"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
