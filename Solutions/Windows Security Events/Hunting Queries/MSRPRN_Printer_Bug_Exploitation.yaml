id: c29a03c6-d074-4934-afae-df1aeb30da70
name: Potential Exploitation of MS-RPRN printer bug
description: |
  'This query detects potential attempts to remotely access to the print spooler service on Active Directory Domain Controllers which could indicate an exploitation of MS-RPRN printer bug from a server that is configured with unconstrained delegation.'
description-detailed: |
  'This query detects potential attempts to remotely access to the print spooler service on Active Directory Domain Controllers which could indicate an exploitation of MS-RPRN printer bug from a server that is configured with unconstrained delegation.
   This query searches for the event id 5145 on Domain Controllers where the ShareName is "\\\*\IPC$" and the RelativeTargetName is "spoolss".
   Ref: https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976#:~:text=The%20exploitation%20of%20unconstrained%20delegation,system%20with%20the%20delegation%20enabled.&text=but%20before%20doing%20that%20we,listen%20for%20incoming%20authenticated%20connections.'
requiredDataConnectors:
  - connectorId: SecurityEvents
    dataTypes:
      - SecurityEvent
  - connectorId: WindowsSecurityEvents
    dataTypes:
      - SecurityEvent
tactics:
  - PrivilegeEscalation
relevantTechniques:
  - T1134
query: |
 // Enter a reference list of hostnames for your DC servers
 // let DCServersList = dynamic (["DC01.domain.local","DC02.domain.local"]);
 // Enter a reference list of IP addresses for your unconstrained delegation servers
 // let UnconstrainedServersIPList = dynamic (["10.1.0.7","10.1.0.45"]);
 SecurityEvent
 // | where Computer in (DCServersList)
 // | where IpAddress  in (UnconstrainedServersIPList)
 | where EventID == 5145 and ShareName == "\\\\*\\IPC$" and RelativeTargetName == "spoolss"
 | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by Computer, SubjectUserName, IpAddress, ShareName, RelativeTargetName, Type, SubjectUserSid
 | extend HostName = tostring(split(Computer, '.', 0)[0]), DnsDomain = tostring(strcat_array(array_slice(split(Computer, '.'), 1, -1), '.'))
 | extend Account_0_Name = SubjectUserName
 | extend Host_0_HostName = HostName
 | extend Host_0_DnsDomain = DnsDomain
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: SubjectUserName   
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: HostName 
      - identifier: DnsDomain
        columnName: DnsDomain         
version: 2.0.1