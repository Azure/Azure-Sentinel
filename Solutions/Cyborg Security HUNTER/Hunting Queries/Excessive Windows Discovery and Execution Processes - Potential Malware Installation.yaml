id: 6d1c9f13-e43e-4b52-a443-5799465d573b
name: Excessive Windows Discovery and Execution Processes - Potential Malware Installation
description: |
  'Utilizes a list of commonly abused LOLB an attacker or malware would execute in quick succession. The presence of multiple executions of the programs within the list can be indicative of an infection or malicious activity occurring on a victim host.'
requiredDataConnectors:
  - connectorId: SecurityEvent
    dataTypes:
      - SecurityEvent
tactics:
  - Discovery
relevantTechniques:
  - T1016
query: |
  SecurityEvent
  | where NewProcessName has_any (
    "arp.exe",
    "at.exe",
    "attrib.exe",
    "cscript.exe",
    "dsquery.exe",
    "hostname.exe",
    "ipconfig.exe",
    "mimikatz.exe",
    "nbtstat.exe",
    "net.exe",
    "netsh.exe",
    "nslookup.exe",
    "ping.exe",
    "quser.exe",
    "qwinsta.exe",
    "reg.exe",
    "runas.exe",
    "sc.exe",
    "schtasks.exe",
    "ssh.exe",
    "systeminfo.exe",
    "taskkill.exe",
    "telnet.exe",
    "tracert.exe",
    "wscript.exe",
    "xcopy.exe",
    "pscp.exe",
    "copy.exe",
    "robocopy.exe",
    "certutil.exe",
    "vssadmin.exe",
    "powershell.exe",
    "wevtutil.exe",
    "psexec.exe",
    "bcedit.exe",
    "wbadmin.exe",
    "icacls.exe",
    "diskpart.exe",
    "ver.exe",
    "netstat.exe",
    "tasklist.exe",
    "route.exe",
    "driverquery.exe"
  )
  | summarize firstEvent=min(TimeGenerated), lastEvent=max(TimeGenerated), uniqueProcesses=dcount(NewProcessName), eventIds=make_set(tostring(EventID)), processPaths=make_set(NewProcessName), processCommandLines=make_set(CommandLine), parentProcessPaths=make_set(ParentProcessName), processIds=make_set(NewProcessId), parentprocessIds=make_set(ProcessId), eventData=make_set(EventData), count() by SourceComputerId, Computer| order by firstEvent
  | where uniqueProcesses > 4
version: 1.0.0