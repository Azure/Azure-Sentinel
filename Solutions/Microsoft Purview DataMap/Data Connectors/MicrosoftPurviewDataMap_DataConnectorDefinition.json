{
    "name": "Microsoft Purview DataMap",
    "apiVersion": "2022-09-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
    "location": "{{location}}",
    "kind": "Customizable",
    "properties": {
        "connectorUiConfig": {
            "id": "MicrosoftPurviewDataMap",
            "title": "Microsoft Purview DataMap",
            "publisher": "Microsoft",
            "logo": "Microsoft.svg",
            "descriptionMarkdown": "Microsoft Purview is a unified data governance solution that helps organizations discover, classify, and protect data across on-premises, multicloud, and SaaS environments.\n\nThis data connector ingests Microsoft Purview asset ownership data, data lineage information, and governance activities into Microsoft Sentinel for security monitoring and compliance tracking.",
            "graphQueriesTableName": "PurviewDataMapOwnersInfo_CL",
            "graphQueries": [
                {
                    "metricName": "Total data received",
                    "legend": "{{graphQueriesTableName}}",
                    "baseQuery": "{{graphQueriesTableName}}"
                }
            ],
            "sampleQueries": [
                {
                    "description": "Purview Audited Tables",
                    "query": "{{graphQueriesTableName}}\n            | summarize by TableName"
                }
            ],
            "dataTypes": [
                {
                    "name": "{{graphQueriesTableName}}",
                    "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                }
            ],
            "connectivityCriteria": [
                {
                    "type": "HasDataConnectors"
                }
            ],
            "availability": {
                "isPreview": false
            },
            "permissions": {
                "resourceProvider": [
                    {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                            "write": true,
                            "read": true,
                            "delete": true
                        }
                    }
                ],
                "customs": [
                    {
                        "name": "Microsoft Entra app registration",
                        "description": "Application client ID and secret used to access Purview Asset Owners."
                    }
                ]
            },
            "instructionSteps": [
                {
                    "description": ">Connectivity to Purview requires a Microsoft Entra app registration (client ID and secret). You'll also need the Microsoft Entra tenant ID and the Purview Account name."
                },
                {
                    "title": "Step 1 - Microsoft Entra app registration",
                    "description": "1. Navigate to the [Microsoft Entra portal](https://entra.microsoft.com). \n2. Under Applications, click on **App Registrations** and create a new app registration (leave all defaults).\n3. Open the new app registration and create a new secret.\n4. Retain the **Tenant ID**, **Application (client) ID**, and **Client secret** for later use."
                },
                {
                    "title": "Step 2 - Role Assignment in Purview",
                    "description": "1. In the Purview portal, navigate to **Data Map > Domain** and click **Role Assignment** tab.\n2. Under **Data Readers** search for the App Created in step1.\n3. Click **OK**.\n"
                },
                {
                    "title": "Step 3 - Collect tenant ID and Purview Account",
                    "description": "1. Get tenant id from the Microsoft Entra portal for token endpoint: https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/token.\n2. Get the Purview Account name from the Purview portal for api endpoint https://{PurviewAccountName}.purview.azure.com/datamap/api/search/query?api-version=2023-09-01"
                },
                {
                    "description": "Connect using client credentials",
                    "title": "Connect events from Purview DataMap to Microsoft Sentinel",
                    "instructions": [
                        {
                            "type": "ContextPane",
                            "parameters": {
                                "contextPaneType": "DataConnectorsContextPane",
                                "label": "Add environment",
                                "isPrimary": true,
                                "title": "Purview connection",
                                "instructionSteps": [
                                    {
                                        "title": "Environment details",
                                        "instructions": [
                                            {
                                                "type": "Textbox",
                                                "parameters": {
                                                    "label": "Token Endpoint",
                                                    "name": "tokenEndpoint",
                                                    "placeholder": "https://login.microsoftonline.com/{TenantId}/oauth2/v2.0/token",
                                                    "type": "text",
                                                    "validations": {
                                                        "required": true
                                                    }

                                                }
                                            },
                                            {
                                                "type": "Textbox",
                                                "parameters": {
                                                    "label": "App registration client ID",
                                                    "placeholder": "App client ID",
                                                    "type": "text",
                                                    "name": "clientId"
                                                }
                                            },
                                            {
                                                "type": "Textbox",
                                                "parameters": {
                                                    "label": "App registration client secret",
                                                    "placeholder": "App client secret",
                                                    "type": "password",
                                                    "name": "clientSecret"
                                                }
                                            },
                                            {
                                                "type": "Textbox",
                                                "parameters": {
                                                    "label": "API Endpoint",
                                                    "placeholder": "https://{PurviewAccountName}.purview.azure.com/datamap/api/search/query?api-version=2023-09-01",
                                                    "type": "text",
                                                    "name": "apiEndpoint",
                                                    "validations": {
                                                        "required": true
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        }
                    ]
                },
                {
                    "title": "Organizations",
                    "description": "Each row represents purview connection",
                    "instructions": [
                        {
                            "type": "DataConnectorsGrid",
                            "parameters": {
                                "mapping": [
                                    {
                                        "columnName": "Environment URL",
                                        "columnValue": "properties.request.apiEndpoint"
                                    }
                                ],
                                "menuItems": [
                                    "DeleteConnector"
                                ]
                            }
                        }
                    ]
                }
            ]
        }
    }
}