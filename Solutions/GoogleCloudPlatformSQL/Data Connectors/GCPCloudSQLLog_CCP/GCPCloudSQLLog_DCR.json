[
    {
        "name": "GCPCloudSQLDCR",
        "apiVersion": "2022-06-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GCP_CloudSQL_CL": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GCP_CloudSQL_CL"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                  "transformKql": "source | extend Operation = parse_json(operation) | extend ProtoPayload = parse_json(tostring(protoPayload)) | extend Resource = parse_json(resource) | extend OperationFirst = tobool(Operation['first']) | extend OperationLast = tobool(Operation['last']) | extend OperationId = tostring(Operation['id']) | extend OperationProducer = tostring(Operation['producer']) | extend PayloadType = tostring(ProtoPayload['@type']) | extend AuthInfoPrincipalEmail = tostring(ProtoPayload['authenticationInfo']['principalEmail']) | extend AuthInfoPrincipalSubject = tostring(ProtoPayload['authenticationInfo']['principalSubject']) | extend AuthInfoServiceAccountKeyName = tostring(ProtoPayload['authenticationInfo']['serviceAccountKeyName']) | extend AuthorizationInfo = todynamic(ProtoPayload.authorizationInfo) | extend ResourceName = tostring(ProtoPayload.resourceName) | extend MetadataType= tostring(ProtoPayload['metadata']['@type']) | extend MethodName = tostring(ProtoPayload.methodName) | extend RequestType = tostring(ProtoPayload['request']['@type']) | extend RequestDatabase = tostring(ProtoPayload['request']['database']) | extend RequestEnableFinalBackup = tobool(ProtoPayload['request']['enableFinalBackup']) | extend RequestFinalBackupTtlDays = tostring(ProtoPayload['request']['finalBackupTtlDays']) | extend RequestName = tostring(ProtoPayload['request']['name']) | extend RequestFilter = tostring(ProtoPayload['request']['filter']) | extend RequestPageSize = tostring(ProtoPayload.request.pageSize) | extend RequestParent = tostring(ProtoPayload.request.parent) | extend RequestInstance = tostring(ProtoPayload.request.instance) | extend RequestHost = tostring(ProtoPayload.request.host) | extend RequestMaxResults = tostring(ProtoPayload.request.maxResults) | extend RequestResourceId = tostring(ProtoPayload.request.resourceId) | extend RequestStartTime= todatetime(ProtoPayload['request']['startTime']) | extend RequestEndTime= todatetime(ProtoPayload['request']['endTime']) | extend RequestOperation= tostring(ProtoPayload.request.operation) | extend RequestSha1Fingerprint = tostring(ProtoPayload.request.sha1Fingerprint) | extend RequestBodyBackendType = tostring(ProtoPayload.request.body.backendType) | extend RequestBodyDatabaseVersion = tostring(ProtoPayload.request.body.databaseVersion) | extend RequestBodyInstanceType = tostring(ProtoPayload.request.body.instanceType) | extend RequestBodyInstanceUid = tostring(ProtoPayload.request.body.instanceUid) | extend RequestBodyMasterInstance = tostring(ProtoPayload.request.body.masterInstance.name) | extend RequestBodyMasterInstanceRegion = tostring(ProtoPayload.request.body.masterInstance.region) | extend RequestBodyMasterInstanceName = tostring(ProtoPayload.request.body.masterInstanceName) | extend RequestBodyName = tostring(ProtoPayload.request.body.name) | extend RequestBodyRegion = tostring(ProtoPayload.request.body.region) | extend RequestBodyCharset = tostring(ProtoPayload.request.body.charset) | extend RequestBodyInstance= tostring(ProtoPayload['request']['body']['instance']) | extend RequestBodyUser= tostring(ProtoPayload['request']['body']['user']) | extend RequestBodyDatabase= tostring(ProtoPayload['request']['body']['database']) | extend RequestBodyKind= tostring(ProtoPayload['request']['body']['kind']) | extend RequestBodyProject= tostring(ProtoPayload['request']['body']['project']) | extend RequestBodyDescription= tostring(ProtoPayload['request']['body']['description']) | extend RequestBodyLocation= tostring(ProtoPayload['request']['body']['location']) | extend RequestBodyCloneContextDestinationInstanceName= tostring(ProtoPayload.request.body.cloneContext.destinationInstanceName) | extend RequestBodyFailoverContext= todynamic(ProtoPayload.request.body.failoverContext) | extend RequestBodyHost= tostring(ProtoPayload.request.body.host) | extend RequestBodyPasswordPolicy= todynamic(ProtoPayload.request.body.passwordPolicy) | extend RequestBodyDualPasswordType= todynamic(ProtoPayload.request.body.dualPasswordType) | extend RequestBodyBackup= tostring(ProtoPayload.request.body.backup) | extend RequestBodyNodeCount= tostring(ProtoPayload.request.body.nodeCount) | extend RequestBodyCommonName= tostring(ProtoPayload.request.body.commonName) | extend RequestBodyImportContext= todynamic(ProtoPayload.request.body.importContext) | extend RequestBodyExportContext= todynamic(ProtoPayload.request.body.exportContext) | extend RequestBodyRotateServerCaContext= todynamic(ProtoPayload.request.body.rotateServerCaContext) | extend RequestBodyRestoreInstanceSettingsInstanceUid= tostring(ProtoPayload.request.body.restoreInstanceSettings.instanceUid) | extend RequestBodyRestoreInstanceSettingsName= tostring(ProtoPayload['request']['body']['restoreInstanceSettings']['name']) | extend RequestBodyRestoreInstanceSettingsProject= tostring(ProtoPayload['request']['body']['restoreInstanceSettings']['project']) | extend RequestBodyRestoreInstanceSettingsRegion= tostring(ProtoPayload.request.body.restoreInstanceSettings.region) | extend RequestBodySettingsActivationPolicy = tostring(ProtoPayload.request.body.settings.activationPolicy) | extend RequestBodySettingsActiveDirectoryConfig = tostring(ProtoPayload.request.body.settings.activeDirectoryConfig) | extend RequestBodySettingsAdvancedMachineFeatures = tostring(ProtoPayload.request.body.settings.advancedMachineFeatures) | extend RequestBodySettingsCollation = tostring(ProtoPayload.request.body.settings.collation) | extend RequestBodySettingsAvailabilityType = tostring(ProtoPayload.request.body.settings.availabilityType) | extend RequestBodySettingsRetentinedBackup = tostring(ProtoPayload.request.body.settings.backupConfiguration.backupRetentionSettings.retainedBackups) | extend RequestBodySettingsRetentionUnit = tostring(ProtoPayload.request.body.settings.backupConfiguration.backupRetentionSettings.retentionUnit) | extend RequestBodySettingsBackupEnabled = tobool(ProtoPayload.request.body.settings.backupConfiguration.enabled) | extend RequestBodySettingsBackupLocation = tostring(ProtoPayload.request.body.settings.backupConfiguration.location) | extend RequestBodySettingsBackupPointInTimeRecoveryEnabled = tostring(ProtoPayload['request']['body']['settings']['backupConfiguration']['PointInTimeRecoveryEnabled']) | extend RequestBodySettingsBinaryLogEnabled = tobool(ProtoPayload.request.body.settings.backupConfiguration.binaryLogEnabled) | extend RequestBodySettingsBackupStartTime = tostring(ProtoPayload['request']['body']['settings']['backupConfiguration']['startTime']) | extend RequestBodySettingsTransactionLogRetentionDays = tostring(ProtoPayload.request.body.settings.backupConfiguration.transactionLogRetentionDays) | extend RequestBodySettingsConnectionPoolConfig = tostring(ProtoPayload.request.body.settings.connectionPoolConfig) | extend RequestBodySettingsdataCacheConfigDataCacheEnabled = tobool(ProtoPayload.request.body.settings.dataCacheConfig.dataCacheEnabled) | extend RequestBodySettingsDataDiskSizeGb = tostring(ProtoPayload.request.body.settings.dataDiskSizeGb) | extend RequestBodySettingsDataDiskType = tostring(ProtoPayload.request.body.settings.dataDiskType) | extend RequestBodySettingsDeletionProtectionEnabled = tobool(ProtoPayload.request.body.settings.deletionProtectionEnabled) | extend RequestBodySettingsEdition = tostring(ProtoPayload.request.body.settings.edition) | extend RequestBodySettingsEnableGoogleMlIntegration = tobool(ProtoPayload.request.body.settings.enableGoogleMlIntegration) | extend RequestBodySettingsInsightsConfig = todynamic(ProtoPayload.request.body.settings.insightsConfig) | extend RequestBodySettingsIPConfiguration = todynamic(ProtoPayload.request.body.settings.ipConfiguration) | extend RequestBodySettingsLocationPreference = tostring(ProtoPayload.request.body.settings.locationPreference) | extend RequestBodySettingsMaintenanceWindow = todynamic(ProtoPayload.request.body.settings.maintenanceWindow) | extend RequestBodySettingsRetainBackupsOnDelete = tobool(ProtoPayload.request.body.settings.retainBackupsOnDelete) | extend RequestBodySettingsVersion = tobool(ProtoPayload.request.body.settings.settingsVersion) | extend RequestBodySettingsSqlServerAuditConfigRetentionInterval = todatetime(ProtoPayload.request.body.settings.sqlServerAuditConfig.retentionInterval) | extend RequestBodySettingsSqlServerAuditConfigUploadInterval = todatetime(ProtoPayload.request.body.settings.sqlServerAuditConfig.uploadInterval) | extend RequestBodySettingsStorageAutoResize = tobool(ProtoPayload.request.body.settings.storageAutoResize) | extend RequestBodySettingsTier = tostring(ProtoPayload.request.body.settings.tier) | extend RequestBodySettingsTmeZone = tostring(ProtoPayload.request.body.settings.timeZone) | extend RequestBodySettingsUserbackuplable = tostring(ProtoPayload.request.body.settings.userLabels.backuplable) | extend RequestProject = tostring(ProtoPayload['request']['project']) | extend RequestId = tostring(ProtoPayload.request.requestId) | extend RequestMetadataCallerIP = tostring(ProtoPayload.requestMetadata.callerIp) | extend RequestMetadataRequestAttributesDestinationAttributes = tostring(ProtoPayload.requestMetadata.destinationAttributes) | extend RequestMetadataRequestAttributesAuth = tostring(ProtoPayload.requestMetadata.requestAttributes.auth) | extend RequestMetadataRequestAttributesRequestReason = tostring(ProtoPayload.requestMetadata.requestAttributes.reason) | extend RequestMetadataRequestAttributesRequestTime = todatetime(ProtoPayload['requestMetadata']['requestAttributes']['time']) | extend ResponseType = tostring(ProtoPayload['response']['@type']) | extend ResponseClientCert = tostring(ProtoPayload['response']['clientCert']) | extend ResponseServerCaCert = tostring(ProtoPayload['response']['serverCaCert']) | extend ResponseOperation = tostring(ProtoPayload['response']['operation']) | extend ResponseEphemeralCertKind  = tostring(ProtoPayload['response']['ephemeralCert']['kind']) | extend ResponseBackupContextBackupId  = tostring(ProtoPayload['response']['backupContext']['backupId']) | extend ResponseBackupContextKind  = tostring(ProtoPayload['response']['backupContext']['kind']) | extend ResponseBackupContextName  = tostring(ProtoPayload['response']['backupContext']['name']) | extend OperationInsertTime = todatetime(ProtoPayload['response']['insertTime']) | extend ResponseInstanceUid = tostring(ProtoPayload.response.instanceUid) | extend ResponseKind = tostring(ProtoPayload['response']['kind']) | extend ResponseName = tostring(ProtoPayload.response.name) | extend ResponseOperationType = tostring(ProtoPayload.response.operationType) | extend ResponsePromoteContextPrimary = tostring(ProtoPayload.response.promoteContext.primary) | extend ResponsePromoteContextReplica = tostring(ProtoPayload.response.promoteContext.replica) | extend ResponseSelfLink = tostring(ProtoPayload.response.selfLink) | extend ResponseStatus = tostring(ProtoPayload.response.status) | extend ResponseTargetId = tostring(ProtoPayload.response.targetId) | extend ResponseTargetLink = tostring(ProtoPayload.response.targetLink) | extend ResponseTargetProject = tostring(ProtoPayload.response.targetProject) | extend ResponseUser = tostring(ProtoPayload.response.user) | extend ServiceName = tostring(ProtoPayload.serviceName) | extend StatusCode = tostring(ProtoPayload.status.code) | extend StatusMessage = tostring(ProtoPayload.status.message) | extend ReceiveTimestamp = receiveTimestamp | extend ResourceLabelsDatabaseId = tostring(Resource['labels']['database_id']) | extend ResourceLabelsProjectId = tostring(Resource['labels']['project_id']) | extend ResourceLabelsRegion = tostring(Resource['labels']['region']) | extend ResourceType = tostring(Resource['type']) | extend Severity = tostring(severity) | extend TimeGenerated = todatetime(timestamp) | extend Timestamp = todatetime(timestamp) | extend LogName = tostring(logName) | extend InsertId = tostring(insertId) | project InsertId, LogName, OperationFirst, OperationLast, OperationId, OperationProducer, PayloadType, AuthInfoPrincipalEmail, AuthInfoPrincipalSubject, AuthInfoServiceAccountKeyName, AuthorizationInfo, MetadataType, MethodName, RequestType, RequestEnableFinalBackup, RequestFinalBackupTtlDays, RequestName, RequestFilter, RequestPageSize, RequestParent, RequestInstance, RequestHost, RequestMaxResults, RequestResourceId, RequestStartTime, RequestEndTime, RequestOperation, RequestSha1Fingerprint, RequestBodyBackendType, RequestBodyDatabaseVersion, RequestBodyInstanceType, RequestBodyInstanceUid, RequestBodyMasterInstance, RequestBodyMasterInstanceName, RequestBodyMasterInstanceRegion, RequestBodyName, RequestBodyUser, RequestBodyCommonName, RequestBodyRegion, RequestBodyCharset, RequestBodyKind, RequestBodyPasswordPolicy, RequestBodyDescription, RequestBodyLocation, RequestBodyCloneContextDestinationInstanceName, RequestBodyFailoverContext, RequestBodyBackup, RequestBodyDualPasswordType, RequestBodyHost, RequestBodyNodeCount, RequestBodyRotateServerCaContext, RequestBodyRestoreInstanceSettingsInstanceUid, RequestBodyRestoreInstanceSettingsName, RequestBodyRestoreInstanceSettingsProject, RequestBodyRestoreInstanceSettingsRegion, RequestBodyInstance, RequestDatabase, RequestBodyExportContext, RequestBodySettingsActivationPolicy, RequestBodySettingsActiveDirectoryConfig, RequestBodySettingsAvailabilityType, RequestBodySettingsRetentinedBackup, RequestBodySettingsRetentionUnit, RequestBodySettingsBackupEnabled, RequestBodyProject, RequestBodySettingsBackupLocation, RequestBodySettingsBackupPointInTimeRecoveryEnabled, RequestBodySettingsBinaryLogEnabled, RequestBodySettingsBackupStartTime, RequestBodySettingsTransactionLogRetentionDays, RequestBodySettingsConnectionPoolConfig, RequestBodySettingsdataCacheConfigDataCacheEnabled, RequestBodySettingsDataDiskSizeGb, RequestBodySettingsDataDiskType, RequestBodySettingsDeletionProtectionEnabled, RequestBodySettingsEdition, RequestBodySettingsEnableGoogleMlIntegration, RequestBodySettingsInsightsConfig, RequestBodySettingsIPConfiguration, RequestBodySettingsLocationPreference, RequestBodySettingsMaintenanceWindow, RequestBodySettingsRetainBackupsOnDelete, RequestBodySettingsVersion, RequestBodySettingsSqlServerAuditConfigRetentionInterval, RequestBodySettingsSqlServerAuditConfigUploadInterval, RequestBodySettingsStorageAutoResize, RequestBodySettingsTier, RequestBodySettingsTmeZone, RequestBodySettingsUserbackuplable, RequestProject, RequestId, RequestMetadataCallerIP, RequestMetadataRequestAttributesDestinationAttributes, RequestMetadataRequestAttributesAuth, RequestMetadataRequestAttributesRequestReason, RequestMetadataRequestAttributesRequestTime, ResourceName, ResponseType, ResponseClientCert, ResponseServerCaCert, ResponseOperation, ResponseEphemeralCertKind, ResponseBackupContextBackupId, ResponseBackupContextKind, ResponseBackupContextName, OperationInsertTime, ResponseInstanceUid, ResponseKind, ResponseName, ResponseOperationType, ResponsePromoteContextPrimary, ResponsePromoteContextReplica, ResponseSelfLink, ResponseStatus, ResponseTargetId, ResponseTargetLink, ResponseTargetProject, ResponseUser, ServiceName, StatusCode, StatusMessage, ReceiveTimestamp, ResourceLabelsDatabaseId, ResourceLabelsProjectId, ResourceLabelsRegion, ResourceType, Severity, Timestamp, TimeGenerated",
                    "outputStream": "Custom-GCP_CloudSQL_CL"
                }
            ]
        }
    }
]