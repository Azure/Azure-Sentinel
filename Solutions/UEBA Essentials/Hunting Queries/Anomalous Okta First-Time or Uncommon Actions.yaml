id: d4e5f6g7-h8i9-0123-defg-hi4567890123
name: Anomalous Okta First-Time or Uncommon Actions
description: |
  'Detects anomalous Okta activities where a user performs an action that is uncommon in the tenant or connects from a country for the first time. The query focuses on high-priority anomalies and provides key details such as timestamp, action type, source IP, location, and associated user and activity insights for investigation.'
requiredDataConnectors:
  - connectorId: BehaviorAnalytics
    dataTypes:
      - BehaviorAnalytics
tactics:
  - InitialAccess
  - CredentialAccess
  - Persistence
relevantTechniques:
  - T1078
  - T1110
  - T1556
query: |
  BehaviorAnalytics
  | where TimeGenerated > ago(7d)
  | where EventSource == "Okta_CL"
  | where InvestigationPriority > 0
  | where ActivityInsights.ActionUncommonlyPerformedInTenant == True 
         or ActivityInsights.FirstTimeUserConnectedFromCountry == True
  | project TimeGenerated, ActionType, ActivityType, InvestigationPriority, 
            SourceIPAddress, SourceIPLocation, UsersInsights, ActivityInsights
  | extend Account_0_Name = tostring(UsersInsights.UserPrincipalName)
  | extend IP_0_Address = SourceIPAddress
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Account_0_Name
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IP_0_Address
version: 2.0.0