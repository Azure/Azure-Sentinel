id: e5f6g7h8-i9j0-1234-efgh-ij5678901234
name: Anomalous GCP IAM Activity
description: |
  'Identifies anomalous IAM-related activities in Google Cloud Platform (GCP) Audit Logs where the investigation priority is greater than zero. This query highlights potential privilege or access anomalies by providing key details such as timestamp, action type, activity type, source IP, location, and associated user and activity insights for further investigation.'
requiredDataConnectors:
  - connectorId: BehaviorAnalytics
    dataTypes:
      - BehaviorAnalytics
tactics:
  - PrivilegeEscalation
  - Persistence
  - CredentialAccess
relevantTechniques:
  - T1078
  - T1548
  - T1098
query: |
  BehaviorAnalytics
  | where TimeGenerated > ago(7d)
  | where EventSource == "GCP Audit Logs"
  | where ActivityType contains "IAM"
  | where InvestigationPriority > 0
  | project TimeGenerated, ActionType, ActivityType, InvestigationPriority, 
            SourceIPAddress, SourceIPLocation, UsersInsights, ActivityInsights
  | extend Account_0_Name = tostring(UsersInsights.UserPrincipalName)
  | extend IP_0_Address = SourceIPAddress
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Account_0_Name
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IP_0_Address
version: 2.0.0