{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for ProofPointTap"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Proofpoint TAP",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "_solutionName": "ProofPointTap",
    "_solutionVersion": "3.0.1",
    "solutionId": "azuresentinel.azure-sentinel-proofpoint",
    "_solutionId": "[variables('solutionId')]",
    "uiConfigId1": "ProofpointTAP",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "ProofpointTAP",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "parserName1": "ProofpointTAPEvent",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1'))))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "ProofpointTAPEvent-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "_parsercontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('_parserContentId1'),'-', variables('parserVersion1'))))]",
    "analyticRuleVersion1": "1.0.3",
    "analyticRulecontentId1": "0558155e-4556-447e-9a22-828f2a7de06b",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1'))))]",
    "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId1'),'-', variables('analyticRuleVersion1'))))]",
    "analyticRuleVersion2": "1.0.3",
    "analyticRulecontentId2": "8675dd7a-795e-4d56-a79c-fc848c5ee61c",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2'))))]",
    "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId2'),'-', variables('analyticRuleVersion2'))))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "ProofPointTAPWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "ProofpointTAPConnector": "ProofpointTAPConnector",
    "_ProofpointTAPConnector": "[variables('ProofpointTAPConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "ProofpointTAPConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1'))))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','lc','-', uniqueString(concat(variables('_solutionId'),'-','LogicAppsCustomConnector','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "Get-ProofPointTapEvents": "Get-ProofPointTapEvents",
    "_Get-ProofPointTapEvents": "[variables('Get-ProofPointTapEvents')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Get-ProofPointTapEvents",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "ProofpointTAP-AddForensicsInfoToIncident": "ProofpointTAP-AddForensicsInfoToIncident",
    "_ProofpointTAP-AddForensicsInfoToIncident": "[variables('ProofpointTAP-AddForensicsInfoToIncident')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "ProofpointTAP-AddForensicsInfoToIncident",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "ProofpointTAP-CheckAccountInVAP": "ProofpointTAP-CheckAccountInVAP",
    "_ProofpointTAP-CheckAccountInVAP": "[variables('ProofpointTAP-CheckAccountInVAP')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "ProofpointTAP-CheckAccountInVAP",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofPointTap data connector with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Proofpoint TAP (using Azure Functions)",
                  "publisher": "Proofpoint",
                  "descriptionMarkdown": "The [Proofpoint Targeted Attack Protection (TAP)](https://www.proofpoint.com/us/products/advanced-threat-protection/targeted-attack-protection) connector provides the capability to ingest Proofpoint TAP logs and events into Microsoft Sentinel. The connector provides visibility into Message and Click events in Microsoft Sentinel to view dashboards, create custom alerts, and to improve monitoring and investigation capabilities.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "Proofpoint TAP Messages Delivered",
                      "baseQuery": "ProofPointTAPMessagesDelivered_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Proofpoint TAP Messages Blocked",
                      "baseQuery": "ProofPointTAPMessagesBlocked_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Proofpoint TAP Clicks Permitted",
                      "baseQuery": "ProofPointTAPClicksPermitted_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "Proofpoint TAP Clicks Blocked",
                      "baseQuery": "ProofPointTAPClicksBlocked_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Malware click events permitted",
                      "query": "ProofPointTAPClicksPermitted_CL\n | where classification_s == \"malware\" \n | take 10"
                    },
                    {
                      "description": "Phishing click events blocked",
                      "query": "ProofPointTAPClicksBlocked_CL\n | where classification_s == \"phish\" \n | take 10"
                    },
                    {
                      "description": "Malware messages events delivered",
                      "query": "ProofPointTAPMessagesDelivered_CL\n | mv-expand todynamic(threatsInfoMap_s)\n | extend classification = tostring(threatsInfoMap_s.classification)\n | where classification == \"malware\" \n | take 10"
                    },
                    {
                      "description": "Phishing message events blocked",
                      "query": "ProofPointTAPMessagesBlocked_CL\n | mv-expand todynamic(threatsInfoMap_s)\n | extend classification = tostring(threatsInfoMap_s.classification)\n | where classification == \"phish\""
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "ProofPointTAPClicksPermitted_CL",
                      "lastDataReceivedQuery": "ProofPointTAPClicksPermitted_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "ProofPointTAPClicksBlocked_CL",
                      "lastDataReceivedQuery": "ProofPointTAPClicksBlocked_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "ProofPointTAPMessagesDelivered_CL",
                      "lastDataReceivedQuery": "ProofPointTAPMessagesDelivered_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "ProofPointTAPMessagesBlocked_CL",
                      "lastDataReceivedQuery": "ProofPointTAPMessagesBlocked_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "ProofPointTAPMessagesDelivered_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "ProofPointTAPMessagesBlocked_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "ProofPointTAPClicksPermitted_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "ProofPointTAPMessagesBlocked_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Proofpoint TAP API Key",
                        "description": "A Proofpoint TAP API username and password is required. [See the documentation to learn more about Proofpoint SIEM API](https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/SIEM_API)."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to Proofpoint TAP to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the Proofpoint TAP API**\n\n1. Log into the Proofpoint TAP console \n2. Navigate to **Connect Applications** and select **Service Principal**\n3. Create a **Service Principal** (API Authorization Key)"
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Proofpoint TAP connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Proofpoint TAP API Authorization Key(s), readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "instructions": [
                        {
                          "parameters": {
                            "instructionSteps": [
                              {
                                "title": "Option 1 - Azure Resource Manager (ARM) Template",
                                "description": "Use this method for automated deployment of the Proofpoint TAP connector.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelproofpointtapazuredeploy) \n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **API Username**, **API Password**, and validate the **Uri**.\n> - The default URI is pulling data for the last 300 seconds (5 minutes) to correspond with the default Function App Timer trigger of 5 minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion. \n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy."
                              },
                              {
                                "title": "Option 2 - Manual Deployment of Azure Functions",
                                "description": "This method provides the step-by-step instructions to deploy the Proofpoint TAP connector manually with Azure Function (Deployment via Visual Studio Code).",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "instructionSteps": [
                                        {
                                          "title": "Step 1 - Deploy a Function App",
                                          "description": "1. Download the [Azure Function App](https://aka.ms/sentinelproofpointtapazurefunctionzip) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeployment.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
                                        },
                                        {
                                          "title": "Step 2 - Configure the Function App",
                                          "description": "1. Go to Azure Portal for the Function App configuration.\n2. In the Function App, select the Function App Name and select **Configuration**.\n3. In the **Application settings** tab, select **+ New application setting**.\n4. Add each of the following six (6) application settings individually, with their respective string values (case-sensitive): \n\t\tapiUsername\n\t\tapipassword\n\t\tworkspaceID\n\t\tworkspaceKey\n\t\turi\n\t\tlogAnalyticsUri (optional)\n> - Set the `uri` value to: `https://tap-api-v2.proofpoint.com/v2/siem/all?format=json&sinceSeconds=300`\n> - The default URI is pulling data for the last 300 seconds (5 minutes) to correspond with the default Function App Timer trigger of 5 minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly to prevent overlapping data ingestion.\n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details.\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`\n5. Once all application settings have been entered, click **Save**."
                                        }
                                      ]
                                    },
                                    "type": "InstructionStepsGroup"
                                  }
                                ]
                              }
                            ]
                          },
                          "type": "InstructionStepsGroup"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "Proofpoint TAP (using Azure Functions)",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "ProofPointTap",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Proofpoint TAP (using Azure Functions)",
          "publisher": "Proofpoint",
          "descriptionMarkdown": "The [Proofpoint Targeted Attack Protection (TAP)](https://www.proofpoint.com/us/products/advanced-threat-protection/targeted-attack-protection) connector provides the capability to ingest Proofpoint TAP logs and events into Microsoft Sentinel. The connector provides visibility into Message and Click events in Microsoft Sentinel to view dashboards, create custom alerts, and to improve monitoring and investigation capabilities.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Proofpoint TAP Messages Delivered",
              "baseQuery": "ProofPointTAPMessagesDelivered_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "Proofpoint TAP Messages Blocked",
              "baseQuery": "ProofPointTAPMessagesBlocked_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "Proofpoint TAP Clicks Permitted",
              "baseQuery": "ProofPointTAPClicksPermitted_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "Proofpoint TAP Clicks Blocked",
              "baseQuery": "ProofPointTAPClicksBlocked_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "ProofPointTAPClicksPermitted_CL",
              "lastDataReceivedQuery": "ProofPointTAPClicksPermitted_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "ProofPointTAPClicksBlocked_CL",
              "lastDataReceivedQuery": "ProofPointTAPClicksBlocked_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "ProofPointTAPMessagesDelivered_CL",
              "lastDataReceivedQuery": "ProofPointTAPMessagesDelivered_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "ProofPointTAPMessagesBlocked_CL",
              "lastDataReceivedQuery": "ProofPointTAPMessagesBlocked_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "ProofPointTAPMessagesDelivered_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "ProofPointTAPMessagesBlocked_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "ProofPointTAPClicksPermitted_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "ProofPointTAPMessagesBlocked_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Malware click events permitted",
              "query": "ProofPointTAPClicksPermitted_CL\n | where classification_s == \"malware\" \n | take 10"
            },
            {
              "description": "Phishing click events blocked",
              "query": "ProofPointTAPClicksBlocked_CL\n | where classification_s == \"phish\" \n | take 10"
            },
            {
              "description": "Malware messages events delivered",
              "query": "ProofPointTAPMessagesDelivered_CL\n | mv-expand todynamic(threatsInfoMap_s)\n | extend classification = tostring(threatsInfoMap_s.classification)\n | where classification == \"malware\" \n | take 10"
            },
            {
              "description": "Phishing message events blocked",
              "query": "ProofPointTAPMessagesBlocked_CL\n | mv-expand todynamic(threatsInfoMap_s)\n | extend classification = tostring(threatsInfoMap_s.classification)\n | where classification == \"phish\""
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Proofpoint TAP API Key",
                "description": "A Proofpoint TAP API username and password is required. [See the documentation to learn more about Proofpoint SIEM API](https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/SIEM_API)."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to Proofpoint TAP to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": "**STEP 1 - Configuration steps for the Proofpoint TAP API**\n\n1. Log into the Proofpoint TAP console \n2. Navigate to **Connect Applications** and select **Service Principal**\n3. Create a **Service Principal** (API Authorization Key)"
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Proofpoint TAP connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Proofpoint TAP API Authorization Key(s), readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "instructions": [
                {
                  "parameters": {
                    "instructionSteps": [
                      {
                        "title": "Option 1 - Azure Resource Manager (ARM) Template",
                        "description": "Use this method for automated deployment of the Proofpoint TAP connector.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinelproofpointtapazuredeploy) \n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **API Username**, **API Password**, and validate the **Uri**.\n> - The default URI is pulling data for the last 300 seconds (5 minutes) to correspond with the default Function App Timer trigger of 5 minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly (in the function.json file, post deployment) to prevent overlapping data ingestion. \n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy."
                      },
                      {
                        "title": "Option 2 - Manual Deployment of Azure Functions",
                        "description": "This method provides the step-by-step instructions to deploy the Proofpoint TAP connector manually with Azure Function (Deployment via Visual Studio Code).",
                        "instructions": [
                          {
                            "parameters": {
                              "instructionSteps": [
                                {
                                  "title": "Step 1 - Deploy a Function App",
                                  "description": "1. Download the [Azure Function App](https://aka.ms/sentinelproofpointtapazurefunctionzip) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeployment.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
                                },
                                {
                                  "title": "Step 2 - Configure the Function App",
                                  "description": "1. Go to Azure Portal for the Function App configuration.\n2. In the Function App, select the Function App Name and select **Configuration**.\n3. In the **Application settings** tab, select **+ New application setting**.\n4. Add each of the following six (6) application settings individually, with their respective string values (case-sensitive): \n\t\tapiUsername\n\t\tapipassword\n\t\tworkspaceID\n\t\tworkspaceKey\n\t\turi\n\t\tlogAnalyticsUri (optional)\n> - Set the `uri` value to: `https://tap-api-v2.proofpoint.com/v2/siem/all?format=json&sinceSeconds=300`\n> - The default URI is pulling data for the last 300 seconds (5 minutes) to correspond with the default Function App Timer trigger of 5 minutes. If the time interval needs to be modified, it is recommended to change the Function App Timer Trigger accordingly to prevent overlapping data ingestion.\n> - Note: If using Azure Key Vault secrets for any of the values above, use the`@Microsoft.KeyVault(SecretUri={Security Identifier})`schema in place of the string values. Refer to [Key Vault references documentation](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) for further details.\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`\n5. Once all application settings have been entered, click **Save**."
                                }
                              ]
                            },
                            "type": "InstructionStepsGroup"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ]
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointTAPEvent Data Parser with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointTAPEvent",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "ProofpointTAPEvent",
                "query": "union isfuzzy=true ProofpointTAPNativePoller_CL, ProofPointTAPMessagesDelivered_CL, ProofPointTAPMessagesBlocked_CL, ProofPointTAPClicksPermitted_CL, ProofPointTAPClicksBlocked_CL\n| extend EventVendor = 'Proofpoint',\n         EventProduct = 'Targeted Attack Protection',\n         EventCount = '1'\n| project-rename CcAddresses=ccAddresses_s,\n\t             Cluster=cluster_s,\n\t             CompletelyRewritten=completelyRewritten_b,\n\t             SrcUsername=fromAddress_s,\n\t             EventOriginalUid=GUID_s,\n\t             HeaderFrom=headerFrom_s,\n\t             HeaderReplyTo=headerReplyTo_s,\n\t             Id=id_g,\n\t             ImpostorScore=impostorScore_d,\n\t             MalwareScore=malwareScore_d,\n\t             MessageId=messageID_s,\n\t             MessageParts=messageParts_s,\n\t             NetworkBytes=messageSize_d,\n\t             EventEndTime=messageTime_t,\n\t             ModulesRun=modulesRun_s,\n\t             PhishScore=phishScore_d,\n\t             PolicyRoutes=policyRoutes_s,\n\t             Qid=QID_s,\n\t             QuarantineFolder=quarantineFolder_s,\n\t             QuarantineRule=quarantineRule_s,\n\t             Recipient=recipient_s,\n\t             ReplyToAddress=replyToAddress_s,\n\t             Sender=sender_s,\n\t             SrcIpAddr=senderIP_s,\n\t             SpamScore=spamScore_d,\n\t             Subject=subject_s,\n\t             ThreatsInfoMap=threatsInfoMap_s,\n\t             DstUsername=toAddresses_s,\n\t             Xmailer=xmailer_s\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserId1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "ProofPointTap",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_parserContentId1')]",
        "contentKind": "Parser",
        "displayName": "ProofpointTAPEvent",
        "contentProductId": "[variables('_parsercontentProductId1')]",
        "id": "[variables('_parsercontentProductId1')]",
        "version": "[variables('parserVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "ProofpointTAPEvent",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "ProofpointTAPEvent",
        "query": "union isfuzzy=true ProofpointTAPNativePoller_CL, ProofPointTAPMessagesDelivered_CL, ProofPointTAPMessagesBlocked_CL, ProofPointTAPClicksPermitted_CL, ProofPointTAPClicksBlocked_CL\n| extend EventVendor = 'Proofpoint',\n         EventProduct = 'Targeted Attack Protection',\n         EventCount = '1'\n| project-rename CcAddresses=ccAddresses_s,\n\t             Cluster=cluster_s,\n\t             CompletelyRewritten=completelyRewritten_b,\n\t             SrcUsername=fromAddress_s,\n\t             EventOriginalUid=GUID_s,\n\t             HeaderFrom=headerFrom_s,\n\t             HeaderReplyTo=headerReplyTo_s,\n\t             Id=id_g,\n\t             ImpostorScore=impostorScore_d,\n\t             MalwareScore=malwareScore_d,\n\t             MessageId=messageID_s,\n\t             MessageParts=messageParts_s,\n\t             NetworkBytes=messageSize_d,\n\t             EventEndTime=messageTime_t,\n\t             ModulesRun=modulesRun_s,\n\t             PhishScore=phishScore_d,\n\t             PolicyRoutes=policyRoutes_s,\n\t             Qid=QID_s,\n\t             QuarantineFolder=quarantineFolder_s,\n\t             QuarantineRule=quarantineRule_s,\n\t             Recipient=recipient_s,\n\t             ReplyToAddress=replyToAddress_s,\n\t             Sender=sender_s,\n\t             SrcIpAddr=senderIP_s,\n\t             SpamScore=spamScore_d,\n\t             Subject=subject_s,\n\t             ThreatsInfoMap=threatsInfoMap_s,\n\t             DstUsername=toAddresses_s,\n\t             Xmailer=xmailer_s\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "ProofPointTap",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MalwareAttachmentDelivered_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query identifies a message containing a malware attachment that was delivered.",
                "displayName": "Malware attachment delivered",
                "enabled": false,
                "query": "ProofPointTAPMessagesDelivered_CL\n| mv-expand todynamic(threatsInfoMap_s)\n| mv-expand todynamic(messageParts_s)\n| extend threatType = tostring(threatsInfoMap_s.threatType), classification = tostring(threatsInfoMap_s.classification)\n| extend filename = tostring(messageParts_s.filename)\n| where threatType =~ \"attachment\" and classification =~ \"malware\"\n| summarize filenames = make_set(filename), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by TimeGenerated, Sender = sender_s, SenderIPAddress = senderIP_s, Recipient = recipient_s, threatType, classification,  Subject = subject_s\n| extend timestamp = StartTime, AccountCustomEntity = Recipient, IPCustomEntity = SenderIPAddress\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "ProofpointTAP",
                    "dataTypes": [
                      "ProofPointTAPMessagesDelivered_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1566"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "ProofPointTap Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId1')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Malware attachment delivered",
        "contentProductId": "[variables('_analyticRulecontentProductId1')]",
        "id": "[variables('_analyticRulecontentProductId1')]",
        "version": "[variables('analyticRuleVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "MalwareLinkClicked_AnalyticalRules Analytics Rule with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This query identifies a user clicking on an email link whose threat category is classified as a malware",
                "displayName": "Malware Link Clicked",
                "enabled": false,
                "query": "ProofPointTAPClicksPermitted_CL\n| where classification_s =~ \"malware\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by TimeGenerated, Sender = sender_s, SenderIPAddress = senderIP_s, Recipient = recipient_s, TimeClicked = clickTime_t, URLClicked = url_s\n| extend timestamp = StartTime, AccountCustomEntity = Recipient, IPCustomEntity = SenderIPAddress, URLCustomEntity = URLClicked\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "ProofpointTAP",
                    "dataTypes": [
                      "ProofPointTAPClicksPermitted_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1566"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "ProofPointTap Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId2')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Malware Link Clicked",
        "contentProductId": "[variables('_analyticRulecontentProductId2')]",
        "id": "[variables('_analyticRulecontentProductId2')]",
        "version": "[variables('analyticRuleVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointTAPWorkbook Workbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain extensive insight into Proofpoint Targeted Attack Protection (TAP) by analyzing, collecting and correlating TAP log events.\nThis workbook provides visibility into message and click events that were permitted, delivered, or blocked"
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Messages\",\"subTarget\":\"Messages\",\"style\":\"link\"},{\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Clicks\",\"subTarget\":\"Clicks\",\"style\":\"link\"}]},\"name\":\"links - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"326a3767-8597-43ee-a116-44fc7280c63a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"resourceType\":\"microsoft.insights/components\",\"label\":\"Time Range\"},{\"id\":\"59948c5e-ab41-4b57-85f0-5e65966dd98e\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Classification\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"union ProofPointTAPMessagesBlocked_CL, ProofPointTAPMessagesDelivered_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend classification = tostring(threatsInfoMap_s.classification)\\n| distinct classification\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"503a952f-d169-4c5a-bf2e-5e74672bd9d4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ThreatType\",\"label\":\"Threat Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"union ProofPointTAPMessagesBlocked_CL, ProofPointTAPMessagesDelivered_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\n| distinct threatType_\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.insights/components\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union ProofPointTAPMessagesBlocked_CL, ProofPointTAPMessagesDelivered_CL\\r\\n| mv-expand todynamic(threatsInfoMap_s)\\r\\n| extend classification = tostring(threatsInfoMap_s.classification)\\r\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\r\\n| where classification in ({Classification}) or '*' in ({Classification})\\r\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\r\\n| summarize phish = countif(classification == 'phish'), malware = countif(classification == \\\"malware\\\"), impostor = countif(classification == \\\"impostor\\\"), spam = countif(classification == \\\"spam\\\") by bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"title\":\"Message Events by Classification\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"red\"},{\"seriesName\":\"impostor\",\"color\":\"green\"},{\"seriesName\":\"spam\",\"color\":\"magenta\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union ProofPointTAPClicksBlocked_CL, ProofPointTAPClicksPermitted_CL\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize phish = countif(classification_s == \\\"phish\\\"), malware = countif(classification_s == \\\"malware\\\"), spam = countif(classification_s == \\\"spam\\\") by bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"showAnalytics\":true,\"title\":\"Click Events by Classification\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"spam\",\"color\":\"magenta\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query - 2 - Clicks\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union ProofPointTAPClicksBlocked_CL, ProofPointTAPClicksPermitted_CL\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize ClicksBlocked = countif(Type == \\\"ProofPointTAPClicksBlocked_CL\\\"), ClicksPermitted = countif(Type == \\\"ProofPointTAPClicksPermitted_CL\\\") by bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"showAnalytics\":true,\"title\":\"Clicks Blocked vs. Permitted\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"spam\",\"color\":\"magenta\"},{\"seriesName\":\"ClicksBlocked\",\"color\":\"redBright\"},{\"seriesName\":\"ClicksPermitted\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query - 2 - Clicks - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"union ProofPointTAPMessagesBlocked_CL, ProofPointTAPMessagesDelivered_CL\\r\\n| mv-expand todynamic(threatsInfoMap_s)\\r\\n| extend classification = tostring(threatsInfoMap_s.classification)\\r\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\r\\n| where classification in ({Classification}) or '*' in ({Classification})\\r\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\r\\n| mv-expand todynamic(recipient_s)\\r\\n| summarize MessagesBlocked = countif(Type == \\\"ProofPointTAPMessagesBlocked_CL\\\"), MessagesDelivered = countif(Type == \\\"ProofPointTAPMessagesDelivered_CL\\\") by bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"showAnalytics\":true,\"title\":\"Messages Blocked vs. Delivered\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"MessagesBlocked\",\"color\":\"red\"},{\"seriesName\":\"MessagesDelivered\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"50\",\"name\":\"query - 2 -\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPClicksBlocked_CL\\r\\n| extend URL = extract(@\\\"\\\\/\\\\/(www.)?([a-zA-Z0-9-_.]+)(\\\\/|$)\\\",2,url_s)\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize phish = countif(classification_s == \\\"phish\\\"), malware = countif(classification_s == \\\"malware\\\"), spam = countif(classification_s == \\\"spam\\\"), count() by URL\\r\\n| project-rename Total = count_\\r\\n| top 10 by Total\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 10 Clicks Blocked by Domain\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"URL\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"magenta\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blueOrange\",\"showIcon\":true}}]},\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"impostor\",\"color\":\"magenta\"},{\"seriesName\":\"spam\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query_clicks_top10clicksblockedbydomain\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPClicksPermitted_CL\\r\\n| extend URL = extract(@\\\"\\\\/\\\\/(www.)?([a-zA-Z0-9-_.]+)(\\\\/|$)\\\",2,url_s)\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize phish = countif(classification_s == \\\"phish\\\"), malware = countif(classification_s == \\\"malware\\\"), spam = countif(classification_s == \\\"spam\\\"), count() by URL\\r\\n| project-rename Total = count_\\r\\n| top 10 by Total\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 10 Clicks Permitted by Domain\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"URL\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"magenta\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blueOrange\",\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"sortBy\":[{\"itemKey\":\"$gen_heatmap_phish_1\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_phish_1\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"impostor\",\"color\":\"magenta\"},{\"seriesName\":\"spam\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query_clicks_top10clickspermittedbydomain\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPClicksBlocked_CL\\r\\n| extend URL = extract(@\\\"\\\\/\\\\/(www.)?([a-zA-Z0-9-_.]+)(\\\\/|$)\\\",2,url_s)\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize phish = countif(classification_s == \\\"phish\\\"), malware = countif(classification_s == \\\"malware\\\"), spam = countif(classification_s == \\\"spam\\\"), count() by senderIP_s\\r\\n| project-rename Total = count_, SenderIP = senderIP_s\\r\\n| top 10 by Total\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 10 Clicks Blocked by Sender IP\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SenderIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"purple\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blueOrange\",\"showIcon\":true}},{\"columnMatch\":\"URL\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"SenderIP\",\"label\":\"Sender IP\"},{\"columnId\":\"phish\"},{\"columnId\":\"malware\"},{\"columnId\":\"spam\"},{\"columnId\":\"Total\"}]},\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"impostor\",\"color\":\"magenta\"},{\"seriesName\":\"spam\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query_clicks_top10clicksblockedbysenderIP\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPClicksPermitted_CL\\r\\n| extend URL = extract(@\\\"\\\\/\\\\/(www.)?([a-zA-Z0-9-_.]+)(\\\\/|$)\\\",2,url_s)\\r\\n| where classification_s in ({Classification}) or '*' in ({Classification})\\r\\n| summarize phish = countif(classification_s == \\\"phish\\\"), malware = countif(classification_s == \\\"malware\\\"), spam = countif(classification_s == \\\"spam\\\"), count() by clickIP_s\\r\\n| project-rename Total = count_, ClickIP = clickIP_s\\r\\n| top 10 by Total\",\"size\":0,\"showAnalytics\":true,\"title\":\"Top 10 Clicks Permitted by Click IP\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"ClickIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"purple\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blueOrange\",\"showIcon\":true}},{\"columnMatch\":\"URL\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Type\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}],\"sortBy\":[{\"itemKey\":\"$gen_heatmap_phish_1\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"ClickIP\",\"label\":\"Click IP\"},{\"columnId\":\"phish\"},{\"columnId\":\"malware\"},{\"columnId\":\"spam\"},{\"columnId\":\"Total\"}]},\"sortBy\":[{\"itemKey\":\"$gen_heatmap_phish_1\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"classification\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"phish\",\"color\":\"blue\"},{\"seriesName\":\"malware\",\"color\":\"redBright\"},{\"seriesName\":\"impostor\",\"color\":\"magenta\"},{\"seriesName\":\"spam\",\"color\":\"green\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Clicks\"},\"customWidth\":\"50\",\"name\":\"query_clicks_top10clickspermittedbyclickip\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPMessagesBlocked_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend classification = tostring(threatsInfoMap_s.classification)\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\n| where classification in ({Classification}) or '*' in ({Classification})\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\n| mv-expand todynamic(recipient_s)\\n| summarize phish = countif(classification == \\\"phish\\\"), malware = countif(classification == \\\"malware\\\"), impostor = countif(classification == \\\"impostor\\\"), spam = countif(classification == \\\"spam\\\"), count() by sender_s \\n| project-rename Total = count_, SourceAddress = sender_s \\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Blocked Sender Address\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceAddress\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"impostor\",\"formatter\":8,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"magenta\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}},{\"columnMatch\":\"SourceIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"70\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPMessagesBlocked_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend classification = tostring(threatsInfoMap_s.classification)\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\n| where classification in ({Classification}) or '*' in ({Classification})\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\n| mv-expand todynamic(recipient_s)\\n| summarize count() by threatType_  \",\"size\":0,\"title\":\"Threat Type\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPMessagesBlocked_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend classification = tostring(threatsInfoMap_s.classification)\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\n| where classification in ({Classification}) or '*' in ({Classification})\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\n| mv-expand todynamic(recipient_s)\\n| summarize phish = countif(classification == \\\"phish\\\"), malware = countif(classification == \\\"malware\\\"), impostor = countif(classification == \\\"impostor\\\"), spam = countif(classification == \\\"spam\\\"), count() by senderIP_s\\n| top 10 by count_\",\"size\":0,\"title\":\"Top 10 Blocked Sender IP \",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"senderIP_s\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"impostor\",\"formatter\":8,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"magenta\",\"showIcon\":true}},{\"columnMatch\":\"count_\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"SourceIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}],\"labelSettings\":[{\"columnId\":\"senderIP_s\",\"label\":\"Sender IP\"},{\"columnId\":\"phish\"},{\"columnId\":\"malware\"},{\"columnId\":\"impostor\"},{\"columnId\":\"spam\"},{\"columnId\":\"count_\",\"label\":\"Total\"}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"45\",\"name\":\"query - 5 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofPointTAPMessagesBlocked_CL\\n| mv-expand todynamic(threatsInfoMap_s)\\n| extend classification = tostring(threatsInfoMap_s.classification)\\n| extend threatType_ = tostring(threatsInfoMap_s.threatType)\\n| where classification in ({Classification}) or '*' in ({Classification})\\n| where threatType_ in ({ThreatType}) or '*' in ({ThreatType})\\n| mv-expand todynamic(recipient_s)\\n| summarize phish = countif(classification == \\\"phish\\\"), malware = countif(classification == \\\"malware\\\"), impostor = countif(classification == \\\"impostor\\\"), spam = countif(classification == \\\"spam\\\"), count() by tostring(recipient_s)\\n| project-rename Total = count_, Recipient = recipient_s\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Recipients\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"SourceIP\",\"formatter\":0,\"formatOptions\":{\"showIcon\":true}},{\"columnMatch\":\"phish\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\",\"showIcon\":true}},{\"columnMatch\":\"malware\",\"formatter\":8,\"formatOptions\":{\"palette\":\"red\",\"showIcon\":true}},{\"columnMatch\":\"impostor\",\"formatter\":8,\"formatOptions\":{\"palette\":\"green\",\"showIcon\":true}},{\"columnMatch\":\"spam\",\"formatter\":8,\"formatOptions\":{\"palette\":\"magenta\",\"showIcon\":true}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"greenRed\",\"showIcon\":true}}]}},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Messages\"},\"customWidth\":\"50\",\"name\":\"query - 5 - Copy - Copy\"}],\"fromTemplateId\":\"sentinel-ProofPointTAPWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ProofPointTAPWorkbook; logoFileName=proofpointlogo.svg; description=Gain extensive insight into Proofpoint Targeted Attack Protection (TAP) by analyzing, collecting and correlating TAP log events.\nThis workbook provides visibility into message and click events that were permitted, delivered, or blocked; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Proofpoint TAP; templateRelativePath=ProofpointTAP.json; subtitle=; provider=Proofpoint}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ProofPointTAPMessagesBlocked_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofPointTAPMessagesDelivered_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofPointTAPClicksPermitted_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofPointTAPClicksBlocked_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofpointTAP",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointTAPConnector Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "customApis_ProofpointTAP_name": {
              "defaultValue": "ProofpointTAP",
              "type": "string"
            }
          },
          "variables": {
            "operationId-getCampaignById": "getCampaignById",
            "_operationId-getCampaignById": "[[variables('operationId-getCampaignById')]",
            "operationId-getVAP": "getVAP",
            "_operationId-getVAP": "[[variables('operationId-getVAP')]",
            "operationId-getForensics": "getForensics",
            "_operationId-getForensics": "[[variables('operationId-getForensics')]",
            "operationId-getTopClickers": "getTopClickers",
            "_operationId-getTopClickers": "[[variables('operationId-getTopClickers')]",
            "operationId-decodeURL": "decodeURL",
            "_operationId-decodeURL": "[[variables('operationId-decodeURL')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "ProofpointTAPConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('customApis_ProofpointTAP_name'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('customApis_ProofpointTAP_name')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "username": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Service Principal",
                      "description": "The Service Principal for ProofpointTAP API",
                      "tooltip": "Provide the Service Principal",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": true,
                        "required": "true"
                      }
                    }
                  },
                  "password": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "Secret",
                      "description": "The Secret for ProofpointTAP API",
                      "tooltip": "Provide the Secret",
                      "constraints": {
                        "tabIndex": 3,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "description": "ProofpointTAP API Connector",
                "displayName": "[[parameters('customApis_ProofpointTAP_name')]",
                "brandColor": "#FFFFFF",
                "iconUri": "data:image/png;base64,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",
                "backendService": {
                  "serviceUrl": "https://tap-api-v2.proofpoint.com"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "ProofpointTAP",
                    "description": "ProofpointTAP API Connector",
                    "version": "1.0"
                  },
                  "host": "tap-api-v2.proofpoint.com",
                  "basePath": "/",
                  "schemes": [
                    "https"
                  ],
                  "consumes": "[variables('TemplateEmptyArray')]",
                  "produces": "[variables('TemplateEmptyArray')]",
                  "paths": {
                    "/v2/campaign/{campaignId}": {
                      "get": {
                        "summary": "Get Campaign by Id",
                        "description": "Fetch detailed information for a given campaign.",
                        "operationId": "[[variables('_operationId-getCampaignById')]",
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "name": "campaignId",
                            "in": "path",
                            "description": "ID of campaign to return",
                            "required": true,
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "At least one record matching the specified criteria was found and returned in the response body. In the case of JSON format, the structure is always returned, even if empty.",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "string",
                                  "description": "the campaign id",
                                  "x-ms-summary": "Campaign ID"
                                },
                                "name": {
                                  "type": "string",
                                  "description": "the name of the campaign",
                                  "x-ms-summary": "Campaign name"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "a description of the campaign written by one of Proofpoint's threat analysts",
                                  "x-ms-summary": "Campaign description"
                                },
                                "startDate": {
                                  "type": "string",
                                  "x-ms-summary": "Campaign start date",
                                  "description": "an  ISO8601-formatted datetime corresponding to the time the campaign's first threat variants were first observed"
                                },
                                "notable": {
                                  "type": "boolean",
                                  "description": "returns true when the campaign is marked as notable by Proofpoint's Threat Analyst team"
                                },
                                "actors": {
                                  "type": "array",
                                  "x-ms-summary": "Actors",
                                  "description": "optional, an array of Actor objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Actor",
                                    "description": "Actor object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Actor id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Actor name"
                                      }
                                    }
                                  }
                                },
                                "families": {
                                  "type": "array",
                                  "x-ms-summary": "Campaign Families",
                                  "description": "array of Campaign Family objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Campaign Family",
                                    "description": "Campaign Family object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Campaign Family id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Campaign Family name"
                                      }
                                    }
                                  }
                                },
                                "malware": {
                                  "description": "optional, an array of Malware objects",
                                  "type": "array",
                                  "x-ms-summary": "Malwares",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Malware",
                                    "description": "Malware object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Malware id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Malware name"
                                      }
                                    }
                                  }
                                },
                                "techniques": {
                                  "description": "optional, an array of Technique objects",
                                  "type": "array",
                                  "x-ms-summary": "Techniques",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Technique",
                                    "description": "Technique object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Technique id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Technique name"
                                      }
                                    }
                                  }
                                },
                                "brands": {
                                  "description": "optional, an array of Brand objects",
                                  "type": "array",
                                  "x-ms-summary": "Brands",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Brand",
                                    "description": "Brand object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "description": "Brand id"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "Brand name"
                                      }
                                    }
                                  }
                                },
                                "campaignMembers": {
                                  "type": "array",
                                  "x-ms-summary": "Campaign Members",
                                  "description": "array of Campaign Member objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Campaign Member",
                                    "description": "Campaign Member object",
                                    "properties": {
                                      "id": {
                                        "type": "string",
                                        "x-ms-summary": "ID",
                                        "description": "the threat identifier"
                                      },
                                      "threat": {
                                        "type": "string",
                                        "x-ms-summary": "threat",
                                        "description": "the attachment hash or URL fragment of the threat"
                                      },
                                      "threatStatus": {
                                        "type": "string",
                                        "description": "threat status",
                                        "x-ms-summary": "threat status"
                                      },
                                      "type": {
                                        "type": "string",
                                        "x-ms-summary": "threat type",
                                        "description": "the type of the threat: attachment or url"
                                      },
                                      "threatTime": {
                                        "type": "string",
                                        "x-ms-summary": "threat time",
                                        "description": "an  ISO8601-formatted datetime corresponding to the the threat variant was first recognized as malicious"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          },
                          "400": {
                            "description": "The request is missing a mandatory request parameter, a parameter contains data which is incorrectly formatted, or the API doesn't have enough information to determine the identity of the customer."
                          },
                          "401": {
                            "description": "There is no authorization information included in the request, the authorization information is incorrect, or the user is not authorized"
                          },
                          "404": {
                            "description": "The campaign ID does not exist."
                          },
                          "500": {
                            "description": "The service has encountered an unexpected situation and is unable to give a better response to the request."
                          }
                        }
                      }
                    },
                    "/v2/people/vap": {
                      "get": {
                        "summary": "Get Very Attacked People",
                        "description": "Fetch the identities and attack index breakdown of Very Attacked People within your organization for a given period.",
                        "operationId": "[[variables('_operationId-getVAP')]",
                        "produces": [
                          "application/json"
                        ],
                        "parameters": [
                          {
                            "name": "window",
                            "in": "query",
                            "type": "integer",
                            "description": "An integer indicating how many days the data should be retrieved for. Accepted values are 14, 30 and 90.",
                            "required": true,
                            "default": 14,
                            "enum": [
                              14,
                              30,
                              90
                            ],
                            "x-ms-summary": "Period"
                          },
                          {
                            "name": "size",
                            "in": "query",
                            "type": "integer",
                            "description": "The maximum number of VAPs to produce in the response. The attackIndex value determine the order of results. Defaults to 1000.",
                            "required": false,
                            "default": 1000,
                            "x-ms-summary": "Maximum response size"
                          },
                          {
                            "name": "page",
                            "in": "query",
                            "type": "integer",
                            "description": "The page of results to return, in multiples of the specified size (or 1000, if no size is explicitly chosen). Defaults to 1.",
                            "required": false,
                            "default": 1,
                            "x-ms-summary": "Page"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "The request was successful. The body of the response contains the requested information in JSON format.",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "users": {
                                  "type": "array",
                                  "x-ms-summary": "Users",
                                  "description": "array of User objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "User",
                                    "description": "User object",
                                    "properties": {
                                      "identity": {
                                        "type": "object",
                                        "description": "User identity object",
                                        "properties": {
                                          "guid": {
                                            "type": "string",
                                            "description": "a unique identifier within Proofpoint's system",
                                            "x-ms-summary": "GUID"
                                          },
                                          "customerUserId": {
                                            "type": "string",
                                            "description": "a identifier associated with the user which was provided by the customer, usually from their directory",
                                            "x-ms-summary": "Customer Id"
                                          },
                                          "emails": {
                                            "type": "array",
                                            "x-ms-summary": "emails array",
                                            "description": "a list of email addresses associated with the user",
                                            "items": {
                                              "type": "string"
                                            }
                                          },
                                          "name": {
                                            "type": "string",
                                            "description": "the name of the user, if known, or null",
                                            "x-ms-summary": "name"
                                          },
                                          "department": {
                                            "type": "string",
                                            "description": "the department of the user, if known, or null",
                                            "x-ms-summary": "department"
                                          },
                                          "location": {
                                            "type": "string",
                                            "description": "the location of the user, if known, or null",
                                            "x-ms-summary": "location"
                                          },
                                          "title": {
                                            "type": "string",
                                            "description": "the name of the user, if known, or null",
                                            "x-ms-summary": "title"
                                          },
                                          "vip": {
                                            "type": "boolean",
                                            "description": "whether the user has been identified as a VIP",
                                            "x-ms-summary": "VIP",
                                            "enum": [
                                              "",
                                              "true",
                                              "false"
                                            ]
                                          }
                                        }
                                      },
                                      "threatStatistics": {
                                        "type": "object",
                                        "description": "User threat statistics object",
                                        "properties": {
                                          "attackIndex": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "the attack index value for this user during the selected interval",
                                            "x-ms-summary": "Attack Index"
                                          },
                                          "families": {
                                            "type": "array",
                                            "x-ms-summary": "Threat families",
                                            "description": "list of threat family objects",
                                            "items": {
                                              "type": "object",
                                              "x-ms-summary": "Threat family",
                                              "description": "Threat family object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "description": "Threat family name",
                                                  "x-ms-summary": "Threat family name"
                                                },
                                                "score": {
                                                  "type": "integer",
                                                  "format": "int32",
                                                  "description": "Threat family score",
                                                  "x-ms-summary": "Threat family score"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "totalVapUsers": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "an integer describing the total number of VAP users for the interval",
                                  "x-ms-summary": "total Vap Users"
                                },
                                "interval": {
                                  "type": "string",
                                  "description": "an ISO8601-formatted interval showing what time the response was calculated for",
                                  "x-ms-summary": "interval"
                                },
                                "averageAttackIndex": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "the average attack index value for users during the interval",
                                  "x-ms-summary": "average Attack Index"
                                },
                                "vapAttackIndexThreshold": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "this interval's attack index threshold, past which a user is considered a VAP",
                                  "x-ms-summary": "VAP Attack Index Threshold"
                                }
                              }
                            }
                          },
                          "400": {
                            "description": "The request is missing a mandatory request parameter or a parameter contains data which is incorrectly formatted."
                          },
                          "401": {
                            "description": "There is no authorization information included in the request, the authorization information is incorrect, or the user is not authorized"
                          },
                          "500": {
                            "description": "The service has encountered an unexpected situation and is unable to give a better response to the request"
                          }
                        }
                      }
                    },
                    "/v2/forensics": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "generated": {
                                  "type": "string",
                                  "description": "ISO8601-formatted datetime corresponding to the time this report was generated"
                                },
                                "reports": {
                                  "type": "array",
                                  "x-ms-summary": "Reports",
                                  "description": "array of Report objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Report",
                                    "description": "Report object",
                                    "properties": {
                                      "scope": {
                                        "type": "string",
                                        "description": "whether the report scope covers a campaign or an individual threat"
                                      },
                                      "id": {
                                        "type": "string",
                                        "description": "the identifier associated with the campaign or individual threat"
                                      },
                                      "type": {
                                        "type": "string",
                                        "description": "the threat type: attachment, url, or hybrid"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "the malicious URL, SHA256 hash of the malicious attachment, or campaign name"
                                      },
                                      "forensics": {
                                        "type": "array",
                                        "x-ms-summary": "Evidences",
                                        "description": "array of Evidence objects",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "type": {
                                              "type": "string",
                                              "description": "the evidence type"
                                            },
                                            "display": {
                                              "type": "string",
                                              "description": "a friendly display string"
                                            },
                                            "engine": {
                                              "type": "string",
                                              "description": "engine"
                                            },
                                            "malicious": {
                                              "type": "boolean",
                                              "description": "whether the evidence was used to reach a malicious verdict"
                                            },
                                            "time": {
                                              "type": "integer",
                                              "format": "int32",
                                              "description": "[[Unsupported] This field is currently unsupported and it's expected to always return 0."
                                            },
                                            "what": {
                                              "type": "object",
                                              "properties": {
                                                "url": {
                                                  "type": "string",
                                                  "description": "url"
                                                },
                                                "action": {
                                                  "type": "string",
                                                  "description": "action"
                                                },
                                                "ip": {
                                                  "type": "string",
                                                  "description": "ip"
                                                },
                                                "port": {
                                                  "type": "integer",
                                                  "format": "int32",
                                                  "description": "port"
                                                },
                                                "type": {
                                                  "type": "string",
                                                  "description": "type"
                                                },
                                                "name": {
                                                  "type": "string",
                                                  "description": "name"
                                                },
                                                "host": {
                                                  "type": "string",
                                                  "description": "host"
                                                },
                                                "ips": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "description": "ips"
                                                },
                                                "cnames": {
                                                  "type": "array",
                                                  "items": {
                                                    "type": "string"
                                                  },
                                                  "description": "cnames"
                                                },
                                                "sha256": {
                                                  "type": "string",
                                                  "description": "sha256"
                                                },
                                                "size": {
                                                  "type": "integer",
                                                  "format": "int32",
                                                  "description": "size"
                                                },
                                                "path": {
                                                  "type": "string",
                                                  "description": "path"
                                                },
                                                "rule": {
                                                  "type": "string",
                                                  "description": "rule"
                                                }
                                              },
                                              "description": "a map of values associated with the specific evidence type"
                                            },
                                            "platforms": {
                                              "type": "array",
                                              "x-ms-summary": "Platforms",
                                              "description": "array of Platform objects",
                                              "items": {
                                                "type": "object",
                                                "x-ms-summary": "Platform",
                                                "description": "Platform object",
                                                "properties": {
                                                  "name": {
                                                    "type": "string",
                                                    "description": "Platform name"
                                                  },
                                                  "os": {
                                                    "type": "string",
                                                    "description": "Platform os"
                                                  },
                                                  "version": {
                                                    "type": "string",
                                                    "description": "Platform version"
                                                  }
                                                }
                                              }
                                            },
                                            "note": {
                                              "type": "string",
                                              "description": "note"
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get Forensics",
                        "description": "Fetch forensic information for a given threat or campaign.",
                        "operationId": "[[variables('_operationId-getForensics')]",
                        "parameters": [
                          {
                            "name": "campaignId",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "description": "An string containing a campaign identifier.  CampaignId or threatId parameter must be supplied with each request. They are mutually exclusive.",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "threatId",
                            "in": "query",
                            "required": false,
                            "type": "string",
                            "description": "An string containing a threat identifier. CampaignId or threatId parameter must be supplied with each request. They are mutually exclusive.",
                            "x-ms-visibility": "important"
                          },
                          {
                            "name": "includeCampaignForensics",
                            "in": "query",
                            "required": false,
                            "type": "boolean",
                            "description": "A boolean value, defaulting to false. May optionally be used with the threatId parameter. It cannot be used with the campaignId parameter.  If false, aggregate forensics for that specific threat identifier will be returned.  If true AND if the threat has been associated with a campaign, aggregate forensics for the entire campaign are returned. Otherwise, aggregate forensics for the individual threat are returned."
                          }
                        ]
                      }
                    },
                    "/v2/people/top-clickers": {
                      "get": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "users": {
                                  "type": "array",
                                  "x-ms-summary": "Users",
                                  "description": "an array of User objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "User",
                                    "description": "User object",
                                    "properties": {
                                      "identity": {
                                        "type": "object",
                                        "description": "User identity object",
                                        "properties": {
                                          "guid": {
                                            "type": "string",
                                            "description": "a unique identifier within Proofpoint's system"
                                          },
                                          "customerUserId": {
                                            "type": "string",
                                            "description": "[[Unsupported] a identifier associated with the user which was provided by the customer, usually from their directory"
                                          },
                                          "emails": {
                                            "type": "array",
                                            "items": {
                                              "type": "string"
                                            },
                                            "description": "a list of email addresses associated with the user"
                                          },
                                          "name": {
                                            "type": "string",
                                            "description": "the name of the user, if known, or null"
                                          },
                                          "department": {
                                            "type": "string",
                                            "description": "the department of the user, if known, or null"
                                          },
                                          "location": {
                                            "type": "string",
                                            "description": "the location of the user, if known, or null"
                                          },
                                          "title": {
                                            "type": "string",
                                            "description": "the name of the user, if known, or null"
                                          },
                                          "vip": {
                                            "type": "boolean",
                                            "description": "whether the user has been identified as a VIP"
                                          }
                                        }
                                      },
                                      "clickStatistics": {
                                        "type": "object",
                                        "description": "User click statistics object",
                                        "properties": {
                                          "clickCount": {
                                            "type": "integer",
                                            "format": "int32",
                                            "description": "total number of clicks from this user in the time internval"
                                          },
                                          "families": {
                                            "type": "array",
                                            "x-ms-summary": "Threat families",
                                            "description": "an array of Threat family objects",
                                            "items": {
                                              "type": "object",
                                              "x-ms-summary": "Threat family",
                                              "description": "Threat family object",
                                              "properties": {
                                                "name": {
                                                  "type": "string",
                                                  "description": "name of the threat family"
                                                },
                                                "clicks": {
                                                  "type": "integer",
                                                  "format": "int32",
                                                  "description": "total number of clicks on threats belong to this threat family"
                                                }
                                              }
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                },
                                "totalTopClickers": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "an integer describing the total number of top clickers in the time interval"
                                },
                                "interval": {
                                  "type": "string",
                                  "description": "an  ISO8601-formatted interval showing what time the response was calculated for"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Get top clickers",
                        "description": "Fetch the identities and attack index of the top clickers within your organization for a given period. Top clickers are the users who have demonstrated a tendency to click on malicious URLs, regardless of whether the clicks were blocked or not. Knowing who are more susceptible to threats is useful for proactive security approaches such as security training assignments.",
                        "operationId": "[[variables('_operationId-getTopClickers')]",
                        "parameters": [
                          {
                            "name": "window",
                            "in": "query",
                            "required": true,
                            "type": "integer",
                            "default": 14,
                            "x-ms-summary": "Period",
                            "description": "An integer indicating how many days the data should be retrieved for. Accepted values are 14, 30 and 90.",
                            "enum": [
                              14,
                              30,
                              90
                            ]
                          },
                          {
                            "name": "page",
                            "in": "query",
                            "required": true,
                            "type": "integer",
                            "default": 1,
                            "x-ms-summary": "Page",
                            "description": "The page of results to return, in multiples of the specified size (or 100, if no size is explicitly chosen). Defaults to 1."
                          },
                          {
                            "name": "size",
                            "in": "query",
                            "required": true,
                            "type": "integer",
                            "default": 100,
                            "x-ms-summary": "Size",
                            "description": "The maximum number of top clickers to produce in the response. The attackIndex value determine the order of results. Defaults to 100 and the max supported value is 200."
                          }
                        ]
                      }
                    },
                    "/v2/url/decode": {
                      "post": {
                        "responses": {
                          "default": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "urls": {
                                  "type": "array",
                                  "x-ms-summary": "Urls",
                                  "description": "array of Url objects",
                                  "items": {
                                    "type": "object",
                                    "x-ms-summary": "Url",
                                    "description": "Url object",
                                    "properties": {
                                      "encodedUrl": {
                                        "type": "string",
                                        "x-ms-summary": "encoded",
                                        "description": "A string, the original, rewritten URL supplied to the endpoint."
                                      },
                                      "decodedUrl": {
                                        "type": "string",
                                        "x-ms-summary": "decoded",
                                        "description": "A string, the target URL embedded inside the rewritten link."
                                      },
                                      "messageGuid": {
                                        "type": "string",
                                        "x-ms-summary": "message GUID",
                                        "description": "A string, the PPS GUID of the message which originally contained the URL."
                                      },
                                      "clusterName": {
                                        "type": "string",
                                        "x-ms-summary": "cluster name",
                                        "description": "A string, the name of the PPS cluster which rewrote the message."
                                      },
                                      "recipientEmail": {
                                        "type": "string",
                                        "x-ms-summary": "recipient email",
                                        "description": "A string, the email address of the messages' original recipient."
                                      },
                                      "success": {
                                        "type": "boolean",
                                        "description": "A boolean, indicates whether the URL could successfully be decoded"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Decode URL",
                        "description": "Decodes one or more URLs. Available fields in results vary, depending on if the request is authenticated.",
                        "operationId": "[[variables('_operationId-decodeURL')]",
                        "parameters": [
                          {
                            "name": "Content-Type",
                            "in": "header",
                            "required": true,
                            "type": "string",
                            "default": "application/json",
                            "x-ms-visibility": "internal"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": true,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "urls": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "urls"
                                }
                              },
                              "x-ms-visibility": "important"
                            },
                            "x-ms-visibility": "important"
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "basic_auth": {
                      "type": "basic"
                    }
                  },
                  "security": [
                    {
                      "basic_auth": "[variables('TemplateEmptyArray')]"
                    }
                  ],
                  "tags": "[variables('TemplateEmptyArray')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "LogicAppsCustomConnector",
        "displayName": "ProofpointTAPConnector",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Get-ProofpointTAPEvents Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Get-ProofpointTAPEvents",
              "type": "String"
            },
            "ProofPointUserName": {
              "defaultValue": "<Enter Username>",
              "type": "String"
            },
            "ProofPointPassword": {
              "defaultValue": "<Enter Password>",
              "type": "secureString"
            },
            "LogAnalyticsDisplayName": {
              "defaultValue": "<LogAnalyticsWorkspaceName>",
              "type": "String"
            }
          },
          "variables": {
            "LogAnalyticsConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azureloganalyticsdatacollector')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('LogAnalyticsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('LogAnalyticsDisplayName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsConnectionName'))]"
              ],
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "ProofPointPasswordPB": {
                      "type": "securestring"
                    },
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "HTTP": {
                      "type": "Http",
                      "inputs": {
                        "authentication": {
                          "password": "@parameters('ProofPointPasswordPB')",
                          "type": "Basic",
                          "username": "[[parameters('ProofPointUserName')]"
                        },
                        "method": "GET",
                        "uri": "https://tap-api-v2.proofpoint.com/v2/siem/clicks/blocked?format=json&sinceSeconds=3600"
                      }
                    },
                    "Parse_JSON": {
                      "runAfter": {
                        "HTTP": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('HTTP')",
                        "schema": {
                          "properties": {
                            "clicksBlocked": {
                              "items": {
                                "properties": {
                                  "campaignId": {
                                    "type": "string"
                                  },
                                  "classification": {
                                    "type": "string"
                                  },
                                  "clickIP": {
                                    "type": "string"
                                  },
                                  "clickTime": {
                                    "type": "string"
                                  },
                                  "messageID": {
                                    "type": "string"
                                  },
                                  "recipient": {
                                    "type": "string"
                                  },
                                  "sender": {
                                    "type": "string"
                                  },
                                  "senderIP": {
                                    "type": "string"
                                  },
                                  "threatID": {
                                    "type": "string"
                                  },
                                  "threatTime": {
                                    "type": "string"
                                  },
                                  "threatURL": {
                                    "type": "string"
                                  },
                                  "url": {
                                    "type": "string"
                                  },
                                  "userAgent": {
                                    "type": "string"
                                  }
                                },
                                "required": [
                                  "campaignId",
                                  "classification",
                                  "clickIP",
                                  "clickTime",
                                  "messageID",
                                  "recipient",
                                  "sender",
                                  "senderIP",
                                  "threatID",
                                  "threatTime",
                                  "threatURL",
                                  "url",
                                  "userAgent"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            },
                            "queryEndTime": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "clicksBlocked": {
                      "foreach": "@body('Parse_JSON')?['clicksBlocked']",
                      "actions": {
                        "Send_Data": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": "@{items('clicksBlocked')}",
                            "headers": {
                              "Log-Type": "ProofPointData"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/api/logs"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_JSON": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  }
                },
                "parameters": {
                  "ProofPointPasswordPB": {
                    "value": "[[parameters('ProofPointPassword')]"
                  },
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azureloganalyticsdatacollector')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "Get-ProofpointTapEvents",
            "description": "This playbook ingests events from ProofPoint TAP to Log Analytics/MicroSoft Sentinel.",
            "prerequisites": [
              "To get Proofpoint TAP API credentials follow the instructions:",
              "1. Log in to your Proofpoint TAP dashboard.",
              "2. Click the *Settings* tab.",
              "3. Click *Connected Applications*.",
              "4. In the *Name* section, select *Create New Credential*.",
              "5. Type the name and click the *Generate* button.",
              "6. In the *Generated Service Credential* pop-up, the *Service Principal* and *Secret* values are shown."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the MicroSoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Repeat steps for Proofpoint TAP connector API Connection. Provide the Service Principal and the secret for authorizing.",
              "**b. Configurations in Sentinel**",
              "1.In MicroSoft Sentinel, analytical rules should be configured to trigger an incident with risky user account.",
              "2.Configure the automation rules to trigger the playbooks."
            ],
            "lastUpdateTime": "2022-08-04T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Get-ProofpointTapEvents",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Get-ProofpointTAPEvents",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointTAP-AddForensicsInfoToIncident Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ProofpointTAP-AddForensicsInfoToIncident",
              "type": "String"
            },
            "customApis_ProofpointTAP_name": {
              "defaultValue": "ProofpointTAP",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ProofpointTAPCustomAPIConnectionName": "[[concat('proofpointtap-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_proofpointtap_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ProofpointTAPCustomAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p><strong></strong><strong>@{outputs('Create_logo')}</strong><strong>ProofpointTAP-AddForensicsInfoToIncident<br>\n</strong><strong>@{body('Create_HTML_table')}</strong><strong></strong></p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_logo": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('forensics')"
                      },
                      "runAfter": {
                        "For_each_campaign_id_in_campaign_ids_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Create_logo": {
                      "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/ProofPointTap/Playbooks/ProofpointTAPConnector/proofpointlogo.png\"  width=\"32\" height=\"32\">",
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    },
                    "For_each_alert_in_incident": {
                      "actions": {
                        "For_each_campaign_id_in_alert_custom_details": {
                          "actions": {
                            "Append_campaign_id_to_campaign_ids_variable": {
                              "inputs": {
                                "name": "compaign_ids",
                                "value": "@items('For_each_campaign_id_in_alert_custom_details')"
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_campaign_ids_from_alert_custom_details')?['campaignId']",
                          "runAfter": {
                            "Get_campaign_ids_from_alert_custom_details": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_campaign_ids_from_alert_custom_details": {
                          "inputs": {
                            "content": "@items('For_each_alert_in_incident')?['properties']?['additionalData']?['Custom Details']",
                            "schema": {
                              "properties": {
                                "campaignId": {
                                  "items": {
                                    "type": "string"
                                  },
                                  "type": "array"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        }
                      },
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_campaign_id_in_campaign_ids_array": {
                      "actions": {
                        "For_each_report": {
                          "actions": {
                            "Filter_malicious_forensics": {
                              "inputs": {
                                "from": "@items('For_each_report')?['forensics']",
                                "where": "@equals(item()?['malicious'], true)"
                              },
                              "type": "Query"
                            },
                            "For_each_malicious_forensic": {
                              "actions": {
                                "Append_to_array_variable": {
                                  "inputs": {
                                    "name": "forensics",
                                    "value": "@item()?['display']"
                                  },
                                  "type": "AppendToArrayVariable"
                                }
                              },
                              "foreach": "@body('Filter_malicious_forensics')",
                              "runAfter": {
                                "Filter_malicious_forensics": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Foreach"
                            }
                          },
                          "foreach": "@body('Get_Forensics')?['reports']",
                          "runAfter": {
                            "Get_Forensics": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_Forensics": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['proofpointtapapi']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/v2/forensics",
                            "queries": {
                              "campaignId": "@{items('For_each_campaign_id_in_campaign_ids_array')}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@variables('compaign_ids')",
                      "runAfter": {
                        "For_each_alert_in_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "forensics",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_compaign_ids": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_compaign_ids": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "compaign_ids",
                            "type": "array"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "proofpointtapapi": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ProofpointTAPCustomAPIConnectionName'))]",
                        "connectionName": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_proofpointtap_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ProofpointTAPConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "ProofpointTAP-AddForensicsInfoToIncident",
            "description": "Once a new sentinel incident is created, this playbook gets triggered and performs the following actions:\n\n1. [Gets Forensics](https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/Forensics_API) by the *campaignId*, provided in the alert custom entities.\n\n2. Enriches the incident with Forensics info.",
            "prerequisites": [
              "1. ProofpointTAP Custom Connector has to be deployed prior to the deployment of this playbook under the same subscription.",
              "2. ProofpointTAP API credentials are required. Refer to ProofpointTAP Custom Connector documentation."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the MicroSoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Repeat steps for Proofpoint TAP connector API Connection. Provide the Service Principal and the secret for authorizing.",
              "**b. Configurations in Sentinel**",
              "1.In MicroSoft Sentinel, analytical rules should be configured to trigger an incident. An incident should have *campaignId* custom entity (obtained from *campaignId_s* field in ProofpointTAP logs). Check the [documentation](https://docs.microsoft.com/azure/sentinel/surface-custom-details-in-alerts) to learn more about adding custom entities to incidents.",
              "2.Configure the automation rules to trigger the playbooks."
            ],
            "lastUpdateTime": "2022-08-04T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "ProofpointTAP-AddForensicsInfoToIncident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "ProofpointTAP-AddForensicsInfoToIncident",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointTAP-CheckAccountInVAP Playbook with template version 3.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "ProofpointTAP-CheckAccountInVAP",
              "type": "String"
            },
            "customApis_ProofpointTAP_name": {
              "defaultValue": "ProofpointTAP",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "ProofpointTAPCustomAPIConnectionName": "[[concat('proofpointtap-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_proofpointtap_name'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('ProofpointTAPCustomAPIConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Condition": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Change_incident_severity_to_high')?['id']",
                              "message": "<p><strong></strong><strong>@{outputs('Create_logo')}</strong><strong>ProofpointTAP CheckAccountInVAP Playbook</strong><br>\nThe following users are in VAP list:<br>\n@{body('Create_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_logo": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Change_incident_severity_to_high": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "severity": "High"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Incidents"
                          },
                          "type": "ApiConnection"
                        },
                        "Create_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('incident_vap_emails')"
                          },
                          "runAfter": {
                            "Change_incident_severity_to_high": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Create_logo": {
                          "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/ProofPointTap/Playbooks/ProofpointTAPConnector/proofpointlogo.png\"  width=\"32\" height=\"32\">",
                          "runAfter": {
                            "Create_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "Compose"
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(variables('incident_vap_emails'))",
                              0
                            ]
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Entities_-_Get_Accounts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/account"
                      },
                      "type": "ApiConnection"
                    },
                    "Filter_array": {
                      "description": "Filter \"emails\" array with emails that are present in \"vap_emails\" array",
                      "inputs": {
                        "from": "@variables('emails')",
                        "where": "@contains(variables('vap_emails'), item())"
                      },
                      "runAfter": {
                        "For_each_user_from_\"Get_Very_Attacked_People\"_action_": [
                          "Succeeded"
                        ]
                      },
                      "type": "Query"
                    },
                    "For_each_account_in_incident": {
                      "actions": {
                        "Append_to_array_variable": {
                          "description": "Parsing email from Account object and adding it to \"emails\" variable.",
                          "inputs": {
                            "name": "emails",
                            "value": "@concat(trim(replace(replace(replace(item()?['Name'], '\"', ''), '[', ''), ']', '')), '@', trim(replace(replace(replace(item()?['UPNSuffix'], '\"', ''), '[', ''), ']', '')))"
                          },
                          "type": "AppendToArrayVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                      "runAfter": {
                        "Initialize_variable_\"emails\"": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_user_from_\"Get_Very_Attacked_People\"_action_": {
                      "actions": {
                        "For_each_user's_email": {
                          "actions": {
                            "Append_user's_email_to_\"vap_emails\"_variable": {
                              "inputs": {
                                "name": "vap_emails",
                                "value": "@items('For_each_user''s_email')"
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@items('For_each_user_from_\"Get_Very_Attacked_People\"_action_')?['identity']?['emails']",
                          "type": "Foreach"
                        }
                      },
                      "foreach": "@body('Get_Very_Attacked_People')?['users']",
                      "runAfter": {
                        "Initialize_variable_\"vap_emails\"": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Get_Very_Attacked_People": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['proofpointtapapi']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v2/people/vap",
                        "queries": {
                          "page": 1,
                          "size": 1000,
                          "window": 14
                        }
                      },
                      "runAfter": {
                        "For_each_account_in_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Initialize_variable": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "incident_vap_emails",
                            "type": "array",
                            "value": "@body('Filter_array')"
                          }
                        ]
                      },
                      "runAfter": {
                        "Filter_array": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_\"emails\"": {
                      "description": "This variable will contain emails from incident.",
                      "inputs": {
                        "variables": [
                          {
                            "name": "emails",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Accounts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_\"vap_emails\"": {
                      "description": "This variable will contain emails from \"Get Very Attacked People\" action",
                      "inputs": {
                        "variables": [
                          {
                            "name": "vap_emails",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Get_Very_Attacked_People": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]"
                      },
                      "proofpointtapapi": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('ProofpointTAPCustomAPIConnectionName'))]",
                        "connectionName": "[[variables('ProofpointTAPCustomAPIConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('customApis_proofpointtap_name'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "ProofPointTap",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_ProofpointTAPConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": " ProofpointTAP-CheckAccountInVAP",
            "description": "Once a new sentinel incident is created, this playbook gets triggered and performs the following actions:\n\n1. Gets [Very Attacked People](https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/People_API#.2Fv2.2Fpeople.2Fvap) for the latest 14 days.\n\n 2. Enriches the incident with information whether incident's users are in VAP list and changes incident severity.",
            "prerequisites": [
              "1. ProofpointTAP Custom Connector has to be deployed prior to the deployment of this playbook under the same subscription.",
              "2. ProofpointTAP API credentials are required. Refer to ProofpointTAP Custom Connector documentation."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the MicroSoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Repeat steps for Proofpoint TAP connector API Connection. Provide the Service Principal and the secret for authorizing.",
              "**b. Configurations in Sentinel**",
              "1.In MicroSoft Sentinel, analytical rules have to be configured to trigger an incident with risky user account. In the *Entity maping* section of the analytics rule creation workflow, user's email has to be mapped to **FullName** identitfier of the **Account** entity type. Check the [documentation](https://docs.microsoft.com/azure/sentinel/map-data-fields-to-entities) to learn more about mapping entities.",
              "2.Configure the automation rules to trigger the playbooks."
            ],
            "lastUpdateTime": "2022-08-04T00:00:00Z",
            "entities": [
              "Account"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "ProofpointTAP-CheckAccountInVAP",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "ProofpointTAP-CheckAccountInVAP",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "ProofPointTap",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>The <a href=\"https://www.proofpoint.com/us/products/advanced-threat-protection/targeted-attack-protection\">Proofpoint TAP</a> solution for Microsoft Sentinel enables you to ingest Proofpoint TAP logs into Microsoft Sentinel.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><p><a href=\"https://docs.microsoft.com/azure/azure-monitor/logs/data-collector-api\">Azure Monitor HTTP Data Collector API</a></p>\n</li>\n<li><p><a href=\"https://docs.microsoft.com/azure/azure-monitor/logs/data-collector-api\">Azure Functions</a></p>\n</li>\n</ol>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 2, <strong>Custom Azure Logic Apps Connectors:</strong> 1, <strong>Playbooks:</strong> 3</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "ProofPointTap",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_ProofpointTAPConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Get-ProofPointTapEvents')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ProofpointTAP-AddForensicsInfoToIncident')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_ProofpointTAP-CheckAccountInVAP')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2022-05-23",
        "providers": [
          "Proofpoint"
        ],
        "categories": {
          "domains": [
            "Security - Automation (SOAR)",
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
