{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Pathlock Inc. - support@pathlock.com",
    "comments": "Solution template for Pathlock_TDnR"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@pathlock.com",
    "_email": "[variables('email')]",
    "_solutionName": "Pathlock_TDnR",
    "_solutionVersion": "3.2.1",
    "solutionId": "securitybridge1647511278080.securitybridge-sentinel-app-1",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "Pathlock_TDnR",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "Pathlock_TDnRConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Pathlock Inc.: Threat Detection and Response for SAP",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "Pathlock_TDnR",
                  "title": "Pathlock Inc.: Threat Detection and Response for SAP",
                  "publisher": "Pathlock Inc.",
                  "logo": "pathlock.svg",
                  "descriptionMarkdown": "The [**Pathlock Threat Detection**](https://pathlock.com/) integration with **Microsoft Sentinel** strengthens SAP security by delivering unified, real-time visibility into threats across all SAP systems. This seamless integration allows Security Operations Centers (SOCs) to correlate SAP-specific alerts with broader enterprise security data, creating a single, comprehensive view of the organization’s risk landscape.\n\nBy leveraging advanced analytics and AI-assisted insights through **Microsoft Security Copilot**, Pathlock identifies complex attack behaviors, configuration weaknesses, and authorization risks within SAP environments. The solution scales effortlessly across on-premise, cloud, and hybrid SAP landscapes, ensuring consistent protection regardless of system architecture.\n\nThrough its deep integration, Pathlock bridges the operational gap between IT and SAP security teams—empowering organizations to detect, investigate, and respond to threats faster, strengthen compliance, and continuously enhance their overall security posture.",
                  "graphQueriesTableName": "ABAPAuditLog",
                  "graphQueries": [
                    {
                      "metricName": "Total events received",
                      "legend": "SAP_SID",
                      "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample Events",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "availability": {
                    "isPreview": true
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft Entra",
                        "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                      },
                      {
                        "name": "Microsoft Azure",
                        "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "1. Create ARM Resources and Provide the Required Permissions",
                      "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Deploy push connector resources",
                            "applicationDisplayName": "Pathlock Inc. Threat Detection and Response for SAP"
                          },
                          "type": "DeployPushConnectorButton_test"
                        }
                      ]
                    },
                    {
                      "title": "2. Maintain the data collection endpoint details and authentication info in Pathlock CAC- Threat Detection and Response",
                      "description": "Share the data collection endpoint URL and authentication info with the Pathlock administrator to configure the CAC to send data to the data collection endpoint.\n",
                      "instructions": [
                        {
                          "parameters": {
                            "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                            "fillWith": [
                              "TenantId"
                            ]
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra Application ID",
                            "fillWith": [
                              "ApplicationId"
                            ],
                            "placeholder": "Deploy push connector to get the Application ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Entra Application Secret",
                            "fillWith": [
                              "ApplicationSecret"
                            ],
                            "placeholder": "Deploy push connector to get the Application Secret"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                            "fillWith": [
                              "DataCollectionEndpoint"
                            ],
                            "placeholder": "Deploy push connector to get the DCE URI"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "DCR Immutable ID",
                            "fillWith": [
                              "DataCollectionRuleId"
                            ],
                            "placeholder": "Deploy push connector to get the DCR ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Sentinel for SAP Stream ID",
                            "value": "SAP_ABAPAUDITLOG"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "label": "Pathlock_TDnR_CL Stream ID",
                            "value": "Custom-Pathlock_TDnR_CL"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Pathlock Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Pathlock Inc.",
                  "email": "support@pathlock.com",
                  "link": "https://pathlock.com/support/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "Pathlock_TDnR-DCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-Pathlock_TDnR_CL": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "BusinessEvent",
                        "type": "string"
                      },
                      {
                        "name": "action",
                        "type": "string"
                      },
                      {
                        "name": "attribute1",
                        "type": "string"
                      },
                      {
                        "name": "attribute2",
                        "type": "string"
                      },
                      {
                        "name": "attribute3",
                        "type": "string"
                      },
                      {
                        "name": "attribute4",
                        "type": "string"
                      },
                      {
                        "name": "attribute5",
                        "type": "string"
                      },
                      {
                        "name": "client",
                        "type": "string"
                      },
                      {
                        "name": "EventdateISO8601",
                        "type": "datetime"
                      },
                      {
                        "name": "Eventdatetimestamp",
                        "type": "string"
                      },
                      {
                        "name": "Eventtime",
                        "type": "string"
                      },
                      {
                        "name": "Eventdate",
                        "type": "string"
                      },
                      {
                        "name": "RecdateISO8601",
                        "type": "datetime"
                      },
                      {
                        "name": "message",
                        "type": "string"
                      },
                      {
                        "name": "Listener",
                        "type": "string"
                      },
                      {
                        "name": "Program",
                        "type": "string"
                      },
                      {
                        "name": "severity",
                        "type": "string"
                      },
                      {
                        "name": "DataSource",
                        "type": "string"
                      },
                      {
                        "name": "RawDatastructure",
                        "type": "string"
                      },
                      {
                        "name": "Agent",
                        "type": "string"
                      },
                      {
                        "name": "triggeringTA",
                        "type": "string"
                      },
                      {
                        "name": "triggeringTerminal",
                        "type": "string"
                      },
                      {
                        "name": "Terminal",
                        "type": "string"
                      },
                      {
                        "name": "User",
                        "type": "string"
                      },
                      {
                        "name": "UserGroup",
                        "type": "string"
                      },
                      {
                        "name": "UserType",
                        "type": "string"
                      },
                      {
                        "name": "User_Full",
                        "type": "string"
                      },
                      {
                        "name": "UPN",
                        "type": "string"
                      },
                      {
                        "name": "IP",
                        "type": "string"
                      },
                      {
                        "name": "FQDN",
                        "type": "string"
                      },
                      {
                        "name": "AppServerName",
                        "type": "string"
                      },
                      {
                        "name": "PGUID",
                        "type": "string"
                      },
                      {
                        "name": "ReferenceUser",
                        "type": "string"
                      },
                      {
                        "name": "StagingLevel",
                        "type": "string"
                      },
                      {
                        "name": "BContact_Mail",
                        "type": "string"
                      },
                      {
                        "name": "BContact_name",
                        "type": "string"
                      },
                      {
                        "name": "PContact_Mail",
                        "type": "string"
                      },
                      {
                        "name": "PContact_name",
                        "type": "string"
                      },
                      {
                        "name": "guid",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "name": "clv2ws1",
                      "workspaceResourceId": "[variables('workspaceResourceId')]"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-ABAPAuditLog"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n",
                    "outputStream": "Microsoft-ABAPAuditLog"
                  },
                  {
                    "streams": [
                      "Custom-Pathlock_TDnR_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n| extend TimeGenerated = now()\n| project\n    TimeGenerated,\n    BusinessEvent,\n    action,\n    attribute1,\n    attribute2,\n    attribute3,\n    attribute4,\n    attribute5,\n    client,\n    EventdateISO8601,\n    Eventdatetimestamp,\n    Eventtime,\n    Eventdate,\n    RecdateISO8601,\n    message,\n    Listener,\n    Program,\n    severity,\n    DataSource,\n    RawDatastructure,\n    Agent,\n    triggeringTA,\n    triggeringTerminal,\n    Terminal,\n    User,\n    UserGroup,\n    UserType,\n    User_Full,\n    UPN,\n    IP,\n    FQDN,\n    AppServerName,\n    PGUID,\n    ReferenceUser,\n    StagingLevel,\n    BContact_Mail,\n    BContact_name,\n    PContact_Mail,\n    PContact_name,\n    guid",
                    "outputStream": "Custom-Pathlock_TDnR_CL"
                  }
                ]
              }
            },
            {
              "name": "Pathlock_TDnR_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "Pathlock_TDnR_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "BusinessEvent",
                      "type": "string"
                    },
                    {
                      "name": "action",
                      "type": "string"
                    },
                    {
                      "name": "attribute1",
                      "type": "string"
                    },
                    {
                      "name": "attribute2",
                      "type": "string"
                    },
                    {
                      "name": "attribute3",
                      "type": "string"
                    },
                    {
                      "name": "attribute4",
                      "type": "string"
                    },
                    {
                      "name": "attribute5",
                      "type": "string"
                    },
                    {
                      "name": "client",
                      "type": "string"
                    },
                    {
                      "name": "EventdateISO8601",
                      "type": "datetime"
                    },
                    {
                      "name": "Eventdatetimestamp",
                      "type": "string"
                    },
                    {
                      "name": "Eventtime",
                      "type": "string"
                    },
                    {
                      "name": "Eventdate",
                      "type": "string"
                    },
                    {
                      "name": "RecdateISO8601",
                      "type": "datetime"
                    },
                    {
                      "name": "message",
                      "type": "string"
                    },
                    {
                      "name": "Listener",
                      "type": "string"
                    },
                    {
                      "name": "Program",
                      "type": "string"
                    },
                    {
                      "name": "severity",
                      "type": "string"
                    },
                    {
                      "name": "DataSource",
                      "type": "string"
                    },
                    {
                      "name": "RawDatastructure",
                      "type": "string"
                    },
                    {
                      "name": "Agent",
                      "type": "string"
                    },
                    {
                      "name": "triggeringTA",
                      "type": "string"
                    },
                    {
                      "name": "triggeringTerminal",
                      "type": "string"
                    },
                    {
                      "name": "Terminal",
                      "type": "string"
                    },
                    {
                      "name": "User",
                      "type": "string"
                    },
                    {
                      "name": "UserGroup",
                      "type": "string"
                    },
                    {
                      "name": "UserType",
                      "type": "string"
                    },
                    {
                      "name": "User_Full",
                      "type": "string"
                    },
                    {
                      "name": "UPN",
                      "type": "string"
                    },
                    {
                      "name": "IP",
                      "type": "string"
                    },
                    {
                      "name": "FQDN",
                      "type": "string"
                    },
                    {
                      "name": "AppServerName",
                      "type": "string"
                    },
                    {
                      "name": "PGUID",
                      "type": "string"
                    },
                    {
                      "name": "ReferenceUser",
                      "type": "string"
                    },
                    {
                      "name": "StagingLevel",
                      "type": "string"
                    },
                    {
                      "name": "BContact_Mail",
                      "type": "string"
                    },
                    {
                      "name": "BContact_name",
                      "type": "string"
                    },
                    {
                      "name": "PContact_Mail",
                      "type": "string"
                    },
                    {
                      "name": "PContact_name",
                      "type": "string"
                    },
                    {
                      "name": "guid",
                      "type": "string"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "Pathlock_TDnR",
          "title": "Pathlock Inc.: Threat Detection and Response for SAP",
          "publisher": "Pathlock Inc.",
          "logo": "pathlock.svg",
          "descriptionMarkdown": "The [**Pathlock Threat Detection**](https://pathlock.com/) integration with **Microsoft Sentinel** strengthens SAP security by delivering unified, real-time visibility into threats across all SAP systems. This seamless integration allows Security Operations Centers (SOCs) to correlate SAP-specific alerts with broader enterprise security data, creating a single, comprehensive view of the organization’s risk landscape.\n\nBy leveraging advanced analytics and AI-assisted insights through **Microsoft Security Copilot**, Pathlock identifies complex attack behaviors, configuration weaknesses, and authorization risks within SAP environments. The solution scales effortlessly across on-premise, cloud, and hybrid SAP landscapes, ensuring consistent protection regardless of system architecture.\n\nThrough its deep integration, Pathlock bridges the operational gap between IT and SAP security teams—empowering organizations to detect, investigate, and respond to threats faster, strengthen compliance, and continuously enhance their overall security posture.",
          "graphQueriesTableName": "ABAPAuditLog",
          "graphQueries": [
            {
              "metricName": "Total events received",
              "legend": "SAP_SID",
              "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample Events",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "availability": {
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft Entra",
                "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
              },
              {
                "name": "Microsoft Azure",
                "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "1. Create ARM Resources and Provide the Required Permissions",
              "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                  }
                },
                {
                  "parameters": {
                    "label": "Deploy push connector resources",
                    "applicationDisplayName": "Pathlock Inc. Threat Detection and Response for SAP"
                  },
                  "type": "DeployPushConnectorButton_test"
                }
              ]
            },
            {
              "title": "2. Maintain the data collection endpoint details and authentication info in Pathlock CAC- Threat Detection and Response",
              "description": "Share the data collection endpoint URL and authentication info with the Pathlock administrator to configure the CAC to send data to the data collection endpoint.\n",
              "instructions": [
                {
                  "parameters": {
                    "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                    "fillWith": [
                      "TenantId"
                    ]
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra Application ID",
                    "fillWith": [
                      "ApplicationId"
                    ],
                    "placeholder": "Deploy push connector to get the Application ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Entra Application Secret",
                    "fillWith": [
                      "ApplicationSecret"
                    ],
                    "placeholder": "Deploy push connector to get the Application Secret"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                    "fillWith": [
                      "DataCollectionEndpoint"
                    ],
                    "placeholder": "Deploy push connector to get the DCE URI"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "DCR Immutable ID",
                    "fillWith": [
                      "DataCollectionRuleId"
                    ],
                    "placeholder": "Deploy push connector to get the DCR ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Sentinel for SAP Stream ID",
                    "value": "SAP_ABAPAUDITLOG"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "label": "Pathlock_TDnR_CL Stream ID",
                    "value": "Custom-Pathlock_TDnR_CL"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Pathlock Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Partner",
          "name": "Pathlock Inc.",
          "email": "support@pathlock.com",
          "link": "https://pathlock.com/support/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Pathlock Inc.: Threat Detection and Response for SAP",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "auth": {
              "type": "object",
              "defaultValue": {
                "appId": "[[parameters('auth').appId]]",
                "servicePrincipalId": "[[parameters('auth').servicePrincipalId]]"
              }
            },
            "connectorDefinitionName": {
              "defaultValue": "Pathlock Inc.: Threat Detection and Response for SAP",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Pathlock Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Pathlock Inc.",
                  "email": "support@pathlock.com",
                  "link": "https://pathlock.com/support/"
                }
              }
            },
            {
              "name": "[[concat([[concat(parameters('workspaceName'), ', '/Pathlock_TDnR_Push')]]', parameters('guidValue'))]]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "Push",
              "properties": {
                "connectorDefinitionName": "Pathlock_TDnR",
                "dcrConfig": {
                  "dataCollectionRuleId": "[[resourceId('Microsoft.Insights/dataCollectionRules', 'Pathlock_TDnR-DCR')]]",
                  "dataCollectionEndpoint": "[[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('workspaceName'))]]",
                  "dataCollectionRuleImmutableId": "[[reference(resourceId('Microsoft.Insights/dataCollectionRules', 'Pathlock_TDnR-DCR'), '2023-03-11').properties.immutableId]]",
                  "streamName": "Custom-Pathlock_TDnR_CL"
                },
                "auth": {
                  "type": "Push",
                  "appId": "[[parameters('auth').appId]",
                  "servicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                },
                "request": {
                  "RetryCount": 1
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.messages"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.2.1",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Pathlock_TDnR",
        "publisherDisplayName": "Pathlock Inc.",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Pathlock_TDnR/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://pathlock.com/\"><strong>Pathlock App</strong></a> solution enables organizations to seamlessly ingest <strong>Pathlock Threat Detection</strong> events from both on-premise and cloud-based SAP systems into <strong>Microsoft Sentinel</strong>.</p>\n<p>This integration leverages the <strong>Custom Logs via Azure Monitor Agent (AMA)</strong> connector to collect and forward log data securely. The Custom Logs solution will be automatically deployed as part of this installation process.</p>\n<blockquote>\n<p><strong>Note:</strong> Microsoft recommends using <strong>Custom Logs via the AMA connector</strong>. The legacy <strong>Log Analytics (MMA)</strong> agent was deprecated on <strong>August 31, 2024</strong>. Running both MMA and AMA on the same host can lead to log duplication and increased ingestion costs. <a href=\"https://learn.microsoft.com/azure/sentinel/ama-migrate?WT.mc_id=Portal-fx\">Learn more</a>.</p>\n</blockquote>\n<p><strong>Data Connectors:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/pathlock.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Pathlock_TDnR",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Pathlock Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Pathlock Inc.",
          "email": "support@pathlock.com",
          "tier": "Partner",
          "link": "https://pathlock.com/support/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2022-02-17",
        "providers": [
          "Pathlock_TDnR"
        ],
        "categories": {
          "domains": [
            "Security - Network"
          ],
          "verticals": [
            "Finance"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
