id: 12509d03-0206-4b85-84b9-6d2349afa42b
name: SAP - User Creates and uses new user
description: |
    Identifies a user creating and using other users.

    Source Action: Create a user using SU01. Login using the newly created user from the same IP.

    *Data Sources: SAPcon -  Audit Log*
severity: High
requiredDataConnectors:
-   connectorId: SAP
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Discovery
- InitialAccess
relevantTechniques: ''
query: |
    // Define Variables
    let MinutesThreshold = 15; // Difference by minutes between Create and Connect
    let AuditUserCreated = dynamic(['AU7']); // Message of create user
    let AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user
    // Query Logic
    let UserCreated = // Get users created
    SAPAuditLog
    | where MessageID in (AuditUserCreated)
    | project-rename UserCreationTimeGenerated = TimeGenerated, UserCreated = Variable1;
    SAPAuditLog // Get users connections
    | where MessageID in (AuditLogIn)
    | lookup kind=inner UserCreated on TerminalIPv6,$left.User == $right.UserCreated, SystemID, ClientID // Lookup of user created to user log in
    | where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated)) <= MinutesThreshold // Connect after creation
    | summarize by TimeGenerated, Instance ,SystemID, ClientID, UserActing = User1, UserActingEmail= Email1, UserCreated = User, UserCreatedEmail= Email, TerminalIPv6, Host
alertDetailsOverride: null
customDetails:
    SAP_User: UserActing
    SAP_UserCreated: UserCreated
entityMappings:
-   entityType: Account
    fieldMappings:
    -   identifier: FullName
        columnName: UserActingEmail
-   entityType: IP
    fieldMappings:
    -   identifier: Address
        columnName: TerminalIPv6
-   entityType: Host
    fieldMappings:
    -   identifier: FullName
        columnName: Host
-   entityType: CloudApplication
    fieldMappings:
    -   identifier: Name
        columnName: SystemID
    -   identifier: AppId
        columnName: ClientID
    -   identifier: InstanceName
        columnName: Instance
-   entityType: Account
    fieldMappings:
    -   identifier: FullName
        columnName: UserCreatedEmail
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
