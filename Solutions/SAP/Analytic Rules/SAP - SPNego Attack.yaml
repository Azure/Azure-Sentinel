id: d83d4699-7bd5-44f1-826a-3bd3501712a9
name: SAP - SPNego Attack
description: |
    Identifies SPNego Replay Attack.

    *Data Sources: SAPcon -  Audit Log*
severity: High
requiredDataConnectors:
-   connectorId: SAP
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Impact
- LateralMovement
relevantTechniques: ''
query: |
    // Define variables
    let AuditClasses = dynamic(['BUI']); // Message of SPNego
    // Query logic
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | project TimeGenerated, Instance , SystemID, ClientID, User ,  Email, TerminalIPv6, Host
alertDetailsOverride: null
customDetails:
    SAP_User: User
entityMappings:
-   entityType: Account
    fieldMappings:
    -   identifier: FullName
        columnName: Email
-   entityType: IP
    fieldMappings:
    -   identifier: Address
        columnName: TerminalIPv6
-   entityType: Host
    fieldMappings:
    -   identifier: FullName
        columnName: Host
-   entityType: CloudApplication
    fieldMappings:
    -   identifier: Name
        columnName: SystemID
    -   identifier: AppId
        columnName: ClientID
    -   identifier: InstanceName
        columnName: Instance
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
