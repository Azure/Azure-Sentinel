id: 7c2d366a-1cb8-41f3-9b0b-a5c469ad467e
name: SAP - (Preview) Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014]
description: 'SAP NetWeaver ABAP Server and ABAP Platform creates information about
    system identity in an ambiguous format. <br/> This may be exploited by malicious
    users to obtain illegitimate access to the system. <br/> Read SAP note 3281854
    - FAQ for Security Note 3089413 for more details. This alert rule helps to identify
    current risks for systems in the landscape.

    '
severity: High
requiredDataConnectors:
-   connectorId: SAP
    dataTypes:
    - SAPSystems
queryFrequency: 1d
queryPeriod: 7d
triggerOperator: gt
triggerThreshold: 0
tactics:
- CredentialAccess
relevantTechniques: ''
query: |
    //  a per SAP note https://launchpad.support.sap.com/#/notes/3089413
    // Systems without this parameter, or with values != "no" are vulnerable
    // both (default) - old method allowed as client and server
    // client - old method allowed as client
    // server - old method allowed as server
    // no - old method not allowed
    // CONFIGURATION OPTION- determine which system roles are relevant for this alert
    let TimeAgo= 7d;
    let SelectedSystemRoles =  dynamic(["All System Roles"]); //can also do// let SelectedSystemRoles =  dynamic(["Production", "UAT"]);
    let SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole, SystemUsage
    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown' );
    let Vulnerability= 'SAP - [CVE-2023-0014] Capture-replay vulnerability in a ';
    let Remediation= ' SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format. <br/> This may be exploited by malicious users to obtain illegitimate access to the system. <br/> Read SAP note 3281854 - FAQ for Security Note 3089413 for more details.';
    let SafeValues= dynamic(['no']);
    let MitigatedValues= dynamic(['client']);
    let ConfiguredSystems= SAP_PAHI
    | where TimeGenerated > ago(TimeAgo)
    | where PARNAME == 'rfc/allowoldticket4tt'
    | where PARSTATE == "A"
    | summarize arg_max(PARDATE, PARVALUE, TimeGenerated, SYSTEMID) by SystemID, Host= HOSTNAME, SYSTEMID
    | project-rename SystemNumber= SYSTEMID
    | extend LastChanged= todatetime(PARDATE);
    // ConfiguredSystems
    let PotentialSystems= SAPAuditLog
    | where TimeGenerated > ago(TimeAgo)
    | project SystemID, Host, SystemNumber
    | summarize by SystemID, Host, SystemNumber
    | join kind= inner SelectedSystems on SystemID;
    PotentialSystems | join kind= inner ConfiguredSystems on SystemID, Host, SystemNumber
    | summarize SystemRole=any(SystemRole), Hosts= makeset(Host), SystemNumbers= makeset(SystemNumber) by SystemID, PARVALUE
    | extend BagODetails= case(
    (PARVALUE in (MitigatedValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system- mitigated' ),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'Medium' ),
    (PARVALUE in (SafeValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' - system resolved' ),'AlertDescription', Remediation, 'IsVulnerable', false, 'Severity', 'Iformational' ),
    //  else:
    bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system'),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'High' ))
    | evaluate bag_unpack(BagODetails)
    | project Hosts, SystemNumbers, PARVALUE, AlertName= columnifexists('AlertName', Vulnerability), AlertDescription= columnifexists('AlertDescription', Remediation), SystemID, Severity= columnifexists('Severity', '')
    | extend ExtendedLink= 'https://www.cve.org/CVERecord?id=CVE-2023-0014', Dummy= ''
alertDetailsOverride:
    alertDisplayNameFormat: '{{AlertName}}'
    alertDescriptionFormat: '{{AlertDescription}}

        '
    alertTacticsColumnName: Dummy
    alertSeverityColumnName: Dummy
customDetails: null
entityMappings:
-   entityType: CloudApplication
    fieldMappings:
    -   identifier: Name
        columnName: SystemID
eventGroupingSettings:
    aggregationKind: AlertPerResult
kind: Scheduled
version: 2.0.49
