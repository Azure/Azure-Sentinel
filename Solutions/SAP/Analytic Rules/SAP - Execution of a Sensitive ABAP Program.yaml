id: e0e53cb9-d3f4-47c3-b953-ad62a8414f4f
name: SAP - Execution of a Sensitive ABAP Program
description: |
    Identifies direct execution of a sensitive ABAP program.

    Source Action: Execute a program directly using SE38/SA38/SE80.

    **Recommended for Production only**

    ABAP Programs should be maintained in watchlist "SAP - Sensitive ABAP Programs"

    *Data Sources: SAPcon -  Audit Log*
severity: High
requiredDataConnectors:
-   connectorId: SAP
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Exfiltration
- LateralMovement
- Execution
relevantTechniques: ''
query: |
    // Define Variables
    let Role = "Production";
    let AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started
    let allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles
    let allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages
    // Get Relevant Systems from WatchList
    let systemID = _GetWatchlist('SAP - Systems');
    let fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)
    // Maintain these if WatchList is not available
        ["S4H","Production","ERP",
        "XXX","Sandbox","BW"]
    ;
    // Get Relevant ABAP Programs
    let SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');
    let fixedABAPReports = datatable(ABAPProgram:string)
    // Maintain these if WatchList is not available
        ["RSPFLDOC"]
    ;
    let UnionAbap =
        union SensitiveABAPReports, fixedABAPReports
        | summarize by ABAPProgram;
    let UnitedSystem =
    union systemID, fixedSID
    | summarize by SystemID, SystemRole, SystemUsage
    | where SystemRole == Role; // Reccommended is Production only
    //| where SystemRole in (allSystemRoles); // Use this for all system roles
    // Query logic
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | where ABAPProgramName in (UnionAbap)
    | project-rename SystemIDTemp = SystemID
    | project-rename SystemID= SystemIDTemp
    | project-rename SystemID= SystemID
    | lookup kind = inner (UnitedSystem) on SystemID
    | order by TimeGenerated asc
    | project TimeGenerated, Instance , SystemID, ClientID, User, ABAPProgramName, MessageText, TransactionCode, MessageID, Email, TerminalIPv6, Host
alertDetailsOverride: null
customDetails:
    SAP_User: User
entityMappings:
-   entityType: Account
    fieldMappings:
    -   identifier: FullName
        columnName: Email
-   entityType: IP
    fieldMappings:
    -   identifier: Address
        columnName: TerminalIPv6
-   entityType: Host
    fieldMappings:
    -   identifier: FullName
        columnName: Host
-   entityType: CloudApplication
    fieldMappings:
    -   identifier: Name
        columnName: SystemID
    -   identifier: AppId
        columnName: ClientID
    -   identifier: InstanceName
        columnName: Instance
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
