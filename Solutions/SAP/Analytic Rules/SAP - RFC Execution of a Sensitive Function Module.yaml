id: 8e8a95c5-7f78-435e-9e6a-7e29c0b831c1
name: SAP - RFC Execution of a Sensitive Function Module
description: |
    Identifies execution of a sensitive function module using RFC.

    Source Action: Execute a function module using RFC.

    **Recommended for Production only**

    Function Modules should be maintained in watchlist "SAP - Sensitive Function Modules"

    *Data Sources: SAPcon -  Audit Log*
severity: High
requiredDataConnectors:
-   connectorId: SAP
queryFrequency: 2h
queryPeriod: 2h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Discovery
- Exfiltration
- LateralMovement
relevantTechniques: ''
query: |
    let Role = "Production";
    let AuditClasses = dynamic(['AUK']); // Audit Log Classes - Successful RFC call &C (function group = &A)
    let allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles
    let allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages
    // Get Relevant Systems from WatchList
    let systemID = _GetWatchlist('SAP - Systems');
    let fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)
        // Maintain these if WatchList is not available
        ["S4H", "Production", "ERP",
        "XXX", "Sandbox", "BW"]
    ;
    // Get Relevant Function Modules
    let SensitiveFM = _GetWatchlist('SAP - Sensitive Function Modules');
    let fixedFM = datatable(FunctionModule: string)
        // Maintain these if WatchList is not available
        ["RSAU_CLEAR_AUDIT_LOG"]
    ;
    let UnitedSystems = union systemID, fixedSID
    | where SystemRole == Role // Recommended  is Production only
    | summarize by SystemID;
    //| where SystemRole in (allSystemRoles); // Use this for all system roles
    let UnitedSensitive =  union SensitiveFM, fixedFM
    | summarize by FunctionModule;
    SAPAuditLog
    | where MessageID in (AuditClasses)
    | project-rename FunctionModule = Variable3, FunctionGroup = Variable1
    | where SystemID in (UnitedSystems) // The systemID is in this list
    | where FunctionModule in (UnitedSensitive) // Function module is sensitive
    | order by TimeGenerated asc
    | project TimeGenerated,Instance ,User, SystemID, ClientID, MessageText, FunctionGroup, FunctionModule, MessageID, Email, TerminalIPv6, Host
alertDetailsOverride: null
customDetails:
    SAP_User: User
entityMappings:
-   entityType: Account
    fieldMappings:
    -   identifier: FullName
        columnName: Email
-   entityType: IP
    fieldMappings:
    -   identifier: Address
        columnName: TerminalIPv6
-   entityType: Host
    fieldMappings:
    -   identifier: FullName
        columnName: Host
-   entityType: CloudApplication
    fieldMappings:
    -   identifier: Name
        columnName: SystemID
    -   identifier: AppId
        columnName: ClientID
    -   identifier: InstanceName
        columnName: Instance
eventGroupingSettings:
    aggregationKind: SingleAlert
kind: Scheduled
version: 2.0.19
