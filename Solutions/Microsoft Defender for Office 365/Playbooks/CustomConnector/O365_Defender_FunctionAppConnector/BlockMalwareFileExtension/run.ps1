using namespace System.Net

# Input bindings are passed in via param block.
param($Request, $TriggerMetadata)
$flag = 0
# Write to the Azure Functions log stream.
Write-Host "Request initiated for blocking the malware files"

# Interact with query parameters or the body of the request.
$MalwarePolicyName = $Request.Body.MalwarePolicyName
$FileExtensions = $Request.Body.FileExtensions

try{
if($MalwarePolicyName -AND $FileExtensions)
{
    $FileTypesAdd = Get-MalwareFilterPolicy -Identity "$MalwarePolicyName" | Select-Object -Expand FileTypes
    $FileTypesAdd += $FileExtensions
    $Result = Set-MalwareFilterPolicy -Identity "$MalwarePolicyName" -EnableFileFilter $true -FileTypes $FileTypesAdd
    if($?){Write-Host "Successfully added list of extensions"
    $flag = 1
    }
    else
    {
        Write-Host "Failed to add list of extension"
    }
}else{
    Write-Host "Missing parameters (MalwarePolicyName , FileExtensions )"
}
}

catch{
    Write-Host "$_.Exception"
    $Result = "$_.Exception"
}

finally{
if($flag){
    # Associate values to output bindings by calling 'Push-OutputBinding'.
    Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
        StatusCode = [HttpStatusCode]::OK
        Body = $Result
    })}else{
    
        Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
            StatusCode = [HttpStatusCode]::NotFound
            Body = $Result
        })
    }
}


