[
  {
    "name": "dcr-tacitred-findings",
    "apiVersion": "2024-03-11",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
      "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
      "streamDeclarations": {
        "Custom-TacitRed_Findings_Raw": {
          "columns": [
            { "name": "finding", "type": "dynamic" },
            { "name": "severity", "type": "string" }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [ "Custom-TacitRed_Findings_Raw" ],
          "destinations": [ "clv2ws1" ],
          "transformKql": "source | extend f = todynamic(finding) | extend TimeGenerated = todatetime(f['time']), email_s = tostring(iif(isnotempty(f['email']), f['email'], f['supporting_data']['credential']['email'])), domain_s = tostring(f['supporting_data']['credential']['domain']), findingType_s = tostring(f['type']), confidence_d = toint(f['confidence']), firstSeen_t = todatetime(f['first_seen']), lastSeen_t = todatetime(f['last_seen']), notes_s = tostring(f['notes']), source_s = tostring(f['source']), severity_s = tostring(f['severity']), status_s = tostring(f['status']), campaign_id_s = tostring(iif(isnotempty(f['campaign_id']), f['campaign_id'], f['campaign']['id'])), user_id_s = tostring(iif(isnotempty(f['user_id']), f['user_id'], f['user']['id'])), username_s = tostring(iif(isnotempty(f['username']), f['username'], f['user']['username'])), detection_ts_t = todatetime(f['detection_ts']), metadata_s = tostring(f) | project TimeGenerated, email_s, domain_s, findingType_s, confidence_d, firstSeen_t, lastSeen_t, notes_s, source_s, severity_s, status_s, campaign_id_s, user_id_s, username_s, detection_ts_t, metadata_s",
          "outputStream": "Custom-TacitRed_Findings_CL"
        }
      ]
    }
  }
]
