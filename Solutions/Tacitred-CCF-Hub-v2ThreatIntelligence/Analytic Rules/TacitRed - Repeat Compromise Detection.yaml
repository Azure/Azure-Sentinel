id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
name: TacitRed - Repeat Compromise Detection
version: 1.0.0
kind: Scheduled
description: |-
  Detects users who have been compromised multiple times within a 7-day window.
  Multiple compromises of the same user indicate persistent targeting or ongoing credential theft.
  
  Ref: https://tacitred.com/
severity: High
requiredDataConnectors:
  - connectorId: TacitRedThreatIntel
    dataTypes:
      - TacitRed_Findings_CL
queryFrequency: 1h
queryPeriod: 7d
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - CredentialAccess
  - InitialAccess
relevantTechniques:
  - T1078
  - T1110
query: |-
  let lookbackPeriod = 7d;
  let threshold = 2;
  TacitRed_Findings_CL
  | where TimeGenerated >= ago(lookbackPeriod)
  | extend
      Email = tostring(email_s),
      Username = tostring(username_s),
      Domain = tostring(domain_s),
      FindingType = tostring(findingType_s),
      Confidence = todouble(confidence_d),
      FirstSeen = todatetime(firstSeen_t),
      LastSeen = todatetime(lastSeen_t)
  | summarize 
      CompromiseCount = count(),
      FindingTypes = make_set(FindingType),
      FirstCompromise = min(FirstSeen),
      LatestCompromise = max(LastSeen),
      AverageConfidence = avg(Confidence),
      Domains = make_set(Domain)
      by Email, Username
  | where CompromiseCount >= threshold
  | extend
      Severity = case(
          CompromiseCount >= 5, "Critical",
          CompromiseCount >= 3, "High",
          "Medium"
      )
  | project
      Email,
      Username,
      CompromiseCount,
      Severity,
      FirstCompromise,
      LatestCompromise,
      AverageConfidence,
      FindingTypes,
      Domains
suppressionEnabled: false
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: 5h
    matchingMethod: Selected
    groupByEntities:
      - Account
suppressionDuration: 5h
eventGroupingSettings:
  aggregationKind: SingleAlert
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Username
      - identifier: UPNSuffix
        columnName: Email
