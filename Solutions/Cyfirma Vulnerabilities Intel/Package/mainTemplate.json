{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft",
    "comments": "Solution template for Cyfirma Vulnerabilities Intel"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "_solutionName": "Cyfirma Vulnerabilities Intel",
    "_solutionVersion": "3.0.2",
    "solutionId": "cyfirmaholdingspteltd1742879329545.azure-sentinel-solution-cyfirma-vulnerabilities",
    "_solutionId": "[variables('solutionId')]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.1",
      "_analyticRulecontentId1": "123fad02-6d9e-439e-8241-7a2fffa7e0a5",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '123fad02-6d9e-439e-8241-7a2fffa7e0a5')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('123fad02-6d9e-439e-8241-7a2fffa7e0a5')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','123fad02-6d9e-439e-8241-7a2fffa7e0a5','-', '1.0.1')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.1",
      "_analyticRulecontentId2": "6306f2d9-34a3-409a-850d-175b7bdd1ab1",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6306f2d9-34a3-409a-850d-175b7bdd1ab1')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6306f2d9-34a3-409a-850d-175b7bdd1ab1')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6306f2d9-34a3-409a-850d-175b7bdd1ab1','-', '1.0.1')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.1",
      "_analyticRulecontentId3": "4c1b282b-62f1-4783-bf40-94c44f0ae630",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4c1b282b-62f1-4783-bf40-94c44f0ae630')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4c1b282b-62f1-4783-bf40-94c44f0ae630')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4c1b282b-62f1-4783-bf40-94c44f0ae630','-', '1.0.1')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.1",
      "_analyticRulecontentId4": "6cc62c46-dd44-46d7-8681-8422f780eabd",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6cc62c46-dd44-46d7-8681-8422f780eabd')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6cc62c46-dd44-46d7-8681-8422f780eabd')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6cc62c46-dd44-46d7-8681-8422f780eabd','-', '1.0.1')))]"
    },
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "CyfirmaVulnerabilitiesIntelDC",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "CyfirmaVulnerabilitiesIntelDCConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AssetVulnerabilitiesHighSeverityRule_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule detects high severity asset-based vulnerabilities from CYFIRMA's vulnerability intelligence data. \nIt identifies vulnerabilities with a confidence score of 80 or higher, excluding those categorized as 'ATTACK_SURFACE_VULNERABILITY', and generates alerts for assets that may be at risk.",
                "displayName": "CYFIRMA - High Severity Asset based Vulnerabilities Rule Alert",
                "enabled": false,
                "query": "// High severity - Asset based Vulnerabilities\nlet timeFrame = 5m;\nCyfirmaVulnerabilities_CL\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    attack_complexity         = tostring(props.attack_complexity),\n    cvss_score                = toreal(props.cvss_score),\n    integrity_impact          = tostring(props.integrity_impact),\n    impact_score              = tostring(props.impact_score),\n    attack_vector             = tostring(props.attack_vector),\n    privileges_required       = tostring(props.privileges_required),\n    cvss_version              = tostring(props.cvss_version),\n    user_interaction          = tostring(props.user_interaction),\n    cvss_vector               = tostring(props.cvss_vector),\n    scope                     = tostring(props.scope),\n    confidentiality_impact    = tostring(props.confidentiality_impact),\n    exploitability_score      = toreal(props.exploitability_score),\n    products                  = tostring(props.products),\n    technologies              = tostring(props.technologies),\n    vendors                   = tostring(props.vendors),\n    confidence_score          = toint(confidence),\n    servers                   = tostring(props.servers),\n    vulnerability_type        = tostring(props.vulnerability_type),\n    vulnerability_category        = tostring(props.vulnerability_category),\n    NetworkIPs                = tostring(props.ips),\n    ProviderName              ='CYFIRMA',\n    ProductName               ='DeCYFIR/DeTCT'\n| summarize arg_max(\n                integrity_impact,\n                TimeGenerated, \n                id,\n                description,\n                confidence_score,\n                created,\n                modified,\n                attack_complexity,\n                cvss_score,\n                impact_score,\n                attack_vector,\n                privileges_required,\n                cvss_version,\n                user_interaction,\n                cvss_vector,\n                scope,\n                confidentiality_impact,\n                exploitability_score,\n                products,\n                technologies,\n                vendors,\n                ProviderName,\n                ProductName,\n                servers,\n                NetworkIPs,\n                vulnerability_type,\n                vulnerability_category\n            )\n    by name\n| where confidence_score >= 80 and vulnerability_category != 'ATTACK_SURFACE_VULNERABILITY' and TimeGenerated between (ago(timeFrame) .. now())\n| project \n    TimeGenerated,\n    name,\n    confidence_score,\n    integrity_impact,\n    attack_complexity,\n    cvss_score,\n    impact_score,\n    attack_vector,\n    UID = id,\n    description,\n    created,\n    modified,\n    privileges_required,\n    cvss_version,\n    user_interaction,\n    cvss_vector,\n    scope,\n    confidentiality_impact,\n    exploitability_score,\n    products,\n    technologies,\n    vendors,\n    ProviderName,\n    ProductName,\n    servers,\n    NetworkIPs,\n    vulnerability_type,\n    vulnerability_category\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "CyfirmaVulnerabilitiesIntelDC",
                    "dataTypes": [
                      "CyfirmaVulnerabilities_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "LateralMovement",
                  "PrivilegeEscalation",
                  "InitialAccess",
                  "CredentialAccess",
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1548.002",
                  "T1021.002"
                ],
                "techniques": [
                  "T1059",
                  "T1203",
                  "T1210",
                  "T1068",
                  "T1190",
                  "T1133",
                  "T1003",
                  "T1553",
                  "T1548",
                  "T1021"
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "CVE": "name",
                  "IntegrityImpact": "integrity_impact",
                  "UserInteraction": "user_interaction",
                  "PrivilegesRequired": "privileges_required",
                  "Products": "products",
                  "ConfidenceScore": "confidence_score",
                  "ExploitabilityScore": "exploitability_score",
                  "Modified": "modified",
                  "Vendors": "vendors",
                  "CVSSVersion": "cvss_version",
                  "Technologies": "technologies",
                  "ConfidentialImpact": "confidentiality_impact",
                  "TimeGenerated": "TimeGenerated",
                  "CVSSScore": "cvss_score",
                  "AttackComplexity": "attack_complexity",
                  "scope": "scope",
                  "CVSSVector": "cvss_vector",
                  "ImpactScore": "impact_score",
                  "AttackVector": "attack_vector"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{description}} ",
                  "alertDynamicProperties": [
                    {
                      "value": "ProductName",
                      "alertProperty": "ProductName"
                    },
                    {
                      "value": "ProviderName",
                      "alertProperty": "ProviderName"
                    }
                  ],
                  "alertDisplayNameFormat": "CYFIRMA - High Severity Asset based Vulnerability Identified - {{name}} "
                },
                "incidentConfiguration": {
                  "createIncident": true,
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "matchingMethod": "AllEntities",
                    "enabled": false
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Cyfirma Vulnerabilities Intel Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Cyfirma Vulnerabilities Intel",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "CYFIRMA - High Severity Asset based Vulnerabilities Rule Alert",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AssetVulnerabilitiesMediumSeverityRule_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule detects medium severity asset-based vulnerabilities from CYFIRMA's vulnerability intelligence data. \nIt identifies vulnerabilities with a confidence score of 50 or higher, excluding those categorized as 'ATTACK_SURFACE_VULNERABILITY', and generates alerts for assets that may be at risk.",
                "displayName": "CYFIRMA - Medium Severity Asset based Vulnerabilities Rule Alert",
                "enabled": false,
                "query": "// Medium severity - Asset based Vulnerabilities\nlet timeFrame= 5m;\nCyfirmaVulnerabilities_CL\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    attack_complexity         = tostring(props.attack_complexity),\n    cvss_score                = toreal(props.cvss_score),\n    integrity_impact          = tostring(props.integrity_impact),\n    impact_score              = tostring(props.impact_score),\n    attack_vector             = tostring(props.attack_vector),\n    privileges_required       = tostring(props.privileges_required),\n    cvss_version              = tostring(props.cvss_version),\n    user_interaction          = tostring(props.user_interaction),\n    cvss_vector               = tostring(props.cvss_vector),\n    scope                     = tostring(props.scope),\n    confidentiality_impact    = tostring(props.confidentiality_impact),\n    exploitability_score      = toreal(props.exploitability_score),\n    products                  = tostring(props.products),\n    technologies              = tostring(props.technologies),\n    vendors                   = tostring(props.vendors),\n    confidence_score          = toint(confidence),\n    servers                   = tostring(props.servers),\n    vulnerability_type        = tostring(props.vulnerability_type),\n    vulnerability_category        = tostring(props.vulnerability_category),\n    NetworkIPs                = tostring(props.ips),\n    ProviderName              ='CYFIRMA',\n    ProductName               ='DeCYFIR/DeTCT'\n| summarize arg_max(\n                integrity_impact,\n                TimeGenerated, \n                id,\n                description,\n                confidence_score,\n                created,\n                modified,\n                attack_complexity,\n                cvss_score,\n                impact_score,\n                attack_vector,\n                privileges_required,\n                cvss_version,\n                user_interaction,\n                cvss_vector,\n                scope,\n                confidentiality_impact,\n                exploitability_score,\n                products,\n                technologies,\n                vendors,\n                ProviderName,\n                ProductName,\n                servers,\n                NetworkIPs,\n                vulnerability_type,\n                vulnerability_category\n            )\n    by name\n| where  confidence_score >= 60 and vulnerability_category != 'ATTACK_SURFACE_VULNERABILITY' and TimeGenerated between (ago(timeFrame) .. now())\n| project \n    TimeGenerated,\n    name,\n    confidence_score,\n    integrity_impact,\n    attack_complexity,\n    cvss_score,\n    impact_score,\n    attack_vector,\n    UID = id,\n    description,\n    created,\n    modified,\n    privileges_required,\n    cvss_version,\n    user_interaction,\n    cvss_vector,\n    scope,\n    confidentiality_impact,\n    exploitability_score,\n    products,\n    technologies,\n    vendors,\n    ProviderName,\n    ProductName,\n    servers,\n    NetworkIPs,\n    vulnerability_type,\n    vulnerability_category\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "CyfirmaVulnerabilitiesIntelDC",
                    "dataTypes": [
                      "CyfirmaVulnerabilities_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "LateralMovement",
                  "PrivilegeEscalation",
                  "InitialAccess",
                  "CredentialAccess",
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1548.002",
                  "T1021.002"
                ],
                "techniques": [
                  "T1059",
                  "T1203",
                  "T1210",
                  "T1068",
                  "T1190",
                  "T1133",
                  "T1003",
                  "T1553",
                  "T1548",
                  "T1021"
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "CVE": "name",
                  "IntegrityImpact": "integrity_impact",
                  "UserInteraction": "user_interaction",
                  "PrivilegesRequired": "privileges_required",
                  "Products": "products",
                  "ConfidenceScore": "confidence_score",
                  "ExploitabilityScore": "exploitability_score",
                  "Modified": "modified",
                  "Vendors": "vendors",
                  "CVSSVersion": "cvss_version",
                  "Technologies": "technologies",
                  "ConfidentialImpact": "confidentiality_impact",
                  "TimeGenerated": "TimeGenerated",
                  "CVSSScore": "cvss_score",
                  "AttackComplexity": "attack_complexity",
                  "scope": "scope",
                  "CVSSVector": "cvss_vector",
                  "ImpactScore": "impact_score",
                  "AttackVector": "attack_vector"
                },
                "incidentConfiguration": {
                  "createIncident": true,
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "matchingMethod": "AllEntities",
                    "enabled": false
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Cyfirma Vulnerabilities Intel Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Cyfirma Vulnerabilities Intel",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "CYFIRMA - Medium Severity Asset based Vulnerabilities Rule Alert",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AttackSurfaceVulnerabilitiesMediumSeverityRule_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule detects medium severity attack surface-based vulnerabilities from CYFIRMA's vulnerability intelligence data. It identifies vulnerabilities with a confidence score of 50 or higher, excluding those categorized as 'ASSET_VULNERABILITY', and generates alerts for assets that may be at risk.",
                "displayName": "CYFIRMA - Medium Severity Attack Surface based Vulnerabilities Rule",
                "enabled": false,
                "query": "// Medium severity - Attack Surface based Vulnerabilities\nlet timeFrame= 5m;\nCyfirmaVulnerabilities_CL\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    attack_complexity         = tostring(props.attack_complexity),\n    cvss_score                = toreal(props.cvss_score),\n    integrity_impact          = tostring(props.integrity_impact),\n    impact_score              = tostring(props.impact_score),\n    attack_vector             = tostring(props.attack_vector),\n    privileges_required       = tostring(props.privileges_required),\n    cvss_version              = tostring(props.cvss_version),\n    user_interaction          = tostring(props.user_interaction),\n    cvss_vector               = tostring(props.cvss_vector),\n    scope                     = tostring(props.scope),\n    confidentiality_impact    = tostring(props.confidentiality_impact),\n    exploitability_score      = toreal(props.exploitability_score),\n    products                  = tostring(props.products),\n    technologies              = tostring(props.technologies),\n    vendors                   = tostring(props.vendors),\n    confidence_score          = toint(confidence),\n    servers                   = tostring(props.servers),\n    vulnerability_type        = tostring(props.vulnerability_type),\n    vulnerability_category        = tostring(props.vulnerability_category),\n    NetworkIPs                = tostring(props.ips),\n    ProviderName              ='CYFIRMA',\n    ProductName               ='DeCYFIR/DeTCT'\n| summarize arg_max(\n                integrity_impact,\n                TimeGenerated, \n                id,\n                description,\n                confidence_score,\n                created,\n                modified,\n                attack_complexity,\n                cvss_score,\n                impact_score,\n                attack_vector,\n                privileges_required,\n                cvss_version,\n                user_interaction,\n                cvss_vector,\n                scope,\n                confidentiality_impact,\n                exploitability_score,\n                products,\n                technologies,\n                vendors,\n                ProviderName,\n                ProductName,\n                servers,\n                NetworkIPs,\n                vulnerability_type,\n                vulnerability_category\n            )\n    by name\n| where confidence_score >= 60 and vulnerability_category == 'ATTACK_SURFACE_VULNERABILITY' and TimeGenerated between (ago(timeFrame) .. now())\n| project \n    TimeGenerated,\n    name,\n    confidence_score,\n    integrity_impact,\n    attack_complexity,\n    cvss_score,\n    impact_score,\n    attack_vector,\n    UID = id,\n    description,\n    created,\n    modified,\n    privileges_required,\n    cvss_version,\n    user_interaction,\n    cvss_vector,\n    scope,\n    confidentiality_impact,\n    exploitability_score,\n    products,\n    technologies,\n    vendors,\n    ProviderName,\n    ProductName,\n    servers,\n    NetworkIPs,\n    vulnerability_type,\n    vulnerability_category\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "CyfirmaVulnerabilitiesIntelDC",
                    "dataTypes": [
                      "CyfirmaVulnerabilities_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "LateralMovement",
                  "PrivilegeEscalation",
                  "InitialAccess",
                  "CredentialAccess",
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1548.002",
                  "T1021.002"
                ],
                "techniques": [
                  "T1059",
                  "T1203",
                  "T1210",
                  "T1068",
                  "T1190",
                  "T1133",
                  "T1003",
                  "T1553",
                  "T1548",
                  "T1021"
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "CVE": "name",
                  "IntegrityImpact": "integrity_impact",
                  "UserInteraction": "user_interaction",
                  "PrivilegesRequired": "privileges_required",
                  "Products": "technologies",
                  "ConfidenceScore": "confidence_score",
                  "ExploitabilityScore": "modified",
                  "Modified": "products",
                  "Vendors": "vendors",
                  "CVSSVersion": "cvss_version",
                  "Technologies": "technologies",
                  "ConfidentialImpact": "confidentiality_impact",
                  "TimeGenerated": "TimeGenerated",
                  "CVSSScore": "cvss_score",
                  "AttackComplexity": "attack_complexity",
                  "scope": "exploitability_score",
                  "CVSSVector": "scope",
                  "ImpactScore": "impact_score",
                  "AttackVector": "attack_vector"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{description}} ",
                  "alertDynamicProperties": [
                    {
                      "value": "ProductName",
                      "alertProperty": "ProductName"
                    },
                    {
                      "value": "ProviderName",
                      "alertProperty": "ProviderName"
                    }
                  ],
                  "alertDisplayNameFormat": "CYFIRMA - Medium Severity Attack Surface based Vulnerability Identified - {{name}} "
                },
                "incidentConfiguration": {
                  "createIncident": true,
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "matchingMethod": "AllEntities",
                    "enabled": false
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Cyfirma Vulnerabilities Intel Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Cyfirma Vulnerabilities Intel",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "CYFIRMA - Medium Severity Attack Surface based Vulnerabilities Rule",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "AttackSurfaceVulnerabilitiesHighSeverityRule_AnalyticalRules Analytics Rule with template version 3.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "This rule detects high severity attack surface-based vulnerabilities from CYFIRMA's vulnerability intelligence data. \nIt identifies vulnerabilities with a confidence score of 80 or higher, excluding those categorized as 'ASSET_VULNERABILITY', and generates alerts for assets that may be at risk.",
                "displayName": "CYFIRMA - High Severity Attack Surface based Vulnerabilities Rule Alert",
                "enabled": false,
                "query": "// High severity - Attack Surface based Vulnerabilities\nlet timeFrame= 5m;\nCyfirmaVulnerabilities_CL\n| extend parsed = parse_json(extensions)\n| extend extensionKeys = bag_keys(parsed)\n| mv-expand extensionKeys\n| extend extensionKeyStr = tostring(extensionKeys)\n| extend ext = parsed[extensionKeyStr]\n| extend props = ext.properties\n| extend \n    attack_complexity         = tostring(props.attack_complexity),\n    cvss_score                = toreal(props.cvss_score),\n    integrity_impact          = tostring(props.integrity_impact),\n    impact_score              = tostring(props.impact_score),\n    attack_vector             = tostring(props.attack_vector),\n    privileges_required       = tostring(props.privileges_required),\n    cvss_version              = tostring(props.cvss_version),\n    user_interaction          = tostring(props.user_interaction),\n    cvss_vector               = tostring(props.cvss_vector),\n    scope                     = tostring(props.scope),\n    confidentiality_impact    = tostring(props.confidentiality_impact),\n    exploitability_score      = toreal(props.exploitability_score),\n    products                  = tostring(props.products),\n    technologies              = tostring(props.technologies),\n    vendors                   = tostring(props.vendors),\n    confidence_score          = toint(confidence),\n    servers                   = tostring(props.servers),\n    vulnerability_type        = tostring(props.vulnerability_type),\n    vulnerability_category        = tostring(props.vulnerability_category),\n    NetworkIPs                = tostring(props.ips),\n    ProviderName              ='CYFIRMA',\n    ProductName               ='DeCYFIR/DeTCT'\n| summarize arg_max(\n                integrity_impact,\n                TimeGenerated, \n                id,\n                description,\n                confidence_score,\n                created,\n                modified,\n                attack_complexity,\n                cvss_score,\n                impact_score,\n                attack_vector,\n                privileges_required,\n                cvss_version,\n                user_interaction,\n                cvss_vector,\n                scope,\n                confidentiality_impact,\n                exploitability_score,\n                products,\n                technologies,\n                vendors,\n                ProviderName,\n                ProductName,\n                servers,\n                NetworkIPs,\n                vulnerability_type,\n                vulnerability_category\n            )\n    by name\n| where confidence_score >= 80 and vulnerability_category == 'ATTACK_SURFACE_VULNERABILITY' and TimeGenerated between (ago(timeFrame) .. now())\n| project \n    TimeGenerated,\n    name,\n    confidence_score,\n    integrity_impact,\n    attack_complexity,\n    cvss_score,\n    impact_score,\n    attack_vector,\n    UID = id,\n    description,\n    created,\n    modified,\n    privileges_required,\n    cvss_version,\n    user_interaction,\n    cvss_vector,\n    scope,\n    confidentiality_impact,\n    exploitability_score,\n    products,\n    technologies,\n    vendors,\n    ProviderName,\n    ProductName,\n    servers,\n    NetworkIPs,\n    vulnerability_type,\n    vulnerability_category\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "CyfirmaVulnerabilitiesIntelDC",
                    "dataTypes": [
                      "CyfirmaVulnerabilities_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "LateralMovement",
                  "PrivilegeEscalation",
                  "InitialAccess",
                  "CredentialAccess",
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1548.002",
                  "T1021.002"
                ],
                "techniques": [
                  "T1059",
                  "T1203",
                  "T1210",
                  "T1068",
                  "T1190",
                  "T1133",
                  "T1003",
                  "T1553",
                  "T1548",
                  "T1021"
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "CVE": "name",
                  "IntegrityImpact": "integrity_impact",
                  "UserInteraction": "user_interaction",
                  "PrivilegesRequired": "privileges_required",
                  "Products": "technologies",
                  "ConfidenceScore": "confidence_score",
                  "ExploitabilityScore": "modified",
                  "Modified": "products",
                  "Vendors": "vendors",
                  "CVSSVersion": "cvss_version",
                  "Technologies": "technologies",
                  "ConfidentialImpact": "confidentiality_impact",
                  "TimeGenerated": "TimeGenerated",
                  "CVSSScore": "cvss_score",
                  "AttackComplexity": "attack_complexity",
                  "scope": "exploitability_score",
                  "CVSSVector": "scope",
                  "ImpactScore": "impact_score",
                  "AttackVector": "attack_vector"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{description}} ",
                  "alertDynamicProperties": [
                    {
                      "value": "ProductName",
                      "alertProperty": "ProductName"
                    },
                    {
                      "value": "ProviderName",
                      "alertProperty": "ProviderName"
                    }
                  ],
                  "alertDisplayNameFormat": "CYFIRMA - High Severity Attack Surface based Vulnerability Identified - {{name}} "
                },
                "incidentConfiguration": {
                  "createIncident": true,
                  "groupingConfiguration": {
                    "reopenClosedIncident": false,
                    "lookbackDuration": "PT5H",
                    "matchingMethod": "AllEntities",
                    "enabled": false
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Cyfirma Vulnerabilities Intel Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Cyfirma Vulnerabilities Intel",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "CYFIRMA - High Severity Attack Surface based Vulnerabilities Rule Alert",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "CYFIRMA Vulnerabilities Intelligence",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "CyfirmaVulnerabilitiesIntelDC",
                  "title": "CYFIRMA Vulnerabilities Intelligence",
                  "publisher": "Microsoft",
                  "isConnectivityCriteriasMatchSome": false,
                  "descriptionMarkdown": "The CYFIRMA Vulnerabilities Intelligence data connector enables seamless log ingestion from the DeCYFIR API into Microsoft Sentinel. Built on the Microsoft Sentinel Codeless Connector Platform, it leverages the CYFIRMA API's to retrieve logs. Additionally, it supports DCR-based [ingestion time transformations](https://docs.microsoft.com/azure/azure-monitor/logs/custom-logs-overview), which parse security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
                  "graphQueries": [
                    {
                      "metricName": "Total Vulnerabilities logs received",
                      "legend": "Vulnerabilities Logs",
                      "baseQuery": "CyfirmaVulnerabilities_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample of Vulnerabilities logs",
                      "query": "CyfirmaVulnerabilities_CL | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "CyfirmaVulnerabilities_CL",
                      "lastDataReceivedQuery": "CyfirmaVulnerabilities_CL\n | where TimeGenerated > ago(5m) | summarize Time = max(TimeGenerated)\n  | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": true,
                          "write": true,
                          "delete": true,
                          "action": false
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "CYFIRMA Vulnerabilities Intelligence",
                      "description": "This connector provides the Vulnerabilities logs from CYFIRMA Vulnerabilities Intelligence. The connector uses the DeCYFIR API to retrieve logs and supports DCR-based ingestion time transformations, parsing security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
                      "descriptionMarkdown": "This connector provides the Vulnerabilities logs from CYFIRMA Vulnerabilities Intelligence. The connector uses the DeCYFIR API to retrieve logs and supports DCR-based ingestion time transformations, parsing security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
                      "estimatedTime": "5 minutes",
                      "icon": "https://www.microsoft.com/favicon.ico",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "CYFIRMA API URL",
                            "placeholder": "https://decyfir.cyfirma.com",
                            "type": "text",
                            "name": "cyfirmaAPIURL"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "CYFIRMA API Key",
                            "placeholder": "CYFIRMA API Key",
                            "type": "password",
                            "name": "cyfirmaAPIKey"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Delta",
                            "placeholder": "API Delta",
                            "type": "text",
                            "name": "apiDelta",
                            "defaultValue": "false",
                            "description": "API Delta: If true (default), returns data since the last call; if false or unspecified, returns data from the last 24 hours."
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Vendor-Associated Vulnerabilities",
                            "placeholder": "",
                            "type": "text",
                            "name": "isVendor",
                            "defaultValue": "false",
                            "description": "The value for Vendor-Associated Vulnerabilities can be either true or false."
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Product-Associated Vulnerabilities",
                            "placeholder": "",
                            "type": "text",
                            "name": "isProduct",
                            "defaultValue": "false",
                            "description": "The value for Product-Associated Vulnerabilities can be either true or false."
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Product with Version-Associated Vulnerabilities",
                            "placeholder": "",
                            "type": "text",
                            "name": "isVersion",
                            "defaultValue": "false",
                            "description": "The value for Version-Associated Vulnerabilities can be either true or false."
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {
                            "connectLabel": "Connect",
                            "name": "connect"
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "CyfirmaVulnerabilitiesIntelDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-CyfirmaVulnerabilities_CL": {
                    "columns": [
                      {
                        "name": "type",
                        "type": "string"
                      },
                      {
                        "name": "name",
                        "type": "string"
                      },
                      {
                        "name": "id",
                        "type": "string"
                      },
                      {
                        "name": "description",
                        "type": "string"
                      },
                      {
                        "name": "created",
                        "type": "datetime"
                      },
                      {
                        "name": "modified",
                        "type": "datetime"
                      },
                      {
                        "name": "spec_version",
                        "type": "string"
                      },
                      {
                        "name": "external_references",
                        "type": "dynamic"
                      },
                      {
                        "name": "extensions",
                        "type": "dynamic"
                      },
                      {
                        "name": "confidence",
                        "type": "int"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-CyfirmaVulnerabilities_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n| extend TimeGenerated= created\n| extend Type = ['type']\n| project-away type\n\n",
                    "outputStream": "Custom-CyfirmaVulnerabilities_CL"
                  }
                ]
              }
            },
            {
              "name": "CyfirmaVulnerabilities_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "CyfirmaVulnerabilities_CL",
                  "columns": [
                    {
                      "name": "confidence",
                      "type": "int",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "created",
                      "type": "datetime",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "description",
                      "type": "string",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "extensions",
                      "type": "dynamic",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "external_references",
                      "type": "dynamic",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "id",
                      "type": "string",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "modified",
                      "type": "datetime",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "name",
                      "type": "string",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "spec_version",
                      "type": "string",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    },
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "isDefaultDisplay": false,
                      "isHidden": false
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "CyfirmaVulnerabilitiesIntelDC",
          "title": "CYFIRMA Vulnerabilities Intelligence",
          "publisher": "Microsoft",
          "isConnectivityCriteriasMatchSome": false,
          "descriptionMarkdown": "The CYFIRMA Vulnerabilities Intelligence data connector enables seamless log ingestion from the DeCYFIR API into Microsoft Sentinel. Built on the Microsoft Sentinel Codeless Connector Platform, it leverages the CYFIRMA API's to retrieve logs. Additionally, it supports DCR-based [ingestion time transformations](https://docs.microsoft.com/azure/azure-monitor/logs/custom-logs-overview), which parse security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
          "graphQueries": [
            {
              "metricName": "Total Vulnerabilities logs received",
              "legend": "Vulnerabilities Logs",
              "baseQuery": "CyfirmaVulnerabilities_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample of Vulnerabilities logs",
              "query": "CyfirmaVulnerabilities_CL | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "CyfirmaVulnerabilities_CL",
              "lastDataReceivedQuery": "CyfirmaVulnerabilities_CL\n | where TimeGenerated > ago(5m) | summarize Time = max(TimeGenerated)\n  | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true,
                  "action": false
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "CYFIRMA Vulnerabilities Intelligence",
              "description": "This connector provides the Vulnerabilities logs from CYFIRMA Vulnerabilities Intelligence. The connector uses the DeCYFIR API to retrieve logs and supports DCR-based ingestion time transformations, parsing security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
              "descriptionMarkdown": "This connector provides the Vulnerabilities logs from CYFIRMA Vulnerabilities Intelligence. The connector uses the DeCYFIR API to retrieve logs and supports DCR-based ingestion time transformations, parsing security data into a custom table during ingestion. This eliminates the need for query-time parsing, enhancing performance and efficiency.",
              "estimatedTime": "5 minutes",
              "icon": "https://www.microsoft.com/favicon.ico",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "CYFIRMA API URL",
                    "placeholder": "https://decyfir.cyfirma.com",
                    "type": "text",
                    "name": "cyfirmaAPIURL"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "CYFIRMA API Key",
                    "placeholder": "CYFIRMA API Key",
                    "type": "password",
                    "name": "cyfirmaAPIKey"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Delta",
                    "placeholder": "API Delta",
                    "type": "text",
                    "name": "apiDelta",
                    "defaultValue": "false",
                    "description": "API Delta: If true (default), returns data since the last call; if false or unspecified, returns data from the last 24 hours."
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Vendor-Associated Vulnerabilities",
                    "placeholder": "",
                    "type": "text",
                    "name": "isVendor",
                    "defaultValue": "false",
                    "description": "The value for Vendor-Associated Vulnerabilities can be either true or false."
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Product-Associated Vulnerabilities",
                    "placeholder": "",
                    "type": "text",
                    "name": "isProduct",
                    "defaultValue": "false",
                    "description": "The value for Product-Associated Vulnerabilities can be either true or false."
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Product with Version-Associated Vulnerabilities",
                    "placeholder": "",
                    "type": "text",
                    "name": "isVersion",
                    "defaultValue": "false",
                    "description": "The value for Version-Associated Vulnerabilities can be either true or false."
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {
                    "connectLabel": "Connect",
                    "name": "connect"
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "CYFIRMA",
          "email": "support@cyfirma.com",
          "tier": "Partner",
          "link": "https://www.cyfirma.com/contact-us/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "CYFIRMA Vulnerabilities Intelligence",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "CYFIRMA Vulnerabilities Intelligence",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "cyfirmaAPIURL": {
              "defaultValue": "cyfirmaAPIURL",
              "type": "securestring",
              "minLength": 1
            },
            "cyfirmaAPIKey": {
              "defaultValue": "cyfirmaAPIKey",
              "type": "securestring",
              "minLength": 1
            },
            "apiDelta": {
              "defaultValue": "apiDelta",
              "type": "securestring",
              "minLength": 1
            },
            "isVendor": {
              "defaultValue": "isVendor",
              "type": "securestring",
              "minLength": 1
            },
            "isProduct": {
              "defaultValue": "isProduct",
              "type": "securestring",
              "minLength": 1
            },
            "isVersion": {
              "defaultValue": "isVersion",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "CYFIRMA",
                  "email": "support@cyfirma.com",
                  "tier": "Partner",
                  "link": "https://www.cyfirma.com/contact-us/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CyfirmaVulnerabilitiesIntelPoller', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "displayName": "CyfirmaVulnerabilitiesIntelPoller",
                "connectorDefinitionName": "CyfirmaVulnerabilitiesIntelDC",
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('cyfirmaAPIKey')]",
                  "ApiKeyName": "key"
                },
                "request": {
                  "apiEndpoint": "[[concat(parameters('cyfirmaAPIURL'),'/core/api-ua/stix-v2.1/v2/vulnerabilities')]",
                  "httpMethod": "GET",
                  "headers": {
                    "Accept": "application/json"
                  },
                  "queryTimeFormat": "UnixTimestampInMills",
                  "queryWindowInMin": 5,
                  "logResponseContent": true,
                  "queryParameters": {
                    "delta": "[[parameters('apiDelta')]",
                    "is-vendor": "[[parameters('isVendor')]",
                    "is-product": "[[parameters('isProduct')]",
                    "is-version": "[[parameters('isVersion')]",
                    "key": "[[parameters('cyfirmaAPIKey')]",
                    "intg-product-name": "MS_AZURE_DC"
                  }
                },
                "response": {
                  "EventsJsonPaths": [
                    "$"
                  ],
                  "format": "json",
                  "SuccessStatusValue": "success"
                },
                "dcrConfig": {
                  "streamName": "Custom-CyfirmaVulnerabilities_CL",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Cyfirma Vulnerabilities Intel",
        "publisherDisplayName": "CYFIRMA",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Cyfirma%20Vulnerabilities%20Intel/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The CYFIRMA Vulnerability Intelligence solution integrates with Microsoft Sentinel to deliver real-time intelligence on exposed and vulnerable assets across internet-facing infrastructure. This includes open ports, outdated software, misconfigurations, and exploitable weaknesses linked to known vulnerabilities (CVEs). By ingesting asset-level vulnerability insights into Sentinel, security teams can prioritize remediation based on risk context, correlate exposures with active threat campaigns, and trigger automated responses using analytics rules and playbooks.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Analytic Rules:</strong> 4</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Cyfirma_logo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Cyfirma Vulnerabilities Intel",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "CYFIRMA",
          "email": "support@cyfirma.com",
          "tier": "Partner",
          "link": "https://www.cyfirma.com/contact-us/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2025-05-15",
        "providers": [
          "CYFIRMA"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Application",
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
