{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "author": "Cyble Inc",
        "comments": "Solution template for Cyble Vision"
    },
    "parameters": {
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "resourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "resource group name where Microsoft Sentinel is setup"
            }
        },
        "subscription": {
            "type": "string",
            "defaultValue": "[last(split(subscription().id, '/'))]",
            "metadata": {
                "description": "subscription id where Microsoft Sentinel is setup"
            }
        }
    },
    "variables": {
        "_solutionName": "Cyble Vision",
        "_solutionVersion": "3.0.2",
        "solutionId": "cybleinc1737472004964.cybleinc1737472004964-azure-sentinel-offerid",
        "_solutionId": "[variables('solutionId')]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "dataConnectorCCPVersion": "1.0.0",
        "_dataConnectorContentIdConnectorDefinition1": "CybleVisionAlerts",
        "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
        "_dataConnectorContentIdConnections1": "CybleVisionAlertsConnections",
        "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
        "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
        "blanks": "[replace('b', 'b', '')]",
        "IoC-Enrichment": "IoC-Enrichment",
        "_IoC-Enrichment": "[variables('IoC-Enrichment')]",
        "TemplateEmptyArray": "[json('[]')]",
        "playbookVersion1": "1.0",
        "playbookContentId1": "IoC-Enrichment",
        "_playbookContentId1": "[variables('playbookContentId1')]",
        "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
        "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
        "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
        "TI-Ingest": "TI-Ingest",
        "_TI-Ingest": "[variables('TI-Ingest')]",
        "playbookVersion2": "1.0",
        "playbookContentId2": "TI-Ingest",
        "_playbookContentId2": "[variables('playbookContentId2')]",
        "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
        "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
        "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
        "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "displayName": "Cyble Vision Alerts",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
                            "apiVersion": "2022-09-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
                            "location": "[parameters('workspace-location')]",
                            "kind": "Customizable",
                            "properties": {
                                "connectorUiConfig": {
                                    "title": "Cyble Vision Alerts",
                                    "publisher": "Cyble",
                                    "id": "CybleVisionAlerts",
                                    "descriptionMarkdown": "The **Cyble Vision Alerts** CCF Data Connector enables Ingestion of Threat Alerts from Cyble Vision into Microsoft Sentinel using the Codeless Connector Framework Connector. It collects alert data via API, normalizes it, and stores it in a custom table for advanced detection, correlation, and response.",
                                    "graphQueriesTableName": "CybleVisionAlerts_CL",
                                    "graphQueries": [
                                        {
                                            "metricName": "Total Alerts received",
                                            "legend": "Alerts",
                                            "baseQuery": "{{graphQueriesTableName}}"
                                        }
                                    ],
                                    "sampleQueries": [
                                        {
                                            "description": "Get Sample of Cyble Vision Alerts",
                                            "query": "{{graphQueriesTableName}}\n | take 10"
                                        }
                                    ],
                                    "dataTypes": [
                                        {
                                            "name": "CybleVisionAlerts_CL",
                                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(7d) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                                        }
                                    ],
                                    "connectivityCriteria": [
                                        {
                                            "type": "HasDataConnectors"
                                        }
                                    ],
                                    "permissions": {
                                        "resourceProvider": [
                                            {
                                                "provider": "Microsoft.OperationalInsights/workspaces",
                                                "permissionsDisplayText": "Read and Write permissions are required.",
                                                "providerDisplayName": "Workspace",
                                                "scope": "Workspace",
                                                "requiredPermissions": {
                                                    "write": true,
                                                    "read": true,
                                                    "delete": true
                                                }
                                            }
                                        ],
                                        "customs": [
                                            {
                                                "name": "Cyble Vision API token",
                                                "description": "An API Token from Cyble Vision Platform is required."
                                            }
                                        ]
                                    },
                                    "instructionSteps": [
                                        {
                                            "title": "Step 1 - Generating API Token from Cyble Platform",
                                            "description": "Navigate to [Cyble Platform](https://bifrost.cyble.ai) and log in using your Cyble Vision credentials.\n\nOnce logged in, go to the left-hand panel and scroll down to **Utilities**. Click on **Access APIs**. On the top-right corner of the page, click the ** + (Add)** icon to generate a new API key. Provide an alias (a friendly name for your key) and click **Generate**. Copy the generated API token and store it securely."
                                        },
                                        {
                                            "title": "STEP 2 - Configure the Data Connector",
                                            "description": "Return to Microsoft Sentinel and open the **Cyble Vision Alerts** data connector configuration page. Paste your Cyble API Token into the **API Token** field under 'API Details'.",
                                            "instructions": [
                                                {
                                                    "type": "Textbox",
                                                    "parameters": {
                                                        "label": "API Token",
                                                        "placeholder": "Enter your API Token",
                                                        "type": "password",
                                                        "name": "ApiToken"
                                                    }
                                                },
                                                {
                                                    "type": "ConnectionToggleButton",
                                                    "parameters": {
                                                        "connectLabel": "Connect",
                                                        "name": "toggle"
                                                    }
                                                }
                                            ]
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorCCPVersion')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "Cyble Inc"
                                },
                                "support": {
                                    "name": "Cyble Support",
                                    "email": "csm@cyble.com",
                                    "tier": "Partner",
                                    "link": "https://cyble.com/talk-to-sales/"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "version": "[variables('dataConnectorCCPVersion')]",
                                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                                            "kind": "ResourcesDataConnector"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "CybleVisionAlertsDCR",
                            "apiVersion": "2022-06-01",
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "location": "[parameters('workspace-location')]",
                            "kind": "[variables('blanks')]",
                            "properties": {
                                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                                "streamDeclarations": {
                                    "Custom-CybleVisionAlerts_CL": {
                                        "columns": [
                                            {
                                                "name": "created_at",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "updated_at",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "deleted_at",
                                                "type": "string"
                                            },
                                            {
                                                "name": "id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "data_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "entity_id",
                                                "type": "int"
                                            },
                                            {
                                                "name": "keyword_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "entity_type",
                                                "type": "int"
                                            },
                                            {
                                                "name": "service",
                                                "type": "string"
                                            },
                                            {
                                                "name": "company_id",
                                                "type": "int"
                                            },
                                            {
                                                "name": "description",
                                                "type": "string"
                                            },
                                            {
                                                "name": "status",
                                                "type": "string"
                                            },
                                            {
                                                "name": "assignee_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "assignment_date",
                                                "type": "string"
                                            },
                                            {
                                                "name": "archive_date",
                                                "type": "string"
                                            },
                                            {
                                                "name": "severity",
                                                "type": "string"
                                            },
                                            {
                                                "name": "updated_by_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "created_by",
                                                "type": "string"
                                            },
                                            {
                                                "name": "user_severity",
                                                "type": "string"
                                            },
                                            {
                                                "name": "bucket_id",
                                                "type": "int"
                                            },
                                            {
                                                "name": "asset",
                                                "type": "string"
                                            },
                                            {
                                                "name": "last_detected_at",
                                                "type": "string"
                                            },
                                            {
                                                "name": "filename",
                                                "type": "string"
                                            },
                                            {
                                                "name": "repository_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "owner_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "extension",
                                                "type": "string"
                                            },
                                            {
                                                "name": "compromised_date",
                                                "type": "string"
                                            },
                                            {
                                                "name": "article_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "breach_source",
                                                "type": "string"
                                            },
                                            {
                                                "name": "breach_date",
                                                "type": "string"
                                            },
                                            {
                                                "name": "channel_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "server_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "content_updated_on",
                                                "type": "string"
                                            },
                                            {
                                                "name": "discussion_date",
                                                "type": "string"
                                            },
                                            {
                                                "name": "discussion_by",
                                                "type": "string"
                                            },
                                            {
                                                "name": "source_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "topic_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "source",
                                                "type": "string"
                                            },
                                            {
                                                "name": "type",
                                                "type": "string"
                                            },
                                            {
                                                "name": "content_added_on",
                                                "type": "string"
                                            },
                                            {
                                                "name": "ioc",
                                                "type": "string"
                                            },
                                            {
                                                "name": "first_seen_on",
                                                "type": "string"
                                            },
                                            {
                                                "name": "last_seen_on",
                                                "type": "string"
                                            },
                                            {
                                                "name": "old_risk_score",
                                                "type": "string"
                                            },
                                            {
                                                "name": "new_risk_score",
                                                "type": "string"
                                            },
                                            {
                                                "name": "ip",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "host",
                                                "type": "string"
                                            },
                                            {
                                                "name": "port",
                                                "type": "int"
                                            },
                                            {
                                                "name": "application_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "market_source",
                                                "type": "string"
                                            },
                                            {
                                                "name": "uploaded_at",
                                                "type": "string"
                                            },
                                            {
                                                "name": "cve",
                                                "type": "string"
                                            },
                                            {
                                                "name": "subdomain",
                                                "type": "string"
                                            },
                                            {
                                                "name": "domain",
                                                "type": "string"
                                            },
                                            {
                                                "name": "chat_title",
                                                "type": "string"
                                            },
                                            {
                                                "name": "username",
                                                "type": "string"
                                            },
                                            {
                                                "name": "search_engine",
                                                "type": "string"
                                            },
                                            {
                                                "name": "category",
                                                "type": "string"
                                            },
                                            {
                                                "name": "sentiment",
                                                "type": "string"
                                            },
                                            {
                                                "name": "name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "true_positive",
                                                "type": "boolean"
                                            },
                                            {
                                                "name": "llm_processed",
                                                "type": "boolean"
                                            },
                                            {
                                                "name": "llm_explanation",
                                                "type": "string"
                                            },
                                            {
                                                "name": "bucket_name",
                                                "type": "string"
                                            },
                                            {
                                                "name": "tags",
                                                "type": "dynamic"
                                            },
                                            {
                                                "name": "risk_score",
                                                "type": "dynamic"
                                            }
                                        ]
                                    }
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[variables('workspaceResourceId')]",
                                            "name": "clv2ws1"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Custom-CybleVisionAlerts_CL"
                                        ],
                                        "destinations": [
                                            "clv2ws1"
                                        ],
                                        "transformKql": "source | extend TimeGenerated = now(), Created_At = todatetime(created_at), Updated_At = todatetime(updated_at), Deleted_At = deleted_at, DataID = data_id, EntityID = entity_id, KeywordName = keyword_name, EntityType = entity_type, Service = service, CompanyID = company_id, Description = description, Status = status, AssigneeID = assignee_id, AssignmentDate = assignment_date, ArchiveDate = archive_date, Severity = severity, UpdatedBy = updated_by_id, CreatedBy = created_by, UserSeverity = user_severity, BucketID = bucket_id, Filename = filename, RepositoryName = repository_name, OwnerName = owner_name, BucketName = bucket_name, TruePositive = true_positive, LLMProcessed = llm_processed, LLMExplanation = llm_explanation, Tags = tags, ID = id, Asset = asset, Last_Detected_At = last_detected_at, Extension = extension, Compromised_Date = compromised_date, Article_Name = article_name, Breach_Source = breach_source, Breach_Date = breach_date, Channel_Name = channel_name, Server_Name = server_name, Content_Updated_On = content_updated_on, Discussion_Date = discussion_date, Discussion_By = discussion_by, Source_Name = source_name, Topic_Name = topic_name, Source = source, Alert_Type = type, Content_Added_On = content_added_on, IOC = ioc, First_Seen_On = first_seen_on, Last_Seen_On = last_seen_on, Old_Risk_Score = old_risk_score, New_Risk_Score = new_risk_score, IP = ip, Host = host, Port = port, Application_Name = application_name, Market_Source = market_source, Uploaded_At = uploaded_at, CVE = cve, Subdomain = subdomain, Domain = domain, Chat_Title = chat_title, Username = username, Search_Engine = search_engine, Category = category, Sentiment = sentiment, Name = name, RiskScore_s = tostring(risk_score.s), RiskScore_e = tostring(risk_score.e), RiskScore_c = tostring(risk_score.c) | project TimeGenerated, Created_At, Updated_At, Deleted_At, DataID, EntityID, KeywordName, EntityType, Service, CompanyID, Description, Status, AssigneeID, AssignmentDate, ArchiveDate, Severity, UpdatedBy, CreatedBy, UserSeverity, BucketID, Filename, RepositoryName, OwnerName, BucketName, TruePositive, LLMProcessed, LLMExplanation, Tags, ID, Asset, Last_Detected_At, Extension, Compromised_Date, Article_Name, Breach_Source, Breach_Date, Channel_Name, Server_Name, Content_Updated_On, Discussion_Date, Discussion_By, Source_Name, Topic_Name, Source, Alert_Type, Content_Added_On, IOC, First_Seen_On, Last_Seen_On, Old_Risk_Score, New_Risk_Score, IP, Host, Port, Application_Name, Market_Source, Uploaded_At, CVE, Subdomain, Domain, Chat_Title, Username, Search_Engine, Category, Sentiment, Name, RiskScore_s, RiskScore_e, RiskScore_c",
                                        "outputStream": "Custom-CybleVisionAlerts_CL"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "CybleVisionAlerts_CL",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "location": "[parameters('workspace-location')]",
                            "kind": null,
                            "properties": {
                                "schema": {
                                    "name": "CybleVisionAlerts_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "Created_At",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "Updated_At",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "Deleted_At",
                                            "type": "string"
                                        },
                                        {
                                            "name": "DataID",
                                            "type": "string"
                                        },
                                        {
                                            "name": "EntityID",
                                            "type": "int"
                                        },
                                        {
                                            "name": "KeywordName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "EntityType",
                                            "type": "int"
                                        },
                                        {
                                            "name": "Service",
                                            "type": "string"
                                        },
                                        {
                                            "name": "CompanyID",
                                            "type": "int"
                                        },
                                        {
                                            "name": "Description",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Status",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AssigneeID",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AssignmentDate",
                                            "type": "string"
                                        },
                                        {
                                            "name": "ArchiveDate",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Severity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "UpdatedBy",
                                            "type": "string"
                                        },
                                        {
                                            "name": "CreatedBy",
                                            "type": "string"
                                        },
                                        {
                                            "name": "UserSeverity",
                                            "type": "string"
                                        },
                                        {
                                            "name": "BucketID",
                                            "type": "int"
                                        },
                                        {
                                            "name": "Filename",
                                            "type": "string"
                                        },
                                        {
                                            "name": "RepositoryName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "OwnerName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "BucketName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "TruePositive",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "LLMProcessed",
                                            "type": "boolean"
                                        },
                                        {
                                            "name": "LLMExplanation",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Tags",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "ID",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Asset",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Last_Detected_At",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Extension",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Compromised_Date",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Article_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Breach_Source",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Breach_Date",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Channel_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Server_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Content_Updated_On",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Discussion_Date",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Discussion_By",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Source_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Topic_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Source",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Alert_Type",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Content_Added_On",
                                            "type": "string"
                                        },
                                        {
                                            "name": "IOC",
                                            "type": "string"
                                        },
                                        {
                                            "name": "First_Seen_On",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Last_Seen_On",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Old_Risk_Score",
                                            "type": "string"
                                        },
                                        {
                                            "name": "New_Risk_Score",
                                            "type": "string"
                                        },
                                        {
                                            "name": "IP",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "Host",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Port",
                                            "type": "int"
                                        },
                                        {
                                            "name": "Application_Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Market_Source",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Uploaded_At",
                                            "type": "string"
                                        },
                                        {
                                            "name": "CVE",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Subdomain",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Domain",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Chat_Title",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Username",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Search_Engine",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Category",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Sentiment",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Name",
                                            "type": "string"
                                        },
                                        {
                                            "name": "RiskScore_s",
                                            "type": "String"
                                        },
                                        {
                                            "name": "RiskScore_e",
                                            "type": "String"
                                        },
                                        {
                                            "name": "RiskScore_c",
                                            "type": "String"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "title": "Cyble Vision Alerts",
                    "publisher": "Cyble",
                    "id": "CybleVisionAlerts",
                    "descriptionMarkdown": "The **Cyble Vision Alerts** CCF Data Connector enables Ingestion of Threat Alerts from Cyble Vision into Microsoft Sentinel using the Codeless Connector Framework Connector. It collects alert data via API, normalizes it, and stores it in a custom table for advanced detection, correlation, and response.",
                    "graphQueriesTableName": "CybleVisionAlerts_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total Alerts received",
                            "legend": "Alerts",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "Get Sample of Cyble Vision Alerts",
                            "query": "{{graphQueriesTableName}}\n | take 10"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "CybleVisionAlerts_CL",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(7d) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and Write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Cyble Vision API token",
                                "description": "An API Token from Cyble Vision Platform is required."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "title": "Step 1 - Generating API Token from Cyble Platform",
                            "description": "Navigate to [Cyble Platform](https://bifrost.cyble.ai) and log in using your Cyble Vision credentials.\n\nOnce logged in, go to the left-hand panel and scroll down to **Utilities**. Click on **Access APIs**. On the top-right corner of the page, click the ** + (Add)** icon to generate a new API key. Provide an alias (a friendly name for your key) and click **Generate**. Copy the generated API token and store it securely."
                        },
                        {
                            "title": "STEP 2 - Configure the Data Connector",
                            "description": "Return to Microsoft Sentinel and open the **Cyble Vision Alerts** data connector configuration page. Paste your Cyble API Token into the **API Token** field under 'API Details'.",
                            "instructions": [
                                {
                                    "type": "Textbox",
                                    "parameters": {
                                        "label": "API Token",
                                        "placeholder": "Enter your API Token",
                                        "type": "password",
                                        "name": "ApiToken"
                                    }
                                },
                                {
                                    "type": "ConnectionToggleButton",
                                    "parameters": {
                                        "connectLabel": "Connect",
                                        "name": "toggle"
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                    "sourceId": "[variables('_solutionId')]",
                    "name": "[variables('_solutionName')]",
                    "kind": "Solution"
                },
                "author": {
                    "name": "Cyble Inc"
                },
                "support": {
                    "name": "Cyble Support",
                    "email": "csm@cyble.com",
                    "tier": "Partner",
                    "link": "https://cyble.com/talk-to-sales/"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "version": "[variables('dataConnectorCCPVersion')]",
                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                            "kind": "ResourcesDataConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "displayName": "Cyble Vision Alerts",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {
                        "guidValue": {
                            "defaultValue": "[[newGuid()]",
                            "type": "securestring"
                        },
                        "innerWorkspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "securestring"
                        },
                        "connectorDefinitionName": {
                            "defaultValue": "Cyble Vision Alerts",
                            "type": "securestring",
                            "minLength": 1
                        },
                        "workspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "securestring"
                        },
                        "dcrConfig": {
                            "defaultValue": {
                                "dataCollectionEndpoint": "data collection Endpoint",
                                "dataCollectionRuleImmutableId": "data collection rule immutableId"
                            },
                            "type": "object"
                        },
                        "ApiToken": {
                            "defaultValue": "ApiToken",
                            "type": "securestring",
                            "minLength": 1
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorCCPVersion')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "Cyble Inc"
                                },
                                "support": {
                                    "name": "Cyble Support",
                                    "email": "csm@cyble.com",
                                    "tier": "Partner",
                                    "link": "https://cyble.com/talk-to-sales/"
                                }
                            }
                        },
                        {
                            "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'CybleVisionPoller', parameters('guidValue'))]",
                            "apiVersion": "2023-02-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "RestApiPoller",
                            "properties": {
                                "connectorDefinitionName": "CybleVisionAlerts",
                                "dataType": "CybleVisionAlerts_CL",
                                "dcrConfig": {
                                    "streamName": "Custom-CybleVisionAlerts_CL",
                                    "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                    "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                                },
                                "auth": {
                                    "type": "APIKey",
                                    "ApiKey": "[[parameters('ApiToken')]",
                                    "ApiKeyName": "Authorization",
                                    "ApiKeyIdentifier": "Bearer"
                                },
                                "request": {
                                    "apiEndpoint": "https://bifrost.cyble.ai/ar-apollo-v2/api/v2/y/alerts",
                                    "httpMethod": "POST",
                                    "queryWindowInMin": 10,
                                    "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                                    "rateLimitQps": 1,
                                    "retryCount": 3,
                                    "timeoutInSeconds": 60,
                                    "headers": {
                                        "Content-Type": "application/json",
                                        "Accept": "application/json"
                                    },
                                    "isPostPayloadJson": true,
                                    "queryParametersTemplate": "{ \"orderBy\": [ { \"created_at\": \"desc\" }, { \"updated_at\": \"desc\" } ], \"filters\": { \"updated_at\": { \"gte\": \"2025-11-18T13:38:00.000Z\", \"lte\": \"2025-11-18T13:40:00.000Z\" }, \"user_severity\": [ \"LOW\", \"MEDIUM\", \"HIGH\" ] }, \"excludes\": { \"status\": [ \"FALSE_POSITIVE\" ] }, \"skip\": 0, \"take\": 10 }"
                                },
                                "response": {
                                    "format": "json",
                                    "eventsJsonPaths": [
                                        "$.data.*"
                                    ]
                                },
                                "paging": {
                                    "pagingType": "Offset",
                                    "pageSizeParameterName": "take",
                                    "pageSize": 10,
                                    "offsetParaName": "skip"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "Cyble-IOC-Enrichment-Playbook Playbook with template version 3.0.2",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion1')]",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "Cyble-IOC-Enrichment-Playbook",
                            "type": "String"
                        },
                        "ScheduleFrequencyInMinutes": {
                            "defaultValue": "60",
                            "type": "String"
                        },
                        "CybleApiBearerToken": {
                            "defaultValue": "",
                            "type": "securestring"
                        },
                        "WorkspaceID": {
                            "defaultValue": "",
                            "type": "String"
                        }
                    },
                    "variables": {
                        "apiConnectionResourceName": "[[concat(parameters('PlaybookName'), '-ti-conn-', uniqueString(resourceGroup().id, parameters('PlaybookName')))]",
                        "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/',  variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('apiConnectionResourceName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "properties": {
                                "displayName": "[[variables('apiConnectionResourceName')]",
                                "api": {
                                    "id": "[[variables('_connection-1')]",
                                    "type": "Microsoft.Web/locations/managedApis"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2017-07-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('apiConnectionResourceName'))]"
                            ],
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "properties": {
                                "state": "Enabled",
                                "parameters": {
                                    "ScheduleFrequencyInMinutes": {
                                        "type": "String",
                                        "value": "[[parameters('ScheduleFrequencyInMinutes')]"
                                    },
                                    "CybleApiBearerToken": {
                                        "type": "SecureString",
                                        "value": "[[parameters('CybleApiBearerToken')]"
                                    },
                                    "WorkspaceID": {
                                        "type": "String",
                                        "value": "[[parameters('WorkspaceID')]"
                                    },
                                    "$connections": {
                                        "type": "Object",
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('apiConnectionResourceName'))]",
                                                "connectionName": "[[variables('apiConnectionResourceName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/',  variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                                "alternativeParameterValues": {
                                                    "authenticationType": "ManagedServiceIdentity"
                                                }
                                            }
                                        }
                                    }
                                },
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "ScheduleFrequencyInMinutes": {
                                            "type": "String"
                                        },
                                        "CybleApiBearerToken": {
                                            "type": "SecureString"
                                        },
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "WorkspaceID": {
                                            "type": "String"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Parse_FullIncident": {
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@triggerOutputs()?['body/object']",
                                                "schema": {
                                                    "type": "object",
                                                    "properties": {
                                                        "Properties": {
                                                            "type": "object",
                                                            "properties": {
                                                                "relatedEntities": {
                                                                    "type": "string"
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "Parse_Entities": {
                                            "runAfter": {
                                                "Parse_FullIncident": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Parse_FullIncident')?['Properties']?['relatedEntities']",
                                                "schema": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "object"
                                                    }
                                                }
                                            }
                                        },
                                        "Initialize_Enrichment_Array": {
                                            "runAfter": {
                                                "Parse_Entities": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "FormattedComments",
                                                        "type": "Array",
                                                        "value": "[variables('TemplateEmptyArray')]"
                                                    }
                                                ]
                                            }
                                        },
                                        "For_each_Entity": {
                                            "foreach": "@body('Parse_Entities')",
                                            "actions": {
                                                "HTTP_Get_IOC_Data": {
                                                    "type": "Http",
                                                    "inputs": {
                                                        "uri": "@concat('https://api.cyble.ai/engine/api/v2/y/iocs?ioc=', coalesce(if(equals(toLower(item()?['kind']),'filehash'), item()?['properties']?['hashValue'], null), if(equals(toLower(item()?['kind']),'ip'), item()?['properties']?['address'], null), if(equals(toLower(item()?['kind']),'url'), item()?['properties']?['url'], null), if(equals(toLower(item()?['kind']),'host'), item()?['properties']?['hostName'], null), if(equals(toLower(item()?['kind']),'mailbox'), item()?['properties']?['mailboxPrimaryAddress'], null), ''))",
                                                        "method": "GET",
                                                        "headers": {
                                                            "Authorization": "@concat('Bearer ', parameters('CybleApiBearerToken'))",
                                                            "Content-Type": "application/json"
                                                        }
                                                    }
                                                },
                                                "Parse_IOC_Response": {
                                                    "runAfter": {
                                                        "HTTP_Get_IOC_Data": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('HTTP_Get_IOC_Data')",
                                                        "schema": {
                                                            "type": "object",
                                                            "properties": {
                                                                "success": {
                                                                    "type": "boolean"
                                                                },
                                                                "data": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "iocs": {
                                                                            "type": [
                                                                                "array",
                                                                                "null"
                                                                            ],
                                                                            "items": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "ioc": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "ioc_type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "first_seen": {
                                                                                        "type": "number"
                                                                                    },
                                                                                    "last_seen": {
                                                                                        "type": "number"
                                                                                    },
                                                                                    "risk_score": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "sources": {
                                                                                        "type": "array",
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "behaviour_tags": {
                                                                                        "type": [
                                                                                            "array",
                                                                                            "null"
                                                                                        ],
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "confidence_rating": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "target_countries": {
                                                                                        "type": [
                                                                                            "array",
                                                                                            "null"
                                                                                        ],
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "target_regions": {
                                                                                        "type": [
                                                                                            "array",
                                                                                            "null"
                                                                                        ],
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "target_industries": {
                                                                                        "type": [
                                                                                            "array",
                                                                                            "null"
                                                                                        ],
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    },
                                                                                    "related_malware": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "related_threat_actors": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "is_whitelisted": {
                                                                                        "type": "boolean"
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "pagination": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "total_count": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "page": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "limit": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "Compose_Formatted_Comment": {
                                                    "runAfter": {
                                                        "Parse_IOC_Response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@concat(\n  '---\\n**Entity:** ', coalesce(item()?['properties']?['address'], item()?['properties']?['hostName'], item()?['properties']?['url'], item()?['properties']?['mailboxPrimaryAddress'], item()?['properties']?['hashValue'], 'Unknown'), '\\n',\n  if(\n    equals(body('Parse_IOC_Response')?['success'], true),\n    concat(\n      '**IOC:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'No IOCs found.',\n          first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['ioc']\n        ), '\\n',\n      '**Type:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['ioc_type']\n        ), '\\n',\n      '**Risk Score:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['risk_score'])\n        ), '\\n',\n      '**Confidence Rating:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['confidence_rating']\n        ), '\\n',\n      '**Sources:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          join(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['sources'], ', ')\n        ), '\\n',\n      '**Malware:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['related_malware'])\n        ), '\\n',\n      '**Threat Actors:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['related_threat_actors'])\n        ), '\\n',\n      '**Behavior Tags:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          if(\n            or(\n              equals(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['behaviour_tags'], null),\n              equals(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['behaviour_tags'], 'null')\n            ),\n            'None',\n            join(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['behaviour_tags'], ', ')\n          )\n        ), '\\n',\n      '**First Seen:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['first_seen'])\n        ), '\\n',\n      '**Last Seen:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['last_seen'])\n        ), '\\n',\n      '**Is Whitelisted:** ',\n        if(\n          equals(\n            length(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))),\n            0\n          ),\n          'N/A',\n          string(first(coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]')))?['is_whitelisted'])\n        ), '\\n'\n    ),\n    'API returned an error or no data available.\\n'\n  )\n)"
                                                },
                                                "Append_Comment_to_Array": {
                                                    "runAfter": {
                                                        "Compose_Formatted_Comment": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "AppendToArrayVariable",
                                                    "inputs": {
                                                        "name": "FormattedComments",
                                                        "value": "@outputs('Compose_Formatted_Comment')"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_Enrichment_Array": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Check_If_Comments_Not_Empty": {
                                            "actions": {
                                                "Add_comment_to_incident_(V3)": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "incidentArmId": "@body('Parse_FullIncident')?['id']",
                                                            "message": "<p class=\"editor-paragraph\">@{concat('**IOC Enrichment Results**\\\\n\\\\n', join(variables('FormattedComments'), '\\\\n'))}</p>"
                                                        },
                                                        "path": "/Incidents/Comment"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "For_each_Entity": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "No_Comments_Skip": {
                                                        "type": "Compose",
                                                        "inputs": "No enriched IOCs found; skipping comment."
                                                    }
                                                }
                                            },
                                            "expression": "@greater(length(variables('FormattedComments')), 0)",
                                            "type": "If"
                                        }
                                    }
                                }
                            },
                            "tags": {
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId1')]",
                                "contentId": "[variables('_playbookContentId1')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Cyble Vision",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Cyble Inc"
                                },
                                "support": {
                                    "name": "Cyble Support",
                                    "email": "csm@cyble.com",
                                    "tier": "Partner",
                                    "link": "https://cyble.com/talk-to-sales/"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "Cyble-IOC_Enrichment-Playbook",
                        "description": "This playbook leverages the Cyble API to enrich IP, Domain, Url & Hash indicators, found in Microsoft Sentinel incidents, with the following context: Risk Score, Confidence, etc. The enrichment content will be posted as a comment in the Microsoft Sentinel incident",
                        "prerequisites": [
                            "To use the Cyble Endpoints for Azure connector, you will need a valid API token from Cyble Vision platform."
                        ],
                        "postDeployment": [
                            ""
                        ],
                        "lastUpdateTime": "2025-05-06T00:00:00Z",
                        "entities": [
                            "ip",
                            "url",
                            "filehash"
                        ],
                        "tags": [
                            "Enrichment"
                        ],
                        "releaseNotes": [
                            {
                                "version": "1.0",
                                "title": "Cyble-IOC_Enrichment",
                                "notes": [
                                    "Initial version"
                                ]
                            }
                        ],
                        "basics": {
                            "displayName": "Cyble IOC Enrichment",
                            "description": "Enrich IOCs using the Cyble Threat Intelligence API.",
                            "category": "Threat Intelligence"
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId1')]",
                "contentKind": "Playbook",
                "displayName": "Cyble-IOC-Enrichment-Playbook",
                "contentProductId": "[variables('_playbookcontentProductId1')]",
                "id": "[variables('_playbookcontentProductId1')]",
                "version": "[variables('playbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName2')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "Cyble-TI-Ingest-Playbook Playbook with template version 3.0.2",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion2')]",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "Cyble-TI-Ingest-Playbook",
                            "type": "string"
                        },
                        "ScheduleFrequencyInMinutes": {
                            "defaultValue": "60",
                            "type": "string"
                        },
                        "CybleApiBearerToken": {
                            "defaultValue": "",
                            "type": "securestring"
                        },
                        "WorkspaceID": {
                            "defaultValue": "",
                            "type": "string"
                        },
                        "logAnalyticsWorkspaceName": {
                            "defaultValue": "please enter your workspace name",
                            "type": "string"
                        }
                    },
                    "variables": {
                        "apiConnectionResourceName": "[[concat(parameters('PlaybookName'), '-ti-connection')]",
                        "AzuremonitorlogsConnectionName": "[[concat('Azuremonitorlogs-', parameters('PlaybookName'))]",
                        "logAnalyticsWorkspaceName": "[[parameters('logAnalyticsWorkspaceName')]",
                        "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "_connection-1": "[[variables('connection-1')]",
                        "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]",
                        "_connection-2": "[[variables('connection-2')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('apiConnectionResourceName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "properties": {
                                "displayName": "[[variables('apiConnectionResourceName')]",
                                "api": {
                                    "id": "[[variables('_connection-1')]",
                                    "type": "Microsoft.Web/locations/managedApis"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzuremonitorlogsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzuremonitorlogsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-2')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Logic/workflows",
                            "apiVersion": "2017-07-01",
                            "name": "[[parameters('PlaybookName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('apiConnectionResourceName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]"
                            ],
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "properties": {
                                "state": "Enabled",
                                "parameters": {
                                    "ScheduleFrequencyInMinutes": {
                                        "type": "String",
                                        "value": "[[parameters('ScheduleFrequencyInMinutes')]"
                                    },
                                    "CybleApiBearerToken": {
                                        "type": "securestring",
                                        "value": "[[parameters('CybleApiBearerToken')]"
                                    },
                                    "WorkspaceID": {
                                        "type": "String",
                                        "value": "[[parameters('WorkspaceID')]"
                                    },
                                    "$connections": {
                                        "type": "Object",
                                        "value": {
                                            "azuresentinel": {
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('apiConnectionResourceName'))]",
                                                "connectionName": "[[variables('apiConnectionResourceName')]"
                                            },
                                            "azuremonitorlogs": {
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuremonitorlogs')]",
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                                                "connectionName": "[[variables('AzuremonitorlogsConnectionName')]"
                                            }
                                        }
                                    }
                                },
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "ScheduleFrequencyInMinutes": {
                                            "type": "String"
                                        },
                                        "CybleApiBearerToken": {
                                            "type": "SecureString"
                                        },
                                        "WorkspaceID": {
                                            "type": "String"
                                        },
                                        "$connections": {
                                            "type": "Object"
                                        }
                                    },
                                    "triggers": {
                                        "Recurrence_Trigger": {
                                            "recurrence": {
                                                "frequency": "Minute",
                                                "interval": "@int(parameters('ScheduleFrequencyInMinutes'))"
                                            },
                                            "evaluatedRecurrence": {
                                                "frequency": "Minute",
                                                "interval": 60
                                            },
                                            "type": "Recurrence"
                                        }
                                    },
                                    "actions": {
                                        "Initialize_StartDateTimeFull": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "StartDateTimeFull",
                                                        "type": "String",
                                                        "value": "@formatDateTime(addMinutes(utcNow(), mul(-1, int(parameters('ScheduleFrequencyInMinutes')))), 'yyyy-MM-ddTHH:mm:ssZ')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_EndDateTimeFull": {
                                            "runAfter": {
                                                "Initialize_StartDateTimeFull": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "EndDateTimeFull",
                                                        "type": "String",
                                                        "value": "@{formatDateTime(utcNow(), 'yyyy-MM-ddTHH:mm:ssZ')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "HTTP_Get_IOC_Data": {
                                            "runAfter": {
                                                "Initialize_existingIoCs": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@concat('https://api.cyble.ai/engine/api/v2/y/iocs?sortBy=last_seen&order=desc&limit=100&startDate=', variables('StartDateTimeFull'), '&endDate=', variables('EndDateTimeFull'))",
                                                "method": "GET",
                                                "headers": {
                                                    "Authorization": "@{concat('Bearer ', parameters('CybleApiBearerToken'))}",
                                                    "Content-Type": "application/json"
                                                }
                                            }
                                        },
                                        "For_Each_IOC": {
                                            "foreach": "@variables('rawIocs')",
                                            "actions": {
                                                "Condition": {
                                                    "actions": {
                                                        "Check_If_in_lastNmins": {
                                                            "actions": {
                                                                "Upload_Indicators_v2": {
                                                                    "type": "ApiConnection",
                                                                    "inputs": {
                                                                        "host": {
                                                                            "connection": {
                                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                            }
                                                                        },
                                                                        "method": "post",
                                                                        "body": {
                                                                            "sourcesystem": "CybleVision",
                                                                            "indicators": [
                                                                                {
                                                                                    "DisplayName": "@item()?['ioc']",
                                                                                    "Name": "@item()?['ioc']",
                                                                                    "IndicatorValue": "@item()?['ioc']",
                                                                                    "IndicatorType": "@if(equals(item()?['ioc_type'],'FileHash-SHA256'),'filehash-sha256',if(equals(item()?['ioc_type'],'IPv4'),'ipv4address','url'))",
                                                                                    "ThreatType": "malicious-activity",
                                                                                    "Confidence": "@if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 80), 5, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 60), 4, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 40), 3, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 20), 2, 1))))",
                                                                                    "SeverityLevel": "@if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 80), 5, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 60), 4, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 40), 3, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 20), 2, 1))))",
                                                                                    "severity_level": "@if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 80), 5, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 60), 4, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 40), 3, if(greaterOrEquals(coalesce(item()?['risk_score'], 0), 20), 2, 1))))",
                                                                                    "Tags": [
                                                                                        "@coalesce(item()?['confidence_rating'],'Unknown')"
                                                                                    ],
                                                                                    "ExpirationDateTime": "@addDays(utcNow(),7)",
                                                                                    "description": "IOC from Cyble",
                                                                                    "labels": [
                                                                                        "@join(coalesce(item()?['behaviour_tags'], json('[]')), ',')"
                                                                                    ],
                                                                                    "pattern": "@if(equals(item()?['ioc_type'],'FileHash-SHA256'), concat('[[file:hashes.''SHA-256'' = ''', item()?['ioc'], ''']]'), if(equals(item()?['ioc_type'],'IPv4'), concat('[[ipv4-addr:value = ''', item()?['ioc'], ''']]'), concat('[[url:value = ''', item()?['ioc'], ''']]')))",
                                                                                    "valid_from": "@utcNow()",
                                                                                    "type": "indicator",
                                                                                    "id": "@concat('indicator--', guid())",
                                                                                    "created": "@utcNow()",
                                                                                    "modified": "@utcNow()",
                                                                                    "pattern_type": "stix",
                                                                                    "spec_version": "2.1"
                                                                                }
                                                                            ]
                                                                        },
                                                                        "path": "/V2/ThreatIntelligence/@{encodeURIComponent(parameters('WorkspaceID'))}/UploadIndicators/",
                                                                        "retryPolicy": {
                                                                            "type": "exponential",
                                                                            "count": 5,
                                                                            "interval": "PT15S"
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@and(\n  greaterOrEquals(\n    item()?['last_seen'],\n    div(\n      sub(\n        ticks(variables('StartDateTimeFull')),\n        ticks('1970-01-01T00:00:00Z')\n      ),\n      10000000\n    )\n  ),\n  lessOrEquals(\n    item()?['last_seen'],\n    div(\n      sub(\n        ticks(variables('EndDateTimeFull')),\n        ticks('1970-01-01T00:00:00Z')\n      ),\n      10000000\n    )\n  )\n)",
                                                            "type": "If"
                                                        }
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Increment_variable": {
                                                                "type": "IncrementVariable",
                                                                "inputs": {
                                                                    "name": "skippedCounter",
                                                                    "value": 1
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@not(contains(variables('existingIocs'), item()?['ioc']))",
                                                                    ""
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_skippedCounter": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 1
                                                }
                                            }
                                        },
                                        "Compose": {
                                            "runAfter": {
                                                "Get_Iocs_Per_Page": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@variables('existingIocs')"
                                        },
                                        "Initialize_skippedCounter": {
                                            "runAfter": {
                                                "Compose": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "skippedCounter",
                                                        "type": "integer",
                                                        "value": 0
                                                    }
                                                ]
                                            }
                                        },
                                        "Compose_1": {
                                            "runAfter": {
                                                "For_Each_IOC": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@variables('skippedCounter')"
                                        },
                                        "Initialize_Page_Number": {
                                            "runAfter": {
                                                "Initialize_EndDateTimeFull": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "PageNumber",
                                                        "type": "integer",
                                                        "value": 1
                                                    }
                                                ]
                                            }
                                        },
                                        "Parse_JSON": {
                                            "runAfter": {
                                                "HTTP_Get_IOC_Data": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('HTTP_Get_IOC_Data')",
                                                "schema": {
                                                    "type": "object",
                                                    "properties": {
                                                        "data": {
                                                            "type": "object",
                                                            "properties": {
                                                                "iocs": {
                                                                    "type": [
                                                                        "array",
                                                                        "null"
                                                                    ]
                                                                },
                                                                "pagination": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "total_count": {
                                                                            "type": [
                                                                                "integer",
                                                                                "null"
                                                                            ]
                                                                        },
                                                                        "page": {
                                                                            "type": [
                                                                                "integer",
                                                                                "null"
                                                                            ]
                                                                        },
                                                                        "limit": {
                                                                            "type": [
                                                                                "integer",
                                                                                "null"
                                                                            ]
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "success": {
                                                            "type": "boolean"
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "Initialize_Limit": {
                                            "runAfter": {
                                                "Initialize_Page_Number": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "Limit",
                                                        "type": "integer",
                                                        "value": 100
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_TotalPages": {
                                            "runAfter": {
                                                "Initialize_Limit": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "TotalPages",
                                                        "type": "integer",
                                                        "value": 0
                                                    }
                                                ]
                                            }
                                        },
                                        "Set_TotalPages": {
                                            "runAfter": {
                                                "Parse_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "TotalPages",
                                                "value": "@div(add(int(body('Parse_JSON')?['data']?['pagination']?['total_count']), sub(variables('limit'), 1)), variables('limit'))\n"
                                            }
                                        },
                                        "Initialize_rawIoCs": {
                                            "runAfter": {
                                                "Initialize_TotalPages": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "rawIocs",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_iocArray": {
                                            "runAfter": {
                                                "Initialize_rawIoCs": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "iocArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Get_Iocs_Per_Page": {
                                            "foreach": "@range(1, variables('TotalPages'))",
                                            "actions": {
                                                "HTTP_Get_Iocs_Per_Page": {
                                                    "runAfter": {
                                                        "Set_PageNumber": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "uri": "@concat('https://api.cyble.ai/engine/api/v2/y/iocs?sortBy=last_seen&order=desc&limit=', string(variables('Limit')), '&page=', string(variables('PageNumber')), '&startDate=', variables('StartDateTimeFull'), '&endDate=', variables('EndDateTimeFull'))\n",
                                                        "method": "GET",
                                                        "headers": {
                                                            "Content-Type": "application/json",
                                                            "Authorization": "@{concat('Bearer ', parameters('CybleApiBearerToken'))}"
                                                        }
                                                    },
                                                    "runtimeConfiguration": {
                                                        "contentTransfer": {
                                                            "transferMode": "Chunked"
                                                        }
                                                    }
                                                },
                                                "Set_PageNumber": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "PageNumber",
                                                        "value": "@items('Get_Iocs_Per_Page')"
                                                    }
                                                },
                                                "Parse_IOC_Response": {
                                                    "runAfter": {
                                                        "HTTP_Get_Iocs_Per_Page": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('HTTP_Get_IOC_Data')",
                                                        "schema": {
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "For_each": {
                                                    "foreach": "@coalesce(body('Parse_IOC_Response')?['data']?['iocs'], json('[]'))",
                                                    "actions": {
                                                        "Append_to_rawIoCs": {
                                                            "runAfter": {
                                                                "Append_to_iocArrray": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "rawIocs",
                                                                "value": "@item()"
                                                            }
                                                        },
                                                        "Append_to_iocArrray": {
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "iocArray",
                                                                "value": "@{concat('\"', items('For_each')?['ioc'], '\"')\n}\n"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_IOC_Response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                },
                                                "FinalIOCList": {
                                                    "runAfter": {
                                                        "For_each": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@concat('[', join(variables('iocArray'), ','), ']')"
                                                },
                                                "KQLQuery": {
                                                    "runAfter": {
                                                        "FinalIOCList": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@replace(\n  'let iocs = dynamic(PLACEHOLDER); ThreatIntelIndicators | where ObservableValue in (iocs) | order by TimeGenerated desc',\n  'PLACEHOLDER',\n  outputs('FinalIOCList')\n)"
                                                },
                                                "GetExistingIoCs": {
                                                    "runAfter": {
                                                        "KQLQuery": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": "@{outputs('KQLQuery')}",
                                                        "path": "/queryData",
                                                        "queries": {
                                                            "subscriptions": "[[subscription().subscriptionId]",
                                                            "resourcegroups": "[[resourceGroup().name]",
                                                            "resourcetype": "Log Analytics Workspace",
                                                            "resourcename": "[[variables('logAnalyticsWorkspaceName')]",
                                                            "timerange": "Last 7 days"
                                                        }
                                                    }
                                                },
                                                "Parse_KQL": {
                                                    "runAfter": {
                                                        "GetExistingIoCs": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('GetExistingIoCs')",
                                                        "schema": {
                                                            "value": [
                                                                {
                                                                    "ObservableValue": "16f97a927458e2c1af1a03e546730a9251f136b85fdd136dd85a091bc65cb44f"
                                                                }
                                                            ]
                                                        }
                                                    }
                                                },
                                                "For_each_existing_IOC": {
                                                    "foreach": "@body('Parse_KQL')?['value']\n",
                                                    "actions": {
                                                        "Append_to_existingIoCs": {
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "existingIocs",
                                                                "value": "@items('For_each_existing_IOC')?['ObservableValue']"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_KQL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                }
                                            },
                                            "runAfter": {
                                                "Set_TotalPages": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Initialize_existingIoCs": {
                                            "runAfter": {
                                                "Initialize_iocArray": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "existingIocs",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        }
                                    }
                                }
                            },
                            "tags": {
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId2')]",
                                "contentId": "[variables('_playbookContentId2')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion2')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "Cyble Vision",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Cyble Inc"
                                },
                                "support": {
                                    "name": "Cyble Support",
                                    "email": "csm@cyble.com",
                                    "tier": "Partner",
                                    "link": "https://cyble.com/talk-to-sales/"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "Cyble-ThreatIntelligence-Ingest-Playbook",
                        "description": "This playbook imports IoC lists from Cyble and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on Cyble-ThreatIntelligence-Ingest that need to be installed **manually** before installing this playbook.",
                        "prerequisites": [
                            "First install the Cyble-ThreatIntelligenceImport playbook.",
                            "To use the Cyble for Azure connector, you will need a valid API token from Cyble"
                        ],
                        "lastUpdateTime": "2025-05-06T00:00:00Z",
                        "tags": [
                            "Threat Intelligence"
                        ],
                        "releaseNotes": [
                            {
                                "version": "1.0",
                                "title": "Cyble-ThreatIntelligence-Ingest",
                                "description": "This playbook imports IoC lists from Cyble and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on Cyble-ThreatIntelligence-Ingest that need to be installed **manually** before installing this playbook.",
                                "prerequisites": [
                                    "First install the Cyble-ThreatIntelligenceImport playbook.",
                                    "To use the Cyble for Azure connector, you will need a valid API token from Cyble"
                                ],
                                "prerequisitesDeployTemplateFile": "../azuredeploy.json",
                                "lastUpdateTime": "2025-05-06T00:00:00Z",
                                "entities": [],
                                "tags": [
                                    "Threat Intelligence"
                                ],
                                "support": {
                                    "tier": "Partner",
                                    "armtemplate": "Generated from https://github.com/Azure/Azure-Sentinel/tree/master/Tools/Playbook-ARM-Template-Generator"
                                },
                                "author": {
                                    "name": "Cyble Inc."
                                },
                                "releaseNotes": [
                                    {
                                        "version": "1.0",
                                        "title": "Cyble-ThreatIntelligence-Ingest",
                                        "notes": [
                                            "Initial version"
                                        ]
                                    }
                                ]
                            }
                        ],
                        "basics": {
                            "displayName": "Cyble Threat Intelligence Ingestion",
                            "description": "Import IOCs using the Cyble Threat Intelligence API.",
                            "category": "Threat Intelligence"
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId2')]",
                "contentKind": "Playbook",
                "displayName": "Cyble-TI-Ingest-Playbook",
                "contentProductId": "[variables('_playbookcontentProductId2')]",
                "id": "[variables('_playbookcontentProductId2')]",
                "version": "[variables('playbookVersion2')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.2",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "Cyble Vision",
                "publisherDisplayName": "Cyble Support",
                "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Cyble%20Vision/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>This Solution provides Playbooks for Cyble Vision Threat Intelligence ingestion and IOC enrichment, integrating Cyble APIs.</p>\n<p>This Solution also includes a CCF Conenctor which enables Alerts ingestion from Cyble Platform to Microsoft Sentinel Workspace.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Playbooks:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                "contentKind": "Solution",
                "contentProductId": "[variables('_solutioncontentProductId')]",
                "id": "[variables('_solutioncontentProductId')]",
                "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/CybleLogo.svg\" width=\"75px\" height=\"75px\">",
                "contentId": "[variables('_solutionId')]",
                "parentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "Cyble Vision",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Cyble Inc"
                },
                "support": {
                    "name": "Cyble Support",
                    "email": "csm@cyble.com",
                    "tier": "Partner",
                    "link": "https://cyble.com/talk-to-sales/"
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                            "version": "[variables('dataConnectorCCPVersion')]"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_IoC-Enrichment')]",
                            "version": "[variables('playbookVersion1')]"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_TI-Ingest')]",
                            "version": "[variables('playbookVersion2')]"
                        }
                    ]
                },
                "firstPublishDate": "2025-05-05",
                "providers": [
                    "Cyble"
                ],
                "categories": {
                    "domains": [
                        "Security - Threat Protection"
                    ]
                }
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
        }
    ],
    "outputs": {}
}