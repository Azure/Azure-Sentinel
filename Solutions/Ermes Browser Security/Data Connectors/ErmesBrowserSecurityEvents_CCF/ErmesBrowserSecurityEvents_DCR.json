[{
	"name": "ErmesOauthDCR1",
	"apiVersion": "2021-09-01-preview",
	"type": "Microsoft.Insights/dataCollectionRules",
	"location": "{{location}}",
	"properties": {
		"dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
		"streamDeclarations": {
			"Custom-Ermes_ClientCredentials": {
				"columns": [
					{
						"name": "_created",
						"type": "string",
						"description": "Event creation timestamp (server ingestion/generation time)"
					},
					{
						"name": "timestamp",
						"type": "string",
						"description": "Event timestamp"
					},
					{
						"name": "username",
						"type": "string",
						"description": "Username"
					},
					{
						"name": "client_ip",
						"type": "string",
						"description": "Client IP"
					},
					{
						"name": "level",
						"type": "string",
						"description": "Event priority level (INFO, WARNING, etc)"
					},
					{
						"name": "event_cat",
						"type": "string",
						"description": "Event Category"
					},
					{
						"name": "event_id",
						"type": "string",
						"description": "Event Id"
					},
					{
						"name": "message",
						"type": "dynamic",
						"description": "Message"
					},
					{
						"name": "log_data",
						"type": "dynamic",
						"description": "Event-specific log data"
					}
				]
			}
		},
		"destinations": {
			"logAnalytics": [
				{
					"workspaceResourceId": "{{workspaceResourceId}}",
					"name": "clv2ws1"
				}
			]
		},
		"dataFlows": [
			{
				"streams": [
					"Custom-Ermes_ClientCredentials"
				],
				"destinations": [
					"clv2ws1"
				],
				"transformKql": "source | extend actual_timestamp = iff(isnotnull(timestamp), todatetime(timestamp), todatetime([\"_created\"])) | extend log_data_final = case(event_cat in (\"general\", \"dashboard_auth\", \"dashboard_audit\", \"device_status\"), parse_json('null'), log_data) | project TimeGenerated = actual_timestamp, Username = username, ClientIP = client_ip, EventCategory = event_cat, EventId = event_id, Level = level, Message = tostring(message.en), LogData = log_data_final",
				"outputStream": "Custom-ErmesBrowserSecurityEvents_CL"
			}
		]
	}
}]
