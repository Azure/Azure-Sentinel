{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Recorded Future Premier Integrations - support@recordedfuture.com",
    "comments": "Solution template for Recorded Future"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Recorded Future - Playbook Alerts Overview",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook2-name": {
      "type": "string",
      "defaultValue": "Recorded Future - Alerts Overview",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook3-name": {
      "type": "string",
      "defaultValue": "Recorded Future - Domain Correlation",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook4-name": {
      "type": "string",
      "defaultValue": "Recorded Future - Hash Correlation",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook5-name": {
      "type": "string",
      "defaultValue": "Recorded Future - IP Correlation",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "workbook6-name": {
      "type": "string",
      "defaultValue": "Recorded Future - URL Correlation",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "email": "support@recordedfuture.com",
    "_email": "[variables('email')]",
    "_solutionName": "Recorded Future",
    "_solutionVersion": "3.0.0",
    "solutionId": "recordedfuture1605638642586.recorded_future_sentinel_solution",
    "_solutionId": "[variables('solutionId')]",
    "analyticRuleVersion1": "1.0.1",
    "analyticRulecontentId1": "a1c02815-4248-4728-a9ae-dac73c67db23",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1'))))]",
    "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId1'),'-', variables('analyticRuleVersion1'))))]",
    "analyticRuleVersion2": "1.0.1",
    "analyticRulecontentId2": "dffd068f-fdab-440e-bbc0-34c14b623c89",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2'))))]",
    "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId2'),'-', variables('analyticRuleVersion2'))))]",
    "analyticRuleVersion3": "1.0.0",
    "analyticRulecontentId3": "388e197d-ec9e-46b6-addb-947d74d2a5c4",
    "_analyticRulecontentId3": "[variables('analyticRulecontentId3')]",
    "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId3'))))]",
    "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId3'),'-', variables('analyticRuleVersion3'))))]",
    "analyticRuleVersion4": "1.0.0",
    "analyticRulecontentId4": "588dc717-7583-452c-a743-dee96705898e",
    "_analyticRulecontentId4": "[variables('analyticRulecontentId4')]",
    "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId4'))]",
    "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId4'))))]",
    "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId4'),'-', variables('analyticRuleVersion4'))))]",
    "analyticRuleVersion5": "1.0.0",
    "analyticRulecontentId5": "22cc1dff-14ad-481d-97e1-0602895e429e",
    "_analyticRulecontentId5": "[variables('analyticRulecontentId5')]",
    "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId5'))]",
    "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId5'))))]",
    "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId5'),'-', variables('analyticRuleVersion5'))))]",
    "analyticRuleVersion6": "1.0.0",
    "analyticRulecontentId6": "9acb3664-72c4-4676-80fa-9f81912e347e",
    "_analyticRulecontentId6": "[variables('analyticRulecontentId6')]",
    "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId6'))]",
    "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId6'))))]",
    "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-',variables('_analyticRulecontentId6'),'-', variables('analyticRuleVersion6'))))]",
    "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
    "_RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash": "[variables('RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash')]",
    "playbookVersion1": "2.5",
    "playbookContentId1": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "RecordedFuture-Sandbox_Enrichment-Url": "RecordedFuture-Sandbox_Enrichment-Url",
    "_RecordedFuture-Sandbox_Enrichment-Url": "[variables('RecordedFuture-Sandbox_Enrichment-Url')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "RecordedFuture-Sandbox_Enrichment-Url",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "RecordedFuture-Playbook-Alert-Importer": "RecordedFuture-Playbook-Alert-Importer",
    "_RecordedFuture-Playbook-Alert-Importer": "[variables('RecordedFuture-Playbook-Alert-Importer')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "RecordedFuture-Playbook-Alert-Importer",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "RecordedFuture-Alert-Importer": "RecordedFuture-Alert-Importer",
    "_RecordedFuture-Alert-Importer": "[variables('RecordedFuture-Alert-Importer')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "RecordedFuture-Alert-Importer",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "RecordedFuture-ThreatIntelligenceImport": "RecordedFuture-ThreatIntelligenceImport",
    "_RecordedFuture-ThreatIntelligenceImport": "[variables('RecordedFuture-ThreatIntelligenceImport')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "RecordedFuture-ThreatIntelligenceImport",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5'))))]",
    "_playbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId5'),'-', variables('playbookVersion5'))))]",
    "RecordedFuture-Domain-IndicatorImport": "RecordedFuture-Domain-IndicatorImport",
    "_RecordedFuture-Domain-IndicatorImport": "[variables('RecordedFuture-Domain-IndicatorImport')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "RecordedFuture-Domain-IndicatorImport",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6'))))]",
    "_playbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId6'),'-', variables('playbookVersion6'))))]",
    "RecordedFuture-Hash-IndicatorImport": "RecordedFuture-Hash-IndicatorImport",
    "_RecordedFuture-Hash-IndicatorImport": "[variables('RecordedFuture-Hash-IndicatorImport')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "RecordedFuture-Hash-IndicatorImport",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7'))))]",
    "_playbookcontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId7'),'-', variables('playbookVersion7'))))]",
    "RecordedFuture-IP-IndicatorImport": "RecordedFuture-IP-IndicatorImport",
    "_RecordedFuture-IP-IndicatorImport": "[variables('RecordedFuture-IP-IndicatorImport')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "RecordedFuture-IP-IndicatorImport",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8'))))]",
    "_playbookcontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId8'),'-', variables('playbookVersion8'))))]",
    "RecordedFuture-URL-IndicatorImport": "RecordedFuture-URL-IndicatorImport",
    "_RecordedFuture-URL-IndicatorImport": "[variables('RecordedFuture-URL-IndicatorImport')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "RecordedFuture-URL-IndicatorImport",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9'))))]",
    "_playbookcontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId9'),'-', variables('playbookVersion9'))))]",
    "RecordedFuture-ImportToSentinel": "RecordedFuture-ImportToSentinel",
    "_RecordedFuture-ImportToSentinel": "[variables('RecordedFuture-ImportToSentinel')]",
    "playbookVersion10": "1.1",
    "playbookContentId10": "RecordedFuture-ImportToSentinel",
    "_playbookContentId10": "[variables('playbookContentId10')]",
    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10'))))]",
    "_playbookcontentProductId10": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId10'),'-', variables('playbookVersion10'))))]",
    "RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor": "RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor",
    "_RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor": "[variables('RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor')]",
    "playbookVersion11": "1.1",
    "playbookContentId11": "RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor",
    "_playbookContentId11": "[variables('playbookContentId11')]",
    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11'))))]",
    "_playbookcontentProductId11": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId11'),'-', variables('playbookVersion11'))))]",
    "RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor": "RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor",
    "_RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor": "[variables('RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor')]",
    "playbookVersion12": "1.1",
    "playbookContentId12": "RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor",
    "_playbookContentId12": "[variables('playbookContentId12')]",
    "playbookId12": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId12'))]",
    "playbookTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId12'))))]",
    "_playbookcontentProductId12": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId12'),'-', variables('playbookVersion12'))))]",
    "RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor": "RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor",
    "_RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor": "[variables('RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor')]",
    "playbookVersion13": "1.1",
    "playbookContentId13": "RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor",
    "_playbookContentId13": "[variables('playbookContentId13')]",
    "playbookId13": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId13'))]",
    "playbookTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId13'))))]",
    "_playbookcontentProductId13": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId13'),'-', variables('playbookVersion13'))))]",
    "RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor": "RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor",
    "_RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor": "[variables('RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor')]",
    "playbookVersion14": "1.1",
    "playbookContentId14": "RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor",
    "_playbookContentId14": "[variables('playbookContentId14')]",
    "playbookId14": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId14'))]",
    "playbookTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId14'))))]",
    "_playbookcontentProductId14": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId14'),'-', variables('playbookVersion14'))))]",
    "RecordedFuture-Ukraine-IndicatorProcessor": "RecordedFuture-Ukraine-IndicatorProcessor",
    "_RecordedFuture-Ukraine-IndicatorProcessor": "[variables('RecordedFuture-Ukraine-IndicatorProcessor')]",
    "playbookVersion15": "1.1",
    "playbookContentId15": "RecordedFuture-Ukraine-IndicatorProcessor",
    "_playbookContentId15": "[variables('playbookContentId15')]",
    "playbookId15": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId15'))]",
    "playbookTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId15'))))]",
    "_playbookcontentProductId15": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId15'),'-', variables('playbookVersion15'))))]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "RecordedFuturePlaybookAlertOverviewWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "workbookVersion2": "1.0.0",
    "workbookContentId2": "RecordedFutureAlertOverviewWorkbook",
    "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
    "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
    "_workbookContentId2": "[variables('workbookContentId2')]",
    "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
    "workbookVersion3": "1.0.1",
    "workbookContentId3": "RecordedFutureDomainCorrelationWorkbook",
    "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
    "workbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3'))))]",
    "_workbookContentId3": "[variables('workbookContentId3')]",
    "_workbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId3'),'-', variables('workbookVersion3'))))]",
    "workbookVersion4": "1.0.1",
    "workbookContentId4": "RecordedFutureHashCorrelationWorkbook",
    "workbookId4": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId4'))]",
    "workbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId4'))))]",
    "_workbookContentId4": "[variables('workbookContentId4')]",
    "_workbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId4'),'-', variables('workbookVersion4'))))]",
    "workbookVersion5": "1.0.1",
    "workbookContentId5": "RecordedFutureIPCorrelationWorkbook",
    "workbookId5": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId5'))]",
    "workbookTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId5'))))]",
    "_workbookContentId5": "[variables('workbookContentId5')]",
    "_workbookcontentProductId5": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId5'),'-', variables('workbookVersion5'))))]",
    "workbookVersion6": "1.0.1",
    "workbookContentId6": "RecordedFutureURLCorrelationWorkbook",
    "workbookId6": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId6'))]",
    "workbookTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId6'))))]",
    "_workbookContentId6": "[variables('workbookContentId6')]",
    "_workbookcontentProductId6": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId6'),'-', variables('workbookVersion6'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureDomainMalwareC2inDNSEvents_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in DNSEvents from Recorded Future C2 DNS Name Domains Risklist.",
                "displayName": "Detection of Malware C2 Domains in DNS Events",
                "enabled": false,
                "query": "// Identifies a match in DnsEvent from the Recorded Future DOMAIN Malware C2 DNS Name \nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\n//Create a list of TLDs in our threat feed for later validation\nlet list_tlds = ThreatIntelligenceIndicator\n| where TimeGenerated > ago(ioc_lookBack)\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == 'Recorded Future - Domains - Command and Control Activity'\n| where isnotempty(DomainName)\n| extend parts = split(DomainName, '.')\n| extend tld = parts[(array_length(parts)-1)]\n| summarize count() by tostring(tld)\n| summarize make_list(tld);\nThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == 'Recorded Future - Domains - Command and Control Activity'\n// Picking up only IOC's that contain the entities we want\n| where isnotempty(DomainName)\n| join (\n  DnsEvents\n  | where TimeGenerated > ago(dt_lookBack)\n  //Extract Domain patterns from syslog message\n  | where isnotempty(Name)\n  | extend parts = split(Name, '.')\n  //Split out the TLD\n  | extend tld = parts[(array_length(parts)-1)]\n  //Validate parsed Domain by checking if the TLD is in the list of TLDs in our threat feed\n  | where tld in~ (list_tlds)\n  | extend DNS_TimeGenerated = TimeGenerated\n  ) \non $left.DomainName==$right.Name\n| where DNS_TimeGenerated >= TimeGenerated and DNS_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, DomainName, Description, ConfidenceScore, AdditionalInformation, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, DNS_TimeGenerated, Computer, ClientIP, Name, QueryType\n| extend timestamp = DNS_TimeGenerated, HostCustomEntity = Computer, IPCustomEntity = ClientIP, DomainCustomEntity = DomainName\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "DNS",
                    "dataTypes": [
                      "DnsEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "HostCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "DNS",
                    "fieldMappings": [
                      {
                        "identifier": "DomainName",
                        "columnName": "DomainCustomEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId1')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Malware C2 Domains in DNS Events",
        "contentProductId": "[variables('_analyticRulecontentProductId1')]",
        "id": "[variables('_analyticRulecontentProductId1')]",
        "version": "[variables('analyticRuleVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureDomainMalwareC2inSyslogEvents_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in Syslog from Recorded Future C2 DNS Name Domains Risklist.",
                "displayName": "Detection of Malware C2 Domains in Syslog Events",
                "enabled": false,
                "query": "// Identifies a match in Syslog from the Recorded Future DOMAIN Malware C2 DNS Name \nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\n//Create a list of TLDs in our threat feed for later validation\nlet list_tlds = ThreatIntelligenceIndicator\n| where TimeGenerated > ago(ioc_lookBack)\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == 'Recorded Future - Domains - Command and Control Activity'\n| where isnotempty(DomainName)\n| extend parts = split(DomainName, '.')\n| extend tld = parts[(array_length(parts)-1)]\n| summarize count() by tostring(tld)\n| summarize make_list(tld);\nThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == 'Recorded Future - Domains - Command and Control Activity'\n// Picking up only IOC's that contain the entities we want\n| where isnotempty(DomainName)\n| join (\n  Syslog\n  | where TimeGenerated > ago(dt_lookBack)\n  //Extract domain patterns from syslog message\n  | extend domain = extract(\"(([a-z0-9]+(-[a-z0-9]+)*\\\\.)+[a-z]{2,})\",1, tolower(SyslogMessage))\n  | where isnotempty(domain)\n  | extend parts = split(domain, '.')\n  //Split out the TLD\n  | extend tld = parts[(array_length(parts)-1)]\n  //Validate parsed domain by checking if the TLD is in the list of TLDs in our threat feed\n  | where tld in~ (list_tlds)\n  | extend Syslog_TimeGenerated = TimeGenerated\n  ) \non $left.DomainName==$right.domain\n| where Syslog_TimeGenerated >= TimeGenerated and Syslog_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, Syslog_TimeGenerated, SyslogMessage, Computer, ProcessName, domain, HostIP, Url\n| extend timestamp = Syslog_TimeGenerated, HostCustomEntity = Computer, IPCustomEntity = HostIP, URLCustomEntity = Url\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "Syslog",
                    "dataTypes": [
                      "Syslog"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "HostCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "DNS",
                    "fieldMappings": [
                      {
                        "identifier": "DomainName",
                        "columnName": "domain"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId2')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Malware C2 Domains in Syslog Events",
        "contentProductId": "[variables('_analyticRulecontentProductId2')]",
        "id": "[variables('_analyticRulecontentProductId2')]",
        "version": "[variables('analyticRuleVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureHashObservedInUndergroundinCommonSecurityLog_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId3')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in CommonSecurityLog from Recorded Future Hash Observed in Underground Virus Testing Sites RiskList.",
                "displayName": "Detection of Specific Hashes in CommonSecurityLog",
                "enabled": false,
                "query": "// Identifies a match in CommonSecurityLog from the Recorded Future Hashes Observed in Underground Virus Testing Sites\nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\nlet fileHashIndicators = ThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n// Picking up only Recorded Future IOC's that have been observed in undersground testing sites\n| where Description == \"Recorded Future - HASH - Observed in Underground Virus Testing Sites\"\n| where Active == true\n| where isnotempty(FileHashValue);\n// Handle matches against both lower case and uppercase versions of the hash:\n(fileHashIndicators | extend  FileHashValue = tolower(FileHashValue)\n| union (fileHashIndicators | extend FileHashValue = toupper(FileHashValue)))\n| join (\n  CommonSecurityLog | where TimeGenerated >= ago(dt_lookBack)\n  | where isnotempty(FileHash)\n  | extend CommonSecurityLog_TimeGenerated = TimeGenerated\n  )\non $left.FileHashValue == $right.FileHash\n| where CommonSecurityLog_TimeGenerated >= TimeGenerated and CommonSecurityLog_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, Description, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore,\nCommonSecurityLog_TimeGenerated, SourceIP, SourcePort, DestinationIP, DestinationPort, SourceUserID, SourceUserName, DeviceName, DeviceAction, RequestURL, DestinationUserName, DestinationUserID, ApplicationProtocol, Activity, FileHash, AdditionalInformation\n| extend timestamp = CommonSecurityLog_TimeGenerated, IPCustomEntity = SourceIP, HostCustomEntity = DeviceName, AccountCustomEntity = SourceUserName, URLCustomEntity = Url\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "CEF",
                    "dataTypes": [
                      "CommonSecurityLog"
                    ]
                  }
                ],
                "tactics": [
                  "PreAttack"
                ],
                "techniques": [
                  "T1587"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "HostCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId3'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 3",
                "parentId": "[variables('analyticRuleId3')]",
                "contentId": "[variables('_analyticRulecontentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId3')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Specific Hashes in CommonSecurityLog",
        "contentProductId": "[variables('_analyticRulecontentProductId3')]",
        "id": "[variables('_analyticRulecontentProductId3')]",
        "version": "[variables('analyticRuleVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureIPMalwareC2inAzureActivityEvents_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId4')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in Azure Activity Events from Recorded Future Actively Communicating C&C Server Risklist.",
                "displayName": "Detection of Malware C2 IPs in Azure Act. Events",
                "enabled": false,
                "query": "// Identifies a match in AzureActivity from the Recorded Future C2 Malware Detection IPs (Actively Communicating C&C Server RiskList)\nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\nThreatIntelligenceIndicator\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == \"Recorded Future - IP - Actively Communicating C&C Server\"\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n| extend TI_ipEntity = NetworkIP\n| join (\n  AzureActivity | where TimeGenerated >= ago(dt_lookBack)\n  // renaming time column so it is clear the log this came from\n  | extend AzureActivity_TimeGenerated = TimeGenerated\n  )\non $left.TI_ipEntity == $right.CallerIpAddress\n| where AzureActivity_TimeGenerated >= TimeGenerated and AzureActivity_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, AzureActivity_TimeGenerated, TI_ipEntity, CallerIpAddress, Caller, OperationNameValue, ActivityStatusValue, CategoryValue, ResourceId, NetworkIP, Description, AdditionalInformation\n| extend timestamp = AzureActivity_TimeGenerated, IPCustomEntity = CallerIpAddress, AccountCustomEntity = Caller, URLCustomEntity = Url\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "AzureActivity",
                    "dataTypes": [
                      "AzureActivity"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "TI_ipEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId4'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 4",
                "parentId": "[variables('analyticRuleId4')]",
                "contentId": "[variables('_analyticRulecontentId4')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId4')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Malware C2 IPs in Azure Act. Events",
        "contentProductId": "[variables('_analyticRulecontentProductId4')]",
        "id": "[variables('_analyticRulecontentProductId4')]",
        "version": "[variables('analyticRuleVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureIPMalwareC2inDNSEvents_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId5')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in DnsEvents from Recorded Future Actively Communicating C&C Server Risklist.",
                "displayName": "Detection of Malware C2 IPs in DNS Events",
                "enabled": false,
                "query": "// Identifies a match in DnsEvent from the Recorded Future C2 Malware Detection IPs (Actively Communicating C&C Server RiskList)\nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\nThreatIntelligenceIndicator\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\n| where Description == \"Recorded Future - IP - Actively Communicating C&C Server\"\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n| extend TI_ipEntity = NetworkIP\n| join (\n  DnsEvents | where TimeGenerated >= ago(dt_lookBack)\n  | where SubType =~ \"LookupQuery\" and isnotempty(IPAddresses)\n  | extend SingleIP = split(IPAddresses, \",\")\n  | mvexpand SingleIP\n  | extend SingleIP = tostring(SingleIP)\n  // renaming time column so it is clear the log this came from\n  | extend DNS_TimeGenerated = TimeGenerated\n  )\non $left.TI_ipEntity == $right.SingleIP\n| where DNS_TimeGenerated >= TimeGenerated and DNS_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, ActivityGroupNames, IndicatorId, ThreatType, Url, ExpirationDateTime, ConfidenceScore, DNS_TimeGenerated, TI_ipEntity, Computer, EventId, SubType, ClientIP, Name, IPAddresses, NetworkIP, Description, AdditionalInformation\n| extend timestamp = DNS_TimeGenerated, IPCustomEntity = ClientIP, HostCustomEntity = Computer, URLCustomEntity = Url\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "DNS",
                    "dataTypes": [
                      "DnsEvents"
                    ]
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "HostCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "TI_ipEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId5'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 5",
                "parentId": "[variables('analyticRuleId5')]",
                "contentId": "[variables('_analyticRulecontentId5')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId5')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Malware C2 IPs in DNS Events",
        "contentProductId": "[variables('_analyticRulecontentProductId5')]",
        "id": "[variables('_analyticRulecontentProductId5')]",
        "version": "[variables('analyticRuleVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureUrlReportedbyInsiktGroupinSyslogEvents_AnalyticalRules Analytics Rule with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRulecontentId6')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies a match in Syslog from Recorded Future URLs Recently Reported as malicious by Insikt Group.",
                "displayName": "Detection of Malicious URLs in Syslog Events",
                "enabled": false,
                "query": "// Identifies a match in Syslog from the Recorded Future URLs Recently Reported by Insikt Group\nlet dt_lookBack = 1h;\nlet ioc_lookBack = 1d;\nThreatIntelligenceIndicator\n// Picking up only Recorded Future IOC's that have been recently reported as malicious by Insikt Group\n| where Description == 'Recorded Future - URL - Recently Reported by Insikt Group'\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n// Picking up only IOC's that contain the entities we want\n| where isnotempty(Url)\n| join (\n  Syslog\n  | where TimeGenerated >= ago(dt_lookBack)\n  // Extract URL from the Syslog message but only take messages that include URLs\n  | extend Url = extract(\"(http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\\\(\\\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+)\", 1,SyslogMessage)\n  | where isnotempty(Url)\n  | extend Syslog_TimeGenerated = TimeGenerated\n  ) \non Url\n| where Syslog_TimeGenerated >= TimeGenerated and Syslog_TimeGenerated < ExpirationDateTime\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| project LatestIndicatorTime, Description, ActivityGroupNames, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, Syslog_TimeGenerated, SyslogMessage, Computer, ProcessName, Url, AdditionalInformation, HostIP\n| extend timestamp = Syslog_TimeGenerated, HostCustomEntity = Computer, IPCustomEntity = HostIP, URLCustomEntity = Url\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P1D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "Syslog",
                    "dataTypes": [
                      "Syslog"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "entityMappings": [
                  {
                    "entityType": "Host",
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "HostCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ]
                  },
                  {
                    "entityType": "URL",
                    "fieldMappings": [
                      {
                        "identifier": "Url",
                        "columnName": "URLCustomEntity"
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId6'),'/'))))]",
              "properties": {
                "description": "Recorded Future Analytics Rule 6",
                "parentId": "[variables('analyticRuleId6')]",
                "contentId": "[variables('_analyticRulecontentId6')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_analyticRulecontentId6')]",
        "contentKind": "AnalyticsRule",
        "displayName": "Detection of Malicious URLs in Syslog Events",
        "contentProductId": "[variables('_analyticRulecontentProductId6')]",
        "id": "[variables('_analyticRulecontentProductId6')]",
        "version": "[variables('analyticRuleVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
              "type": "string"
            }
          },
          "variables": {
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateVersion": "2.5",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Parse_JSON_2": {
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "id": {
                                  "type": "string"
                                },
                                "kind": {
                                  "type": "string"
                                },
                                "properties": {
                                  "type": "object"
                                },
                                "type": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        },
                        "Switch": {
                          "cases": {
                            "Case": {
                              "actions": {
                                "Add_comment_to_incident_(V3)_-_Domain": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{body('Domain_Enrichment')?['data']?['html_response']}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Domain_Enrichment": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Add_comment_to_incident_(V3)_4": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p><img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/RecordedFuture.png\" /><br>\nNo Recorded Future data on @{body('Parse_JSON_-_DNS_Resolution')?['domainName']}<br>\n<a href=\"https://app.recordedfuture.com/live/sc/collection-request\" target=\"_blank\">Request Data Collection In The Recorded Future Portal</a></p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)_-_Domain": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Domain_Enrichment": {
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/lookup/domain/@{encodeURIComponent(body('Parse_JSON_-_DNS_Resolution')?['domainName'])}",
                                    "queries": {
                                      "IntelligenceCloud": "@parameters('IntelligenceCloud')",
                                      "RFIncidentId": "@variables('RFIncidentId')",
                                      "Techniques": "@string(triggerBody()?['object']?['properties']?['additionalData']?['techniques'])",
                                      "WorkspaceId": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                      "fields": "intelCard,risk,links",
                                      "htmlresponse": "True"
                                    }
                                  },
                                  "runAfter": {
                                    "Parse_JSON_-_DNS_Resolution": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Parse_JSON_-_DNS_Resolution": {
                                  "inputs": {
                                    "content": "@body('Parse_JSON_2')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "domainName": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "ParseJson"
                                }
                              },
                              "case": "DnsResolution"
                            },
                            "Case_2": {
                              "actions": {
                                "Add_comment_to_incident_(V3)_-_Hash": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{body('Hash_Enrichment')?['data']?['html_response']}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Hash_Enrichment": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Add_comment_to_incident_(V3)_3": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p><img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/RecordedFuture.png\" /><br>\nNo Recorded Future data on @{body('Parse_JSON_-_File_Hash')?['hashValue']}<br>\n<a href=\"https://app.recordedfuture.com/live/sc/collection-request\" target=\"_blank\">Request Data Collection In The Recorded Future Portal</a></p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)_-_Hash": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Hash_Enrichment": {
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/lookup/hash/@{encodeURIComponent(body('Parse_JSON_-_File_Hash')?['hashValue'])}",
                                    "queries": {
                                      "IntelligenceCloud": "@parameters('IntelligenceCloud')",
                                      "RFIncidentId": "@variables('RFIncidentId')",
                                      "Techniques": "@string(triggerBody()?['object']?['properties']?['additionalData']?['techniques'])",
                                      "WorkspaceId": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                      "fields": "intelCard,risk,links",
                                      "htmlresponse": "True"
                                    }
                                  },
                                  "runAfter": {
                                    "Parse_JSON_-_File_Hash": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Parse_JSON_-_File_Hash": {
                                  "inputs": {
                                    "content": "@body('Parse_JSON_2')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "algorithm": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "hashValue": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "ParseJson"
                                }
                              },
                              "case": "FileHash"
                            },
                            "Case_3": {
                              "actions": {
                                "Add_comment_to_incident_(V3)_-_URL": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{body('URL_Enrichment')?['data']?['html_response']}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "URL_Enrichment": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Add_comment_to_incident_(V3)_2": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p><img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/RecordedFuture.png\" /><br>\nNo Recorded Future data on @{body('Parse_JSON_-_Url')?['url']}<br>\n<a href=\"https://app.recordedfuture.com/live/sc/collection-request\" target=\"_blank\">Request Data Collection In The Recorded Future Portal</a></p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)_-_URL": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Parse_JSON_-_Url": {
                                  "inputs": {
                                    "content": "@body('Parse_JSON_2')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "friendlyName": {
                                          "type": "string"
                                        },
                                        "url": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "ParseJson"
                                },
                                "URL_Enrichment": {
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/lookup/url/@{encodeURIComponent(body('Parse_JSON_-_Url')?['url'])}",
                                    "queries": {
                                      "IntelligenceCloud": "@parameters('IntelligenceCloud')",
                                      "RFIncidentId": "@variables('RFIncidentId')",
                                      "Techniques": "@string(triggerBody()?['object']?['properties']?['additionalData']?['techniques'])",
                                      "WorkspaceId": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                      "fields": "intelCard,risk,links",
                                      "htmlresponse": "True"
                                    }
                                  },
                                  "runAfter": {
                                    "Parse_JSON_-_Url": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                }
                              },
                              "case": "Url"
                            },
                            "Case_4": {
                              "actions": {
                                "Add_comment_to_incident_(V3)": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p><img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/RecordedFuture.png\" /><br>\nNo Recorded Future data on @{body('Parse_JSON_-_Ip')?['address']}<br>\n<a href=\"https://app.recordedfuture.com/live/sc/collection-request\" target=\"_blank\">Request Data Collection In The Recorded Future Portal</a></p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)_-_IP": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Add_comment_to_incident_(V3)_-_IP": {
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>@{body('IP_Enrichment')?['data']?['html_response']}</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  },
                                  "runAfter": {
                                    "IP_Enrichment": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "IP_Enrichment": {
                                  "inputs": {
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                                      }
                                    },
                                    "method": "get",
                                    "path": "/lookup/ip/@{encodeURIComponent(body('Parse_JSON_-_Ip')?['address'])}",
                                    "queries": {
                                      "IntelligenceCloud": "@parameters('IntelligenceCloud')",
                                      "RFIncidentId": "@variables('RFIncidentId')",
                                      "Techniques": "@string(triggerBody()?['object']?['properties']?['additionalData']?['techniques'])",
                                      "WorkspaceId": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                      "fields": "intelCard,risk,links",
                                      "htmlresponse": "True"
                                    }
                                  },
                                  "runAfter": {
                                    "Parse_JSON_-_Ip": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "ApiConnection"
                                },
                                "Parse_JSON_-_Ip": {
                                  "inputs": {
                                    "content": "@body('Parse_JSON_2')?['properties']",
                                    "schema": {
                                      "properties": {
                                        "address": {
                                          "type": "string"
                                        },
                                        "friendlyName": {
                                          "type": "string"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "ParseJson"
                                }
                              },
                              "case": "Ip"
                            }
                          },
                          "expression": "@body('Parse_JSON_2')?['kind']",
                          "runAfter": {
                            "Parse_JSON_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Switch"
                        }
                      },
                      "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                      "runAfter": {
                        "RFIncidentId": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "RFIncidentId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "RFIncidentId",
                            "type": "string",
                            "value": "@{guid()}"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "IntelligenceCloud": {
                      "defaultValue": true,
                      "type": "Bool"
                    },
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]"
                      },
                      "recordedfuture": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
            "description": "This playbook leverages the Recorded Future API to enrich IP, Domain, Url & Hash indicators, found in Microsoft Sentinel incidents, with the following context: Risk Score, Risk Rules and Link to Intelligence Card. The enrichment content will be posted as a comment in the Microsoft Sentinel incident <img alt=\"Microsoft Sentinel incident comment\" src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/EnrichmentExampleDark.png\"/>.",
            "prerequisites": [
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment open the playbook in edit mode and configure/authorize all connections and press save.<img alt=\"Logic app schema\" src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Recorded%20Future/Playbooks/RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash/images/LogicAppDark.png\" />"
            ],
            "lastUpdateTime": "2023-03-08T00:00:00Z",
            "entities": [
              "ip",
              "url",
              "dnsresolution",
              "filehash"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Improved layout and added Recorded Future Collective Insights."
                ]
              },
              {
                "version": "1.2",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Fixed risk rule severity and correct image url."
                ]
              },
              {
                "version": "2.3",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Updated readme and improved layout."
                ]
              },
              {
                "version": "2.4",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Handle 404 result from enrichment."
                ]
              },
              {
                "version": "2.5",
                "title": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
                "notes": [
                  "Backend rendered markdown/html to increse performance and reduce cost of enrichment."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-Sandbox_Enrichment-Url Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-Sandbox_Enrichment-Url",
              "type": "string"
            },
            "Sandbox API Key": {
              "type": "string",
              "metadata": {
                "description": "Enter value for Sandbox API Key. Retrive API Key from [Recorded Future Portal](https://sandbox.recordedfuture.com/account)"
              }
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "[[concat('', parameters('PlaybookName'))]",
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/recordedfuturesandbo')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "Sandbox API Key": {
                      "defaultValue": "[[parameters('Sandbox API Key')]",
                      "type": "string"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_URLs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/url"
                      }
                    },
                    "For_each": {
                      "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "runAfter": {
                            "Get_the_full_report": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>@{body('Get_the_full_report')?['html_report']}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          }
                        },
                        "Get_the_full_report": {
                          "runAfter": {
                            "Wait_for_sandbox_report": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "headers": {
                              "SandboxToken": "@parameters('Sandbox API Key')"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['recordedfuturesandbo']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/samples/@{encodeURIComponent(body('Get_the_full_summary')?['id'])}/overview.json"
                          }
                        },
                        "Initialize_Sandbox_status": {
                          "runAfter": {
                            "Submit_url_samples": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "sandbox_status",
                            "value": "@body('Submit_url_samples')?['status']"
                          }
                        },
                        "Submit_url_samples": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "url": "@items('For_each')?['Url']"
                            },
                            "headers": {
                              "Content-Type": "application/json",
                              "SandboxToken": "@parameters('Sandbox API Key')"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['recordedfuturesandbo']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/samples/url"
                          }
                        },
                        "Wait_for_sandbox_report": {
                          "actions": {
                            "Delay": {
                              "runAfter": {
                                "Set_sandbox_status": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Wait",
                              "inputs": {
                                "interval": {
                                  "count": 2,
                                  "unit": "Minute"
                                }
                              }
                            },
                            "Get_the_full_summary": {
                              "type": "ApiConnection",
                              "inputs": {
                                "headers": {
                                  "SandboxToken": "@parameters('Sandbox API Key')"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['recordedfuturesandbo']['connectionId']"
                                  }
                                },
                                "method": "get",
                                "path": "/samples/@{encodeURIComponent(body('Submit_url_samples')?['id'])}"
                              }
                            },
                            "Set_sandbox_status": {
                              "runAfter": {
                                "Get_the_full_summary": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "sandbox_status",
                                "value": "@body('Get_the_full_summary')?['status']"
                              }
                            }
                          },
                          "runAfter": {
                            "Initialize_Sandbox_status": [
                              "Succeeded"
                            ]
                          },
                          "expression": "@equals(variables('sandbox_status'), 'reported')",
                          "limit": {
                            "count": 60,
                            "timeout": "PT1H"
                          },
                          "type": "Until"
                        }
                      },
                      "runAfter": {
                        "Define_sandbox_status": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Define_sandbox_status": {
                      "runAfter": {
                        "Entities_-_Get_URLs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "sandbox_status",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "recordedfuturesandbo": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "recordedfuturesandbo",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/recordedfuturesandbo')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-Sandbox_Enrichment-Url",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Sandbox_Enrichment-Url",
            "description": "This playbook will enrich url entities in an incident and send them to Recorded Future Sandbox. The result will be written as a incident comment.",
            "prerequisites": "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials",
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-03-24T00:00:00Z",
            "entities": [
              "url"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-Sandbox_Enrichment-Url",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-Sandbox_Enrichment-Url",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-Playbook-Alert-Importer Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-Playbook-Alert-Importer",
              "type": "string"
            }
          },
          "variables": {
            "AzureloganalyticsdatacollectorConnectionName": "[[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Search_Playbook_Alerts')",
                      "actions": {
                        "Get_Playbook_Alert_by_ID": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['recordedfuturev2']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/playbook-alert/@{encodeURIComponent(items('For_each')?['playbook_alert_id'])}"
                          }
                        },
                        "Send_Data": {
                          "runAfter": {
                            "Get_Playbook_Alert_by_ID": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": "{\n\"title\": \"@{body('Get_Playbook_Alert_by_ID')?['title']}\",\n\"id\": \"@{body('Get_Playbook_Alert_by_ID')?['id']}\",\n\"category\":\"@{body('Get_Playbook_Alert_by_ID')?['category']}\",\n\"rule_label\":\"@{body('Get_Playbook_Alert_by_ID')?['rule_label']}\",\n\"status\": \"@{body('Get_Playbook_Alert_by_ID')?['status']}\", \n\"priority\": \"@{body('Get_Playbook_Alert_by_ID')?['priority']}\",\n\"created_date\": \"@{body('Get_Playbook_Alert_by_ID')?['created_date']}\",\n\"updated_date\": \"@{body('Get_Playbook_Alert_by_ID')?['updated_date']}\",\n\"targets\":\"@{body('Get_Playbook_Alert_by_ID')?['targets']}\",\n\"evidence_summary\": \"@{body('Get_Playbook_Alert_by_ID')?['evidence_summary']}\",\n\"link\": \"@{body('Get_Playbook_Alert_by_ID')?['link']}\"\n}",
                            "headers": {
                              "Log-Type": "RecordedFuturePlaybookAlerts"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/api/logs"
                          }
                        }
                      },
                      "runAfter": {
                        "Search_Playbook_Alerts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Search_Playbook_Alerts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "categories": [
                            "domain_abuse",
                            "cyber_vulnerability",
                            "code_repo_leakage"
                          ],
                          "created_from_relative": "-1"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuturev2']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/playbook-alert/search"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                        "connectionName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]"
                      },
                      "recordedfuturev2": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "PlaybookAlert-Import",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Playbook-Alert-Importer",
            "description": "This playbook imports alerts from Recorded Future and stores them in a custom log in the log analytics workspace.",
            "prerequisites": [
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Alert"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-Playbook-Alert-Importer",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-Playbook-Alert-Importer",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-AlertImporter Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-AlertImporter",
              "type": "string"
            },
            "create_incident": {
              "type": "string",
              "metadata": {
                "description": "Create Microsoft Sentinel incidents (possible values true/false)"
              }
            },
            "workspace_name": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Sentinel Workspace name"
              }
            }
          },
          "variables": {
            "AzureloganalyticsdatacollectorConnectionName": "[[concat('Azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzuremonitorlogsConnectionName": "[[concat('Azuremonitorlogs-', parameters('PlaybookName'))]",
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "Recordedfuturev2ConnectionName": "[[concat('Recordedfuturev2-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-4": "[[variables('connection-4')]",
            "connection-5": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-5": "[[variables('connection-5')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "create_incident": {
                      "type": "string",
                      "defaultValue": "[[parameters('create_incident')]"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each_triggered_alert": {
                      "foreach": "@body('Search_Triggered_Alerts')?['data']",
                      "actions": {
                        "Create_incident_if_parameter_is_set": {
                          "actions": {
                            "Add_comment_to_incident_(V3)": {
                              "runAfter": {
                                "Parse_JSON_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@body('Create_incident')?['id']",
                                  "message": "<p>@{items('For_each_triggered_alert')?['title']}<br>\nAlert ID: @{items('For_each_triggered_alert')?['id']}<br>\nTriggered: @{items('For_each_triggered_alert')?['log']?['triggered']}<br>\n[Open Recorded Future portal](@{items('For_each_triggered_alert')?['url']?['portal']})<br>\nAI Summary: @{items('For_each_triggered_alert')?['ai_insights']?['text']}</p>"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/Comment"
                              }
                            },
                            "Create_incident": {
                              "type": "ApiConnection",
                              "inputs": {
                                "body": {
                                  "description": "**Recorded Future Alert**\n@{items('For_each_triggered_alert')?['title']}\nAlert ID: @{items('For_each_triggered_alert')?['id']}\nTriggered: @{items('For_each_triggered_alert')?['log']?['triggered']}\n[Open Recorded Future portal](@{items('For_each_triggered_alert')?['url']?['portal']})\nAI summary: @{items('For_each_triggered_alert')?['ai_insights']?['text']}",
                                  "severity": "Medium",
                                  "status": "New",
                                  "tagsToAdd": {
                                    "TagsToAdd": [
                                      {
                                        "Tag": "Recorded Future Alert"
                                      }
                                    ]
                                  },
                                  "title": "@items('For_each_triggered_alert')?['title']"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "[[concat('/Incidents/subscriptions/', subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/workspaces/',parameters('workspace_name') ) ]"
                              }
                            },
                            "Parse_JSON_2": {
                              "runAfter": {
                                "Create_incident": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ParseJson",
                              "inputs": {
                                "content": "@items('For_each_triggered_alert')?['hits']",
                                "schema": {
                                  "items": {
                                    "properties": {
                                      "document": {
                                        "properties": {
                                          "authors": {
                                            "type": "array"
                                          },
                                          "source": {
                                            "properties": {
                                              "id": {
                                                "type": "string"
                                              },
                                              "name": {
                                                "type": "string"
                                              },
                                              "type": {
                                                "type": "string"
                                              }
                                            },
                                            "type": "object"
                                          },
                                          "title": {
                                            "type": [
                                              "string",
                                              "null"
                                            ]
                                          }
                                        },
                                        "type": "object"
                                      },
                                      "entities": {
                                        "items": {
                                          "properties": {
                                            "id": {
                                              "type": "string"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "type": {
                                              "type": "string"
                                            }
                                          },
                                          "required": [
                                            "id",
                                            "name",
                                            "type"
                                          ],
                                          "type": "object"
                                        },
                                        "type": "array"
                                      },
                                      "fragment": {
                                        "type": "string"
                                      },
                                      "id": {
                                        "type": "string"
                                      },
                                      "language": {
                                        "type": "string"
                                      }
                                    },
                                    "required": [
                                      "entities",
                                      "document",
                                      "fragment",
                                      "id",
                                      "language",
                                      "primary_entity",
                                      "analyst_note"
                                    ],
                                    "type": "object"
                                  },
                                  "type": "array"
                                }
                              }
                            }
                          },
                          "runAfter": {
                            "For_each_hit": [
                              "Succeeded"
                            ]
                          },
                          "expression": {
                            "and": [
                              {
                                "equals": [
                                  "@parameters('create_incident')",
                                  "true"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_hit": {
                          "foreach": "@items('For_each_triggered_alert')['hits']",
                          "actions": {
                            "Parse_JSON": {
                              "type": "ParseJson",
                              "inputs": {
                                "content": "@items('For_each_hit')",
                                "schema": {
                                  "properties": {
                                    "document": {
                                      "properties": {
                                        "authors": {
                                          "items": {
                                            "properties": {
                                              "id": {
                                                "type": "string"
                                              },
                                              "name": {
                                                "type": "string"
                                              },
                                              "type": {
                                                "type": "string"
                                              }
                                            },
                                            "required": [
                                              "id",
                                              "name",
                                              "type"
                                            ],
                                            "type": "object"
                                          },
                                          "type": "array"
                                        },
                                        "source": {
                                          "properties": {
                                            "id": {
                                              "type": "string"
                                            },
                                            "name": {
                                              "type": "string"
                                            },
                                            "type": {
                                              "type": "string"
                                            }
                                          },
                                          "type": "object"
                                        },
                                        "title": {
                                          "type": [
                                            "string",
                                            "null"
                                          ]
                                        }
                                      },
                                      "type": "object"
                                    },
                                    "entities": {
                                      "items": {
                                        "properties": {
                                          "id": {
                                            "type": "string"
                                          },
                                          "name": {
                                            "type": "string"
                                          },
                                          "type": {
                                            "type": "string"
                                          }
                                        },
                                        "required": [
                                          "id",
                                          "name",
                                          "type"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    },
                                    "fragment": {
                                      "type": "string"
                                    },
                                    "id": {
                                      "type": "string"
                                    },
                                    "language": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              }
                            },
                            "Send_Data_2": {
                              "runAfter": {
                                "Parse_JSON": [
                                  "Succeeded"
                                ]
                              },
                              "type": "ApiConnection",
                              "inputs": {
                                "body": "{\n\"RuleName\": \"@{items('For_each_triggered_alert')?['rule']?['name']}\",\n\"Triggered\": \"@{items('For_each_triggered_alert')?['log']?['triggered']}\",\n\"AlertName\": \"@{items('For_each_triggered_alert')?['title']}\",\n\"AlertID\": \"@{items('For_each_triggered_alert')?['id']}\", \n\"Entity\": @{items('For_each_hit')?['entities']},\n\"Documents\": @{items('For_each_hit')?['document']},\n\"URL\": \"@{items('For_each_triggered_alert')?['rule']?['url']?['portal']}\",\n\"Document_url\": \"@{items('For_each_hit')?['document']?['url']}\",\n\"AISummary\": \"@{items('For_each_triggered_alert')?['ai_insights']?['text']}\",\n\"Fragment\": \"@{replace(replace(body('Parse_JSON')?['fragment'], '\\', '\\\\'), '\"', '\\\"')}\"}",
                                "headers": {
                                  "Log-Type": "RecordedFuturePortalAlerts"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/api/logs"
                              }
                            }
                          },
                          "type": "Foreach"
                        }
                      },
                      "runAfter": {
                        "Search_Triggered_Alerts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "latest_event_date",
                            "type": "string",
                            "value": "@{addHours(utcNow(), -24)}"
                          }
                        ]
                      }
                    },
                    "Run_query_and_list_results": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "RecordedFuturePortalAlerts_CL\n| summarize LatestEvent=max(Triggered_t)",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs_1']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "[[resourceGroup().name]",
                          "resourcename": "[[parameters('workspace_name')]",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "[[subscription().subscriptionId]",
                          "timerange": "Last 7 days"
                        }
                      }
                    },
                    "Search_Triggered_Alerts": {
                      "runAfter": {
                        "Set_variable": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuturev2']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v2/alerts",
                        "queries": {
                          "triggered": "[[@{addSeconds(variables('latest_event_date'),1)},@{utcNow()}]"
                        }
                      }
                    },
                    "Set_variable": {
                      "runAfter": {
                        "Run_query_and_list_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "latest_event_date",
                        "value": "@string(body('Run_query_and_list_results')?['value'][0]['LatestEvent'])"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                        "connectionName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azureloganalyticsdatacollector')]"
                      },
                      "azuremonitorlogs_1": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                        "connectionName": "[[variables('AzuremonitorlogsConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]"
                      },
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "recordedfuturev2": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Recordedfuturev2ConnectionName'))]",
                        "connectionName": "[[variables('Recordedfuturev2ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-AlertImporter",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureloganalyticsdatacollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Recordedfuturev2ConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureloganalyticsdatacollectorConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzuremonitorlogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzuremonitorlogsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-4')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Recordedfuturev2ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Recordedfuturev2ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-5')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Alert-Importer",
            "description": "This playbook imports alerts from Recorded Future and stores them in a custom log in the log analytics workspace. It can create alerts dependant on the parameter: create_incident. ",
            "prerequisites": [
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-09-13T00:00:00Z",
            "tags": [
              "Alert"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-Alert-Importer",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-AlertImporter",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-ThreatIntelligenceImport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-ThreatIntelligenceImport",
              "type": "string"
            },
            "workspace": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Microsoft Sentinel Workspace name"
              }
            }
          },
          "variables": {
            "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Batch_messages": {
                      "type": "Batch",
                      "inputs": {
                        "configurations": {
                          "RFImportToSentinel": {
                            "releaseCriteria": {
                              "messageCount": 100,
                              "recurrence": {
                                "frequency": "Minute",
                                "interval": 10
                              }
                            }
                          }
                        },
                        "mode": "Inline"
                      }
                    }
                  },
                  "actions": {
                    "Compose": {
                      "runAfter": {
                        "Select": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": {
                        "sourcesystem": "Recorded Future",
                        "value": "@body('Select')"
                      }
                    },
                    "Select": {
                      "type": "Select",
                      "inputs": {
                        "from": "@triggerBody()['items']",
                        "select": "@item()['content']"
                      }
                    },
                    "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(Private_Preview)": {
                      "runAfter": {
                        "Compose": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@outputs('Compose')",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "[[concat('/ThreatIntelligence/', reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace'))).customerId,'/UploadIndicators')]"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                        "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-ThreatIntelligenceImport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('MicrosoftSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-ThreatIntelligenceImport",
            "description": "This playbook will write indicators in batch to ThreatIntelligenceIndicator log analytics table.",
            "prerequisites": [
              "Microsoft Sentinel Threat Intelligence active"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-ThreatIntelligenceImport",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId5')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-ThreatIntelligenceImport",
        "contentProductId": "[variables('_playbookcontentProductId5')]",
        "id": "[variables('_playbookcontentProductId5')]",
        "version": "[variables('playbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-Domain-IndicatorImport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-Domain-IndicatorImport",
              "type": "string"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ThreatIntelligenceImport",
              "type": "String"
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "[[concat('Recordedfuture-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 2
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 24
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "actions": {
                        "Parse_JSON": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "created": "@{utcNow()}",
                              "description": "Recorded Future - Domains - Command and Control Activity",
                              "id": "indicator--@{guid()}",
                              "indicator_types": [
                                "malicious-activity"
                              ],
                              "labels": [
                                "@{body('Parse_JSON')?['EvidenceDetails']?['EvidenceDetails']}"
                              ],
                              "modified": "@{utcNow()}",
                              "name": "@{body('Parse_JSON')?['Name']}",
                              "pattern": "[[[domain-name:value = '@{body('Parse_JSON')?['Name']}']",
                              "pattern_type": "stix",
                              "spec_version": "2.1",
                              "type": "indicator",
                              "valid_from": "@{utcNow()}",
                              "valid_until": "@{addHours(utcNow(),2)}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/domain_c2_dns.json"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedfutureConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-Domain-IndicatorImport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Domain-IndicatorImport",
            "description": "This playbook imports Domain risk lists from Recorded Future and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on RecordedFuture-ThreatIntelligenceImport that need to be installed **manually** before installing this playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ThreatIntelligenceImport playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-Domain-IndicatorImport",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId6')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-Domain-IndicatorImport",
        "contentProductId": "[variables('_playbookcontentProductId6')]",
        "id": "[variables('_playbookcontentProductId6')]",
        "version": "[variables('playbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-Hash-IndicatorImport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-Hash-IndicatorImport",
              "type": "string"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ThreatIntelligenceImport",
              "type": "String"
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "[[concat('Recordedfuture-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 24
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 24
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "actions": {
                        "Parse_JSON": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "created": "@{utcNow()}",
                              "description": "Recorded Future - HASH - Observed in Underground Virus Testing Sites",
                              "id": "indicator--@{guid()}",
                              "indicator_types": [
                                "malicious-activity"
                              ],
                              "labels": [
                                "@{body('Parse_JSON')?['EvidenceDetails']?['EvidenceDetails']}"
                              ],
                              "modified": "@{utcNow()}",
                              "name": "@{body('Parse_JSON')?['Name']}",
                              "pattern": "[[[file:hashes.'@{body('Parse_JSON')?['Algorithm']}' = '@{body('Parse_JSON')?['Name']}']",
                              "pattern_type": "stix",
                              "spec_version": "2.1",
                              "type": "indicator",
                              "valid_from": "@{utcNow()}",
                              "valid_until": "@{addHours(utcNow(),24)}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/hash_observed_testing.json"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedfutureConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-Hash-IndicatorImport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Hash-IndicatorImport",
            "description": "This playbook imports Hash risk lists from Recorded Future and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on RecordedFuture-ThreatIntelligenceImport that need to be installed **manually** before installing this playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ThreatIntelligenceImport playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-Hash-IndicatorImport",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId7')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-Hash-IndicatorImport",
        "contentProductId": "[variables('_playbookcontentProductId7')]",
        "id": "[variables('_playbookcontentProductId7')]",
        "version": "[variables('playbookVersion7')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-IP-IndicatorImport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-IP-IndicatorImport",
              "type": "string"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ThreatIntelligenceImport",
              "type": "String"
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "[[concat('Recordedfuture-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 24
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "actions": {
                        "Parse_JSON": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture-ThreatIntelligenceImport": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "created": "@{utcNow()}",
                              "description": "Recorded Future - IP - Actively Communicating C&C Server",
                              "id": "indicator--@{guid()}",
                              "indicator_types": [
                                "malicious-activity"
                              ],
                              "labels": [
                                "@{body('Parse_JSON')?['EvidenceDetails']?['EvidenceDetails']}"
                              ],
                              "modified": "@{utcNow()}",
                              "name": "@{body('Parse_JSON')?['Name']}",
                              "pattern": "[[[ipv4-addr:value = '@{body('Parse_JSON')?['Name']}']",
                              "pattern_type": "stix",
                              "spec_version": "2.1",
                              "type": "indicator",
                              "valid_from": "@{utcNow()}",
                              "valid_until": "@{addHours(utcNow(),1)}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/ip_active_c2.json"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedfutureConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-IP-IndicatorImport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-IP-IndicatorImport",
            "description": "This playbook imports IP risk lists from Recorded Future and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on RecordedFuture-ThreatIntelligenceImport that need to be installed **manually** before installing this playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ThreatIntelligenceImport playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-IP-IndicatorImport",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId8')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-IP-IndicatorImport",
        "contentProductId": "[variables('_playbookcontentProductId8')]",
        "id": "[variables('_playbookcontentProductId8')]",
        "version": "[variables('playbookVersion8')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-URL-IndicatorImport Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-URL-IndicatorImport",
              "type": "string"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ThreatIntelligenceImport",
              "type": "String"
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "[[concat('Recordedfuture-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 2
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Hour",
                        "interval": 24
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "actions": {
                        "Parse_JSON": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "created": "@{utcNow()}",
                              "description": "Recorded Future - URL - Recently Reported by Insikt Group",
                              "id": "indicator--@{guid()}",
                              "indicator_types": [
                                "malicious-activity"
                              ],
                              "labels": [
                                "@{body('Parse_JSON')?['EvidenceDetails']?['EvidenceDetails']}"
                              ],
                              "modified": "@{utcNow()}",
                              "name": "@{body('Parse_JSON')?['Name']}",
                              "pattern": "[[[url:value = '@{body('Parse_JSON')?['Name']}']",
                              "pattern_type": "stix",
                              "spec_version": "2.1",
                              "type": "indicator",
                              "valid_from": "@{utcNow()}",
                              "valid_until": "@{addHours(utcNow(),2)}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/url_insikt.json"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedfutureConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2017-07-01",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-URL-IndicatorImport",
                "hidden-SentinelTemplateVersion": "1.0",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-URL-IndicatorImport",
            "description": "This playbook imports URL risk lists from Recorded Future and stores them as Threat Intelligence Indicators in Microsoft Sentinel, for detection purposes.\n\nThis playbook depends on RecordedFuture-ThreatIntelligenceImport that need to be installed **manually** before installing this playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ThreatIntelligenceImport playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment, open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-07-06T00:00:00Z",
            "tags": [
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-URL-IndicatorImport",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId9')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-URL-IndicatorImport",
        "contentProductId": "[variables('_playbookcontentProductId9')]",
        "id": "[variables('_playbookcontentProductId9')]",
        "version": "[variables('playbookVersion9')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-ImportToSentinel Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion10')]",
          "parameters": {
            "PlaybookName": {
              "type": "string",
              "defaultValue": "RecordedFuture-ImportToSentinel"
            }
          },
          "variables": {
            "GraphSecurityConnectionName": "[[concat('microsoftgraphsecurity-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/microsoftgraphsecurity')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-ImportToSentinel",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('GraphSecurityConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Select": {
                      "inputs": {
                        "from": "@triggerBody()['items']",
                        "select": "@item()['content']"
                      },
                      "type": "Select"
                    },
                    "Submit_multiple_tiIndicators": {
                      "inputs": {
                        "body": {
                          "value": "@body('Select')"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/beta/security/tiIndicators/submitTiIndicators"
                      },
                      "runAfter": {
                        "Select": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Batch_messages": {
                      "inputs": {
                        "configurations": {
                          "RFImportToSentinel": {
                            "releaseCriteria": {
                              "messageCount": 100,
                              "recurrence": {
                                "frequency": "Minute",
                                "interval": 10
                              }
                            }
                          }
                        },
                        "mode": "Inline"
                      },
                      "type": "Batch"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "microsoftgraphsecurity": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/microsoftgraphsecurity')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('GraphSecurityConnectionName'))]",
                        "connectionName": "[[variables('GraphSecurityConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[variables('GraphSecurityConnectionName')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId10')]",
                "contentId": "[variables('_playbookContentId10')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-ImportToSentinel",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook is purposed to listen (via batching mechanism provided by Microsoft Azure) for incoming messages from the IndicatorProcessor Playbooks and create submit the indicators for creation",
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2023-08-09T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              },
              {
                "version": "1.0",
                "title": "RecordedFuture-ImportToSentinel",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId10')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-ImportToSentinel",
        "contentProductId": "[variables('_playbookcontentProductId10')]",
        "id": "[variables('_playbookcontentProductId10')]",
        "version": "[variables('playbookVersion10')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-DOMAIN-C2_DNS_Name-TIProcessor Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion11')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-DOMAIN-C2_DNS_Name-TIProcessor",
              "type": "String"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ImportToSentinel",
              "type": "String"
            }
          },
          "variables": {
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-DOMAIN-C2_DNS_Name-TIProcessor",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Parse_JSON": {
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "description": "Recorded Future - DOMAIN - C2 DNS Name",
                              "domainName": "@{body('Parse_JSON')?['Name']}",
                              "expirationDateTime": "@{addHours(utcNow(),2)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "targetProduct": "Azure Sentinel",
                              "threatType": "C2",
                              "tlpLevel": "amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          },
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch"
                        }
                      },
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/domain_c2_dns.json"
                        }
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 2
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId11')]",
                "contentId": "[variables('_playbookContentId11')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-DOMAIN-C2_DNS_Name-TIProcessor",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook leverages the Recorded Future API and automatically imports the C&C DNS Name Domain RiskList, as Threat Intelligence Indicators, for detection purposes in Microsoft Sentinel.\n\nThis playbook depends on RecordedFuture-ImportToSentinel that need to be installed **manually** before installing current playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ImportToSentinel playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-08-07T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor",
                "notes": [
                  "Initial version"
                ]
              },
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId11')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-DOMAIN-C2_DNS_Name-TIProcessor",
        "contentProductId": "[variables('_playbookcontentProductId11')]",
        "id": "[variables('_playbookcontentProductId11')]",
        "version": "[variables('playbookVersion11')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName12')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion12')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor",
              "type": "String"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ImportToSentinel",
              "type": "String"
            }
          },
          "variables": {
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Parse_JSON": {
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "description": "Recorded Future - HASH - Observed in Underground Virus Testing Sites",
                              "expirationDateTime": "@{addDays(utcNow(),1)}",
                              "fileHashType": "unknown",
                              "fileHashValue": "@{body('Parse_JSON')?['Name']}",
                              "ingestedDateTime": "@{utcNow()}",
                              "targetProduct": "Azure Sentinel",
                              "threatType": "Malware",
                              "tlpLevel": "amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          },
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch"
                        }
                      },
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/hash_observed_testing.json"
                        }
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId12'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId12')]",
                "contentId": "[variables('_playbookContentId12')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion12')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook leverages the Recorded Future API and automatically imports the Observed in Underground Virus Testing Sites Hash RiskList, as Threat Intelligence Indicators, for detection purposes in Microsoft Sentinel.\n\nThis playbook depends on RecordedFuture-ImportToSentinel that need to be installed **manually** before installing current playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ImportToSentinel playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-08-09T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              },
              {
                "version": "1.0",
                "title": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId12')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-HASH-Obs_in_Underground-TIProcessor",
        "contentProductId": "[variables('_playbookcontentProductId12')]",
        "id": "[variables('_playbookcontentProductId12')]",
        "version": "[variables('playbookVersion12')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName13')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-IP-Actively_Comm_C2_Server-TIProcessor Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion13')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-IP-Actively_Comm_C2_Server-TIProcessor",
              "type": "String"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ImportToSentinel",
              "type": "String"
            }
          },
          "variables": {
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-IP-Actively_Comm_C2_Server-TIProcessor",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Parse_JSON": {
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "description": "Recorded Future - IP - Actively Communicating C&C Server",
                              "expirationDateTime": "@{addHours(utcNow(),1)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "networkIPv4": "@{body('Parse_JSON')?['Name']}",
                              "targetProduct": "Azure Sentinel",
                              "threatType": "C2",
                              "tlpLevel": "amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          },
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch"
                        }
                      },
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/ip_active_c2.json"
                        }
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId13'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId13')]",
                "contentId": "[variables('_playbookContentId13')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion13')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-IP-Actively_Comm_C2_Server-TIProcessor",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook leverages the Recorded Future API and automatically imports the Actively Communicating C&C Server IP RiskList, as Threat Intelligence Indicators, for detection purposes in Microsoft Sentinel.\n\nThis playbook depends on RecordedFuture-ImportToSentinel that need to be installed **manually** before installing current playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ImportToSentinel playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-08-09T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              },
              {
                "version": "1.0",
                "title": "RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId13')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-IP-Actively_Comm_C2_Server-TIProcessor",
        "contentProductId": "[variables('_playbookcontentProductId13')]",
        "id": "[variables('_playbookcontentProductId13')]",
        "version": "[variables('playbookVersion13')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName14')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-URL-Recent_Rep_by_Insikt-TIProcessor Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion14')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-URL-Recent_Rep_by_Insikt-TIProcessor",
              "type": "String"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ImportToSentinel",
              "type": "String"
            }
          },
          "variables": {
            "RecordedFutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-URL-Recent_Rep_by_Insikt-TIProcessor",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]"
              ],
              "properties": {
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "For_each": {
                      "actions": {
                        "Parse_JSON": {
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "ParseJson"
                        },
                        "RecordedFuture-ImportToSentinel": {
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "description": "Recorded Future - URL - Recently Reported by Insikt Group",
                              "expirationDateTime": "@{addHours(utcNow(),2)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "targetProduct": "Azure Sentinel",
                              "threatType": "MaliciousUrl",
                              "tlpLevel": "amber",
                              "url": "@{body('Parse_JSON')?['Name']}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          },
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch"
                        }
                      },
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/MicrosoftAzure/url_insikt.json"
                        }
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Hour",
                        "interval": 2
                      },
                      "type": "Recurrence"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfuturev2')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureConnectionName')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedFutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId14'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId14')]",
                "contentId": "[variables('_playbookContentId14')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion14')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-URL-Recent_Rep_by_Insikt-TIProcessor",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook leverages the Recorded Future API and automatically imports the Recently Reported by Insikt Group URL RiskList, as Threat Intelligence Indicators, for detection purposes in Microsoft Sentinel.\n\nThis playbook depends on RecordedFuture-ImportToSentinel that need to be installed **manually** before installing current playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ImportToSentinel playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2022-08-09T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              },
              {
                "version": "1.0",
                "title": "RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId14')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-URL-Recent_Rep_by_Insikt-TIProcessor",
        "contentProductId": "[variables('_playbookcontentProductId14')]",
        "id": "[variables('_playbookcontentProductId14')]",
        "version": "[variables('playbookVersion14')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName15')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuture-Ukraine-IndicatorProcessor Playbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion15')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFuture-Ukraine-IndicatorProcessor",
              "type": "string"
            },
            "PlaybookNameBatching": {
              "defaultValue": "RecordedFuture-ImportToSentinel",
              "type": "string"
            }
          },
          "variables": {
            "RecordedfutureConnectionName": "recordedfuture-connectorv2",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "properties": {
                "provisioningState": "Succeeded",
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "For_each": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download')",
                      "actions": {
                        "Parse_JSON": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture_Ukraine_Detection_ImportToSentinel": {
                          "runAfter": {
                            "Parse_JSON": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON')?['Risk'])",
                              "description": "Recorded Future - Ukraine IP Detection",
                              "expirationDateTime": "@{addDays(utcNow(),1)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "isActive": true,
                              "networkIPv4": "@{body('Parse_JSON')?['Name']}",
                              "targetProduct": "Azure Sentinel",
                              "threatType": "WatchList",
                              "tlpLevel": "Amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_2": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download_2')",
                      "actions": {
                        "Parse_JSON_2": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_2')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture_Ukraine_Detection_ImportToSentinel_2": {
                          "runAfter": {
                            "Parse_JSON_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON_2')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON_2')?['Risk'])",
                              "description": "Recorded Future - Ukraine Domain Detection",
                              "domainName": "@{body('Parse_JSON_2')?['Name']}",
                              "expirationDateTime": "@{addHours(utcNow(),2)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "isActive": true,
                              "targetProduct": "Microsoft Sentinel",
                              "threatType": "WatchList",
                              "tlpLevel": "Amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download_2": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_3": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download_3')",
                      "actions": {
                        "Parse_JSON_3": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_3')",
                            "schema": {
                              "properties": {
                                "EvidenceDetails": {
                                  "properties": {
                                    "EvidenceDetails": {
                                      "items": {
                                        "properties": {
                                          "Criticality": {
                                            "type": "integer"
                                          },
                                          "CriticalityLabel": {
                                            "type": "string"
                                          },
                                          "EvidenceString": {
                                            "type": "string"
                                          },
                                          "Rule": {
                                            "type": "string"
                                          },
                                          "Timestamp": {
                                            "type": "integer"
                                          }
                                        },
                                        "required": [
                                          "Rule",
                                          "EvidenceString",
                                          "CriticalityLabel",
                                          "Timestamp",
                                          "Criticality"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    }
                                  },
                                  "type": "object"
                                },
                                "Name": {
                                  "type": "string"
                                },
                                "Risk": {
                                  "type": "integer"
                                },
                                "riskString": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture_Ukraine_Detection_ImportToSentinel_3": {
                          "runAfter": {
                            "Parse_JSON_3": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON_3')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON_3')?['Risk'])",
                              "description": "Recorded Future - Ukraine Url Detection",
                              "expirationDateTime": "@{addHours(utcNow(),2)}",
                              "ingestedDateTime": "@{utcNow()}",
                              "isActive": true,
                              "targetProduct": "Microsoft Sentinel",
                              "threatType": "MaliciousUrl",
                              "tlpLevel": "Amber",
                              "url": "@{body('Parse_JSON_3')?['Name']}"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download_3": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_4": {
                      "foreach": "@body('Recorded_Future_RiskLists_and_SCF_Download_4')",
                      "actions": {
                        "Parse_JSON_4": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('For_each_4')",
                            "schema": {
                              "properties": {
                                "body": {
                                  "items": {
                                    "properties": {
                                      "Algorithm": {
                                        "type": "string"
                                      },
                                      "EvidenceDetails": {
                                        "properties": {
                                          "EvidenceDetails": {
                                            "items": {
                                              "properties": {
                                                "Criticality": {
                                                  "type": "integer"
                                                },
                                                "CriticalityLabel": {
                                                  "type": "string"
                                                },
                                                "EvidenceString": {
                                                  "type": "string"
                                                },
                                                "MitigationString": {
                                                  "type": "string"
                                                },
                                                "Rule": {
                                                  "type": "string"
                                                },
                                                "Timestamp": {
                                                  "type": "integer"
                                                }
                                              },
                                              "required": [
                                                "Rule",
                                                "EvidenceString",
                                                "CriticalityLabel",
                                                "Timestamp",
                                                "MitigationString",
                                                "Criticality"
                                              ],
                                              "type": "object"
                                            },
                                            "type": "array"
                                          }
                                        },
                                        "type": "object"
                                      },
                                      "Name": {
                                        "type": "string"
                                      },
                                      "Risk": {
                                        "type": "integer"
                                      },
                                      "RiskString": {
                                        "type": "string"
                                      }
                                    },
                                    "required": [
                                      "Name",
                                      "Algorithm",
                                      "Risk",
                                      "RiskString",
                                      "EvidenceDetails"
                                    ],
                                    "type": "object"
                                  },
                                  "type": "array"
                                },
                                "headers": {
                                  "properties": {
                                    "CF-Cache-Status": {
                                      "type": "string"
                                    },
                                    "CF-RAY": {
                                      "type": "string"
                                    },
                                    "Cache-Control": {
                                      "type": "string"
                                    },
                                    "Content-Length": {
                                      "type": "string"
                                    },
                                    "Content-Type": {
                                      "type": "string"
                                    },
                                    "Date": {
                                      "type": "string"
                                    },
                                    "Expect-CT": {
                                      "type": "string"
                                    },
                                    "Timing-Allow-Origin": {
                                      "type": "string"
                                    },
                                    "Transfer-Encoding": {
                                      "type": "string"
                                    },
                                    "pragma": {
                                      "type": "string"
                                    },
                                    "referrer-policy": {
                                      "type": "string"
                                    },
                                    "strict-transport-security": {
                                      "type": "string"
                                    },
                                    "x-content-type-options": {
                                      "type": "string"
                                    },
                                    "x-frame-options": {
                                      "type": "string"
                                    },
                                    "x-ms-apihub-cached-response": {
                                      "type": "string"
                                    },
                                    "x-ms-apihub-obo": {
                                      "type": "string"
                                    },
                                    "x-rf-proxy-basepath": {
                                      "type": "string"
                                    },
                                    "x-rf-proxy-serviceid": {
                                      "type": "string"
                                    },
                                    "x-xss-protection": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "statusCode": {
                                  "type": "integer"
                                }
                              },
                              "type": "object"
                            }
                          }
                        },
                        "RecordedFuture_Ukraine_Detection_ImportToSentinel_4": {
                          "runAfter": {
                            "Parse_JSON_4": [
                              "Succeeded"
                            ]
                          },
                          "type": "SendToBatch",
                          "inputs": {
                            "batchName": "RFImportToSentinel",
                            "content": {
                              "action": "alert",
                              "additionalInformation": "@{body('Parse_JSON_4')?['EvidenceDetails']}",
                              "azureTenantId": "[[subscription().tenantId]",
                              "confidence": "@int(body('Parse_JSON_4')?['Risk'])",
                              "description": "Recorded Future - Ukraine File Hash Detection",
                              "expirationDateTime": "@{addHours(utcNow(),2)}",
                              "filehashtype": "@{replace(replace(body('Parse_JSON_4')?['Algorithm'],'SHA-256', 'sha256'),'SHA-1', 'sha1')}",
                              "filehashvalue": "@{body('Parse_JSON_4')?['Name']}",
                              "ingestedDateTime": "@{utcNow()}",
                              "isActive": true,
                              "targetProduct": "Microsoft Sentinel",
                              "threatType": "Malware",
                              "tlpLevel": "Amber"
                            },
                            "host": {
                              "triggerName": "Batch_messages",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('PlaybookNameBatching'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Recorded_Future_RiskLists_and_SCF_Download_4": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/ukraine/ukraine_russia_ip.csv"
                        }
                      }
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download_2": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/ukraine/ukraine_russia_domain.csv"
                        }
                      }
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download_3": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/ukraine/ukraine_russia_url.csv"
                        }
                      }
                    },
                    "Recorded_Future_RiskLists_and_SCF_Download_4": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfuture']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/fusion/files",
                        "queries": {
                          "path": "/public/ukraine/ukraine_russia_hash.csv"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "recordedfuture": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]",
                        "connectionName": "[[variables('RecordedfutureConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Recordedfuturev2')]"
                      }
                    }
                  }
                }
              },
              "name": "[[parameters('PlaybookName')]",
              "type": "Microsoft.Logic/workflows",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "hidden-SentinelTemplateName": "RecordedFuture-Ukraine-IndicatorProcessor",
                "hidden-SentinelTemplateVersion": "1.1",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "apiVersion": "2019-05-01",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RecordedfutureConnectionName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RecordedfutureConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('RecordedfutureConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId15'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId15')]",
                "contentId": "[variables('_playbookContentId15')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion15')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFuture-Ukraine-IndicatorProcessor",
            "description": "**[Deprecated]**\nDeprecated due to changes in the Threat Intelligence Platform. Use the new IndicatorImport playbooks that is provided in this Solution.\n\nThis playbook leverages the Recorded Future API and automatically imports the Ukraine RiskLists, as Threat Intelligence Indicators, for detection purposes in Microsoft Sentinel.\n\nThis playbook depends on RecordedFuture-ImportToSentinel that need to be installed **manually** before installing current playbook.",
            "prerequisites": [
              "First install the RecordedFuture-ImportToSentinel playbook.",
              "To use the Recorded Future for Azure connector, you will need a valid API token from Recorded Future as described in the documentation https://learn.microsoft.com/en-us/connectors/recordedfuturev2/#how-to-get-credentials"
            ],
            "postDeployment": [
              "After deployment you have to open the playbook to configure all connections and press save."
            ],
            "lastUpdateTime": "2023-09-13T00:00:00Z",
            "tags": [
              "Deprecated",
              "Threat Intelligence"
            ],
            "releaseNotes": [
              {
                "version": "1.1",
                "title": "Deprecated",
                "notes": [
                  "Deprecated in favor for the new IndicatorImport playbooks. More information can be found in the readme on Github https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Recorded%20Future/Playbooks/readme.md",
                  "Once a new IndicatorImport playbook is installed downloading the same risk list. Deactivate or delete this playbook."
                ]
              },
              {
                "version": "1.0",
                "title": "RecordedFuture-Ukraine-IndicatorProcessor",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId15')]",
        "contentKind": "Playbook",
        "displayName": "RecordedFuture-Ukraine-IndicatorProcessor",
        "contentProductId": "[variables('_playbookcontentProductId15')]",
        "id": "[variables('_playbookcontentProductId15')]",
        "version": "[variables('playbookVersion15')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFuturePlaybookAlertOverviewWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future Playbook Alerts Overview Workbook. This workbook will visualize playbook alerts imported via the RecordedFuture-Playbook-Alert-Importer."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recorded Future Playbook Alerts\\n---\\n\\nWorkbook to display and analyze Recorded Future Playbook Alerts. This workbook visualize data that is retrived by the ```Recorded Future Playbook Alerts Importer``` Logic app. First run the Logic app once and then select the RecordedFuturePlaybookAlerts_CL table.\",\"style\":\"info\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"8e8c2f1a-d25d-49d1-a217-9831dbc4f919\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"time_picker\",\"label\":\"Time Picker\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":259200000}},{\"id\":\"f8d34a51-ba10-4241-abff-cb6c14b50a55\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"log_table\",\"label\":\"Playbook Alerts Log Table\",\"type\":2,\"description\":\"Run the Recorded Future Playbook Alert Importer Playbook first.\",\"isRequired\":true,\"query\":\"search *\\n| where $table endswith \\\"_CL\\\" \\n| distinct $table\\n\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"RecordedFuturePlaybookAlerts_CL\"},{\"id\":\"89279a9c-af9e-4734-8a98-21aa1f2fa545\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"categories\",\"label\":\"Category\",\"type\":2,\"description\":\"Filter categories you're looking at\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{log_table}\\n| distinct rule_label_s\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"time_picker\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"a0947450-1ebd-4dea-94d7-41a751c79237\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"status\",\"label\":\"Alert Status\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{log_table}\\n| distinct status_s\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"25a82661-1700-43a6-ba7a-b3ae5d8fe7b9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"priority\",\"label\":\"Alert Priority\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{log_table}\\n| distinct priority_s\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":172800000},\"timeContextFromParameter\":\"time_picker\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where rule_label_s in ({categories:value})\\n| where status_s in ({status:value}) \\n| where priority_s in ({priority:value})\\n| distinct id_s, rule_label_s, updated_date_t\\n| summarize alert_count = count() by rule_label_s\\n| project alert_count, Alert = rule_label_s\",\"size\":0,\"title\":\"Top Categories Triggered\",\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where rule_label_s in ({categories:value})\\n| where status_s in ({status:value}) \\n| where priority_s in ({priority:value})\\n| distinct id_s, rule_label_s, updated_date_t\\n| summarize Alert=count() by bin(updated_date_t, 1h)\\n\",\"size\":0,\"title\":\"Playbook Alerts triggered over time\",\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"maxWidth\":\"70\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where rule_label_s in ({categories:value})\\n| where status_s in ({status:value}) \\n| where priority_s in ({priority:value})\\n| distinct updated_date_t, title_s, rule_label_s, status_s, priority_s, link_s, evidence_summary_s, targets_s, created_date_t, id_s\\n| project-rename Updated=updated_date_t, Title=title_s, Category=rule_label_s, Status=status_s, Priority=priority_s, Created=created_date_t, Targets=targets_s, [\\\"Evidence\\\"]=evidence_summary_s, [\\\"External Link\\\"]=link_s, ID=id_s\\n\\n\",\"size\":0,\"title\":\"Triggered Playbook Alerts\",\"noDataMessage\":\"No data in Playbook Alert custom log. Check that playbook/logic apps is running without errors and rules for playbook alerts is setup in Recorded Future Portal.\",\"timeContextFromParameter\":\"time_picker\",\"exportFieldName\":\"id_s\",\"exportParameterName\":\"exported_alert_id\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Title\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Link\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Recorded Future\"}},{\"columnMatch\":\"ID\",\"formatter\":5}],\"sortBy\":[{\"itemKey\":\"Updated\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Updated\",\"sortOrder\":2}]},\"name\":\"query - 8\"}],\"fromTemplateId\":\"sentinel-RecordedFuturePlaybookAlertOverview\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFuturePlaybookAlertOverviewWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future Playbook Alerts Overview Workbook. This workbook will visualize playbook alerts imported via the RecordedFuture-Playbook-Alert-Importer.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Recorded Future - Playbook Alerts Overview; templateRelativePath=RecordedFuturePlaybookAlertOverview.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "RecordedFuturePlaybookAlerts_CL",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureAlertOverviewWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId2')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future Alerts Overview Workbook. This workbook will visualize playbook alerts imported via the RecordedFuture-Alert-Importer."
              },
              "properties": {
                "displayName": "[parameters('workbook2-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Recorded Future Alerts\\n---\\n\\nWorkbook to display and analyze Recorded Future Alerts. This workbook visualize data that is retrived by the ```Recorded Future Alerts Importer``` Logic app. First run the Logic app once and then select the RecordedFuturePortalAlerts_CL table.\",\"style\":\"info\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"8e8c2f1a-d25d-49d1-a217-9831dbc4f919\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"time_picker\",\"label\":\"Time Picker\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":86400000}},{\"id\":\"f8d34a51-ba10-4241-abff-cb6c14b50a55\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"log_table\",\"label\":\"Alerts Log Table\",\"type\":2,\"isRequired\":true,\"query\":\"search \\\"*\\\" | summarize count() by $table | sort by count_ desc | where $table endswith \\\"CL\\\" | project $table\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"RecordedFuturePortalAlerts_CL\"},{\"id\":\"89279a9c-af9e-4734-8a98-21aa1f2fa545\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"alert_rules\",\"label\":\"Alert Rules\",\"type\":2,\"description\":\"Filter alert rules you're looking at\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{log_table}\\n| distinct RuleName_s\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where RuleName_s in ({alert_rules:value})\\n| distinct AlertID_s, RuleName_s, Triggered_t\\n| summarize alert_count = count() by RuleName_s\\n| project alert_count, Alert = RuleName_s\\n\",\"size\":0,\"title\":\"Top Rules Triggered\",\"noDataMessage\":\"There are no alerts within this time frame.\",\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 2\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where RuleName_s in ({alert_rules:value})\\n| distinct AlertID_s, RuleName_s, Triggered_t\\n| summarize Alert=count() by bin(Triggered_t, 1h)\\n\",\"size\":0,\"title\":\"Alerts triggered over time\",\"timeContextFromParameter\":\"time_picker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"customWidth\":\"50\",\"name\":\"query - 2 - Copy\",\"styleSettings\":{\"maxWidth\":\"70\"}},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"20edde78-9485-4056-8eca-6ef7cd86c8b5\",\"cellValue\":\"TAB\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Alert\",\"subTarget\":\"Reference\",\"preText\":\"Some thing\",\"postText\":\"Some thing\",\"style\":\"link\"}]},\"name\":\"links - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where RuleName_s in ({alert_rules:value})\\n//| where Documents_s != \\\"[]\\\"\\n//| distinct AlertID_s, AlertName_s, Documents_s, Entity_description_s, Entity_id_s, Entity_name_s, Entity_type_s, Risk_criticalityLabel_s, \\n//Risk_criticality_d, Risk_documents_s, Risk_evidence_s, RuleName_s, Trend_documents_s, Trend_name_s, Trend_strengthLabel_s, Trend_strength_d, Triggered_t\\n| distinct  Triggered = Triggered_t, [\\\"Alert ID\\\"]=AlertID_s, [\\\"Alert Name\\\"]=AlertName_s, [\\\"Rule Name\\\"]=RuleName_s, [\\\"External Link\\\"]= URL_s\\n\\n\\n\\n\",\"size\":0,\"timeContextFromParameter\":\"time_picker\",\"exportFieldName\":\"Alert ID\",\"exportParameterName\":\"Ref_AlertID\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"External Link\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Recorded Future\"}},{\"columnMatch\":\"Recorded Future Portal\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\"}},{\"columnMatch\":\"URL\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Recorded Future\"}}],\"sortBy\":[{\"itemKey\":\"Triggered\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Triggered\",\"sortOrder\":2}]},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{log_table:value}\\n| where AlertID_s == \\\"{Ref_AlertID}\\\"\\n| project Fragment=Fragment_s, Source=Documents_source_name_s, Title=Documents_title_s, URL=Document_url_s, AlertName = RuleName_s, AlertID=AlertID_s, entities=parse_json(Entity_s)\\n| mv-apply with_itemindex=i entities on (\\n    extend p = pack(strcat(\\\"Entity \\\", i+1), strcat(entities.type, \\\", \\\", entities.name, \\\", id:\\\", entities.id))\\n    | summarize b = make_bag(p)\\n)\\n| evaluate bag_unpack(b)\\n| project-reorder Fragment, Source, Title, URL, Entity*\\n\\n\",\"size\":0,\"timeContextFromParameter\":\"time_picker\",\"exportedParameters\":[{\"fieldName\":\"Fragment\",\"parameterName\":\"FragmentRef\",\"parameterType\":1},{\"fieldName\":\"Title\",\"parameterName\":\"TitleRef\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Fragment\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true},\"tooltipFormat\":{\"tooltip\":\"{0}\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"TAB\",\"comparison\":\"isEqualTo\",\"value\":\"Reference\"},\"name\":\"Reference View\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Document Title**\\r\\n{TitleRef}\"},\"name\":\"text - 3\"},{\"type\":1,\"content\":{\"json\":\"**Fragment**\\r\\n{FragmentRef}\\r\\n\\r\\n\\r\\n\"},\"showPin\":false,\"name\":\"Fragment\"}]},\"name\":\"group - 4\"}]},\"conditionalVisibility\":{\"parameterName\":\"TAB\",\"comparison\":\"isEqualTo\",\"value\":\"Reference\"},\"name\":\"Reference Alerts\"}],\"fromTemplateId\":\"sentinel-RecordedFutureAlertOverviewWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFutureAlertOverviewWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future Alerts Overview Workbook. This workbook will visualize playbook alerts imported via the RecordedFuture-Alert-Importer.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Recorded Future - Alerts Overview; templateRelativePath=RecordedFutureAlertOverview.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId2')]",
                "contentId": "[variables('_workbookContentId2')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "RecordedFuturePortalAlerts_CL",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId2')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook2-name')]",
        "contentProductId": "[variables('_workbookcontentProductId2')]",
        "id": "[variables('_workbookcontentProductId2')]",
        "version": "[variables('workbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureDomainCorrelationWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId3')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future Domain Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel."
              },
              "properties": {
                "displayName": "[parameters('workbook3-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"d7ccc5ca-c8ec-458f-ab0d-564a7ef1d217\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Guide\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\", \\\"selected\\\":true},\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"No\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Guide: Domain Correlation \\n\\nRecorded Futures Domain Correlation Workbook helps you detect malicious domains within your environment by correlating your logs with Recorded Future Domain Risk Lists.\\n\\n### How to Correlate Domains\\n\\nTo correlate domains, follow the steps below:\\n\\n1. In the **Domain Logs Table** dropdown, select a log table that contains domain logs.\\n\\t* If a particular log table is not listed in the dropdown, ensure it is enabled in your environment.\\n2. In the **Log field with domains** dropdown, select the log field that holds the domains to be correlated.\\n\\t* The workbook can correlate domains in the format: `domainName.net`.\\n3. Select a Recorded Future Domain Risk List for correlation.\\n4. If necessary, adjust the values in the **Logs from** and **Data from** dropdowns to match your requirements.\\n5. Done\\n\\n---\\n\\n#### Log table with examples of correlatable log fields\\n\\n| Table      \\t | Field |\\n| ----------- \\t | ----------- |\\n| DNSEvents      | Name        |\\n| _Im_Dns   \\t | DnsQuery    |\",\"style\":\"info\"},\"name\":\"text - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"group - 15\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Domains (from logs)\"},\"customWidth\":\"50\",\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Recorded Future Risk List\"},\"customWidth\":\"50\",\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b91b8b5b-10cf-4106-99e2-793eb0d72dce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Domain_Logs_Time_Range\",\"label\":\"Logs from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":604800000}},{\"id\":\"3300ad41-acbc-4ebd-900a-c6ab250b7c73\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Domain_Logs_Table\",\"label\":\"Domain Logs Table\",\"type\":2,\"description\":\"Log Table to correlate Domains Against\",\"isRequired\":true,\"query\":\"search \\\"*\\\" \\n| where TimeGenerated {Domain_Logs_Time_Range:query}\\n| summarize count() by $table \\n| sort by count_ desc \\n| where $table != \\\"ThreatIntelligenceIndicator\\\" \\n| project $table\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Squid_Proxy_URL_CL\"},{\"id\":\"f4f77ada-b97c-4a82-9421-20a58fb7ce26\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Domain_Logs_Field\",\"label\":\"Log Field with Domains\",\"type\":2,\"description\":\"Select the field containing the Domain Name that you want to correlate against\",\"isRequired\":true,\"query\":\"{Domain_Logs_Table:value}\\n| getschema\\n| where DataType == \\\"System.String\\\"\\n| project ColumnName\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Domain_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"95e78560-1e69-437c-8226-7b0f8c4dc199\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Threat_Intelligence_Time_Range\",\"label\":\"Data from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"value\":{\"durationMs\":604800000}},{\"id\":\"e7c7e2ea-f5b3-4505-b64c-b18ca8561168\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RF_Risk_list\",\"label\":\"Risk List\",\"type\":2,\"description\":\"Which Domain Risk List do you want to correlate against\",\"isRequired\":true,\"query\":\"ThreatIntelligenceIndicator\\n| where isnotempty(DomainName)\\n| where Description contains \\\"Recorded Future\\\"\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| summarize count() by Description\\n| project output = strcat('\\\"', Description, '\\\"')\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"\\\"Recorded Future - DOMAIN - Default RiskList\\\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 1\"}],\"exportParameters\":true},\"name\":\"group - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected Domains Per Day\\n\\nThe chart displays the number of correlation detections per day between domain logs and Recorded Future's domain Risk lists.\",\"style\":\"info\"},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_tlds = ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\n| where Description == {RF_Risk_list:value}\\n| where isnotempty(DomainName)\\n| where isnotempty(Tags)\\n| extend parts = split(DomainName, '.')\\n| extend tld = parts[(array_length(parts)-1)]\\n| summarize count() by tostring(tld)\\n| summarize make_list(tld);\\nThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Active == true\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\n| where Description == {RF_Risk_list:value}\\n// Picking up only IOC's that contain the entities we want\\n| where isnotempty(DomainName)\\n| where isnotempty(Tags)\\n| join (\\n    {Domain_Logs_Table:value}\\n    | where TimeGenerated  {Domain_Logs_Time_Range:query}\\n    //Extract Domain patterns from syslog message\\n    | where isnotempty({Domain_Logs_Field:value})\\n    | extend parts = split({Domain_Logs_Field:value}, '.')\\n    //Split out the TLD\\n    | extend tld = parts[(array_length(parts)-1)]\\n    //Validate parsed Domain by checking if the TLD is in the list of TLDs in our threat feed\\n    | where tld in~ (list_tlds)\\n    | extend DNS_TimeGenerated = TimeGenerated\\n) on $left.DomainName==$right.{Domain_Logs_Field:value}\\n| summarize Correlation_Matches=count() by bin(DNS_TimeGenerated, 1d)\\n| render barchart\",\"size\":0,\"title\":\"Detected Domains Per Day\",\"noDataMessage\":\"No detected domains\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"query - 1\"}]},\"customWidth\":\"100\",\"name\":\"group - 14\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected Domains\\n\\nThe Detected Domains table lists domains from the correlated logs that have been matched with Recorded Future Domain Risk Lists.\\n\\n**Table Columns**\\n\\n* **Risk Score:** The Recorded Future Risk Score for the domain (IOC), ranging from 1 to 99, with 99 being the highest level of severity.\\n* **Domain:** The detected domain.\\n* **Detected:** The time when the log was correlated with a Risk List.\\n* **Log Created:** The time when the log event itself was created.\\n* **Threat Classification:** The type of threat associated with the domain (IOC).\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_tlds = ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\r\\n| where Description == {RF_Risk_list:value}\\r\\n| where isnotempty(DomainName)\\r\\n| where isnotempty(Tags)\\r\\n| extend parts = split(DomainName, '.')\\r\\n| extend tld = parts[(array_length(parts)-1)]\\r\\n| summarize count() by tostring(tld)\\r\\n| summarize make_list(tld);\\r\\nThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Active == true\\r\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\r\\n| where Description == {RF_Risk_list:value}\\r\\n// Picking up only IOC's that contain the entities we want\\r\\n| where isnotempty(DomainName)\\r\\n| join (\\r\\n    {Domain_Logs_Table:value}\\r\\n    | where TimeGenerated  {Domain_Logs_Time_Range:query}\\r\\n    //Extract Domain patterns from syslog message\\r\\n    | where isnotempty({Domain_Logs_Field:value})\\r\\n    | extend parts = split({Domain_Logs_Field:value}, '.')\\r\\n    //Split out the TLD\\r\\n    | extend tld = parts[(array_length(parts)-1)]\\r\\n    //Validate parsed Domain by checking if the TLD is in the list of TLDs in our threat feed\\r\\n    | where tld in~ (list_tlds)\\r\\n    | extend DNS_TimeGenerated = TimeGenerated\\r\\n) on $left.DomainName==$right.{Domain_Logs_Field:value}\\r\\n| project [\\\"Risk Score\\\"]=ConfidenceScore, Domain=DomainName, Detected=format_datetime(TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Log Created\\\"]=format_datetime(DNS_TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Threat Classification\\\"]=ThreatType\\r\\n| summarize [\\\"Log Created\\\"]=max([\\\"Log Created\\\"]) by Domain, [\\\"Risk Score\\\"], Detected, [\\\"Threat Classification\\\"]\\r\\n| project [\\\"Risk Score\\\"], Domain, Detected, [\\\"Log Created\\\"], [\\\"Threat Classification\\\"]\\r\\n| sort by [\\\"Risk Score\\\"] desc\",\"size\":0,\"title\":\"Detected Domains\",\"noDataMessage\":\"No detected domains\",\"exportFieldName\":\"Domain\",\"exportParameterName\":\"MaliciousDomainMatch\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Risk\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\">=\",\"thresholdValue\":\"90\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"65\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"25\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}}]}},\"customWidth\":\"70\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let list_tlds = ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\r\\n| where Description == {RF_Risk_list:value}\\r\\n| where isnotempty(DomainName)\\r\\n| where isnotempty(Tags)\\r\\n| extend parts = split(DomainName, '.')\\r\\n| extend tld = parts[(array_length(parts)-1)]\\r\\n| summarize count() by tostring(tld)\\r\\n| summarize make_list(tld);\\r\\nThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Active == true\\r\\n// Picking up only Recorded Future IOC's that are pertinent to the use case (Malware C2 Detection)\\r\\n| where Description == {RF_Risk_list:value}\\r\\n// Picking up only IOC's that contain the entities we want\\r\\n| where isnotempty(DomainName)\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {Domain_Logs_Table:value}\\r\\n    | where TimeGenerated  {Domain_Logs_Time_Range:query}\\r\\n    //Extract Domain patterns from syslog message\\r\\n    | where isnotempty({Domain_Logs_Field:value})\\r\\n    | extend parts = split({Domain_Logs_Field:value}, '.')\\r\\n    //Split out the TLD\\r\\n    | extend tld = parts[(array_length(parts)-1)]\\r\\n    //Validate parsed Domain by checking if the TLD is in the list of TLDs in our threat feed\\r\\n    | where tld in~ (list_tlds)\\r\\n    | extend DNS_TimeGenerated = TimeGenerated\\r\\n) on $left.DomainName==$right.{Domain_Logs_Field:value}\\r\\n| project Risk=ConfidenceScore, DomainName, ThreatType, Tags\\r\\n| extend Evidence=parse_json(Tags)[0]\\r\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\r\\n| extend Rule=Evidence['Rule']\\r\\n| summarize count() by tostring(Rule)\\r\\n| sort by count_ desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Top Triggered Risk Rules\",\"noDataMessage\":\"No triggered Risk Rules\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}}],\"labelSettings\":[{\"columnId\":\"count_\",\"label\":\"Count\"}]}},\"customWidth\":\"30\",\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"### Detected Domains: Evidence Details\\n\\nTo view evidence details, click a row (domain) in the Detected Domains table.\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Description contains {RF_Risk_list:value}\\n| where DomainName == \\\"{MaliciousDomainMatch}\\\"\\n| where isnotempty(Tags)\\n//| where ExpirationDateTime > now()\\n| extend Evidence=parse_json(Tags)[0]\\n| take 1\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\n| project Rules = Evidence['Rule'], Criticality = Evidence['Criticality'], Evidence_String = Evidence['EvidenceString'] \\n| sort by toint(Criticality) desc\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Evidence_String\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70%\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"MaliciousDomainMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"\\n### Source data from {Domain_Logs_Table:value}\\nTo view source data of correlated domain, click a row (domain) in the Detected Domains table.\"},\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{Domain_Logs_Table:value}\\n| where TimeGenerated {Domain_Logs_Time_Range:query}\\n| where {Domain_Logs_Field:value} == \\\"{MaliciousDomainMatch}\\\"\\n\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousDomainMatch\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"name\":\"query - 1\"}]},\"name\":\"group - 8\"}],\"styleSettings\":{\"paddingStyle\":\"wide\"},\"fromTemplateId\":\"sentinel-RecordedFutureDomainCorrelationWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFutureDomainCorrelationWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future Domain Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Recorded Future - Domain Correlation; templateRelativePath=RecordedFutureDomainCorrelation.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId3')]",
                "contentId": "[variables('_workbookContentId3')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ThreatIntelligenceIndicator",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId3')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook3-name')]",
        "contentProductId": "[variables('_workbookcontentProductId3')]",
        "id": "[variables('_workbookcontentProductId3')]",
        "version": "[variables('workbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureHashCorrelationWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId4')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future Hash Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel."
              },
              "properties": {
                "displayName": "[parameters('workbook4-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"d7ccc5ca-c8ec-458f-ab0d-564a7ef1d217\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\" Guide\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\", \\\"selected\\\":true},\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"No\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 7\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Guide: Hash Correlation \\n\\nRecorded Futures Hash Correlation Workbook helps you detect malicious hashes within your environment by correlating your logs with Recorded Future Hash Risk Lists.\\n\\n### How to Correlate hashs\\n\\nTo correlate hashes, follow the steps below:\\n\\n1. In the **Hash Logs Table** dropdown, select a log table that contains hash logs.\\n\\t* If a particular log table is not listed in the dropdown, ensure it is enabled in your environment.\\n2. In the **Log field with hashes** dropdown, select the log field that holds the hashs to be correlated.\\n\\t* The workbook can correlate hashes in the format: `b0a0c7ae387c00161f4cc26405600b1a`.\\n3. Select a Recorded Future Hash Risk List for correlation.\\n4. If necessary, adjust the values in the **Logs from** and **Data from** dropdowns to match your requirements.\\n5. Done\\n\\n---\\n\\n#### Log table with examples of correlatable log fields\\n| Table      \\t \\t| Field |\\n| ----------- \\t \\t| ----------- |\\n| CommonSecurityLog | FileHash    |\\n| SecurityEvent   \\t| FileHash    |\",\"style\":\"info\"},\"name\":\"text - 0\"}]},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"group - 15\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Hashes (from logs)\"},\"customWidth\":\"50\",\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Recorded Future Risk List\"},\"customWidth\":\"50\",\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b91b8b5b-10cf-4106-99e2-793eb0d72dce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Hash_Logs_Time_Range\",\"label\":\"Logs from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":1209600000}},{\"id\":\"3300ad41-acbc-4ebd-900a-c6ab250b7c73\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Hash_Logs_Table\",\"label\":\"Hash Logs Table\",\"type\":2,\"description\":\"Log Table to correlate Domains Against\",\"isRequired\":true,\"query\":\"search \\\"*\\\" \\n| where TimeGenerated {Hash_Logs_Time_Range:query}\\n| summarize count() by $table | sort by count_ desc | where $table != \\\"ThreatIntelligenceIndicator\\\" | project $table\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"EndpointProtection_HASH_CL\"},{\"id\":\"f4f77ada-b97c-4a82-9421-20a58fb7ce26\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Hash_Logs_Field\",\"label\":\"Log Field with Hashes\",\"type\":2,\"description\":\"Select the field containing the Domain Name that you want to correlate against\",\"isRequired\":true,\"query\":\"{Hash_Logs_Table:value}\\n| getschema\\n| where DataType == \\\"System.String\\\"\\n| project ColumnName\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Hash_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"95e78560-1e69-437c-8226-7b0f8c4dc199\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Threat_Intelligence_Time_Range\",\"label\":\"Data from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"value\":{\"durationMs\":1209600000}},{\"id\":\"e7c7e2ea-f5b3-4505-b64c-b18ca8561168\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RF_Risk_list\",\"label\":\"Risk List\",\"type\":2,\"description\":\"Which Domain Risk List do you want to correlate against\",\"isRequired\":true,\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where isnotempty(FileHashValue)\\n| where Description contains \\\"Recorded Future\\\"\\n| summarize count() by Description\\n| project output = strcat('\\\"', Description, '\\\"')\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"\\\"Recorded Future - HASH - Observed in Underground Virus Testing Sites\\\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 1\"}],\"exportParameters\":true},\"name\":\"group - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected Domains Per Day\\n\\nThe chart displays the number of correlation detections per day between domain logs and Recorded Future's domain Risk lists.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query} \\r\\n| where Description == {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| extend FileHashValue = tolower(FileHashValue)\\r\\n| join (\\r\\n    {Hash_Logs_Table:value}\\r\\n    | where TimeGenerated {Hash_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend Hash_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.FileHashValue == $right.{Hash_Logs_Field:value}\\r\\n| summarize Correlation_Matches=count() by bin(Hash_TimeGenerated, 1d)\\r\\n| render barchart\",\"size\":0,\"title\":\"Detected File Hashes Per Day\",\"noDataMessage\":\"No detected hashes\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"}]},\"name\":\"group - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected Hashs\\n\\nThe Detected Hashs table lists hashs from the correlated logs that have been matched with Recorded Future Hash Risk Lists.\\n\\n**Table Columns**\\n\\n* **Risk Score:** The Recorded Future Risk Score for the Hashe (IOC), ranging from 1 to 99, with 99 being the highest level of severity.\\n* **Hash:** The detected hash.\\n* **Detected:** The time when the log was correlated with a Risk List.\\n* **Log Created:** The time when the log event itself was created.\\n* **Threat Classification:** The type of threat associated with the hash (IOC).\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| extend FileHashValue = tolower(FileHashValue)\\r\\n| join (\\r\\n    {Hash_Logs_Table:value}\\r\\n    | where TimeGenerated {Hash_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend Hash_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.FileHashValue == $right.{Hash_Logs_Field:value}\\r\\n| project [\\\"Risk Score\\\"]=ConfidenceScore, Hash=FileHashValue, Detected = format_datetime(TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Log Created\\\"] = format_datetime(Hash_TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Threat Classification\\\"]=ThreatType\\r\\n| summarize [\\\"Log Created\\\"]=max([\\\"Log Created\\\"]) by Hash, [\\\"Risk Score\\\"], Detected, [\\\"Threat Classification\\\"]\\r\\n| project [\\\"Risk Score\\\"], Hash, Detected, [\\\"Log Created\\\"], [\\\"Threat Classification\\\"]\\r\\n| sort by [\\\"Risk Score\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Detected Hashes\",\"noDataMessage\":\"No detected hashes\",\"exportedParameters\":[{\"fieldName\":\"Hash\",\"parameterName\":\"MaliciousHashMatch\",\"parameterType\":5}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Risk\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\">=\",\"thresholdValue\":\"90\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"65\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"25\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}}]}},\"customWidth\":\"70\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| extend FileHashValue = tolower(FileHashValue)\\r\\n| join (\\r\\n    {Hash_Logs_Table:value}\\r\\n    | where TimeGenerated {Hash_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend Hash_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.FileHashValue == $right.{Hash_Logs_Field:value}\\r\\n| project Risk=ConfidenceScore, FileHashValue, ThreatType, Tags\\r\\n| extend Evidence=parse_json(Tags)[0]\\r\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\r\\n| extend Rule=Evidence['Rule']\\r\\n| summarize count() by tostring(Rule)\\r\\n| sort by count_ desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Top Triggered Risk Rules\",\"noDataMessage\":\"No triggered Risk Rules\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}}],\"labelSettings\":[{\"columnId\":\"count_\",\"label\":\"Count\"}]}},\"customWidth\":\"30\",\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"### Detected Hashes: Evidence Details\\n\\nTo view evidence details, click a row (hash) in the Detected Hashes table.\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Description contains {RF_Risk_list:value}\\n| extend FileHashValue = tolower(FileHashValue)\\n| where FileHashValue == \\\"{MaliciousHashMatch}\\\"\\n| where isnotempty(Tags)\\n//| where ExpirationDateTime > now()\\n| extend Evidence=parse_json(Tags)[0]\\n| take 1\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\n| project Rules = Evidence['Rule'], Criticality = Evidence['Criticality'], Evidence_String = Evidence['EvidenceString']\\n| sort by toint(Criticality) desc\",\"size\":1,\"noDataMessage\":\"No evidence details to show\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousHashMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"\\n### Source data from {Hash_Logs_Table:value}\\n\\nTo view source data of correlated hash, click a row (hash) in the Detected Hashes table.\"},\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{Hash_Logs_Table:value}\\n| where TimeGenerated {Hash_Logs_Time_Range:query}\\n| where {Hash_Logs_Field:value} == \\\"{MaliciousHashMatch}\\\"\\n\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousHashMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 6\"}]},\"name\":\"group - 8\"}],\"styleSettings\":{\"paddingStyle\":\"wide\"},\"fromTemplateId\":\"sentinel-RecordedFutureHashCorrelationWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId4'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFutureHashCorrelationWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future Hash Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Recorded Future - Hash Correlation; templateRelativePath=RecordedFutureHashCorrelation.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId4')]",
                "contentId": "[variables('_workbookContentId4')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ThreatIntelligenceIndicator",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId4')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook4-name')]",
        "contentProductId": "[variables('_workbookcontentProductId4')]",
        "id": "[variables('_workbookcontentProductId4')]",
        "version": "[variables('workbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureIPCorrelationWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId5')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future IP Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel."
              },
              "properties": {
                "displayName": "[parameters('workbook5-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"041885bf-2e2c-42ae-ad35-2e12272b4dc4\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Guide\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":\"[variables('TemplateEmptyArray')]\"},\"jsonData\":\"[\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\", \\\"selected\\\":true},\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"No\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 6\"},{\"type\":1,\"content\":{\"json\":\"### Guide: IP Correlation \\n\\nRecorded Futures IP Correlation Workbook helps you detect malicious IPs within your environment by correlating your logs with Recorded Future IP Risk Lists.\\n\\n### How to Correlate IPs\\n\\nTo correlate IPs, follow the steps below:\\n\\n1. In the **IP Logs Table** dropdown, select a log table that contains IP logs.\\n\\t* If a particular log table is not listed in the dropdown, ensure it is enabled in your environment.\\n2. In the **Log field with IPs** dropdown, select the log field that holds the IPs to be correlated.\\n\\t* The workbook can correlate IPs in the format: `5.56.61.62`.\\n3. Select a Recorded Future IP Risk List for correlation.\\n4. If necessary, adjust the values in the **Logs from** and **Data from** dropdowns to match your requirements.\\n5. Done\\n\\n---\\n\\n#### Log table with examples of correlatable log fields\\n\\n\\n| Table                        | Field              | Table                           | Field     |\\n|------------------------------|--------------------|---------------------------------|-----------|\\n| AzureActivity                | CallerIpAddress    | VMConnection                    | RemoteIp  |\\n| AzureDiagnostics             | CallerIPAddress    | W3CIISLog                       | cIP       |\\n| AWSCloudTrail                | SourceIpAddress    | _Im_NetworkSession              | SrcIpAddr |\\n| AppServiceHTTPLogs           | CIp                | _Im_NetworkSession              | DstIpAddr |\\n| AzureDiagnostics             | client_ip_s        | _Im_WebSession                  | SrcIpAddr |\\n| CommonSecurityLog            | SourceIpAddress    | SigninLogs                      | IPAddress |\\n| CommonSecurityLog            | DestinationIP      | AADNonInteractiveUserSignInLogs | IPAddress |\\n| DuoSecurityAuthentication_CL | access_device_ip_s |                                 |           |\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### IP (from logs)\"},\"customWidth\":\"50\",\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Recorded Future Risk List\"},\"customWidth\":\"50\",\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b91b8b5b-10cf-4106-99e2-793eb0d72dce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IP_Logs_Time_Range\",\"label\":\"Logs from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":7776000000}},{\"id\":\"3300ad41-acbc-4ebd-900a-c6ab250b7c73\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IP_Logs_Table\",\"label\":\"IP Logs Table\",\"type\":2,\"description\":\"Log Table to correlate IPs Against\",\"isRequired\":true,\"query\":\"search * \\n| where TimeGenerated {IP_Logs_Time_Range:query}\\n| summarize count() by $table \\n| sort by count_ desc \\n| where $table != \\\"ThreatIntelligenceIndicator\\\" \\n| project $table\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"NetScreen_Firewall_CL\"},{\"id\":\"f4f77ada-b97c-4a82-9421-20a58fb7ce26\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IP_Logs_Field\",\"label\":\"Log Field with IPs\",\"type\":2,\"description\":\"Select the field containing the IP that you want to correlate against\",\"isRequired\":true,\"query\":\"{IP_Logs_Table:value}\\n| where TimeGenerated {IP_Logs_Time_Range:query}\\n| getschema\\n| where DataType == \\\"System.String\\\"\\n| project ColumnName\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Dst_IPv4_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"95e78560-1e69-437c-8226-7b0f8c4dc199\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Threat_Intelligence_Time_Range\",\"label\":\"Data from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"value\":{\"durationMs\":5184000000}},{\"id\":\"e7c7e2ea-f5b3-4505-b64c-b18ca8561168\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RF_Risk_list\",\"label\":\"Risk List\",\"type\":2,\"description\":\"Which IP Risk List do you want to correlate against\",\"isRequired\":true,\"query\":\"ThreatIntelligenceIndicator\\n| where isnotempty(NetworkIP)\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Description contains \\\"Recorded Future\\\"\\n//| summarize count() by Description\\n| distinct Description\\n| project output = strcat('\\\"', Description, '\\\"')\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"\\\"Recorded Future - IP - Actively Communicating C&C Server\\\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 1\"}],\"exportParameters\":true},\"name\":\"group - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected IPs Per Day\\n\\nThe chart displays the number of correlation detections per day between IP logs and Recorded Future's IP Risk lists.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {IP_Logs_Table:value}\\r\\n    | where TimeGenerated {IP_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend IP_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.NetworkIP == $right.{IP_Logs_Field:value}\\r\\n| summarize Correlation_Matches=count() by bin(IP_TimeGenerated, 1d)\\r\\n| render barchart\",\"size\":0,\"title\":\"Detected IPs Per Day\",\"noDataMessage\":\"No detected IPs\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"}]},\"name\":\"group - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected IPs\\n\\nThe Detected IPs table lists IPs from the correlated logs that have been matched with Recorded Future IP Risk Lists.\\n\\n**Table Columns**\\n\\n* **Risk Score:** The Recorded Future Risk Score for the IP (IOC), ranging from 1 to 99, with 99 being the highest level of severity.\\n* **IP:** The detected IP.\\n* **Detected:** The time when the log was correlated with a Risk List.\\n* **Log Created:** The time when the log event itself was created.\\n* **Threat Classification:** The type of threat associated with the IP (IOC).\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {IP_Logs_Table:value}\\r\\n    | where TimeGenerated {IP_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend IP_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.NetworkIP == $right.{IP_Logs_Field:value}\\r\\n| project [\\\"Risk Score\\\"]=ConfidenceScore, IP=NetworkIP, Detected=format_datetime(TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Log Created\\\"]=format_datetime(IP_TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Threat Classification\\\"]=ThreatType\\r\\n| summarize [\\\"Log Created\\\"]=max([\\\"Log Created\\\"]) by IP, [\\\"Risk Score\\\"], Detected, [\\\"Threat Classification\\\"]\\r\\n| project [\\\"Risk Score\\\"], IP, Detected, [\\\"Log Created\\\"], [\\\"Threat Classification\\\"]\\r\\n| sort by [\\\"Risk Score\\\"] desc\",\"size\":0,\"title\":\"Detected IPs\",\"noDataMessage\":\"No detected IPs\",\"exportedParameters\":[{\"fieldName\":\"IP\",\"parameterName\":\"MaliciousIPMatch\",\"parameterType\":5}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Risk\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\">=\",\"thresholdValue\":\"90\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"65\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"25\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AdditionalInformation\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"100%\"}}],\"sortBy\":[{\"itemKey\":\"$gen_thresholds_Risk_0\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"$gen_thresholds_Risk_0\",\"sortOrder\":2}]},\"customWidth\":\"70\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {IP_Logs_Table:value}\\r\\n    | where TimeGenerated {IP_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend IP_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.NetworkIP == $right.{IP_Logs_Field:value}\\r\\n| project Risk=ConfidenceScore, NetworkIP, ThreatType, Tags\\r\\n| extend Evidence=parse_json(Tags)[0]\\r\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\r\\n| extend Rule=Evidence['Rule']\\r\\n| summarize count() by tostring(Rule)\\r\\n| sort by count_ desc\",\"size\":0,\"title\":\"Top Triggered Risk Rules\",\"noDataMessage\":\"No triggered Risk Rules\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}}]}},\"customWidth\":\"30\",\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"### Detected IPs: Evidence Details\\n\\nTo view evidence details, click a row (IP) in the Detected IPs table.\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Description contains {RF_Risk_list:value}\\n| where NetworkIP == \\\"{MaliciousIPMatch}\\\"\\n| where isnotempty(Tags)\\n//| where ExpirationDateTime > now()\\n| extend Evidence=parse_json(Tags)[0]\\n| take 1\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\n| project Rules = Evidence['Rule'], Criticality = Evidence['Criticality'], Evidence_String = Evidence['EvidenceString']\\n| sort by toint(Criticality) desc\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Evidence_String\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"100%\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"MaliciousIPMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"\\n### Source data from {IP_Logs_Table:value}\\nTo view source data of correlated IP, click a row (IP) in the Detected IPs table.\"},\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{IP_Logs_Table:value}\\n| where TimeGenerated {IP_Logs_Time_Range:query}\\n| where {IP_Logs_Field:value} == \\\"{MaliciousIPMatch}\\\"\\n\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousIPMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 9\"}]},\"name\":\"group - 11\"}],\"styleSettings\":{\"paddingStyle\":\"wide\"},\"fromTemplateId\":\"sentinel-RecordedFutureIPCorrelationWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId5'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFutureIPCorrelationWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future IP Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Recorded Future - IP Correlation; templateRelativePath=RecordedFutureIPCorrelation.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId5')]",
                "contentId": "[variables('_workbookContentId5')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ThreatIntelligenceIndicator",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId5')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook5-name')]",
        "contentProductId": "[variables('_workbookcontentProductId5')]",
        "id": "[variables('_workbookcontentProductId5')]",
        "version": "[variables('workbookVersion5')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "RecordedFutureURLCorrelationWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId6')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Recorded Future URL Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel."
              },
              "properties": {
                "displayName": "[parameters('workbook6-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"d7ccc5ca-c8ec-458f-ab0d-564a7ef1d217\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Help\",\"label\":\"Show Guide\",\"type\":10,\"isRequired\":true,\"jsonData\":\"[\\n    {\\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\", \\\"selected\\\":true},\\n    {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\"}\\n]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"No\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 7\"},{\"type\":1,\"content\":{\"json\":\"### Guide: URL Correlation \\n\\nRecorded Futures URL Correlation Workbook helps you detect malicious URLs within your environment by correlating your logs with Recorded Future URL Risk Lists.\\n\\n### How to Correlate URLs\\n\\nTo correlate URLs, follow the steps below:\\n\\n1. In the **URL Logs Table** dropdown, select a log table that contains URL logs.\\n\\t* If a particular log table is not listed in the dropdown, ensure it is enabled in your environment.\\n2. In the **Log field with URLs** dropdown, select the log field that holds the URLs to be correlated.\\n\\t* The workbook can correlate URLs in the format: `https://testurl.here.net`.\\n3. Select a Recorded Future URL Risk List for correlation.\\n4. If necessary, adjust the values in the **Logs from** and **Data from** dropdowns to match your requirements.\\n5. Done\\n\\n---\\n\\n#### Log table with examples of correlatable log fields\\n\\n| Table             | Field      |\\n|-------------------|------------|\\n| CommonSecurityLog | RequestURL |\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### URL (from logs)\"},\"customWidth\":\"50\",\"name\":\"text - 2\"},{\"type\":1,\"content\":{\"json\":\"### Recorded Future Risk List\"},\"customWidth\":\"50\",\"name\":\"text - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"b91b8b5b-10cf-4106-99e2-793eb0d72dce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"URL_Logs_Time_Range\",\"label\":\"Logs from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":7776000000}},{\"id\":\"3300ad41-acbc-4ebd-900a-c6ab250b7c73\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"URL_Logs_Table\",\"label\":\"URL Logs Table\",\"type\":2,\"description\":\"Log Table to correlate URLs Against\",\"isRequired\":true,\"query\":\"search \\\"*\\\" \\n| where TimeGenerated {URL_Logs_Time_Range:query}\\n| summarize count() by $table | sort by count_ desc | where $table != \\\"ThreatIntelligenceIndicator\\\" | project $table\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Squid_Proxy_URL_CL\"},{\"id\":\"f4f77ada-b97c-4a82-9421-20a58fb7ce26\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"URL_Logs_Field\",\"label\":\"Log Field with URLs\",\"type\":2,\"description\":\"Select the field containing the URL that you want to correlate against\",\"isRequired\":true,\"query\":\"{URL_Logs_Table:value}\\n| getschema\\n| where DataType == \\\"System.String\\\"\\n| project ColumnName\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"URL_s\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"95e78560-1e69-437c-8226-7b0f8c4dc199\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Threat_Intelligence_Time_Range\",\"label\":\"Data from\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"value\":{\"durationMs\":7776000000}},{\"id\":\"e7c7e2ea-f5b3-4505-b64c-b18ca8561168\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RF_Risk_list\",\"label\":\"Risk List\",\"type\":2,\"description\":\"Which Domain Risk List do you want to correlate against\",\"isRequired\":true,\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where isnotempty(Url)\\n| where Description contains \\\"Recorded Future\\\"\\n| summarize count() by Description\\n| project output = strcat('\\\"', Description, '\\\"')\\n\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"\\\"Recorded Future - URL - Recently Reported by Insikt Group\\\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"parameters - 1\"}],\"exportParameters\":true},\"name\":\"group - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected URLs Per Day\\n\\nThe chart displays the number of correlation detections per day between URL logs and Recorded Future's URL Risk lists.\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {URL_Logs_Table:value}\\r\\n    | where TimeGenerated {URL_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend URL_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.Url == $right.{URL_Logs_Field:value}\\r\\n| summarize Correlation_Matches=count() by bin(URL_TimeGenerated, 1d)\\r\\n| render barchart\",\"size\":0,\"title\":\"Detected URLs Per Day\",\"noDataMessage\":\"No detected URLs\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"}]},\"name\":\"group - 11\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n### Guide: Detected URLs\\n\\nThe Detected URLs table lists URLs from the correlated logs that have been matched with Recorded Future URL Risk Lists.\\n\\n**Table Columns**\\n\\n* **Risk Score:** The Recorded Future Risk Score for the URL (IOC), ranging from 1 to 99, with 99 being the highest level of severity.\\n* **URL:** The detected URL.\\n* **Detected:** The time when the log was correlated with a Risk List.\\n* **Log Created:** The time when the log event itself was created.\\n* **Threat Classification:** The type of threat associated with the URL (IOC).\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"Help\",\"comparison\":\"isEqualTo\",\"value\":\"Yes\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {URL_Logs_Table:value}\\r\\n    | where TimeGenerated {URL_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend IP_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.Url == $right.{URL_Logs_Field:value}\\r\\n| project [\\\"Risk Score\\\"]=ConfidenceScore, URL=Url, Detected = format_datetime(TimeGenerated, 'yyyy-MM-dd HH:mm:ss'), [\\\"Log Created\\\"] = IP_TimeGenerated, [\\\"Threat Classification\\\"]=ThreatType\\r\\n| summarize [\\\"Log Created\\\"]=max([\\\"Log Created\\\"]) by URL, [\\\"Risk Score\\\"], Detected, [\\\"Threat Classification\\\"]\\r\\n| project [\\\"Risk Score\\\"], URL, Detected, [\\\"Log Created\\\"], [\\\"Threat Classification\\\"]\\r\\n| sort by [\\\"Risk Score\\\"] desc\\r\\n\",\"size\":0,\"title\":\"Detected URLs\",\"noDataMessage\":\"No detected URLs\",\"exportFieldName\":\"URL\",\"exportParameterName\":\"MaliciousURLMatch\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Risk\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\">=\",\"thresholdValue\":\"90\",\"representation\":\"redBright\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"65\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"25\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}}]}},\"customWidth\":\"70\",\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\r\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\r\\n| where Description contains {RF_Risk_list:value}\\r\\n| where isnotempty(Tags)\\r\\n| join (\\r\\n    {URL_Logs_Table:value}\\r\\n    | where TimeGenerated {URL_Logs_Time_Range:query}\\r\\n    // renaming time column so it is clear the log this came from\\r\\n    | extend URL_TimeGenerated = TimeGenerated\\r\\n)\\r\\non $left.Url == $right.{URL_Logs_Field:value}\\r\\n| project Risk=ConfidenceScore, Url, ThreatType, Tags\\r\\n| extend Evidence=parse_json(Tags)[0]\\r\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\r\\n| extend Rule=Evidence['Rule']\\r\\n| summarize count() by tostring(Rule)\\r\\n| sort by count_ desc\\r\\n\\r\\n\",\"size\":0,\"title\":\"Top Triggered Risk Rules\",\"noDataMessage\":\"No triggered Risk Rules\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"}}]}},\"customWidth\":\"30\",\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"### Detected URLs: Evidence Details\\n\\nTo view evidence details, click a row (URL) in the Detected URLs table.\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ThreatIntelligenceIndicator\\n| where TimeGenerated {Threat_Intelligence_Time_Range:query}\\n| where Description contains {RF_Risk_list}\\n| where Url == \\\"{MaliciousURLMatch}\\\"\\n| where isnotempty(Tags)\\n//| where ExpirationDateTime > now()\\n| extend Evidence=parse_json(Tags)[0]\\n| take 1\\n| mv-expand Evidence = parse_json(tostring(Evidence))\\n| project Rules = Evidence['Rule'], Criticality = Evidence['Criticality'], Evidence_String = Evidence['EvidenceString']\\n| sort by toint(Criticality) desc\",\"size\":1,\"noDataMessage\":\"ExpirationDateTime\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousURLMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"\\n### Source data from {URL_Logs_Table:value}\\nTo view source data of correlated URL, click a row (URL) in the Detected URLs table.\"},\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{URL_Logs_Table:value}\\n| where TimeGenerated {URL_Logs_Time_Range:query}\\n| where {URL_Logs_Field:value} == \\\"{MaliciousURLMatch}\\\"\\n\",\"size\":1,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"MaliciousURLMatch\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - 6\"}]},\"name\":\"group - 10\"}],\"styleSettings\":{\"paddingStyle\":\"wide\"},\"fromTemplateId\":\"sentinel-RecordedFutureURLCorrelationWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId6'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=RecordedFutureURLCorrelationWorkbook; logoFileName=RecordedFuture.svg; description=Recorded Future URL Correlation Workbook. This workbook will visualize Recorded Future threat intelligence data together with infrastructure logs ingested in to Sentinel.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.1; title=Recorded Future - URL Correlation; templateRelativePath=RecordedFutureURLCorrelation.json; subtitle=; provider=Recorded Future}.description",
                "parentId": "[variables('workbookId6')]",
                "contentId": "[variables('_workbookContentId6')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "http://support.recordedfuture.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ThreatIntelligenceIndicator",
                      "kind": "DataType"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId6')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook6-name')]",
        "contentProductId": "[variables('_workbookcontentProductId6')]",
        "id": "[variables('_workbookcontentProductId6')]",
        "version": "[variables('workbookVersion6')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Recorded Future",
        "publisherDisplayName": "Recorded Future Support Team",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p><a href=\"https://www.recordedfuture.com/\">Recorded Future</a> is the worlds largest provider of intelligence for enterprise security. By combining persistent and pervasive automated data collection and analytics with human analysis, Recorded Future delivers intelligence that is timely, accurate, and actionable.</p>\n<p>Playbooks have internal dependencies to RecordedFuture-ImportToSentinel so install the RecordedFuture-ImportToSentinel playbook before any of the others.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on functionality like Azure Logic Apps, Azure Monitor Logs. Some of these dependencies might result in additional ingestion or operational costs.</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/logic-apps/\">Azure Logic Apps</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/azure-monitor/logs/workspace-design\">Design a Log Analytics workspace</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/azure/sentinel/work-with-threat-indicators\">Work with Threat Indicators</a></li>\n</ul>\n<p><strong>Workbooks:</strong> 6, <strong>Analytic Rules:</strong> 6, <strong>Playbooks:</strong> 15</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/RecordedFuture.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Recorded Future",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Recorded Future Premier Integrations",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Recorded Future Support Team",
          "email": "support@recordedfuture.com",
          "tier": "Partner",
          "link": "http://support.recordedfuture.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId3')]",
              "version": "[variables('analyticRuleVersion3')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId4')]",
              "version": "[variables('analyticRuleVersion4')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId5')]",
              "version": "[variables('analyticRuleVersion5')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId6')]",
              "version": "[variables('analyticRuleVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-IOC_Enrichment-IP_Domain_URL_Hash')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Sandbox_Enrichment-Url')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Playbook-Alert-Importer')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Alert-Importer')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-ThreatIntelligenceImport')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Domain-IndicatorImport')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Hash-IndicatorImport')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-IP-IndicatorImport')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-URL-IndicatorImport')]",
              "version": "[variables('playbookVersion9')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-ImportToSentinel')]",
              "version": "[variables('playbookVersion10')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-DOMAIN-C2_DNS_Name-IndicatorProcessor')]",
              "version": "[variables('playbookVersion11')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-HASH-Observed_in_Underground_Virus_Test_Sites-IndicatorProcessor')]",
              "version": "[variables('playbookVersion12')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-IP-Actively_Comm_C2_Server-IndicatorProcessor')]",
              "version": "[variables('playbookVersion13')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-URL-Recent_Rep_by_Insikt_Group-IndicatorProcessor')]",
              "version": "[variables('playbookVersion14')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RecordedFuture-Ukraine-IndicatorProcessor')]",
              "version": "[variables('playbookVersion15')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId2')]",
              "version": "[variables('workbookVersion2')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId3')]",
              "version": "[variables('workbookVersion3')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId4')]",
              "version": "[variables('workbookVersion4')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId5')]",
              "version": "[variables('workbookVersion5')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId6')]",
              "version": "[variables('workbookVersion6')]"
            }
          ]
        },
        "firstPublishDate": "2021-11-01",
        "lastPublishDate": "2023-09-19",
        "providers": [
          "Recorded Future"
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
