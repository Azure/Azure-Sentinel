[
  {
    "name": "OCI_DCR",
    "apiVersion": "2023-03-11",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
      "streamDeclarations": {
        "Custom-OCI_LogsV2_CL": {
          "columns": [
            {
              "name": "data",
              "type": "dynamic"
            },
            {
              "name": "dataschema",
              "type": "string"
            },
            {
              "name": "id",
              "type": "string"
            },
            {
              "name": "oracle",
              "type": "dynamic"
            },
            {
              "name": "source",
              "type": "string"
            },
            {
              "name": "specversion",
              "type": "string"
            },
            {
              "name": "time",
              "type": "datetime"
            },
            {
              "name": "type",
              "type": "string"
            }
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": [
            "Custom-OCI_LogsV2_CL"
          ],
          "destinations": [
            "clv2ws1"
          ],
          "transformKql": "source | extend o = oracle, d = data | extend rq = d.request, rs = d.response, di = d.identity, dsc = d.stateChange.current, adDls = d.additionalDetails | extend py = rs.payload, rh = rq.headers, sh = rs.headers, pm = rs.parameters, dsci = dsc.Instance, dsca = dsc.agentConfig, dscl = dsc.launchOptions, dscsh = dsc.shapeConfig, dscsd = dsc.sourceDetails, time_t = [\"time\"], TimeGenerated = todatetime([\"time\"]), oracle_compartmentid_s = tostring(o.compartmentid), oracle_ingestedtime_t = todatetime(o.ingestedtime), oracle_loggroupid_s = tostring(o.loggroupid), oracle_tenantid_s = tostring(o.tenantid), oracle_logid_s = tostring(o.logid), oracle_vniccompartmentocid_s = tostring(o.vniccompartmentocid), oracle_vnicocid_s = tostring(o.vnicocid), oracle_vnicsubnetocid_s = tostring(o.vnicsubnetocid), data_endTime_d = toint(d.endTime), data_flowid_s = tostring(d.flowid), data_startTime_d = toint(d.startTime), data_status_s = tostring(d.status), data_version_s = tostring(d.version), data_action_s = tostring(d.action), data_bytesOut_d = toint(d.bytesOut), data_destinationAddress_s = tostring(d.destinationAddress), data_destinationPort_d = toint(d.destinationPort), data_packets_d = toint(d.packets), data_protocol_d = toint(d.protocol), data_protocolName_s = tostring(d.protocolName), data_sourceAddress_s = tostring(d.sourceAddress), data_sourcePort_d = toint(d.sourcePort) | extend data_request_parameters_serviceName_s = tostring(pm.serviceName), data_request_parameters_vcnId_s = tostring(pm.vcnId), data_request_parameters_imageId_s = tostring(pm.imageId), data_request_parameters_operatingSystem_s = tostring(pm.operatingSystemType), data_request_parameters_operatingSystemVersion_s = tostring(pm.operatingSystemVersion), data_request_parameters_shape_s = tostring(pm.shape), data_request_parameters_isMergeEnabled_s = tostring(pm.isMergeEnabled), data_identity_callerId_s = tostring(di.callerId), data_identity_callerName_s = tostring(di.callerName), data_request_headers_opc_obo_token_s = tostring(rh[\"opc-obo-token\"]), data_additionalDetails_imageId_s = tostring(adDls.imageId), data_additionalDetails_shape_s = tostring(adDls.shape), data_additionalDetails_type_s = tostring(adDls.type), data_additionalDetails_volumeId_s = tostring(adDls.volumeId), data_stateChange_current_systemTags_orcl_cloud_s = tostring(dsc.systemTags[\"orcl-cloud\"]), data_request_parameters_instanceId_s = tostring(pm.instanceId), data_request_headers_opc_retry_token_s = tostring(rh[\"opc-retry-token\"]), data_additionalDetails_isFreeTier_b = tobool(adDls.isFreeTier), data_stateChange_current_Instance_agentConfig_s = tostring(dsci.agentConfig), data_stateChange_current_Instance_availabilityConfig_s = tostring(dsci.availabilityConfig), data_stateChange_current_Instance_availabilityDomain_s = tostring(dsci.availabilityDomain), data_stateChange_current_Instance_compartmentId_s = tostring(dsci.compartmentId), data_stateChange_current_Instance_definedTags_s = tostring(dsci.definedTags), data_stateChange_current_Instance_displayName_s = tostring(dsci.displayName), data_response_headers_Content_Security_Policy_s = tostring(sh[\"Content-Security-Policy\"]), data_response_headers_Etag_s = tostring(sh[\"Etag\"]), data_response_headers_Opc_Request_Id_s = tostring(sh[\"opc-request-id\"]), data_response_headers_Strict_Transport_Security_s = tostring(sh[\"Strict-Transport-Security\"]), data_response_headers_X_Frame_Options_s = tostring(sh[\"X-Frame-Options\"]), data_response_headers_X_Xss_Protection_s = tostring(sh[\"X-Xss-Protection\"]), data_stateChange_current_compartmentId_s = tostring(dsc.compartmentId), data_stateChange_current_definedTags_Oracle_Tags_s = tostring(dsc.definedTags[\"Oracle-Tags\"]), data_stateChange_current_displayName_s = tostring(dsc.displayName), data_stateChange_current_id_s = tostring(dsc.id), data_stateChange_current_instanceId_s = tostring(dsc.instanceId), data_stateChange_current_lifecycleDetails_s = tostring(dsc.lifecycleDetails), data_stateChange_current_tenancyId_s = tostring(dsc.tenancyId), data_stateChange_current_timeUpdated_t = todatetime(dsc.timeUpdated), data_stateChange_current_userDisplayName_s = tostring(dsc.userDisplayName), data_stateChange_current_userName_s = tostring(dsc.userName), data_request_headers_oci_splat_generated_ocids_s = tostring(rh[\"oci-splat-generated-ocids\"]), data_response_headers_opc_work_request_id_s = tostring(sh[\"opc-work-request-id\"]), data_stateChange_current_configuration_s = tostring(dsc.configuration), data_stateChange_current_definedTags_s = tostring(dsc.definedTags), data_stateChange_current_freeformTags_s = tostring(dsc.freeformTags), data_stateChange_current_isEnabled_b = tobool(dsc.isEnabled), data_stateChange_current_logGroupId_s = tostring(dsc.logGroupId), data_stateChange_current_logType_s = tostring(dsc.logType), data_stateChange_current_retentionDuration_d = todouble(dsc.retentionDuration), data_stateChange_current_timeCreated_t = todatetime(dsc.timeCreated), data_stateChange_current_timeLastModified_t = todatetime(dsc.timeLastModified), data_request_headers_Cache_Control_s = tostring(rh[\"Cache-Control\"]), data_request_headers_Cookie_s = tostring(rh[\"Cookie\"]), data_response_headers_X_FRAME_OPTIONS_s = tostring(sh[\"X-FRAME-OPTIONS\"]), data_additionalDetails_id_s = tostring(adDls.id), data_availabilityDomain_s = tostring(d.availabilityDomain), data_compartmentId_s = tostring(d.compartmentId), data_compartmentName_s = tostring(d.compartmentName), data_definedTags_Oracle_Tags_CreatedBy_s = tostring(d.definedTags[\"Oracle-Tags\"].CreatedBy), data_definedTags_Oracle_Tags_CreatedOn_t = todatetime(d.definedTags[\"Oracle-Tags\"].CreatedOn), data_eventGroupingId_s = tostring(d.eventGroupingId), data_eventName_s = tostring(d.eventName), data_identity_ipAddress_s = tostring(di.ipAddress), data_identity_principalId_s = tostring(di.principalId), data_identity_tenantId_s = tostring(di.tenantId), data_identity_userAgent_s = tostring(di.userAgent), data_message_s = tostring(d.message), data_request_action_s = tostring(rq.action), data_request_headers_Connection_s = tostring(rh[\"Connection\"]), data_request_headers_User_Agent_s = tostring(rh[\"User-Agent\"]), data_request_headers_X_Forwarded_For_s = tostring(rh[\"X-Forwarded-For\"]), data_request_headers_auth_info_s = tostring(rh[\"auth_info\"]), data_request_headers_opc_request_id_s = tostring(rh[\"Opc-Request-Id\"]), data_request_id_s = tostring(rq.id), data_request_parameters_tenancy_s = tostring(pm.tenancy), data_request_path_s = tostring(rq.path), data_resourceId_s = tostring(d.resourceId), data_response_headers_Content_Length_d = todouble(sh[\"Content-Length\"]), data_response_headers_Content_Type_s = tostring(sh[\"Content-Type\"]), data_response_headers_Date_t = todatetime(sh[\"Date\"]), data_response_headers_ETag_s = tostring(sh[\"ETag\"]), data_response_headers_Vary_s = tostring(sh[\"Vary\"]), data_response_headers_opc_request_id_s = tostring(sh[\"opc-request-id\"]), data_response_responseTime_d = todouble(rs.responseTime), data_response_status_d = toint(rs.status), data_response_status_s = tostring(rs.status), dataschema_s = tostring(dataschema), id_s = tostring(id), source_s = tostring(source), specversion_s = tostring(specversion), type_s = tostring([\"type\"]), data_identity_authType_s = tostring(di.authType), data_identity_consoleSessionId_s = tostring(di.consoleSessionId), data_identity_credentials_s = tostring(di.credentials), data_identity_principalName_s = tostring(di.principalName), data_request_headers_Accept_s = tostring(rh[\"Accept\"]), data_request_headers_Accept_Encoding_s = tostring(rh[\"Accept-Encoding\"]), data_request_headers_Accept_Language_s = tostring(rh[\"Accept-Language\"]), data_request_headers_Origin_s = tostring(rh[\"Origin\"]), data_request_headers_Referer_s = tostring(rh[\"Referer\"]), data_request_headers_X_OCI_LB_NetworkMetadata_s = tostring(rh[\"X-OCI-LB-NetworkMetadata\"]), data_request_headers_X_Real_IP_s = tostring(rh[\"X-Real-IP\"]), data_request_headers_X_Real_Port_s = tostring(rh[\"X-Real-Port\"]), data_request_headers_oci_original_url_s = tostring(rh[\"oci-original-url\"]), data_request_headers_oci_skip_authorization_for_splat_s = tostring(rh[\"oci-skip-authorization-for-splat\"]), data_request_headers_opc_principal_s = tostring(rh[\"opc-principal\"]), data_request_headers_x_date_t = todatetime(rh[\"x-date\"]), data_request_parameters_compartmentId_s = tostring(pm.compartmentId), data_response_headers_Access_Control_Allow_Credentials_s = tostring(sh[\"Access-Control-Allow-Credentials\"]), data_response_headers_Access_Control_Allow_Origin_s = tostring(sh[\"Access-Control-Allow-Origin\"]), data_response_headers_Access_Control_Expose_Headers_s = tostring(sh[\"Access-Control-Expose-Headers\"]), data_request_parameters_limit_d = todouble(pm[\"limit\"]), data_request_headers_oci_splat_audited_s = tostring(rh[\"oci-splat-audited\"]), data_request_headers_oci_splat_internal_context_s = tostring(rh[\"oci-splat-internal-context\"]), data_request_parameters_sortBy_s = tostring(pm.sortBy), data_request_parameters_sortOrder_s = tostring(pm.sortOrder), data_additionalDetails_X_Real_Port_s = tostring(adDls[\"X-Real-Port\"]), data_freeformTags_VCN_s = tostring(d.freeformTags[\"VCN\"]), data_response_headers_Connection_s = tostring(sh[\"Connection\"]), data_response_headers_Timing_Allow_Origin_s = tostring(sh[\"Timing-Allow-Origin\"]), data_response_headers_X_Content_Type_Options_s = tostring(sh[\"X-Content-Type-Options\"]), data_request_headers_Content_Length_d = todouble(rh[\"Content-Length\"]), data_request_headers_Content_Type_s = tostring(rh[\"Content-Type\"]), data_request_headers_x_content_sha256_s = tostring(rh[\"x-content-sha256\"]), data_request_headers_If_None_Match_s = tostring(rh[\"If-None-Match\"]), data_response_headers_Content_Encoding_s = tostring(sh[\"Content-Encoding\"]), data_request_parameters_includeSubcompartments_b = tobool(pm.includeSubcompartments), data_response_headers_opc_limit_d = todouble(sh[\"opc-limit\"]), data_request_headers_Date_t = todatetime(rh[\"Date\"]), data_request_headers_opc_client_info_s = tostring(rh[\"opc-client-info\"]), data_request_parameters_endTime_t = todatetime(pm.endTime), data_request_parameters_startTime_t = todatetime(pm.startTime), data_response_headers_opc_next_page_s = tostring(sh[\"opc-next-page\"]), data_response_headers_opc_prev_page_s = tostring(sh[\"opc-prev-page\"]), data_request_parameters_id_s = tostring(pm.id), data_request_parameters_lifecycleState_s = tostring(pm.lifecycleState), data_request_parameters_name_s = tostring(pm.name), data_request_parameters_page_s = tostring(pm.page), data_request_parameters_streamPoolId_s = tostring(pm.streamPoolId), data_response_headers_opc_previous_page_s = tostring(sh[\"opc-previous-page\"]), data_response_payload_id_s = tostring(py.id), data_response_payload_resourceName_s = tostring(py.resourceName), data_request_headers_accept_language_s = tostring(rh[\"accept-language\"]), data_request_headers_authorization_s = tostring(rh[\"authorization\"]), data_response_headers_access_control_allow_credentials_s = tostring(sh[\"access-control-allow-credentials\"]), data_response_headers_access_control_allow_methods_s = tostring(sh[\"access-control-allow-methods\"]), data_response_headers_access_control_allow_origin_s = tostring(sh[\"access-control-allow-origin\"]), data_response_headers_access_control_expose_headers_s = tostring(sh[\"access-control-expose-headers\"]), data_response_headers_date_t = todatetime(sh[\"date\"]), data_response_headers_x_api_id_s = tostring(sh[\"x-api-id\"]), data_additionalDetails_namespace_s = tostring(adDls[\"namespace\"]), data_request_parameters_param0_s = tostring(pm.param0), data_response_headers_Cache_Control_s = tostring(sh[\"Cache-Control\"]), data_response_headers_Pragma_s = tostring(sh[\"Pragma\"]), data_response_headers_Transfer_Encoding_s = tostring(sh[\"Transfer-Encoding\"]), data_request_parameters_accessLevel_s = tostring(pm.accessLevel), data_request_parameters_compartmentIdInSubtree_b = tobool(pm.compartmentIdInSubtree), data_additionalDetails_description_s = tostring(adDls[\"description\"]), data_additionalDetails_isAccessable_b = tobool(adDls[\"isAccessable\"]), data_additionalDetails_lifeCycleState_s = tostring(adDls[\"lifeCycleState\"]), data_additionalDetails_homeRegionKey_s = tostring(adDls[\"homeRegionKey\"]), data_additionalDetails_oracleMyServicesIdentifier_s = tostring(adDls[\"oracleMyServicesIdentifier\"]), data_request_headers_X_Forwarded_Host_s = tostring(rh[\"X-Forwarded-Host\"]), data_request_headers_X_Forwarded_Port_s = tostring(rh[\"X-Forwarded-Port\"]), data_request_headers_X_Forwarded_Proto_s = tostring(rh[\"X-Forwarded-Proto\"]), data_request_headers_X_Oracle_Auth_Client_CN_s = tostring(rh[\"X-Oracle-Auth-Client-CN\"]), data_request_parameters_isBanner_b = tobool(pm.isBanner), data_request_parameters_granularity_s = tostring(pm.granularity), data_request_parameters_protocol_s = tostring(pm.protocol), data_additionalDetails_userId_s = tostring(adDls[\"userId\"]), data_response_headers_Location_s = tostring(sh[\"Location\"]), data_stateChange_current_fingerprint_s = tostring(dsc.fingerprint), data_stateChange_current_keyId_s = tostring(dsc.keyId), data_stateChange_current_keyValue_s = tostring(dsc.keyValue), data_stateChange_current_lifecycleState_s = tostring(dsc.lifecycleState), data_stateChange_current_userId_s = tostring(dsc.userId), data_request_parameters_userId_s = tostring(pm.userId), data_request_headers_X_OCI_LB_PrivateAccessMetadata_s = tostring(rh[\"X-OCI-LB-PrivateAccessMetadata\"]), data_request_headers_date_t = todatetime(rh[\"date\"]), data_stateChange_current_LoadBalancers_s = tostring(dsc.LoadBalancers), data_request_parameters_fields_s = tostring(pm.fields), data_request_parameters_availabilityDomain_s = tostring(pm.availabilityDomain), data_request_parameters_subnetId_s = tostring(pm.subnetId) | extend EventVendor = 'Oracle', EventProduct = 'Oracle Cloud Infrastructure', EventStartTime = iff(isnotnull(columnifexists(\"data_startTime_d\", long(null))), todatetime(columnifexists(\"data_startTime_d\", long(null))), time_t), EventEndTime = iff(isnotnull(columnifexists(\"data_endTime_d\", long(null))), todatetime(columnifexists(\"data_endTime_d\", long(null))), time_t), SrcIpAddr = iff(isnotempty(columnifexists(\"data_sourceAddress_s\", '')), columnifexists(\"data_sourceAddress_s\", ''), data_identity_ipAddress_s), SrcPortNumber=columnifexists(\"data_sourcePort_d\", ''), DstIpAddr=columnifexists (\"data_destinationAddress_s\", ''), DstPortNumber=columnifexists (\"data_destinationPort_d\", ''), DstBytes=columnifexists (\"data_bytesOut_d\", ''), NetworkProtocol=columnifexists (\"data_protocolName_s\", ''), data_stateChange_current_Instance_displayName_s = columnifexists(\"data_stateChange_current_Instance_displayName_s\", ''), data_stateChange_current_userName_s = columnifexists(\"data_stateChange_current_userName_s\", ''), data_request_headers_oci_original_url_s = columnifexists(\"data_request_headers_oci_original_url_s\", ''), data_action_s = columnifexists(\"data_action_s\", '') | project-rename EventType=type_s, EventMessage=data_message_s, HttpUserAgentOriginal=data_identity_userAgent_s, HttpStatusCode=data_response_status_s, HttpRequestMethod=data_request_action_s | project-away d, o, [\"time\"], [\"type\"], rs, rq, di, dsc, adDls, py, rh, sh, pm, dsci, dsca, dscl, dscsh, dscsd, dataschema, source, specversion\n",
          "outputStream": "Custom-OCI_LogsV2_CL"
        }
      ]
    }
  }
]
