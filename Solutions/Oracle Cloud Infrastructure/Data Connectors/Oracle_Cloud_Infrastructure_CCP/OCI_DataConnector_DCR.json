{
  "name": "OCI_DCR",
  "apiVersion": "2023-03-11",
  "type": "Microsoft.Insights/dataCollectionRules",
  "location": "{{location}}",
  "properties": {
    "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
    "streamDeclarations": {
      "Custom-OCI_LogsV2_CL": {
        "columns": [
          {
            "name": "data",
            "type": "dynamic"
          },
          {
            "name": "id",
            "type": "string"
          },
          {
            "name": "oracle",
            "type": "dynamic"
          },
          {
            "name": "time",
            "type": "datetime"
          },
          {
            "name": "dataschema",
            "type": "string"
          },
          {
            "name": "source",
            "type": "string"
          },
          {
            "name": "specversion",
            "type": "string"
          },
          {
            "name": "type",
            "type": "string"
          },
          {
            "name": "EventVendor",
            "type": "string"
          },
          {
            "name": "EventProduct",
            "type": "string"
          },
          {
            "name": "stream",
            "type": "string"
          }
        ]
      }
    },
    "destinations": {
      "logAnalytics": [
        {
          "workspaceResourceId": "{{workspaceResourceId}}",
          "name": "clv2ws1"
        }
      ]
    },
    "dataFlows": [
      {
        "streams": [
          "Custom-OCI_LogsV2_CL"
        ],
        "destinations": [
          "clv2ws1"
        ],
        "outputStream": "Custom-OCI_LogsV2_CL",
        "transformKql": "source | extend dqp=data.request.parameters,drh=data.response.headers,dqh=data.request.headers,ds=data.response,dq=data.request,o=oracle,d=data | project TimeGenerated=['time'],data,id,oracle,time_t=['time'],oracle_compartmentid_s=tostring(o.compartmentid),oracle_ingestedtime_t=todatetime(o.ingestedtime),oracle_loggroupid_s=tostring(o.loggroupid),oracle_tenantid_s=tostring(o.tenantid),oracle_logid_s=tostring(o.logid),oracle_vniccompartmentocid_s=tostring(o.vniccompartmentocid),oracle_vnicocid_s=tostring(o.vnicocid),oracle_vnicsubnetocid_s=tostring(o.vnicsubnetocid),data_endTime_d=toint(d.endTime),data_flowid_s=tostring(d.flowid),data_startTime_d=toint(d.startTime),data_status_s=tostring(d.status),data_version_s=tostring(d.version),data_action_s=tostring(d.action),data_bytesOut_d=toint(d.bytesOut),data_destinationAddress_s=tostring(d.destinationAddress),data_destinationPort_d=toint(d.destinationPort),data_packets_d=toint(d.packets),data_protocol_d=toint(d.protocol),data_protocolName_s=tostring(d.protocolName),data_sourceAddress_s=tostring(d.sourceAddress),data_sourcePort_d=toint(d.sourcePort),data_availabilityDomain_s=tostring(d.availabilityDomain),data_compartmentId_s=tostring(d.compartmentId),data_compartmentName_s=tostring(d.compartmentName),data_eventGroupingId_s=tostring(d.eventGroupingId),data_eventName_s=tostring(d.eventName),data_request_id_s=tostring(d.id),data_request_path_s=tostring(d.path),data_resourceId_s=tostring(d.resourceId),data_request_parameters_serviceName_s=tostring(dqp.serviceName),data_request_parameters_vcnId_s=tostring(dqp.vcnId),data_request_parameters_imageId_s=tostring(dqp.imageId),data_request_parameters_operatingSystem_s=tostring(dqp.operatingSystem),data_request_parameters_operatingSystemVersion_s=tostring(dqp.operatingSystemVersion),data_request_parameters_shape_s=tostring(dqp.shape),data_request_parameters_isMergeEnabled_s=tostring(dqp.isMergeEnabled),data_request_parameters_instanceId_s=tostring(dqp.instanceId),data_request_parameters_tenancy_s=tostring(dqp.tenancy),data_request_parameters_compartmentId_s=tostring(dqp.compartmentId),data_request_parameters_limit_d=todouble(dq.parameters['limit']),data_request_parameters_sortBy_s=tostring(dqp.sortBy),data_request_parameters_sortOrder_s=tostring(dqp.sortOrder),data_request_parameters_includeSubcompartments_b=tobool(dqp.includeSubcompartments),data_request_parameters_endTime_t=todatetime(dqp.endTime),data_request_parameters_startTime_t=todatetime(dqp.startTime),data_request_parameters_id_s=tostring(dqp.id),data_request_parameters_lifecycleState_s=tostring(dqp.lifecycleState),data_request_parameters_name_s=tostring(dqp.name),data_request_parameters_page_s=tostring(dqp.page),data_request_parameters_streamPoolId_s=tostring(dqp.streamPoolId),data_request_parameters_param0_s=tostring(dqp.param0),data_request_parameters_accessLevel_s=tostring(dqp.accessLevel),data_request_parameters_compartmentIdInSubtree_b=tobool(dqp.compartmentIdInSubtree),data_request_parameters_isBanner_b=tobool(dqp.isBanner),data_request_parameters_granularity_s=tostring(dqp.granularity),data_request_parameters_protocol_s=tostring(dqp.protocol),data_request_parameters_userId_s=tostring(dqp.userId),data_request_parameters_fields_s=tostring(dqp.fields),data_request_parameters_availabilityDomain_s=tostring(dqp.availabilityDomain),data_request_parameters_subnetId_s=tostring(dqp.subnetId),data_identity_callerId_s=tostring(d.identity.callerId),data_identity_callerName_s=tostring(d.identity.callerName),data_identity_ipAddress_s=tostring(d.identity.ipAddress),data_identity_principalId_s=tostring(d.identity.principalId),data_identity_tenantId_s=tostring(d.identity.tenantId),data_identity_authType_s=tostring(d.identity.authType),data_identity_consoleSessionId_s=tostring(d.identity.consoleSessionId),data_identity_credentials_s=tostring(d.identity.credentials),data_identity_principalName_s=tostring(d.identity.principalName),HttpUserAgentOriginal=tostring(d.identity.userAgent),data_request_headers_opc_obo_token_s=tostring(dqh.opc_obo_token),data_request_headers_opc_retry_token_s=tostring(dqh.opc_retry_token),data_request_headers_Cache_Control_s=tostring(dqh.Cache_Control),data_request_headers_Cookie_s=tostring(dqh.Cookie),data_request_headers_Connection_s=tostring(dqh.Connection),data_request_headers_User_Agent_s=tostring(dqh.User_Agent),data_request_headers_X_Forwarded_For_s=tostring(dqh.X_Forwarded_For),data_request_headers_auth_info_s=tostring(dqh.auth_info),data_request_headers_opc_request_id_s=tostring(dqh.opc_request_id),data_request_headers_Accept_s=tostring(dqh.Accept),data_request_headers_Accept_Encoding_s=tostring(dqh.Accept_Encoding),data_request_headers_Accept_Language_s=tostring(dqh.Accept_Language),data_request_headers_Origin_s=tostring(dqh.Origin),data_request_headers_Referer_s=tostring(dqh.Referer),data_request_headers_X_OCI_LB_NetworkMetadata_s=tostring(dqh.X_OCI_LB_NetworkMetadata),data_request_headers_X_Real_IP_s=tostring(dqh.X_Real_IP),data_request_headers_X_Real_Port_s=tostring(dqh.X_Real_Port),data_request_headers_oci_skip_authorization_for_splat_s=tostring(dqh.oci_skip_authorization_for_splat),data_request_headers_opc_principal_s=tostring(dqh.opc_principal),data_request_headers_x_date_t=todatetime(dqh.x_date),data_request_headers_oci_splat_audited_s=tostring(dqh.oci_splat_audited),data_request_headers_oci_splat_internal_context_s=tostring(dqh.oci_splat_internal_context),data_request_headers_Content_Length_d=todouble(dqh.Content_Length),data_request_headers_Content_Type_s=tostring(dqh.Content_Type),data_request_headers_x_content_sha256_s=tostring(dqh.x_content_sha256),data_request_headers_If_None_Match_s=tostring(dqh.If_None_Match),data_request_headers_Date_t=todatetime(dqh.Date),data_request_headers_opc_client_info_s=tostring(dqh.opc_client_info),data_request_headers_accept_language_s=tostring(dqh.accept_language),data_request_headers_authorization_s=tostring(dqh.authorization),data_request_headers_X_Forwarded_Host_s=tostring(dqh.X_Forwarded_Host),data_request_headers_X_Forwarded_Port_s=tostring(dqh.X_Forwarded_Port),data_request_headers_X_Forwarded_Proto_s=tostring(dqh.X_Forwarded_Proto),data_request_headers_X_Oracle_Auth_Client_CN_s=tostring(dqh.X_Oracle_Auth_Client_CN),data_request_headers_X_OCI_LB_PrivateAccessMetadata_s=tostring(dqh.X_OCI_LB_PrivateAccessMetadata),data_request_headers_date_t=todatetime(dq.headers['date']),data_request_headers_oci_splat_generated_ocids_s=tostring(dqh.oci_splat_generated_ocids),data_request_headers_oci_original_url_s=tostring(dqh.oci_original_url),data_additionalDetails_imageId_s=tostring(d.additionalDetails.imageId),data_additionalDetails_shape_s=tostring(d.additionalDetails.shape),data_additionalDetails_type_s=tostring(d.additionalDetails.type),data_additionalDetails_volumeId_s=tostring(d.additionalDetails.volumeId),data_additionalDetails_isFreeTier_b=tobool(d.additionalDetails.isFreeTier),data_additionalDetails_id_s=tostring(d.additionalDetails.id),data_additionalDetails_X_Real_Port_s=tostring(d.additionalDetails.X_Real_Port),data_additionalDetails_namespace_s=tostring(d.additionalDetails.namespace),data_additionalDetails_description_s=tostring(d.additionalDetails.description),data_additionalDetails_isAccessable_b=tobool(d.additionalDetails.isAccessable),data_additionalDetails_lifeCycleState_s=tostring(d.additionalDetails.lifeCycleState),data_additionalDetails_homeRegionKey_s=tostring(d.additionalDetails.homeRegionKey),data_additionalDetails_oracleMyServicesIdentifier_s=tostring(d.additionalDetails.oracleMyServicesIdentifier),data_additionalDetails_userId_s=tostring(d.additionalDetails.userId),data_stateChange_current_systemTags_orcl_cloud_s=tostring(d.stateChange.current.systemTags.orcl_cloud),data_stateChange_current_Instance_agentConfig_s=tostring(d.stateChange.current.Instance.agentConfig),data_stateChange_current_Instance_availabilityConfig_s=tostring(d.stateChange.current.Instance.availabilityConfig),data_stateChange_current_Instance_availabilityDomain_s=tostring(d.stateChange.current.Instance.availabilityDomain),data_stateChange_current_Instance_compartmentId_s=tostring(d.stateChange.current.Instance.compartmentId),data_stateChange_current_Instance_definedTags_s=tostring(d.stateChange.current.Instance.definedTags),data_stateChange_current_Instance_displayName_s=tostring(d.stateChange.current.Instance.displayName),data_stateChange_current_compartmentId_s=tostring(d.stateChange.current.compartmentId),data_stateChange_current_displayName_s=tostring(d.stateChange.current.displayName),data_stateChange_current_id_s=tostring(d.stateChange.current.id),data_stateChange_current_instanceId_s=tostring(d.stateChange.current.instanceId),data_stateChange_current_lifecycleDetails_s=tostring(d.stateChange.current.lifecycleDetails),data_stateChange_current_tenancyId_s=tostring(d.stateChange.current.tenancyId),data_stateChange_current_timeUpdated_t=todatetime(d.stateChange.current.timeUpdated),data_stateChange_current_userDisplayName_s=tostring(d.stateChange.current.userDisplayName),data_stateChange_current_configuration_s=tostring(d.stateChange.current.configuration),data_stateChange_current_definedTags_s=tostring(d.stateChange.current.definedTags),data_stateChange_current_freeformTags_s=tostring(d.stateChange.current.freeformTags),data_stateChange_current_isEnabled_b=tobool(d.stateChange.current.isEnabled),data_stateChange_current_logGroupId_s=tostring(d.stateChange.current.logGroupId),data_stateChange_current_logType_s=tostring(d.stateChange.current.logType),data_stateChange_current_retentionDuration_d=todouble(d.stateChange.current.retentionDuration),data_stateChange_current_timeCreated_t=todatetime(d.stateChange.current.timeCreated),data_stateChange_current_timeLastModified_t=todatetime(d.stateChange.current.timeLastModified),data_stateChange_current_fingerprint_s=tostring(d.stateChange.current.fingerprint),data_stateChange_current_keyId_s=tostring(d.stateChange.current.keyId),data_stateChange_current_keyValue_s=tostring(d.stateChange.current.keyValue),data_stateChange_current_lifecycleState_s=tostring(d.stateChange.current.lifecycleState),data_stateChange_current_userId_s=tostring(d.stateChange.current.userId),data_stateChange_current_LoadBalancers_s=tostring(d.stateChange.current.LoadBalancers),data_stateChange_current_userName_s=tostring(d.stateChange.current.userName),data_stateChange_current_definedTags_Oracle_Tags_s=tostring(d.stateChange.current.definedTags.Oracle_Tags),data_definedTags_Oracle_Tags_CreatedBy_s=tostring(d.definedTags['Oracle-Tags'].CreatedBy),data_definedTags_Oracle_Tags_CreatedOn_t=todatetime(d.definedTags['Oracle-Tags'].CreatedOn),data_freeformTags_VCN_s=tostring(d.freeformTags.VCN),data_response_headers_Content_Security_Policy_s=tostring(drh.Content_Security_Policy),data_response_headers_Etag_s=tostring(drh.Etag),data_response_headers_Opc_Request_Id_s=tostring(drh.Opc_Request_Id),data_response_headers_Strict_Transport_Security_s=tostring(drh.Strict_Transport_Security),data_response_headers_X_Frame_Options_s=tostring(drh.X_Frame_Options),data_response_headers_X_Xss_Protection_s=tostring(drh.X_Xss_Protection),data_response_headers_opc_work_request_id_s=tostring(drh.opc_work_request_id),data_response_headers_X_FRAME_OPTIONS_s=tostring(drh.X_FRAME_OPTIONS),data_response_headers_Content_Length_d=todouble(drh.Content_Length),data_response_headers_Content_Type_s=tostring(drh.Content_Type),data_response_headers_Date_t=todatetime(drh.Date),data_response_headers_ETag_s=tostring(drh.ETag),data_response_headers_Vary_s=tostring(drh.Vary),data_response_headers_opc_request_id_s=tostring(drh.opc_request_id),data_response_headers_Access_Control_Allow_Credentials_s=tostring(drh.Access_Control_Allow_Credentials),data_response_headers_Access_Control_Allow_Origin_s=tostring(drh.Access_Control_Allow_Origin),data_response_headers_Access_Control_Expose_Headers_s=tostring(drh.Access_Control_Expose_Headers),data_response_headers_Connection_s=tostring(drh.Connection),data_response_headers_Timing_Allow_Origin_s=tostring(drh.Timing_Allow_Origin),data_response_headers_X_Content_Type_Options_s=tostring(drh.X_Content_Type_Options),data_response_headers_Content_Encoding_s=tostring(drh.Content_Encoding),data_response_headers_opc_limit_d=todouble(drh.opc_limit),data_response_headers_opc_next_page_s=tostring(drh.opc_next_page),data_response_headers_opc_prev_page_s=tostring(drh.opc_prev_page),data_response_headers_opc_previous_page_s=tostring(drh.opc_previous_page),data_response_headers_access_control_allow_credentials_s=tostring(drh.access_control_allow_credentials),data_response_headers_access_control_allow_methods_s=tostring(drh.access_control_allow_methods),data_response_headers_access_control_allow_origin_s=tostring(drh.access_control_allow_origin),data_response_headers_access_control_expose_headers_s=tostring(drh.access_control_expose_headers),data_response_headers_date_t=todatetime(ds.headers['date']),data_response_headers_x_api_id_s=tostring(drh.x_api_id),data_response_headers_Cache_Control_s=tostring(drh.Cache_Control),data_response_headers_Pragma_s=tostring(drh.Pragma),data_response_headers_Transfer_Encoding_s=tostring(drh.Transfer_Encoding),data_response_headers_Location_s=tostring(drh.Location),data_response_responseTime_d=todouble(ds.responseTime),data_response_status_d=toint(ds.status),data_response_payload_id_s=tostring(ds.payload.id),data_response_payload_resourceName_s=tostring(ds.payload.resourceName),EventMessage=tostring(d.message),HttpRequestMethod=tostring(dq.action),HttpStatusCode=tostring(ds.status),EventStartTime=todatetime(d.startTime),EventEndTime=todatetime(d.endTime),SrcIpAddr=tostring(d.identity.ipAddres),SrcPortNumber=toint(d.sourcePort),DstIpAddr=tostring(d.destinationAddress),DstPortNumber=toint(d.destinationPort),DstBytes=toint(d.bytesOut),NetworkProtocol=tostring(d.protocolName),dataschema_s=['dataschema'],id_s=['id'],source_s=['source'],specversion_s=['specversion'],EventType=['type'],EventVendor,EventProduct,StreamName=['stream']"
      }
    ]
  }
}