id: 634600b4-d931-4a58-a21f-1de3dd35df23
Function:
  Title: Parser for ProofpointPOD using new CCF connector tables
  Version: '1.2.1'
  LastUpdated: '2025-06-01'
Category: Microsoft Sentinel Parser
FunctionName: ProofpointPOD
FunctionAlias: ProofpointPOD
FunctionQuery: |
let ProofpointPOD_maillog_view = view ()
{
    ProofpointPODMailLog_CL
    | where isnotempty(id) and Type == "ProofpointPODMailLog_CL"
    | extend
        Id                             = ['id'],
        EventOriginalMessage           = ['data'],
        EventOriginalTime              = ['eventTime'],
        MetadataOriginDataAgent        = ['metadata'].['origin'].['data'].['agent'],
        MetadataOriginDataCid          = ['metadata'].['origin'].['data'].['cid'],
        PpsAgent                       = ['pps'].['agent'],
        PpsCid                         = ['pps'].['cid'],
        NetworkDuration                = ['sm'].['delay'],
        SmDsn                          = ['sm'].['dsn'],
        SmMailer                       = ['sm'].['mailer'],
        SmPri                          = ['sm'].['pri'],
        SmQid                          = ['sm'].['qid'],
        SrcNatIpAddr                   = ['sm'].['relay'],
        NetworkConnectionStateDetailed = ['sm'].['stat'],
        DstUserUpn                     = ['sm'].['to'],
        SmXdelay                       = ['sm'].['xdelay'],
        TlsEstablished                 = ['tls'].['verify'],
        EventType                      = "Mail"
    // EventProduct                   = "Proofpoint On Demand Email Security",
    // EventVendor                    = "Proofpoint",
    // NetworkBytes                   = toreal(['sm'].['sizeBytes']),
    // NetworkProtocol                = ['sm'].['proto'],
    // ProcessName                    = ['sm'].['daemon'],
    // SmAuth                         = ['sm'].['auth'],
    // EventUid                       = ['sm'].['msgid'],
    // SmClass                        = ['sm'].['class'],
    // SmCtladdr                      = ['sm'].['ctladdr'],
    // SmMsgid                        = ['sm'].['msgid'],
    // SmNrcpts                       = ['sm'].['nrcpts'],
    // SrcUserUpn                     = ['sm'].['from'],
    | project
        TimeGenerated,
        Id,
        EventOriginalMessage,
        EventOriginalTime,
        MetadataOriginDataAgent,
        MetadataOriginDataCid,
        PpsAgent,
        PpsCid,
        NetworkDuration,
        SmDsn,
        SmMailer,
        SmPri,
        SmQid,
        SrcNatIpAddr,
        NetworkConnectionStateDetailed,
        DstUserUpn,
        SmXdelay,
        TlsEstablished,
        EventType
//,
//NetworkBytes,
//NetworkProtocol,
//ProcessName,
//SmAuth,
//SmClass,
//SmCtladdr,
//SmMsgid,
//SmNrcpts,
//SrcUserUpn,
//EventVendor,
//EventProduct,
//EventUid
}
    ;
let ProofpointPOD_message_view = view ()
{
    ProofpointPODMessage_CL
    | where Type == "ProofpointPODMessage_CL"
    | extend
        EventOriginalTime                                         = ['eventTime'],
        Guid                                                      = ['guid'],
        SrcGeoCountry                                             = ['connection'].['country'],
        ConnectionHelo                                            = ['connection'].['helo'],
        SrcDvcHostname                                            = ['connection'].['host'],
        SrcIpAddr                                                 = ['connection'].['ip'],
        NetworkProtocol                                           = ['connection'].['protocol'],
        NetworkConnectionState                                    = ['connection'].['resolveStatus'],
        NetworkSessionId                                          = ['connection'].['sid'],
        TlsCipher                                                 = ['connection'].['tls'].['inbound'].['cipher'],
        TlsCipherBits                                             = ['connection'].['tls'].['inbound'].['cipherBits'],
        TlsVersion                                                = ['connection'].['tls'].['inbound'].['version'],
        SrcUserUpn                                                = ['envelope'].['from'],
        DstUserUpn                                                = ['envelope'].['rcpts'],
        // EnvelopeFromHashed                                        = ['envelope'].['fromHashed'],
        // EnvelopeRcptsHashed                                       = ['envelope'].['rcptsHashed'],
        // MsgHeaderFromHashed                                       = ['msg'].['header'].['fromHashed'],
        MsgHeaderFrom                                             = ['msg'].['header'].['from'],
        MsgHeaderMessageId                                        = ['msg'].['header'].['message-id'],
        MsgHeaderSubject                                          = ['msg'].['header'].['subject'],
        MsgHeaderTo                                               = ['msg'].['header'].['to'],
        MsgHeaderXOriginatorOrg                                   = ['msg'].['header'].['x-originatororg'],
        MsgHeaderCc                                               = ['msg'].['header'].['cc'],
        // MsgHeaderCcHashed                                         = ['msg'].['header'].['ccHashed'],
        MsgHeaderReplyTo                                          = ['msg'].['header'].['reply'].['to'], //maynotexist!?
        // MsgHeaderReplyToHashed                                    = ['msg'].['header'].['reply'].['toHashed'],
        MsgHeaderReturnPath                                       = ['msg'].['header'].['return'].['path'], //maynotexist!?
        // MsgHeaderReturnPathHashed                                 = ['msg'].['header'].['return'].['pathHashed'],
        // MsgHeaderToHashed                                         = ['msg'].['header'].['toHashed'],
        MsgHeaderXMailer                                          = ['msg'].['header'].['x'].['mailer'], //maynotexist!?
        MsgHeaderXOriginatingIp                                   = ['msg'].['header'].['x'].['originating'].['ip'], //maynotexist!?
        MsgLang                                                   = ['msg'].['lang'],
        MsgNormalizedHeaderCc                                     = ['msg'].['normalizedHeader'].['cc'],
        //MsgNormalizedHeaderCcHashed                               = ['msg'].['normalizedHeader'].['ccHashed'],
        MsgNormalizedHeaderFrom                                   = ['msg'].['normalizedHeader'].['from'],
        //MsgNormalizedHeaderFromHashed                             = ['msg'].['normalizedHeader'].['fromHashed'],
        MsgNormalizedHeaderMessageId                              = ['msg'].['normalizedHeader'].['message-id'],
        MsgNormalizedHeaderSubject                                = ['msg'].['normalizedHeader'].['subject'],
        MsgNormalizedHeaderTo                                     = ['msg'].['normalizedHeader'].['to'],
        MsgNormalizedHeaderXOriginatorOrg                         = ['msg'].['normalizedHeader'].['x-originatororg'],
        MsgNormalizedHeaderReplyTo                                = ['msg'].['normalizedHeader'].['reply'].['to'], //maynotexist!?
        //MsgNormalizedHeaderReplyToHashed                          = ['msg'].['normalizedHeader'].['reply'].['toHashed'],
        MsgNormalizedHeaderReturnPath                             = ['msg'].['normalizedHeader'].['return'].['path'], //maynotexist!?
        // MsgNormalizedHeaderReturnPathHashed                       = ['msg'].['normalizedHeader'].['return'].['pathHashed'],
        // MsgNormalizedHeadertoHashed                               = ['msg'].['normalizedHeader'].['toHashed'],
        MsgNormalizedHeaderXMailer                                = ['msg'].['normalizedHeader'].['x'].['mailer'], //maynotexist!?
        MsgNormalizedHeaderXOriginatingIp                         = ['msg'].['normalizedHeader'].['x'].['originating'].['ip'], //maynotexist!?
        MsgParsedAddressesCc                                      = ['msg'].['parsedAddresses'].['cc'],
        // MsgParsedAddressesCcHashed                                = ['msg'].['parsedAddresses'].['ccHashed'],
        MsgParsedAddressesFrom                                    = ['msg'].['parsedAddresses'].['from'],
        MsgParsedAddressesFromDisplayNames                        = ['msg'].['parsedAddresses'].['fromDisplayNames'],//netnew
        // MsgParsedAddressesFromHashed                              = ['msg'].['parsedAddresses'].['fromHashed'],
        MsgParsedAddressesTo                                      = ['msg'].['parsedAddresses'].['to'],
        // MsgParsedAddressesToHashed                                = ['msg'].['parsedAddresses'].['toHashed'],
        NetworkBytes                                              = toreal(['msg'].['sizeBytes']),
        MetadataOriginDataAgent                                   = ['metadata'].['origin'].['data'].['agent'],
        MetadataOriginDataCid                                     = ['metadata'].['origin'].['data'].['cid'],
        MetadataOriginDataVersion                                 = ['metadata'].['origin'].['data'].['version'],
        FilterActions                                             = ['filter'].['actions'],
        FilterAliasedRcpts                                        = ['filter'].['aliasedRcpts'], //netnew
        FilterDelivered                                           = ['filter'].['delivered'], //netnew
        FilterDisposition                                         = ['filter'].['disposition'],
        NetworkDuration                                           = toreal(['filter'].['durationSecs']),
        FilterIsMsgEncrypted                                      = tobool(['filter'].['isMsgEncrypted']),
        FilterIsMsgReinjected                                     = tobool(['filter'].['isMsgReinjected']),
        FilterModulesDkimv                                        = ['filter'].['modules'].['dkimv'],
        FilterModulesDmarcAlignment                               = ['filter'].['modules'].['dmarc'].['alignment'],
        FilterModulesDmarcAuthResults                             = ['filter'].['modules'].['dmarc'].['authResults'],
        FilterModulesDmarcFilterdResult                           = ['filter'].['modules'].['dmarc'].['filterdResult'],
        FilterModulesDmarcIsVerified                              = ['filter'].['modules'].['dmarc'].['isVerified'],//netnew
        FilterModulesDmarcRecords                                 = ['filter'].['modules'].['dmarc'].['records'],
        FilterModulesDmarcSrvid                                   = ['filter'].['modules'].['dmarc'].['srvid'],
        FilterModulesSpamAuthority                                = ['filter'].['modules'].['spam'].['authority'],//netnew
        FilterModulesSpamLangs                                    = ['filter'].['modules'].['spam'].['langs'],
        FilterModulesSpamScoresClassifiers                        = ['filter'].['modules'].['spam'].['scores'].['classifiers'],
        FilterModulesSpamScoresEngine                             = toreal(['filter'].['modules'].['spam'].['scores'].['engine']),
        FilterModulesSpamScoresOverall                            = toreal(['filter'].['modules'].['spam'].['scores'].['overall']),
        FilterModulesSpamTds                                      = ['filter'].['modules'].['spam'].['tds'],//netnew
        FilterModulesSpamVersionDefinitions                       = ['filter'].['modules'].['spam'].['version'].['definitions'],
        FilterModulesSpamVersionEngine                            = ['filter'].['modules'].['spam'].['version'].['engine'],
        FilterModulesSpamCharsets                                 = ['filter'].['modules'].['spam'].['charsets'],//unseen
        FilterModulesSpamSafeBlockedListMatches                   = ['filter'].['modules'].['spam'].['safeBlockedListMatches'],//unseen
        FilterModulesSpamTriggeredClassifier                      = ['filter'].['modules'].['spam'].['triggeredClassifier'],//unseen
        FilterModulesSpfDomain                                    = ['filter'].['modules'].['spf'].['domain'],
        FilterModulesSpfResult                                    = ['filter'].['modules'].['spf'].['result'],
        FilterModulesUrldefenseCountsNoRewriteIsEmail             = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsEmail']),
        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsUnsupportedScheme']),
        FilterModulesUrldefenseCountsRewritten                    = toreal(['filter'].['modules'].['urldefense'].['counts'].['rewritten']),
        FilterModulesUrldefenseCountsTotal                        = toreal(['filter'].['modules'].['urldefense'].['counts'].['total']),
        FilterModulesUrldefenseCountsUnique                       = toreal(['filter'].['modules'].['urldefense'].['counts'].['unique']),
        FilterModulesUrldefenseCountsUnwritten                    = toreal(['filter'].['modules'].['urldefense'].['counts'].['unwritten']),//netnew
        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain    = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsExcludedDomain']),//unseen
        FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize  = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsLargeMsgPartSize']),//unseen
        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsMaxLengthExceeded']),//unseen
        FilterModulesUrldefenseCountsNoRewriteIsSchemeless        = toreal(['filter'].['modules'].['urldefense'].['counts'].['noRewriteIsSchemeless']),//unseen
        FilterModulesUrldefenseVersionEngine                      = ['filter'].['modules'].['urldefense'].['version'].['engine'],
        FilterModulesAvVirusNames                                 = ['filter'].['modules'].['av'].['virusNames'],//unseen
        FilterModulesPdrV2Response                                = ['filter'].['modules'].['pdr'].['v2'].['response'],//unseen
        FilterModulesPdrV2Rscore                                  = toreal(['filter'].['modules'].['pdr'].['v2'].['rscore']),//unseen
        FilterModulesZerohourScore                                = ['filter'].['modules'].['zerohour'].['score'],//unseen
        FilterMsgSizeBytes                                        = toreal(['filter'].['msgSizeBytes']),
        FilterOrigGuid                                            = ['filter'].['origGuid'],
        FilterQid                                                 = ['filter'].['qid'],
        FilterReinjectedType                                      = ['filter'].['reinjectedType'],//netnew
        NetworkDirection                                          = ['filter'].['routeDirection'],
        FilterRoutes                                              = ['filter'].['routes'],
        FilterSuborgsRcpts                                        = ['filter'].['suborgs'].['rcpts'],
        FilterSuborgsSender                                       = ['filter'].['suborgs'].['sender'],
        FilterVerifiedRcpts                                       = ['filter'].['verified'].['rcpts'],
        //FilterVerifiedRcptsHashed                                 = ['filter'].['verified'].['rcptsHashed'],//unseen
        EventStartTime                                            = todatetime(['filter'].['startTime']),//unseen
        FilterThrottleIp                                          = ['filter'].['throttleIp'],//unseen
        FilterQuarantineFolder                                    = ['filter'].['quarantine'].['folder'],//unseen
        FilterQuarantineRule                                      = ['filter'].['quarantine'].['rule'],//unseen
        MsgParts                                                  = ['msgParts'],
        PpsAgent                                                  = ['pps'].['agent'],//unseen
        PpsCid                                                    = ['pps'].['cid'],//unseen
        PpsVersion                                                = ['pps'].['version'],//unseen
        EventType                                                 = "Message"
    //EventProduct                                              = "Proofpoint On Demand Email Security",//unnecessary
    //EventVendor                                               = "Proofpoint"//unnecessary
    | project
        TimeGenerated,
        EventOriginalTime,
        Guid,
        SrcGeoCountry,
        ConnectionHelo,
        SrcDvcHostname,
        SrcIpAddr,
        NetworkProtocol,
        NetworkConnectionState,
        NetworkSessionId,
        TlsCipher,
        TlsCipherBits,
        TlsVersion,
        SrcUserUpn,
        DstUserUpn,
        // EnvelopeFromHashed,
        // EnvelopeRcptsHashed,
        // MsgHeaderFromHashed,
        MsgHeaderFrom,
        MsgHeaderMessageId,
        MsgHeaderSubject,
        MsgHeaderTo,
        MsgHeaderXOriginatorOrg,
        MsgHeaderCc,
        // MsgHeaderCcHashed,
        MsgHeaderReplyTo,
        // MsgHeaderReplyToHashed,
        MsgHeaderReturnPath,
        // MsgHeaderReturnPathHashed,
        // MsgHeaderToHashed,
        MsgHeaderXMailer,
        MsgHeaderXOriginatingIp,
        MsgLang,
        MsgNormalizedHeaderCc,
        //MsgNormalizedHeaderCcHashed,
        MsgNormalizedHeaderFrom,
        //MsgNormalizedHeaderFromHashed,
        MsgNormalizedHeaderMessageId,
        MsgNormalizedHeaderSubject,
        MsgNormalizedHeaderTo,
        MsgNormalizedHeaderXOriginatorOrg,
        MsgNormalizedHeaderReplyTo,
        //MsgNormalizedHeaderReplyToHashed,
        MsgNormalizedHeaderReturnPath,
        // MsgNormalizedHeaderReturnPathHashed,
        // MsgNormalizedHeadertoHashed,
        MsgNormalizedHeaderXMailer,
        MsgNormalizedHeaderXOriginatingIp,
        MsgParsedAddressesCc,
        // MsgParsedAddressesCcHashed,
        MsgParsedAddressesFrom,
        MsgParsedAddressesFromDisplayNames,
        // MsgParsedAddressesFromHashed,
        MsgParsedAddressesTo,
        // MsgParsedAddressesToHashed,
        NetworkBytes,
        MetadataOriginDataAgent,
        MetadataOriginDataCid,
        MetadataOriginDataVersion,
        FilterActions,
        FilterAliasedRcpts,
        FilterDelivered,
        FilterDisposition,
        NetworkDuration,
        FilterIsMsgEncrypted,
        FilterIsMsgReinjected,
        FilterModulesDkimv,
        FilterModulesDmarcAlignment,
        FilterModulesDmarcAuthResults,
        FilterModulesDmarcFilterdResult,
        FilterModulesDmarcIsVerified,
        FilterModulesDmarcRecords,
        FilterModulesDmarcSrvid,
        FilterModulesSpamAuthority,
        FilterModulesSpamLangs,
        FilterModulesSpamScoresClassifiers,
        FilterModulesSpamScoresEngine,
        FilterModulesSpamScoresOverall,
        FilterModulesSpamTds,
        FilterModulesSpamVersionDefinitions,
        FilterModulesSpamVersionEngine,
        FilterModulesSpamCharsets,
        FilterModulesSpamSafeBlockedListMatches,
        FilterModulesSpamTriggeredClassifier,
        FilterModulesSpfDomain,
        FilterModulesSpfResult,
        FilterModulesUrldefenseCountsNoRewriteIsEmail,
        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,
        FilterModulesUrldefenseCountsRewritten,
        FilterModulesUrldefenseCountsTotal,
        FilterModulesUrldefenseCountsUnique,
        FilterModulesUrldefenseCountsUnwritten,
        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,
        FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,
        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,
        FilterModulesUrldefenseCountsNoRewriteIsSchemeless,
        FilterModulesUrldefenseVersionEngine,
        FilterModulesAvVirusNames,
        FilterModulesPdrV2Response,
        FilterModulesPdrV2Rscore,
        FilterModulesZerohourScore,
        FilterMsgSizeBytes,
        FilterOrigGuid,
        FilterQid,
        FilterReinjectedType,
        NetworkDirection,
        FilterRoutes,
        FilterSuborgsRcpts,
        FilterSuborgsSender,
        FilterVerifiedRcpts,
        //FilterVerifiedRcptsHashed,
        EventStartTime,
        FilterThrottleIp,
        FilterQuarantineFolder,
        FilterQuarantineRule,
        MsgParts,
        PpsAgent,
        PpsCid,
        PpsVersion,
        EventType
    //EventProduct,
    //EventVendor,
    | join kind=inner  (
        ProofpointPODMessage_CL
        | extend
            Guid = column_ifexists('guid', ''),
            MsgParts = column_ifexists('msgParts', '')
        | extend d    = parse_json(MsgParts)
        | mv-expand d
        | extend URL_LIST = parse_json(d.urls)
        | mv-expand URL_LIST
        | extend URLLIST = tostring(URL_LIST.url)
        | summarize make_set(URLLIST) by Guid
        )
        on Guid
    | project-away Guid1
    | project-rename Urls = set_URLLIST
}
    ;
union isfuzzy=true ProofpointPOD_message_view, ProofpointPOD_maillog_view
