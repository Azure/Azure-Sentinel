{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Proofpoint, Inc. - azure-support@proofpoint.com",
    "comments": "Solution template for Proofpoint On demand(POD) Email Security"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Proofpoint On-Demand Email Security",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "azure-support@proofpoint.com",
    "_email": "[variables('email')]",
    "_solutionName": "Proofpoint On demand(POD) Email Security",
    "_solutionVersion": "3.1.2",
    "solutionId": "proofpointinc1600438591120.azure-sentinel-proofpointpod",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "ProofpointPODWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "parserObject1": {
      "_parserName1": "[concat(parameters('workspace'),'/','ProofpointPOD')]",
      "_parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ProofpointPOD')]",
      "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('ProofpointPOD-Parser')))]",
      "parserVersion1": "1.0.1",
      "parserContentId1": "ProofpointPOD-Parser"
    },
    "huntingQueryObject1": {
      "huntingQueryVersion1": "1.0.0",
      "_huntingQuerycontentId1": "0794a162-8635-43fd-81ed-2cf2604575b1",
      "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('0794a162-8635-43fd-81ed-2cf2604575b1')))]"
    },
    "huntingQueryObject2": {
      "huntingQueryVersion2": "1.0.0",
      "_huntingQuerycontentId2": "eb74aaab-ebf4-4763-9b03-b1a33fe48600",
      "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('eb74aaab-ebf4-4763-9b03-b1a33fe48600')))]"
    },
    "huntingQueryObject3": {
      "huntingQueryVersion3": "1.0.0",
      "_huntingQuerycontentId3": "a0d56fcd-edb3-46f1-aaa3-12d606a48ff1",
      "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('a0d56fcd-edb3-46f1-aaa3-12d606a48ff1')))]"
    },
    "huntingQueryObject4": {
      "huntingQueryVersion4": "1.0.0",
      "_huntingQuerycontentId4": "c9ff3690-b754-4c91-b866-4d07098da074",
      "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c9ff3690-b754-4c91-b866-4d07098da074')))]"
    },
    "huntingQueryObject5": {
      "huntingQueryVersion5": "1.0.0",
      "_huntingQuerycontentId5": "bc619ce8-0807-4b13-93ea-0d7b79c7ee68",
      "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('bc619ce8-0807-4b13-93ea-0d7b79c7ee68')))]"
    },
    "huntingQueryObject6": {
      "huntingQueryVersion6": "1.0.0",
      "_huntingQuerycontentId6": "dd9674cf-898b-4c80-96f1-f70bec66e6fc",
      "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('dd9674cf-898b-4c80-96f1-f70bec66e6fc')))]"
    },
    "huntingQueryObject7": {
      "huntingQueryVersion7": "1.0.0",
      "_huntingQuerycontentId7": "d324e435-31d3-4aa3-907c-76f4917820a9",
      "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('d324e435-31d3-4aa3-907c-76f4917820a9')))]"
    },
    "huntingQueryObject8": {
      "huntingQueryVersion8": "1.0.0",
      "_huntingQuerycontentId8": "c334e1e8-a7da-4c23-a9c0-fdda26b07606",
      "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('c334e1e8-a7da-4c23-a9c0-fdda26b07606')))]"
    },
    "huntingQueryObject9": {
      "huntingQueryVersion9": "1.0.0",
      "_huntingQuerycontentId9": "af7f133a-5fed-4ebf-8272-4330c884c7ca",
      "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('af7f133a-5fed-4ebf-8272-4330c884c7ca')))]"
    },
    "huntingQueryObject10": {
      "huntingQueryVersion10": "1.0.0",
      "_huntingQuerycontentId10": "7b281f4a-6a9a-439f-8b4f-f08eb24f2fb7",
      "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-hq-',uniquestring('7b281f4a-6a9a-439f-8b4f-f08eb24f2fb7')))]"
    },
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.3",
      "_analyticRulecontentId1": "eb68b129-5f17-4f56-bf6d-dde48d5e615a",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'eb68b129-5f17-4f56-bf6d-dde48d5e615a')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('eb68b129-5f17-4f56-bf6d-dde48d5e615a')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','eb68b129-5f17-4f56-bf6d-dde48d5e615a','-', '1.0.3')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.1",
      "_analyticRulecontentId2": "aedc5b33-2d7c-42cb-a692-f25ef637cbb1",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'aedc5b33-2d7c-42cb-a692-f25ef637cbb1')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('aedc5b33-2d7c-42cb-a692-f25ef637cbb1')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','aedc5b33-2d7c-42cb-a692-f25ef637cbb1','-', '1.0.1')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.1",
      "_analyticRulecontentId3": "c7cd6073-6d2c-4284-a5c8-da27605bdfde",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c7cd6073-6d2c-4284-a5c8-da27605bdfde')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c7cd6073-6d2c-4284-a5c8-da27605bdfde')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c7cd6073-6d2c-4284-a5c8-da27605bdfde','-', '1.0.1')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.2",
      "_analyticRulecontentId4": "bda5a2bd-979b-4828-a91f-27c2a5048f7f",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bda5a2bd-979b-4828-a91f-27c2a5048f7f')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bda5a2bd-979b-4828-a91f-27c2a5048f7f')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bda5a2bd-979b-4828-a91f-27c2a5048f7f','-', '1.0.2')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.1",
      "_analyticRulecontentId5": "d1aba9a3-5ab1-45ef-8ed4-da57dc3c0d32",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd1aba9a3-5ab1-45ef-8ed4-da57dc3c0d32')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d1aba9a3-5ab1-45ef-8ed4-da57dc3c0d32')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d1aba9a3-5ab1-45ef-8ed4-da57dc3c0d32','-', '1.0.1')))]"
    },
    "analyticRuleObject6": {
      "analyticRuleVersion6": "1.1.1",
      "_analyticRulecontentId6": "f8127962-7739-4211-a4a9-390a7a00e91f",
      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f8127962-7739-4211-a4a9-390a7a00e91f')]",
      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f8127962-7739-4211-a4a9-390a7a00e91f')))]",
      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f8127962-7739-4211-a4a9-390a7a00e91f','-', '1.1.1')))]"
    },
    "analyticRuleObject7": {
      "analyticRuleVersion7": "1.0.2",
      "_analyticRulecontentId7": "f6a51e2c-2d6a-4f92-a090-cfb002ca611f",
      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f6a51e2c-2d6a-4f92-a090-cfb002ca611f')]",
      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f6a51e2c-2d6a-4f92-a090-cfb002ca611f')))]",
      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f6a51e2c-2d6a-4f92-a090-cfb002ca611f','-', '1.0.2')))]"
    },
    "analyticRuleObject8": {
      "analyticRuleVersion8": "1.0.3",
      "_analyticRulecontentId8": "56b0a0cd-894e-4b38-a0a1-c41d9f96649a",
      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '56b0a0cd-894e-4b38-a0a1-c41d9f96649a')]",
      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('56b0a0cd-894e-4b38-a0a1-c41d9f96649a')))]",
      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','56b0a0cd-894e-4b38-a0a1-c41d9f96649a','-', '1.0.3')))]"
    },
    "analyticRuleObject9": {
      "analyticRuleVersion9": "1.1.2",
      "_analyticRulecontentId9": "35a0792a-1269-431e-ac93-7ae2980d4dde",
      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '35a0792a-1269-431e-ac93-7ae2980d4dde')]",
      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('35a0792a-1269-431e-ac93-7ae2980d4dde')))]",
      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','35a0792a-1269-431e-ac93-7ae2980d4dde','-', '1.1.2')))]"
    },
    "analyticRuleObject10": {
      "analyticRuleVersion10": "1.1.1",
      "_analyticRulecontentId10": "78979d32-e63f-4740-b206-cfb300c735e0",
      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '78979d32-e63f-4740-b206-cfb300c735e0')]",
      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('78979d32-e63f-4740-b206-cfb300c735e0')))]",
      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','78979d32-e63f-4740-b206-cfb300c735e0','-', '1.1.1')))]"
    },
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "ProofpointCCPDefinition",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "ProofpointCCPDefinitionConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPOD Workbook with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into your Proofpoint on Demand Email Security activities, including maillog and messages data. The Workbook provides users with an executive dashboard showing the reporting capabilities, message traceability and monitoring."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n>**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Proofpoint%20On%20demand(POD)%20Email%20Security/Parsers/ProofpointPOD.yaml) to create the Kusto function alias **ProofpointPOD**.\"},\"name\":\"text - 16\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"3fb8c41a-e970-467a-8975-0b87bfda8cc0\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Proofpoint Email Security Main Dashboard\",\"subTarget\":\"proofpoint_email_security_main_dashboard\",\"preText\":\"Proofpoint Email Security Main Dashboard\",\"style\":\"link\"},{\"id\":\"40d6c856-9ecd-428b-ada5-ad76ba351f5e\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"TLS Dashboard\",\"subTarget\":\"tls_dashboard\",\"style\":\"link\"},{\"id\":\"68036e0c-acaa-48d3-aae0-911917ec637d\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Message Summary\",\"subTarget\":\"messages_summary\",\"style\":\"link\"}]},\"name\":\"Tab\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"f1aebfc5-f1bd-4462-bb99-f87af7f027ba\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isNotEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType;\",\"size\":1,\"title\":\"Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let email_security_total_messages_timechart=ProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where TimeGenerated {TimeRange}\\n| extend event_type = \\\"Message Rate\\\";\\n\\nlet email_security_total_blocked_timechart =\\nProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\"\\n| extend event_type = \\\"Blocked Message Rate\\\";\\n\\nlet quarantine_trends = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where isnotempty(FilterQuarantineFolder)\\n| extend event_type = \\\"Quarantined Message Rate\\\";\\n\\nlet result = union email_security_total_messages_timechart, email_security_total_blocked_timechart, quarantine_trends\\n| make-series Trend = dcount(MsgHeaderMessageId) on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by event_type;\\nresult\",\"size\":0,\"title\":\"Email Messages over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"60\",\"name\":\"EmailMessagesOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let email_security_total_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Total Messages Processed\\\";\\n\\nlet email_security_inbound_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Inbound Messages Processed\\\";\\n\\nlet email_security_outbound_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"outbound\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Outbound Messages Processed\\\";\\n\\nlet email_security_total_blocked_messages =\\nProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where TimeGenerated {TimeRange} \\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Total Blocked Messages\\\";\\n\\nlet email_security_total_quarantined_messages = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where isnotempty(FilterQuarantineFolder)\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title = \\\"Quarantined Messages\\\";\\n\\nlet email_security_result_table = union email_security_total_messages_processed, email_security_inbound_messages_processed,email_security_outbound_messages_processed,email_security_total_blocked_messages,email_security_total_quarantined_messages; \\nemail_security_result_table \\n| sort by Count\",\"size\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"40\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterQuarantineRule)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterQuarantineRule\",\"size\":3,\"title\":\"Quarantine Rules Hits\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"35\",\"name\":\"QuarantineRulesHits\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterModulesDmarcFilterdResult)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterModulesDmarcFilterdResult\",\"size\":3,\"title\":\"DMARC Summary Results\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"35\",\"name\":\"DMARCSummaryResults\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterModulesSpamTriggeredClassifier)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterModulesSpamTriggeredClassifier\",\"size\":3,\"title\":\"Top AntiSpam Results\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopAntiSpamResults\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\" or isnotempty(FilterQuarantineFolder)\\n| where TimeGenerated {TimeRange} \\n| extend dstUserUpn = todynamic(DstUserUpn) \\n| mv-expand dstUserUpn\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by tostring(dstUserUpn) | top 10 by Count\",\"size\":0,\"title\":\"Top Recipients with high block rate\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopRecipients\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| extend srcUserUpn = todynamic(SrcUserUpn) \\n| mv-expand srcUserUpn\\n| where isnotempty(srcUserUpn)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by tostring(srcUserUpn) | top 10 by Count\",\"size\":0,\"title\":\"Top Senders\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopSenders\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"afe179f1-6dc8-4a97-bc20-5b8aadf5a9aa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange1\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":172800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"label\":\"TimeRange\"},{\"id\":\"cc0743b6-1893-4f3d-8c7c-96f075f3006c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Direction\",\"type\":2,\"isRequired\":true,\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange1} \\n| project NetworkDirection | distinct NetworkDirection | where isnotempty(NetworkDirection)\\n| order by NetworkDirection asc\",\"typeSettings\":{\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"34bcd907-7f33-4d49-b158-eb7877a763f9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Sender\",\"type\":1,\"value\":\"\"},{\"id\":\"65c7de4d-b953-407a-ac81-9c2fe2fddd99\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Recipient\",\"type\":1,\"value\":\"\"},{\"id\":\"e819f521-396a-4292-ae6d-99a173eb09b6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subject\",\"type\":1,\"value\":\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Parameters2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange1}\\n| project-rename Direction = NetworkDirection, Sender = MsgHeaderFrom,  Recipient = MsgHeaderTo, Subject = MsgHeaderSubject, Filter_Action = FilterDisposition\\n| project TimeGenerated, Direction, Sender, Recipient, Subject, Filter_Action, MsgNormalizedHeaderMessageId\\n| search Sender contains \\\"{Sender:value}\\\" and Recipient contains \\\"{Recipient:value}\\\" and Subject contains \\\"{Subject:value}\\\"\\n| search Direction == \\\"{Direction:value}\\\" | project TimeGenerated, Direction, Sender, Recipient, Subject, Filter_Action, MsgNormalizedHeaderMessageId | take 50\",\"size\":0,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"MsgNormalizedHeaderMessageId\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"MsgNormalizedHeaderMessageId\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Table\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let inbound_tls_encrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where FilterIsMsgEncrypted == \\\"true\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Encrypted\\\";\\n\\nlet inbound_tls_unencrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Unencrypted\\\";\\n\\nlet inbound_total = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound Total\\\";\\n\\nlet trend_result = union inbound_tls_encrypted, inbound_tls_unencrypted, inbound_total;\\ntrend_result | summarize Count=dcount(MsgNormalizedHeaderMessageId) by event_type \\n| join kind=inner (trend_result | make-series Trend = dcount(MsgNormalizedHeaderMessageId) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}  by event_type) on event_type \\n;\\n\",\"size\":1,\"title\":\"TLS Usage over time\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"70\",\"name\":\"TLSUsage\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let inbound_tls_encrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where FilterIsMsgEncrypted == \\\"true\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Encrypted\\\";\\n\\nlet inbound_tls_unencrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Unencrypted\\\";\\n\\nlet inbound_total = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound Total\\\";\\n\\nlet trend_result = union inbound_tls_encrypted, inbound_tls_unencrypted, inbound_total;\\ntrend_result | summarize Count=dcount(MsgNormalizedHeaderMessageId) by event_type \\n| join kind=inner (trend_result | make-series Trend = dcount(MsgNormalizedHeaderMessageId) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}  by event_type) on event_type \\n| order by Count desc\\n| project event_type, Trend, Count\\n;\",\"size\":3,\"title\":\"TLS Statistics\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}}],\"sortBy\":[{\"itemKey\":\"Count\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Count\",\"sortOrder\":2}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"event_type\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"30\",\"name\":\"TLSStatistics\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\"\\n| summarize Count=dcount(MsgNormalizedHeaderMessageId) by MsgHeaderFrom | top 10 by Count | extend Domain = extract(\\\"(.*@)([a-zA-z0-9.-]*)\\\", 2, MsgHeaderFrom)\\n| project Domain, Count\\n\",\"size\":0,\"title\":\"Top 10 Sender domains not using TLS\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"50\",\"name\":\"Top10SenderNotUsingTLS\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where FilterIsMsgEncrypted == \\\"false\\\"\\n| where TimeGenerated {TimeRange} \\n| extend splited=split(MsgHeaderTo,\\\",\\\") | mv-expand splited | extend Domain = extract(\\\"(.*@)([a-zA-z0-9.-]*)\\\", 2, tostring(splited))\\n| where isnotempty(Domain)\\n| summarize Count=dcount(MsgNormalizedHeaderMessageId) by Domain | top 10 by Count\\n\",\"size\":0,\"title\":\"Top 10 Recipient domains not using TLS\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"50\",\"name\":\"Top10RecipientNotUsingTLS\"}],\"fromTemplateId\":\"sentinel-ProofpointPOD\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ProofpointPODWorkbook; logoFileName=proofpointlogo.svg; description=Gain insights into your Proofpoint on Demand Email Security activities, including maillog and messages data. The Workbook provides users with an executive dashboard showing the reporting capabilities, message traceability and monitoring.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Proofpoint On-Demand Email Security; templateRelativePath=ProofpointPOD.json; subtitle=; provider=Proofpoint}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ProofpointPOD_maillog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofpointPOD_message_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofpointPOD",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserObject1').parserTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPOD Data Parser with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserObject1').parserVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('parserObject1')._parserName1]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for ProofpointPOD",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "ProofpointPOD",
                "query": "let ProofpointPOD_maillog_view = view () { \n    union isfuzzy=true ProofpointPOD_maillog_CL, maillog_CL | where isnotempty( pps_cid_s) and event_type_s == \"maillog\"\n    | extend \n                SmMsgid=column_ifexists('sm_msgid_g', ''),\n                PpsCid=column_ifexists('pps_cid_s', ''),\n                PpsAgent=column_ifexists('pps_agent_s', ''),\n                Id=column_ifexists('id_s', ''),\n                SmNrcpts=column_ifexists('sm_nrcpts_s', ''),\n                SmAuth=column_ifexists('sm_auth_s', ''),\n                SmClass=column_ifexists('sm_class_s', ''),\n                SmQid=column_ifexists('sm_qid_s', ''),\n                MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\n                MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\n                SmMailer=column_ifexists('sm_mailer_s', ''),\n                SmDsn=column_ifexists('sm_dsn_s', ''),\n                SmPri=column_ifexists('sm_pri_s', ''),\n                SmXdelay=column_ifexists('sm_xdelay_s', ''),\n                SmCtladdr=column_ifexists('sm_ctladdr_s', ''),\n                EventUid=column_ifexists('sm_msgid_s', ''),\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\n                TlsEstablished=column_ifexists('sm_tls_verify_s', ''),\n                SrcNatIpAddr=column_ifexists('sm_relay_s', ''),\n                ProcessName=column_ifexists('sm_daemon_s', ''),\n                NetworkProtocol=column_ifexists('sm_proto_s', ''),\n                SrcUserUpn=column_ifexists('sm_from_s', ''),\n                EventOriginalTime=column_ifexists('ts_t', ''),\n                EventOriginalMessage=column_ifexists('data_s', ''),\n                EventType=column_ifexists('event_type_s', ''),\n                NetworkConnectionStateDetailed=column_ifexists('sm_stat_s', ''),\n                DstUserUpn=column_ifexists('sm_to_s', ''),\n                NetworkDuration=column_ifexists('sm_delay_s', ''),\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                SmMsgid,\n                PpsCid,\n                PpsAgent,\n                Id,\n                SmNrcpts,\n                SmAuth,\n                SmClass,\n                SmQid,\n                MetadataOriginDataAgent,\n                MetadataOriginDataCid,\n                SmMailer,\n                SmDsn,\n                SmPri,\n                SmXdelay,\n                SmCtladdr,\n                EventUid,\n                NetworkBytes,\n                TlsEstablished,\n                SrcNatIpAddr,\n                ProcessName,\n                NetworkProtocol,\n                SrcUserUpn,\n                EventOriginalTime,\n                EventOriginalMessage,\n                EventType,\n                NetworkConnectionStateDetailed,\n                DstUserUpn,\n                NetworkDuration\n};\nlet ProofpointPOD_maillogV2_view = view () {\n    ProofpointPODMailLog_CL\n    | extend \n    sm_data = parse_json(sm),\n    pps_data = parse_json(pps),\n    metadata_data = parse_json(metadata)\n    | extend SmMsgid = tostring(sm_data.msgid),\n        PpsCid = tostring(pps_data.cid),\n        PpsAgent = tostring(pps_data.agent),\n        Id = column_ifexists('id', ''),\n        SmNrcpts = tostring(sm_data.nrcpts),\n        SmAuth = tostring(sm_data.auth),\n        SmClass = tostring(sm_data.class),\n        SmQid = tostring(sm_data.qid),\n        MetadataOriginDataAgent = tostring(metadata_data.origin.data.agent),\n        MetadataOriginDataCid = tostring(metadata_data.origin.data.cid),\n        SmMailer = tostring(sm_data.mailer),\n        SmDsn = tostring(sm_data.dsn),\n        SmPri = tostring(sm_data.pri),\n        SmXdelay = tostring(sm_data.xdelay),\n        SmCtladdr = tostring(sm_data.ctladdr),\n        EventUid = tostring(sm_data.msgid), // need to verify\n        NetworkBytes = toreal(sm_data.sizeBytes),\n        //TlsEstablished = parse_json(sm).tls_verify,\n        SrcNatIpAddr = tostring(sm_data.relay),\n        ProcessName = tostring(sm_data.daemon),\n        NetworkProtocol = tostring(sm_data.proto),\n        SrcUserUpn = tostring(sm_data.from),\n        EventOriginalTime = column_ifexists('eventTime', ''),\n        EventOriginalMessage = column_ifexists('data', ''),\n        EventType = \"maillog\",\n        NetworkConnectionStateDetailed = tostring(sm_data.stat),\n        DstUserUpn = tostring(sm_data.[\"to\"]),\n        NetworkDuration = tostring(sm_data.delay),\n        EventVendor = \"Proofpoint\", \n        EventProduct = \"Proofpoint On Demand Email Security\"\n    | project\n         TimeGenerated, \n                EventVendor,\n                EventProduct,\n                SmMsgid,\n                PpsCid,\n                PpsAgent,\n                Id,\n                SmNrcpts,\n                SmAuth,\n                SmClass,\n                SmQid,\n                MetadataOriginDataAgent,\n                MetadataOriginDataCid,\n                SmMailer,\n                SmDsn,\n                SmPri,\n                SmXdelay,\n                SmCtladdr,\n                EventUid,\n                NetworkBytes,\n               // TlsEstablished,\n                SrcNatIpAddr,\n                ProcessName,\n                NetworkProtocol,\n                SrcUserUpn,\n                EventOriginalTime,\n                EventOriginalMessage,\n                EventType,\n                NetworkConnectionStateDetailed,\n                DstUserUpn,\n                NetworkDuration             \n};\nlet ProofpointPOD_message_view = view () { \n    union isfuzzy=true ProofpointPOD_message_CL, message_CL | where event_type_s == \"message\"\n    | extend \n            FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize=column_ifexists('filter_modules_urldefense_counts_noRewriteIsLargeMsgPartSize_d', ''),\n\t\t        PpsVersion=column_ifexists('pps_version_s', ''),\n\t\t        PpsCid=column_ifexists('pps_cid_s', ''),\n\t\t        MsgParts=todynamic(column_ifexists('msgParts_s', '')),\n\t\t        MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\n\t\t        MetadataOriginDataVersion=column_ifexists('metadata_origin_data_version_s', ''),\n\t\t        MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\n\t\t        ConnectionHelo=column_ifexists('connection_helo_s', ''),\n\t\t        MsgLang=column_ifexists('msg_lang_s', ''),\n\t\t        MsgNormalizedHeaderSubject=column_ifexists('msg_normalizedHeader_subject_s', ''),\n\t\t        MsgNormalizedHeaderMessageId=column_ifexists('msg_normalizedHeader_message_id_s', ''),\n\t\t        MsgNormalizedHeaderTo=column_ifexists('msg_normalizedHeader_to_s', ''),\n\t\t        MsgNormalizedHeadertoHashed=column_ifexists('msg_normalizedHeader_toHashed_s', ''),\n\t\t        MsgNormalizedHeaderFrom=column_ifexists('msg_normalizedHeader_from_s', ''),\n\t\t        MsgNormalizedHeaderFromHashed=column_ifexists('msg_normalizedHeader_fromHashed_s', ''),\n\t\t        MsgHeaderFrom=column_ifexists('msg_header_from_s', ''),\n\t\t        MsgHeaderFromHashed=column_ifexists('msg_header_fromHashed_s', ''),\n\t\t        MsgHeaderMessageId=column_ifexists('msg_header_message_id_s', ''),\n\t\t        MsgHeaderSubject=column_ifexists('msg_header_subject_s', ''),\n\t\t        MsgHeaderTo=column_ifexists('msg_header_to_s', ''),\n\t\t        MsgHeaderToHashed=column_ifexists('msg_header_toHashed_s', ''),\n\t\t        MsgParsedAddressesFromHashed=column_ifexists('msg_parsedAddresses_fromHashed_s', ''),\n\t\t        MsgParsedAddressesFrom=column_ifexists('msg_parsedAddresses_from_s', ''),\n\t\t        MsgParsedAddressesToHashed=column_ifexists('msg_parsedAddresses_toHashed_s', ''),\n\t\t        MsgParsedAddressesTo=column_ifexists('msg_parsedAddresses_to_s', ''),\n\t\t        FilterActions=column_ifexists('filter_actions_s', ''),\n\t\t        FilterRoutes=column_ifexists('filter_routes_s', ''),\n\t\t        FilterQid=column_ifexists('filter_qid_s', ''),\n\t\t        FilterIsMsgEncrypted=tobool(column_ifexists('filter_isMsgEncrypted_b', '')),\n\t\t        FilterIsMsgReinjected=tobool(column_ifexists('filter_isMsgReinjected_b', '')),\n\t\t        FilterQuarantineRule=column_ifexists('filter_quarantine_rule_s', ''),\n\t\t        FilterQuarantineFolder=column_ifexists('filter_quarantine_folder_s', ''),\n\t\t        FilterModulesDmarcSrvid=column_ifexists('filter_modules_dmarc_srvid_s', ''),\n\t\t        FilterModulesDmarcRecords=column_ifexists('filter_modules_dmarc_records_s', ''),\n\t\t        FilterModulesDmarcFilterdResult=column_ifexists('filter_modules_dmarc_filterdResult_s', ''),\n\t\t        FilterModulesDmarcAuthResults=column_ifexists('filter_modules_dmarc_authResults_s', ''),\n\t\t        FilterModulesSpfDomain=column_ifexists('filter_modules_spf_domain_s', ''),\n\t\t        FilterModulesSpfResult=column_ifexists('filter_modules_spf_result_s', ''),\n\t\t        FilterModulesSpamTriggeredClassifier=column_ifexists('filter_modules_spam_triggeredClassifier_s', ''),\n\t\t        FilterModulesSpamSafeBlockedListMatches=column_ifexists('filter_modules_spam_safeBlockedListMatches_s', ''),\n\t\t        FilterModulesSpamVersionEngine=column_ifexists('filter_modules_spam_version_engine_s', ''),\n\t\t        FilterModulesSpamVersionDefinitions=column_ifexists('filter_modules_spam_version_definitions_s', ''),\n\t\t        FilterModulesSpamScoresOverall=column_ifexists('filter_modules_spam_scores_overall_d', ''),\n\t\t        FilterModulesSpamScoresEngine=column_ifexists('filter_modules_spam_scores_engine_d', ''),\n\t\t        FilterModulesSpamScoresClassifiers=column_ifexists('filter_modules_spam_scores_classifiers_s', ''),\n\t\t        FilterModulesSpamLangs=column_ifexists('filter_modules_spam_langs_s', ''),\n\t\t        FilterModulesUrldefenseVersionEngine=column_ifexists('filter_modules_urldefense_version_engine_s', ''),\n\t\t        FilterModulesUrldefenseCountsUnique=column_ifexists('filter_modules_urldefense_counts_unique_d', ''),\n\t\t        FilterModulesUrldefenseCountsRewritten=column_ifexists('filter_modules_urldefense_counts_rewritten_d', ''),\n\t\t        FilterModulesUrldefenseCountsTotal=column_ifexists('filter_modules_urldefense_counts_total_d', ''),\n\t\t        FilterModulesDkimv=column_ifexists('filter_modules_dkimv_s', ''),\n\t\t        FilterModulesPdrV2Response=column_ifexists('filter_modules_pdr_v2_response_s', ''),\n\t\t        FilterModulesZerohourScore=column_ifexists('filter_modules_zerohour_score_s', ''),\n\t\t        FilterDisposition=column_ifexists('filter_disposition_s', ''),\n\t\t        FilterSuborgsRcpts=column_ifexists('filter_suborgs_rcpts_s', ''),\n\t        \tFilterSuborgsSender=column_ifexists('filter_suborgs_sender_s', ''),\n\t        \tFilterMsgSizeBytes=column_ifexists('filter_msgSizeBytes_d', ''),\n\t\t        FilterVerifiedRcptsHashed=column_ifexists('filter_verified_rcptsHashed_s', ''),\n\t\t        FilterVerifiedRcpts=column_ifexists('filter_verified_rcpts_s', ''),\n\t        \tGuid=column_ifexists('guid_s', ''),\n\t        \tEnvelopeRcptsHashed=column_ifexists('envelope_rcptsHashed_s', ''),\n\t        \tEnvelopeFromHashed=column_ifexists('envelope_fromHashed_s', ''),\n\t        \tMsgNormalizedHeaderReturnPathHashed=column_ifexists('msg_normalizedHeader_return_pathHashed_s', ''),\n\t        \tMsgNormalizedHeaderXMailer=column_ifexists('msg_normalizedHeader_x_mailer_s', ''),\n\t\t        MsgNormalizedHeaderReturnPath=column_ifexists('msg_normalizedHeader_return_path_s', ''),\n\t\t        MsgHeaderXMailer=column_ifexists('msg_header_x_mailer_s', ''),\n\t\t        MsgHeaderReturnPathHashed=column_ifexists('msg_header_return_pathHashed_s', ''),\n\t\t        MsgHeaderReturnPath=column_ifexists('msg_header_return_path_s', ''),\n\t\t        FilterModulesSpamCharsets=column_ifexists('filter_modules_spam_charsets_s', ''),\n\t\t        FilterModulesDmarcAlignment=column_ifexists('filter_modules_dmarc_alignment_s', ''),\n\t\t        MsgNormalizedHeaderXOriginatingIp=column_ifexists('msg_normalizedHeader_x_originating_ip_s', ''),\n\t\t        MsgHeaderXOriginatingIp=column_ifexists('msg_header_x_originating_ip_s', ''),\n\t\t        MsgNormalizedHeaderReplyTo=column_ifexists('msg_normalizedHeader_reply_to_s', ''),\n\t\t        MsgNormalizedHeaderReplyToHashed=column_ifexists('msg_normalizedHeader_reply_toHashed_s', ''),\n\t\t        MsgHeaderReplyToHashed=column_ifexists('msg_header_reply_toHashed_s', ''),\n\t\t        MsgHeaderReplyTo=column_ifexists('msg_header_reply_to_s', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail=column_ifexists('filter_modules_urldefense_counts_noRewriteIsEmail_d', ''),\n\t\t        FilterModulesPdrV2Rscore=column_ifexists('filter_modules_pdr_v2_rscore_d', ''),\n\t\t        FilterOrigGuid=column_ifexists('filter_origGuid_s', ''),\n\t\t        MsgNormalizedHeaderCc=column_ifexists('msg_normalizedHeader_cc_s', ''),\n\t\t        MsgNormalizedHeaderCcHashed=column_ifexists('msg_normalizedHeader_ccHashed_s', ''),\n\t\t        MsgParsedAddressesCcHashed=column_ifexists('msg_parsedAddresses_ccHashed_s', ''),\n\t\t        MsgParsedAddressesCc=column_ifexists('msg_parsedAddresses_cc_s', ''),\n\t\t        MsgHeaderCcHashed=column_ifexists('msg_header_ccHashed_s', ''),\n\t\t        MsgHeaderCc=column_ifexists('msg_header_cc_s', ''),\n\t\t        FilterModulesAvVirusNames=column_ifexists('filter_modules_av_virusNames_s', ''),\n\t\t        FilterThrottleIp=column_ifexists('filter_throttleIp_s', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme=column_ifexists('filter_modules_urldefense_counts_noRewriteIsUnsupportedScheme_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless=column_ifexists('filter_modules_urldefense_counts_noRewriteIsSchemeless_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded=column_ifexists('filter_modules_urldefense_counts_noRewriteIsMaxLengthExceeded_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain=column_ifexists('filter_modules_urldefense_counts_noRewriteIsExcludedDomain_d', ''),\n                PpsAgent=column_ifexists('pps_agent_s', ''),\n                EventOriginalTime=column_ifexists('ts_t', ''),\n                TlsCipher=column_ifexists('connection_tls_inbound_cipher_s', ''),\n                TlsCipherBits=column_ifexists('connection_tls_inbound_cipherBits_d', ''),\n                TlsVersion=column_ifexists('connection_tls_inbound_version_s', ''),\n                SrcIpAddr=column_ifexists('connection_ip_s', ''),\n                NetworkSessionId=column_ifexists('connection_sid_s', ''),\n                SrcDvcHostname=column_ifexists('connection_host_s', ''),\n                SrcGeoCountry=column_ifexists('connection_country_s', ''),\n                NetworkProtocol=column_ifexists('connection_protocol_s', ''),\n                NetworkConnectionState=column_ifexists('connection_resolveStatus_s', ''),\n                NetworkBytes=toreal( column_ifexists('msg_sizeBytes_s', '')),\n                NetworkDuration=tostring(column_ifexists('filter_durationSecs_d', '')),\n                EventStartTime=column_ifexists('filter_startTime_t', ''),\n                NetworkDirection=column_ifexists('filter_routeDirection_s', ''),\n                DstUserUpn=column_ifexists('envelope_rcpts_s', ''),\n                SrcUserUpn=column_ifexists('envelope_from_s', ''),\n                EventType=column_ifexists('event_type_s', ''),\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\n                PpsVersion,\n                PpsCid,\n                MsgParts,\n                MetadataOriginDataAgent,\n                MetadataOriginDataVersion,\n                MetadataOriginDataCid,\n                ConnectionHelo,\n                MsgLang,\n                MsgNormalizedHeaderSubject,\n                MsgNormalizedHeaderMessageId,\n                MsgNormalizedHeaderTo,\n                MsgNormalizedHeadertoHashed,\n                MsgNormalizedHeaderFrom,\n                MsgNormalizedHeaderFromHashed,\n                MsgHeaderFrom,\n                MsgHeaderFromHashed,\n                MsgHeaderMessageId,\n                MsgHeaderSubject,\n                MsgHeaderTo,\n                MsgHeaderToHashed,\n                MsgParsedAddressesFromHashed,\n                MsgParsedAddressesFrom,\n                MsgParsedAddressesToHashed,\n                MsgParsedAddressesTo,\n                FilterActions,\n                FilterRoutes,\n                FilterQid,\n                FilterIsMsgEncrypted,\n                FilterIsMsgReinjected,\n                FilterQuarantineRule,\n                FilterQuarantineFolder,\n                FilterModulesDmarcSrvid,\n                FilterModulesDmarcRecords,\n                FilterModulesDmarcFilterdResult,\n                FilterModulesDmarcAuthResults,\n                FilterModulesSpfDomain,\n                FilterModulesSpfResult,\n                FilterModulesSpamTriggeredClassifier,\n                FilterModulesSpamSafeBlockedListMatches,\n                FilterModulesSpamVersionEngine,\n                FilterModulesSpamVersionDefinitions,\n                FilterModulesSpamScoresOverall,\n                FilterModulesSpamScoresEngine,\n                FilterModulesSpamScoresClassifiers,\n                FilterModulesSpamLangs,\n                FilterModulesUrldefenseVersionEngine,\n                FilterModulesUrldefenseCountsUnique,\n                FilterModulesUrldefenseCountsRewritten,\n                FilterModulesUrldefenseCountsTotal,\n                FilterModulesDkimv,\n                FilterModulesPdrV2Response,\n                FilterModulesZerohourScore,\n                FilterDisposition,\n                FilterSuborgsRcpts,\n                FilterSuborgsSender,\n                FilterMsgSizeBytes,\n                FilterVerifiedRcptsHashed,\n                FilterVerifiedRcpts,\n                Guid,\n                EnvelopeRcptsHashed,\n                EnvelopeFromHashed,\n                MsgNormalizedHeaderReturnPathHashed,\n                MsgNormalizedHeaderXMailer,\n                MsgNormalizedHeaderReturnPath,\n                MsgHeaderXMailer,\n                MsgHeaderReturnPathHashed,\n                MsgHeaderReturnPath,\n                FilterModulesSpamCharsets,\n                FilterModulesDmarcAlignment,\n                MsgNormalizedHeaderXOriginatingIp,\n                MsgHeaderXOriginatingIp,\n                MsgNormalizedHeaderReplyTo,\n                MsgNormalizedHeaderReplyToHashed,\n                MsgHeaderReplyToHashed,\n                MsgHeaderReplyTo,\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\n                FilterModulesPdrV2Rscore,\n                FilterOrigGuid,\n                MsgNormalizedHeaderCc,\n                MsgNormalizedHeaderCcHashed,\n                MsgParsedAddressesCcHashed,\n                MsgParsedAddressesCc,\n                MsgHeaderCcHashed,\n                MsgHeaderCc,\n                FilterModulesAvVirusNames,\n                FilterThrottleIp,\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\n                PpsAgent,\n                SrcDvcHostname,\n                EventOriginalTime,\n                TlsCipher,\n                TlsCipherBits,\n                TlsVersion,\n                SrcIpAddr,\n                NetworkSessionId,\n                SrcGeoCountry,\n                NetworkProtocol,\n                NetworkConnectionState,\n                NetworkBytes,\n                NetworkDuration,\n                EventStartTime,\n                NetworkDirection,\n                DstUserUpn,\n                SrcUserUpn,\n                EventType\n\t| join kind=inner  (\n\t\tProofpointPOD_message_CL\n        | extend Guid = column_ifexists('guid_s', ''), MsgParts=column_ifexists('msgParts_s', '')\n\t\t| extend d = parse_json(MsgParts)\n        | mv-expand d\n        | extend URL_LIST = parse_json(d.urls)\n        | mv-expand URL_LIST\n        | extend URLLIST = tostring(URL_LIST.url)\n\t\t| summarize make_set(URLLIST) by Guid\n        )\n        on Guid\n    | project-away Guid1\n    | project-rename Urls = set_URLLIST\n};\nlet ProofpointPOD_messageV2_view = view () { \n    ProofpointPODMessage_CL\n    | extend \n    filter_data = parse_json(filter),\n    pps_data = parse_json(pps),\n    metadata_data = parse_json(metadata),\n    connection_data = parse_json(connection),\n    msg_data = parse_json(msg),\n    envelope_data = parse_json(envelope)\n    | extend \n            FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize= toreal(filter_data.modules.urldefense.counts.noRewriteIsLargeMsgPartSize),\n\t\t        PpsVersion= tostring(pps_data.version),\n\t\t        PpsCid= tostring(pps_data.cid),\n\t\t        MsgParts=column_ifexists('msgParts', ''),\n\t\t        MetadataOriginDataAgent= tostring(metadata_data.origin.data.agent),\n\t\t        MetadataOriginDataVersion= tostring(metadata_data.origin.data.version),\n\t\t        MetadataOriginDataCid= tostring(metadata_data.origin.data.cid),\n\t\t        ConnectionHelo= tostring(connection_data.helo),\n\t\t        MsgLang= tostring(msg_data.lang),\n\t\t        MsgNormalizedHeaderSubject= tostring(msg_data.normalizedHeader.[\"subject\"]),\n\t\t        MsgNormalizedHeaderMessageId= tostring(msg_data.normalizedHeader.[\"message-id\"]),\n\t\t        MsgNormalizedHeaderTo= tostring(msg_data.normalizedHeader.[\"to\"]),\n\t\t        MsgNormalizedHeadertoHashed= tostring(msg_data.normalizedHeader.[\"toHashed\"]),\n\t\t        MsgNormalizedHeaderFrom= tostring(msg_data.normalizedHeader.[\"from\"]),\n\t\t        MsgNormalizedHeaderFromHashed= tostring(msg_data.normalizedHeader.[\"fromHashed\"]),\n\t\t        MsgHeaderFrom= tostring(msg_data.header.[\"from\"]),\n\t\t        MsgHeaderFromHashed= tostring(msg_data.header.[\"fromHashed\"]),\n\t\t        MsgHeaderMessageId= tostring(msg_data.header.[\"message-id\"]),\n\t\t        MsgHeaderSubject= tostring(msg_data.header.[\"subject\"]),\n\t\t        MsgHeaderTo= tostring(msg_data.header.[\"to\"]),\n\t\t        MsgHeaderToHashed= tostring(msg_data.header.[\"toHashed\"]),\n\t\t        MsgParsedAddressesFromHashed= tostring(msg_data.parsedAddresses.[\"fromHashed\"]),\n\t\t        MsgParsedAddressesFrom= tostring(msg_data.parsedAddresses.[\"from\"]),\n\t\t        MsgParsedAddressesToHashed= tostring(msg_data.parsedAddresses.[\"toHashed\"]),\n\t\t        MsgParsedAddressesTo= tostring(msg_data.parsedAddresses.[\"to\"]),\n\t\t        FilterActions= tostring(filter_data.[\"actions\"]),\n\t\t        FilterRoutes= tostring(filter_data.[\"routes\"]),\n\t\t        FilterQid= tostring(filter_data.qid),\n\t\t        FilterIsMsgEncrypted= tobool(filter_data.isMsgEncrypted),\n\t\t        FilterIsMsgReinjected= tobool(filter_data.isMsgReinjected),\n\t\t        FilterQuarantineRule= tostring(filter_data.quarantine.rule),\n\t\t        FilterQuarantineFolder= tostring(filter_data.quarantine.folder),\n\t\t        FilterModulesDmarcSrvid= tostring(filter_data.modules.dmarc.srvid),\n\t\t        FilterModulesDmarcRecords= tostring(filter_data.modules.dmarc.records),\n\t\t        FilterModulesDmarcFilterdResult= tostring(filter_data.modules.dmarc.filterdResult),\n\t\t        FilterModulesDmarcAuthResults= tostring(filter_data.modules.dmarc.authResults),\n\t\t        FilterModulesSpfDomain= tostring(filter_data.modules.spf.domain),\n\t\t        FilterModulesSpfResult= tostring(filter_data.modules.spf.result),\n\t\t        FilterModulesSpamTriggeredClassifier= tostring(filter_data.modules.spam.triggeredClassifier),\n\t\t        FilterModulesSpamSafeBlockedListMatches= tostring(filter_data.modules.spam.safeBlockedListMatches),\n\t\t        FilterModulesSpamVersionEngine= tostring(filter_data.modules.spam.version.engine),\n\t\t        FilterModulesSpamVersionDefinitions= tostring(filter_data.modules.spam.version.definitions),\n\t\t        FilterModulesSpamScoresOverall= toreal(filter_data.modules.spam.scores.overall),\n\t\t        FilterModulesSpamScoresEngine= toreal(filter_data.modules.spam.scores.engine),\n\t\t        FilterModulesSpamScoresClassifiers= tostring(filter_data.modules.spam.scores.classifiers),\n\t\t        FilterModulesSpamLangs= tostring(filter_data.modules.spam.langs),\n\t\t        FilterModulesUrldefenseVersionEngine= tostring(filter_data.modules.urldefense.version.engine),\n\t\t        FilterModulesUrldefenseCountsUnique= toreal(filter_data.modules.urldefense.counts.unique),\n\t\t        FilterModulesUrldefenseCountsRewritten= toreal(filter_data.modules.urldefense.counts.rewritten),\n\t\t        FilterModulesUrldefenseCountsTotal= toreal(filter_data.modules.urldefense.counts.total),\n\t\t        FilterModulesDkimv= tostring(filter_data.modules.dkimv),\n\t\t        FilterModulesPdrV2Response= tostring(filter_data.modules.pdr.v2.response),\n\t\t        FilterModulesZerohourScore= tostring(filter_data.modules.zerohour.score),\n\t\t        FilterDisposition= tostring(filter_data.disposition),\n\t\t        FilterSuborgsRcpts= tostring(filter_data.suborgs.rcpts),\n\t        \tFilterSuborgsSender= tostring(filter_data.suborgs.sender),\n\t        \tFilterMsgSizeBytes= toreal(filter_data.msgSizeBytes),\n\t\t        FilterVerifiedRcptsHashed= tostring(filter_data.verified.rcptsHashed),\n\t\t        FilterVerifiedRcpts= tostring(filter_data.verified.rcpts),\n\t        \tGuid=column_ifexists('guid', ''),\n\t        \tEnvelopeRcptsHashed= tostring(envelope_data.[\"rcptsHashed\"]),\n\t        \tEnvelopeFromHashed= tostring(envelope_data.[\"fromHashed\"]),\n\t        \tMsgNormalizedHeaderReturnPathHashed= tostring(msg_data.normalizedHeader.[\"return-pathHashed\"]),\n\t        \tMsgNormalizedHeaderXMailer= tostring(msg_data.normalizedHeader.[\"x-mailer\"]),\n\t\t        MsgNormalizedHeaderReturnPath= tostring(msg_data.normalizedHeader.[\"return-path\"]),\n\t\t        MsgHeaderXMailer= tostring(msg_data.header.[\"x-mailer\"]),\n\t\t        MsgHeaderReturnPathHashed= tostring(msg_data.header.[\"return-pathHashed\"]),\n\t\t        MsgHeaderReturnPath= tostring(msg_data.header.[\"return-path\"]),\n\t\t        FilterModulesSpamCharsets= tostring(filter_data.modules.spam.charsets),\n\t\t        FilterModulesDmarcAlignment= tostring(filter_data.modules.dmarc.[\"alignment\"]),\n\t\t        MsgNormalizedHeaderXOriginatingIp= tostring(msg_data.normalizedHeader.[\"x-originating-ip\"]),\n\t\t        MsgHeaderXOriginatingIp= tostring(msg_data.header.[\"x-originating-ip\"]),\n\t\t        MsgNormalizedHeaderReplyTo= tostring(msg_data.normalizedHeader.[\"reply-to\"]),\n\t\t        MsgNormalizedHeaderReplyToHashed= tostring(msg_data.normalizedHeader.[\"reply-toHashed\"]),\n\t\t        MsgHeaderReplyToHashed= tostring(msg_data.header.[\"reply-toHashed\"]),\n\t\t        MsgHeaderReplyTo= tostring(msg_data.header.[\"reply-to\"]),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail= toreal(filter_data.modules.urldefense.counts.noRewriteIsEmail),\n\t\t        FilterModulesPdrV2Rscore= toreal(filter_data.modules.pdr.v2.rscore),\n\t\t        FilterOrigGuid= tostring(filter_data.origGuid),\n\t\t        MsgNormalizedHeaderCc= tostring(msg_data.normalizedHeader.[\"cc\"]),\n\t\t        MsgNormalizedHeaderCcHashed=tostring(msg_data.normalizedHeader.[\"ccHashed\"]),\n\t\t        MsgParsedAddressesCcHashed=tostring(msg_data.parsedAddresses.[\"ccHashed\"]),\n\t\t        MsgParsedAddressesCc= tostring(msg_data.parsedAddresses.[\"cc\"]),\n\t\t        MsgHeaderCcHashed= tostring(msg_data.header.[\"ccHashed\"]),\n\t\t        MsgHeaderCc= tostring(msg_data.header.[\"cc\"]),\n\t\t        FilterModulesAvVirusNames= tostring(filter_data.modules.av.virusNames),\n\t\t        FilterThrottleIp=tostring(filter_data.throttleIp),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme= toreal(filter_data.modules.urldefense.counts.noRewriteIsUnsupportedScheme),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless= toreal(filter_data.modules.urldefense.counts.noRewriteIsSchemeless),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded= tostring(filter_data.modules.urldefense.counts.noRewriteIsMaxLengthExceeded),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain= toreal(filter_data.modules.urldefense.counts.noRewriteIsExcludedDomain),\n                PpsAgent= tostring(pps_data.version),\n                EventOriginalTime=column_ifexists('eventTime', ''),\n                TlsCipher= tostring(connection_data.tls.inbound.cipher),\n                TlsCipherBits= toreal(connection_data.tls.inbound.cipherBits),\n                TlsVersion= tostring(connection_data.tls.inbound.version),\n                SrcIpAddr= tostring(connection_data.ip),\n                NetworkSessionId= tostring(connection_data.sid),\n                SrcDvcHostname= tostring(connection_data.host),\n                SrcGeoCountry= tostring(connection_data.country),\n                NetworkProtocol= tostring(connection_data.protocol),\n                NetworkConnectionState= tostring(connection_data.resolveStatus),\n                NetworkBytes=toreal(msg_data.sizeBytes),\n                NetworkDuration= tostring(filter_data.durationSecs),\n              //  EventStartTime= column_ifexists('filter_startTime_t', ''),\n                NetworkDirection= tostring(filter_data.routeDirection),\n                DstUserUpn= tostring(envelope_data.[\"rcpts\"]),\n                SrcUserUpn= tostring(envelope_data.from),\n                EventType= \"message\",\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\n                PpsVersion,\n                PpsCid,\n                MsgParts,\n                MetadataOriginDataAgent,\n                MetadataOriginDataVersion,\n                MetadataOriginDataCid,\n                ConnectionHelo,\n                MsgLang,\n                MsgNormalizedHeaderSubject,\n                MsgNormalizedHeaderMessageId,\n                MsgNormalizedHeaderTo,\n                MsgNormalizedHeadertoHashed,\n                MsgNormalizedHeaderFrom,\n                MsgNormalizedHeaderFromHashed,\n                MsgHeaderFrom,\n                MsgHeaderFromHashed,\n                MsgHeaderMessageId,\n                MsgHeaderSubject,\n                MsgHeaderTo,\n                MsgHeaderToHashed,\n                MsgParsedAddressesFromHashed,\n                MsgParsedAddressesFrom,\n                MsgParsedAddressesToHashed,\n                MsgParsedAddressesTo,\n                FilterActions,\n                FilterRoutes,\n                FilterQid,\n                FilterIsMsgEncrypted,\n                FilterIsMsgReinjected,\n                FilterQuarantineRule,\n                FilterQuarantineFolder,\n                FilterModulesDmarcSrvid,\n                FilterModulesDmarcRecords,\n                FilterModulesDmarcFilterdResult,\n                FilterModulesDmarcAuthResults,\n                FilterModulesSpfDomain,\n                FilterModulesSpfResult,\n                FilterModulesSpamTriggeredClassifier,\n                FilterModulesSpamSafeBlockedListMatches,\n                FilterModulesSpamVersionEngine,\n                FilterModulesSpamVersionDefinitions,\n                FilterModulesSpamScoresOverall,\n                FilterModulesSpamScoresEngine,\n                FilterModulesSpamScoresClassifiers,\n                FilterModulesSpamLangs,\n                FilterModulesUrldefenseVersionEngine,\n                FilterModulesUrldefenseCountsUnique,\n                FilterModulesUrldefenseCountsRewritten,\n                FilterModulesUrldefenseCountsTotal,\n                FilterModulesDkimv,\n                FilterModulesPdrV2Response,\n                FilterModulesZerohourScore,\n                FilterDisposition,\n                FilterSuborgsRcpts,\n                FilterSuborgsSender,\n                FilterMsgSizeBytes,\n                FilterVerifiedRcptsHashed,\n                FilterVerifiedRcpts,\n                Guid,\n                EnvelopeRcptsHashed,\n                EnvelopeFromHashed,\n                MsgNormalizedHeaderReturnPathHashed,\n                MsgNormalizedHeaderXMailer,\n                MsgNormalizedHeaderReturnPath,\n                MsgHeaderXMailer,\n                MsgHeaderReturnPathHashed,\n                MsgHeaderReturnPath,\n                FilterModulesSpamCharsets,\n                FilterModulesDmarcAlignment,\n                MsgNormalizedHeaderXOriginatingIp,\n                MsgHeaderXOriginatingIp,\n                MsgNormalizedHeaderReplyTo,\n                MsgNormalizedHeaderReplyToHashed,\n                MsgHeaderReplyToHashed,\n                MsgHeaderReplyTo,\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\n                FilterModulesPdrV2Rscore,\n                FilterOrigGuid,\n                MsgNormalizedHeaderCc,\n                MsgNormalizedHeaderCcHashed,\n                MsgParsedAddressesCcHashed,\n                MsgParsedAddressesCc,\n                MsgHeaderCcHashed,\n                MsgHeaderCc,\n                FilterModulesAvVirusNames,\n                FilterThrottleIp,\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\n                PpsAgent,\n                SrcDvcHostname,\n                EventOriginalTime,\n                TlsCipher,\n                TlsCipherBits,\n                TlsVersion,\n                SrcIpAddr,\n                NetworkSessionId,\n                SrcGeoCountry,\n                NetworkProtocol,\n                NetworkConnectionState,\n                NetworkBytes,\n                NetworkDuration,\n              //  EventStartTime,\n                NetworkDirection,\n                DstUserUpn,\n                SrcUserUpn,\n                EventType\n    | join kind=inner  (\n\t\tProofpointPODMessage_CL\n        | project Guid = column_ifexists('guid', ''), MsgParts=column_ifexists('msgParts', '')\n\t\t| extend d = parse_json(MsgParts)\n        | mv-expand d\n        | extend URL_LIST = parse_json(d.urls)\n        | mv-expand URL_LIST\n        | extend URLLIST = tostring(URL_LIST.url)\n\t\t| summarize make_set(URLLIST) by Guid\n        )\n        on Guid\n    | project-away Guid1\n    | project-rename Urls = set_URLLIST\n};\nunion isfuzzy=true ProofpointPOD_message_view, ProofpointPOD_maillog_view, ProofpointPOD_maillogV2_view, ProofpointPOD_messageV2_view\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
              "dependsOn": [
                "[variables('parserObject1')._parserId1]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ProofpointPOD')]",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "kind": "Parser",
                "version": "[variables('parserObject1').parserVersion1]",
                "source": {
                  "name": "Proofpoint On demand(POD) Email Security",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "contentKind": "Parser",
        "displayName": "Parser for ProofpointPOD",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.1')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.1')))]",
        "version": "[variables('parserObject1').parserVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('parserObject1')._parserName1]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for ProofpointPOD",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "ProofpointPOD",
        "query": "let ProofpointPOD_maillog_view = view () { \n    union isfuzzy=true ProofpointPOD_maillog_CL, maillog_CL | where isnotempty( pps_cid_s) and event_type_s == \"maillog\"\n    | extend \n                SmMsgid=column_ifexists('sm_msgid_g', ''),\n                PpsCid=column_ifexists('pps_cid_s', ''),\n                PpsAgent=column_ifexists('pps_agent_s', ''),\n                Id=column_ifexists('id_s', ''),\n                SmNrcpts=column_ifexists('sm_nrcpts_s', ''),\n                SmAuth=column_ifexists('sm_auth_s', ''),\n                SmClass=column_ifexists('sm_class_s', ''),\n                SmQid=column_ifexists('sm_qid_s', ''),\n                MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\n                MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\n                SmMailer=column_ifexists('sm_mailer_s', ''),\n                SmDsn=column_ifexists('sm_dsn_s', ''),\n                SmPri=column_ifexists('sm_pri_s', ''),\n                SmXdelay=column_ifexists('sm_xdelay_s', ''),\n                SmCtladdr=column_ifexists('sm_ctladdr_s', ''),\n                EventUid=column_ifexists('sm_msgid_s', ''),\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\n                TlsEstablished=column_ifexists('sm_tls_verify_s', ''),\n                SrcNatIpAddr=column_ifexists('sm_relay_s', ''),\n                ProcessName=column_ifexists('sm_daemon_s', ''),\n                NetworkProtocol=column_ifexists('sm_proto_s', ''),\n                SrcUserUpn=column_ifexists('sm_from_s', ''),\n                EventOriginalTime=column_ifexists('ts_t', ''),\n                EventOriginalMessage=column_ifexists('data_s', ''),\n                EventType=column_ifexists('event_type_s', ''),\n                NetworkConnectionStateDetailed=column_ifexists('sm_stat_s', ''),\n                DstUserUpn=column_ifexists('sm_to_s', ''),\n                NetworkDuration=column_ifexists('sm_delay_s', ''),\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                SmMsgid,\n                PpsCid,\n                PpsAgent,\n                Id,\n                SmNrcpts,\n                SmAuth,\n                SmClass,\n                SmQid,\n                MetadataOriginDataAgent,\n                MetadataOriginDataCid,\n                SmMailer,\n                SmDsn,\n                SmPri,\n                SmXdelay,\n                SmCtladdr,\n                EventUid,\n                NetworkBytes,\n                TlsEstablished,\n                SrcNatIpAddr,\n                ProcessName,\n                NetworkProtocol,\n                SrcUserUpn,\n                EventOriginalTime,\n                EventOriginalMessage,\n                EventType,\n                NetworkConnectionStateDetailed,\n                DstUserUpn,\n                NetworkDuration\n};\nlet ProofpointPOD_maillogV2_view = view () {\n    ProofpointPODMailLog_CL\n    | extend \n    sm_data = parse_json(sm),\n    pps_data = parse_json(pps),\n    metadata_data = parse_json(metadata)\n    | extend SmMsgid = tostring(sm_data.msgid),\n        PpsCid = tostring(pps_data.cid),\n        PpsAgent = tostring(pps_data.agent),\n        Id = column_ifexists('id', ''),\n        SmNrcpts = tostring(sm_data.nrcpts),\n        SmAuth = tostring(sm_data.auth),\n        SmClass = tostring(sm_data.class),\n        SmQid = tostring(sm_data.qid),\n        MetadataOriginDataAgent = tostring(metadata_data.origin.data.agent),\n        MetadataOriginDataCid = tostring(metadata_data.origin.data.cid),\n        SmMailer = tostring(sm_data.mailer),\n        SmDsn = tostring(sm_data.dsn),\n        SmPri = tostring(sm_data.pri),\n        SmXdelay = tostring(sm_data.xdelay),\n        SmCtladdr = tostring(sm_data.ctladdr),\n        EventUid = tostring(sm_data.msgid), // need to verify\n        NetworkBytes = toreal(sm_data.sizeBytes),\n        //TlsEstablished = parse_json(sm).tls_verify,\n        SrcNatIpAddr = tostring(sm_data.relay),\n        ProcessName = tostring(sm_data.daemon),\n        NetworkProtocol = tostring(sm_data.proto),\n        SrcUserUpn = tostring(sm_data.from),\n        EventOriginalTime = column_ifexists('eventTime', ''),\n        EventOriginalMessage = column_ifexists('data', ''),\n        EventType = \"maillog\",\n        NetworkConnectionStateDetailed = tostring(sm_data.stat),\n        DstUserUpn = tostring(sm_data.[\"to\"]),\n        NetworkDuration = tostring(sm_data.delay),\n        EventVendor = \"Proofpoint\", \n        EventProduct = \"Proofpoint On Demand Email Security\"\n    | project\n         TimeGenerated, \n                EventVendor,\n                EventProduct,\n                SmMsgid,\n                PpsCid,\n                PpsAgent,\n                Id,\n                SmNrcpts,\n                SmAuth,\n                SmClass,\n                SmQid,\n                MetadataOriginDataAgent,\n                MetadataOriginDataCid,\n                SmMailer,\n                SmDsn,\n                SmPri,\n                SmXdelay,\n                SmCtladdr,\n                EventUid,\n                NetworkBytes,\n               // TlsEstablished,\n                SrcNatIpAddr,\n                ProcessName,\n                NetworkProtocol,\n                SrcUserUpn,\n                EventOriginalTime,\n                EventOriginalMessage,\n                EventType,\n                NetworkConnectionStateDetailed,\n                DstUserUpn,\n                NetworkDuration             \n};\nlet ProofpointPOD_message_view = view () { \n    union isfuzzy=true ProofpointPOD_message_CL, message_CL | where event_type_s == \"message\"\n    | extend \n            FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize=column_ifexists('filter_modules_urldefense_counts_noRewriteIsLargeMsgPartSize_d', ''),\n\t\t        PpsVersion=column_ifexists('pps_version_s', ''),\n\t\t        PpsCid=column_ifexists('pps_cid_s', ''),\n\t\t        MsgParts=todynamic(column_ifexists('msgParts_s', '')),\n\t\t        MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\n\t\t        MetadataOriginDataVersion=column_ifexists('metadata_origin_data_version_s', ''),\n\t\t        MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\n\t\t        ConnectionHelo=column_ifexists('connection_helo_s', ''),\n\t\t        MsgLang=column_ifexists('msg_lang_s', ''),\n\t\t        MsgNormalizedHeaderSubject=column_ifexists('msg_normalizedHeader_subject_s', ''),\n\t\t        MsgNormalizedHeaderMessageId=column_ifexists('msg_normalizedHeader_message_id_s', ''),\n\t\t        MsgNormalizedHeaderTo=column_ifexists('msg_normalizedHeader_to_s', ''),\n\t\t        MsgNormalizedHeadertoHashed=column_ifexists('msg_normalizedHeader_toHashed_s', ''),\n\t\t        MsgNormalizedHeaderFrom=column_ifexists('msg_normalizedHeader_from_s', ''),\n\t\t        MsgNormalizedHeaderFromHashed=column_ifexists('msg_normalizedHeader_fromHashed_s', ''),\n\t\t        MsgHeaderFrom=column_ifexists('msg_header_from_s', ''),\n\t\t        MsgHeaderFromHashed=column_ifexists('msg_header_fromHashed_s', ''),\n\t\t        MsgHeaderMessageId=column_ifexists('msg_header_message_id_s', ''),\n\t\t        MsgHeaderSubject=column_ifexists('msg_header_subject_s', ''),\n\t\t        MsgHeaderTo=column_ifexists('msg_header_to_s', ''),\n\t\t        MsgHeaderToHashed=column_ifexists('msg_header_toHashed_s', ''),\n\t\t        MsgParsedAddressesFromHashed=column_ifexists('msg_parsedAddresses_fromHashed_s', ''),\n\t\t        MsgParsedAddressesFrom=column_ifexists('msg_parsedAddresses_from_s', ''),\n\t\t        MsgParsedAddressesToHashed=column_ifexists('msg_parsedAddresses_toHashed_s', ''),\n\t\t        MsgParsedAddressesTo=column_ifexists('msg_parsedAddresses_to_s', ''),\n\t\t        FilterActions=column_ifexists('filter_actions_s', ''),\n\t\t        FilterRoutes=column_ifexists('filter_routes_s', ''),\n\t\t        FilterQid=column_ifexists('filter_qid_s', ''),\n\t\t        FilterIsMsgEncrypted=tobool(column_ifexists('filter_isMsgEncrypted_b', '')),\n\t\t        FilterIsMsgReinjected=tobool(column_ifexists('filter_isMsgReinjected_b', '')),\n\t\t        FilterQuarantineRule=column_ifexists('filter_quarantine_rule_s', ''),\n\t\t        FilterQuarantineFolder=column_ifexists('filter_quarantine_folder_s', ''),\n\t\t        FilterModulesDmarcSrvid=column_ifexists('filter_modules_dmarc_srvid_s', ''),\n\t\t        FilterModulesDmarcRecords=column_ifexists('filter_modules_dmarc_records_s', ''),\n\t\t        FilterModulesDmarcFilterdResult=column_ifexists('filter_modules_dmarc_filterdResult_s', ''),\n\t\t        FilterModulesDmarcAuthResults=column_ifexists('filter_modules_dmarc_authResults_s', ''),\n\t\t        FilterModulesSpfDomain=column_ifexists('filter_modules_spf_domain_s', ''),\n\t\t        FilterModulesSpfResult=column_ifexists('filter_modules_spf_result_s', ''),\n\t\t        FilterModulesSpamTriggeredClassifier=column_ifexists('filter_modules_spam_triggeredClassifier_s', ''),\n\t\t        FilterModulesSpamSafeBlockedListMatches=column_ifexists('filter_modules_spam_safeBlockedListMatches_s', ''),\n\t\t        FilterModulesSpamVersionEngine=column_ifexists('filter_modules_spam_version_engine_s', ''),\n\t\t        FilterModulesSpamVersionDefinitions=column_ifexists('filter_modules_spam_version_definitions_s', ''),\n\t\t        FilterModulesSpamScoresOverall=column_ifexists('filter_modules_spam_scores_overall_d', ''),\n\t\t        FilterModulesSpamScoresEngine=column_ifexists('filter_modules_spam_scores_engine_d', ''),\n\t\t        FilterModulesSpamScoresClassifiers=column_ifexists('filter_modules_spam_scores_classifiers_s', ''),\n\t\t        FilterModulesSpamLangs=column_ifexists('filter_modules_spam_langs_s', ''),\n\t\t        FilterModulesUrldefenseVersionEngine=column_ifexists('filter_modules_urldefense_version_engine_s', ''),\n\t\t        FilterModulesUrldefenseCountsUnique=column_ifexists('filter_modules_urldefense_counts_unique_d', ''),\n\t\t        FilterModulesUrldefenseCountsRewritten=column_ifexists('filter_modules_urldefense_counts_rewritten_d', ''),\n\t\t        FilterModulesUrldefenseCountsTotal=column_ifexists('filter_modules_urldefense_counts_total_d', ''),\n\t\t        FilterModulesDkimv=column_ifexists('filter_modules_dkimv_s', ''),\n\t\t        FilterModulesPdrV2Response=column_ifexists('filter_modules_pdr_v2_response_s', ''),\n\t\t        FilterModulesZerohourScore=column_ifexists('filter_modules_zerohour_score_s', ''),\n\t\t        FilterDisposition=column_ifexists('filter_disposition_s', ''),\n\t\t        FilterSuborgsRcpts=column_ifexists('filter_suborgs_rcpts_s', ''),\n\t        \tFilterSuborgsSender=column_ifexists('filter_suborgs_sender_s', ''),\n\t        \tFilterMsgSizeBytes=column_ifexists('filter_msgSizeBytes_d', ''),\n\t\t        FilterVerifiedRcptsHashed=column_ifexists('filter_verified_rcptsHashed_s', ''),\n\t\t        FilterVerifiedRcpts=column_ifexists('filter_verified_rcpts_s', ''),\n\t        \tGuid=column_ifexists('guid_s', ''),\n\t        \tEnvelopeRcptsHashed=column_ifexists('envelope_rcptsHashed_s', ''),\n\t        \tEnvelopeFromHashed=column_ifexists('envelope_fromHashed_s', ''),\n\t        \tMsgNormalizedHeaderReturnPathHashed=column_ifexists('msg_normalizedHeader_return_pathHashed_s', ''),\n\t        \tMsgNormalizedHeaderXMailer=column_ifexists('msg_normalizedHeader_x_mailer_s', ''),\n\t\t        MsgNormalizedHeaderReturnPath=column_ifexists('msg_normalizedHeader_return_path_s', ''),\n\t\t        MsgHeaderXMailer=column_ifexists('msg_header_x_mailer_s', ''),\n\t\t        MsgHeaderReturnPathHashed=column_ifexists('msg_header_return_pathHashed_s', ''),\n\t\t        MsgHeaderReturnPath=column_ifexists('msg_header_return_path_s', ''),\n\t\t        FilterModulesSpamCharsets=column_ifexists('filter_modules_spam_charsets_s', ''),\n\t\t        FilterModulesDmarcAlignment=column_ifexists('filter_modules_dmarc_alignment_s', ''),\n\t\t        MsgNormalizedHeaderXOriginatingIp=column_ifexists('msg_normalizedHeader_x_originating_ip_s', ''),\n\t\t        MsgHeaderXOriginatingIp=column_ifexists('msg_header_x_originating_ip_s', ''),\n\t\t        MsgNormalizedHeaderReplyTo=column_ifexists('msg_normalizedHeader_reply_to_s', ''),\n\t\t        MsgNormalizedHeaderReplyToHashed=column_ifexists('msg_normalizedHeader_reply_toHashed_s', ''),\n\t\t        MsgHeaderReplyToHashed=column_ifexists('msg_header_reply_toHashed_s', ''),\n\t\t        MsgHeaderReplyTo=column_ifexists('msg_header_reply_to_s', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail=column_ifexists('filter_modules_urldefense_counts_noRewriteIsEmail_d', ''),\n\t\t        FilterModulesPdrV2Rscore=column_ifexists('filter_modules_pdr_v2_rscore_d', ''),\n\t\t        FilterOrigGuid=column_ifexists('filter_origGuid_s', ''),\n\t\t        MsgNormalizedHeaderCc=column_ifexists('msg_normalizedHeader_cc_s', ''),\n\t\t        MsgNormalizedHeaderCcHashed=column_ifexists('msg_normalizedHeader_ccHashed_s', ''),\n\t\t        MsgParsedAddressesCcHashed=column_ifexists('msg_parsedAddresses_ccHashed_s', ''),\n\t\t        MsgParsedAddressesCc=column_ifexists('msg_parsedAddresses_cc_s', ''),\n\t\t        MsgHeaderCcHashed=column_ifexists('msg_header_ccHashed_s', ''),\n\t\t        MsgHeaderCc=column_ifexists('msg_header_cc_s', ''),\n\t\t        FilterModulesAvVirusNames=column_ifexists('filter_modules_av_virusNames_s', ''),\n\t\t        FilterThrottleIp=column_ifexists('filter_throttleIp_s', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme=column_ifexists('filter_modules_urldefense_counts_noRewriteIsUnsupportedScheme_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless=column_ifexists('filter_modules_urldefense_counts_noRewriteIsSchemeless_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded=column_ifexists('filter_modules_urldefense_counts_noRewriteIsMaxLengthExceeded_d', ''),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain=column_ifexists('filter_modules_urldefense_counts_noRewriteIsExcludedDomain_d', ''),\n                PpsAgent=column_ifexists('pps_agent_s', ''),\n                EventOriginalTime=column_ifexists('ts_t', ''),\n                TlsCipher=column_ifexists('connection_tls_inbound_cipher_s', ''),\n                TlsCipherBits=column_ifexists('connection_tls_inbound_cipherBits_d', ''),\n                TlsVersion=column_ifexists('connection_tls_inbound_version_s', ''),\n                SrcIpAddr=column_ifexists('connection_ip_s', ''),\n                NetworkSessionId=column_ifexists('connection_sid_s', ''),\n                SrcDvcHostname=column_ifexists('connection_host_s', ''),\n                SrcGeoCountry=column_ifexists('connection_country_s', ''),\n                NetworkProtocol=column_ifexists('connection_protocol_s', ''),\n                NetworkConnectionState=column_ifexists('connection_resolveStatus_s', ''),\n                NetworkBytes=toreal( column_ifexists('msg_sizeBytes_s', '')),\n                NetworkDuration=tostring(column_ifexists('filter_durationSecs_d', '')),\n                EventStartTime=column_ifexists('filter_startTime_t', ''),\n                NetworkDirection=column_ifexists('filter_routeDirection_s', ''),\n                DstUserUpn=column_ifexists('envelope_rcpts_s', ''),\n                SrcUserUpn=column_ifexists('envelope_from_s', ''),\n                EventType=column_ifexists('event_type_s', ''),\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\n                PpsVersion,\n                PpsCid,\n                MsgParts,\n                MetadataOriginDataAgent,\n                MetadataOriginDataVersion,\n                MetadataOriginDataCid,\n                ConnectionHelo,\n                MsgLang,\n                MsgNormalizedHeaderSubject,\n                MsgNormalizedHeaderMessageId,\n                MsgNormalizedHeaderTo,\n                MsgNormalizedHeadertoHashed,\n                MsgNormalizedHeaderFrom,\n                MsgNormalizedHeaderFromHashed,\n                MsgHeaderFrom,\n                MsgHeaderFromHashed,\n                MsgHeaderMessageId,\n                MsgHeaderSubject,\n                MsgHeaderTo,\n                MsgHeaderToHashed,\n                MsgParsedAddressesFromHashed,\n                MsgParsedAddressesFrom,\n                MsgParsedAddressesToHashed,\n                MsgParsedAddressesTo,\n                FilterActions,\n                FilterRoutes,\n                FilterQid,\n                FilterIsMsgEncrypted,\n                FilterIsMsgReinjected,\n                FilterQuarantineRule,\n                FilterQuarantineFolder,\n                FilterModulesDmarcSrvid,\n                FilterModulesDmarcRecords,\n                FilterModulesDmarcFilterdResult,\n                FilterModulesDmarcAuthResults,\n                FilterModulesSpfDomain,\n                FilterModulesSpfResult,\n                FilterModulesSpamTriggeredClassifier,\n                FilterModulesSpamSafeBlockedListMatches,\n                FilterModulesSpamVersionEngine,\n                FilterModulesSpamVersionDefinitions,\n                FilterModulesSpamScoresOverall,\n                FilterModulesSpamScoresEngine,\n                FilterModulesSpamScoresClassifiers,\n                FilterModulesSpamLangs,\n                FilterModulesUrldefenseVersionEngine,\n                FilterModulesUrldefenseCountsUnique,\n                FilterModulesUrldefenseCountsRewritten,\n                FilterModulesUrldefenseCountsTotal,\n                FilterModulesDkimv,\n                FilterModulesPdrV2Response,\n                FilterModulesZerohourScore,\n                FilterDisposition,\n                FilterSuborgsRcpts,\n                FilterSuborgsSender,\n                FilterMsgSizeBytes,\n                FilterVerifiedRcptsHashed,\n                FilterVerifiedRcpts,\n                Guid,\n                EnvelopeRcptsHashed,\n                EnvelopeFromHashed,\n                MsgNormalizedHeaderReturnPathHashed,\n                MsgNormalizedHeaderXMailer,\n                MsgNormalizedHeaderReturnPath,\n                MsgHeaderXMailer,\n                MsgHeaderReturnPathHashed,\n                MsgHeaderReturnPath,\n                FilterModulesSpamCharsets,\n                FilterModulesDmarcAlignment,\n                MsgNormalizedHeaderXOriginatingIp,\n                MsgHeaderXOriginatingIp,\n                MsgNormalizedHeaderReplyTo,\n                MsgNormalizedHeaderReplyToHashed,\n                MsgHeaderReplyToHashed,\n                MsgHeaderReplyTo,\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\n                FilterModulesPdrV2Rscore,\n                FilterOrigGuid,\n                MsgNormalizedHeaderCc,\n                MsgNormalizedHeaderCcHashed,\n                MsgParsedAddressesCcHashed,\n                MsgParsedAddressesCc,\n                MsgHeaderCcHashed,\n                MsgHeaderCc,\n                FilterModulesAvVirusNames,\n                FilterThrottleIp,\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\n                PpsAgent,\n                SrcDvcHostname,\n                EventOriginalTime,\n                TlsCipher,\n                TlsCipherBits,\n                TlsVersion,\n                SrcIpAddr,\n                NetworkSessionId,\n                SrcGeoCountry,\n                NetworkProtocol,\n                NetworkConnectionState,\n                NetworkBytes,\n                NetworkDuration,\n                EventStartTime,\n                NetworkDirection,\n                DstUserUpn,\n                SrcUserUpn,\n                EventType\n\t| join kind=inner  (\n\t\tProofpointPOD_message_CL\n        | extend Guid = column_ifexists('guid_s', ''), MsgParts=column_ifexists('msgParts_s', '')\n\t\t| extend d = parse_json(MsgParts)\n        | mv-expand d\n        | extend URL_LIST = parse_json(d.urls)\n        | mv-expand URL_LIST\n        | extend URLLIST = tostring(URL_LIST.url)\n\t\t| summarize make_set(URLLIST) by Guid\n        )\n        on Guid\n    | project-away Guid1\n    | project-rename Urls = set_URLLIST\n};\nlet ProofpointPOD_messageV2_view = view () { \n    ProofpointPODMessage_CL\n    | extend \n    filter_data = parse_json(filter),\n    pps_data = parse_json(pps),\n    metadata_data = parse_json(metadata),\n    connection_data = parse_json(connection),\n    msg_data = parse_json(msg),\n    envelope_data = parse_json(envelope)\n    | extend \n            FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize= toreal(filter_data.modules.urldefense.counts.noRewriteIsLargeMsgPartSize),\n\t\t        PpsVersion= tostring(pps_data.version),\n\t\t        PpsCid= tostring(pps_data.cid),\n\t\t        MsgParts=column_ifexists('msgParts', ''),\n\t\t        MetadataOriginDataAgent= tostring(metadata_data.origin.data.agent),\n\t\t        MetadataOriginDataVersion= tostring(metadata_data.origin.data.version),\n\t\t        MetadataOriginDataCid= tostring(metadata_data.origin.data.cid),\n\t\t        ConnectionHelo= tostring(connection_data.helo),\n\t\t        MsgLang= tostring(msg_data.lang),\n\t\t        MsgNormalizedHeaderSubject= tostring(msg_data.normalizedHeader.[\"subject\"]),\n\t\t        MsgNormalizedHeaderMessageId= tostring(msg_data.normalizedHeader.[\"message-id\"]),\n\t\t        MsgNormalizedHeaderTo= tostring(msg_data.normalizedHeader.[\"to\"]),\n\t\t        MsgNormalizedHeadertoHashed= tostring(msg_data.normalizedHeader.[\"toHashed\"]),\n\t\t        MsgNormalizedHeaderFrom= tostring(msg_data.normalizedHeader.[\"from\"]),\n\t\t        MsgNormalizedHeaderFromHashed= tostring(msg_data.normalizedHeader.[\"fromHashed\"]),\n\t\t        MsgHeaderFrom= tostring(msg_data.header.[\"from\"]),\n\t\t        MsgHeaderFromHashed= tostring(msg_data.header.[\"fromHashed\"]),\n\t\t        MsgHeaderMessageId= tostring(msg_data.header.[\"message-id\"]),\n\t\t        MsgHeaderSubject= tostring(msg_data.header.[\"subject\"]),\n\t\t        MsgHeaderTo= tostring(msg_data.header.[\"to\"]),\n\t\t        MsgHeaderToHashed= tostring(msg_data.header.[\"toHashed\"]),\n\t\t        MsgParsedAddressesFromHashed= tostring(msg_data.parsedAddresses.[\"fromHashed\"]),\n\t\t        MsgParsedAddressesFrom= tostring(msg_data.parsedAddresses.[\"from\"]),\n\t\t        MsgParsedAddressesToHashed= tostring(msg_data.parsedAddresses.[\"toHashed\"]),\n\t\t        MsgParsedAddressesTo= tostring(msg_data.parsedAddresses.[\"to\"]),\n\t\t        FilterActions= tostring(filter_data.[\"actions\"]),\n\t\t        FilterRoutes= tostring(filter_data.[\"routes\"]),\n\t\t        FilterQid= tostring(filter_data.qid),\n\t\t        FilterIsMsgEncrypted= tobool(filter_data.isMsgEncrypted),\n\t\t        FilterIsMsgReinjected= tobool(filter_data.isMsgReinjected),\n\t\t        FilterQuarantineRule= tostring(filter_data.quarantine.rule),\n\t\t        FilterQuarantineFolder= tostring(filter_data.quarantine.folder),\n\t\t        FilterModulesDmarcSrvid= tostring(filter_data.modules.dmarc.srvid),\n\t\t        FilterModulesDmarcRecords= tostring(filter_data.modules.dmarc.records),\n\t\t        FilterModulesDmarcFilterdResult= tostring(filter_data.modules.dmarc.filterdResult),\n\t\t        FilterModulesDmarcAuthResults= tostring(filter_data.modules.dmarc.authResults),\n\t\t        FilterModulesSpfDomain= tostring(filter_data.modules.spf.domain),\n\t\t        FilterModulesSpfResult= tostring(filter_data.modules.spf.result),\n\t\t        FilterModulesSpamTriggeredClassifier= tostring(filter_data.modules.spam.triggeredClassifier),\n\t\t        FilterModulesSpamSafeBlockedListMatches= tostring(filter_data.modules.spam.safeBlockedListMatches),\n\t\t        FilterModulesSpamVersionEngine= tostring(filter_data.modules.spam.version.engine),\n\t\t        FilterModulesSpamVersionDefinitions= tostring(filter_data.modules.spam.version.definitions),\n\t\t        FilterModulesSpamScoresOverall= toreal(filter_data.modules.spam.scores.overall),\n\t\t        FilterModulesSpamScoresEngine= toreal(filter_data.modules.spam.scores.engine),\n\t\t        FilterModulesSpamScoresClassifiers= tostring(filter_data.modules.spam.scores.classifiers),\n\t\t        FilterModulesSpamLangs= tostring(filter_data.modules.spam.langs),\n\t\t        FilterModulesUrldefenseVersionEngine= tostring(filter_data.modules.urldefense.version.engine),\n\t\t        FilterModulesUrldefenseCountsUnique= toreal(filter_data.modules.urldefense.counts.unique),\n\t\t        FilterModulesUrldefenseCountsRewritten= toreal(filter_data.modules.urldefense.counts.rewritten),\n\t\t        FilterModulesUrldefenseCountsTotal= toreal(filter_data.modules.urldefense.counts.total),\n\t\t        FilterModulesDkimv= tostring(filter_data.modules.dkimv),\n\t\t        FilterModulesPdrV2Response= tostring(filter_data.modules.pdr.v2.response),\n\t\t        FilterModulesZerohourScore= tostring(filter_data.modules.zerohour.score),\n\t\t        FilterDisposition= tostring(filter_data.disposition),\n\t\t        FilterSuborgsRcpts= tostring(filter_data.suborgs.rcpts),\n\t        \tFilterSuborgsSender= tostring(filter_data.suborgs.sender),\n\t        \tFilterMsgSizeBytes= toreal(filter_data.msgSizeBytes),\n\t\t        FilterVerifiedRcptsHashed= tostring(filter_data.verified.rcptsHashed),\n\t\t        FilterVerifiedRcpts= tostring(filter_data.verified.rcpts),\n\t        \tGuid=column_ifexists('guid', ''),\n\t        \tEnvelopeRcptsHashed= tostring(envelope_data.[\"rcptsHashed\"]),\n\t        \tEnvelopeFromHashed= tostring(envelope_data.[\"fromHashed\"]),\n\t        \tMsgNormalizedHeaderReturnPathHashed= tostring(msg_data.normalizedHeader.[\"return-pathHashed\"]),\n\t        \tMsgNormalizedHeaderXMailer= tostring(msg_data.normalizedHeader.[\"x-mailer\"]),\n\t\t        MsgNormalizedHeaderReturnPath= tostring(msg_data.normalizedHeader.[\"return-path\"]),\n\t\t        MsgHeaderXMailer= tostring(msg_data.header.[\"x-mailer\"]),\n\t\t        MsgHeaderReturnPathHashed= tostring(msg_data.header.[\"return-pathHashed\"]),\n\t\t        MsgHeaderReturnPath= tostring(msg_data.header.[\"return-path\"]),\n\t\t        FilterModulesSpamCharsets= tostring(filter_data.modules.spam.charsets),\n\t\t        FilterModulesDmarcAlignment= tostring(filter_data.modules.dmarc.[\"alignment\"]),\n\t\t        MsgNormalizedHeaderXOriginatingIp= tostring(msg_data.normalizedHeader.[\"x-originating-ip\"]),\n\t\t        MsgHeaderXOriginatingIp= tostring(msg_data.header.[\"x-originating-ip\"]),\n\t\t        MsgNormalizedHeaderReplyTo= tostring(msg_data.normalizedHeader.[\"reply-to\"]),\n\t\t        MsgNormalizedHeaderReplyToHashed= tostring(msg_data.normalizedHeader.[\"reply-toHashed\"]),\n\t\t        MsgHeaderReplyToHashed= tostring(msg_data.header.[\"reply-toHashed\"]),\n\t\t        MsgHeaderReplyTo= tostring(msg_data.header.[\"reply-to\"]),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail= toreal(filter_data.modules.urldefense.counts.noRewriteIsEmail),\n\t\t        FilterModulesPdrV2Rscore= toreal(filter_data.modules.pdr.v2.rscore),\n\t\t        FilterOrigGuid= tostring(filter_data.origGuid),\n\t\t        MsgNormalizedHeaderCc= tostring(msg_data.normalizedHeader.[\"cc\"]),\n\t\t        MsgNormalizedHeaderCcHashed=tostring(msg_data.normalizedHeader.[\"ccHashed\"]),\n\t\t        MsgParsedAddressesCcHashed=tostring(msg_data.parsedAddresses.[\"ccHashed\"]),\n\t\t        MsgParsedAddressesCc= tostring(msg_data.parsedAddresses.[\"cc\"]),\n\t\t        MsgHeaderCcHashed= tostring(msg_data.header.[\"ccHashed\"]),\n\t\t        MsgHeaderCc= tostring(msg_data.header.[\"cc\"]),\n\t\t        FilterModulesAvVirusNames= tostring(filter_data.modules.av.virusNames),\n\t\t        FilterThrottleIp=tostring(filter_data.throttleIp),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme= toreal(filter_data.modules.urldefense.counts.noRewriteIsUnsupportedScheme),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless= toreal(filter_data.modules.urldefense.counts.noRewriteIsSchemeless),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded= tostring(filter_data.modules.urldefense.counts.noRewriteIsMaxLengthExceeded),\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain= toreal(filter_data.modules.urldefense.counts.noRewriteIsExcludedDomain),\n                PpsAgent= tostring(pps_data.version),\n                EventOriginalTime=column_ifexists('eventTime', ''),\n                TlsCipher= tostring(connection_data.tls.inbound.cipher),\n                TlsCipherBits= toreal(connection_data.tls.inbound.cipherBits),\n                TlsVersion= tostring(connection_data.tls.inbound.version),\n                SrcIpAddr= tostring(connection_data.ip),\n                NetworkSessionId= tostring(connection_data.sid),\n                SrcDvcHostname= tostring(connection_data.host),\n                SrcGeoCountry= tostring(connection_data.country),\n                NetworkProtocol= tostring(connection_data.protocol),\n                NetworkConnectionState= tostring(connection_data.resolveStatus),\n                NetworkBytes=toreal(msg_data.sizeBytes),\n                NetworkDuration= tostring(filter_data.durationSecs),\n              //  EventStartTime= column_ifexists('filter_startTime_t', ''),\n                NetworkDirection= tostring(filter_data.routeDirection),\n                DstUserUpn= tostring(envelope_data.[\"rcpts\"]),\n                SrcUserUpn= tostring(envelope_data.from),\n                EventType= \"message\",\n                EventVendor=\"Proofpoint\",\n                EventProduct=\"Proofpoint On Demand Email Security\"\n    | project\n                TimeGenerated, \n                EventVendor,\n                EventProduct,\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\n                PpsVersion,\n                PpsCid,\n                MsgParts,\n                MetadataOriginDataAgent,\n                MetadataOriginDataVersion,\n                MetadataOriginDataCid,\n                ConnectionHelo,\n                MsgLang,\n                MsgNormalizedHeaderSubject,\n                MsgNormalizedHeaderMessageId,\n                MsgNormalizedHeaderTo,\n                MsgNormalizedHeadertoHashed,\n                MsgNormalizedHeaderFrom,\n                MsgNormalizedHeaderFromHashed,\n                MsgHeaderFrom,\n                MsgHeaderFromHashed,\n                MsgHeaderMessageId,\n                MsgHeaderSubject,\n                MsgHeaderTo,\n                MsgHeaderToHashed,\n                MsgParsedAddressesFromHashed,\n                MsgParsedAddressesFrom,\n                MsgParsedAddressesToHashed,\n                MsgParsedAddressesTo,\n                FilterActions,\n                FilterRoutes,\n                FilterQid,\n                FilterIsMsgEncrypted,\n                FilterIsMsgReinjected,\n                FilterQuarantineRule,\n                FilterQuarantineFolder,\n                FilterModulesDmarcSrvid,\n                FilterModulesDmarcRecords,\n                FilterModulesDmarcFilterdResult,\n                FilterModulesDmarcAuthResults,\n                FilterModulesSpfDomain,\n                FilterModulesSpfResult,\n                FilterModulesSpamTriggeredClassifier,\n                FilterModulesSpamSafeBlockedListMatches,\n                FilterModulesSpamVersionEngine,\n                FilterModulesSpamVersionDefinitions,\n                FilterModulesSpamScoresOverall,\n                FilterModulesSpamScoresEngine,\n                FilterModulesSpamScoresClassifiers,\n                FilterModulesSpamLangs,\n                FilterModulesUrldefenseVersionEngine,\n                FilterModulesUrldefenseCountsUnique,\n                FilterModulesUrldefenseCountsRewritten,\n                FilterModulesUrldefenseCountsTotal,\n                FilterModulesDkimv,\n                FilterModulesPdrV2Response,\n                FilterModulesZerohourScore,\n                FilterDisposition,\n                FilterSuborgsRcpts,\n                FilterSuborgsSender,\n                FilterMsgSizeBytes,\n                FilterVerifiedRcptsHashed,\n                FilterVerifiedRcpts,\n                Guid,\n                EnvelopeRcptsHashed,\n                EnvelopeFromHashed,\n                MsgNormalizedHeaderReturnPathHashed,\n                MsgNormalizedHeaderXMailer,\n                MsgNormalizedHeaderReturnPath,\n                MsgHeaderXMailer,\n                MsgHeaderReturnPathHashed,\n                MsgHeaderReturnPath,\n                FilterModulesSpamCharsets,\n                FilterModulesDmarcAlignment,\n                MsgNormalizedHeaderXOriginatingIp,\n                MsgHeaderXOriginatingIp,\n                MsgNormalizedHeaderReplyTo,\n                MsgNormalizedHeaderReplyToHashed,\n                MsgHeaderReplyToHashed,\n                MsgHeaderReplyTo,\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\n                FilterModulesPdrV2Rscore,\n                FilterOrigGuid,\n                MsgNormalizedHeaderCc,\n                MsgNormalizedHeaderCcHashed,\n                MsgParsedAddressesCcHashed,\n                MsgParsedAddressesCc,\n                MsgHeaderCcHashed,\n                MsgHeaderCc,\n                FilterModulesAvVirusNames,\n                FilterThrottleIp,\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\n                PpsAgent,\n                SrcDvcHostname,\n                EventOriginalTime,\n                TlsCipher,\n                TlsCipherBits,\n                TlsVersion,\n                SrcIpAddr,\n                NetworkSessionId,\n                SrcGeoCountry,\n                NetworkProtocol,\n                NetworkConnectionState,\n                NetworkBytes,\n                NetworkDuration,\n              //  EventStartTime,\n                NetworkDirection,\n                DstUserUpn,\n                SrcUserUpn,\n                EventType\n    | join kind=inner  (\n\t\tProofpointPODMessage_CL\n        | project Guid = column_ifexists('guid', ''), MsgParts=column_ifexists('msgParts', '')\n\t\t| extend d = parse_json(MsgParts)\n        | mv-expand d\n        | extend URL_LIST = parse_json(d.urls)\n        | mv-expand URL_LIST\n        | extend URLLIST = tostring(URL_LIST.url)\n\t\t| summarize make_set(URLLIST) by Guid\n        )\n        on Guid\n    | project-away Guid1\n    | project-rename Urls = set_URLLIST\n};\nunion isfuzzy=true ProofpointPOD_message_view, ProofpointPOD_maillog_view, ProofpointPOD_maillogV2_view, ProofpointPOD_messageV2_view\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
      "dependsOn": [
        "[variables('parserObject1')._parserId1]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'ProofpointPOD')]",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "kind": "Parser",
        "version": "[variables('parserObject1').parserVersion1]",
        "source": {
          "kind": "Solution",
          "name": "Proofpoint On demand(POD) Email Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Proofpoint, Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Partner",
          "name": "Proofpoint, Inc.",
          "email": "azure-support@proofpoint.com",
          "link": "https://proofpoint.my.site.com/community/s/"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject1').huntingQueryTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreAdultValue_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject1').huntingQueryVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'adult' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).adult > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'adult' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 1",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject1')._huntingQuerycontentId1)]",
                "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject1').huntingQueryVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Emails with high score of 'adult' filter classifier value",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject1')._huntingQuerycontentId1,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject2').huntingQueryTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreMalwareValue_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject2').huntingQueryVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'malware' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).malware > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'malware' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 2",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject2')._huntingQuerycontentId2)]",
                "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject2').huntingQueryVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Emails with high score of 'malware' filter classifier value",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject2')._huntingQuerycontentId2,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject3').huntingQueryTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScorePhishValue_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject3').huntingQueryVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'phish' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).phish > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'phish' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 3",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject3')._huntingQuerycontentId3)]",
                "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject3').huntingQueryVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Emails with high score of 'phish' filter classifier value",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject3')._huntingQuerycontentId3,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject4').huntingQueryTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreSpamValue_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject4').huntingQueryVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'spam' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).spam > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'spam' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 4",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject4')._huntingQuerycontentId4)]",
                "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject4').huntingQueryVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Emails with high score of 'spam' filter classifier value",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject4')._huntingQuerycontentId4,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject5').huntingQueryTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreSuspectValue_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject5').huntingQueryVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'suspect' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).suspect > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'suspect' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 5",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject5')._huntingQuerycontentId5)]",
                "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject5').huntingQueryVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Emails with high score of 'suspect' filter classifier value",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject5')._huntingQuerycontentId5,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject6').huntingQueryTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODLargeOutboundEmails_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject6').huntingQueryVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Large size outbound emails",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nlet lookback = starttime - 14d;\nlet out_msg = ProofpointPOD\n| where TimeGenerated between (lookback..starttime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != '';\nProofpointPOD\n| where TimeGenerated between(starttime..endtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != ''\n| summarize AvgMsgSize = toint(avg(NetworkBytes)) by SrcUserUpn\n| join out_msg on SrcUserUpn\n| where NetworkBytes > AvgMsgSize*2\n| project SrcUserUpn, AvgMsgSize, NetworkBytes\n| extend AccountCustomEntity = SrcUserUpn\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails which size is 2 times grater than average size of outbound email for user."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 6",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject6')._huntingQuerycontentId6)]",
                "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject6').huntingQueryVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Large size outbound emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject6')._huntingQuerycontentId6,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject7').huntingQueryTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODRecipientsHighNumberDiscardReject_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject7').huntingQueryVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Recipients with high number of discarded or rejected emails",
                "category": "Hunting Queries",
                "query": "let threshold = 10;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| summarize count() by DstUserUpn\n| where count_ > threshold\n| extend AccountCustomEntity = DstUserUpn\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for recipients with high number of discarded or rejected emails."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 7",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject7')._huntingQuerycontentId7)]",
                "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject7').huntingQueryVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Recipients with high number of discarded or rejected emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject7')._huntingQuerycontentId7,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject8').huntingQueryTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODRecipientsLargeNumberOfCorruptedEmails_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject8').huntingQueryVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Recipients with large number of corrupted emails",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| extend isCorrupted = todynamic(MsgParts)[0]['isCorrupted']\n| where isCorrupted == 'true'\n| summarize count() by DstUserUpn\n| sort by count_\n| where count_ > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for recipients with large number of corrupted emails."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 8",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject8')._huntingQuerycontentId8)]",
                "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject8').huntingQueryVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Recipients with large number of corrupted emails",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject8')._huntingQuerycontentId8,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject9').huntingQueryTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODSendersLargeNumberOfCorruptedEmails_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject9').huntingQueryVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Senders with large number of corrupted messages",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend isCorrupted = todynamic(MsgParts)[0]['isCorrupted']\n| where isCorrupted == 'true'\n| summarize count() by SrcUserUpn\n| sort by count_\n| where count_ > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for senders with large number of corrupted messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 9",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject9')._huntingQuerycontentId9)]",
                "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject9').huntingQueryVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Senders with large number of corrupted messages",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject9')._huntingQuerycontentId9,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('huntingQueryObject10').huntingQueryTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODSuspiciousFileTypesInAttachments_HuntingQueries Hunting Query with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryObject10').huntingQueryVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2022-10-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Suspicious file types in attachments",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| extend attachedFileType = todynamic(MsgParts)[0]['detectedExt']\n| summarize count() by tostring(attachedFileType)\n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Hunting for suspicious file types in attachments."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 10",
                "parentId": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('huntingQueryObject10')._huntingQuerycontentId10)]",
                "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryObject10').huntingQueryVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
        "contentKind": "HuntingQuery",
        "displayName": "ProofpointPOD - Suspicious file types in attachments",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','hq','-', uniqueString(concat(variables('_solutionId'),'-','HuntingQuery','-',variables('huntingQueryObject10')._huntingQuerycontentId10,'-', '1.0.0')))]",
        "version": "1.0.0"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODBinaryInAttachment_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email received with binary file as attachment.",
                "displayName": "ProofpointPOD - Binary file in attachment",
                "enabled": false,
                "query": "let lbtime = 10m;\nlet binaryTypes = dynamic(['zip', 'octet-stream', 'java-archive', 'rar', 'tar', 'x-7z-compressed', 'x-msdownload', 'portable-executable']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| extend attachedMimeType = tostring(todynamic(MsgParts)[0]['detectedMime'])\n| where attachedMimeType has_any (binaryTypes)\n| project SrcUserUpn, AccountCustomEntity = tostring(parse_json(DstUserUpn)[0]), attachedMimeType, MsgHeaderSubject\n| extend Name = tostring(split(AccountCustomEntity, \"@\")[0]), UPNSuffix = tostring(split(AccountCustomEntity, \"@\")[1])\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "Name",
                        "identifier": "Name"
                      },
                      {
                        "columnName": "UPNSuffix",
                        "identifier": "UPNSuffix"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Binary file in attachment",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODDataExfiltrationToPrivateEmail_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when sender sent email to the non-corporate domain and recipient's username is the same as sender's username.",
                "displayName": "ProofpointPOD - Possible data exfiltration to private email",
                "enabled": false,
                "query": "let lbtime = 10m;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where array_length(todynamic(DstUserUpn)) == 1\n| extend sender = extract(@'\\A(.*?)@', 1, SrcUserUpn)\n| extend sender_domain = extract(@'@(.*)$', 1, SrcUserUpn)\n| extend recipient = extract(@'\\A(.*?)@', 1, tostring(todynamic(DstUserUpn)[0]))\n| extend recipient_domain = extract(@'@(.*)$', 1, tostring(todynamic(DstUserUpn)[0]))\n| where sender =~ recipient\n| where sender_domain != recipient_domain\n| project SrcUserUpn, DstUserUpn\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Possible data exfiltration to private email",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighRiskNotDiscarded_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email with high risk score was not rejected or discarded by filters.",
                "displayName": "ProofpointPOD - High risk message not discarded",
                "enabled": false,
                "query": "let lbtime = 10m;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| where FilterModulesSpamScoresOverall == '100'\n| project SrcUserUpn, DstUserUpn\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1566"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - High risk message not discarded",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleArchivedAttachmentsToSameRecipient_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple emails where sent to the same recipient with large archived attachments.",
                "displayName": "ProofpointPOD - Multiple archived attachments to the same recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet msgthreshold = 3;\nlet compressedTypes = dynamic(['zip', 'rar', 'tar', 'x-7z-compressed']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend attachedMimeType = todynamic(MsgParts)[0]['detectedMime']\n| where attachedMimeType has_any (compressedTypes)\n| summarize count(), make_set(attachedMimeType) by SrcUserUpn, DstUserUpn\n| where count_ > msgthreshold\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "techniques": [
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Multiple archived attachments to the same recipient",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleLargeEmailsToSameRecipient_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple emails with large size where sent to the same recipient.",
                "displayName": "ProofpointPOD - Multiple large emails to the same recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet msgthreshold = 3;\nlet msgszthreshold = 3000000;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where NetworkBytes > msgszthreshold\n| summarize count() by SrcUserUpn, DstUserUpn\n| where count_ > msgthreshold\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "techniques": [
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Multiple large emails to the same recipient",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleProtectedEmailsToUnknownRecipient_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple protected messages where sent to early not seen recipient.",
                "displayName": "ProofpointPOD - Multiple protected emails to unknown recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet lbperiod = 14d;\nlet knownrecipients = ProofpointPOD\n| where TimeGenerated > ago(lbperiod)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != ''\n| where array_length(todynamic(DstUserUpn)) == 1\n| summarize recipients = make_set(tostring(todynamic(DstUserUpn)[0])) by SrcUserUpn\n| extend commcol = SrcUserUpn;\nProofpointPOD\n| where TimeGenerated between (ago(lbtime) .. now())\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend isProtected = todynamic(MsgParts)[0]['isProtected']\n| extend mimePgp = todynamic(MsgParts)[0]['detectedMime']\n| where isProtected == 'true' or mimePgp == 'application/pgp-encrypted'\n| extend DstUserMail = tostring(todynamic(DstUserUpn)[0])\n| extend commcol = tostring(todynamic(DstUserUpn)[0])\n| join knownrecipients on commcol\n| where recipients !contains DstUserMail\n| project SrcUserUpn, DstUserMail\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "techniques": [
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 6",
                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Multiple protected emails to unknown recipient",
        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODSuspiciousAttachment_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email contains suspicious attachment (file type).",
                "displayName": "ProofpointPOD - Suspicious attachment",
                "enabled": false,
                "query": "let lbtime = 10m;\nlet disallowed_ext = dynamic(['ps1', 'exe', 'vbs', 'js', 'scr']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| extend attachedExt = todynamic(MsgParts)[0]['detectedExt']\n| where tolower(attachedExt) in (disallowed_ext)\n| project SrcUserUpn, AccountCustomEntity = parse_json(DstUserUpn)[0], attachedExt\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "techniques": [
                  "T1566"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "AccountCustomEntity",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 7",
                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Suspicious attachment",
        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODWeakCiphers_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when weak TLS ciphers are used.",
                "displayName": "ProofpointPOD - Weak ciphers",
                "enabled": false,
                "query": "let lbtime = 1h;\nlet tls_ciphers = dynamic(['RC4-SHA', 'DES-CBC3-SHA']);\nProofpointPOD\n| where EventType == 'message'\n| where TlsCipher in (tls_ciphers)\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "CommandAndControl"
                ],
                "techniques": [
                  "T1573"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "IPCustomEntity",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 8",
                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Weak ciphers",
        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODEmailSenderInTIList_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Email sender in TI list.",
                "displayName": "ProofpointPOD - Email sender in TI list",
                "enabled": false,
                "query": "let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where Active == true\n| where isnotempty(EmailSenderAddress)\n| extend TI_emailEntity = EmailSenderAddress\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n       ProofpointPOD\n       | where TimeGenerated >= ago(dt_lookBack)\n       | where isnotempty(SrcUserUpn)\n       | extend ProofpointPOD_TimeGenerated = TimeGenerated, ClientEmail = SrcUserUpn\n)\non $left.TI_emailEntity == $right.ClientEmail\n| where ProofpointPOD_TimeGenerated < ExpirationDateTime\n| summarize ProofpointPOD_TimeGenerated = arg_max(ProofpointPOD_TimeGenerated, *) by IndicatorId, ClientEmail\n| project ProofpointPOD_TimeGenerated, Description, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore, ClientEmail\n| extend timestamp = ProofpointPOD_TimeGenerated\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ThreatIntelligenceIndicator"
                    ],
                    "connectorId": "ThreatIntelligence"
                  },
                  {
                    "dataTypes": [
                      "ThreatIntelligenceIndicator"
                    ],
                    "connectorId": "ThreatIntelligenceTaxii"
                  },
                  {
                    "dataTypes": [
                      "ProofpointPOD_maillog_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration",
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078",
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ClientEmail",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 9",
                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Email sender in TI list",
        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ProofpointPODEmailSenderIPinTIList_AnalyticalRules Analytics Rule with template version 3.1.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Email sender IP in TI list.",
                "displayName": "ProofpointPOD - Email sender IP in TI list",
                "enabled": false,
                "query": "let dt_lookBack = 1h;\nlet ioc_lookBack = 14d;\nThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| where isnotempty(NetworkIP) or isnotempty(EmailSourceIpAddress) or isnotempty(NetworkDestinationIP) or isnotempty(NetworkSourceIP)\n| extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)\n| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)\n| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| where Active == true\n// using innerunique to keep perf fast and result set low, we only need one match to indicate potential malicious activity that needs to be investigated\n| join kind=innerunique (\n          ProofpointPOD \n          | where TimeGenerated >= ago(dt_lookBack)\n          | where isnotempty(SrcIpAddr)\n          | extend ProofpointPOD_TimeGenerated = TimeGenerated, ClientIP = SrcIpAddr\n  )\non $left.TI_ipEntity == $right.ClientIP\n| where ProofpointPOD_TimeGenerated < ExpirationDateTime\n| summarize ProofpointPOD_TimeGenerated = arg_max(ProofpointPOD_TimeGenerated, *) by IndicatorId, ClientIP\n| project ProofpointPOD_TimeGenerated, SrcUserUpn, DstUserUpn, SrcIpAddr, IndicatorId, ThreatType, ExpirationDateTime, ConfidenceScore,\nTI_ipEntity, ClientIP\n| extend timestamp = ProofpointPOD_TimeGenerated\n",
                "queryFrequency": "P1D",
                "queryPeriod": "P14D",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ThreatIntelligenceIndicator"
                    ],
                    "connectorId": "ThreatIntelligence"
                  },
                  {
                    "dataTypes": [
                      "ThreatIntelligenceIndicator"
                    ],
                    "connectorId": "ThreatIntelligenceTaxii"
                  },
                  {
                    "dataTypes": [
                      "ProofpointPOD_maillog_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration",
                  "InitialAccess"
                ],
                "techniques": [
                  "T1078",
                  "T1567"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "columnName": "SrcUserUpn",
                        "identifier": "FullName"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "columnName": "ClientIP",
                        "identifier": "Address"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 10",
                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
        "contentKind": "AnalyticsRule",
        "displayName": "ProofpointPOD - Email sender IP in TI list",
        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Proofpoint On Demand Email Security (via Codeless Connector Platform)",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "ProofpointCCPDefinition",
                  "title": "Proofpoint On Demand Email Security (via Codeless Connector Platform)",
                  "publisher": "Proofpoint",
                  "descriptionMarkdown": "Proofpoint On Demand Email Security data connector provides the capability to get Proofpoint on Demand Email Protection data, allows users to check message traceability, monitoring into email activity, threats,and data exfiltration by attackers and malicious insiders. The connector provides ability to review events in your org on an accelerated basis, get event log files in hourly increments for recent activity.",
                  "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **ProofpointPOD** in queries and workbooks [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-proofpointpod-parser)",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "ProofpointPODMailLog_CL",
                      "baseQuery": "ProofpointPODMailLog_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "ProofpointPODMessage_CL",
                      "baseQuery": "ProofpointPODMessage_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Last ProofpointPOD message Events",
                      "query": "ProofpointPODMessage_CL\n | where EventType == 'message'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "Last ProofpointPOD maillog Events",
                      "query": "ProofpointPODMailLog_CL\n | where EventType == 'maillog'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "ProofpointPODMailLog_CL",
                      "lastDataReceivedQuery": "ProofpointPODMailLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "ProofpointPODMessage_CL",
                      "lastDataReceivedQuery": "ProofpointPODMessage_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors",
                      "value": null
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": true,
                          "write": true,
                          "delete": true,
                          "action": false
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Websocket API Credentials/permissions",
                        "description": "**ProofpointClusterID**, and **ProofpointToken** are required. [See the documentation to learn more about API](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API)."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### Configuration steps for the Proofpoint POD Websocket API \n ####  The PoD Log API does not allow use of the same token for more than one session at the same time, so make sure your token isn't used anywhere. \n Proofpoint Websocket API service requires Remote Syslog Forwarding license. Please refer the [documentation](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API) on how to enable and check PoD Log API. \n You must provide your cluster id and security token."
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### 1. Retrieve the cluster id\n   1.1. Log in to the [proofpoint](https://admin.proofpoint.com/) [**Management Console**] with Admin user credentials\n\n   1.2. In the **Management Console**, the cluster id is displayed in the upper-right corner."
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### 2. Retrieve the API token\n   2.1. Log in to the [proofpoint](https://admin.proofpoint.com/) [**Management Console**] with Admin user credentials\n\n  2.2. In the **Management Console**, click **Settings** -> **API Key Management** \n\n  2.3. Under **API Key Management** click on the **PoD Logging** tab.\n\n   2.4. Get or create a new API key."
                          }
                        },
                        {
                          "parameters": {
                            "label": "Cluster Id",
                            "placeholder": "cluster_id",
                            "type": "text",
                            "name": "clusterId"
                          },
                          "type": "Textbox"
                        },
                        {
                          "parameters": {
                            "label": "API Key",
                            "placeholder": "API Key",
                            "type": "text",
                            "name": "apiKey"
                          },
                          "type": "Textbox"
                        },
                        {
                          "parameters": {
                            "label": "toggle",
                            "name": "toggle"
                          },
                          "type": "ConnectionToggleButton"
                        }
                      ],
                      "innerSteps": null
                    }
                  ],
                  "isConnectivityCriteriasMatchSome": false
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "ProofpointPodDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-ProofpointPodMessage": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "guid",
                        "type": "string"
                      },
                      {
                        "name": "ts",
                        "type": "string"
                      },
                      {
                        "name": "connection",
                        "type": "dynamic"
                      },
                      {
                        "name": "envelope",
                        "type": "dynamic"
                      },
                      {
                        "name": "msg",
                        "type": "dynamic"
                      },
                      {
                        "name": "pps",
                        "type": "dynamic"
                      },
                      {
                        "name": "metadata",
                        "type": "dynamic"
                      },
                      {
                        "name": "filter",
                        "type": "dynamic"
                      },
                      {
                        "name": "msgParts",
                        "type": "dynamic"
                      }
                    ]
                  },
                  "Custom-ProofpointPodMailLog": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "id",
                        "type": "string"
                      },
                      {
                        "name": "data",
                        "type": "string"
                      },
                      {
                        "name": "ts",
                        "type": "string"
                      },
                      {
                        "name": "metadata",
                        "type": "dynamic"
                      },
                      {
                        "name": "pps",
                        "type": "dynamic"
                      },
                      {
                        "name": "sm",
                        "type": "dynamic"
                      },
                      {
                        "name": "tls",
                        "type": "dynamic"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-ProofpointPodMessage"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = now() | project TimeGenerated, connection, eventTime = todatetime(ts), envelope, pps, msg, guid, metadata, ['filter'] = ['filter'], msgParts",
                    "outputStream": "Custom-ProofpointPODMessage_CL"
                  },
                  {
                    "streams": [
                      "Custom-ProofpointPodMailLog"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = now() | project TimeGenerated, eventTime = todatetime(ts), data, id, pps, metadata, sm, tls",
                    "outputStream": "Custom-ProofpointPODMailLog_CL"
                  }
                ],
                "dataCollectionEndpointId": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]"
              }
            },
            {
              "name": "ProofpointPODMailLog_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "ProofpointPODMailLog_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "id",
                      "type": "string"
                    },
                    {
                      "name": "data",
                      "type": "string"
                    },
                    {
                      "name": "eventTime",
                      "type": "datetime"
                    },
                    {
                      "name": "metadata",
                      "type": "dynamic"
                    },
                    {
                      "name": "pps",
                      "type": "dynamic"
                    },
                    {
                      "name": "sm",
                      "type": "dynamic"
                    },
                    {
                      "name": "tls",
                      "type": "dynamic"
                    }
                  ]
                }
              }
            },
            {
              "name": "ProofpointPODMessage_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "ProofpointPODMessage_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "guid",
                      "type": "string"
                    },
                    {
                      "name": "eventTime",
                      "type": "datetime"
                    },
                    {
                      "name": "connection",
                      "type": "dynamic"
                    },
                    {
                      "name": "envelope",
                      "type": "dynamic"
                    },
                    {
                      "name": "msg",
                      "type": "dynamic"
                    },
                    {
                      "name": "pps",
                      "type": "dynamic"
                    },
                    {
                      "name": "metadata",
                      "type": "dynamic"
                    },
                    {
                      "name": "filter",
                      "type": "dynamic"
                    },
                    {
                      "name": "msgParts",
                      "type": "dynamic"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "ProofpointCCPDefinition",
          "title": "Proofpoint On Demand Email Security (via Codeless Connector Platform)",
          "publisher": "Proofpoint",
          "descriptionMarkdown": "Proofpoint On Demand Email Security data connector provides the capability to get Proofpoint on Demand Email Protection data, allows users to check message traceability, monitoring into email activity, threats,and data exfiltration by attackers and malicious insiders. The connector provides ability to review events in your org on an accelerated basis, get event log files in hourly increments for recent activity.",
          "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. Follow the steps to use this Kusto functions alias **ProofpointPOD** in queries and workbooks [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-proofpointpod-parser)",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "ProofpointPODMailLog_CL",
              "baseQuery": "ProofpointPODMailLog_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "ProofpointPODMessage_CL",
              "baseQuery": "ProofpointPODMessage_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Last ProofpointPOD message Events",
              "query": "ProofpointPODMessage_CL\n | where EventType == 'message'\n | sort by TimeGenerated desc"
            },
            {
              "description": "Last ProofpointPOD maillog Events",
              "query": "ProofpointPODMailLog_CL\n | where EventType == 'maillog'\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "ProofpointPODMailLog_CL",
              "lastDataReceivedQuery": "ProofpointPODMailLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "ProofpointPODMessage_CL",
              "lastDataReceivedQuery": "ProofpointPODMessage_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors",
              "value": null
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true,
                  "action": false
                }
              }
            ],
            "customs": [
              {
                "name": "Websocket API Credentials/permissions",
                "description": "**ProofpointClusterID**, and **ProofpointToken** are required. [See the documentation to learn more about API](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API)."
              }
            ]
          },
          "instructionSteps": [
            {
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### Configuration steps for the Proofpoint POD Websocket API \n ####  The PoD Log API does not allow use of the same token for more than one session at the same time, so make sure your token isn't used anywhere. \n Proofpoint Websocket API service requires Remote Syslog Forwarding license. Please refer the [documentation](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API) on how to enable and check PoD Log API. \n You must provide your cluster id and security token."
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### 1. Retrieve the cluster id\n   1.1. Log in to the [proofpoint](https://admin.proofpoint.com/) [**Management Console**] with Admin user credentials\n\n   1.2. In the **Management Console**, the cluster id is displayed in the upper-right corner."
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### 2. Retrieve the API token\n   2.1. Log in to the [proofpoint](https://admin.proofpoint.com/) [**Management Console**] with Admin user credentials\n\n  2.2. In the **Management Console**, click **Settings** -> **API Key Management** \n\n  2.3. Under **API Key Management** click on the **PoD Logging** tab.\n\n   2.4. Get or create a new API key."
                  }
                },
                {
                  "parameters": {
                    "label": "Cluster Id",
                    "placeholder": "cluster_id",
                    "type": "text",
                    "name": "clusterId"
                  },
                  "type": "Textbox"
                },
                {
                  "parameters": {
                    "label": "API Key",
                    "placeholder": "API Key",
                    "type": "text",
                    "name": "apiKey"
                  },
                  "type": "Textbox"
                },
                {
                  "parameters": {
                    "label": "toggle",
                    "name": "toggle"
                  },
                  "type": "ConnectionToggleButton"
                }
              ],
              "innerSteps": null
            }
          ],
          "isConnectivityCriteriasMatchSome": false
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Proofpoint, Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Partner",
          "name": "Proofpoint, Inc.",
          "email": "azure-support@proofpoint.com",
          "link": "https://proofpoint.my.site.com/community/s/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Proofpoint On Demand Email Security (via Codeless Connector Platform)",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "Proofpoint On Demand Email Security (via Codeless Connector Platform)",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "clusterId": {
              "defaultValue": "clusterId",
              "type": "securestring",
              "minLength": 1
            },
            "apiKey": {
              "defaultValue": "apiKey",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Proofpoint, Inc.",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Partner",
                  "name": "Proofpoint, Inc.",
                  "email": "azure-support@proofpoint.com",
                  "link": "https://proofpoint.my.site.com/community/s/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'ProofpointPodMessageConnection', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "WebSocket",
              "properties": {
                "connectorDefinitionName": "ProofpointCCPDefinition",
                "dataType": "ProofpointPODMessage_CL",
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apiKey')]",
                  "apiKeyName": "Authorization",
                  "apiKeyIdentifier": "Bearer"
                },
                "request": {
                  "httpMethod": "Get",
                  "apiEndpoint": "wss://logstream.proofpoint.com:443/v1/stream",
                  "queryParameters": {
                    "cid": "[[parameters('clusterId')]",
                    "type": "message"
                  },
                  "rateLimitQPS": 20,
                  "queryWindowInMin": 5,
                  "retryCount": 2,
                  "logResponseContent": true
                },
                "response": {
                  "eventsJsonPaths": [
                    "$"
                  ]
                },
                "dcrConfig": {
                  "streamName": "Custom-ProofpointPodMessage",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'ProofpointPodMailLogConnection', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "WebSocket",
              "properties": {
                "connectorDefinitionName": "ProofpointCCPDefinition",
                "dataType": "ProofpointPODMailLog_CL",
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apiKey')]",
                  "apiKeyName": "Authorization",
                  "apiKeyIdentifier": "Bearer"
                },
                "request": {
                  "httpMethod": "Get",
                  "apiEndpoint": "wss://logstream.proofpoint.com:443/v1/stream",
                  "queryParameters": {
                    "cid": "[[parameters('clusterId')]",
                    "type": "maillog"
                  },
                  "rateLimitQPS": 20,
                  "queryWindowInMin": 5,
                  "retryCount": 2,
                  "logResponseContent": true
                },
                "response": {
                  "eventsJsonPaths": [
                    "$"
                  ]
                },
                "dcrConfig": {
                  "streamName": "Custom-ProofpointPodMailLog",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.1.2",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Proofpoint On demand(POD) Email Security",
        "publisherDisplayName": "Proofpoint, Inc.",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Proofpoint%20On%20demand%28POD%29%20Email%20Security/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://www.proofpoint.com/us/products/email-security-and-protection/email-protection\">Proofpoint on Demand Email Security</a> solution for Microsoft Sentinel enables you to ingest Proofpoint on Demand Email Protection data and activity logs for monitoring email activity, events and threats in your organization.</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<p> <a href=\"https://aka.ms/Sentinel-CCP_Platform\">Microsoft Sentinel Codeless Connector Framework</a></p>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 10, <strong>Hunting Queries:</strong> 10</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/PFPTLogo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Proofpoint On demand(POD) Email Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Proofpoint, Inc.",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Proofpoint, Inc.",
          "email": "azure-support@proofpoint.com",
          "tier": "Partner",
          "link": "https://proofpoint.my.site.com/community/s/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('parserObject1').parserContentId1]",
              "version": "[variables('parserObject1').parserVersion1]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject1')._huntingQuerycontentId1]",
              "version": "[variables('huntingQueryObject1').huntingQueryVersion1]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject2')._huntingQuerycontentId2]",
              "version": "[variables('huntingQueryObject2').huntingQueryVersion2]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject3')._huntingQuerycontentId3]",
              "version": "[variables('huntingQueryObject3').huntingQueryVersion3]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject4')._huntingQuerycontentId4]",
              "version": "[variables('huntingQueryObject4').huntingQueryVersion4]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject5')._huntingQuerycontentId5]",
              "version": "[variables('huntingQueryObject5').huntingQueryVersion5]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject6')._huntingQuerycontentId6]",
              "version": "[variables('huntingQueryObject6').huntingQueryVersion6]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject7')._huntingQuerycontentId7]",
              "version": "[variables('huntingQueryObject7').huntingQueryVersion7]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject8')._huntingQuerycontentId8]",
              "version": "[variables('huntingQueryObject8').huntingQueryVersion8]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject9')._huntingQuerycontentId9]",
              "version": "[variables('huntingQueryObject9').huntingQueryVersion9]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('huntingQueryObject10')._huntingQuerycontentId10]",
              "version": "[variables('huntingQueryObject10').huntingQueryVersion10]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2021-03-31",
        "providers": [
          "Proofpoint"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
