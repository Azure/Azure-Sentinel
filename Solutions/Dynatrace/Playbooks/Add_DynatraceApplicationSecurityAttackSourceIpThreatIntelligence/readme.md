# Add_DynatraceApplicationSecurityAttackSourceIpThreatIntelligence
author: Dynatrace

This playbook uses the Dynatrace REST APIs to automatically add an attackers source IP address to Microsoft Threat Intelligence when an alert is generated by Microsoft Sentinel. You need a valid Dynatrace tenant with [Application Security](https://www.dynatrace.com/platform/application-security/) enabled. To learn more about the Dynatrace platform [Start your free trial](https://www.dynatrace.com/trial)

** Prerequisites ** 
- Follow [these instructions](https://docs.dynatrace.com/docs/shortlink/token#create-api-tokenynatrace) access token, the token should have Read attacks (attacks.read) scope.
- [Important step]Store the Dynatrace Access Token as a [secret in Azure Key vault](https://learn.microsoft.com/en-us/azure/key-vault/secrets/quick-create-portal) and provide the key vault name during playbook deployment, by convention the secret name should be 'DynatraceAccessToken'.

** Post Install Notes:**

The Logic App uses a Managed System Identity (MSI) to read the Microsoft Sentinel Incident. 

Assign RBAC 'Microsoft Sentinel Reader' role to the Logic App at the Resource Group level of the Log Analytics Workspace.

Assign access policy on key vault for Playbook to fetch the secret key

To create new Threat Indicators for Microsoft Threat Intelligence we leverage the Microsoft Graph Security connector, please ensure you meet the prerequisites to connect with The [Microsoft Graph Security connector](https://learn.microsoft.com/en-us/connectors/microsoftgraphsecurity/#prerequisites-to-connect-with-the-microsoft-graph-security-connector)

Basic steps for the Microsoft Graph Security connector permissions are as follows :

1. Perform role assignment for the playbook managed indentity, assign the ThreatIndicators.ReadWrite.OwnedBy permission  

    # Install the AzureAD PowerShell module
    # Install-Module AzureAD
    $TenantID="[YOUR AZURE ACTIVE DIRECTORY TENANT ID]"
    $GraphAppId = "00000003-0000-0000-c000-000000000000"
    $DisplayNameOfMSI="[PLAYBOOK IDENTITY NAME]"
    $PermissionName = "ThreatIndicators.ReadWrite.OwnedBy"
    Connect-AzureAD -TenantId $TenantID
    $MSI = (Get-AzureADServicePrincipal -Filter "displayName eq '$DisplayNameOfMSI'")
    Start-Sleep -Seconds 10
    $GraphServicePrincipal = Get-AzureADServicePrincipal -Filter "appId eq '$GraphAppId'"
    $AppRole = $GraphServicePrincipal.AppRoles | Where-Object {$_.Value -eq $PermissionName -and $_.AllowedMemberTypes -contains "Application"}
    New-AzureAdServiceAppRoleAssignment -ObjectId $MSI.ObjectId -PrincipalId $MSI.ObjectId -ResourceId $GraphServicePrincipal.ObjectId -Id $AppRole.Id

2. Grant Admin Consent for MicrosoftGraphSecurityConnector application
2.1 Navigate to 'https://login.microsoftonline.com/[YOUR AZURE ACTIVE DIRECTORY TENANT ID]/adminconsent?client_id=c4829704-0edc-4c3d-a347-7c4a67586f3c'
2.2 Accept the requested permissions


## Initial Setup

A Microsoft Sentinel playbook is utilized by automation rules, therefore to automatically trigger this playbook you must setup a new automation rule. If you have not set permissions yet, [review here](https://docs.microsoft.com/azure/sentinel/automate-incident-handling-with-automation-rules#permissions-for-automation-rules-to-run-playbooks)

Basic steps for setup of the playbook and automation rule are as follows :

1. Go to the Automation blade in Microsoft Sentinel.
2. Create a new playbook from the 'Add Dynatrace Application Security Attack Source IP Address to Threat Intelligence' [playbook template](https://learn.microsoft.com/en-us/azure/sentinel/use-playbook-templates)
- KeyvaultName: The name of the keyvault created as pre-requisite
- DynatraceTenant: xyz.dynatrace.com
3. Create a new [automation rule](https://learn.microsoft.com/en-us/azure/sentinel/create-manage-use-automation-rules)
- Name : Add Dynatrace Application Security Attack Source IP Address to Threat Intelligence
- Trigger : When alert is created
- Conditions : If Analytic rule name contains 'Dynatrace Application Security - Attack detection'
- Actions : Run playbook AddDynatraceApplicationSecurityAttackSourceIPAddressTI

