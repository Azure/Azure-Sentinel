{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Miro - enterprise_integrations@miro.com",
    "comments": "Solution template for Miro"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "enterprise_integrations@miro.com",
    "_email": "[variables('email')]",
    "_solutionName": "Miro",
    "_solutionVersion": "3.0.0",
    "solutionId": "realtimeboardincdbamiro1645117589045.azure-sentinel-solution-miro",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "MiroAuditLogsDataConnector",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "MiroAuditLogsDataConnectorConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "TemplateEmptyObject": "[json('{}')]",
    "_dataConnectorContentIdConnectorDefinition2": "MiroContentLogsDataConnector",
    "dataConnectorTemplateNameConnectorDefinition2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition2')))]",
    "_dataConnectorContentIdConnections2": "MiroContentLogsDataConnectorConnections",
    "dataConnectorTemplateNameConnections2": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections2')))]",
    "dataCollectionEndpointId2": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Miro Audit Logs (Enterprise Plan)",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "MiroAuditLogsDataConnector",
                  "title": "Miro Audit Logs (Enterprise Plan)",
                  "publisher": "Miro",
                  "descriptionMarkdown": "The [Miro Audit Logs](https://help.miro.com/hc/en-us/articles/360017571434-Audit-logs) data connector enables you to ingest organization-wide audit events from Miro into Microsoft Sentinel. Monitor user activities, security events, content access, team changes, and administrative actions to enhance your security operations and compliance capabilities.\n\n**Key features:**\n- Track user authentication and access patterns.\n- Monitor content creation, sharing, and deletion.\n- Audit team and organization configuration changes.\n- Detect suspicious activities and policy violations.\n- Meet compliance and regulatory requirements.\n\n**Requirements:**\n- **Miro Plan**: [Enterprise Plan](https://miro.com/pricing/).\n- **OAuth scope**: `auditlogs:read`.\n- **Role**: Company Admin in your Miro organization.\n\nðŸ’¡ **Not on Enterprise Plan yet?** Upgrade to [Miro Enterprise](https://miro.com/enterprise/) to unlock audit logs and gain comprehensive visibility into your team's activities in Microsoft Sentinel.\n\nFor detailed instructions, refer to the [documentation](https://help.miro.com/hc/en-us/articles/31325908249362).",
                  "graphQueriesTableName": "MiroAuditLogs_CL",
                  "graphQueries": [
                    {
                      "metricName": "Miro Audit Logs",
                      "legend": "MiroAuditLogs_CL",
                      "baseQuery": "MiroAuditLogs_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Recent audit events",
                      "query": "MiroAuditLogs_CL\n| sort by TimeGenerated desc\n| take 10"
                    },
                    {
                      "description": "Events by category",
                      "query": "MiroAuditLogs_CL\n| summarize count() by category\n| render piechart"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "MiroAuditLogs_CL",
                      "lastDataReceivedQuery": "MiroAuditLogs_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "availability": {
                    "isPreview": false
                  },
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Miro Enterprise Plan",
                        "description": "Miro Enterprise Plan subscription is required."
                      },
                      {
                        "name": "Miro OAuth Application",
                        "description": "Miro OAuth application with auditlogs:read scope and Company Admin role is required."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "**Step 1: Verify your Miro plan**\n\n1. Ensure your organization has an active [Miro Enterprise Plan](https://miro.com/pricing/).\n2. If you need to upgrade, contact [Miro Sales](https://miro.com/contact/sales/) or your account manager.\n3. You must be a **Company Admin** to set up this integration."
                    },
                    {
                      "description": "**Step 2: Choose your setup option**\n\nThere are two ways to set up the Miro Audit Logs connector.\n\n**Option 1 (recommended):** Use Enterprise integrations\n- Simplest setup with automatic token generation.\n- Recommended for most users.\n- See Option 1 below.\n\n**Option 2 (alternative):** Create custom OAuth application\n- More control over OAuth app configuration.\n- For advanced users or custom integration needs.\n- See Option 2 below.\n\n**Note:** When using Option 1, the integration is automatically tied to the team with the largest number of users in your organization. When using Option 2, you can choose which team to install the app to. However, **the team selection does not affect which logs are collected**â€”both options provide organization-wide log access. All integration-relevant events from all teams are included in your logs."
                    },
                    {
                      "description": "**Option 1: Enterprise integrations (recommended)**\n\n1. Open [Miro Company Settings](https://miro.com/app/settings/).\n2. Expand the **Apps and integrations** section.\n3. Click **Enterprise integrations**.\n4. Enable the **SIEM** toggle.\n5. Copy the **Access Token** value that appears.\n6. **Important:** Store the token securelyâ€”it provides full access to audit logs.\n7. The token will work until you disable the toggle.\n8. Proceed to Step 3."
                    },
                    {
                      "description": "**Option 2: Custom OAuth application (alternative)**\n\n1. Go to [Miro App Settings](https://miro.com/app/settings/user-profile/apps).\n2. Click **Create new app**.\n3. Select **Non-expiring access token** option during app creation.\n4. Enable the OAuth scope: **`auditlogs:read`**.\n5. Click **Install app and get OAuth token**.\n6. Authorize the app to access your organization.\n7. Copy the **Access Token** that is displayed.\n8. **Important:** Store the token securelyâ€”it provides full access to audit logs.\n9. The token will work until you uninstall the app."
                    },
                    {
                      "description": "**Step 3: Learn more**\n\nFor detailed information about Miro audit logs:\n- [Miro Audit Logs documentation](https://help.miro.com/hc/en-us/articles/360017571434-Audit-logs)\n- [Miro API reference](https://developers.miro.com/reference/enterprise-get-audit-logs)\n- [OAuth non-expiring tokens](https://developers.miro.com/reference/authorization-flow-for-expiring-access-tokens)\n- [Enterprise integrations settings](https://miro.com/app/settings/)"
                    },
                    {
                      "description": "**Step 4: Connect to Miro**\n\nProvide your Miro access token below to complete the connection.",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Access token",
                            "placeholder": "Enter your Miro Access Token",
                            "type": "password",
                            "name": "AccessToken"
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {
                            "label": "toggle",
                            "name": "toggle"
                          }
                        }
                      ],
                      "title": "Connect to Miro to start collecting audit logs in Microsoft Sentinel."
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Miro",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Miro",
                  "email": "enterprise_integrations@miro.com",
                  "tier": "Partner",
                  "link": "https://help.miro.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "MiroAuditLogsDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-MiroAuditLogs_CL": {
                    "columns": [
                      {
                        "name": "id",
                        "type": "string"
                      },
                      {
                        "name": "event",
                        "type": "string"
                      },
                      {
                        "name": "category",
                        "type": "string"
                      },
                      {
                        "name": "type",
                        "type": "string"
                      },
                      {
                        "name": "createdAt",
                        "type": "string"
                      },
                      {
                        "name": "createdBy",
                        "type": "dynamic"
                      },
                      {
                        "name": "context",
                        "type": "dynamic"
                      },
                      {
                        "name": "details",
                        "type": "dynamic"
                      },
                      {
                        "name": "object",
                        "type": "dynamic"
                      }
                    ]
                  }
                },
                "dataSources": "[variables('TemplateEmptyObject')]",
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-MiroAuditLogs_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n| extend TimeGenerated = todatetime(createdAt)\n| extend createdAt = todatetime(createdAt)\n| extend logType = type\n| extend createdBy_email = iff(isnull(createdBy), \"\", tostring(createdBy.email))\n| extend createdBy_id = iff(isnull(createdBy), \"\", tostring(createdBy.id))\n| extend createdBy_name = iff(isnull(createdBy), \"\", tostring(createdBy.name))\n| extend createdBy_type = iff(isnull(createdBy), \"\", tostring(createdBy.type))\n| extend object_id = iff(isnull(object), \"\", tostring(object.id))\n| extend object_name = iff(isnull(object), \"\", tostring(object.name))\n| extend context_ip = iff(isnull(context), \"\", tostring(context.ip))\n| extend context_team_id = iff(isnull(context.team), \"\", tostring(context.team.id))\n| extend context_team_name = iff(isnull(context.team), \"\", tostring(context.team.name))\n| extend context_team_type = iff(isnull(context.team), \"\", tostring(context.team.type))\n| extend context_organization_id = iff(isnull(context.organization), \"\", tostring(context.organization.id))\n| extend context_organization_name = iff(isnull(context.organization), \"\", tostring(context.organization.name))\n| extend context_organization_type = iff(isnull(context.organization), \"\", tostring(context.organization.type))\n| project TimeGenerated, id, createdAt, event, category, logType, createdBy_email, createdBy_id, createdBy_name, createdBy_type, object_id, object_name, context_ip, context_team_id, context_team_name, context_team_type, context_organization_id, context_organization_name, context_organization_type, details",
                    "outputStream": "Custom-MiroAuditLogs_CL"
                  }
                ],
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]"
              }
            },
            {
              "name": "MiroAuditLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "MiroAuditLogs_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "description": "The timestamp (UTC) reflecting the time when the event was ingested"
                    },
                    {
                      "name": "id",
                      "type": "string",
                      "description": "Unique identifier of the audit event"
                    },
                    {
                      "name": "createdAt",
                      "type": "datetime",
                      "description": "Timestamp when the audit event was created"
                    },
                    {
                      "name": "event",
                      "type": "string",
                      "description": "Name of the audit event"
                    },
                    {
                      "name": "category",
                      "type": "string",
                      "description": "Category of the audit event"
                    },
                    {
                      "name": "logType",
                      "type": "string",
                      "description": "Type of the log entry. Mapped from API's 'type' field to avoid reserved 'Type' column name."
                    },
                    {
                      "name": "createdBy_email",
                      "type": "string",
                      "description": "Email address of the user who triggered the event"
                    },
                    {
                      "name": "createdBy_id",
                      "type": "string",
                      "description": "Unique identifier of the user who triggered the event"
                    },
                    {
                      "name": "createdBy_name",
                      "type": "string",
                      "description": "Name of the user who triggered the event"
                    },
                    {
                      "name": "createdBy_type",
                      "type": "string",
                      "description": "Type of the actor (user, service account, etc.)"
                    },
                    {
                      "name": "object_id",
                      "type": "string",
                      "description": "Unique identifier of the object affected by the event"
                    },
                    {
                      "name": "object_name",
                      "type": "string",
                      "description": "Name of the object affected by the event"
                    },
                    {
                      "name": "context_ip",
                      "type": "string",
                      "description": "IP address from which the event originated"
                    },
                    {
                      "name": "context_team_id",
                      "type": "string",
                      "description": "Unique identifier of the team context"
                    },
                    {
                      "name": "context_team_name",
                      "type": "string",
                      "description": "Name of the team context"
                    },
                    {
                      "name": "context_team_type",
                      "type": "string",
                      "description": "Type of the team"
                    },
                    {
                      "name": "context_organization_id",
                      "type": "string",
                      "description": "Unique identifier of the organization"
                    },
                    {
                      "name": "context_organization_name",
                      "type": "string",
                      "description": "Name of the organization"
                    },
                    {
                      "name": "context_organization_type",
                      "type": "string",
                      "description": "Type of the organization"
                    },
                    {
                      "name": "details",
                      "type": "dynamic",
                      "description": "Additional event details in JSON format"
                    }
                  ]
                }
              }
            },
            {
              "name": "MiroContentLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "MiroContentLogs_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "description": "The timestamp (UTC) reflecting the time when the event was ingested"
                    },
                    {
                      "name": "id",
                      "type": "string",
                      "description": "Unique identifier of the content log event"
                    },
                    {
                      "name": "actionTime",
                      "type": "datetime",
                      "description": "Timestamp when the action was performed"
                    },
                    {
                      "name": "actionType",
                      "type": "string",
                      "description": "Type of action performed (create, update, delete, etc.)"
                    },
                    {
                      "name": "actor_id",
                      "type": "string",
                      "description": "Unique identifier of the user who performed the action"
                    },
                    {
                      "name": "actor_email",
                      "type": "string",
                      "description": "Email address of the user who performed the action"
                    },
                    {
                      "name": "actor_name",
                      "type": "string",
                      "description": "Name of the user who performed the action"
                    },
                    {
                      "name": "contentId",
                      "type": "string",
                      "description": "Unique identifier of the content affected"
                    },
                    {
                      "name": "itemId",
                      "type": "string",
                      "description": "Unique identifier of the item affected"
                    },
                    {
                      "name": "itemType",
                      "type": "string",
                      "description": "Type of the content item"
                    },
                    {
                      "name": "relationships",
                      "type": "dynamic",
                      "description": "Relationships of the content item in JSON format"
                    },
                    {
                      "name": "state",
                      "type": "dynamic",
                      "description": "State information of the content item in JSON format"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "MiroAuditLogsDataConnector",
          "title": "Miro Audit Logs (Enterprise Plan)",
          "publisher": "Miro",
          "descriptionMarkdown": "The [Miro Audit Logs](https://help.miro.com/hc/en-us/articles/360017571434-Audit-logs) data connector enables you to ingest organization-wide audit events from Miro into Microsoft Sentinel. Monitor user activities, security events, content access, team changes, and administrative actions to enhance your security operations and compliance capabilities.\n\n**Key features:**\n- Track user authentication and access patterns.\n- Monitor content creation, sharing, and deletion.\n- Audit team and organization configuration changes.\n- Detect suspicious activities and policy violations.\n- Meet compliance and regulatory requirements.\n\n**Requirements:**\n- **Miro Plan**: [Enterprise Plan](https://miro.com/pricing/).\n- **OAuth scope**: `auditlogs:read`.\n- **Role**: Company Admin in your Miro organization.\n\nðŸ’¡ **Not on Enterprise Plan yet?** Upgrade to [Miro Enterprise](https://miro.com/enterprise/) to unlock audit logs and gain comprehensive visibility into your team's activities in Microsoft Sentinel.\n\nFor detailed instructions, refer to the [documentation](https://help.miro.com/hc/en-us/articles/31325908249362).",
          "graphQueriesTableName": "MiroAuditLogs_CL",
          "graphQueries": [
            {
              "metricName": "Miro Audit Logs",
              "legend": "MiroAuditLogs_CL",
              "baseQuery": "MiroAuditLogs_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Recent audit events",
              "query": "MiroAuditLogs_CL\n| sort by TimeGenerated desc\n| take 10"
            },
            {
              "description": "Events by category",
              "query": "MiroAuditLogs_CL\n| summarize count() by category\n| render piechart"
            }
          ],
          "dataTypes": [
            {
              "name": "MiroAuditLogs_CL",
              "lastDataReceivedQuery": "MiroAuditLogs_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "availability": {
            "isPreview": false
          },
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Miro Enterprise Plan",
                "description": "Miro Enterprise Plan subscription is required."
              },
              {
                "name": "Miro OAuth Application",
                "description": "Miro OAuth application with auditlogs:read scope and Company Admin role is required."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "**Step 1: Verify your Miro plan**\n\n1. Ensure your organization has an active [Miro Enterprise Plan](https://miro.com/pricing/).\n2. If you need to upgrade, contact [Miro Sales](https://miro.com/contact/sales/) or your account manager.\n3. You must be a **Company Admin** to set up this integration."
            },
            {
              "description": "**Step 2: Choose your setup option**\n\nThere are two ways to set up the Miro Audit Logs connector.\n\n**Option 1 (recommended):** Use Enterprise integrations\n- Simplest setup with automatic token generation.\n- Recommended for most users.\n- See Option 1 below.\n\n**Option 2 (alternative):** Create custom OAuth application\n- More control over OAuth app configuration.\n- For advanced users or custom integration needs.\n- See Option 2 below.\n\n**Note:** When using Option 1, the integration is automatically tied to the team with the largest number of users in your organization. When using Option 2, you can choose which team to install the app to. However, **the team selection does not affect which logs are collected**â€”both options provide organization-wide log access. All integration-relevant events from all teams are included in your logs."
            },
            {
              "description": "**Option 1: Enterprise integrations (recommended)**\n\n1. Open [Miro Company Settings](https://miro.com/app/settings/).\n2. Expand the **Apps and integrations** section.\n3. Click **Enterprise integrations**.\n4. Enable the **SIEM** toggle.\n5. Copy the **Access Token** value that appears.\n6. **Important:** Store the token securelyâ€”it provides full access to audit logs.\n7. The token will work until you disable the toggle.\n8. Proceed to Step 3."
            },
            {
              "description": "**Option 2: Custom OAuth application (alternative)**\n\n1. Go to [Miro App Settings](https://miro.com/app/settings/user-profile/apps).\n2. Click **Create new app**.\n3. Select **Non-expiring access token** option during app creation.\n4. Enable the OAuth scope: **`auditlogs:read`**.\n5. Click **Install app and get OAuth token**.\n6. Authorize the app to access your organization.\n7. Copy the **Access Token** that is displayed.\n8. **Important:** Store the token securelyâ€”it provides full access to audit logs.\n9. The token will work until you uninstall the app."
            },
            {
              "description": "**Step 3: Learn more**\n\nFor detailed information about Miro audit logs:\n- [Miro Audit Logs documentation](https://help.miro.com/hc/en-us/articles/360017571434-Audit-logs)\n- [Miro API reference](https://developers.miro.com/reference/enterprise-get-audit-logs)\n- [OAuth non-expiring tokens](https://developers.miro.com/reference/authorization-flow-for-expiring-access-tokens)\n- [Enterprise integrations settings](https://miro.com/app/settings/)"
            },
            {
              "description": "**Step 4: Connect to Miro**\n\nProvide your Miro access token below to complete the connection.",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Access token",
                    "placeholder": "Enter your Miro Access Token",
                    "type": "password",
                    "name": "AccessToken"
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {
                    "label": "toggle",
                    "name": "toggle"
                  }
                }
              ],
              "title": "Connect to Miro to start collecting audit logs in Microsoft Sentinel."
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Miro",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Miro",
          "email": "enterprise_integrations@miro.com",
          "tier": "Partner",
          "link": "https://help.miro.com"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Miro Audit Logs (Enterprise Plan)",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "Miro Audit Logs (Enterprise Plan)",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "AccessToken": {
              "defaultValue": "AccessToken",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Miro",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Miro",
                  "email": "enterprise_integrations@miro.com",
                  "tier": "Partner",
                  "link": "https://help.miro.com"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'MiroAuditLogsPoller', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "MiroAuditLogsDataConnector",
                "dcrConfig": {
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                  "streamName": "Custom-MiroAuditLogs_CL"
                },
                "dataType": "Miro Audit Logs",
                "response": {
                  "eventsJsonPaths": [
                    "$.data"
                  ],
                  "format": "json"
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageTokenJsonPath": "$.cursor",
                  "nextPageParaName": "cursor",
                  "pageSize": 100
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKeyName": "Authorization",
                  "APIKey": "[[concat('Bearer ',parameters('AccessToken'))]",
                  "IsAPIKeyInPostPayload": false
                },
                "request": {
                  "apiEndpoint": "https://api.miro.com/v2/audit/logs",
                  "rateLimitQPS": 10,
                  "queryWindowInMin": 5,
                  "queryTimeFormat": "yyyy-MM-dd'T'HH:mm:ss'.00Z'",
                  "httpMethod": "GET",
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json",
                    "User-Agent": "Microsoft-Azure-Sentinel-MiroAuditLogsDataConnector"
                  },
                  "StartTimeAttributeName": "createdAfter",
                  "EndTimeAttributeName": "createdBefore",
                  "queryParameters": {
                    "createdAfter": "{_QueryWindowStartTime}",
                    "createdBefore": "{_QueryWindowEndTime}",
                    "sorting": "ASC",
                    "limit": "100"
                  }
                },
                "isActive": true
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition2'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
        "displayName": "Miro Content Logs (Enterprise Plan + Enterprise Guard)",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition2'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "MiroContentLogsDataConnector",
                  "title": "Miro Content Logs (Enterprise Plan + Enterprise Guard)",
                  "publisher": "Miro",
                  "descriptionMarkdown": "The [Miro Content Logs](https://help.miro.com/hc/en-us/articles/17774729839378-Content-Logs-overview) data connector enables you to ingest content activity logs from Miro into Microsoft Sentinel. Part of Miro's Enterprise Guard eDiscovery capabilities, this connector provides content-level visibility for compliance, legal hold, and advanced threat detection.\n\n**Key features:**\n- Track all content item changes.\n- Monitor content modifications by user and timestamp.\n- Support compliance and eDiscovery requirements.\n- Detect data exfiltration and insider threats.\n- Meet regulatory and legal hold obligations.\n\n**Requirements:**\n- **Miro Plan**: [Enterprise Plan](https://miro.com/pricing/) + **Enterprise Guard** add-on.\n- **OAuth scope**: `contentlogs:export`.\n- **Role**: Company Admin in your Miro organization.\n- **Organization ID**: Your Miro organization identifier.\n\nðŸ’¡ **Not on Enterprise Plan yet?** Upgrade to [Miro Enterprise](https://miro.com/enterprise/) to unlock advanced security and compliance features for your team's collaboration activities in Microsoft Sentinel.\n\nðŸ’¡ **Need Content Logs?** Content activity logging is part of [Miro Enterprise Guard](https://miro.com/enterprise-guard/), which provides advanced security, compliance, and eDiscovery features. Contact your Miro account manager to add Enterprise Guard to your Enterprise Plan and unlock content-level monitoring in Microsoft Sentinel.\n\n**Note:** If you only have the base Enterprise Plan (without Enterprise Guard), please use the **Miro Audit Logs** connector instead for organization-level event monitoring.\n\nFor detailed instructions, refer to the [documentation](https://help.miro.com/hc/en-us/articles/31325908249362).",
                  "graphQueriesTableName": "MiroContentLogs_CL",
                  "graphQueries": [
                    {
                      "metricName": "Miro Content Logs",
                      "legend": "MiroContentLogs_CL",
                      "baseQuery": "MiroContentLogs_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Recent content changes",
                      "query": "MiroContentLogs_CL\n| sort by TimeGenerated desc\n| take 10"
                    },
                    {
                      "description": "Activity by action type",
                      "query": "MiroContentLogs_CL\n| summarize count() by actionType\n| render piechart"
                    },
                    {
                      "description": "Most active users",
                      "query": "MiroContentLogs_CL\n| summarize events = count() by actor_name\n| top 10 by events desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "MiroContentLogs_CL",
                      "lastDataReceivedQuery": "MiroContentLogs_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "availability": {
                    "isPreview": false
                  },
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Miro Enterprise Plan with Enterprise Guard",
                        "description": "Miro Enterprise Plan with Enterprise Guard add-on is required. Content logs are part of Miro's eDiscovery features and are not available on base Enterprise Plan or lower tiers."
                      },
                      {
                        "name": "Miro OAuth Application",
                        "description": "Miro OAuth application with contentlogs:export scope and Company Admin role is required."
                      },
                      {
                        "name": "Miro Organization ID",
                        "description": "Your Miro organization ID is required to access content logs."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "**Step 1: Verify your Miro plan and Enterprise Guard**\n\n1. Ensure your organization has [Miro Enterprise Plan](https://miro.com/pricing/) with **Enterprise Guard** add-on.\n2. Content logs are part of Miro's eDiscovery (Enterprise Guard) features.\n3. If you don't have Enterprise Guard yet, contact your [Miro account manager](https://miro.com/contact/sales/) to upgrade.\n4. Without Enterprise Guard, use the **Miro Audit Logs** connector for organization-level monitoring.\n5. You must be a **Company Admin** to set up this integration."
                    },
                    {
                      "description": "**Step 2: Choose your setup option**\n\nThere are two ways to set up the Miro Content Logs connector.\n\n**Option 1 (recommended):** Use Enterprise integrations\n- Simplest setup with automatic token generation.\n- Recommended for most users.\n- See Option 1 below.\n\n**Option 2 (alternative):** Create custom OAuth application\n- More control over OAuth app configuration.\n- For advanced users or custom integration needs.\n- See Option 2 below.\n\n**Note:** When using Option 1, the integration is automatically tied to the team with the largest number of users in your organization. When using Option 2, you can choose which team to install the app to. However, **the team selection does not affect which logs are collected**â€”both options provide organization-wide log access. All integration-relevant events from all teams are included in your logs."
                    },
                    {
                      "description": "**Option 1: Enterprise integrations (recommended)**\n\n1. Open [Miro Company Settings](https://miro.com/app/settings/).\n2. Expand the **Apps and integrations** section.\n3. Click **Enterprise integrations**.\n4. Enable the **eDiscovery** toggle.\n5. Copy the **Access Token** value that appears.\n6. Get your **Organization ID** from the browser URL:\n   - Look at the browser URL to find your Organization ID.\n   - The URL format is: `https://miro.com/app/settings/company/{ORGANIZATION_ID}/`.\n   - Copy your Organization ID from the URL (the numeric value).\n7. **Important:** Store both the token and Organization ID securelyâ€”they provide full access to content logs.\n8. The token will work until you disable the toggle.\n9. Proceed to Step 3."
                    },
                    {
                      "description": "**Option 2: Custom OAuth application (alternative)**\n\n1. Go to [Miro App Settings](https://miro.com/app/settings/user-profile/apps).\n2. Click **Create new app**.\n3. Select **Non-expiring access token** option during app creation.\n4. Enable the OAuth scope: **`contentlogs:export`**.\n5. Click **Install app and get OAuth token**.\n6. Authorize the app to access your organization.\n7. Copy the **Access Token** that is displayed.\n8. Get your **Organization ID**:\n   - Go to [Miro Company Settings](https://miro.com/app/settings/).\n   - Look at the browser URL to find your Organization ID.\n   - The URL format is: `https://miro.com/app/settings/company/{ORGANIZATION_ID}/`.\n   - Copy your Organization ID from the URL (the numeric value).\n9. **Important:** Store both the token and Organization ID securelyâ€”they provide full access to content logs.\n10. The token will work until you uninstall the app."
                    },
                    {
                      "description": "**Step 3: Learn more**\n\nFor detailed information about Miro content logs and eDiscovery:\n- [Miro Content Logs overview](https://help.miro.com/hc/en-us/articles/17774729839378-Content-Logs-overview)\n- [Miro Enterprise Guard](https://miro.com/enterprise-guard/)\n- [Miro API reference](https://developers.miro.com/reference/enterprise-board-content-item-logs-fetch)\n- [OAuth non-expiring tokens](https://developers.miro.com/reference/authorization-flow-for-expiring-access-tokens)\n- [Enterprise integrations settings](https://miro.com/app/settings/)"
                    },
                    {
                      "description": "**Step 4: Connect to Miro**\n\nProvide the required values below to complete the connection.",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Organization ID",
                            "placeholder": "Enter your Miro Organization ID",
                            "type": "text",
                            "name": "organizationId"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "Access token",
                            "placeholder": "Enter your Miro Access Token",
                            "type": "password",
                            "name": "AccessToken"
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {
                            "label": "toggle",
                            "name": "toggle"
                          }
                        }
                      ],
                      "title": "Connect to Miro to start collecting content logs in Microsoft Sentinel."
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition2')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition2'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Miro",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Miro",
                  "email": "enterprise_integrations@miro.com",
                  "tier": "Partner",
                  "link": "https://help.miro.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections2')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "MiroContentLogsDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-MiroContentLogs_CL": {
                    "columns": [
                      {
                        "name": "id",
                        "type": "string"
                      },
                      {
                        "name": "contentId",
                        "type": "string"
                      },
                      {
                        "name": "actionType",
                        "type": "string"
                      },
                      {
                        "name": "actionTime",
                        "type": "string"
                      },
                      {
                        "name": "actor",
                        "type": "dynamic"
                      },
                      {
                        "name": "itemType",
                        "type": "string"
                      },
                      {
                        "name": "itemId",
                        "type": "string"
                      },
                      {
                        "name": "state",
                        "type": "dynamic"
                      },
                      {
                        "name": "relationships",
                        "type": "dynamic"
                      }
                    ]
                  }
                },
                "dataSources": "[variables('TemplateEmptyObject')]",
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-MiroContentLogs_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source\n| extend TimeGenerated = todatetime(actionTime)\n| extend actionTime = todatetime(actionTime)\n| extend actor_id = iff(isnull(actor), \"\", tostring(actor.id))\n| extend actor_email = iff(isnull(actor), \"\", tostring(actor.email))\n| extend actor_name = iff(isnull(actor), \"\", tostring(actor.name))\n| project TimeGenerated, id, actionTime, actionType, actor_id, actor_email, actor_name, contentId, itemId, itemType, relationships, state",
                    "outputStream": "Custom-MiroContentLogs_CL"
                  }
                ],
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId2')]"
              }
            },
            {
              "name": "MiroContentLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "MiroContentLogs_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "description": "The timestamp (UTC) reflecting the time when the event was ingested"
                    },
                    {
                      "name": "id",
                      "type": "string",
                      "description": "Unique identifier of the content log event"
                    },
                    {
                      "name": "actionTime",
                      "type": "datetime",
                      "description": "Timestamp when the action was performed"
                    },
                    {
                      "name": "actionType",
                      "type": "string",
                      "description": "Type of action performed (create, update, delete, etc.)"
                    },
                    {
                      "name": "actor_id",
                      "type": "string",
                      "description": "Unique identifier of the user who performed the action"
                    },
                    {
                      "name": "actor_email",
                      "type": "string",
                      "description": "Email address of the user who performed the action"
                    },
                    {
                      "name": "actor_name",
                      "type": "string",
                      "description": "Name of the user who performed the action"
                    },
                    {
                      "name": "contentId",
                      "type": "string",
                      "description": "Unique identifier of the content affected"
                    },
                    {
                      "name": "itemId",
                      "type": "string",
                      "description": "Unique identifier of the item affected"
                    },
                    {
                      "name": "itemType",
                      "type": "string",
                      "description": "Type of the content item"
                    },
                    {
                      "name": "relationships",
                      "type": "dynamic",
                      "description": "Relationships of the content item in JSON format"
                    },
                    {
                      "name": "state",
                      "type": "dynamic",
                      "description": "State information of the content item in JSON format"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition2'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition2'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "MiroContentLogsDataConnector",
          "title": "Miro Content Logs (Enterprise Plan + Enterprise Guard)",
          "publisher": "Miro",
          "descriptionMarkdown": "The [Miro Content Logs](https://help.miro.com/hc/en-us/articles/17774729839378-Content-Logs-overview) data connector enables you to ingest content activity logs from Miro into Microsoft Sentinel. Part of Miro's Enterprise Guard eDiscovery capabilities, this connector provides content-level visibility for compliance, legal hold, and advanced threat detection.\n\n**Key features:**\n- Track all content item changes.\n- Monitor content modifications by user and timestamp.\n- Support compliance and eDiscovery requirements.\n- Detect data exfiltration and insider threats.\n- Meet regulatory and legal hold obligations.\n\n**Requirements:**\n- **Miro Plan**: [Enterprise Plan](https://miro.com/pricing/) + **Enterprise Guard** add-on.\n- **OAuth scope**: `contentlogs:export`.\n- **Role**: Company Admin in your Miro organization.\n- **Organization ID**: Your Miro organization identifier.\n\nðŸ’¡ **Not on Enterprise Plan yet?** Upgrade to [Miro Enterprise](https://miro.com/enterprise/) to unlock advanced security and compliance features for your team's collaboration activities in Microsoft Sentinel.\n\nðŸ’¡ **Need Content Logs?** Content activity logging is part of [Miro Enterprise Guard](https://miro.com/enterprise-guard/), which provides advanced security, compliance, and eDiscovery features. Contact your Miro account manager to add Enterprise Guard to your Enterprise Plan and unlock content-level monitoring in Microsoft Sentinel.\n\n**Note:** If you only have the base Enterprise Plan (without Enterprise Guard), please use the **Miro Audit Logs** connector instead for organization-level event monitoring.\n\nFor detailed instructions, refer to the [documentation](https://help.miro.com/hc/en-us/articles/31325908249362).",
          "graphQueriesTableName": "MiroContentLogs_CL",
          "graphQueries": [
            {
              "metricName": "Miro Content Logs",
              "legend": "MiroContentLogs_CL",
              "baseQuery": "MiroContentLogs_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Recent content changes",
              "query": "MiroContentLogs_CL\n| sort by TimeGenerated desc\n| take 10"
            },
            {
              "description": "Activity by action type",
              "query": "MiroContentLogs_CL\n| summarize count() by actionType\n| render piechart"
            },
            {
              "description": "Most active users",
              "query": "MiroContentLogs_CL\n| summarize events = count() by actor_name\n| top 10 by events desc"
            }
          ],
          "dataTypes": [
            {
              "name": "MiroContentLogs_CL",
              "lastDataReceivedQuery": "MiroContentLogs_CL\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "availability": {
            "isPreview": false
          },
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              }
            ],
            "customs": [
              {
                "name": "Miro Enterprise Plan with Enterprise Guard",
                "description": "Miro Enterprise Plan with Enterprise Guard add-on is required. Content logs are part of Miro's eDiscovery features and are not available on base Enterprise Plan or lower tiers."
              },
              {
                "name": "Miro OAuth Application",
                "description": "Miro OAuth application with contentlogs:export scope and Company Admin role is required."
              },
              {
                "name": "Miro Organization ID",
                "description": "Your Miro organization ID is required to access content logs."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "**Step 1: Verify your Miro plan and Enterprise Guard**\n\n1. Ensure your organization has [Miro Enterprise Plan](https://miro.com/pricing/) with **Enterprise Guard** add-on.\n2. Content logs are part of Miro's eDiscovery (Enterprise Guard) features.\n3. If you don't have Enterprise Guard yet, contact your [Miro account manager](https://miro.com/contact/sales/) to upgrade.\n4. Without Enterprise Guard, use the **Miro Audit Logs** connector for organization-level monitoring.\n5. You must be a **Company Admin** to set up this integration."
            },
            {
              "description": "**Step 2: Choose your setup option**\n\nThere are two ways to set up the Miro Content Logs connector.\n\n**Option 1 (recommended):** Use Enterprise integrations\n- Simplest setup with automatic token generation.\n- Recommended for most users.\n- See Option 1 below.\n\n**Option 2 (alternative):** Create custom OAuth application\n- More control over OAuth app configuration.\n- For advanced users or custom integration needs.\n- See Option 2 below.\n\n**Note:** When using Option 1, the integration is automatically tied to the team with the largest number of users in your organization. When using Option 2, you can choose which team to install the app to. However, **the team selection does not affect which logs are collected**â€”both options provide organization-wide log access. All integration-relevant events from all teams are included in your logs."
            },
            {
              "description": "**Option 1: Enterprise integrations (recommended)**\n\n1. Open [Miro Company Settings](https://miro.com/app/settings/).\n2. Expand the **Apps and integrations** section.\n3. Click **Enterprise integrations**.\n4. Enable the **eDiscovery** toggle.\n5. Copy the **Access Token** value that appears.\n6. Get your **Organization ID** from the browser URL:\n   - Look at the browser URL to find your Organization ID.\n   - The URL format is: `https://miro.com/app/settings/company/{ORGANIZATION_ID}/`.\n   - Copy your Organization ID from the URL (the numeric value).\n7. **Important:** Store both the token and Organization ID securelyâ€”they provide full access to content logs.\n8. The token will work until you disable the toggle.\n9. Proceed to Step 3."
            },
            {
              "description": "**Option 2: Custom OAuth application (alternative)**\n\n1. Go to [Miro App Settings](https://miro.com/app/settings/user-profile/apps).\n2. Click **Create new app**.\n3. Select **Non-expiring access token** option during app creation.\n4. Enable the OAuth scope: **`contentlogs:export`**.\n5. Click **Install app and get OAuth token**.\n6. Authorize the app to access your organization.\n7. Copy the **Access Token** that is displayed.\n8. Get your **Organization ID**:\n   - Go to [Miro Company Settings](https://miro.com/app/settings/).\n   - Look at the browser URL to find your Organization ID.\n   - The URL format is: `https://miro.com/app/settings/company/{ORGANIZATION_ID}/`.\n   - Copy your Organization ID from the URL (the numeric value).\n9. **Important:** Store both the token and Organization ID securelyâ€”they provide full access to content logs.\n10. The token will work until you uninstall the app."
            },
            {
              "description": "**Step 3: Learn more**\n\nFor detailed information about Miro content logs and eDiscovery:\n- [Miro Content Logs overview](https://help.miro.com/hc/en-us/articles/17774729839378-Content-Logs-overview)\n- [Miro Enterprise Guard](https://miro.com/enterprise-guard/)\n- [Miro API reference](https://developers.miro.com/reference/enterprise-board-content-item-logs-fetch)\n- [OAuth non-expiring tokens](https://developers.miro.com/reference/authorization-flow-for-expiring-access-tokens)\n- [Enterprise integrations settings](https://miro.com/app/settings/)"
            },
            {
              "description": "**Step 4: Connect to Miro**\n\nProvide the required values below to complete the connection.",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Organization ID",
                    "placeholder": "Enter your Miro Organization ID",
                    "type": "text",
                    "name": "organizationId"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "Access token",
                    "placeholder": "Enter your Miro Access Token",
                    "type": "password",
                    "name": "AccessToken"
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {
                    "label": "toggle",
                    "name": "toggle"
                  }
                }
              ],
              "title": "Connect to Miro to start collecting content logs in Microsoft Sentinel."
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition2')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition2'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition2')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Miro",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Miro",
          "email": "enterprise_integrations@miro.com",
          "tier": "Partner",
          "link": "https://help.miro.com"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections2')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections2'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections2')]",
        "displayName": "Miro Content Logs (Enterprise Plan + Enterprise Guard)",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "Miro Content Logs (Enterprise Plan + Enterprise Guard)",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "organizationId": {
              "defaultValue": "organizationId",
              "type": "securestring",
              "minLength": 1
            },
            "AccessToken": {
              "defaultValue": "AccessToken",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections2": "[variables('_dataConnectorContentIdConnections2')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections2')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections2'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections2')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Miro",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Miro",
                  "email": "enterprise_integrations@miro.com",
                  "tier": "Partner",
                  "link": "https://help.miro.com"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'MiroContentLogsPoller', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "MiroContentLogsDataConnector",
                "dcrConfig": {
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                  "streamName": "Custom-MiroContentLogs_CL"
                },
                "dataType": "Miro Content Logs",
                "addOnAttributes": {
                  "OrganizationId": "[[parameters('organizationId')]"
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.data"
                  ],
                  "format": "json"
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageTokenJsonPath": "$.cursor",
                  "nextPageParaName": "cursor",
                  "pageSize": 100
                },
                "auth": {
                  "type": "APIKey",
                  "ApiKeyName": "Authorization",
                  "APIKey": "[[concat('Bearer ',parameters('AccessToken'))]",
                  "IsAPIKeyInPostPayload": false
                },
                "request": {
                  "apiEndpoint": "[[concat('https://api.miro.com/v2/orgs/',parameters('organizationId'),'/content-logs/items')]",
                  "rateLimitQPS": 10,
                  "queryWindowInMin": 5,
                  "queryTimeFormat": "yyyy-MM-dd'T'HH:mm:ss'.00Z'",
                  "httpMethod": "GET",
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json",
                    "User-Agent": "Microsoft-Azure-Sentinel-MiroContentLogsDataConnector"
                  },
                  "StartTimeAttributeName": "from",
                  "EndTimeAttributeName": "to",
                  "queryParameters": {
                    "from": "{_QueryWindowStartTime}",
                    "to": "{_QueryWindowEndTime}",
                    "sorting": "asc",
                    "limit": "100"
                  }
                },
                "isActive": true
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections2'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Miro",
        "publisherDisplayName": "Miro",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>â€¢ Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Miro/ReleaseNotes.md\">Release Notes</a></p>\n<p>â€¢ There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The <a href=\"https://miro.com/\">Miro</a> solution for Microsoft Sentinel provides the capability to ingest audit logs and content activity logs from <a href=\"https://developers.miro.com/reference\">Miro REST APIs</a> into Microsoft Sentinel using the Codeless Connector Framework (CCF). This connector enables organizations to monitor and analyze activities within their Miro workspaces. For detailed instructions, refer to the <a href=\"https://help.miro.com/hc/en-us/articles/31325908249362\">documentation</a>.</p>\n<p><strong>Underlying Microsoft technology used:</strong></p>\n<p>This solution is dependent on the following technology and this dependency may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<p>â€¢ <a href=\"https://learn.microsoft.com/azure/sentinel/create-codeless-connector\">Codeless Connector Framework (CCF)</a></p>\n<p><strong>Data Connectors:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Miro.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Miro",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Miro",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Miro",
          "email": "enterprise_integrations@miro.com",
          "tier": "Partner",
          "link": "https://help.miro.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections2')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "providers": [
          "Miro"
        ],
        "categories": {
          "domains": [
            "Security - Automation (SOAR)",
            "Security - Insider Threat",
            "Security - Information Protection",
            "Security - Threat Protection",
            "Security - Cloud Security",
            "Compliance",
            "User Behavior (UEBA)",
            "Application"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
