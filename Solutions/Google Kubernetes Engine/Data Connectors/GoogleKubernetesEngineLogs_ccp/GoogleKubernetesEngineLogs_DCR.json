[
    {
        "name": "GKE",
        "apiVersion": "2023-03-11",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-GKEAuditLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "operation",
                            "type": "dynamic"
                        },
                        {
                            "name": "protoPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        }
                    ]
                },
                "Custom-GKEAPIServerLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "sourceLocation",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        }
                    ]
                },
                "Custom-GKESchedulerLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "sourceLocation",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        }
                    ]
                },
                "Custom-GKEControllerManagerLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "sourceLocation",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        }
                    ]
                },
                "Custom-GKEHPADecisionLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "sourceLocation",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        }
                    ]
                },
                "Custom-GKEApplicationLogs": {
                    "columns": [
                        {
                            "name": "insertId",
                            "type": "string"
                        },
                        {
                            "name": "logName",
                            "type": "string"
                        },
                        {
                            "name": "labels",
                            "type": "dynamic"
                        },
                        {
                            "name": "jsonPayload",
                            "type": "dynamic"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "sourceLocation",
                            "type": "dynamic"
                        },
                        {
                            "name": "resource",
                            "type": "dynamic"
                        },
                        {
                            "name": "receiveTimestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "timestamp",
                            "type": "datetime"
                        },
                        {
                            "name": "textPayload",
                            "type": "string"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-GKEAuditLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName has 'cloudaudit.googleapis.com%2Factivity' or logName has 'cloudaudit.googleapis.com%2Fdata_access' or logName has 'container.googleapis.com%2Fcluster-autoscaler-visibility' | extend LogType = case(logName contains 'data_access', 'Data Access Log', logName contains 'activity', 'Activity Log', logName contains 'cluster-autoscaler-visibility', 'Cluster Autoscaler Log', 'Unknown'), InsertId = insertId, TimeGenerated = timestamp, ReceiveTimestamp = receiveTimestamp, Resource = resource, Labels = labels,LogName =logName, ProtoPayload = iff(isnotempty(protoPayload), protoPayload, todynamic('')), JsonPayload = iff(isnotempty(jsonPayload), jsonPayload, todynamic('')), Operation = iff(isnotempty(operation), operation, todynamic('')), Severity = iff(isnotempty(severity), severity, '') | project LogType, InsertId, TimeGenerated, ReceiveTimestamp, Resource, Labels, ProtoPayload, JsonPayload, Operation, Severity,LogName",
                    "outputStream": "Microsoft-GKEAudit"
                },
                {
                    "streams": [
                        "Custom-GKEAPIServerLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName has 'container.googleapis.com%2Fapiserver' | extend TimeGenerated = timestamp, InsertId = tostring(insertId), LogName = tostring(logName), Labels = todynamic(labels), Message = tostring(jsonPayload.message), Pid = tostring(jsonPayload.pid), Severity = tostring(severity), SourceFile = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.file), ''), SourceLine = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.line), ''), ReceiveTimestamp = receiveTimestamp, ClusterName = tostring(resource.labels.cluster_name), ComponentLocation = tostring(resource.labels.component_location), ComponentName = tostring(resource.labels.component_name), Location = tostring(resource.labels.location), ProjectID = tostring(resource.labels.project_id), ComputeResourceName = tostring(labels['compute.googleapis.com/resource_name']) | extend Protocol = iff(Message startswith @'\"HTTP\"', 'HTTP', ''), HttpVerb = extract(@'verb=\\\"(\\w+)\\\"', 1, Message), URI = extract(@'URI=\\\"([^\\\"]+)\\\"', 1, Message), Latency = extract(@'latency=\\\"([^\\\"]+)\\\"', 1, Message), UserAgent = extract(@'userAgent=\\\"([^\\\"]+)\\\"', 1, Message), AuditID = extract(@'audit-ID=\\\"([^\\\"]*)\\\"', 1, Message), SrcIP = extract(@'srcIP=\\\"([^\\\"]+)\\\"', 1, Message), ResponseCode = toint(extract(@'resp=(\\d+)', 1, Message)), ApfPl = extract(@'apf_pl=\\\"([^\\\"]+)\\\"', 1, Message), ApfFs = extract(@'apf_fs=\\\"([^\\\"]+)\\\"', 1, Message), ApfISeats = toint(extract(@'apf_iseats=(\\d+)', 1, Message)), ApfFSeats = toint(extract(@'apf_fseats=(\\d+)', 1, Message)), ApfAdditionalLatency = extract(@'apf_additionalLatency=\\\"([^\\\"]+)\\\"', 1, Message), ApfExecutionTime = extract(@'apf_execution_time=\\\"([^\\\"]+)\\\"', 1, Message) | extend WatchEvent = iff(Message startswith @'\"Starting watch\"', 'Starting watch', ''), WatchPath = extract(@'path=\\\"([^\\\"]+)\\\"', 1, Message), ResourceVersion = extract(@'resourceVersion=\\\"([^\\\"]+)\\\"', 1, Message), WatchLabels = extract(@'labels=\\\"([^\\\"]*)\\\"', 1, Message), WatchFields = extract(@'fields=\\\"([^\\\"]*)\\\"', 1, Message), WatchTimeout = extract(@'timeout=\\\"([^\\\"]+)\\\"', 1, Message) | project-away jsonPayload, sourceLocation, resource, labels,Labels,Message",
                    "outputStream": "Microsoft-GKEAPIServer"
                },
                {
                    "streams": [
                        "Custom-GKESchedulerLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName has 'container.googleapis.com%2Fscheduler' | extend TimeGenerated = timestamp,InsertId = tostring(insertId), LogName = tostring(logName), Labels = todynamic(labels), Message = tostring(jsonPayload.message), Pid = tostring(jsonPayload.pid), Severity = tostring(severity), SourceFile = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.file), ''), SourceLine = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.line), ''), ReceiveTimestamp = receiveTimestamp, ClusterName = tostring(resource.labels.cluster_name), ComponentLocation = tostring(resource.labels.component_location), ComponentName = tostring(resource.labels.component_name), Location = tostring(resource.labels.location), ProjectID = tostring(resource.labels.project_id), ComputeResourceName = tostring(labels['compute.googleapis.com/resource_name']) | extend Protocol = extract(@'^(\\\"[^\\\"]+\\\")', 1, Message), HttpVerb = extract(@'verb=\\\"(\\w+)\\\"', 1, Message), URI = extract(@'URI=\\\"([^\\\"]+)\\\"', 1, Message), Latency = extract(@'latency=\\\"([^\\\"]+)\\\"', 1, Message), UserAgent = extract(@'userAgent=\\\"([^\\\"]+)\\\"', 1, Message), AuditID = extract(@'audit-ID=\\\"([^\\\"]*)\\\"', 1, Message), SrcIP = extract(@'srcIP=\\\"([^\\\"]+)\\\"', 1, Message), ResponseCode = toint(extract(@'resp=(\\d+)', 1, Message)) | project-away jsonPayload, sourceLocation, resource, labels,Labels,Message",
                    "outputStream": "Microsoft-GKEScheduler"
                },
                {
                    "streams": [
                        "Custom-GKEControllerManagerLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName contains 'container.googleapis.com%2Fcontroller-manager' | extend TimeGenerated = timestamp, InsertId = tostring(insertId), LogName = tostring(logName), Labels = todynamic(labels), Message = tostring(jsonPayload.message), Pid = tostring(jsonPayload.pid), Severity = tostring(severity), SourceFile = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.file), ''), SourceLine = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.line), ''), ReceiveTimestamp = receiveTimestamp, ClusterName = tostring(resource.labels.cluster_name), ComponentLocation = tostring(resource.labels.component_location), ComponentName = tostring(resource.labels.component_name), Location = tostring(resource.labels.location), ProjectID = tostring(resource.labels.project_id), ComputeResourceName = tostring(labels['compute.googleapis.com/resource_name']) | extend Logger = extract(@'logger=\\\"([^\\\"]+)\\\"', 1, Message), Kind = extract(@'kind=\\\"([^\\\"]+)\\\"', 1, Message), Key = extract(@'key=\\\"([^\\\"]+)\\\"', 1, Message), Duration = extract(@'duration=\\\"([^\\\"]+)\\\"', 1, Message), SyncStatus = iff(Message contains 'Finished syncing', 'Finished syncing', '') | project TimeGenerated, InsertId, LogName, Labels, Message, Pid, Severity, SourceFile, SourceLine, ReceiveTimestamp, ClusterName, ComponentLocation, ComponentName, Location, ProjectID, ComputeResourceName, Logger, Kind, Key, Duration, SyncStatus",
                    "outputStream": "Microsoft-GKEControllerManager"
                },
                {
                    "streams": [
                        "Custom-GKEHPADecisionLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName has 'container.googleapis.com%2Fhpa-controller'| extend TimeGenerated = timestamp, InsertId = tostring(insertId), LogName = tostring(logName), Labels = todynamic(labels), Message = tostring(jsonPayload.message), Severity = tostring(severity), SourceFile = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.file), ''), SourceLine = iff(isnotempty(todynamic(sourceLocation)), tostring(sourceLocation.line), ''), ReceiveTimestamp = receiveTimestamp, ClusterName = tostring(resource.labels.cluster_name), ComponentLocation = tostring(resource.labels.component_location), ComponentName = tostring(resource.labels.component_name), Location = tostring(resource.labels.location), ProjectID = tostring(resource.labels.project_id), ComputeResourceName = tostring(labels['compute.googleapis.com/resource_name']), VMName = tostring(jsonPayload.instance.vm_name), Zone = tostring(jsonPayload.instance.zone), ActuationLatencySeconds = todouble(jsonPayload.finalRecommendation.actuationLatencySeconds), ActuationTime = todatetime(jsonPayload.finalRecommendation.actuationTime), ConfiguredSize = toint(jsonPayload.finalRecommendation.configuredSize), HPA = tostring(jsonPayload.finalRecommendation.hpa), LeadingMetricIndex = toint(jsonPayload.finalRecommendation.leadingMetricIndex), Replicas = toint(jsonPayload.finalRecommendation.replicas), StartTime = todatetime(jsonPayload.finalRecommendation.startTime),TargetRefkind = jsonPayload['finalRecommendation']['targetRef']['kind'],TargetRefAPIVersion = tostring(jsonPayload.finalRecommendation.targetRef.apiVersion), TargetRefName = tostring(jsonPayload.finalRecommendation.targetRef.name), TopLevelLimit = tostring(jsonPayload.finalRecommendation.topLevelLimit), TopLevelOverride = tostring(jsonPayload.finalRecommendation.topLevelOverride), ResourceType = tostring(resource.type)| project-away jsonPayload, sourceLocation, resource, labels,Labels,Message",
                    "outputStream": "Microsoft-GKEHPADecision"
                },
                {
                    "streams": [
                        "Custom-GKEApplicationLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | where logName has 'stderr' or logName has 'stdout' | extend TimeGenerated = timestamp, InsertId = tostring(insertId), LogName = tostring(logName), Labels = todynamic(labels), Severity = tostring(severity), ReceiveTimestamp = receiveTimestamp, ClusterName = tostring(resource.labels.cluster_name), NamespaceName = tostring(resource.labels.namespace_name), PodName = tostring(resource.labels.pod_name), Location = tostring(resource.labels.location), ContainerName = tostring(resource.labels.container_name), JsonPayload = todynamic(jsonPayload),TextPayload = tostring(textPayload), ProjectID = tostring(resource.labels.project_id), ComputeResourceName = tostring(labels['compute.googleapis.com/resource_name']) | project-away resource, labels,  insertId, logName, receiveTimestamp, severity, timestamp, Labels, jsonPayload,textPayload",
                    "outputStream": "Microsoft-GKEApplication"
                }
            ]
        }
    }
]