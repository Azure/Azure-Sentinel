{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft",
    "comments": "Solution template for SAP BTP"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "SAP BTP Activity",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "_solutionName": "SAP BTP",
    "_solutionVersion": "3.0.11",
    "solutionId": "sentinel4sap.sap_btp_sentinel_solution",
    "_solutionId": "[variables('solutionId')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "SAPBTPActivity",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.0",
      "_analyticRulecontentId1": "8a3b5c7d-9e1f-4a2b-8c6d-3e5f7a9b1c2d",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8a3b5c7d-9e1f-4a2b-8c6d-3e5f7a9b1c2d')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8a3b5c7d-9e1f-4a2b-8c6d-3e5f7a9b1c2d')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8a3b5c7d-9e1f-4a2b-8c6d-3e5f7a9b1c2d','-', '1.0.0')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.0",
      "_analyticRulecontentId2": "3f8a2c5e-7b9d-4e1a-8f6c-2d4b9a1e3c7f",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3f8a2c5e-7b9d-4e1a-8f6c-2d4b9a1e3c7f')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3f8a2c5e-7b9d-4e1a-8f6c-2d4b9a1e3c7f')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3f8a2c5e-7b9d-4e1a-8f6c-2d4b9a1e3c7f','-', '1.0.0')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.0",
      "_analyticRulecontentId3": "9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9e6f4b2c-0d3e-5a8f-c9b7-2f5d8a1e4c6b','-', '1.0.0')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.0",
      "_analyticRulecontentId4": "a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a1b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d','-', '1.0.0')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.0",
      "_analyticRulecontentId5": "b2c3d4e5-6f7a-8b9c-0d1e-2f3a4b5c6d7e",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b2c3d4e5-6f7a-8b9c-0d1e-2f3a4b5c6d7e')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b2c3d4e5-6f7a-8b9c-0d1e-2f3a4b5c6d7e')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b2c3d4e5-6f7a-8b9c-0d1e-2f3a4b5c6d7e','-', '1.0.0')))]"
    },
    "analyticRuleObject6": {
      "analyticRuleVersion6": "1.0.0",
      "_analyticRulecontentId6": "c3d4e5f6-7a8b-9c0d-1e2f-3a4b5c6d7e8f",
      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c3d4e5f6-7a8b-9c0d-1e2f-3a4b5c6d7e8f')]",
      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c3d4e5f6-7a8b-9c0d-1e2f-3a4b5c6d7e8f')))]",
      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c3d4e5f6-7a8b-9c0d-1e2f-3a4b5c6d7e8f','-', '1.0.0')))]"
    },
    "analyticRuleObject7": {
      "analyticRuleVersion7": "1.0.0",
      "_analyticRulecontentId7": "8d5f3a1b-9c2e-4f7d-b8a6-1e4c7f9d2b5a",
      "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8d5f3a1b-9c2e-4f7d-b8a6-1e4c7f9d2b5a')]",
      "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8d5f3a1b-9c2e-4f7d-b8a6-1e4c7f9d2b5a')))]",
      "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8d5f3a1b-9c2e-4f7d-b8a6-1e4c7f9d2b5a','-', '1.0.0')))]"
    },
    "analyticRuleObject8": {
      "analyticRuleVersion8": "3.0.5",
      "_analyticRulecontentId8": "74b243a6-3046-48aa-8b03-e43b3c529cc1",
      "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '74b243a6-3046-48aa-8b03-e43b3c529cc1')]",
      "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('74b243a6-3046-48aa-8b03-e43b3c529cc1')))]",
      "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','74b243a6-3046-48aa-8b03-e43b3c529cc1','-', '3.0.5')))]"
    },
    "analyticRuleObject9": {
      "analyticRuleVersion9": "3.0.7",
      "_analyticRulecontentId9": "31997e9a-7447-47f3-8208-4f5d7efe497c",
      "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '31997e9a-7447-47f3-8208-4f5d7efe497c')]",
      "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('31997e9a-7447-47f3-8208-4f5d7efe497c')))]",
      "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','31997e9a-7447-47f3-8208-4f5d7efe497c','-', '3.0.7')))]"
    },
    "analyticRuleObject10": {
      "analyticRuleVersion10": "3.0.5",
      "_analyticRulecontentId10": "6f1e58bd-cd95-4dfb-8883-94207f30929a",
      "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6f1e58bd-cd95-4dfb-8883-94207f30929a')]",
      "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6f1e58bd-cd95-4dfb-8883-94207f30929a')))]",
      "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6f1e58bd-cd95-4dfb-8883-94207f30929a','-', '3.0.5')))]"
    },
    "analyticRuleObject11": {
      "analyticRuleVersion11": "3.0.0",
      "_analyticRulecontentId11": "a3b8e7c4-5f2d-4a1e-9c6b-8d7f3e2a1b0c",
      "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a3b8e7c4-5f2d-4a1e-9c6b-8d7f3e2a1b0c')]",
      "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a3b8e7c4-5f2d-4a1e-9c6b-8d7f3e2a1b0c')))]",
      "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a3b8e7c4-5f2d-4a1e-9c6b-8d7f3e2a1b0c','-', '3.0.0')))]"
    },
    "analyticRuleObject12": {
      "analyticRuleVersion12": "3.0.5",
      "_analyticRulecontentId12": "62357c23-ecdc-4edc-9349-8338063af1ef",
      "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '62357c23-ecdc-4edc-9349-8338063af1ef')]",
      "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('62357c23-ecdc-4edc-9349-8338063af1ef')))]",
      "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','62357c23-ecdc-4edc-9349-8338063af1ef','-', '3.0.5')))]"
    },
    "analyticRuleObject13": {
      "analyticRuleVersion13": "1.0.0",
      "_analyticRulecontentId13": "7d4e9f2a-8b1c-4a5d-9e3f-6c2b1a0d8e7f",
      "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7d4e9f2a-8b1c-4a5d-9e3f-6c2b1a0d8e7f')]",
      "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7d4e9f2a-8b1c-4a5d-9e3f-6c2b1a0d8e7f')))]",
      "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7d4e9f2a-8b1c-4a5d-9e3f-6c2b1a0d8e7f','-', '1.0.0')))]"
    },
    "analyticRuleObject14": {
      "analyticRuleVersion14": "3.0.5",
      "_analyticRulecontentId14": "5acbe4cb-a379-4acc-9ad3-28dc48ad33d3",
      "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5acbe4cb-a379-4acc-9ad3-28dc48ad33d3')]",
      "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5acbe4cb-a379-4acc-9ad3-28dc48ad33d3')))]",
      "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5acbe4cb-a379-4acc-9ad3-28dc48ad33d3','-', '3.0.5')))]"
    },
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "SAPBTPAuditEvents",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "SAPBTPAuditEventsConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "TemplateEmptyObject": "[json('{}')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "SAPBTPActivity Workbook with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "This workbook contains visualizations and insights in the SAP BTP environment."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"5fcea91d-a1e3-4f09-b39e-0fb2798357a5\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"76a8c413-8eda-4332-a363-8ab214a3ed01\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Identity Management\",\"subTarget\":\"Identity\",\"style\":\"link\"}]},\"name\":\"links - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Overview Dashboard\\r\\n\\r\\nThis dashboard provides a birds-eye view of audit log activity across BTP accounts. This is intended to show the most active accounts and event sources, and general trends in activity.\\r\\n\\r\\nModify the Time Range selector to alter the lookback period and select the Identity Management tab to see more.\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"065c5ee8-c358-49aa-b839-47da6759d71d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| make-series Trend = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| project-away UpdatedOn\\r\\n| join kind = inner (SAPBTPAuditLog_CL\\r\\n    | summarize Requests = count() by Tenant\\r\\n    ) on Tenant\\r\\n| project Tenant, Requests, Trend\\r\\n| order by Requests desc\",\"size\":1,\"title\":\"Most active accounts by events generated\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Requests\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\",\"compositeBarSettings\":{\"labelText\":\"\"}}}]},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Tenant\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where TimeGenerated >= {TimeRange:start}\\r\\n| summarize count() by Category\",\"size\":1,\"title\":\"Ingested events by audit category\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"UserAuthenticationSuccess\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\",\"size\":0,\"title\":\"Successful user sign-in activity over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"Unauthorized access attempt\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| extend (baseline) = series_decompose(Events)\\r\\n| extend (anomalies, baseline) = series_decompose_anomalies(Events, 3, -1, 'linefit')\",\"size\":0,\"title\":\"Business Application Studio sign-in: unauthorized access anomalies\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where Entities has \\\"SAP BTP\\\"\\r\\n| make-series Events = count() default = 0 on TimeGenerated from {TimeRange:start} to now() step 1d\",\"size\":0,\"title\":\"BTP Security alerts over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"group - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Identity Management\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"04187a88-ee78-4ddf-bab3-5ce201d0c3c1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Total = CREATE + UPDATE + DELETE\\r\\n| order by Total desc\",\"size\":1,\"title\":\"Top user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"Total\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}]}},\"customWidth\":\"33.3\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize count() by Tenant\",\"size\":1,\"title\":\"User account management events by subaccount\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33.3\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Events = CREATE + UPDATE + DELETE\\r\\n| order by Events asc\",\"size\":1,\"title\":\"Most rare user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"Events\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}],\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"customWidth\":\"33.3\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let user_account_changes = materialize(SAPBTPAuditLog_CL\\r\\n    | where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n    | where isnotempty(Message.object)\\r\\n    | where Message has \\\"scim user\\\"\\r\\n    | extend Attributes = parse_json(Message.attributes)\\r\\n    | mv-expand Attributes\\r\\n    | where isnotempty(Attributes.new)\\r\\n    | extend New = replace_regex(tostring(Attributes.new), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Old = replace_regex(tostring(Attributes.old), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n    | project UpdatedOn, UserName, Action, Tenant, New, Old);\\r\\nlet unpack_object = (Changes: (UpdatedOn: datetime, UserName: string, Tenant:string, Action: string, Column: string, Value: string)) {\\r\\n    Changes\\r\\n    | extend Column = parse_json(Column)\\r\\n    | evaluate bag_unpack(Column): (\\r\\n        UpdatedOn: datetime\\r\\n        , UserName: string\\r\\n        , Tenant: string\\r\\n        , Action: string\\r\\n        , Value: string\\r\\n        , userName: string\\r\\n        , active: string\\r\\n        , emails: string\\r\\n        , externalId: string\\r\\n        , id: string\\r\\n        , meta: string\\r\\n        , name: string\\r\\n        , origin: string\\r\\n        , passwordLastModified: datetime\\r\\n        , verified: string\\r\\n        , zoneid: string)\\r\\n};\\r\\nlet old_user = user_account_changes\\r\\n    | project-away New\\r\\n    | project-rename Column = Old\\r\\n    | extend Value = \\\"Old\\\"\\r\\n    | where not (Action == \\\"CREATE\\\" and Value == \\\"Old\\\");\\r\\nlet new_user = user_account_changes\\r\\n    | project-away Old\\r\\n    | project-rename Column = New\\r\\n    | extend Value = \\\"New\\\";\\r\\nunion (unpack_object(old_user)), (unpack_object(new_user))\\r\\n| where UserName !startswith \\\"sb-\\\"\\r\\n| order by UpdatedOn desc, Value asc \",\"size\":0,\"title\":\"User account management activity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true,\"labelSettings\":[{\"columnId\":\"Action\",\"label\":\"Activity\"},{\"columnId\":\"userName\",\"label\":\"Target User\"},{\"columnId\":\"active\",\"label\":\"Active\"},{\"columnId\":\"emails\",\"label\":\"Email\"},{\"columnId\":\"externalId\",\"label\":\"ExternalId\"},{\"columnId\":\"id\",\"label\":\"Id\"},{\"columnId\":\"meta\",\"label\":\"Meta\"},{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"passwordLastModified\",\"label\":\"Password Last Modified\"},{\"columnId\":\"verified\",\"label\":\"Verified\"},{\"columnId\":\"zoneid\",\"label\":\"Zone Id\"}]}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has_any (\\\"xs_rolecollection2user\\\", \\\"xsrolecollection2role\\\", \\\"xsrolecollections\\\")\\r\\n| where UserName != \\\"client/hcp_onboarding\\\"\\r\\n| extend ChangeId = parse_json(tostring(parse_json(Message.object).id))\\r\\n| evaluate bag_unpack(ChangeId)\\r\\n| project-away TimeGenerated, Message, MessageUuid, OrgId, SpaceId, AlsServiceId, Category, Type, TenantId, _ResourceId\\r\\n| project-reorder UpdatedOn, UserName\",\"size\":0,\"title\":\"Security role collection management events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"creationTimestamp\",\"formatter\":5},{\"columnMatch\":\"onBehalfOf\",\"formatter\":5}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"crudType\",\"label\":\"Activity\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"rolecollection_identity_zone_id\",\"label\":\"Identity Zone\"},{\"columnId\":\"rolecollection_name\",\"label\":\"Role Collection Name\"},{\"columnId\":\"tableName\",\"label\":\"Activity\"},{\"columnId\":\"user_id\",\"label\":\"Target User\"}]}},\"name\":\"query - 2\"}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Identity\"},\"name\":\"group - identity\"}],\"isLocked\":true,\"fromTemplateId\":\"sentinel-SAPBTPActivity\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=SAPBTPActivity; logoFileName=SAPBTP.svg; description=This workbook contains visualizations and insights in the SAP BTP environment.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=SAP BTP Activity; templateRelativePath=SAPBTPActivity.json; subtitle=; provider=Microsoft}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "SAPBTPAuditLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "SAPBTPAuditLog",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Audit log service unavailable_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies SAP BTP subaccounts that have not reported audit logs for an unusual period.\nThis could indicate that the audit log service has been disabled or tampered with,\npotentially by an attacker attempting to hide malicious activity. It may also indicate\nservice key expiry or SAP BTP service availability problems.",
                "displayName": "BTP - Audit log service unavailable",
                "enabled": false,
                "query": "// Configure the detection threshold (in minutes) - adjust based on your environment\nlet detection_threshold_in_minutes = 60;\n// Lookback period to identify known subaccounts\nlet lookback = 7d;\n// Get all known subaccounts and their last log time\nlet last_activity = SAPBTPAuditLog_CL\n    | where TimeGenerated > ago(lookback)\n    | summarize LastLogTime = max(TimeGenerated) by SubaccountName, Tenant;\n// Identify subaccounts with no recent activity exceeding the threshold\nlast_activity\n| where datetime_diff('minute', now(), LastLogTime) > detection_threshold_in_minutes\n| extend TimeSinceLastLog = datetime_diff('minute', now(), LastLogTime)\n| project \n    SubaccountName,\n    Tenant,\n    LastLogTime,\n    TimeSinceLastLog,\n    CloudApp = \"SAP BTP\"\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "P7D",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "subTechniques": [
                  "T1562.008"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "AlertPerResult"
                },
                "customDetails": {
                  "TimeSinceLastLog": "TimeSinceLastLog",
                  "LastLogTime": "LastLogTime",
                  "Tenant": "Tenant",
                  "SubaccountName": "SubaccountName"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "The SAP BTP subaccount '{{SubaccountName}}' has not reported any audit logs since {{LastLogTime}}.\n\nTime without logs: {{TimeSinceLastLog}} minutes\n\nThis could indicate:\n- Audit log service has been disabled (potential compromise to hide malicious activity)\n- Data connector authentication or connectivity issues\n- SAP BTP service availability problems\n\nRecommended actions:\n1. Verify the audit log service status in SAP BTP cockpit\n2. Check the data connector health in Microsoft Sentinel\n3. Review any recent administrative changes to the subaccount\n4. Investigate for potential unauthorized access or configuration changes\n",
                  "alertDisplayNameFormat": "SAP BTP: No audit logs received from {{SubaccountName}} for {{TimeSinceLastLog}} minutes"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Audit log service unavailable",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Identity Service application configuration monitor_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies CRUD operations on Application (SSO Domain/Service Provider) configurations\nwithin SAP Cloud Identity Service. This includes both SAML 2.0 and OpenID Connect applications.\nUnauthorized application creation could indicate an attacker establishing persistent access\nthrough a rogue federated application.",
                "displayName": "BTP - Cloud Identity Service application configuration monitor",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| extend data_s = tostring(Message.data)\n| extend \n    action = extract(@\"action=\"\"([^\"\"]+)\"\"\", 1, data_s),\n    state = extract(@\"state=\"\"([^\"\"]+)\"\"\", 1, data_s),\n    objectType = extract(@\"objectType=\"\"([^\"\"]+)\"\"\", 1, data_s),\n    serviceProviderName = extract(@\"serviceProviderName=\"\"([^\"\"]+)\"\"\", 1, data_s),\n    ipAddress = extract(@\"ipAddress=\"\"([^\"\"]+)\"\"\", 1, data_s),\n    // Extract payload JSON for federation type\n    payloadJson = extract(@\"\\{\"\"payload\"\":\\{([^}]+)\\}\\}\", 1, data_s)\n| extend federationType = extract(@\"\"\"type\"\":\"\"([^\"\"]+)\"\"\", 1, payloadJson)\n| where objectType == \"ssoDomain\"\n| where state == \"successful\"\n| where action in (\"create\", \"update\", \"delete\")\n| extend MessageText = case(\n    action == \"create\", strcat(\"Application '\", serviceProviderName, \"' (\", federationType, \") was created\"),\n    action == \"update\", strcat(\"Application '\", serviceProviderName, \"' (\", federationType, \") was updated\"),\n    action == \"delete\", strcat(\"Application '\", serviceProviderName, \"' was deleted\"),\n    \"Unclassified operation on application\"\n)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ServiceProviderName = serviceProviderName,\n    FederationType = federationType,\n    Action = action,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Identity Service\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1606",
                  "T1556",
                  "T1134"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "ServiceProviderName": "ServiceProviderName",
                  "SourceIP": "ipAddress",
                  "Action": "Action",
                  "FederationType": "FederationType"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}}. Identity provider name: {{ServiceProviderName}}\n    \nThis could indicate:\n- Legitimate administrative change to federated applications\n- Unauthorized application registration for persistent access\n- Rogue SAML/OIDC application added by attacker\n",
                  "alertDisplayNameFormat": "SAP Cloud Identity Service: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Identity Service application configuration monitor",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Integration access policy tampering_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies changes to access policies in SAP Cloud Integration. Access policies control\nauthorization for integration artifacts, defining which users and roles can access specific\nintegration flows and related content.\n\nUnauthorized access policy manipulation could indicate:\n- Attacker granting themselves access to sensitive integration artifacts\n- Removal of security controls to enable further malicious activity\n- Defense evasion by modifying artifact references to hide unauthorized access",
                "displayName": "BTP - Cloud Integration access policy tampering",
                "enabled": false,
                "query": "let accessPolicyTypes = dynamic([\"Access Policy\", \"Artifact Reference\"]);\nlet monitoredActions = dynamic([\"Create\", \"Change\", \"Delete\"]);\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId),\n         policyMessage = tostring(parsedData.attributes.message)\n| where objectType in (accessPolicyTypes)\n| where action in (monitoredActions)\n| extend normalizedAction = case(\n    action == \"Create\", \"created\",\n    action == \"Change\", \"modified\",\n    action == \"Delete\", \"deleted\",\n    action\n)\n| extend MessageText = case(\n    objectType == \"Access Policy\", strcat(\"Access policy '\", objectId, \"' was \", normalizedAction),\n    objectType == \"Artifact Reference\", strcat(\"Artifact reference '\", objectId, \"' was \", normalizedAction),\n    strcat(objectType, \" '\", objectId, \"' was \", normalizedAction)\n)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ObjectType = objectType,\n    ObjectId = objectId,\n    Action = action,\n    PolicyMessage = policyMessage,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "DefenseEvasion",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1548",
                  "T1222"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "Action": "Action",
                  "ObjectId": "ObjectId",
                  "ObjectType": "ObjectType",
                  "SourceIP": "ipAddress",
                  "PolicyMessage": "PolicyMessage"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n\nThis could indicate:\n- Legitimate access policy administration\n- Unauthorized privilege escalation attempt\n- Attacker modifying security controls to access sensitive integrations\n",
                  "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Integration access policy tampering",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Integration artifact deployment_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies deployment and undeployment of integration artifacts in SAP Cloud Integration.\nIntegration flows are executable code that can process, transform, and route data between\nsystems.\n\nUnauthorized artifact deployment could indicate:\n- Attacker deploying malicious integration flows for data exfiltration\n- Deployment of rogue code for persistent access\n- Undeployment of critical integrations causing denial of service",
                "displayName": "BTP - Cloud Integration artifact deployment",
                "enabled": false,
                "query": "let deploymentActions = dynamic([\"Deploy_of_Artifact_Initiated\", \"Deploy_of_Artifact_Completed\", \"Undeploy_of_artifact_triggered\"]);\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId)\n| where action in (deploymentActions)\n| extend normalizedAction = case(\n    action == \"Deploy_of_Artifact_Initiated\", \"deployment initiated\",\n    action == \"Deploy_of_Artifact_Completed\", \"deployed\",\n    action == \"Undeploy_of_artifact_triggered\", \"undeployed\",\n    action\n),\nactionCategory = case(\n    action startswith \"Deploy\", \"Deploy\",\n    action startswith \"Undeploy\", \"Undeploy\",\n    \"Unknown\"\n)\n| extend MessageText = strcat(objectType, \" '\", objectId, \"' was \", normalizedAction)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ArtifactType = objectType,\n    ArtifactId = objectId,\n    Action = action,\n    ActionCategory = actionCategory,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Execution",
                  "Persistence"
                ],
                "techniques": [
                  "T1059",
                  "T1546"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "ArtifactId": "ArtifactId",
                  "Action": "Action",
                  "ActionCategory": "ActionCategory",
                  "SourceIP": "ipAddress",
                  "ArtifactType": "ArtifactType"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n\nArtifact type: {{ArtifactType}}\n\nThis could indicate:\n- Legitimate integration artifact deployment or maintenance\n- Unauthorized deployment of malicious integration code\n- Attacker undeploying security-relevant integrations\n",
                  "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Integration artifact deployment",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Integration JDBC data source changes_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies deployment and undeployment of JDBC data source configurations in SAP Cloud Integration.\nJDBC data sources contain database connection credentials and configuration that enable\nintegration flows to access backend databases.\n\nUnauthorized JDBC data source manipulation could indicate:\n- Attacker adding rogue database connections for data exfiltration\n- Credential theft by accessing stored database passwords\n- Modification of connection strings to redirect traffic to attacker-controlled systems",
                "displayName": "BTP - Cloud Integration JDBC data source changes",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId)\n| where objectType == \"Data Source\"\n| where action in (\"PasswordStore\", \"PasswordDelete\")\n| extend normalizedAction = case(\n    action == \"PasswordStore\", \"deployed\",\n    action == \"PasswordDelete\", \"undeployed\",\n    action\n)\n| extend MessageText = strcat(\"JDBC data source '\", objectId, \"' was \", normalizedAction)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    DataSourceName = objectId,\n    Action = action,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "LateralMovement"
                ],
                "techniques": [
                  "T1552",
                  "T1021"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "DataSourceName": "DataSourceName",
                  "Action": "Action",
                  "SourceIP": "ipAddress"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n\nJDBC data sources contain database connection credentials. Changes to these configurations\nshould be carefully reviewed.\n\nThis could indicate:\n- Legitimate database configuration management\n- Unauthorized database connection configuration\n- Attacker establishing lateral movement paths to backend systems\n",
                  "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Integration JDBC data source changes",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Integration package import or transport_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies import and transport operations for integration packages and artifacts in\nSAP Cloud Integration. Packages contain integration flows, mappings, scripts, and other\nartifacts that can be imported from external sources or transported between tenants.\n\nUnauthorized package operations could indicate:\n- Supply chain attack through malicious package import\n- Lateral movement between environments via artifact transport\n- Introduction of backdoors or rogue integration logic",
                "displayName": "BTP - Cloud Integration package import or transport",
                "enabled": false,
                "query": "let packageActions = dynamic([\"Package_Import_Started\", \"Package_Import_Completed\", \"Package_Transport_Started\", \"Package_Transport_Completed\", \"Artifact_Transport_Started\", \"Artifact_Transport_Completed\"]);\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId)\n| where action in (packageActions)\n| extend operationType = case(\n    action contains \"Import\", \"Import\",\n    action contains \"Transport\", \"Transport\",\n    \"Unknown\"\n),\noperationStatus = case(\n    action endswith \"Started\", \"Started\",\n    action endswith \"Completed\", \"Completed\",\n    \"Unknown\"\n)\n| extend MessageText = strcat(objectType, \" '\", objectId, \"' \", tolower(operationType), \" \", tolower(operationStatus))\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ObjectType = objectType,\n    ObjectId = objectId,\n    Action = action,\n    OperationType = operationType,\n    OperationStatus = operationStatus,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "InitialAccess",
                  "Persistence"
                ],
                "techniques": [
                  "T1195",
                  "T1546"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "Action": "Action",
                  "ObjectType": "ObjectType",
                  "OperationType": "OperationType",
                  "ObjectId": "ObjectId",
                  "SourceIP": "ipAddress",
                  "OperationStatus": "OperationStatus"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n\nThis could indicate:\n- Legitimate package management and deployment\n- Import of malicious integration content from untrusted sources\n- Unauthorized transport of artifacts between environments\n",
                  "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 6",
                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Integration package import or transport",
        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Cloud Integration tampering with security material_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies operations on security material (credentials, certificates, and keys) within SAP Cloud Integration.\nThis includes credentials (passwords/secrets), X.509 certificates and key pairs, and PGP keys.\nUnauthorized manipulation of security material could indicate an attacker attempting to:\n- Gain access to external systems using stored credentials\n- Intercept or tamper with encrypted communications\n- Establish persistence through certificate manipulation\n- Cover tracks by deleting security artifacts",
                "displayName": "BTP - Cloud Integration tampering with security material",
                "enabled": false,
                "query": "let securityMaterialTypes = dynamic([\"Credential\", \"X.509 Certificate\", \"X.509 Key-Pair\", \"PGP Public Keys\", \"PGP Secret Keys\"]);\nlet keystoreActions = dynamic([\"Create\", \"Update\", \"Change\", \"Delete\"]);\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\"\n| extend data_s = tostring(Message.data),\n         ipAddress = tostring(Message.ip)\n| extend parsedData = parse_json(data_s)\n| extend action = tostring(parsedData.action),\n         objectType = tostring(parsedData.objectType),\n         objectId = tostring(parsedData.objectId),\n         keystoreName = tostring(parsedData.attributes[\"Keystore Name\"])\n| where objectType in (securityMaterialTypes)\n| where \n    (objectType == \"Credential\" and action in (\"PasswordStore\", \"PasswordUpdate\", \"PasswordDelete\"))\n    or \n    (objectType != \"Credential\" and action in (keystoreActions))\n| extend normalizedAction = case(\n    action == \"PasswordStore\", \"created\",\n    action == \"PasswordUpdate\", \"updated\",\n    action == \"PasswordDelete\", \"deleted\",\n    action == \"Create\", \"created\",\n    action == \"Update\", \"updated\",\n    action == \"Change\", \"changed\",\n    action == \"Delete\", \"deleted\",\n    action\n)\n| extend MessageText = case(\n    objectType == \"Credential\", strcat(\"Security credential '\", objectId, \"' was \", normalizedAction),\n    isnotempty(keystoreName), strcat(objectType, \" '\", objectId, \"' was \", normalizedAction, \" in keystore '\", keystoreName, \"'\"),\n    strcat(objectType, \" '\", objectId, \"' was \", normalizedAction)\n)\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    ObjectType = objectType,\n    ObjectId = objectId,\n    Action = action,\n    NormalizedAction = normalizedAction,\n    KeystoreName = keystoreName,\n    Tenant,\n    ipAddress,\n    CloudApp = \"SAP Cloud Integration\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1552",
                  "T1070"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "customDetails": {
                  "SourceIP": "ipAddress",
                  "Action": "Action",
                  "ObjectId": "ObjectId",
                  "ObjectType": "ObjectType",
                  "KeystoreName": "KeystoreName"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}} from IP {{ipAddress}}.\n    \nThis could indicate:\n- Legitimate security material management\n- Unauthorized credential or certificate manipulation\n- Attacker tampering with security artifacts to gain access or cover tracks\n",
                  "alertDisplayNameFormat": "SAP Cloud Integration: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 7",
                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Cloud Integration tampering with security material",
        "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
        "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Failed access attempts across multiple BAS subaccounts_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies failed Business Application Studio access attempts over a predefined number of subaccounts.",
                "displayName": "BTP - Failed access attempts across multiple BAS subaccounts",
                "enabled": false,
                "query": "let subaccount_detection_threshold = 3;\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\" and Message has \"Unauthorized access attempt\"\n| summarize Start=min(UpdatedOn), End=max(UpdatedOn), Tenants = make_set(Tenant, 100) by UserName\n| where array_length(Tenants) > subaccount_detection_threshold\n| project Start, End, UserName, Tenants, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Reconnaissance",
                  "Discovery"
                ],
                "techniques": [
                  "T1595",
                  "T1526"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{UserName}} attempted, and failed, to log into multiple Business Application Studio dev spaces. Tenants accessed: {{Tenants}}",
                  "alertDisplayNameFormat": "BTP - Unauthorized access attempt to multiple tenants"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 8",
                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Failed access attempts across multiple BAS subaccounts",
        "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
        "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Malware detected in BAS dev space_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies instances of malware detected using SAP internal malware agent within Business Application Studio dev spaces.",
                "displayName": "BTP - Malware detected in BAS dev space",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| where Message has \"malware\"\n| extend MessageData = parse_json(tostring(Message.data))\n| extend\n    ClusterID = tostring(MessageData.clusterID),\n    WorkspaceID = tostring(MessageData.wsID),\n    Message = tostring(MessageData.message)\n| parse Message with * 'user: ' User '.The following issues were detected: ' Malware ',' *\n| extend\n    AccountName = tostring(split(User, '@')[0]),\n    UPNSuffix = tostring(split(User, '@')[1])\n| project\n    UpdatedOn,\n    ClusterID,\n    WorkspaceID,\n    Message,\n    User,\n    Malware,\n    Tenant,\n    SpaceId,\n    Category,\n    CloudApp = \"SAP BTP\",\n    AccountName,\n    UPNSuffix\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "ResourceDevelopment",
                  "Execution",
                  "Persistence"
                ],
                "techniques": [
                  "T1584",
                  "T1072",
                  "T0873"
                ],
                "entityMappings": [
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  },
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "Malware",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "Malware"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "Malware was found in the following subaccount: {{Tenant}}",
                  "alertDisplayNameFormat": "BTP - Malware detected in Business Apps Studio dev space"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 9",
                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Malware detected in BAS dev space",
        "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
        "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Mass user deletion in a sub account_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies user account deletion activity where the amount of deleted users exceeds a predefined threshold.",
                "displayName": "BTP - Mass user deletion in a sub account",
                "enabled": false,
                "query": "let bulk_delete_threshold = 10;\nSAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| where Message.object has \"scim user\" and Message.object has \"DELETE\"\n| mv-expand Attributes = Message.attributes\n| where isnotempty(Attributes.old)\n| extend DeletedUserName = tostring(parse_json(tostring(Attributes.old)).userName)\n| where isnotempty(DeletedUserName)\n| summarize\n    Start = min(UpdatedOn),\n    End = max(UpdatedOn),\n    DeletedUsers = make_set(DeletedUserName, 100)\n    by UserName, Tenant, SpaceId\n| where array_length(DeletedUsers) > bulk_delete_threshold\n| project Start, End, UserName, DeletedUsers, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1531",
                  "T1485",
                  "T1489",
                  "T0813",
                  "T0826",
                  "T0827"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 10",
                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Mass user deletion in a sub account",
        "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
        "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Mass user deletion in Cloud Identity Service_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies mass user deletion activity in SAP Cloud Identity Service where the amount of deleted users exceeds a predefined threshold.",
                "displayName": "BTP - Mass user deletion in SAP Cloud Identity Service",
                "enabled": false,
                "query": "let bulk_delete_threshold = 10;\nSAPBTPAuditLog_CL\n| extend data_s = tostring(Message.data)\n| extend action = extract(@\"action=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         objectType = extract(@\"objectType=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         impactedUser = extract(@\"serviceProviderName=\"\"([^\"\"]+)\"\"\", 1, data_s)\n| where action == \"delete\"\n| where objectType == \"authorization\"\n| where isnotempty(impactedUser)\n| summarize\n    Start = min(UpdatedOn),\n    End = max(UpdatedOn),\n    DeleteCount = count(),\n    DeletedUsers = make_set(impactedUser, 100)\n    by UserName, Tenant, SpaceId\n| where array_length(DeletedUsers) > bulk_delete_threshold\n| project Start, End, UserName, DeletedUsers, DeleteCount, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "Impact"
                ],
                "techniques": [
                  "T1531",
                  "T1485",
                  "T1489",
                  "T0813",
                  "T0826",
                  "T0827"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 11",
                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Mass user deletion in SAP Cloud Identity Service",
        "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
        "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - Trust and authorization Identity Provider monitor_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies CRUD operations on Identity Provider settings within a sub account.",
                "displayName": "BTP - Trust and authorization Identity Provider monitor",
                "enabled": false,
                "query": "SAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| extend Object = Message.object, Attributes = Message.attributes\n| where Object.type == \"IdentityProvider\"\n| extend CrudType = tostring(parse_json(tostring(Object.id)).crudType)\n| mv-expand Attributes\n| extend MessageText = case(\n                           CrudType == \"CREATE\",\n                           \"An identity provider was created\",\n                           CrudType == \"UPDATE\",\n                           \"An identity provider was updated\",\n                           CrudType == \"DELETE\",\n                           \"An identity provider was deleted\",\n                           \"Unclassified CRUD operation encountered\"\n                       )\n| extend NewAttributes = parse_json(replace_regex(tostring(Attributes.new), \"\\\\r\", \"\"))\n| extend OldAttributes = parse_json(replace_regex(tostring(Attributes.old), \"\\\\r\", \"\"))\n| extend IdentityProviderName = case(\n                                    CrudType == \"CREATE\" or CrudType == \"UPDATE\",\n                                    NewAttributes.name,\n                                    CrudType == \"DELETE\",\n                                    OldAttributes.name,\n                                    \"Unknown\"\n                                )\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    IdentityProviderName,\n    Tenant,\n    SpaceId,\n    CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "CredentialAccess",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T1606",
                  "T1556",
                  "T1134"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDescriptionFormat": "{{MessageText}} by {{UserName}}. Identity provider name: {{IdentityProviderName}}",
                  "alertDisplayNameFormat": "SAP BTP: {{MessageText}}"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 12",
                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - Trust and authorization Identity Provider monitor",
        "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
        "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - User added to privileged Administrators list_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies when a user is granted privileged administrator permissions in SAP Cloud Identity Service. These permissions include managing Identity Providers, Service Providers, Users, Groups, and Access controls.",
                "displayName": "BTP - User added to Cloud Identity Service privileged Administrators list",
                "enabled": false,
                "query": "let monitored_permissions = dynamic([\"ManageIdP\", \"ManageSP\", \"ManageUsers\", \"ReadUsers\", \"ManageAccess\", \"ManageGroups\"]);\nSAPBTPAuditLog_CL\n| extend data_s = tostring(Message.data)\n| extend action = extract(@\"action=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         state = extract(@\"state=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         changedAttribute = extract(@\"changedAttribute=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         newValue = extract(@\"newValue=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         targetUser = extract(@\"userIdentifier=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         callerMail = extract(@\"callerMail=\"\"([^\"\"]+)\"\"\", 1, data_s),\n         ipAddress = extract(@\"ipAddress=\"\"([^\"\"]+)\"\"\", 1, data_s)\n| where action == \"grantPermissions\"\n| where state == \"successful\"\n| where changedAttribute == \"authorizations\"\n| where isnotempty(newValue)\n| mv-expand permission = monitored_permissions\n| where newValue contains tostring(permission)\n| summarize \n    GrantedPermissions = make_set(newValue, 10),\n    MatchedPermissions = make_set(tostring(permission), 10)\n    by UpdatedOn, UserName, callerMail, targetUser, Tenant, ipAddress\n| project UpdatedOn, UserName, callerMail, targetUser, GrantedPermissions, MatchedPermissions, Tenant, ipAddress, CloudApp = \"SAP Cloud Identity Service\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "LateralMovement",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T0859",
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  },
                  {
                    "entityType": "IP",
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipAddress"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 13",
                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - User added to Cloud Identity Service privileged Administrators list",
        "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
        "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "BTP - User added to sensitive privileged role collection_AnalyticalRules Analytics Rule with template version 3.0.11",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Identifies identity management actions whereby a user is added to a set of monitored privileged role collections.",
                "displayName": "BTP - User added to sensitive privileged role collection",
                "enabled": false,
                "query": "let monitored_rolecollections = dynamic([\"Subaccount Service Administrator\", \"Subaccount Administrator\", \"Connectivity and Destination Administrator\", \"Destination Administrator\", \"Cloud Connector Administrator\"]);\nSAPBTPAuditLog_CL\n| where Message.object has \"xs_rolecollection2user\"\n| extend ObjectId = parse_json((Message.object).id)\n| where ObjectId.crudType == \"CREATE\"\n| extend RoleCollection = ObjectId.rolecollection_name, TargetUserId = ObjectId.user_id\n| where RoleCollection in (monitored_rolecollections)\n| project UpdatedOn, UserName, RoleCollection, TargetUserId, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "connectorId": "SAPBTPAuditEvents",
                    "dataTypes": [
                      "SAPBTPAuditLog_CL"
                    ]
                  }
                ],
                "tactics": [
                  "LateralMovement",
                  "PrivilegeEscalation"
                ],
                "techniques": [
                  "T0859",
                  "T1078"
                ],
                "entityMappings": [
                  {
                    "entityType": "Account",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "AccountName"
                      },
                      {
                        "identifier": "UPNSuffix",
                        "columnName": "UPNSuffix"
                      }
                    ]
                  },
                  {
                    "entityType": "CloudApplication",
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "CloudApp"
                      }
                    ]
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
              "properties": {
                "description": "SAP BTP Analytics Rule 14",
                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                "source": {
                  "kind": "Solution",
                  "name": "SAP BTP",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
        "contentKind": "AnalyticsRule",
        "displayName": "BTP - User added to sensitive privileged role collection",
        "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
        "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "SAP BTP",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "title": "SAP BTP",
                  "logo": "SapLogo.svg",
                  "id": "SAPBTPAuditEvents",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
                  "graphQueriesTableName": "SAPBTPAuditLog_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total events received",
                      "legend": "BTP Events",
                      "baseQuery": "{{graphQueriesTableName}}"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample of BTP Events",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "availability": {
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Client Id and Client Secret for Audit Retrieval API",
                        "description": "Enable API access in BTP."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "**Step 1 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Add a connection for each subaccount."
                    },
                    {
                      "description": "Connect using OAuth client credentials",
                      "title": "Connect events from SAP BTP to Microsoft Sentinel",
                      "instructions": [
                        {
                          "type": "ContextPane",
                          "parameters": {
                            "contextPaneType": "DataConnectorsContextPane",
                            "label": "Add account",
                            "isPrimary": true,
                            "title": "BTP connection",
                            "instructionSteps": [
                              {
                                "title": "Account Details",
                                "instructions": [
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Subaccount name (e.g. Contoso). This will be projected to the InstanceName column.",
                                      "placeholder": "no space or special character allowed!",
                                      "type": "text",
                                      "name": "subaccountName"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Subaccount ID",
                                      "placeholder": "Subaccount GUID taken from service key subaccountid property.",
                                      "type": "text",
                                      "name": "subaccountId"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "SAP BTP Client ID",
                                      "placeholder": "Client ID",
                                      "type": "text",
                                      "name": "clientId"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "SAP BTP Client Secret",
                                      "placeholder": "Client Secret",
                                      "type": "password",
                                      "name": "clientSecret"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Authorization server URL (UAA server)",
                                      "placeholder": "https://your-tenant.authentication.region.hana.ondemand.com",
                                      "type": "text",
                                      "name": "authServerUrl"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Audit Retrieval API URL",
                                      "placeholder": "https://auditlog-management.cfapps.region.hana.ondemand.com",
                                      "type": "text",
                                      "name": "auditHost"
                                    }
                                  }
                                ]
                              },
                              {
                                "title": "Advanced",
                                "instructions": [
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Polling Frequency (minutes, 1-15)",
                                      "placeholder": "1",
                                      "type": "text",
                                      "description": "Frequency to poll for new BTP audit logs.",
                                      "name": "pollingFrequencyMinutes",
                                      "defaultValue": "1"
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Log Ingest Delay (minutes, 1-120)",
                                      "placeholder": "20",
                                      "type": "text",
                                      "description": "Delay to account for SAP BTP audit logs published late.",
                                      "name": "ingestDelayMinutes",
                                      "defaultValue": "20"
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      ]
                    },
                    {
                      "title": "Subaccounts",
                      "description": "Each row represents a connected subaccount",
                      "instructions": [
                        {
                          "type": "DataConnectorsGrid",
                          "parameters": {
                            "mapping": [
                              {
                                "columnName": "Subaccount Name",
                                "columnValue": "properties.addOnAttributes.SubaccountName"
                              },
                              {
                                "columnName": "Subaccount ID",
                                "columnValue": "name"
                              }
                            ],
                            "menuItems": [
                              "DeleteConnector"
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "SAP-BTP-DCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "streamDeclarations": {
                  "Custom-SAPBTPAuditLog_CL": {
                    "columns": [
                      {
                        "name": "SubaccountName",
                        "type": "string"
                      },
                      {
                        "name": "message_uuid",
                        "type": "string"
                      },
                      {
                        "name": "time",
                        "type": "datetime"
                      },
                      {
                        "name": "tenant",
                        "type": "string"
                      },
                      {
                        "name": "org_id",
                        "type": "string"
                      },
                      {
                        "name": "space_id",
                        "type": "string"
                      },
                      {
                        "name": "app_or_service_id",
                        "type": "string"
                      },
                      {
                        "name": "als_service_id",
                        "type": "string"
                      },
                      {
                        "name": "user",
                        "type": "string"
                      },
                      {
                        "name": "category",
                        "type": "string"
                      },
                      {
                        "name": "format_version",
                        "type": "string"
                      },
                      {
                        "name": "message",
                        "type": "string"
                      }
                    ]
                  }
                },
                "dataSources": "[variables('TemplateEmptyObject')]",
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-SAPBTPAuditLog_CL"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source| extend TimeGenerated = now()| extend MessageUuid = tostring(message_uuid), UpdatedOn = todatetime(['time']), Tenant = tostring(tenant), OrgId = tostring(org_id), SpaceId = tostring(space_id), AlsServiceId = tostring(app_or_service_id), Category = tostring(category), Message = parse_json(message), UserName = tostring(user)| project TimeGenerated, SubaccountName, UserName, Message, UpdatedOn, MessageUuid, Tenant, OrgId, SpaceId, AlsServiceId, Category",
                    "outputStream": "Custom-SAPBTPAuditLog_CL"
                  }
                ],
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]"
              }
            },
            {
              "name": "SAPBTPAuditLog_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "SAPBTPAuditLog_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "UserName",
                      "type": "string"
                    },
                    {
                      "name": "Message",
                      "type": "dynamic"
                    },
                    {
                      "name": "UpdatedOn",
                      "type": "datetime"
                    },
                    {
                      "name": "SubaccountName",
                      "type": "string"
                    },
                    {
                      "name": "MessageUuid",
                      "type": "string"
                    },
                    {
                      "name": "Tenant",
                      "type": "string"
                    },
                    {
                      "name": "OrgId",
                      "type": "string"
                    },
                    {
                      "name": "SpaceId",
                      "type": "string"
                    },
                    {
                      "name": "AlsServiceId",
                      "type": "string"
                    },
                    {
                      "name": "Category",
                      "type": "string"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "title": "SAP BTP",
          "logo": "SapLogo.svg",
          "id": "SAPBTPAuditEvents",
          "publisher": "Microsoft",
          "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
          "graphQueriesTableName": "SAPBTPAuditLog_CL",
          "graphQueries": [
            {
              "metricName": "Total events received",
              "legend": "BTP Events",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample of BTP Events",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "availability": {
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Client Id and Client Secret for Audit Retrieval API",
                "description": "Enable API access in BTP."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "**Step 1 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Add a connection for each subaccount."
            },
            {
              "description": "Connect using OAuth client credentials",
              "title": "Connect events from SAP BTP to Microsoft Sentinel",
              "instructions": [
                {
                  "type": "ContextPane",
                  "parameters": {
                    "contextPaneType": "DataConnectorsContextPane",
                    "label": "Add account",
                    "isPrimary": true,
                    "title": "BTP connection",
                    "instructionSteps": [
                      {
                        "title": "Account Details",
                        "instructions": [
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Subaccount name (e.g. Contoso). This will be projected to the InstanceName column.",
                              "placeholder": "no space or special character allowed!",
                              "type": "text",
                              "name": "subaccountName"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Subaccount ID",
                              "placeholder": "Subaccount GUID taken from service key subaccountid property.",
                              "type": "text",
                              "name": "subaccountId"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "SAP BTP Client ID",
                              "placeholder": "Client ID",
                              "type": "text",
                              "name": "clientId"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "SAP BTP Client Secret",
                              "placeholder": "Client Secret",
                              "type": "password",
                              "name": "clientSecret"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Authorization server URL (UAA server)",
                              "placeholder": "https://your-tenant.authentication.region.hana.ondemand.com",
                              "type": "text",
                              "name": "authServerUrl"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Audit Retrieval API URL",
                              "placeholder": "https://auditlog-management.cfapps.region.hana.ondemand.com",
                              "type": "text",
                              "name": "auditHost"
                            }
                          }
                        ]
                      },
                      {
                        "title": "Advanced",
                        "instructions": [
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Polling Frequency (minutes, 1-15)",
                              "placeholder": "1",
                              "type": "text",
                              "description": "Frequency to poll for new BTP audit logs.",
                              "name": "pollingFrequencyMinutes",
                              "defaultValue": "1"
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Log Ingest Delay (minutes, 1-120)",
                              "placeholder": "20",
                              "type": "text",
                              "description": "Delay to account for SAP BTP audit logs published late.",
                              "name": "ingestDelayMinutes",
                              "defaultValue": "20"
                            }
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            },
            {
              "title": "Subaccounts",
              "description": "Each row represents a connected subaccount",
              "instructions": [
                {
                  "type": "DataConnectorsGrid",
                  "parameters": {
                    "mapping": [
                      {
                        "columnName": "Subaccount Name",
                        "columnValue": "properties.addOnAttributes.SubaccountName"
                      },
                      {
                        "columnName": "Subaccount ID",
                        "columnValue": "name"
                      }
                    ],
                    "menuItems": [
                      "DeleteConnector"
                    ]
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "SAP BTP",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "SAP BTP",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "subaccountName": {
              "defaultValue": "subaccountName",
              "type": "securestring",
              "minLength": 1
            },
            "subaccountId": {
              "defaultValue": "subaccountId",
              "type": "securestring",
              "minLength": 1
            },
            "clientId": {
              "defaultValue": "clientId",
              "type": "securestring",
              "minLength": 1
            },
            "clientSecret": {
              "defaultValue": "clientSecret",
              "type": "securestring",
              "minLength": 1
            },
            "authServerUrl": {
              "defaultValue": "authServerUrl",
              "type": "securestring",
              "minLength": 1
            },
            "auditHost": {
              "defaultValue": "auditHost",
              "type": "securestring",
              "minLength": 1
            },
            "pollingFrequencyMinutes": {
              "defaultValue": "pollingFrequencyMinutes",
              "type": "securestring",
              "minLength": 1
            },
            "ingestDelayMinutes": {
              "defaultValue": "ingestDelayMinutes",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'), '/Microsoft.SecurityInsights', '/', parameters('subaccountId'), parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "SAPBTPAuditEvents",
                "dcrConfig": {
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                  "streamName": "Custom-SAPBTPAuditLog_CL"
                },
                "dataType": "SAPBTPAuditLog_CL",
                "addOnAttributes": {
                  "SubaccountName": "[[parameters('subaccountName')]"
                },
                "auth": {
                  "type": "OAuth2",
                  "ClientSecret": "[[parameters('ClientSecret')]",
                  "ClientId": "[[parameters('ClientId')]",
                  "GrantType": "client_credentials",
                  "TokenEndpoint": "[[concat(parameters('authServerUrl'), '/oauth/token?grant_type=client_credentials')]",
                  "TokenEndpointHeaders": {
                    "Content-Type": "application/x-www-form-urlencoded"
                  }
                },
                "request": {
                  "apiEndpoint": "[[concat(parameters('auditHost'), '/auditlog/v2/auditlogrecords')]",
                  "httpMethod": "Get",
                  "queryWindowInMin": "[[int(parameters('pollingFrequencyMinutes'))]",
                  "queryWindowDelayInMin": "[[int(parameters('ingestDelayMinutes'))]",
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss.fff",
                  "retryCount": 3,
                  "timeoutInSeconds": 120,
                  "startTimeAttributeName": "time_from",
                  "endTimeAttributeName": "time_to",
                  "headers": {
                    "Accept": "application/json",
                    "User-Agent": "Scuba"
                  }
                },
                "response": {
                  "eventsJsonPaths": [
                    "$"
                  ]
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageTokenResponseHeader": "paging",
                  "nextPageParaName": "handle",
                  "tokenTransform": {
                    "TransformType": "SplitOnDelimiter",
                    "SliceDelimiter": "=",
                    "StringIndex": 1
                  }
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.11",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "SAP BTP",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/SAP%20BTP/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>SAP Business Technology Platform (BTP) is an infrastructure that allows SAP customers to build no-code/low-code custom apps integrating to SAP and third-party applications and datasets in order to achieve better business value by streamlining user's activities and interactions with the organization's business applications.</p>\n<p>The BTP Solution for Microsoft Sentinel will collect audits and activity logs from the BTP infrastructure and BTP based apps, and will detect threats, suspicious activities, illegitimate activities, and more.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 14</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/SAPBTP.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "SAP BTP",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
              "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
              "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
              "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
              "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
              "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
              "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
              "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
              "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2023-04-04",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Application",
            "Cloud Provider"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
