{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "author": "Microsoft",
        "comments": "Solution template for SAP BTP"
    },
    "parameters": {
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "workbook1-name": {
            "type": "string",
            "defaultValue": "SAP BTP Activity",
            "minLength": 1,
            "metadata": {
                "description": "Name for the workbook"
            }
        },
        "resourceGroupName": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "resource group name where Microsoft Sentinel is setup"
            }
        },
        "subscription": {
            "type": "string",
            "defaultValue": "[last(split(subscription().id, '/'))]",
            "metadata": {
                "description": "subscription id where Microsoft Sentinel is setup"
            }
        }
    },
    "variables": {
        "_solutionName": "SAP BTP",
        "_solutionVersion": "3.0.8",
        "solutionId": "sentinel4sap.sap_btp_sentinel_solution",
        "_solutionId": "[variables('solutionId')]",
        "workbookVersion1": "1.0.0",
        "workbookContentId1": "SAPBTPActivity",
        "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
        "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
        "_workbookContentId1": "[variables('workbookContentId1')]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
        "analyticRuleObject1": {
            "analyticRuleVersion1": "3.0.5",
            "_analyticRulecontentId1": "74b243a6-3046-48aa-8b03-e43b3c529cc1",
            "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '74b243a6-3046-48aa-8b03-e43b3c529cc1')]",
            "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('74b243a6-3046-48aa-8b03-e43b3c529cc1')))]",
            "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','74b243a6-3046-48aa-8b03-e43b3c529cc1','-', '3.0.5')))]"
        },
        "analyticRuleObject2": {
            "analyticRuleVersion2": "3.0.7",
            "_analyticRulecontentId2": "31997e9a-7447-47f3-8208-4f5d7efe497c",
            "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '31997e9a-7447-47f3-8208-4f5d7efe497c')]",
            "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('31997e9a-7447-47f3-8208-4f5d7efe497c')))]",
            "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','31997e9a-7447-47f3-8208-4f5d7efe497c','-', '3.0.7')))]"
        },
        "analyticRuleObject3": {
            "analyticRuleVersion3": "3.0.5",
            "_analyticRulecontentId3": "6f1e58bd-cd95-4dfb-8883-94207f30929a",
            "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6f1e58bd-cd95-4dfb-8883-94207f30929a')]",
            "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6f1e58bd-cd95-4dfb-8883-94207f30929a')))]",
            "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6f1e58bd-cd95-4dfb-8883-94207f30929a','-', '3.0.5')))]"
        },
        "analyticRuleObject4": {
            "analyticRuleVersion4": "3.0.5",
            "_analyticRulecontentId4": "62357c23-ecdc-4edc-9349-8338063af1ef",
            "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '62357c23-ecdc-4edc-9349-8338063af1ef')]",
            "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('62357c23-ecdc-4edc-9349-8338063af1ef')))]",
            "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','62357c23-ecdc-4edc-9349-8338063af1ef','-', '3.0.5')))]"
        },
        "analyticRuleObject5": {
            "analyticRuleVersion5": "3.0.5",
            "_analyticRulecontentId5": "5acbe4cb-a379-4acc-9ad3-28dc48ad33d3",
            "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5acbe4cb-a379-4acc-9ad3-28dc48ad33d3')]",
            "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5acbe4cb-a379-4acc-9ad3-28dc48ad33d3')))]",
            "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5acbe4cb-a379-4acc-9ad3-28dc48ad33d3','-', '3.0.5')))]"
        },
        "dataConnectorCCPVersion": "1.0.0",
        "_dataConnectorContentIdConnectorDefinition1": "SAPBTPAuditEvents",
        "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
        "_dataConnectorContentIdConnections1": "SAPBTPAuditEventsConnections",
        "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
        "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
        "blanks": "[replace('b', 'b', '')]",
        "TemplateEmptyObject": "[json('{}')]",
        "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('workbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPBTPActivity Workbook with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('workbookVersion1')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "[variables('workbookContentId1')]",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "This workbook contains visualizations and insights in the SAP BTP environment."
                            },
                            "properties": {
                                "displayName": "[parameters('workbook1-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"5fcea91d-a1e3-4f09-b39e-0fb2798357a5\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"Overview\",\"style\":\"link\"},{\"id\":\"76a8c413-8eda-4332-a363-8ab214a3ed01\",\"cellValue\":\"setTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Identity Management\",\"subTarget\":\"Identity\",\"style\":\"link\"}]},\"name\":\"links - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Overview Dashboard\\r\\n\\r\\nThis dashboard provides a birds-eye view of audit log activity across BTP accounts. This is intended to show the most active accounts and event sources, and general trends in activity.\\r\\n\\r\\nModify the Time Range selector to alter the lookback period and select the Identity Management tab to see more.\"},\"name\":\"text - 4\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"065c5ee8-c358-49aa-b839-47da6759d71d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| make-series Trend = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| project-away UpdatedOn\\r\\n| join kind = inner (SAPBTPAuditLog_CL\\r\\n    | summarize Requests = count() by Tenant\\r\\n    ) on Tenant\\r\\n| project Tenant, Requests, Trend\\r\\n| order by Requests desc\",\"size\":1,\"title\":\"Most active accounts by events generated\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Requests\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"blue\",\"compositeBarSettings\":{\"labelText\":\"\"}}}]},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Tenant\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where TimeGenerated >= {TimeRange:start}\\r\\n| summarize count() by Category\",\"size\":1,\"title\":\"Ingested events by audit category\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"UserAuthenticationSuccess\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\",\"size\":0,\"title\":\"Successful user sign-in activity over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where Category == \\\"audit.security-events\\\"\\r\\n| where Message has \\\"Unauthorized access attempt\\\"\\r\\n| make-series Events = count() default = 0 on UpdatedOn from {TimeRange:start} to now() step 1d by Tenant\\r\\n| extend (baseline) = series_decompose(Events)\\r\\n| extend (anomalies, baseline) = series_decompose_anomalies(Events, 3, -1, 'linefit')\",\"size\":0,\"title\":\"Business Application Studio sign-in: unauthorized access anomalies\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"customWidth\":\"50\",\"name\":\"query - 5\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where Entities has \\\"SAP BTP\\\"\\r\\n| make-series Events = count() default = 0 on TimeGenerated from {TimeRange:start} to now() step 1d\",\"size\":0,\"title\":\"BTP Security alerts over time\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"query - 6\",\"styleSettings\":{\"margin\":\"10px\",\"padding\":\"10px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Overview\"},\"name\":\"group - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# BTP Identity Management\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"04187a88-ee78-4ddf-bab3-5ce201d0c3c1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Total = CREATE + UPDATE + DELETE\\r\\n| order by Total desc\",\"size\":1,\"title\":\"Top user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"Total\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}]}},\"customWidth\":\"33.3\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn >= {TimeRange:start}\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize count() by Tenant\",\"size\":1,\"title\":\"User account management events by subaccount\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33.3\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has \\\"scim user\\\"\\r\\n| extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n| summarize Events = count() by UserName, Action\\r\\n| evaluate pivot(Action, sum(Events)) : (UserName:string, CREATE:int, UPDATE:int, DELETE:int)\\r\\n| extend Events = CREATE + UPDATE + DELETE\\r\\n| order by Events asc\",\"size\":1,\"title\":\"Most rare user account management events by user\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CREATE\",\"formatter\":5},{\"columnMatch\":\"UPDATE\",\"formatter\":5},{\"columnMatch\":\"DELETE\",\"formatter\":5},{\"columnMatch\":\"Events\",\"formatter\":22,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"CREATE\",\"color\":\"green\"},{\"columnName\":\"UPDATE\",\"color\":\"blue\"},{\"columnName\":\"DELETE\",\"color\":\"orange\"}]}}}],\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"$gen_compositeBar_Events_4\",\"sortOrder\":1}]},\"customWidth\":\"33.3\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let user_account_changes = materialize(SAPBTPAuditLog_CL\\r\\n    | where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n    | where isnotempty(Message.object)\\r\\n    | where Message has \\\"scim user\\\"\\r\\n    | extend Attributes = parse_json(Message.attributes)\\r\\n    | mv-expand Attributes\\r\\n    | where isnotempty(Attributes.new)\\r\\n    | extend New = replace_regex(tostring(Attributes.new), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Old = replace_regex(tostring(Attributes.old), \\\"\\\\\\\\r\\\", \\\"\\\")\\r\\n    | extend Action = tostring(parse_json(tostring(parse_json(tostring(Message.object)).id)).crudType)\\r\\n    | project UpdatedOn, UserName, Action, Tenant, New, Old);\\r\\nlet unpack_object = (Changes: (UpdatedOn: datetime, UserName: string, Tenant:string, Action: string, Column: string, Value: string)) {\\r\\n    Changes\\r\\n    | extend Column = parse_json(Column)\\r\\n    | evaluate bag_unpack(Column): (\\r\\n        UpdatedOn: datetime\\r\\n        , UserName: string\\r\\n        , Tenant: string\\r\\n        , Action: string\\r\\n        , Value: string\\r\\n        , userName: string\\r\\n        , active: string\\r\\n        , emails: string\\r\\n        , externalId: string\\r\\n        , id: string\\r\\n        , meta: string\\r\\n        , name: string\\r\\n        , origin: string\\r\\n        , passwordLastModified: datetime\\r\\n        , verified: string\\r\\n        , zoneid: string)\\r\\n};\\r\\nlet old_user = user_account_changes\\r\\n    | project-away New\\r\\n    | project-rename Column = Old\\r\\n    | extend Value = \\\"Old\\\"\\r\\n    | where not (Action == \\\"CREATE\\\" and Value == \\\"Old\\\");\\r\\nlet new_user = user_account_changes\\r\\n    | project-away Old\\r\\n    | project-rename Column = New\\r\\n    | extend Value = \\\"New\\\";\\r\\nunion (unpack_object(old_user)), (unpack_object(new_user))\\r\\n| where UserName !startswith \\\"sb-\\\"\\r\\n| order by UpdatedOn desc, Value asc \",\"size\":0,\"title\":\"User account management activity\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true,\"labelSettings\":[{\"columnId\":\"Action\",\"label\":\"Activity\"},{\"columnId\":\"userName\",\"label\":\"Target User\"},{\"columnId\":\"active\",\"label\":\"Active\"},{\"columnId\":\"emails\",\"label\":\"Email\"},{\"columnId\":\"externalId\",\"label\":\"ExternalId\"},{\"columnId\":\"id\",\"label\":\"Id\"},{\"columnId\":\"meta\",\"label\":\"Meta\"},{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"passwordLastModified\",\"label\":\"Password Last Modified\"},{\"columnId\":\"verified\",\"label\":\"Verified\"},{\"columnId\":\"zoneid\",\"label\":\"Zone Id\"}]}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPBTPAuditLog_CL\\r\\n| where UpdatedOn between ({TimeRange:start} .. {TimeRange:end})\\r\\n| where Message has_any (\\\"xs_rolecollection2user\\\", \\\"xsrolecollection2role\\\", \\\"xsrolecollections\\\")\\r\\n| where UserName != \\\"client/hcp_onboarding\\\"\\r\\n| extend ChangeId = parse_json(tostring(parse_json(Message.object).id))\\r\\n| evaluate bag_unpack(ChangeId)\\r\\n| project-away TimeGenerated, Message, MessageUuid, OrgId, SpaceId, AlsServiceId, Category, Type, TenantId, _ResourceId\\r\\n| project-reorder UpdatedOn, UserName\",\"size\":0,\"title\":\"Security role collection management events\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"creationTimestamp\",\"formatter\":5},{\"columnMatch\":\"onBehalfOf\",\"formatter\":5}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"crudType\",\"label\":\"Activity\"},{\"columnId\":\"origin\",\"label\":\"Origin\"},{\"columnId\":\"rolecollection_identity_zone_id\",\"label\":\"Identity Zone\"},{\"columnId\":\"rolecollection_name\",\"label\":\"Role Collection Name\"},{\"columnId\":\"tableName\",\"label\":\"Activity\"},{\"columnId\":\"user_id\",\"label\":\"Target User\"}]}},\"name\":\"query - 2\"}]},\"conditionalVisibility\":{\"parameterName\":\"setTab\",\"comparison\":\"isEqualTo\",\"value\":\"Identity\"},\"name\":\"group - identity\"}],\"isLocked\":true,\"fromTemplateId\":\"sentinel-SAPBTPActivity\"}\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=SAPBTPActivity; logoFileName=SAPBTP.svg; description=This workbook contains visualizations and insights in the SAP BTP environment.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=SAP BTP Activity; templateRelativePath=SAPBTPActivity.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId1')]",
                                "contentId": "[variables('_workbookContentId1')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "SAPBTPAuditLog_CL",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "SAPBTPAuditLog",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_workbookContentId1')]",
                "contentKind": "Workbook",
                "displayName": "[parameters('workbook1-name')]",
                "contentProductId": "[variables('_workbookcontentProductId1')]",
                "id": "[variables('_workbookcontentProductId1')]",
                "version": "[variables('workbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "BTP - Failed access attempts across multiple BAS subaccounts_AnalyticalRules Analytics Rule with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies failed Business Application Studio access attempts over a predefined number of subaccounts.",
                                "displayName": "BTP - Failed access attempts across multiple BAS subaccounts",
                                "enabled": false,
                                "query": "let subaccount_detection_threshold = 3;\nSAPBTPAuditLog_CL\n| where Category == \"audit.security-events\" and Message has \"Unauthorized access attempt\"\n| summarize Start=min(UpdatedOn), End=max(UpdatedOn), Tenants = make_set(Tenant, 100) by UserName\n| where array_length(Tenants) > subaccount_detection_threshold\n| project Start, End, UserName, Tenants, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAPBTPAuditEvents",
                                        "dataTypes": [
                                            "SAPBTPAuditLog_CL"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Reconnaissance",
                                    "Discovery"
                                ],
                                "techniques": [
                                    "T1595",
                                    "T1526"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "AccountName",
                                                "identifier": "Name"
                                            },
                                            {
                                                "columnName": "UPNSuffix",
                                                "identifier": "UPNSuffix"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "CloudApplication",
                                        "fieldMappings": [
                                            {
                                                "columnName": "CloudApp",
                                                "identifier": "Name"
                                            }
                                        ]
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{UserName}} attempted, and failed, to log into multiple Business Application Studio dev spaces. Tenants accessed: {{Tenants}}",
                                    "alertDisplayNameFormat": "BTP - Unauthorized access attempt to multiple tenants"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
                            "properties": {
                                "description": "SAP BTP Analytics Rule 1",
                                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "contentKind": "AnalyticsRule",
                "displayName": "BTP - Failed access attempts across multiple BAS subaccounts",
                "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "BTP - Malware detected in BAS dev space_AnalyticalRules Analytics Rule with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies instances of malware detected using SAP internal malware agent within Business Application Studio dev spaces.",
                                "displayName": "BTP - Malware detected in BAS dev space",
                                "enabled": false,
                                "query": "SAPBTPAuditLog_CL\n| where Message has \"malware\"\n| extend MessageData = parse_json(tostring(Message.data))\n| extend\n    ClusterID = tostring(MessageData.clusterID),\n    WorkspaceID = tostring(MessageData.wsID),\n    Message = tostring(MessageData.message)\n| parse Message with * 'user: ' User '.The following issues were detected: ' Malware ',' *\n| extend\n    AccountName = tostring(split(User, '@')[0]),\n    UPNSuffix = tostring(split(User, '@')[1])\n| project\n    UpdatedOn,\n    ClusterID,\n    WorkspaceID,\n    Message,\n    User,\n    Malware,\n    Tenant,\n    SpaceId,\n    Category,\n    CloudApp = \"SAP BTP\",\n    AccountName,\n    UPNSuffix\n",
                                "queryFrequency": "PT15M",
                                "queryPeriod": "PT15M",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAPBTPAuditEvents",
                                        "dataTypes": [
                                            "SAPBTPAuditLog_CL"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "ResourceDevelopment",
                                    "Execution",
                                    "Persistence"
                                ],
                                "techniques": [
                                    "T1584",
                                    "T1072",
                                    "T0873"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "CloudApplication",
                                        "fieldMappings": [
                                            {
                                                "columnName": "CloudApp",
                                                "identifier": "Name"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "AccountName",
                                                "identifier": "Name"
                                            },
                                            {
                                                "columnName": "UPNSuffix",
                                                "identifier": "UPNSuffix"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "Malware",
                                        "fieldMappings": [
                                            {
                                                "columnName": "Malware",
                                                "identifier": "Name"
                                            }
                                        ]
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Malware was found in the following subaccount: {{Tenant}}",
                                    "alertDisplayNameFormat": "BTP - Malware detected in Business Apps Studio dev space"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
                            "properties": {
                                "description": "SAP BTP Analytics Rule 2",
                                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "contentKind": "AnalyticsRule",
                "displayName": "BTP - Malware detected in BAS dev space",
                "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "BTP - Mass user deletion in a sub account_AnalyticalRules Analytics Rule with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies user account deletion activity where the amount of deleted users exceeds a predefined threshold.",
                                "displayName": "BTP - Mass user deletion in a sub account",
                                "enabled": false,
                                "query": "let bulk_delete_threshold = 10;\nSAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| where Message.object has \"scim user\" and Message.object has \"DELETE\"\n| mv-expand Attributes = Message.attributes\n| where isnotempty(Attributes.old)\n| extend DeletedUserName = tostring(parse_json(tostring(Attributes.old)).userName)\n| where isnotempty(DeletedUserName)\n| summarize\n    Start = min(UpdatedOn),\n    End = max(UpdatedOn),\n    DeletedUsers = make_set(DeletedUserName, 100)\n    by UserName, Tenant, SpaceId\n| where array_length(DeletedUsers) > bulk_delete_threshold\n| project Start, End, UserName, DeletedUsers, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAPBTPAuditEvents",
                                        "dataTypes": [
                                            "SAPBTPAuditLog_CL"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact"
                                ],
                                "techniques": [
                                    "T1531",
                                    "T1485",
                                    "T1489",
                                    "T0813",
                                    "T0826",
                                    "T0827"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "AccountName",
                                                "identifier": "Name"
                                            },
                                            {
                                                "columnName": "UPNSuffix",
                                                "identifier": "UPNSuffix"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "CloudApplication",
                                        "fieldMappings": [
                                            {
                                                "columnName": "CloudApp",
                                                "identifier": "Name"
                                            }
                                        ]
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
                            "properties": {
                                "description": "SAP BTP Analytics Rule 3",
                                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "contentKind": "AnalyticsRule",
                "displayName": "BTP - Mass user deletion in a sub account",
                "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "BTP - Trust and authorization Identity Provider monitor_AnalyticalRules Analytics Rule with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies CRUD operations on Identity Provider settings within a sub account.",
                                "displayName": "BTP - Trust and authorization Identity Provider monitor",
                                "enabled": false,
                                "query": "SAPBTPAuditLog_CL\n| where isnotnull(Message.object)\n| extend Object = Message.object, Attributes = Message.attributes\n| where Object.type == \"IdentityProvider\"\n| extend CrudType = tostring(parse_json(tostring(Object.id)).crudType)\n| mv-expand Attributes\n| extend MessageText = case(\n                           CrudType == \"CREATE\",\n                           \"An identity provider was created\",\n                           CrudType == \"UPDATE\",\n                           \"An identity provider was updated\",\n                           CrudType == \"DELETE\",\n                           \"An identity provider was deleted\",\n                           \"Unclassified CRUD operation encountered\"\n                       )\n| extend NewAttributes = parse_json(replace_regex(tostring(Attributes.new), \"\\\\r\", \"\"))\n| extend OldAttributes = parse_json(replace_regex(tostring(Attributes.old), \"\\\\r\", \"\"))\n| extend IdentityProviderName = case(\n                                    CrudType == \"CREATE\" or CrudType == \"UPDATE\",\n                                    NewAttributes.name,\n                                    CrudType == \"DELETE\",\n                                    OldAttributes.name,\n                                    \"Unknown\"\n                                )\n| project\n    UpdatedOn,\n    UserName,\n    MessageText,\n    IdentityProviderName,\n    Tenant,\n    SpaceId,\n    CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                                "queryFrequency": "PT15M",
                                "queryPeriod": "PT15M",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAPBTPAuditEvents",
                                        "dataTypes": [
                                            "SAPBTPAuditLog_CL"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess",
                                    "PrivilegeEscalation"
                                ],
                                "techniques": [
                                    "T1606",
                                    "T1556",
                                    "T1134"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "AccountName",
                                                "identifier": "Name"
                                            },
                                            {
                                                "columnName": "UPNSuffix",
                                                "identifier": "UPNSuffix"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "CloudApplication",
                                        "fieldMappings": [
                                            {
                                                "columnName": "CloudApp",
                                                "identifier": "Name"
                                            }
                                        ]
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{MessageText}} by {{UserName}}. Identity provider name: {{IdentityProviderName}}",
                                    "alertDisplayNameFormat": "SAP BTP: {{MessageText}}"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
                            "properties": {
                                "description": "SAP BTP Analytics Rule 4",
                                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "contentKind": "AnalyticsRule",
                "displayName": "BTP - Trust and authorization Identity Provider monitor",
                "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "BTP - User added to sensitive privileged role collection_AnalyticalRules Analytics Rule with template version 3.0.8",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                            "apiVersion": "2023-02-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies identity management actions whereby a user is added to a set of monitored privileged role collections.",
                                "displayName": "BTP - User added to sensitive privileged role collection",
                                "enabled": false,
                                "query": "let monitored_rolecollections = dynamic([\"Subaccount Service Administrator\", \"Subaccount Administrator\", \"Connectivity and Destination Administrator\", \"Destination Administrator\", \"Cloud Connector Administrator\"]);\nSAPBTPAuditLog_CL\n| where Message.object has \"xs_rolecollection2user\"\n| extend ObjectId = parse_json((Message.object).id)\n| where ObjectId.crudType == \"CREATE\"\n| extend RoleCollection = ObjectId.rolecollection_name, TargetUserId = ObjectId.user_id\n| where RoleCollection in (monitored_rolecollections)\n| project UpdatedOn, UserName, RoleCollection, TargetUserId, Tenant, SpaceId, CloudApp = \"SAP BTP\"\n| extend AccountName = split(UserName, \"@\")[0], UPNSuffix = split(UserName, \"@\")[1]\n",
                                "queryFrequency": "PT15M",
                                "queryPeriod": "PT15M",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAPBTPAuditEvents",
                                        "dataTypes": [
                                            "SAPBTPAuditLog_CL"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "LateralMovement",
                                    "PrivilegeEscalation"
                                ],
                                "techniques": [
                                    "T0859",
                                    "T1078"
                                ],
                                "entityMappings": [
                                    {
                                        "entityType": "Account",
                                        "fieldMappings": [
                                            {
                                                "columnName": "AccountName",
                                                "identifier": "Name"
                                            },
                                            {
                                                "columnName": "UPNSuffix",
                                                "identifier": "UPNSuffix"
                                            }
                                        ]
                                    },
                                    {
                                        "entityType": "CloudApplication",
                                        "fieldMappings": [
                                            {
                                                "columnName": "CloudApp",
                                                "identifier": "Name"
                                            }
                                        ]
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
                            "properties": {
                                "description": "SAP BTP Analytics Rule 5",
                                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP BTP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "contentKind": "AnalyticsRule",
                "displayName": "BTP - User added to sensitive privileged role collection",
                "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "displayName": "SAP BTP",
                "contentKind": "DataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
                            "apiVersion": "2022-09-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
                            "location": "[parameters('workspace-location')]",
                            "kind": "Customizable",
                            "properties": {
                                "connectorUiConfig": {
                                    "title": "SAP BTP",
                                    "logo": "SapLogo.svg",
                                    "id": "SAPBTPAuditEvents",
                                    "publisher": "Microsoft",
                                    "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
                                    "graphQueriesTableName": "SAPBTPAuditLog_CL",
                                    "graphQueries": [
                                        {
                                            "metricName": "Total events received",
                                            "legend": "BTP Events",
                                            "baseQuery": "{{graphQueriesTableName}}"
                                        }
                                    ],
                                    "sampleQueries": [
                                        {
                                            "description": "Get Sample of BTP Events",
                                            "query": "{{graphQueriesTableName}}\n | take 10"
                                        }
                                    ],
                                    "dataTypes": [
                                        {
                                            "name": "{{graphQueriesTableName}}",
                                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | where name_s == \"no data test\" | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                                        }
                                    ],
                                    "connectivityCriteria": [
                                        {
                                            "type": "HasDataConnectors"
                                        }
                                    ],
                                    "availability": {
                                        "isPreview": false
                                    },
                                    "permissions": {
                                        "resourceProvider": [
                                            {
                                                "provider": "Microsoft.OperationalInsights/workspaces",
                                                "permissionsDisplayText": "Read and Write permissions are required.",
                                                "providerDisplayName": "Workspace",
                                                "scope": "Workspace",
                                                "requiredPermissions": {
                                                    "write": true,
                                                    "read": true,
                                                    "delete": true
                                                }
                                            },
                                            {
                                                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                                                "providerDisplayName": "Keys",
                                                "scope": "Workspace",
                                                "requiredPermissions": {
                                                    "action": true
                                                }
                                            }
                                        ],
                                        "customs": [
                                            {
                                                "name": "Client Id and Client Secret for Audit Retrieval API",
                                                "description": "Enable API access in BTP."
                                            }
                                        ]
                                    },
                                    "instructionSteps": [
                                        {
                                            "description": "**Step 1 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Add a connection for each subaccount."
                                        },
                                        {
                                            "description": "Connect using OAuth client credentials",
                                            "title": "Connect events from SAP BTP to Microsoft Sentinel",
                                            "instructions": [
                                                {
                                                    "type": "ContextPane",
                                                    "parameters": {
                                                        "contextPaneType": "DataConnectorsContextPane",
                                                        "label": "Add account",
                                                        "isPrimary": true,
                                                        "title": "BTP connection",
                                                        "instructionSteps": [
                                                            {
                                                                "title": "Account Details",
                                                                "instructions": [
                                                                    {
                                                                        "type": "Textbox",
                                                                        "parameters": {
                                                                            "label": "Subaccount name (e.g. Contoso). This will be projected to the InstanceName column.",
                                                                            "placeholder": "no space or special character allowed!",
                                                                            "type": "text",
                                                                            "name": "subaccountName"
                                                                        }
                                                                    },
                                                                    {
                                                                        "type": "Textbox",
                                                                        "parameters": {
                                                                            "label": "SAP BTP Client ID",
                                                                            "placeholder": "Client ID",
                                                                            "type": "text",
                                                                            "name": "clientId"
                                                                        }
                                                                    },
                                                                    {
                                                                        "type": "Textbox",
                                                                        "parameters": {
                                                                            "label": "SAP BTP Client Secret",
                                                                            "placeholder": "Client Secret",
                                                                            "type": "password",
                                                                            "name": "clientSecret"
                                                                        }
                                                                    },
                                                                    {
                                                                        "type": "Textbox",
                                                                        "parameters": {
                                                                            "label": "Authorization server URL (UAA server)",
                                                                            "placeholder": "https://your-tenant.authentication.region.hana.ondemand.com",
                                                                            "type": "text",
                                                                            "name": "authServerUrl"
                                                                        }
                                                                    },
                                                                    {
                                                                        "type": "Textbox",
                                                                        "parameters": {
                                                                            "label": "Audit Retrieval API URL",
                                                                            "placeholder": "https://auditlog-management.cfapps.region.hana.ondemand.com",
                                                                            "type": "text",
                                                                            "name": "auditHost"
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                }
                                            ]
                                        },
                                        {
                                            "title": "Subaccounts",
                                            "description": "Each row represents a connected subaccount",
                                            "instructions": [
                                                {
                                                    "type": "DataConnectorsGrid",
                                                    "parameters": {
                                                        "mapping": [
                                                            {
                                                                "columnName": "Subaccount Name",
                                                                "columnValue": "name"
                                                            }
                                                        ],
                                                        "menuItems": [
                                                            "DeleteConnector"
                                                        ]
                                                    }
                                                }
                                            ]
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorCCPVersion')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                    "criteria": [
                                        {
                                            "version": "[variables('dataConnectorCCPVersion')]",
                                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                                            "kind": "ResourcesDataConnector"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "SAP-BTP-DCR",
                            "apiVersion": "2022-06-01",
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "location": "[parameters('workspace-location')]",
                            "kind": "[variables('blanks')]",
                            "properties": {
                                "streamDeclarations": {
                                    "Custom-SAPBTPAuditLog_CL": {
                                        "columns": [
                                            {
                                                "name": "SubaccountName",
                                                "type": "string"
                                            },
                                            {
                                                "name": "message_uuid",
                                                "type": "string"
                                            },
                                            {
                                                "name": "time",
                                                "type": "datetime"
                                            },
                                            {
                                                "name": "tenant",
                                                "type": "string"
                                            },
                                            {
                                                "name": "org_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "space_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "app_or_service_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "als_service_id",
                                                "type": "string"
                                            },
                                            {
                                                "name": "user",
                                                "type": "string"
                                            },
                                            {
                                                "name": "category",
                                                "type": "string"
                                            },
                                            {
                                                "name": "format_version",
                                                "type": "string"
                                            },
                                            {
                                                "name": "message",
                                                "type": "string"
                                            }
                                        ]
                                    }
                                },
                                "dataSources": "[variables('TemplateEmptyObject')]",
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[variables('workspaceResourceId')]",
                                            "name": "clv2ws1"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Custom-SAPBTPAuditLog_CL"
                                        ],
                                        "destinations": [
                                            "clv2ws1"
                                        ],
                                        "transformKql": "source| extend TimeGenerated = now()| extend MessageUuid = tostring(message_uuid), UpdatedOn = todatetime(['time']), Tenant = tostring(tenant), OrgId = tostring(org_id), SpaceId = tostring(space_id), AlsServiceId = tostring(app_or_service_id), Category = tostring(category), Message = parse_json(message), UserName = tostring(user)| project TimeGenerated, SubaccountName, UserName, Message, UpdatedOn, MessageUuid, Tenant, OrgId, SpaceId, AlsServiceId, Category",
                                        "outputStream": "Custom-SAPBTPAuditLog_CL"
                                    }
                                ],
                                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]"
                            }
                        },
                        {
                            "name": "SAPBTPAuditLog_CL",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/tables",
                            "location": "[parameters('workspace-location')]",
                            "kind": null,
                            "properties": {
                                "schema": {
                                    "name": "SAPBTPAuditLog_CL",
                                    "columns": [
                                        {
                                            "name": "TimeGenerated",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "UserName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Message",
                                            "type": "dynamic"
                                        },
                                        {
                                            "name": "UpdatedOn",
                                            "type": "datetime"
                                        },
                                        {
                                            "name": "SubaccountName",
                                            "type": "string"
                                        },
                                        {
                                            "name": "MessageUuid",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Tenant",
                                            "type": "string"
                                        },
                                        {
                                            "name": "OrgId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "SpaceId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "AlsServiceId",
                                            "type": "string"
                                        },
                                        {
                                            "name": "Category",
                                            "type": "string"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
            "apiVersion": "2022-09-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
            "location": "[parameters('workspace-location')]",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "title": "SAP BTP",
                    "logo": "SapLogo.svg",
                    "id": "SAPBTPAuditEvents",
                    "publisher": "Microsoft",
                    "descriptionMarkdown": "SAP Business Technology Platform (SAP BTP) brings together data management, analytics, artificial intelligence, application development, automation, and integration in one, unified environment.",
                    "graphQueriesTableName": "SAPBTPAuditLog_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total events received",
                            "legend": "BTP Events",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "Get Sample of BTP Events",
                            "query": "{{graphQueriesTableName}}\n | take 10"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "{{graphQueriesTableName}}",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | where name_s == \"no data test\" | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "availability": {
                        "isPreview": false
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and Write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": true,
                                    "read": true,
                                    "delete": true
                                }
                            },
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                                "providerDisplayName": "Keys",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "action": true
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Client Id and Client Secret for Audit Retrieval API",
                                "description": "Enable API access in BTP."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "description": "**Step 1 - Configuration steps for the SAP BTP Audit Retrieval API**\n\nFollow the steps provided by SAP [see Audit Log Retrieval API for Global Accounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-for-global-accounts-in-cloud-foundry-environment/). Take a note of the **url** (Audit Retrieval API URL), **uaa.url** (User Account and Authentication Server url) and the associated **uaa.clientid**.\n\n>**NOTE:** You can onboard one or more BTP subaccounts by following the steps provided by SAP [see Audit Log Retrieval API Usage for Subaccounts in the Cloud Foundry Environment](https://help.sap.com/docs/btp/sap-business-technology-platform/audit-log-retrieval-api-usage-for-subaccounts-in-cloud-foundry-environment/). Add a connection for each subaccount."
                        },
                        {
                            "description": "Connect using OAuth client credentials",
                            "title": "Connect events from SAP BTP to Microsoft Sentinel",
                            "instructions": [
                                {
                                    "type": "ContextPane",
                                    "parameters": {
                                        "contextPaneType": "DataConnectorsContextPane",
                                        "label": "Add account",
                                        "isPrimary": true,
                                        "title": "BTP connection",
                                        "instructionSteps": [
                                            {
                                                "title": "Account Details",
                                                "instructions": [
                                                    {
                                                        "type": "Textbox",
                                                        "parameters": {
                                                            "label": "Subaccount name (e.g. Contoso). This will be projected to the InstanceName column.",
                                                            "placeholder": "no space or special character allowed!",
                                                            "type": "text",
                                                            "name": "subaccountName"
                                                        }
                                                    },
                                                    {
                                                        "type": "Textbox",
                                                        "parameters": {
                                                            "label": "SAP BTP Client ID",
                                                            "placeholder": "Client ID",
                                                            "type": "text",
                                                            "name": "clientId"
                                                        }
                                                    },
                                                    {
                                                        "type": "Textbox",
                                                        "parameters": {
                                                            "label": "SAP BTP Client Secret",
                                                            "placeholder": "Client Secret",
                                                            "type": "password",
                                                            "name": "clientSecret"
                                                        }
                                                    },
                                                    {
                                                        "type": "Textbox",
                                                        "parameters": {
                                                            "label": "Authorization server URL (UAA server)",
                                                            "placeholder": "https://your-tenant.authentication.region.hana.ondemand.com",
                                                            "type": "text",
                                                            "name": "authServerUrl"
                                                        }
                                                    },
                                                    {
                                                        "type": "Textbox",
                                                        "parameters": {
                                                            "label": "Audit Retrieval API URL",
                                                            "placeholder": "https://auditlog-management.cfapps.region.hana.ondemand.com",
                                                            "type": "text",
                                                            "name": "auditHost"
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                }
                            ]
                        },
                        {
                            "title": "Subaccounts",
                            "description": "Each row represents a connected subaccount",
                            "instructions": [
                                {
                                    "type": "DataConnectorsGrid",
                                    "parameters": {
                                        "mapping": [
                                            {
                                                "columnName": "Subaccount Name",
                                                "columnValue": "name"
                                            }
                                        ],
                                        "menuItems": [
                                            "DeleteConnector"
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
            "apiVersion": "2022-01-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                    "sourceId": "[variables('_solutionId')]",
                    "name": "[variables('_solutionName')]",
                    "kind": "Solution"
                },
                "author": {
                    "name": "Microsoft"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                    "criteria": [
                        {
                            "version": "[variables('dataConnectorCCPVersion')]",
                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                            "kind": "ResourcesDataConnector"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "displayName": "SAP BTP",
                "contentKind": "ResourcesDataConnector",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorCCPVersion')]",
                    "parameters": {
                        "connectorDefinitionName": {
                            "defaultValue": "SAP BTP",
                            "type": "string",
                            "minLength": 1
                        },
                        "workspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "string"
                        },
                        "dcrConfig": {
                            "defaultValue": {
                                "dataCollectionEndpoint": "data collection Endpoint",
                                "dataCollectionRuleImmutableId": "data collection rule immutableId"
                            },
                            "type": "object"
                        },
                        "subaccountName": {
                            "defaultValue": "subaccountName",
                            "type": "string",
                            "minLength": 1
                        },
                        "clientId": {
                            "defaultValue": "clientId",
                            "type": "string",
                            "minLength": 1
                        },
                        "clientSecret": {
                            "defaultValue": "clientSecret",
                            "type": "securestring",
                            "minLength": 1
                        },
                        "authServerUrl": {
                            "defaultValue": "authServerUrl",
                            "type": "string",
                            "minLength": 1
                        },
                        "auditHost": {
                            "defaultValue": "auditHost",
                            "type": "string",
                            "minLength": 1
                        },
                        "innerWorkspace": {
                            "defaultValue": "[parameters('workspace')]",
                            "type": "string"
                        }
                    },
                    "variables": {
                        "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]",
                        "connectorName": "[[concat('BTP_', parameters('subaccountName'))]"
                    },
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
                            "apiVersion": "2022-01-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                                "kind": "ResourcesDataConnector",
                                "version": "[variables('dataConnectorCCPVersion')]",
                                "source": {
                                    "sourceId": "[variables('_solutionId')]",
                                    "name": "[variables('_solutionName')]",
                                    "kind": "Solution"
                                },
                                "author": {
                                    "name": "Microsoft"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        },
                        {
                            "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/',variables('connectorName'))]",
                            "apiVersion": "2023-02-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "RestApiPoller",
                            "properties": {
                                "connectorDefinitionName": "SAPBTPAuditEvents",
                                "dcrConfig": {
                                    "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                    "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                                    "streamName": "Custom-SAPBTPAuditLog_CL"
                                },
                                "dataType": "SAPBTPAuditLog_CL",
                                "addOnAttributes": {
                                    "SubaccountName": "[[parameters('subaccountName')]"
                                },
                                "auth": {
                                    "type": "OAuth2",
                                    "ClientSecret": "[[parameters('ClientSecret')]",
                                    "ClientId": "[[parameters('ClientId')]",
                                    "GrantType": "client_credentials",
                                    "TokenEndpoint": "[[concat(parameters('authServerUrl'), '/oauth/token?grant_type=client_credentials')]",
                                    "TokenEndpointHeaders": {
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    }
                                },
                                "request": {
                                    "apiEndpoint": "[[concat(parameters('auditHost'), '/auditlog/v2/auditlogrecords')]",
                                    "httpMethod": "Get",
                                    "queryWindowInMin": 5,
                                    "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss.fff",
                                    "retryCount": 3,
                                    "timeoutInSeconds": 60,
                                    "startTimeAttributeName": "time_from",
                                    "endTimeAttributeName": "time_to",
                                    "headers": {
                                        "Accept": "application/json",
                                        "User-Agent": "Scuba"
                                    }
                                },
                                "response": {
                                    "eventsJsonPaths": [
                                        "$"
                                    ]
                                },
                                "paging": {
                                    "pagingType": "NextPageToken",
                                    "nextPageTokenResponseHeader": "paging",
                                    "nextPageParaName": "handle"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "version": "[variables('dataConnectorCCPVersion')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.8",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "SAP BTP",
                "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
                "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p> Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/SAP%20BTP/ReleaseNotes.md\">Release Notes</a></p>\n<p> There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>SAP Business Technology Platform (BTP) is an infrastructure that allows SAP customers to build no-code/low-code custom apps integrating to SAP and third-party applications and datasets in order to achieve better business value by streamlining user's activities and interactions with the organization's business applications.</p>\n<p>The BTP Solution for Microsoft Sentinel will collect audits and activity logs from the BTP infrastructure and BTP based apps, and will detect threats, suspicious activities, illegitimate activities, and more.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Workbooks:</strong> 1, <strong>Analytic Rules:</strong> 5</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                "contentKind": "Solution",
                "contentProductId": "[variables('_solutioncontentProductId')]",
                "id": "[variables('_solutioncontentProductId')]",
                "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/SAPBTP.svg\" width=\"75px\" height=\"75px\">",
                "contentId": "[variables('_solutionId')]",
                "parentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP BTP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft"
                },
                "support": {
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "tier": "Microsoft",
                    "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "Workbook",
                            "contentId": "[variables('_workbookContentId1')]",
                            "version": "[variables('workbookVersion1')]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                            "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                            "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                            "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                            "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                            "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                        },
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                            "version": "[variables('dataConnectorCCPVersion')]"
                        }
                    ]
                },
                "firstPublishDate": "2023-04-04",
                "providers": [
                    "Microsoft"
                ],
                "categories": {
                    "domains": [
                        "Application",
                        "Cloud Provider"
                    ]
                }
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
        }
    ],
    "outputs": {}
}