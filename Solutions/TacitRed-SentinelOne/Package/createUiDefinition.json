{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": false,
            "basics": {
                "description": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\"width=\"75px\"height=\"75px\">\n\n**Note:** Please refer to the following before installing the solution: \n\n• Review the solution [Release Notes](https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/TacitRed-SentinelOne/ReleaseNotes.md)\n\n • There may be [known issues](https://aka.ms/sentinelsolutionsknownissues) pertaining to this Solution, please refer to them before installing.\n\nThe TacitRed SentinelOne IOC Automation solution provides example playbooks that demonstrate how to consume TacitRed threat intelligence from Microsoft Sentinel and prepare indicators for ingestion into SentinelOne.\n\n**Playbooks:** 1\n\n[Learn more about Microsoft Sentinel](https://aka.ms/azuresentinel) | [Learn more about Solutions](https://aka.ms/azuresentinelsolutionsdoc)",
                "subscription": {
                    "resourceProviders": [
                        "Microsoft.OperationsManagement/solutions",
                        "Microsoft.OperationalInsights/workspaces/providers/alertRules",
                        "Microsoft.Insights/workbooks",
                        "Microsoft.Logic/workflows"
                    ]
                },
                "location": {
                    "metadata": {
                        "hidden": "Hiding location, we get it from the log analytics workspace"
                    },
                    "visible": false
                },
                "resourceGroup": {
                    "allowExisting": true
                }
            }
        },
        "basics": [
            {
                "name": "getLAWorkspace",
                "type": "Microsoft.Solutions.ArmApiControl",
                "toolTip": "This filters by workspaces that exist in the Resource Group selected",
                "condition": "[greater(length(resourceGroup().name),0)]",
                "request": {
                    "method": "GET",
                    "path": "[concat(subscription().id,'/providers/Microsoft.OperationalInsights/workspaces?api-version=2020-08-01')]"
                }
            },
            {
                "name": "workspace",
                "type": "Microsoft.Common.DropDown",
                "label": "Workspace",
                "placeholder": "Select a workspace",
                "toolTip": "This dropdown will list only workspace that exists in the Resource Group selected",
                "constraints": {
                    "allowedValues": "[map(filter(basics('getLAWorkspace').value, (filter) => contains(toLower(filter.id), toLower(resourceGroup().name))), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
                    "required": true
                },
                "visible": true
            }
        ],
        "steps": [
            {
                "name": "configuration",
                "label": "Configuration",
                "subLabel": {
                    "preValidation": "Configure API connections",
                    "postValidation": "Done"
                },
                "bladeTitle": "Configuration",
                "elements": [
                    {
                        "name": "auth-text",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "Please provide the API credentials for TacitRed and SentinelOne."
                        }
                    },
                    {
                        "name": "tacitRedApiKey",
                        "type": "Microsoft.Common.TextBox",
                        "label": "TacitRed API Key",
                        "toolTip": "Your TacitRed API Key",
                        "constraints": {
                            "required": true,
                            "regex": "^[A-Za-z0-9]+$",
                            "validationMessage": "Please enter a valid API Key (alphanumeric)."
                        },
                        "options": {
                            "secure": true
                        }
                    },
                    {
                        "name": "sentinelOneApiToken",
                        "type": "Microsoft.Common.TextBox",
                        "label": "SentinelOne API Token",
                        "toolTip": "Your SentinelOne API Token",
                        "constraints": {
                            "required": true,
                            "regex": "^[A-Za-z0-9\\-_]+$",
                            "validationMessage": "Please enter a valid API Token."
                        },
                        "options": {
                            "secure": true
                        }
                    },
                    {
                        "name": "sentinelOneBaseUrl",
                        "type": "Microsoft.Common.TextBox",
                        "label": "SentinelOne Base URL",
                        "defaultValue": "https://usea1-001.sentinelone.net",
                        "toolTip": "Your SentinelOne Console URL",
                        "constraints": {
                            "required": true,
                            "regex": "^https://[a-zA-Z0-9.-]+$",
                            "validationMessage": "Please enter a valid HTTPS URL."
                        }
                    },
                    {
                        "name": "sentinelOneAccountId",
                        "type": "Microsoft.Common.TextBox",
                        "label": "SentinelOne Account ID",
                        "toolTip": "Your SentinelOne Account ID (e.g. 2361866902403606722)",
                        "constraints": {
                            "required": true,
                            "regex": "^[0-9]+$",
                            "validationMessage": "Please enter a valid Account ID (digits only)."
                        }
                    },
                    {
                        "name": "tacitRedDomain",
                        "type": "Microsoft.Common.TextBox",
                        "label": "TacitRed Domain Filter (Optional)",
                        "defaultValue": "",
                        "toolTip": "Optional domain to filter findings",
                        "constraints": {
                            "required": false,
                            "regex": "^([a-zA-Z0-9.-]+)?$",
                            "validationMessage": "Please enter a valid domain name."
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "workspace-location": "[first(map(filter(basics('getLAWorkspace').value, (filter) => and(contains(toLower(filter.id), toLower(resourceGroup().name)),equals(filter.name,basics('workspace')))), (item) => item.location))]",
            "location": "[location()]",
            "workspace": "[basics('workspace')]",
            "TacitRed_ApiKey": "[steps('configuration').tacitRedApiKey]",
            "SentinelOne_ApiToken": "[steps('configuration').sentinelOneApiToken]",
            "SentinelOne_BaseUrl": "[steps('configuration').sentinelOneBaseUrl]",
            "SentinelOne_AccountId": "[steps('configuration').sentinelOneAccountId]",
            "TacitRed_Domain": "[steps('configuration').tacitRedDomain]"
        }
    }
}