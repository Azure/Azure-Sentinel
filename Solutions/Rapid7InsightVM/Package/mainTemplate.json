{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Rapid7InsightVM"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "solutionId": "azuresentinel.azure-sentinel-solution-rapid7insightvm",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "InsightVMCloudAPI",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "InsightVMCloudAPI",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "parserVersion1": "1.0.0",
    "parserContentId1": "InsightVMAssets-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "InsightVMAssets",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "parserVersion2": "1.0.0",
    "parserContentId2": "InsightVMVulnerabilities-Parser",
    "_parserContentId2": "[variables('parserContentId2')]",
    "parserName2": "InsightVMVulnerabilities",
    "_parserName2": "[concat(parameters('workspace'),'/',variables('parserName2'))]",
    "parserId2": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
    "_parserId2": "[variables('parserId2')]",
    "parserTemplateSpecName2": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId2')))]",
    "Rapid7InsightVMCloudAPIConnector": "Rapid7InsightVMCloudAPIConnector",
    "_Rapid7InsightVMCloudAPIConnector": "[variables('Rapid7InsightVMCloudAPIConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "Rapid7InsightVMCloudAPIConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1')))]",
    "Rapid7InsightVM-EnrichIncidentWithAssetInfo": "Rapid7InsightVM-EnrichIncidentWithAssetInfo",
    "_Rapid7InsightVM-EnrichIncidentWithAssetInfo": "[variables('Rapid7InsightVM-EnrichIncidentWithAssetInfo')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Rapid7InsightVM-EnrichIncidentWithAssetInfo",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "Rapid7InsightVM-EnrichVulnerabilityInfo": "Rapid7InsightVM-EnrichVulnerabilityInfo",
    "_Rapid7InsightVM-EnrichVulnerabilityInfo": "[variables('Rapid7InsightVM-EnrichVulnerabilityInfo')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Rapid7InsightVM-EnrichVulnerabilityInfo",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "Rapid7InsightVM-RunScan": "Rapid7InsightVM-RunScan",
    "_Rapid7InsightVM-RunScan": "[variables('Rapid7InsightVM-RunScan')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Rapid7InsightVM-RunScan",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Rapid7InsightVM data connector with template",
        "displayName": "Rapid7InsightVM template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Rapid7InsightVM data connector with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Rapid7 Insight Platform Vulnerability Management Reports (using Azure Functions)",
                  "publisher": "Rapid7",
                  "descriptionMarkdown": "The [Rapid7 Insight VM](https://www.rapid7.com/products/insightvm/) Report data connector provides the capability to ingest Scan reports and vulnerability data into Microsoft Sentinel through the REST API from the  Rapid7 Insight platform (Managed in the cloud). Refer to [API documentation](https://docs.rapid7.com/insight/api-overview/) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
                  "additionalRequirementBanner": "This data connector depends on a parsers based on a Kusto Function to work as expected [**InsightVMAssets**](https://aka.ms/sentinel-InsightVMAssets-parser) and [**InsightVMVulnerabilities**](https://aka.ms/sentinel-InsightVMVulnerabilities-parser) which is deployed with the Microsoft Sentinel Solution.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "NexposeInsightVMCloud_assets_CL",
                      "baseQuery": "NexposeInsightVMCloud_assets_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "NexposeInsightVMCloud_vulnerabilities_CL",
                      "baseQuery": "NexposeInsightVMCloud_vulnerabilities_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Insight VM Report Events - Assets information",
                      "query": "NexposeInsightVMCloud_assets_CL\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "Insight VM Report Events - Vulnerabilities information",
                      "query": "NexposeInsightVMCloud_vulnerabilities_CL\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "NexposeInsightVMCloud_assets_CL",
                      "lastDataReceivedQuery": "NexposeInsightVMCloud_assets_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "NexposeInsightVMCloud_vulnerabilities_CL",
                      "lastDataReceivedQuery": "NexposeInsightVMCloud_vulnerabilities_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "NexposeInsightVMCloud_assets_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "NexposeInsightVMCloud_vulnerabilities_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "REST API Credentials",
                        "description": "**InsightVMAPIKey** is required for REST API. [See the documentation to learn more about API](https://docs.rapid7.com/insight/api-overview/). Check all [requirements and follow  the instructions](https://docs.rapid7.com/insight/managing-platform-api-keys/) for obtaining credentials"
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Insight VM API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": ">**NOTE:** This data connector depends on a parsers based on a Kusto Function to work as expected [**InsightVMAssets**](https://aka.ms/sentinel-InsightVMAssets-parser) and [**InsightVMVulnerabilities**](https://aka.ms/sentinel-InsightVMVulnerabilities-parser) which is deployed with the Microsoft Sentinel Solution."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the Insight VM Cloud**\n\n [Follow the instructions](https://docs.rapid7.com/insight/managing-platform-api-keys/) to obtain the credentials. \n"
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Workspace data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the Rapid7 Insight Vulnerability Management Report data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-InsightVMCloudAPI-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **InsightVMAPIKey**, choose **InsightVMCloudRegion** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the Rapid7 Insight Vulnerability Management Report data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://aka.ms/sentinel-InsightVMCloudAPI-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. InsightVMXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive):  \n\t\tInsightVMAPIKey\n\t\tInsightVMCloudRegion\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Rapid7InsightVM",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Rapid7InsightVM",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Rapid7 Insight Platform Vulnerability Management Reports (using Azure Functions)",
          "publisher": "Rapid7",
          "descriptionMarkdown": "The [Rapid7 Insight VM](https://www.rapid7.com/products/insightvm/) Report data connector provides the capability to ingest Scan reports and vulnerability data into Microsoft Sentinel through the REST API from the  Rapid7 Insight platform (Managed in the cloud). Refer to [API documentation](https://docs.rapid7.com/insight/api-overview/) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "NexposeInsightVMCloud_assets_CL",
              "baseQuery": "NexposeInsightVMCloud_assets_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "NexposeInsightVMCloud_vulnerabilities_CL",
              "baseQuery": "NexposeInsightVMCloud_vulnerabilities_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "NexposeInsightVMCloud_assets_CL",
              "lastDataReceivedQuery": "NexposeInsightVMCloud_assets_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "NexposeInsightVMCloud_vulnerabilities_CL",
              "lastDataReceivedQuery": "NexposeInsightVMCloud_vulnerabilities_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "NexposeInsightVMCloud_assets_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "NexposeInsightVMCloud_vulnerabilities_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Insight VM Report Events - Assets information",
              "query": "NexposeInsightVMCloud_assets_CL\n | sort by TimeGenerated desc"
            },
            {
              "description": "Insight VM Report Events - Vulnerabilities information",
              "query": "NexposeInsightVMCloud_vulnerabilities_CL\n | sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "REST API Credentials",
                "description": "**InsightVMAPIKey** is required for REST API. [See the documentation to learn more about API](https://docs.rapid7.com/insight/api-overview/). Check all [requirements and follow  the instructions](https://docs.rapid7.com/insight/managing-platform-api-keys/) for obtaining credentials"
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Insight VM API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This data connector depends on a parsers based on a Kusto Function to work as expected [**InsightVMAssets**](https://aka.ms/sentinel-InsightVMAssets-parser) and [**InsightVMVulnerabilities**](https://aka.ms/sentinel-InsightVMVulnerabilities-parser) which is deployed with the Microsoft Sentinel Solution."
            },
            {
              "description": "**STEP 1 - Configuration steps for the Insight VM Cloud**\n\n [Follow the instructions](https://docs.rapid7.com/insight/managing-platform-api-keys/) to obtain the credentials. \n"
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Workspace data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Rapid7 Insight Vulnerability Management Report data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-InsightVMCloudAPI-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **InsightVMAPIKey**, choose **InsightVMCloudRegion** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Rapid7 Insight Vulnerability Management Report data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://aka.ms/sentinel-InsightVMCloudAPI-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. InsightVMXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive):  \n\t\tInsightVMAPIKey\n\t\tInsightVMCloudRegion\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": "This data connector depends on a parsers based on a Kusto Function to work as expected [**InsightVMAssets**](https://aka.ms/sentinel-InsightVMAssets-parser) and [**InsightVMVulnerabilities**](https://aka.ms/sentinel-InsightVMVulnerabilities-parser) which is deployed with the Microsoft Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "InsightVMAssets Data Parser with template",
        "displayName": "InsightVMAssets Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "InsightVMAssets Data Parser with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "InsightVMAssets",
                "category": "Samples",
                "functionAlias": "InsightVMAssets",
                "query": "\nlet Insight_VM_assets_view  = view () { \r\n    NexposeInsightVMCloud_assets_CL\r\n| extend packed = pack(\r\n                    \"AssessedForPolicies\", assessed_for_policies_b,\r\n                    \"AssessedForVulnerabilities\", assessed_for_vulnerabilities_b,\r\n                    \"CredentialAssessments\", credential_assessments_s,\r\n                    \"CriticalVulnerabilities\", critical_vulnerabilities_d,\r\n                    \"Exploits\", exploits_d,\r\n                    \"DvcHostname\", host_name_s,\r\n                    \"AssetId\", id_s,\r\n                    \"DvcIpAddr\", ip_s,\r\n                    \"LastAssessedForVulnerabilities\", last_assessed_for_vulnerabilities_t,\r\n                    \"LastScanEnd\", last_scan_end_t,\r\n                    \"LastScanStart\", last_scan_start_t,\r\n                    \"MalwareKits\", malware_kits_d,\r\n                    \"ModerateVulnerabilities\", moderate_vulnerabilities_d,\r\n                    \"DvcOsArch\", os_architecture_s,\r\n                    \"DvcOsDesc\", os_description_s,\r\n                    \"DvcOsFamily\", os_family_s,\r\n                    \"DvcOs\", os_name_s,\r\n                    \"DvcOsSysName\", os_system_name_s,\r\n                    \"DvcOsType\", os_type_s,\r\n                    \"DvcOsVendor\", os_vendor_s,\r\n                    \"DvcModelNumber\", os_version_s,\r\n                    \"RiskScore\", risk_score_d,\r\n                    \"SevereVulnerabilitiesCount\", severe_vulnerabilities_d,\r\n                    \"TotalVulnerabilitiesCount\", total_vulnerabilities_d,\r\n                    \"Uid\", unique_identifiers_s,\r\n                    \"VulnerabilitiesSolutions\", same_s,\r\n                    \"DvcMacAddr\", mac_s\r\n                 )\r\n| project TimeGenerated, packed\r\n| evaluate bag_unpack(packed)\r\n| extend       \r\n         EventVendor=\"Rapid7\",\r\n         EventProduct=\"Insight VM\",\r\n         EventType=\"Assets\"\r\n};\r\nInsight_VM_assets_view",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "InsightVMAssets"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Rapid7InsightVM",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "InsightVMAssets",
        "category": "Samples",
        "functionAlias": "InsightVMAssets",
        "query": "\nlet Insight_VM_assets_view  = view () { \r\n    NexposeInsightVMCloud_assets_CL\r\n| extend packed = pack(\r\n                    \"AssessedForPolicies\", assessed_for_policies_b,\r\n                    \"AssessedForVulnerabilities\", assessed_for_vulnerabilities_b,\r\n                    \"CredentialAssessments\", credential_assessments_s,\r\n                    \"CriticalVulnerabilities\", critical_vulnerabilities_d,\r\n                    \"Exploits\", exploits_d,\r\n                    \"DvcHostname\", host_name_s,\r\n                    \"AssetId\", id_s,\r\n                    \"DvcIpAddr\", ip_s,\r\n                    \"LastAssessedForVulnerabilities\", last_assessed_for_vulnerabilities_t,\r\n                    \"LastScanEnd\", last_scan_end_t,\r\n                    \"LastScanStart\", last_scan_start_t,\r\n                    \"MalwareKits\", malware_kits_d,\r\n                    \"ModerateVulnerabilities\", moderate_vulnerabilities_d,\r\n                    \"DvcOsArch\", os_architecture_s,\r\n                    \"DvcOsDesc\", os_description_s,\r\n                    \"DvcOsFamily\", os_family_s,\r\n                    \"DvcOs\", os_name_s,\r\n                    \"DvcOsSysName\", os_system_name_s,\r\n                    \"DvcOsType\", os_type_s,\r\n                    \"DvcOsVendor\", os_vendor_s,\r\n                    \"DvcModelNumber\", os_version_s,\r\n                    \"RiskScore\", risk_score_d,\r\n                    \"SevereVulnerabilitiesCount\", severe_vulnerabilities_d,\r\n                    \"TotalVulnerabilitiesCount\", total_vulnerabilities_d,\r\n                    \"Uid\", unique_identifiers_s,\r\n                    \"VulnerabilitiesSolutions\", same_s,\r\n                    \"DvcMacAddr\", mac_s\r\n                 )\r\n| project TimeGenerated, packed\r\n| evaluate bag_unpack(packed)\r\n| extend       \r\n         EventVendor=\"Rapid7\",\r\n         EventProduct=\"Insight VM\",\r\n         EventType=\"Assets\"\r\n};\r\nInsight_VM_assets_view",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Rapid7InsightVM",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('parserTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "InsightVMVulnerabilities Data Parser with template",
        "displayName": "InsightVMVulnerabilities Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('parserTemplateSpecName2'),'/',variables('parserVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "InsightVMVulnerabilities Data Parser with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName2')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "InsightVMVulnerabilities",
                "category": "Samples",
                "functionAlias": "InsightVMVulnerabilities",
                "query": "\nlet Insight_VM_vulnerabilities_view  = view () { \r\n    NexposeInsightVMCloud_vulnerabilities_CL\r\n| extend packed = pack(\r\n                     \"AssetId\", asset_id_s,\r\n                     \"DvcHostname\", host_name_s,\r\n                     \"DvcIpAddr\", ip_s,\r\n                     \"VulnDetailsAdded\", vuln_details_added_t,\r\n                     \"VulnDetailsCategories\", vuln_details_categories_s,\r\n                     \"VulnDetailsCves\", vuln_details_cves_s,\r\n                     \"VulnDetailsCvssV2AccessComplexity\", vuln_details_cvss_v2_access_complexity_s,\r\n                     \"VulnDetailsCvssV2AccessVector\", vuln_details_cvss_v2_access_vector_s,\r\n                     \"VulnDetailsCvssV2Authentication\", vuln_details_cvss_v2_authentication_s,\r\n                     \"VulnDetailsCvssV2AvailabilityImpact\", vuln_details_cvss_v2_availability_impact_s,\r\n                     \"VulnDetailsCvssV2ConfidentialityImpact\", vuln_details_cvss_v2_confidentiality_impact_s,\r\n                     \"VulnDetailsCvssV2ExploitScore\", vuln_details_cvss_v2_exploit_score_d,\r\n                     \"VulnDetailsCvssV2ImpactScore\", vuln_details_cvss_v2_impact_score_d,\r\n                     \"VulnDetailsCvssV2IntegrityImpact\", vuln_details_cvss_v2_integrity_impact_s,\r\n                     \"VulnDetailsCvssV2Score\", vuln_details_cvss_v2_score_d,\r\n                     \"VulnDetailsCvssV2Vector\", vuln_details_cvss_v2_vector_s,\r\n                     \"VulnDetailsCvssV2AttackComplexity\", vuln_details_cvss_v3_attack_complexity_s,\r\n                     \"VulnDetailsCvssV3AttackVector\", vuln_details_cvss_v3_attack_vector_s,\r\n                     \"VulnDetailsCvssV3AvailabilityImpact\", vuln_details_cvss_v3_availability_impact_s,\r\n                     \"VulnDetailsCvssV3ConfidentialityImpact\", vuln_details_cvss_v3_confidentiality_impact_s,\r\n                     \"VulnDetailsCvssV3ExploitScore\", vuln_details_cvss_v3_exploit_score_d,\r\n                     \"VulnDetailsCvssV3ImpactScore\", vuln_details_cvss_v3_impact_score_d,\r\n                     \"VulnDetailsCvssV3IntegrityImpact\", vuln_details_cvss_v3_integrity_impact_s,\r\n                     \"VulnDetailsCvssV3PrivilegesRequired\", vuln_details_cvss_v3_privileges_required_s,\r\n                     \"VulnDetailsCvssV3Scope\", vuln_details_cvss_v3_scope_s,\r\n                     \"VulnDetailsCvssV3Score\", vuln_details_cvss_v3_score_d,\r\n                     \"VulnDetailsCvssV3UserInteraction\", vuln_details_cvss_v3_user_interaction_s,\r\n                     \"VulnDetailsCvssV3Vector\", vuln_details_cvss_v3_vector_s,\r\n                     \"VulnDetailsDenialOfService\", vuln_details_denial_of_service_b,\r\n                     \"VulnDetailsDescription\", vuln_details_description_s,\r\n                     \"VulnDetailsExploits\", vuln_details_exploits_s,\r\n                     \"VulnDetailsId\", vuln_details_id_s,\r\n                     \"VulnDetailsLinks\", vuln_details_links_s,\r\n                     \"VulnDetailsMalwareKits\", vuln_details_malware_kits_s,\r\n                     \"VulnDetailsModified\", vuln_details_modified_t,\r\n                     \"VulnDetailsPciCvssScore\", vuln_details_pci_cvss_score_d,\r\n                     \"VulnDetailsPciFail\", vuln_details_pci_fail_b,\r\n                     \"VulnDetailsPciSeverityScore\", vuln_details_pci_severity_score_d,\r\n                     \"VulnDetailsPciSpecialNotes\", vuln_details_pci_special_notes_s,\r\n                     \"VulnDetailsPciStatus\", vuln_details_pci_status_s,\r\n                     \"VulnDetailsPublished\", vuln_details_published_t,\r\n                     \"VulnDetailsReferences\", vuln_details_references_s,\r\n                     \"VulnDetailsRiskScore\", vuln_details_risk_score_d,\r\n                     \"VulnDetailsSeverity\", vuln_details_severity_s,\r\n                     \"VulnDetailsSeverityScore\", vuln_details_severity_score_d,\r\n                     \"VulnDetailsTitle\", vuln_details_title_s\r\n                 )\r\n| project TimeGenerated, packed\r\n| evaluate bag_unpack(packed)\r\n| extend       \r\n         EventVendor=\"Rapid7\",\r\n         EventProduct=\"Insight VM\",\r\n         EventType=\"Vulnerabilities\"\r\n};\r\nInsight_VM_vulnerabilities_view",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "InsightVMVulnerabilities"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName2')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
                "contentId": "[variables('_parserContentId2')]",
                "kind": "Parser",
                "version": "[variables('parserVersion2')]",
                "source": {
                  "name": "Rapid7InsightVM",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName2')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "InsightVMVulnerabilities",
        "category": "Samples",
        "functionAlias": "InsightVMVulnerabilities",
        "query": "\nlet Insight_VM_vulnerabilities_view  = view () { \r\n    NexposeInsightVMCloud_vulnerabilities_CL\r\n| extend packed = pack(\r\n                     \"AssetId\", asset_id_s,\r\n                     \"DvcHostname\", host_name_s,\r\n                     \"DvcIpAddr\", ip_s,\r\n                     \"VulnDetailsAdded\", vuln_details_added_t,\r\n                     \"VulnDetailsCategories\", vuln_details_categories_s,\r\n                     \"VulnDetailsCves\", vuln_details_cves_s,\r\n                     \"VulnDetailsCvssV2AccessComplexity\", vuln_details_cvss_v2_access_complexity_s,\r\n                     \"VulnDetailsCvssV2AccessVector\", vuln_details_cvss_v2_access_vector_s,\r\n                     \"VulnDetailsCvssV2Authentication\", vuln_details_cvss_v2_authentication_s,\r\n                     \"VulnDetailsCvssV2AvailabilityImpact\", vuln_details_cvss_v2_availability_impact_s,\r\n                     \"VulnDetailsCvssV2ConfidentialityImpact\", vuln_details_cvss_v2_confidentiality_impact_s,\r\n                     \"VulnDetailsCvssV2ExploitScore\", vuln_details_cvss_v2_exploit_score_d,\r\n                     \"VulnDetailsCvssV2ImpactScore\", vuln_details_cvss_v2_impact_score_d,\r\n                     \"VulnDetailsCvssV2IntegrityImpact\", vuln_details_cvss_v2_integrity_impact_s,\r\n                     \"VulnDetailsCvssV2Score\", vuln_details_cvss_v2_score_d,\r\n                     \"VulnDetailsCvssV2Vector\", vuln_details_cvss_v2_vector_s,\r\n                     \"VulnDetailsCvssV2AttackComplexity\", vuln_details_cvss_v3_attack_complexity_s,\r\n                     \"VulnDetailsCvssV3AttackVector\", vuln_details_cvss_v3_attack_vector_s,\r\n                     \"VulnDetailsCvssV3AvailabilityImpact\", vuln_details_cvss_v3_availability_impact_s,\r\n                     \"VulnDetailsCvssV3ConfidentialityImpact\", vuln_details_cvss_v3_confidentiality_impact_s,\r\n                     \"VulnDetailsCvssV3ExploitScore\", vuln_details_cvss_v3_exploit_score_d,\r\n                     \"VulnDetailsCvssV3ImpactScore\", vuln_details_cvss_v3_impact_score_d,\r\n                     \"VulnDetailsCvssV3IntegrityImpact\", vuln_details_cvss_v3_integrity_impact_s,\r\n                     \"VulnDetailsCvssV3PrivilegesRequired\", vuln_details_cvss_v3_privileges_required_s,\r\n                     \"VulnDetailsCvssV3Scope\", vuln_details_cvss_v3_scope_s,\r\n                     \"VulnDetailsCvssV3Score\", vuln_details_cvss_v3_score_d,\r\n                     \"VulnDetailsCvssV3UserInteraction\", vuln_details_cvss_v3_user_interaction_s,\r\n                     \"VulnDetailsCvssV3Vector\", vuln_details_cvss_v3_vector_s,\r\n                     \"VulnDetailsDenialOfService\", vuln_details_denial_of_service_b,\r\n                     \"VulnDetailsDescription\", vuln_details_description_s,\r\n                     \"VulnDetailsExploits\", vuln_details_exploits_s,\r\n                     \"VulnDetailsId\", vuln_details_id_s,\r\n                     \"VulnDetailsLinks\", vuln_details_links_s,\r\n                     \"VulnDetailsMalwareKits\", vuln_details_malware_kits_s,\r\n                     \"VulnDetailsModified\", vuln_details_modified_t,\r\n                     \"VulnDetailsPciCvssScore\", vuln_details_pci_cvss_score_d,\r\n                     \"VulnDetailsPciFail\", vuln_details_pci_fail_b,\r\n                     \"VulnDetailsPciSeverityScore\", vuln_details_pci_severity_score_d,\r\n                     \"VulnDetailsPciSpecialNotes\", vuln_details_pci_special_notes_s,\r\n                     \"VulnDetailsPciStatus\", vuln_details_pci_status_s,\r\n                     \"VulnDetailsPublished\", vuln_details_published_t,\r\n                     \"VulnDetailsReferences\", vuln_details_references_s,\r\n                     \"VulnDetailsRiskScore\", vuln_details_risk_score_d,\r\n                     \"VulnDetailsSeverity\", vuln_details_severity_s,\r\n                     \"VulnDetailsSeverityScore\", vuln_details_severity_score_d,\r\n                     \"VulnDetailsTitle\", vuln_details_title_s\r\n                 )\r\n| project TimeGenerated, packed\r\n| evaluate bag_unpack(packed)\r\n| extend       \r\n         EventVendor=\"Rapid7\",\r\n         EventProduct=\"Insight VM\",\r\n         EventType=\"Vulnerabilities\"\r\n};\r\nInsight_VM_vulnerabilities_view",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId2')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
        "contentId": "[variables('_parserContentId2')]",
        "kind": "Parser",
        "version": "[variables('parserVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "Rapid7InsightVM",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "properties": {
        "description": "Rapid7InsightVMCloudAPIConnector",
        "displayName": "Rapid7InsightVMCloudAPIConnector"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Rapid7InsightVMCloudAPIConnector Playbook with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "ConnectorName": {
              "defaultValue": "Rapid7InsightVMCloud",
              "type": "String"
            },
            "Insight Platform Region": {
              "type": "string",
              "allowedValues": [
                "us",
                "eu",
                "ca",
                "au",
                "ap"
              ],
              "metadata": {
                "description": "The region indicates the geo-location of the Insight Platform."
              }
            }
          },
          "variables": {
            "api_host": "[[concat(parameters('Insight Platform Region'), '.api.insight.rapid7.com')]",
            "serviceUrl": "[[uri(concat('https://', variables('api_host')), '/vm/')]",
            "operationId-searchIntegrationAssets": "searchIntegrationAssets",
            "_operationId-searchIntegrationAssets": "[[variables('operationId-searchIntegrationAssets')]",
            "operationId-getIntegrationAsset": "getIntegrationAsset",
            "_operationId-getIntegrationAsset": "[[variables('operationId-getIntegrationAsset')]",
            "operationId-getScans": "getScans",
            "_operationId-getScans": "[[variables('operationId-getScans')]",
            "operationId-startScan": "startScan",
            "_operationId-startScan": "[[variables('operationId-startScan')]",
            "operationId-getScanEngines": "getScanEngines",
            "_operationId-getScanEngines": "[[variables('operationId-getScanEngines')]",
            "operationId-getScanEngine": "getScanEngine",
            "_operationId-getScanEngine": "[[variables('operationId-getScanEngine')]",
            "operationId-getScan": "getScan",
            "_operationId-getScan": "[[variables('operationId-getScan')]",
            "operationId-stopScan": "stopScan",
            "_operationId-stopScan": "[[variables('operationId-stopScan')]",
            "operationId-getSites": "getSites",
            "_operationId-getSites": "[[variables('operationId-getSites')]",
            "operationId-searchIntegrationVulnerabilities": "searchIntegrationVulnerabilities",
            "_operationId-searchIntegrationVulnerabilities": "[[variables('operationId-searchIntegrationVulnerabilities')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "Rapid7InsightVMCloudAPIConnector",
            "playbookId1": "[[resourceId('Microsoft.Web/customApis', parameters('ConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('ConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "api_key": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "API Key",
                      "description": "The API Key for this api",
                      "tooltip": "Provide your API Key",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  }
                },
                "brandColor": "#FFFFFF",
                "description": "Connector for Rapid7 InsightVM Cloud Integrations API",
                "displayName": "Rapid7 InsightVM Cloud Integrations",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA5gAAAH0BAMAAACqT5+GAAAAMFBMVEUYFBb////bWSqBgIDMzMxcWlvqoIfgcEkiICEzMzPo5+e4treioaJDQEHzy7zWRBGu68xdAAAU6UlEQVR4XuzRgQwAAAACsBTyl82j/QpPb5CeQKZMZCITmTKRiUxkIlMmMpGJTGTKRCYykSkTmchEJjJlIhOZyESmTGQiE5kykYlMZCJTJjKRiUxkykQmMpEpE5nIRCYyZSITmchEpkxkIhOZyJSJTGQiUyYykYlMZMpEJjKRiUyZyEQmMmUiE5nIRKZMZCITmciUiUxkIlMmMpGJTGTKRCYykYlMmchEJjJlIhOZyESmTGQiE5nIlIlMZCKTFJnIRCYyZSITmchEpkxkIhOZyJSJTGQiUyYykYlMZMpEJjKRiUyZyEQmMmUiE5nIRKZMZCITmciUiUxkIlMmMpGJTGTKRCYykYlMmePtfEPjqtIwfmEcuNlmgKFpixMtEKCBAE2CK7iqsAEWahVoyBa0dYEUWEGgpQUqCJgDnULSNFCxhRJd8HZXarJbtgNd6FaADCjoqmBxC92sAvGjgEKA7bftftJs5p25v/fPxPdj03tnzjznnPc5z/vnDH9YbndWVws3AI1ub2zpni3/WodXV+tsf+587Jb4c9ch08u/99l38FOGwfxgnmzp3hOfHfaBuTufl7asenToEnytPxx99hZNs9udD1W2PTDR690L38yUvvzUiNNGz578vgiAieNFS1l2ZeYOAKB/+aLq0cdy/lYD954ph3Oi/LOP9Hx5lmX5vWd7TuG9I257uPn6yQiYOF62LFt6xT6jGl92Q6GiX9SIZ36ldJKJz7+wDZOrMFkWZqZgaXpsfPP11/oKJs9OOTbxuzlXV1X17J5cN8vy40XvySS26rvbdnIe80CPpb93cyRkbxYBMHnxsKXaL41grnQFoKYayPP5vM6yr3uiOSzQmdw21zRvf/sOLE2XjZ/dCIDJ42VLA08zCEwwFqY0z96c11r2dqHlX6ltXvyp1nXQ+0aCaI5uhMFknhFHU25j8hdlW5tXW/Zuodyq07Z59Lhq7Cn/bTc6MBI1A5qZ5/DANoBA8MxPkzZfzpb+3R3MG51oLW1DfUU59vx4Xdq3YTQPFAEwefKypSp9A94p07TGl1+dN1jWfcc4VM69bqtffxwokMvGD0TA5PGypXcEAMAlfarBkG2S1aZgNoFmAJYfk2jOjYTRfDMCJo+XLW/Xozv4I1ZfzpYWVQRsF+zkFvdybSRusxEwebxslXp00Q+aZwJbNqnwu+mykDS0VhVLf/9mHMwHhQfMOM9g/sKv5unATNPw0ob01u6dPJ0DFchl4wcjYDLPYKtET7BLHr2B5xj73TTp38mzY959Nr7RZpGjIC/N2Noq7BI926DC77Yjp7Ip4LMuOxAEExUtXprBU397J3x5arG8OxXYydPFzvefGYnb+KwfTBiv0lrmDZyXdtyXNzvBfLQTrYUCIrk2jvUDY8X2nwCYzDPY0nKMjqa7Dv2frSa0+s4Hzsd28grss7GlyWDGYxPeINYhmgw778s/6XzgHOzkxg/YP7KjS5PBhPFq3VNsn1x0aQa8z8Y0A7aK63ASX5rZTmkGvE8yGhXNJh3fMI6U5xlccqx9jwgUJ7RZXDPwosERiWqcmDGf5TwDu12EVCCfbSjBjPMMZ7LAhP1xYppsdynPILqTZy0IarpszAtmnGdwfJlfjLkGv3aBuVjudxNqBszjwWm6bNQJZpxncEiSt8nUYsXBY1XKMwjv5FWIUPtsVgVmnGc4o1g3gUjEfTkrbjdy4RzgVGamQPs2+wLmQQIzohmwVUK+mHMNUP/nSSK36irON7bmTjCg0cIBJvOMlHVabg98MLlYNrtc1bdK0748Azn23tyNGND4Q5VtWlSgzJdncP6JDjt6KXNQmBXapc36/8z2b/VydzibkdqEcz+9/snfpUznIU4IMM/+XmWvWvbZzKcZiMhAY/XjlEPgw+7yBtGXw+RpvPhyxySTEs99kWdQegpN6//3xz99fLUHnBfKGdC4MoFyn4XPZj7N4HJd2h8vwQS1Z1afR1+OIdDGczm48nLdaigvd+TDz2UKtrBPpQBwpuZsH8C8qtLp3s9B0DPzqiXUjxj9xlN5qbQ0XO5RH8thfja+yNnB7N0ELqMsCnwjDuaQHK9Sjk/rsVPilLmuUtrwth1DBCx3U54BRWkbn+ZEsmRW1wNlug6FThhM5hltJTlNl61xaf4cjndw/K7Q5xmIQ2qBa1/GZhpnlKo5hUILL5g8XlZaF0NSRJo0+vJmV9ecl634x415BjXF2pdO8xSf/1V1R7NOMGG8ULQhweS49AJs56g5pHXlHGuJdavOMziH45arX4I5ZuE//ByDyePlfXbQsq4W7wM4Tl/+fJlbXDNqBheVSlZql6FyWgfmCQhqasFkjURaw6LnDUueOAHbJr6hrXQTbfC7HLnmpXlXqLO4XXJB4KgXTB4vL7aK4VwxUKzxwgamaSNwjJZcc29pi5+aZershpr/wIMApotn8J7FU2RQat4Vmy8fKJQSbrtE4TkmH2VOdggY0F4tK4Voy/gsgxnmGbwhs8Nbl4tVlnkC01Segdru2oSkOZXJL7NfuVtiHHTMCSaPlyP/g4bzTqvLvxUOzUCaBNOdZ5CmNA5G9mTQ8RhO6/uvE0weL4O5qGdV1W4/XSug/zOYrNXv0Z7KVvJyOntGpeRwYcMogxnlGQwmN1JqohDKvlwLZqu3wlMr1wyqqhkvBb0TuvXFpZ2FC0xWtKStQXgFBGzZCK9UNQCmueUnSsB8T6DFJICJhWQWp8DzqfvObNjBhNlJDJUrDFbkDAF4hKmhHy5RZz4xagaD+qjBIz2rh8ZLNANKnj7NYPp4BheUr+sPJrxx8uLW+onCm2eQLuuzJnb1BnPWof9wFCyL5RlwQTkocR2Rz6fgo6CxVktJnJdKXPdyeSR3Xc8sKmKVGQWgOWOKXhbVDCg53BaIuQ18A95RKLXlKtQmgPrLBzj53a/bBaD9UA1mA5MVLRZB1VIRywCMkfbDBkvcKfRAnNTTsaWeYs6oUsyLg8li2DQEtTjwKUW05e6zYWDKrv/zbHykTDMAZUPvjRaCYF63Js9mEc2AN+QFfR9Jls55wWkHsOzvgVgYsvMLscxYAOLy+Q0PmKxocUj/vHYJ13qGxeK+fKXE8d2QCk+pt12yVJdPCTCRxHBji3EXmKxosaQ1qI5LI+Fg+TytK0FPk+4eiBWI4QCYFs2gARXUAGaQZzSk2NzURpWn1QEazmjlVKMp8LsQyVWzPwEmH/y5QOW0G0wer8yb5XV1oyfPmaAKBdYMOAOoBmjBTk7uiMGctYl5cTBZ0eKFmdrKV1ZspAbIEi3MCufqw0YB+QwAJtQmQFHnGIMZ5xl/z+eVinxDatLgpPw5g0Nd6lma7HfBhYNiQiuzMAczgT0BmGae8ZtM3WFiT28dbkVPH1d6MGJON58GvwunMlIoGcxuV0YB/zGBGeUZf7ukb+RzU1AqkOjc+n+jW1lPavn7GbRiYHJjGH7gAIMZ4hmrL/4q5dAHCGgFO0LW/+XXeimVNjHhHojgN/oH5kHgPz4wmUDcO9pp97McGkzQ9GAxlKfEkvxaUPUJcXd9JDcO5mnkP6wFZo5+BpmwnHpucFyaKQeH9ulrSZ9/yJdnEAeTRboTATCBZ7hsl+OscwlCNAJ2s6W2vwfiRROYLQmmHqEzETCBZ8S6AAHfB38KvtxotUA/gyaCyXIeRCm5FSaAyZpBvN2OknSswWKI9ybapa8kuarcJuJgjkEyewRMMV6PDTpKGKhCgTtncc1noAfiNHRo4BCYVj2/Fl6ZzDPiu6yUyJZdBPID735RBO5anDTVlxdipen5z6kwmHGewVre7hJ93JJrcNMJ5mKkB+IUnOEgbSTAf+JgMs/gX43j0r6UuzXvLotxd5ajkAvIyPx11H84mZ3BZM0g7ps4Ls0FtHFfLuvK3jf2QKzCgRxSLYH/UDAzDub7XjCrprg0qAaBHojSQYc1Aw7SSjD/ams+ei0OZpxncFxa+iEgXOv99OX5FKJFkWsQ/iGj3az/xEWDOM+oFs7a6iO6XIPH3I6875oBJUkwmA8gmT0EZlwzSMfs0VEW++LHzLbprkX4rjALl2Gp2fSfOJhxnsEJsximBLrh1zEakR6InNc9rb4Q7A0IZgZDYPFey9KgmMSWa7DiATNvEdnyZIxRyi+DOQvJ7AEw4zwjnTMnFHFqT1z/T++Q33XmGfCe07Dxnx+iYPaRZwy0XGkL/BOyL+frw8M9EDlUKKHfD/oPkFl3DlCcZ2THDI2cePpMwhLXkzLcBKAzjYn21wohAgA8sI4dqZZxnpF9bc7B5YLduP6f3uWegEDFTEyxChk9pP/EwYTx6hxmYWnkJAwOL15fnsRF7dDPIJpncFHo7BD/AujjGe23gz8aOiklR4rr/zXhekO1Cezqm2qdfQOSuZyFQ3Gekb1tKY+t6sou4/p/GnhaABDqgch1xne18DyAZHYfmHGekbKvCgh0Y2eZ98BVATEDLFHhYcmfZ73k6af4rCGbgEfqM+M8I9WesZXtHv9cmvBk1bD+n2r/MBzz47UJMjQ6R06Qg5lcqJJhbYLe8vmv7tD90p4c3IUipv+n/Ir4XtEeiMwGaoVWM5D8Z5M2ZQYzyDMWZu7sjM6bpiK+PMuWjovZEO6ByHkPFfVaKyCY6eg2QuON3/0+HM5a5nkhF/5Szzl2I5BnwJ2gmyics/7jbuoU1wxaAOaN2JWqjlu9l+7NfHZYPhzvgch8LE2DZiA6XCpF+TELmKBorf5kR0Bmha3IYG8p+lQeW+1mRaC+39Iwfo0uT8D4F+i4oUaIrGhJbJpYteu0C3W7gBvoCciagXQgwNpOoAigzpeeBTBd45UuZxD9r9Mu+nsgmtrVXoacCIvoWVFvnBsUzIz3m+XZuRvYHmgkBqs4eyDSTuHvgciq/wV1FgjqP/G23lxg1wDW2b+ilRqH0moMHpNryjNAZieRl2SW2ekcnEyUYDLPKK2+u9uXIyv4H+AuZOG7FnlhyiPr9U2f/sPYM5iskXB3fZ6+kUPPGmS0hu4e5PQVHlkVskAc/Icbgmf+HojScVWJS0VVA/blbNQD0dzEZqjbwmyqvWDBwcz4jUPMM+TGOUVKdEQ14HgHGyk8fNeitE/wGzfAB0IwU329cRYYr/xJJ/uUTERQNTijlW2tP/cm7O7a0qRQ8x/Qf2JXLkZqMZbhVV5rKoJXZOE8g1/02GRzvguefCAt4/hlqMwzVgyygSkwCvQGmCYY9ECEAia4b1psJbRxevUfBpN5BlwxAbw4qBpwRisb3LVo1Qw+1XSzmjPxn1IwNwBMy3jXufNNvJsQEH3IaAXr712LX2SKybeffCAfY+JX+3PlzH3xd3BQAdWA9X82QMuq/g71wDItq9faQZuYN2YEkxUtCJyAdObLNWD9P64ZtIyNMv7yUg4iB7tM4D+kMDCYzDMkA+KmPSFr918zeDTYA3Ho4y9znYs/A6l2rmQuBpN5BqA9APXSXpvGO5D0xmhxc6nVF568mnLQOMBlgv4DmzKCyb2W6dLD1AYm5bS78LFqzcDfA/H8E1t29F9ZBm3mAB6f/nPaDiYrWlz6DSvYak3kLhoL9TNIIh8UvizA4+E/G2YwmWdwh414XFp+MOv/bPYeiPGwwJxpqc3BOkYwA2XOwvHAi5xWcdyBRLn6lGcQ/67MaGaB/wD0ACbwDBZ2WlgHEFcNVjD2xsY9EOOdyTijp24S8wojmKxocYsNjhymrNxySaOBaWrNetdiXK06ZeI/18DBWsA084wJjWywJplhuT0pF7wjo9UTd+fsb661Jy2P+Q8rBgwmj5epTUV3v7Qw6oYI8Q4wR21CvDMZl0yfhmAmyLgEJvOM+P/hgNVQuSO6CpODje9adHtMWGqg/wD9ATCNGgnziLa5kZO1DJZ9ORvH3V2WKhapdbQw8J8HBYMZvWtRMnz+L03HIRB7MbFhVkj8MJW3QJ2DjfM6BEwATON4mdwsKmMv/hQH7rbNxj0QPZb+6Q1ocTBzww4m8QzWb6us8MKGQQFLzmhl4x6IDkvVIljQNQfE1w8mVM7AMrEscC4/OE9/ZDP2QHRYPgk5IMR/Gr095oYPTB4vE08XXYHFF8wzsPZAjG+yXAOk5j/jb9Q9YMab2C1bGzlZ1/vEz1Cb4GrlCeQU9B+6ZpEts+YZMOcdJE4cXTic0epa+uJUFu9M9i1cman+/7NRMKWiVaiklCV7IydNN8RYbUK0ByJbrV0HF8j6z4ke/1PArgOTK2dYwW1hT122+4JsgpcGC/ZAZBvo0jbqOlwZpQX/QOEEE3kGt9CfBtnMdwwE4bbftQmO1nxAf9z8Z3O27gSTx8uBE28iHdy8uKO1CRcixRSptoWlwAZIDYrym6/VvWDyBSMcOImU+HDIck9uFSHsPRAvGbmP2GOFB5Q2puM/42/WQ2DyeMvThQtBjzAZk4Ul0P/B3D0Q2VIuurKqbpme1W3LiCWDyZoB+DBfHBmW3w7mGbg1g2zgla35KdYZ6D8YzNwELAFMHC9HRZYdzXQ4MA7uFMzXA5Etu/LR1nNClgX+g8lcmyfrYTC5cgayOEBocS0dlJx+/jyDLF96ZutBWJgO/WcUuA+CyTyDwyIOGRVz5ScdeQaBHohsWZZfEVCqF+bIGCVzPRw5W9SjYDLPYN0PTgCutFbrrd597IHYLbs9/2bmoy0ogcoC/5GPjD8cPfuddVSZRzNgqgR+13UQBNm2r7UJ3Pr081urWw8AlSX9RwYzR8+eBChtYL7wYYfd6gnAh53W+hHmzzr/Ip5Vf/ydH98pPk2sj8Db5YCkHRatT6Xt/55MPrP1wGrxv/bomAAAAAYBkBXsX3YddnlABfqRbkOmTGQiE5nIlIlMZCITmTKRiUxkykQmMpGJTJnIRCYykSkTmchEpkxkIhOZyJSJTGQiE5kykYlMZJIiE5nIRKZMZCITmciUiUxkIhOZMpGJTGTKRCYykYlMmchEJjKRKROZyESmTGQiE5nIlIlMZCITmTKRiUxkykQmMpGJTJnIRCYykSkTmchEpkxkIhOZyJSJTGQiE5kykYlMZCJTJjKRiUyZyEQmMpEpE5nIRCYyZSITmciUiUxkIhOZMpGJTGQiUyYykYlMmchEJjKRKROZyEQmMmUiE5nIlIlMZCITmTKRiUxkIlMmMpGJTA5sp/zxgiJuUgAAAABJRU5ErkJggg==",
                "backendService": {
                  "serviceUrl": "[[variables('serviceUrl')]"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "description": "[variables('blanks')]",
                    "title": "InsightVM Cloud Integrations API",
                    "version": "Connector for Rapid7 InsightVM Cloud Integrations API"
                  },
                  "host": "[[variables('api_host')]",
                  "basePath": "/vm/",
                  "schemes": [
                    "https"
                  ],
                  "paths": {
                    "/v4/integration/assets": {
                      "post": {
                        "parameters": [
                          {
                            "description": "The cursor to retrieve the next page of resources.",
                            "in": "query",
                            "name": "cursor",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "The current date and time to compare against the asset state to detect changes. If specified, changes in vulnerabilities from this timestamp since the comparison time are calculated and output in the response. If not provided, defaults to the time of request.",
                            "in": "query",
                            "name": "currentTime",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "The date and time to compare the asset current state against to detect changes. If specified, changes in vulnerabilities from this timestamp to the current time are calculated and output in the response. If not provided, defaults to the current time value.",
                            "in": "query",
                            "name": "comparisonTime",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "Whether the response should include the list of already-existing vulnerabilities on an asset.",
                            "in": "query",
                            "name": "includeSame",
                            "required": false,
                            "type": "boolean"
                          },
                          {
                            "description": "Whether the response should include unique identifiers.",
                            "in": "query",
                            "name": "includeUniqueIdentifiers",
                            "required": false,
                            "type": "boolean"
                          },
                          {
                            "description": "The index of the page (zero-based) to retrieve.",
                            "in": "query",
                            "name": "page",
                            "type": "integer"
                          },
                          {
                            "description": "The number of records per page to retrieve.",
                            "in": "query",
                            "name": "size",
                            "type": "integer"
                          },
                          {
                            "description": "The criteria to sort the records by, in the format: `<property>[,ASC|DESC]`. The default sort order is ascending. Multiple sort criteria can be specified using multiple sort query parameters.",
                            "format": "<property>[,ASC|DESC]",
                            "in": "query",
                            "name": "sort",
                            "type": "string"
                          },
                          {
                            "description": "Search query for filtering assets and vulnerabilities on assets.",
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/AssetVulnerabilityQuery"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/PagedResourcesOfAssetSummary"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Asset"
                        ],
                        "description": "Returns the inventory, assessment, and summary details for a page of assets. Only assets which the caller has access to are returned.",
                        "operationId": "[[variables('_operationId-searchIntegrationAssets')]",
                        "summary": "Search Assets"
                      }
                    },
                    "/v4/integration/assets/{id}": {
                      "get": {
                        "parameters": [
                          {
                            "description": "The identifier of the asset to retrieve the details for.",
                            "in": "path",
                            "name": "id",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "description": "The current date and time to compare the asset state against to detect changes. If specified, changes in vulnerabilities from this timestamp since the comparison time are calculated and output in the response. If not provided, defaults to the time of request.",
                            "in": "query",
                            "name": "currentTime",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "The date and time to compare the current asset state against to detect changes. If specified, changes in vulnerabilities from this timestamp to the current time are calculated and output in the response. If not provided, defaults to the current time value.",
                            "in": "query",
                            "name": "comparisonTime",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "Whether the response should include the list of already-existing vulnerabilities on an asset.",
                            "in": "query",
                            "name": "includeSame",
                            "required": false,
                            "type": "boolean"
                          },
                          {
                            "description": "Whether the response should include asset unique identifiers in the response.",
                            "in": "query",
                            "name": "includeUniqueIdentifiers",
                            "required": false,
                            "type": "boolean"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/AssetSummary"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Asset"
                        ],
                        "description": "Returns the assessment and details of an asset (specified by id). Only assets which the caller has access to can be returned.",
                        "operationId": "[[variables('_operationId-getIntegrationAsset')]",
                        "summary": "Get Asset"
                      }
                    },
                    "/v4/integration/scan": {
                      "get": {
                        "parameters": [
                          {
                            "description": "The index of the page (zero-based) to retrieve.",
                            "in": "query",
                            "name": "page",
                            "type": "integer"
                          },
                          {
                            "description": "The number of records per page to retrieve.",
                            "in": "query",
                            "name": "size",
                            "type": "integer"
                          },
                          {
                            "description": "The criteria to sort the records by, in the format: `<property>[,ASC|DESC]`. The default sort order is ascending. Multiple sort criteria can be specified using multiple sort query parameters.",
                            "format": "<property>[,ASC|DESC]",
                            "in": "query",
                            "name": "sort",
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/PageOfScan"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Retrieves a page of scans.",
                        "operationId": "[[variables('_operationId-getScans')]",
                        "summary": "Get Scans"
                      },
                      "post": {
                        "parameters": [
                          {
                            "description": "Input resource for starting a new scan.",
                            "in": "body",
                            "name": "body",
                            "required": true,
                            "schema": {
                              "$ref": "#/definitions/ScanForm"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/DispatchedScans"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Starts a scan.",
                        "operationId": "[[variables('_operationId-startScan')]",
                        "summary": "Start Scan"
                      }
                    },
                    "/v4/integration/scan/engine": {
                      "get": {
                        "parameters": [
                          {
                            "description": "The index of the page (zero-based) to retrieve.",
                            "in": "query",
                            "name": "page",
                            "type": "integer"
                          },
                          {
                            "description": "The number of records per page to retrieve.",
                            "in": "query",
                            "name": "size",
                            "type": "integer"
                          },
                          {
                            "description": "The criteria to sort the records by, in the format: `<property>[,ASC|DESC]`. The default sort order is ascending. Multiple sort criteria can be specified using multiple sort query parameters.",
                            "format": "<property>[,ASC|DESC]",
                            "in": "query",
                            "name": "sort",
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/PageOfScanEngine"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Retrieves a page of scan engines.",
                        "operationId": "[[variables('_operationId-getScanEngines')]",
                        "summary": "Get Scan Engines"
                      }
                    },
                    "/v4/integration/scan/engine/{id}": {
                      "get": {
                        "parameters": [
                          {
                            "description": "The identifier of the scan engine to retrieve.",
                            "in": "path",
                            "name": "id",
                            "required": true,
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/ScanEngine"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Retrieves the scan engine with the specified identifier.",
                        "operationId": "[[variables('_operationId-getScanEngine')]",
                        "summary": "Get Scan Engine"
                      }
                    },
                    "/v4/integration/scan/{id}": {
                      "get": {
                        "parameters": [
                          {
                            "description": "The identifier of the scan to retrieve.",
                            "in": "path",
                            "name": "id",
                            "required": true,
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/Scan"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Retrieves the scan with the specified identifier.",
                        "operationId": "[[variables('_operationId-getScan')]",
                        "summary": "Get Scan"
                      }
                    },
                    "/v4/integration/scan/{id}/stop": {
                      "post": {
                        "parameters": [
                          {
                            "description": "The identifier of the scan to stop.",
                            "in": "path",
                            "name": "id",
                            "required": true,
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "202": {
                            "description": "Accepted"
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Scan"
                        ],
                        "description": "Stops the scan with the specified identifier.",
                        "operationId": "[[variables('_operationId-stopScan')]",
                        "summary": "Stop Scan"
                      }
                    },
                    "/v4/integration/sites": {
                      "post": {
                        "parameters": [
                          {
                            "description": "The cursor to retrieve the next page of resources.",
                            "in": "query",
                            "name": "cursor",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "The index of the page (zero-based) to retrieve.",
                            "in": "query",
                            "name": "page",
                            "type": "integer"
                          },
                          {
                            "description": "The number of records per page to retrieve.",
                            "in": "query",
                            "name": "size",
                            "type": "integer"
                          },
                          {
                            "description": "The criteria to sort the records by, in the format: `<property>[,ASC|DESC]`. The default sort order is ascending. Multiple sort criteria can be specified using multiple sort query parameters.",
                            "format": "<property>[,ASC|DESC]",
                            "in": "query",
                            "name": "sort",
                            "type": "string"
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/PagedResourcesOfAssetTagSummary"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Site"
                        ],
                        "description": "Returns the details for sites.",
                        "operationId": "[[variables('_operationId-getSites')]",
                        "summary": "List Sites"
                      }
                    },
                    "/v4/integration/vulnerabilities": {
                      "post": {
                        "parameters": [
                          {
                            "description": "The cursor to retrieve the next page of resources.",
                            "in": "query",
                            "name": "cursor",
                            "required": false,
                            "type": "string"
                          },
                          {
                            "description": "The index of the page (zero-based) to retrieve.",
                            "in": "query",
                            "name": "page",
                            "type": "integer"
                          },
                          {
                            "description": "The number of records per page to retrieve.",
                            "in": "query",
                            "name": "size",
                            "type": "integer"
                          },
                          {
                            "description": "The criteria to sort the records by, in the format: `<property>[,ASC|DESC]`. The default sort order is ascending. Multiple sort criteria can be specified using multiple sort query parameters.",
                            "format": "<property>[,ASC|DESC]",
                            "in": "query",
                            "name": "sort",
                            "type": "string"
                          },
                          {
                            "description": "Search criteria for finding vulnerabilities.",
                            "in": "body",
                            "name": "body",
                            "schema": {
                              "$ref": "#/definitions/VulnerabilitySearch"
                            }
                          }
                        ],
                        "responses": {
                          "200": {
                            "description": "SUCCESS",
                            "schema": {
                              "$ref": "#/definitions/PagedResourcesOfVulnerabilitySummary"
                            }
                          },
                          "400": {
                            "description": "BAD REQUEST",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "401": {
                            "description": "UNAUTHORIZED",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "404": {
                            "description": "NOT FOUND",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "415": {
                            "description": "UNSUPPORTED MEDIA TYPE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "500": {
                            "description": "INTERNAL SERVER ERROR",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          },
                          "503": {
                            "description": "SERVICE UNAVAILABLE",
                            "schema": {
                              "$ref": "#/definitions/Error"
                            }
                          }
                        },
                        "tags": [
                          "Vulnerability"
                        ],
                        "description": "Returns all vulnerabilities that can be assessed.",
                        "operationId": "[[variables('_operationId-searchIntegrationVulnerabilities')]",
                        "summary": "Search Vulnerabilities"
                      }
                    }
                  },
                  "definitions": {
                    "AdvisoryLinkSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "href": {
                          "description": "[variables('blanks')]",
                          "type": "string"
                        },
                        "id": {
                          "description": "[variables('blanks')]",
                          "type": "string"
                        },
                        "source": {
                          "description": "[variables('blanks')]",
                          "type": "string"
                        }
                      },
                      "title": "Vulnerability Reference",
                      "type": "object"
                    },
                    "AssetSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "tags": {
                          "description": "The tags applied to the asset.",
                          "items": {
                            "$ref": "#/definitions/AssetTagSummary"
                          },
                          "type": "array"
                        },
                        "assessed_for_policies": {
                          "description": "Whether an asset was assessed for policies.",
                          "type": "boolean"
                        },
                        "assessed_for_vulnerabilities": {
                          "description": "Whether an asset was assessed for vulnerabilities.",
                          "type": "boolean"
                        },
                        "credential_assessments": {
                          "description": "The credential assessments for the asset.",
                          "items": {
                            "$ref": "#/definitions/CredentialAssessmentSummary"
                          },
                          "type": "array"
                        },
                        "critical_vulnerabilities": {
                          "description": "The count of critical vulnerability findings.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "exploits": {
                          "description": "The count of known unique exploits that can be used to exploit vulnerabilities on the asset.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "host_name": {
                          "description": "The host name (local or FQDN).",
                          "type": "string"
                        },
                        "id": {
                          "description": "The identifier of the asset.",
                          "type": "string"
                        },
                        "ip": {
                          "description": "The IPv4 or IPv6 address.",
                          "type": "string"
                        },
                        "last_assessed_for_vulnerabilities": {
                          "description": "The time at which an asset was assessed for vulnerabilities.",
                          "type": "string"
                        },
                        "last_scan_end": {
                          "description": "The time at which the last scan of the asset ended.",
                          "type": "string"
                        },
                        "last_scan_start": {
                          "description": "The time at which the last scan of the asset started.",
                          "type": "string"
                        },
                        "mac": {
                          "description": "The Media Access Control (MAC) address. The format is six groups of two hexadecimal digits separated by colons.",
                          "type": "string"
                        },
                        "malware_kits": {
                          "description": "The count of known unique malware kits that can be used to attack vulnerabilities on the asset.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "moderate_vulnerabilities": {
                          "description": "The count of moderate vulnerability findings.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "new": {
                          "description": "If a comparison time is supplied, the vulnerabilities that are the new in the latest version at current time.",
                          "items": {
                            "$ref": "#/definitions/AssetVulnerabilityResultSummary"
                          },
                          "type": "array"
                        },
                        "os_architecture": {
                          "description": "The architecture of the operating system.",
                          "type": "string"
                        },
                        "os_description": {
                          "description": "The description of the operating system (containing vendor, family, product, version and architecture in a single string).",
                          "type": "string"
                        },
                        "os_family": {
                          "description": "The family of the operating system.",
                          "type": "string"
                        },
                        "os_name": {
                          "description": "The name of the operating system.",
                          "type": "string"
                        },
                        "os_system_name": {
                          "description": "A combination of vendor and family (with redundancies removed), suitable for grouping.",
                          "type": "string"
                        },
                        "os_type": {
                          "description": "The type of operating system.",
                          "type": "string"
                        },
                        "os_vendor": {
                          "description": "The vendor of the operating system.",
                          "type": "string"
                        },
                        "os_version": {
                          "description": "The version of the operating system.",
                          "type": "string"
                        },
                        "remediated": {
                          "description": "If a comparison time is supplied, the vulnerabilities that were remediated in the latest version at current time.",
                          "items": {
                            "$ref": "#/definitions/AssetVulnerabilityResultSummary"
                          },
                          "type": "array"
                        },
                        "risk_score": {
                          "description": "The risk score (with criticality adjustments) of the asset.",
                          "format": "double",
                          "type": "number"
                        },
                        "same": {
                          "description": "If a comparison time is supplied and includeSame is `true`, the vulnerabilities that are the same between current and comparison time.",
                          "items": {
                            "$ref": "#/definitions/AssetVulnerabilityResultSummary"
                          },
                          "type": "array"
                        },
                        "severe_vulnerabilities": {
                          "description": "The count of severe vulnerability findings.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "total_vulnerabilities": {
                          "description": "The total count of vulnerability findings.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "type": {
                          "description": "The type of asset.",
                          "enum": [
                            "hypervisor",
                            "mobile",
                            "guest",
                            "physical",
                            "unknown"
                          ],
                          "type": "string"
                        },
                        "unique_identifiers": {
                          "description": "Unique identifiers found on the asset, such as hardware or operating system identifiers.",
                          "items": {
                            "$ref": "#/definitions/UniqueIdSummary"
                          },
                          "type": "array"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "AssetTagSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "name": {
                          "description": "The stored value.",
                          "type": "string"
                        },
                        "type": {
                          "description": "The type of information stored and displayed. For sites, the value is `\"SITE\"`.",
                          "type": "string"
                        }
                      },
                      "title": "Asset Tags",
                      "type": "object"
                    },
                    "AssetVulnerabilityQuery": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "asset": {
                          "description": "Search criteria for filtering assets returned.",
                          "type": "string"
                        },
                        "vulnerability": {
                          "description": "Search criteria for filtering vulnerabilities returned on each matching asset.",
                          "type": "string"
                        }
                      },
                      "title": "Asset Vulnerability Query",
                      "type": "object"
                    },
                    "AssetVulnerabilityResultSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "check_id": {
                          "description": "The identifier of the vulnerability check.",
                          "type": "string"
                        },
                        "first_found": {
                          "description": "The first time the vulnerability was discovered.",
                          "type": "string"
                        },
                        "key": {
                          "description": "The identifier of the assessment key.",
                          "type": "string"
                        },
                        "last_found": {
                          "description": "The most recent time the vulnerability was discovered.",
                          "type": "string"
                        },
                        "port": {
                          "description": "For services vulnerabilities, the port that is vulnerable.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "proof": {
                          "description": "The identifier of the vulnerability proof.",
                          "type": "string"
                        },
                        "protocol": {
                          "description": "For services vulnerabilities, the protocol that is vulnerable.",
                          "type": "string"
                        },
                        "solution_fix": {
                          "description": "The solution fix for the vulnerability.",
                          "type": "string"
                        },
                        "solution_id": {
                          "description": "The identifier of the solution for the vulnerability.",
                          "type": "string"
                        },
                        "solution_summary": {
                          "description": "The summary for the solution for the vulnerability.",
                          "type": "string"
                        },
                        "solution_type": {
                          "description": "The solution type for the vulnerability.",
                          "type": "string"
                        },
                        "status": {
                          "description": "The status of the vulnerability finding.",
                          "enum": [
                            "EXCEPTION_VULN_EXPL",
                            "UNEXPECTED_ERR",
                            "NOT_VULN_DONT_STORE",
                            "SUPERSEDED",
                            "EXCEPTION_VULN_POTL",
                            "VULNERABLE_EXPL",
                            "OVERRIDDEN_VULN_VERS",
                            "SKIPPED_DISABLED",
                            "VULNERABLE_VERS",
                            "VULNERABLE_POTENTIAL",
                            "SKIPPED_VERS",
                            "EXCEPTION_VULN_VERS",
                            "NOT_VULNERABLE",
                            "UNKNOWN",
                            "SKIPPED_DOS"
                          ],
                          "type": "string"
                        },
                        "vulnerability_id": {
                          "description": "The identifier of the vulnerability.",
                          "type": "string"
                        }
                      },
                      "title": "Vulnerabilities",
                      "type": "object"
                    },
                    "CredentialAssessmentSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "port": {
                          "description": "The port the authentication was used on.",
                          "format": "int64",
                          "type": "integer"
                        },
                        "protocol": {
                          "description": "The protocol the authentication was used on.",
                          "type": "string"
                        },
                        "status": {
                          "description": "The authentication of the last scan performed.",
                          "type": "string"
                        }
                      },
                      "title": "Credential Assessments",
                      "type": "object"
                    },
                    "CursorPageMetadata": {
                      "description": "The details of pagination indicating which page was returned, and how the remaining pages can be retrieved for the same cursored result set.",
                      "properties": {
                        "cursor": {
                          "description": "The cursor associated with the series of page requests being made.",
                          "type": "string"
                        },
                        "number": {
                          "description": "The index (zero-based) of the current page returned.",
                          "format": "int64",
                          "type": "integer"
                        },
                        "size": {
                          "description": "The maximum size of the page returned.",
                          "format": "int64",
                          "type": "integer"
                        },
                        "totalPages": {
                          "description": "The total number of pages available.",
                          "format": "int64",
                          "type": "integer"
                        },
                        "totalResources": {
                          "description": "The total number of resources available across all pages.",
                          "format": "int64",
                          "type": "integer"
                        }
                      },
                      "title": "Cursored Page Metadata",
                      "type": "object"
                    },
                    "DispatchedScans": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "scans": {
                          "description": "[variables('blanks')]",
                          "items": {
                            "$ref": "#/definitions/Scan"
                          },
                          "type": "array"
                        },
                        "unscanned_assets": {
                          "description": "[variables('blanks')]",
                          "items": {
                            "$ref": "#/definitions/UnscannedAsset"
                          },
                          "type": "array"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "Error": {
                      "description": "The details for an error encountered by the API.",
                      "properties": {
                        "localized_message": {
                          "description": "An optional localized message indicating the cause or reason for failure.",
                          "type": "string"
                        },
                        "message": {
                          "description": "The messages indicating the cause or reason for failure.",
                          "type": "string"
                        },
                        "status": {
                          "description": "The HTTP status code for the error (same as in the HTTP response).",
                          "enum": [
                            "100",
                            "101",
                            "102",
                            "103",
                            "200",
                            "201",
                            "202",
                            "203",
                            "204",
                            "205",
                            "206",
                            "207",
                            "208",
                            "226",
                            "300",
                            "301",
                            "302",
                            "303",
                            "304",
                            "305",
                            "307",
                            "308",
                            "400",
                            "401",
                            "402",
                            "403",
                            "404",
                            "405",
                            "406",
                            "407",
                            "408",
                            "409",
                            "410",
                            "411",
                            "412",
                            "413",
                            "414",
                            "415",
                            "416",
                            "417",
                            "418",
                            "419",
                            "420",
                            "421",
                            "422",
                            "423",
                            "424",
                            "425",
                            "426",
                            "428",
                            "429",
                            "431",
                            "451",
                            "500",
                            "501",
                            "502",
                            "503",
                            "504",
                            "505",
                            "506",
                            "507",
                            "508",
                            "509",
                            "510",
                            "511"
                          ],
                          "type": "integer"
                        }
                      },
                      "title": "Error",
                      "type": "object"
                    },
                    "ExploitSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "description": {
                          "description": "A verbose description of the exploit.",
                          "type": "string"
                        },
                        "id": {
                          "description": "The identifier of the exploit.",
                          "type": "string"
                        },
                        "name": {
                          "description": "The name of the exploit.",
                          "type": "string"
                        },
                        "rank": {
                          "description": "How common the exploit is used.",
                          "enum": [
                            "average",
                            "normal",
                            "excellent",
                            "low",
                            "manual",
                            "great",
                            "good"
                          ],
                          "type": "string"
                        },
                        "skill_level": {
                          "description": "The level of skill required to use the exploit.",
                          "enum": [
                            "expert",
                            "intermediate",
                            "novice"
                          ],
                          "type": "string"
                        },
                        "source": {
                          "description": "Details about where the exploit is defined.",
                          "enum": [
                            "metasploit",
                            "exploitdb"
                          ],
                          "type": "string"
                        }
                      },
                      "title": "Exploit",
                      "type": "object"
                    },
                    "Link": {
                      "description": "A hypermedia link.",
                      "properties": {
                        "href": {
                          "description": "A hypertext reference, which is either a URI (see <a target=\"_blank\" href=\"https://tools.ietf.org/html/rfc3986\">RFC 3986</a>) or URI template (see <a target=\"_blank\" href=\"https://tools.ietf.org/html/rfc6570\">RFC 6570</a>). ",
                          "type": "string"
                        },
                        "rel": {
                          "description": "The link relation type. This value is one from the <a target=\"_blank\" href=\"https://tools.ietf.org/html/rfc5988#section-6.2\">Link Relation Type Registry</a> or is the type of resource being linked to.",
                          "type": "string"
                        }
                      },
                      "title": "Link",
                      "type": "object"
                    },
                    "MalwareKitSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "description": {
                          "description": "A known Malware Kit that can be used to compromise a vulnerability.",
                          "type": "string"
                        },
                        "name": {
                          "description": "The name of the malware kit.",
                          "type": "string"
                        },
                        "popularity": {
                          "description": "The popularity of the malware kit.",
                          "enum": [
                            "uncommon",
                            "common",
                            "rare",
                            "favored",
                            "occasional",
                            "popular",
                            "undefined"
                          ],
                          "type": "string"
                        }
                      },
                      "title": "Malware Kit",
                      "type": "object"
                    },
                    "PageMetadataOfScan": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "index": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "size": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "total_data": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "total_pages": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PageMetadataOfScanEngine": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "index": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "size": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "total_data": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        },
                        "total_pages": {
                          "description": "[variables('blanks')]",
                          "format": "int64",
                          "type": "integer"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PageOfScan": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "data": {
                          "description": "The page of resources returned.",
                          "items": {
                            "$ref": "#/definitions/Scan"
                          },
                          "title": "Page Data",
                          "type": "array"
                        },
                        "links": {
                          "description": "Hypermedia links that allow navigation to the previous, next, first and last pages.",
                          "items": {
                            "$ref": "#/definitions/Link"
                          },
                          "title": "Page Links",
                          "type": "array"
                        },
                        "metadata": {
                          "$ref": "#/definitions/PageMetadataOfScan"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PageOfScanEngine": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "data": {
                          "description": "The page of resources returned.",
                          "items": {
                            "$ref": "#/definitions/ScanEngine"
                          },
                          "title": "Page Data",
                          "type": "array"
                        },
                        "links": {
                          "description": "Hypermedia links that allow navigation to the previous, next, first and last pages.",
                          "items": {
                            "$ref": "#/definitions/Link"
                          },
                          "title": "Page Links",
                          "type": "array"
                        },
                        "metadata": {
                          "$ref": "#/definitions/PageMetadataOfScanEngine"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PagedResourcesOfAssetSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "data": {
                          "description": "The page of resources returned.",
                          "items": {
                            "$ref": "#/definitions/AssetSummary"
                          },
                          "title": "Page Data",
                          "type": "array"
                        },
                        "links": {
                          "description": "Hypermedia links that allow navigation to the previous, next, first and last pages.",
                          "items": {
                            "$ref": "#/definitions/Link"
                          },
                          "title": "Page Links",
                          "type": "array"
                        },
                        "metadata": {
                          "$ref": "#/definitions/CursorPageMetadata"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PagedResourcesOfAssetTagSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "data": {
                          "description": "The page of resources returned.",
                          "items": {
                            "$ref": "#/definitions/AssetTagSummary"
                          },
                          "title": "Page Data",
                          "type": "array"
                        },
                        "links": {
                          "description": "Hypermedia links that allow navigation to the previous, next, first and last pages.",
                          "items": {
                            "$ref": "#/definitions/Link"
                          },
                          "title": "Page Links",
                          "type": "array"
                        },
                        "metadata": {
                          "$ref": "#/definitions/CursorPageMetadata"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "PagedResourcesOfVulnerabilitySummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "data": {
                          "description": "The page of resources returned.",
                          "items": {
                            "$ref": "#/definitions/VulnerabilitySummary"
                          },
                          "title": "Page Data",
                          "type": "array"
                        },
                        "links": {
                          "description": "Hypermedia links that allow navigation to the previous, next, first and last pages.",
                          "items": {
                            "$ref": "#/definitions/Link"
                          },
                          "title": "Page Links",
                          "type": "array"
                        },
                        "metadata": {
                          "$ref": "#/definitions/CursorPageMetadata"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "Scan": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "asset_ids": {
                          "description": "[variables('blanks')]",
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        },
                        "engine_id": {
                          "description": "The identifier of the engine for the scan.",
                          "type": "string"
                        },
                        "finished": {
                          "description": "The completion timestamp of the scan.",
                          "type": "string"
                        },
                        "id": {
                          "description": "The identifier of the scan.",
                          "type": "string"
                        },
                        "name": {
                          "description": "The name of the scan.",
                          "type": "string"
                        },
                        "started": {
                          "description": "The start timestamp of the scan.",
                          "type": "string"
                        },
                        "status": {
                          "description": "The status of the scan. One of [Dispatched, Running, Integrating, Success, Paused, Stopped, Failed, Aborted, Unknown]",
                          "type": "string"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "ScanEngine": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "host_name": {
                          "description": "The hostname of the scan engine.",
                          "type": "string"
                        },
                        "id": {
                          "description": "The identifier of the engine for the scan.",
                          "type": "string"
                        },
                        "last_seen": {
                          "description": "Timestamp the engine was last seen.",
                          "type": "string"
                        },
                        "name": {
                          "description": "The name of the scan engine.",
                          "type": "string"
                        },
                        "registered": {
                          "description": "Timestamp the scan engine was registered to the Insight Platform.",
                          "type": "string"
                        },
                        "status": {
                          "description": "The status of the scan engine.",
                          "type": "string"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "ScanForm": {
                      "description": "The payload for starting a scan.",
                      "properties": {
                        "asset_ids": {
                          "description": "The identifiers of the assets to scan.",
                          "items": {
                            "type": "string"
                          },
                          "type": "array",
                          "uniqueItems": true
                        },
                        "credential_sources": {
                          "description": "The names of the sites on the Nexpose console to pull asset credentials from.",
                          "items": {
                            "type": "string"
                          },
                          "type": "array",
                          "uniqueItems": true
                        },
                        "engine_ids": {
                          "description": "The identifiers of the engines to use for the scan.",
                          "items": {
                            "type": "string"
                          },
                          "type": "array",
                          "uniqueItems": true
                        },
                        "exclusions": {
                          "$ref": "#/definitions/ScanForm"
                        },
                        "name": {
                          "description": "The name of the scan.",
                          "type": "string"
                        },
                        "result_consumer": {
                          "description": "The name of the site on the Nexpose console used to ingest the scanned assets.",
                          "type": "string"
                        },
                        "solution_ids": {
                          "description": "The identifiers of the solutions used to reduce the scope of the scan.",
                          "items": {
                            "type": "string"
                          },
                          "type": "array",
                          "uniqueItems": true
                        },
                        "start_time": {
                          "description": "The time at which to start the scan.",
                          "type": "string"
                        },
                        "vulnerability_ids": {
                          "description": "The identifiers of the vulnerabilities used to reduce the scope of the scan.",
                          "items": {
                            "type": "string"
                          },
                          "type": "array",
                          "uniqueItems": true
                        }
                      },
                      "title": "ScanForm",
                      "type": "object"
                    },
                    "UniqueIdSummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "id": {
                          "description": "The unique identifier.",
                          "type": "string"
                        },
                        "source": {
                          "description": "The source of the unique identifier.",
                          "type": "string"
                        }
                      },
                      "title": "Unique Identifiers",
                      "type": "object"
                    },
                    "UnscannedAsset": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "id": {
                          "description": "[variables('blanks')]",
                          "type": "string"
                        },
                        "reason": {
                          "description": "[variables('blanks')]",
                          "type": "string"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    },
                    "VulnerabilitySearch": {
                      "description": "Criteria for searching vulnerabilities.",
                      "properties": {
                        "vulnerability": {
                          "description": "Search expression with criteria for searching on vulnerabilities.",
                          "type": "string"
                        }
                      },
                      "title": "Vulnerability Search",
                      "type": "object"
                    },
                    "VulnerabilitySummary": {
                      "description": "[variables('blanks')]",
                      "properties": {
                        "added": {
                          "description": "The date the vulnerability coverage was added. The format is an ISO 8601 date, `YYYY-MM-DD`.",
                          "type": "string"
                        },
                        "categories": {
                          "description": "Comma-separated list of categories the vulnerability is classified under.",
                          "type": "string"
                        },
                        "cves": {
                          "description": "All <a target=\"_blank\" href=\"https://cve.mitre.org/\">CVE</a>s assigned to this vulnerability.",
                          "type": "string"
                        },
                        "cvss_v2_access_complexity": {
                          "description": "Access Complexity (AC) component which measures the complexity of the attack required to exploit the vulnerability once an attacker has gained access to the target system. <table> <tr><th>Access Complexity</th><th>Description</th></tr> <tr><td>High (\"high\")</td><td>Specialized access conditions exist.</td></tr> <tr><td>Medium (\"medium\")</td><td>The access conditions are somewhat specialized.</td></tr> <tr><td>Low (\"low\")</td><td>Specialized access conditions or extenuating circumstances do not exist.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low",
                            "medium"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_access_vector": {
                          "description": "Access Vector (Av) component which reflects how the vulnerability is exploited. <table> <tr><th>Access Vector</th><th>Description</th></tr> <tr><td>Local (\"local\")</td><td>A vulnerability exploitable with only local access requires the attacker to have either physical access to the vulnerable system or a local (shell) account.</td></tr> <tr><td>Adjacent Network (\"adjacent\")</td><td>A vulnerability exploitable with adjacent network access requires the attacker to have access to either the broadcast or collision domain of the vulnerable software.</td></tr> <tr><td>Network (\"network\")</td><td>A vulnerability exploitable with network access means the vulnerable software is bound to the network stack and the attacker does not require local network access or local access. Such a vulnerability is often termed \"remotely exploitable\".</td></tr> </table>",
                          "enum": [
                            "adjacent",
                            "local",
                            "network"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_authentication": {
                          "description": "Authentication (Au) component which measures the number of times an attacker must authenticate to a target in order to exploit a vulnerability. \n<table> <tr><th>Authentication</th><th>Description</th></tr> <tr><td>Multiple (\"multiple\")</td><td>Exploiting the vulnerability requires that the attacker authenticate two or more times, even if the same credentials are used each time.</td></tr> <tr><td>Single (\"single\")</td><td>The vulnerability requires an attacker to be logged into the system.</td></tr> <tr><td>None (\"none\")</td><td>Authentication is not required to exploit the vulnerability.</td></tr> </table>",
                          "enum": [
                            "single",
                            "multiple",
                            "none"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_availability_impact": {
                          "description": "Availability Impact (A) component which measures the impact to availability of a successfully exploited vulnerability. \n<table> <tr><th>Availability Impact</th><th>Description</th></tr> <tr><td>None (\"none)</td><td>There is no impact to the availability of the system.</td></tr> <tr><td>Partial (\"partial\")</td><td>There is reduced performance or interruptions in resource availability.</td></tr> <tr><td>Complete (\"complete\")</td><td>There is a total shutdown of the affected resource. The attacker can render the resource completely unavailable.</td></tr> </table>",
                          "enum": [
                            "none",
                            "complete",
                            "partial"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_confidentiality_impact": {
                          "description": "Confidentiality Impact (C) component which measures the impact on confidentiality of a successfully exploited vulnerability. \n<table> <tr><th>Confidentiality Impact</th><th>Description</th></tr> <tr><td>None (\"none\")</td><td>There is no impact to the confidentiality of the system.</td></tr> <tr><td>Partial (\"partial\")</td><td>There is considerable informational disclosure. Access to some system files is possible, but the attacker does not have control over what is obtained, or the scope of the loss is constrained.</td></tr> <tr><td>Complete (\"complete\")</td><td>There is total information disclosure, resulting in all system files being revealed. The attacker is able to read all of the system's data (memory, files, etc.)</td></tr> </table>",
                          "enum": [
                            "none",
                            "complete",
                            "partial"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_exploit_score": {
                          "description": "The CVSS exploit score.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v2_impact_score": {
                          "description": "The CVSS impact score.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v2_integrity_impact": {
                          "description": "Integrity Impact (I) component measures the impact to integrity of a successfully exploited vulnerability. \n<table> <tr><th>Integrity Impact</th><th>Description</th></tr> <tr><td>None (\"none\")</td><td>There is no impact to the integrity of the system.</td></tr> <tr><td>Partial (\"partial\")</td><td>Modification of some system files or information is possible, but the attacker does not have control over what can be modified, or the scope of what the attacker can affect is limited.</td></tr> <tr><td>Complete (\"complete\")</td><td>There is a total compromise of system integrity. There is a complete loss of system protection, resulting in the entire system being compromised. The attacker is able to modify any files on the target system.</td></tr> </table>",
                          "enum": [
                            "none",
                            "complete",
                            "partial"
                          ],
                          "type": "string"
                        },
                        "cvss_v2_score": {
                          "description": "The CVSS score, which ranges from 0-10.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v2_vector": {
                          "description": "The <a target=\"_blank\" href=\"https://www.first.org/cvss/v2/guide\">CVSS v2</a> vector.",
                          "type": "string"
                        },
                        "cvss_v3_attack_complexity": {
                          "description": "Attack Complexity (AC) component with measures the conditions beyond the attacker's control that must exist in order to exploit the vulnerability. \n\n<table> <tr><th>Access Complexity</th><th>Description</th></tr> <tr><td>Low (\"low\")</td><td>Specialized access conditions or extenuating circumstances do not exist.</td></tr> <tr><td>High (\"high\")</td><td>A successful attack depends on conditions beyond the attacker's control.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_attack_vector": {
                          "description": "Attack Vector (AV) component which measures context by which vulnerability exploitation is possible.</td></tr> <table> <tr><th>Access Vector</th><th>Description</th></tr> <tr><td>Local (\"local\")</td><td>A vulnerability exploitable with only local access requires the attacker to have either physical access to the vulnerable system or a local (shell) account.</td></tr> <tr><td>Adjacent (\"adjacent\")</td><td>A vulnerability exploitable with adjacent network access requires the attacker to have access to either the broadcast or collision domain of the vulnerable software.</td></tr> <tr><td>Network (\"network\")</td><td>A vulnerability exploitable with network access means the vulnerable software is bound to the network stack and the attacker does not require local network access or local access. Such a vulnerability is often termed \"remotely exploitable\".</td></tr> <tr><td>Physical (\"physical\")</td><td>A vulnerability exploitable with Physical access requires the attacker to physically touch or manipulate the vulnerable component.</td></tr> </table>",
                          "enum": [
                            "adjacent",
                            "physical",
                            "local",
                            "network"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_availability_impact": {
                          "description": "Availability Impact (A) measures the impact to the availability of the impacted component resulting from a successfully exploited vulnerability. \n\n<table> <tr><th>Availability Impact</th><th>Description</th></tr> <tr><td>High (\"high\")</td><td>There is total loss of availability, resulting in the attacker being able to fully deny access to resources in the impacted component; this loss is either sustained (while the attacker continues to deliver the attack) or persistent (the condition persists even after the attack has completed).</td></tr> <tr><td>Low (\"low\")</td><td>There is reduced performance or interruptions in resource availability. Even if repeated exploitation of the vulnerability is possible, the attacker does not have the ability to completely deny service to legitimate users.</td></tr> <tr><td>None (\"none\")</td><td>There is no impact to availability within the impacted component.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low",
                            "none"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_confidentiality_impact": {
                          "description": "Confidentiality Impact (C) component which measures the impact on confidentiality of a successfully exploited vulnerability. \n\n<table> <tr><th>Confidentiality Impact</th><th>Description</th></tr> <tr><td>High (\"high\")</td><td>There is total loss of confidentiality, resulting in all resources within the impacted component being divulged to the attacker.</td></tr> <tr><td>Low (\"low\")</td><td>There is some loss of confidentiality. Access to some restricted information is obtained, but the attacker does not have control over what information is obtained, or the amount or kind of loss is constrained.</td></tr> <tr><td>None (\"none\")</td><td>There is no loss of confidentiality within the impacted component.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low",
                            "none"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_exploit_score": {
                          "description": "The CVSS exploit score.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v3_impact_score": {
                          "description": "The CVSS impact score.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v3_integrity_impact": {
                          "description": "Integrity Impact (I) measures the impact to integrity of a successfully exploited vulnerability. Integrity refers to the trustworthiness and veracity of information. \n\n<table> <tr><th>Integrity Impact</th><th>Description</th></tr> <tr><td>High (\"high\")</td><td>There is a total loss of integrity, or a complete loss of protection.</td></tr> <tr><td>Low (\"low\")</td><td>Modification of data is possible, but the attacker does not have control over the consequence of a modification, or the amount of modification is constrained.</td></tr> <tr><td>None (\"none\")</td><td>There is no loss of integrity within the impacted component.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low",
                            "none"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_privileges_required": {
                          "description": "Privileges Required (PR) measures the level of privileges an attacker must possess before successfully exploiting the vulnerability. \n\n<table> <tr><th>Privileges Required</th><th>Description</th></tr> <tr><td>High (\"high\")</td><td>The attacker is authorized with (i.e. requires) privileges that provide significant (e.g. administrative) control over the vulnerable component that could affect component-wide settings and files.</td></tr> <tr><td>Low (\"low\")</td><td>The attacker is authorized with (i.e. requires) privileges that provide basic user capabilities that could normally affect only settings and files owned by a user.</td></tr> <tr><td>None (\"none\")</td><td>The attacker is unauthorized prior to attack, and therefore does not require any access to settings or files to carry out an attack.</td></tr> </table>",
                          "enum": [
                            "high",
                            "low",
                            "none"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_scope": {
                          "description": "Scope (S) measures the collection of privileges defined by a computing authority (e.g. an application, an operating system, or a sandbox environment) when granting access to computing resources (e.g. files, CPU, memory, etc). These privileges are assigned based on some method of identification and authorization. \n\n<table> <tr><th>Scope</th><th>Description</th></tr> <tr><td>Unchanged (\"unchanged\")</td><td>An exploited vulnerability can only affect resources managed by the same authority. In this case the vulnerable component and the impacted component are the same.</td></tr> <tr><td>Changed (\"changed\")</td><td>An exploited vulnerability can affect resources beyond the authorization privileges intended by the vulnerable component. In this case the vulnerable component and the impacted component are different.</td></tr> </table>",
                          "enum": [
                            "unchanged",
                            "changed"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_score": {
                          "description": "The CVSS score, which ranges from 0-10.",
                          "format": "double",
                          "type": "number"
                        },
                        "cvss_v3_user_interaction": {
                          "description": "User Interaction (UI) measures the requirement for a user, other than the attacker, to participate in the successful compromise of the vulnerable component. \n\n<table> <tr><th>User Interaction</th><th>Description</th></tr> <tr><td>None (\"none\")</td><td>The vulnerable system can be exploited without interaction from any user.</td></tr> <tr><td>Required (\"required\")</td><td>Successful exploitation of this vulnerability requires a user to take some action before the vulnerability can be exploited.</td></tr> </table>",
                          "enum": [
                            "none",
                            "required"
                          ],
                          "type": "string"
                        },
                        "cvss_v3_vector": {
                          "description": "The <a target=\"_blank\" href=\"https://www.first.org/cvss/specification-document\">CVSS v3</a> vector.",
                          "type": "string"
                        },
                        "denial_of_service": {
                          "description": "Whether the vulnerability can lead to Denial of Service (DoS).",
                          "type": "boolean"
                        },
                        "description": {
                          "description": "A verbose description of the vulnerability.",
                          "type": "string"
                        },
                        "exploits": {
                          "description": "The exploits that can be used to exploit a vulnerability.",
                          "items": {
                            "$ref": "#/definitions/ExploitSummary"
                          },
                          "type": "array"
                        },
                        "id": {
                          "description": "The identifier of the vulnerability.",
                          "type": "string"
                        },
                        "links": {
                          "description": "References to security standards this vulnerability is a part of.",
                          "items": {
                            "$ref": "#/definitions/AdvisoryLinkSummary"
                          },
                          "type": "array"
                        },
                        "malware_kits": {
                          "description": "The malware kits that are known to be used to exploit the vulnerability.",
                          "items": {
                            "$ref": "#/definitions/MalwareKitSummary"
                          },
                          "type": "array"
                        },
                        "modified": {
                          "description": "The last date the vulnerability was modified. The format is an ISO 8601 date, `YYYY-MM-DD`.",
                          "type": "string"
                        },
                        "pci_cvss_score": {
                          "description": "The CVSS score of the vulnerability, adjusted for PCI rules and exceptions, on a scale of 0-10.",
                          "format": "double",
                          "type": "number"
                        },
                        "pci_fail": {
                          "description": "Whether if present on a host this vulnerability would cause a PCI failure. `true` if compliance status is `\"fail\"`, `false` otherwise.",
                          "type": "boolean"
                        },
                        "pci_severity_score": {
                          "description": "The severity score of the vulnerability, adjusted for PCI rules and exceptions, on a scale of 0-10.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "pci_special_notes": {
                          "description": "Any special notes or remarks about the vulnerability that pertain to PCI compliance.",
                          "type": "string"
                        },
                        "pci_status": {
                          "description": "The PCI compliance status.",
                          "type": "string"
                        },
                        "published": {
                          "description": "The date the vulnerability was first published or announced. The format is an ISO 8601 date, `YYYY-MM-DD`.",
                          "type": "string"
                        },
                        "references": {
                          "description": "References to security standards this vulnerability is a part of, in condensed format (comma-separated): `[<source>:<id>,...]`.",
                          "type": "string"
                        },
                        "risk_score": {
                          "description": "The risk score of the vulnerability. If using the default Rapid7 Real Risk model, this value ranges from 0-1000.",
                          "format": "double",
                          "type": "number"
                        },
                        "severity": {
                          "description": "The severity of the vulnerability.",
                          "enum": [
                            "critical",
                            "low",
                            "severe",
                            "informational",
                            "none",
                            "moderate"
                          ],
                          "type": "string"
                        },
                        "severity_score": {
                          "description": "The severity score of the vulnerability, on a scale of 0-10.",
                          "format": "int32",
                          "type": "integer"
                        },
                        "title": {
                          "description": "The title (summary) of the vulnerability.",
                          "type": "string"
                        }
                      },
                      "title": "[variables('blanks')]",
                      "type": "object"
                    }
                  },
                  "securityDefinitions": {
                    "API Key": {
                      "type": "apiKey",
                      "in": "header",
                      "name": "X-Api-Key"
                    }
                  },
                  "security": [
                    {
                      "API Key": "[variables('TemplateEmptyArray')]"
                    }
                  ],
                  "tags": [
                    {
                      "description": "Endpoints to discover available resources and operations in this API.",
                      "name": "Discovery"
                    },
                    {
                      "description": "Resources and operations for managing assets.",
                      "name": "Asset"
                    },
                    {
                      "description": "Endpoints to monitor service health and quality.",
                      "name": "Health"
                    },
                    {
                      "description": "Resources and operations for managing scans.",
                      "name": "Scan"
                    },
                    {
                      "description": "Resources and operations for managing sites.",
                      "name": "Site"
                    },
                    {
                      "description": "Resources and operations for viewing vulnerability data.",
                      "name": "Vulnerability"
                    }
                  ],
                  "x-tagGroups": [
                    {
                      "tags": [
                        "Discovery",
                        "Health",
                        "Authentication"
                      ],
                      "name": "Administration"
                    },
                    {
                      "tags": [
                        "Asset",
                        "Scan",
                        "Site",
                        "Vulnerability"
                      ],
                      "name": "Resources"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Rapid7InsightVM",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Rapid7InsightVM-EnrichIncidentWithAssetInfo playbook",
        "displayName": "Rapid7InsightVM-EnrichIncidentWithAssetInfo playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "Rapid7InsightVM-EnrichIncidentWithAssetInfo Playbook with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Rapid7InsightVM-EnrichIncidentWithAssetInfo",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "Rapid7InsightVMCloud",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "Rapid7InsightVMCloudConnectionName": "[[concat('rapid7insightvmcloud-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Rapid7InsightVMCloudConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>@{body('Create_HTML_table')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('assets_info')"
                      },
                      "runAfter": {
                        "For_each_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Initialize_variable_assets_info": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP": {
                      "actions": {
                        "For_each_asset": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "assets_info",
                                "value": "@outputs('get_asset_info')"
                              },
                              "runAfter": {
                                "get_asset_info": [
                                  "Succeeded"
                                ]
                              },
                              "type": "AppendToArrayVariable"
                            },
                            "get_asset_info": {
                              "inputs": {
                                "asset_id": "@items('For_each_asset')?['id']",
                                "critical_vulnerabilities": "@items('For_each_asset')?['critical_vulnerabilities']",
                                "exploits": "@items('For_each_asset')?['exploits']",
                                "hostname": "@items('For_each_asset')?['host_name']",
                                "ip": "@items('For_each_asset')?['ip']",
                                "last_scan_end": "@items('For_each_asset')?['last_scan_end']",
                                "os_system_name": "@items('For_each_asset')?['os_system_name']",
                                "risk_score": "@items('For_each_asset')?['risk_score']",
                                "total_vulnerabilities": "@items('For_each_asset')?['total_vulnerabilities']"
                              },
                              "type": "Compose"
                            }
                          },
                          "foreach": "@body('Search_Assets')?['data']",
                          "runAfter": {
                            "Search_Assets": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Search_Assets": {
                          "inputs": {
                            "body": {
                              "asset": "asset.ipv4 = @{items('For_each_IP')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v4/integration/assets"
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable_assets_info": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "assets_info",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "rapid7insightvmcloud": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]",
                        "connectionName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Rapid7InsightVM",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_Rapid7InsightVMCloudAPIConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Rapid7 Insight VM - Enrich incident with asset info",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Obtains IPs from the incident. \n 2. Searches asset ids by the IPs.\n 3. Gets assets information. \n 4. Adds obtained information as a comment to the incident.",
            "prerequisites": [
              "1. Prior to the deployment of this playbook, [Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) needs to be deployed under the same subscription.",
              "2. Obtain Rapid7 InsightVM API credentials. [Refer to Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) documentation."
            ],
            "lastUpdateTime": "2022-09-22T12:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Enrichment"
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the Microsoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Click the Rapid7 connection resource",
              "7.Click edit API connection",
              "8.Provide API key",
              "9.Click Save",
              "**b. Configurations in Sentinel**",
              "1.In Microsoft sentinel, analytical rules should be configured to trigger an incident that contains IPs. In the Entity maping section of the analytics rule creation workflow, IP should be mapped to Address identitfier of the IP entity type. Check the [documentation](https://learn.microsoft.com/azure/sentinel/map-data-fields-to-entities) to learn more about mapping entities.",
              "2.Configure the automation rules to trigger the playbook. Check the [documentation](https://learn.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?tabs=LAC) to learn more about automation rules."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Rapid7 Insight VM - Enrich incident with asset info",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Rapid7InsightVM-EnrichVulnerabilityInfo playbook",
        "displayName": "Rapid7InsightVM-EnrichVulnerabilityInfo playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "Rapid7InsightVM-EnrichVulnerabilityInfo Playbook with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Rapid7InsightVM-EnrichVulnerabilityInfo",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "Rapid7InsightVMCloud",
              "type": "String"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "Rapid7InsightVMCloudConnectionName": "[[concat('rapid7insightvmcloud-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Rapid7InsightVMCloudConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Add_comment_to_incident_(V3)": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "message": "<p>@{body('Create_HTML_table')}</p>"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/Incidents/Comment"
                      },
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Append_to_string_variable": {
                      "inputs": {
                        "name": "vuln_ids_string",
                        "value": "@concat(variables('array_start'), join(variables('vuln_ids'), variables('array_delimiter')), variables('array_end'))"
                      },
                      "runAfter": {
                        "Set_variable_vuln_ids": [
                          "Succeeded"
                        ]
                      },
                      "type": "AppendToStringVariable"
                    },
                    "Create_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('vuln info')"
                      },
                      "runAfter": {
                        "For_each_vuln": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Initialize_variable_vuln_info": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP": {
                      "actions": {
                        "For_each_asset": {
                          "actions": {
                            "For_each_vulnerability": {
                              "actions": {
                                "Append_to_array_variable": {
                                  "inputs": {
                                    "name": "vuln_ids",
                                    "value": "@items('For_each_vulnerability')['vulnerability_id']"
                                  },
                                  "type": "AppendToArrayVariable"
                                }
                              },
                              "foreach": "@body('Parse_JSON')",
                              "runAfter": {
                                "Parse_JSON": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Foreach"
                            },
                            "Parse_JSON": {
                              "inputs": {
                                "content": "@items('For_each_asset')?['same']",
                                "schema": {
                                  "items": {
                                    "properties": {
                                      "vulnerability_id": {
                                        "type": "string"
                                      }
                                    },
                                    "required": [
                                      "vulnerability_id"
                                    ],
                                    "type": "object"
                                  },
                                  "type": "array"
                                }
                              },
                              "type": "ParseJson"
                            }
                          },
                          "foreach": "@body('Search_Assets')?['data']",
                          "runAfter": {
                            "Search_Assets": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Search_Assets": {
                          "inputs": {
                            "body": {
                              "asset": "asset.ipv4 = @{items('For_each_IP')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v4/integration/assets",
                            "queries": {
                              "includeSame": true
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_vuln": {
                      "actions": {
                        "Append_to_array_variable_3": {
                          "inputs": {
                            "name": "vuln info",
                            "value": "@outputs('get_vuln_info')"
                          },
                          "runAfter": {
                            "get_vuln_info": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "get_vuln_info": {
                          "inputs": {
                            "cves": "@items('For_each_vuln')?['cves']",
                            "id": "@items('For_each_vuln')?['id']",
                            "severity": "@items('For_each_vuln')?['severity']",
                            "title": "@items('For_each_vuln')?['title']"
                          },
                          "type": "Compose"
                        }
                      },
                      "foreach": "@body('Search_Vulnerabilities')?['data']",
                      "runAfter": {
                        "Search_Vulnerabilities": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Initialize_variable_array_delimiter": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "array_delimiter",
                            "type": "string",
                            "value": "', '"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_array_end": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_array_end": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "array_end",
                            "type": "string",
                            "value": "']"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_array_start": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_array_start": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "array_start",
                            "type": "string",
                            "value": "[['"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_vuln_ids_string": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_assets_info": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "assets_info",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_vuln_ids": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "vuln_ids",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_assets_info": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_vuln_ids_final": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "vuln_ids_final",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_vuln_ids": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_vuln_ids_string": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "vuln_ids_string",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_vuln_ids_final": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_vuln_info": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "vuln info",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_array_delimiter": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Remove_duplicates_from_vuln_ids": {
                      "actions": {
                        "Condition": {
                          "actions": {
                            "Append_to_array_variable_2": {
                              "inputs": {
                                "name": "vuln_ids_final",
                                "value": "@items('Remove_duplicates_from_vuln_ids')"
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('vuln_ids_final')",
                                    ""
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "foreach": "@variables('vuln_ids')",
                      "runAfter": {
                        "For_each_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Search_Vulnerabilities": {
                      "inputs": {
                        "body": {
                          "vulnerability": "id IN @{variables('vuln_ids_string')}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v4/integration/vulnerabilities",
                        "queries": {
                          "size": 100
                        }
                      },
                      "runAfter": {
                        "Append_to_string_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Set_variable_vuln_ids": {
                      "inputs": {
                        "name": "vuln_ids",
                        "value": "@variables('vuln_ids_final')"
                      },
                      "runAfter": {
                        "Remove_duplicates_from_vuln_ids": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "rapid7insightvmcloud": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]",
                        "connectionName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Rapid7InsightVM",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_Rapid7InsightVMCloudAPIConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Rapid7 Insight VM - Enrich vulnerability info",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Obtains IPs from the incident. \n 2. Searches asset ids by the IPs.\n 3. Gets vulnerability ids.\n 4. Gets vulnerability information.\n 5. Adds obtained information as a comment to the incident.",
            "prerequisites": [
              "1. Prior to the deployment of this playbook, [Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) needs to be deployed under the same subscription.",
              "2. Obtain Rapid7 InsightVM API credentials. [Refer to Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) documentation."
            ],
            "lastUpdateTime": "2022-10-08T12:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Enrichment"
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the Microsoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Click the Rapid7 connection resource",
              "7.Click edit API connection",
              "8.Provide API key",
              "9.Click Save",
              "**b. Configurations in Sentinel**",
              "1.In Microsoft sentinel, analytical rules should be configured to trigger an incident that contains IPs. In the Entity maping section of the analytics rule creation workflow, IP should be mapped to Address identitfier of the IP entity type. Check the [documentation](https://learn.microsoft.com/azure/sentinel/map-data-fields-to-entities) to learn more about mapping entities.",
              "2.Configure the automation rules to trigger the playbook. Check the [documentation](https://learn.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?tabs=LAC) to learn more about automation rules."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Rapid7 Insight VM - Enrich vulnerability info",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2022-02-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Rapid7InsightVM-RunScan playbook",
        "displayName": "Rapid7InsightVM-RunScan playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2022-02-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "Rapid7InsightVM-RunScan Playbook with template version 2.0.3",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Rapid7InsightVM-RunScan",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "Rapid7InsightVMCloud",
              "type": "String"
            },
            "TeamsGroupId": {
              "defaultValue": "TeamsGroupIds",
              "type": "String",
              "metadata": {
                "description": "Id of the Teams Group where the adaptive card will be posted."
              }
            },
            "TeamsChannelId": {
              "defaultValue": "TeamsChannelId",
              "type": "String",
              "metadata": {
                "description": "Id of the Teams Channel where the adaptive card will be posted."
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TeamsConnectionName": "[[concat('teams-', parameters('PlaybookName'))]",
            "Rapid7InsightVMCloudConnectionName": "[[concat('rapid7insightvmcloud-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/teams')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TeamsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('TeamsConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('Rapid7InsightVMCloudConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-3')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Condition": {
                      "actions": {
                        "For_each_asset_id": {
                          "actions": {
                            "Add_comment_to_incident_(V3)": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "message": "<p>@{variables('comment')}</p>"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/Incidents/Comment"
                              },
                              "runAfter": {
                                "Set_variable_4": [
                                  "Succeeded",
                                  "Skipped"
                                ]
                              },
                              "type": "ApiConnection"
                            },
                            "Set_variable_4": {
                              "inputs": {
                                "name": "comment",
                                "value": "Started scan for asset @{items('For_each_asset_id')} and scan engine @{variables('scan_to_run')} "
                              },
                              "runAfter": {
                                "Set_variable_5": [
                                  "Skipped"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Set_variable_5": {
                              "inputs": {
                                "name": "comment",
                                "value": "Asset @{items('For_each_asset_id')} was not sanned by scan engine @{variables('scan_to_run')} because of error."
                              },
                              "runAfter": {
                                "Start_Scan": [
                                  "Failed"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Start_Scan": {
                              "inputs": {
                                "body": {
                                  "asset_ids": [
                                    "@{items('For_each_asset_id')}"
                                  ],
                                  "engine_ids": [
                                    "@variables('scan_to_run')"
                                  ]
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                                  }
                                },
                                "method": "post",
                                "path": "/v4/integration/scan"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "foreach": "@variables('asset_ids_to_scan')",
                          "runAfter": {
                            "Set_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Set_variable": {
                          "inputs": {
                            "name": "scan_to_run",
                            "value": "@{body('Post_adaptive_card_and_wait_for_a_response')['data']['scan_choices']}"
                          },
                          "runAfter": {
                            "Set_variable_3": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Set_variable_3": {
                          "inputs": {
                            "name": "asset_ids_to_scan",
                            "value": "@split(body('Post_adaptive_card_and_wait_for_a_response')['data']['asset_choices'], ',')"
                          },
                          "type": "SetVariable"
                        }
                      },
                      "else": {
                        "actions": {
                          "Add_comment_to_incident_(V3)_2": {
                            "inputs": {
                              "body": {
                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                "message": "<p>@{variables('comment')}</p>"
                              },
                              "host": {
                                "connection": {
                                  "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                }
                              },
                              "method": "post",
                              "path": "/Incidents/Comment"
                            },
                            "runAfter": {
                              "Set_variable_2": [
                                "Succeeded"
                              ]
                            },
                            "type": "ApiConnection"
                          },
                          "Set_variable_2": {
                            "inputs": {
                              "name": "comment",
                              "value": "No assets or scan engines were selected for processing."
                            },
                            "type": "SetVariable"
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "contains": [
                              "@body('Post_adaptive_card_and_wait_for_a_response')",
                              "data"
                            ]
                          },
                          {
                            "contains": [
                              "@body('Post_adaptive_card_and_wait_for_a_response')['data']",
                              "asset_choices"
                            ]
                          },
                          {
                            "contains": [
                              "@body('Post_adaptive_card_and_wait_for_a_response')['data']",
                              "scan_choices"
                            ]
                          }
                        ]
                      },
                      "runAfter": {
                        "Post_adaptive_card_and_wait_for_a_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Initialize_variable_comment": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP": {
                      "actions": {
                        "For_each_asset": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "asset ids",
                                "value": {
                                  "title": "@items('For_each_asset')?['ip']",
                                  "value": "@items('For_each_asset')?['id']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Search_Assets')?['data']",
                          "runAfter": {
                            "Search_Assets": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Search_Assets": {
                          "inputs": {
                            "body": {
                              "asset": "asset.ipv4 = @{items('For_each_IP')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/v4/integration/assets",
                            "queries": {
                              "includeSame": true
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_scan_engine": {
                      "actions": {
                        "Append_to_array_variable_2": {
                          "inputs": {
                            "name": "scans",
                            "value": {
                              "title": "@items('For_each_scan_engine')?['name']",
                              "value": "@items('For_each_scan_engine')?['id']"
                            }
                          },
                          "type": "AppendToArrayVariable"
                        }
                      },
                      "foreach": "@body('Get_Scan_Engines')?['data']",
                      "runAfter": {
                        "Get_Scan_Engines": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Get_Scan_Engines": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['rapid7insightvmcloud']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v4/integration/scan/engine"
                      },
                      "runAfter": {
                        "For_each_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Initialize_variable_TeamsChannelId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "TeamsChannelId",
                            "type": "string",
                            "value": "[[parameters('TeamsChannelId')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_TeamsGroupId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_TeamsGroupId": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "TeamsGroupId",
                            "type": "string",
                            "value": "[[parameters('TeamsGroupId')]"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_asset_ids": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "asset ids",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_TeamsChannelId": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_asset_ids_to_scan": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "asset_ids_to_scan",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_asset_ids": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_comment": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "comment",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_scan_to_run": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_scan_to_run": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "scan_to_run",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_scans": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Initialize_variable_scans": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "scans",
                            "type": "array",
                            "value": "[variables('TemplateEmptyArray')]"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_asset_ids_to_scan": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Post_adaptive_card_and_wait_for_a_response": {
                      "inputs": {
                        "body": {
                          "body": {
                            "messageBody": "@{outputs('create_teams_message')}",
                            "recipient": {
                              "channelId": "@variables('TeamsChannelId')",
                              "groupId": "@variables('TeamsGroupId')"
                            },
                            "updateMessage": "Thanks for your response!"
                          },
                          "notificationUrl": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['teams']['connectionId']"
                          }
                        },
                        "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                      },
                      "runAfter": {
                        "create_teams_message": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnectionWebhook"
                    },
                    "create_teams_message": {
                      "inputs": {
                        "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                        "actions": [
                          {
                            "id": "btnSubmit",
                            "title": "Submit",
                            "type": "Action.Submit"
                          },
                          {
                            "id": "btnIgnore",
                            "title": "Ignore",
                            "type": "Action.Submit"
                          }
                        ],
                        "body": [
                          {
                            "size": "large",
                            "text": "Rapid7InsightVMCloud-RunScan",
                            "type": "TextBlock",
                            "weight": "bolder",
                            "wrap": true
                          },
                          {
                            "text": " Incident No : @{triggerBody()?['object']?['properties']?['incidentNumber']}  ",
                            "type": "TextBlock",
                            "weight": "Bolder",
                            "wrap": true
                          },
                          {
                            "text": "@{triggerBody()?['object']?['properties']?['description']}",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "text": "Select assets and scan engine to run in Rapid7. For more details check the incident:",
                            "type": "TextBlock",
                            "weight": "Bolder",
                            "wrap": true
                          },
                          {
                            "text": "[[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "id": "PollQuestionAction",
                            "text": "Select scan engine",
                            "type": "TextBlock",
                            "wrap": true
                          },
                          {
                            "choices": "@variables('scans')",
                            "id": "scan_choices",
                            "placeholder": "Select from these scan engines",
                            "style": "compact",
                            "type": "Input.ChoiceSet"
                          },
                          {
                            "id": "PollQuestionSeverity",
                            "text": "Select asset",
                            "type": "TextBlock"
                          },
                          {
                            "choices": "@variables('asset ids')",
                            "id": "asset_choices",
                            "isMultiSelect": true,
                            "placeholder": "Select from these assets",
                            "style": "compact",
                            "type": "Input.ChoiceSet"
                          }
                        ],
                        "type": "AdaptiveCard",
                        "version": "1.0"
                      },
                      "runAfter": {
                        "For_each_scan_engine": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "teams": {
                        "connectionName": "[[variables('TeamsConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/teams')]"
                      },
                      "rapid7insightvmcloud": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Rapid7InsightVMCloudConnectionName'))]",
                        "connectionName": "[[variables('Rapid7InsightVMCloudConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Rapid7InsightVM",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_Rapid7InsightVMCloudAPIConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Rapid7 Insight VM - Run scan",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Obtains IPs from the incident. \n 2. Searches asset ids by the IPs.\n 3. Obtains a list of scan engines.\n 4. Sends an adaptive card to the Teams channel where the user can choose an action to be taken.\n 5. Runs scans for selected IPs using chosen scan engines.\n 6. Add inforamtions about launched scans as a comment to the incident.",
            "prerequisites": [
              "1. Prior to the deployment of this playbook, [Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) needs to be deployed under the same subscription.",
              "2. Obtain Rapid7 InsightVM API credentials. [Refer to Rapid7 InsightVM API Connector](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/Rapid7InsightVM/Playbooks/azuredeploy.json) documentation."
            ],
            "lastUpdateTime": "2022-10-08T12:00:00Z",
            "entities": [
              "IP"
            ],
            "tags": [
              "Remediation",
              "Response from teams"
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection.",
              "1.Click the Microsoft Sentinel connection resource",
              "2.Click edit API connection",
              "3.Click Authorize",
              "4.Sign in",
              "5.Click Save",
              "6.Click the Rapid7 connection resource",
              "7.Click edit API connection",
              "8.Provide API key",
              "9.Click Save",
              "**b. Configurations in Sentinel**",
              "1.In Microsoft sentinel, analytical rules should be configured to trigger an incident that contains IPs. In the Entity maping section of the analytics rule creation workflow, IP should be mapped to Address identitfier of the IP entity type. Check the [documentation](https://learn.microsoft.com/azure/sentinel/map-data-fields-to-entities) to learn more about mapping entities.",
              "2.Configure the automation rules to trigger the playbook. Check the [documentation](https://learn.microsoft.com/azure/sentinel/tutorial-respond-threats-playbook?tabs=LAC) to learn more about automation rules."
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Rapid7 Insight VM - Run scan",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.3",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Rapid7InsightVM",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId2')]",
              "version": "[variables('parserVersion2')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_Rapid7InsightVMCloudAPIConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Rapid7InsightVM-EnrichIncidentWithAssetInfo')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Rapid7InsightVM-EnrichVulnerabilityInfo')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Rapid7InsightVM-RunScan')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2021-07-07",
        "providers": [
          "Insight VM / Rapid7"
        ],
        "categories": {
          "domains": [
            "Security - Vulnerability Management",
            "Security - Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
