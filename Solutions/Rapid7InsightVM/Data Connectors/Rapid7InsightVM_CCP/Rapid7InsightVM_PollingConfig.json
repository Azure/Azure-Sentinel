[
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "Rapid7InsightVMCloudAssetsPoller",
    "location": "{{location}}",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "[[parameters('ApiKey')]",
        "ApiKeyName": "X-Api-Key",
        "IsApiKeyInPostPayload": false
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('region'),'.api.insight.rapid7.com/vm/v4/integration/assets?api-version=2016-04-01&includeSame=true&includeUniqueIdentifiers=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 5,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 4,
        "timeoutInSeconds": 30,
        "isPostPayloadJson": true,
        "headers": {
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        "queryParametersTemplate": "{\"asset\": \"last_scan_end < {_QueryWindowEndTime} && last_scan_end > {_QueryWindowStartTime}\"}"
      },
      "response": {
        "eventsJsonPaths": [
          "$.data[*]"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "$.links[?(@.rel=='next')].href",
        "pageSize": 100,
        "pageSizeParameterName": "size"
      },
      "connectorDefinitionName": "Rapid7InsightVMConnector",
      "dataType": "Rapid7InsightVMCloudAssets",
      "dcrConfig": {
        "streamName": "SENTINEL_RAPID7INSIGHTVMCLOUDASSETS",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  },
  {
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "apiVersion": "2024-09-01",
    "name": "Rapid7InsightVMCloudVulnerabilitiesPoller",
    "location": "{{location}}",
    "kind": "RestApiPoller",
    "properties": {
      "auth": {
        "type": "APIKey",
        "ApiKey": "[[parameters('ApiKey')]",
        "ApiKeyName": "X-Api-Key",
        "IsApiKeyInPostPayload": false
      },
      "request": {
        "apiEndpoint": "[[concat('https://',parameters('region'),'.api.insight.rapid7.com/vm/v4/integration/assets?api-version=2016-04-01&includeSame=true&includeUniqueIdentifiers=true')]",
        "httpMethod": "POST",
        "queryWindowInMin": 5,
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "retryCount": 4,
        "timeoutInSeconds": 30,
        "isPostPayloadJson": true,
        "headers": {
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        "queryParametersTemplate": "{\"asset\": \"last_scan_end < {_QueryWindowEndTime} && last_scan_end > {_QueryWindowStartTime}\"}"
      },
      "response": {
        "eventsJsonPaths": [
          "$.data[*].same[*]"
        ],
        "format": "json"
      },
      "paging": {
        "pagingType": "LinkHeader",
        "linkHeaderTokenJsonPath": "$.links[?(@.rel=='next')].href",
        "pageSize": 100,
        "pageSizeParameterName": "size"
      },
      "stepInfo": {
        "stepType": "Nested",
        "nextSteps": [
          {
            "stepId": "step1",
            "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project idPlaceholder = res.vulnerability_id"
          }
        ]
      },
      "stepCollectorConfigs": {
        "step1": {
          "shouldJoinNestedData": false,
          "request": {
            "apiEndpoint": "[[concat('https://',parameters('region'),'.api.insight.rapid7.com/vm/v4/integration/vulnerabilities?api-version=2016-04-01')]",
            "httpMethod": "POST",
            "isPostPayloadJson": true,
            "headers": {
              "Accept": "application/json",
              "Content-Type": "application/json",
              "X-Api-Key": "[[parameters('ApiKey')]"
            },
            "queryParametersTemplate": "{\"vulnerability\": \"id = '$idPlaceholder$'\"}"
          },
          "response": {
            "eventsJsonPaths": [
              "$.data[*]"
            ],
            "format": "json"
          }
        }
      },
      "connectorDefinitionName": "Rapid7InsightVMConnector",
      "dataType": "Rapid7InsightVMCloudVulnerabilities",
      "dcrConfig": {
        "streamName": "SENTINEL_RAPID7INSIGHTVMCLOUDVULNERABILITIES",
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
      }
    }
  }
]