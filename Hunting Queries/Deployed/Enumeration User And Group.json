{
    "name": "User and Group enumeration",
    "description": "The query finds attempts to list users or groups using Net commands",
    "techniques": ["Discovery", "InitialAccess", "Execution", "Persistence", "LateralMovement"],
    "query": "let ProcessCreationEvents=() {\n    let processEvents=SecurityEvent\n    | where EventID==4688\n    | project TimeGenerated, ComputerName=Computer, AccountName=SubjectUserName, AccountDomain=SubjectDomainName, FileName=tostring(split(NewProcessName, '\\\\')[-1]), ProcessCommandLine = CommandLine, InitiatingProcessFileName=ParentProcessName;\n    processEvents\n};\nProcessCreationEvents\n| where FileName == 'net.exe' and AccountName != '' and ProcessCommandLine !contains '\\\\'  and ProcessCommandLine !contains '/add' \n| where (ProcessCommandLine contains ' user ' or ProcessCommandLine contains ' group ') and (ProcessCommandLine endswith ' /do' or ProcessCommandLine endswith ' /domain') \n| extend Target = extract('(?i)[user|group] (\"*[a-zA-Z0-9-_ ]+\"*)', 1, ProcessCommandLine) | filter Target  != '' \n| project AccountName, Target, ProcessCommandLine, ComputerName, TimeGenerated  \n| sort by AccountName, Target"
}