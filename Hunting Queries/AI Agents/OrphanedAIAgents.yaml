id: 5e0f4a6b-7c8d-9e0f-1a2b-3c4d5e6f7a8b
name: AI Agents - Orphaned Agents with Disabled Owners
description: |
  This query identifies Copilot Studio AI agents whose owners are either disabled or removed from the organization. 
  Orphaned agents without an active owner pose governance and security risks because no one is accountable for their configuration, updates, or potential misuse. 
  If these agents remain active, they could retain sensitive connections or perform actions without proper oversight, increasing the risk of unauthorized access or persistence in the environment.
  Recommended Action: Assign a new active owner to each orphaned agent or retire the agent if it`s no longer needed. Regularly review ownership to maintain compliance and security governance.
requiredDataConnectors: []
tactics:
  - Persistence
  - DefenseEvasion
relevantTechniques:
  - T1078
  - T1562
query: |
  let EnabledAccountUpns =  
      IdentityInfo  
      | where IsAccountEnabled == 1  
      | distinct AccountUPN;  
  AIAgentsInfo  
  | summarize arg_max(Timestamp, *) by AIAgentId  
  | where AgentStatus != "Deleted"   
  | where not(OwnerAccountUpns in (EnabledAccountUpns))
  | project-reorder AgentCreationTime, AIAgentId, AIAgentName, AgentStatus, CreatorAccountUpn, OwnerAccountUpns
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: OwnerAccountUpns
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: AIAgentName
version: 1.0.0