id: 8f0a7b1c-2d3e-4f5a-6b7c-8d9e0f1a2b3c
name: AI Agents - Published Generative Orchestration without Instructions
description: |
  'Identifies published AI agents with generative orchestration that lack configured instructions. This may present
  a risk to the agent and heighten the likelihood of the agent being influenced to deviate from the intended course
  of action through prompt injection attacks. Organizations should ensure proper instructions are configured.'
requiredDataConnectors: []
tactics:
  - Impact
  - DefenseEvasion
relevantTechniques:
  - T1499
  - T1562
query: |
 AIAgentsInfo 
  | summarize arg_max(Timestamp, *) by AIAgentId 
  | where AgentStatus != "Deleted" 
  | extend Config = tostring(todynamic(RawAgentInfo).Bot.Attributes.configuration)
  | parse Config with * "\"GenerativeActionsEnabled\":" GenerativeActionsEnabled:boolean * 
  | where GenerativeActionsEnabled 
  | extend  BotComponents = todynamic(RawAgentInfo).BotComponents 
  | mv-expand BotComponent = BotComponents 
  | where BotComponent has "GptComponentMetadata" 
  | where BotComponent.FormattedValues.componenttype == "Custom GPT" 
  | extend InstructionsRaw = tostring(BotComponent.Attributes.data), AIAgentName 
  | where InstructionsRaw has "instructions" 
  | where BotComponent.Attributes.schemaname endswith ".gpt.default" 
  | extend DisplayNamePos = indexof(InstructionsRaw, "displayName", indexof(InstructionsRaw, "instructions:") + strlen("instructions:")) 
  | extend CapabilitiesPos = indexof(InstructionsRaw, "gptCapabilities", indexof(InstructionsRaw, "instructions:") + strlen("instructions:")) 
  | extend InstructionsStart = indexof(InstructionsRaw, "instructions:") + strlen("instructions:") 
  | extend InstructionsEnd = iif( 
      DisplayNamePos != -1 and CapabilitiesPos != -1,  
      iif(DisplayNamePos < CapabilitiesPos, DisplayNamePos, CapabilitiesPos), 
      iif(DisplayNamePos != -1, DisplayNamePos, 
      iif(CapabilitiesPos != -1, CapabilitiesPos, strlen(InstructionsRaw))) 
  ) 
  | extend Instructions = substring(InstructionsRaw, InstructionsStart, InstructionsEnd - InstructionsStart) 
  | where CapabilitiesPos == 43 and CapabilitiesPos == InstructionsEnd
  | project-away DisplayNamePos, CapabilitiesPos, InstructionsStart, InstructionsEnd 
  | project-reorder AgentCreationTime, AIAgentId, AIAgentName, AgentStatus, CreatorAccountUpn, OwnerAccountUpns
  | extend AccountCustomEntity = CreatorAccountUpn
  | extend HostCustomEntity = AIAgentName
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: CreatorAccountUpn
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: AIAgentName
version: 1.0.0
