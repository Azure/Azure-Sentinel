id: 8b3c7d9e-0f1a-2b3c-4d5e-6f7a8b9c0d1e
name: AI Agents - HTTP Requests to Connector Endpoints
description: |
  'Identifies AI agents that use HTTP actions to endpoints that have available Power Platform connectors. This may indicate
  inefficient implementation or potential security risks. Organizations should verify with the agent owner if this is
  necessary and consider using a proper connector instead of direct HTTP calls.'
requiredDataConnectors: []
tactics:
  - DefenseEvasion
relevantTechniques:
  - T1562
query: |
  AIAgentsInfo 
  // Find agents with topic that contains Http request to endpoint with built-in connector 
  | summarize arg_max(Timestamp, *) by AIAgentId 
  | where AgentStatus != "Deleted" 
  | mvexpand Topic = AgentTopicsDetails 
  | where Topic has "HttpRequestAction" 
  | extend TopicActions = Topic.beginDialog.actions 
  | mvexpand action = TopicActions 
  | where action['$kind'] == "HttpRequestAction" 
  | extend Url = tostring(action.url.literalValue) 
  | extend ParsedUrl = parse_url(Url) 
  | extend Host = tostring(ParsedUrl["Host"]) 
  | where Host has_any("graph.microsoft.com", "management.azure.com") 
  | project-reorder AgentCreationTime, AIAgentId, AIAgentName, ParsedUrl, Url, Host, AgentStatus, CreatorAccountUpn, OwnerAccountUpns, Topic
  | extend AccountCustomEntity = CreatorAccountUpn
  | extend HostCustomEntity = AIAgentName
  | extend URLCustomEntity = Url
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: CreatorAccountUpn
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: AIAgentName
  - entityType: URL
    fieldMappings:
      - identifier: Url
        columnName: Url
version: 1.0.0
