id: cb99e25d-bcd9-435b-ad29-de08638b0f78
name: Malware Detections by delivery location
description: |
  This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location.
description-detailed: |
  This query visualises total emails with Malware detections over time summarizing the data daily by Delivery Location.
  Query is also included as part of the Defender for Office 365 solution in Sentinel: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
  - EmailEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  let TimeStart = startofday(ago(30d));
  let TimeEnd = startofday(now());
  EmailEvents
  | where TimeGenerated >= TimeStart
  | where DetectionMethods has "Malware" and EmailDirection == "Inbound"
  | make-series TotalMalwareDetections=count(),Quarantine = countif(DeliveryLocation == "Quarantine"), Failed=countif(DeliveryLocation == "Failed") default = 0 on Timestamp from TimeStart to TimeEnd step 1d
  | render timechart
version: 1.0.0
