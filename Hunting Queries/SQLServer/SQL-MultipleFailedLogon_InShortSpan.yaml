id: aef212b5-c770-42e1-9abf-bc513e4e749c
name: Multiple Failed Logon on SQL Server in Short time Span
description: |
  This hunting queries looks for multiple failed logon attempts in short span of time.
  This query is based on the SQLEvent KQL Parser function (link below)
  SQLEvent KQL Parser provided at https://github.com/Azure/Azure-Sentinel/tree/master/Parsers/SQLSever
  Detailed blog post on Monitoring SQL Server with Azure Sentinel https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-sql-server-with-azure-sentinel/ba-p/1502960
requiredDataConnectors:
  - connectorId: AzureMonitor(WindowsEventLogs)
    dataTypes:
      - Events
query: |

        // the timeframe and threshold can be changed below as per requirement
        //
        let TimeFrame = 10m;
        let failedThreshold = 3;
        SQLEvent
        | where TimeGenerated > ago(TimeFrame) 
        | where LogonResult has "failed"
        | summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), TotalFailedLogons = count() by CurrentUser
        | where TotalFailedLogons >= failedThreshold
        | project CurrentUser, TotalFailedLogons