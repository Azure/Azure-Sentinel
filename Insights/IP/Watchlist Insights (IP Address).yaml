---
BaseQuery: "let defaultValue = 'defaultValue'; \n
    let myIP = '{{Ip_Address}}'; \n
    let ips = _GetWatchlist('NetworkAddresses'); \n
    ips
    | extend IPSubnet = column_ifexists('IP Subnet', defaultValue)
    | extend FirstIP = split(IPSubnet , '-').[0],
             SecondIP = split(IPSubnet, '-').[1],
             checkIPv4 = parse_ipv4(myIP)
    | extend myIPnum = iff(isempty(checkIPv4), (parse_ipv6(myIP)), tostring(checkIPv4))
    | extend firstIPparsed = iff(isempty(checkIPv4), parse_ipv6(tostring(FirstIP)), tostring(parse_ipv4(tostring(FirstIP)))),
             secondIPparsed = iff(isempty(checkIPv4), parse_ipv6(tostring(SecondIP)), tostring(parse_ipv4(tostring(SecondIP))))
    | extend results = iff((isnotempty(checkIPv4) and tolong(firstIPparsed) <= tolong(myIPnum) and
                            (tolong(myIPnum) <= tolong(secondIPparsed)) or
                        (ipv4_is_in_range(myIP, tostring(SecondIP)) or
                        (ipv6_compare(myIP, tostring(FirstIP)) == 0) or
                        (ipv6_compare(myIP, tostring(SecondIP))==0))),
                        True, false)
    | where results == true
    | extend RangeName = column_ifexists('Range Name', defaultValue)
    | extend IPSubnet = column_ifexists('IP Subnet', defaultValue)
    | extend Tags = column_ifexists('Tags', defaultValue)
    | extend ['Watchlist Insight'] = 'IP Address is within a known range'
    | extend ['Additional Data'] = strcat('Range Name: ', RangeName,', ','IP Range: ', IPSubnet)
    | project ['Watchlist Insight'],['Additional Data'], Tags"
DataTypes:
    -
        DataType: "Watchlist templates"
EntitiesFilter: {}
Insights:
    DefaultTimeRange:
        AfterRange: 0d
        BeforeRange: 0d
    Description: |-
        ### Description
         ___
        This insight aggregates data from the watchlists templates (Network Addresses) regarding the IP address.
    DisplayName: "Watchlist Insights (Preview)"
    Id: 3834647e-ac3e-4fb4-a5f8-0dd50ba2b66c
    ReferenceTimeRange:
        BeforeRange: 0d
    SingleValuesQuery: {}
    TableQuery:
        ColumnsDefinitions:
            -
                Header: "Watchlist Insight"
                OutputType: String
                SupportDeepLink: false
            -
                Header: "Additional Data"
                OutputType: String
                SupportDeepLink: false
            -
                Header: Tags
                OutputType: String
                SupportDeepLink: false
        QueriesDefinitions:
            -
                Filter: " where 1 == 1"
                Project: " project ['Watchlist Insight'], ['Additional Data'], Tags"
                Summarize: " summarize count() by ['Watchlist Insight'], ['Additional Data'], Tags"
Provider: Sentinel
RequiredInputFieldsSets:
    -
        - IP_Address
SchemaVersion: "1.0"
Type: KQL
