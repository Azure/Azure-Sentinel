SchemaVersion: 1.0
Provider: Sentinel
Type: KQL
DataTypes:
    - DataType: AzureDiagnostics
RequiredInputFieldsSets:
    - - AzureResource_ResourceId
BaseQuery: |-
    let SensitiveOperationList = dynamic(["VaultDelete", "KeyDelete", "SecretDelete", "SecretPurge", "KeyPurge", "SecretBackup", "KeyBackup"]);
     AzureDiagnostics
     | where ResourceType == "VAULTS"
     | where Category == "AuditEvent"
     | where ResourceId =~ '{{AzureResource_ResourceId}}'
     | extend Result = columnifexists("ResultType", "NoResult")
     | extend requestUri_s = columnifexists("requestUri_s", "None"), identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g = columnifexists("identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g", "None")
     | extend id_s = columnifexists("id_s", "None"), CallerIPAddress = columnifexists("CallerIPAddress", "None"), clientInfo_s = columnifexists("clientInfo_s", "None")
     | where Result !~ "None" and isnotempty(Result)
     | where identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g !~ "None" and isnotempty(identity_claim_http_schemas_microsoft_com_identity_claims_objectidentifier_g)
     | where id_s !~ "None" and isnotempty(id_s)
     | where CallerIPAddress !~ "None" and isnotempty(CallerIPAddress)
     | where clientInfo_s !~ "None" and isnotempty(clientInfo_s)
     | where requestUri_s !~ "None" and isnotempty(requestUri_s)
     | where ResourceType =~ "VAULTS" and Result =~ "Success"
     | where OperationName in~ (SensitiveOperationList)
     | project TimeGenerated, ResourceId, Result, OperationName, CallerIPAddress


Activities:
    EnabledByDefault: true
    Title: "Azure Key Vault sensitive operation"
    Content: "The operation {{OperationName}} was observed from the IP {{CallerIPAddress}} {{Count}} time(s)"
    Items:
        - Id: 5a2b8371-8708-4e41-8613-b64bbcbd0199
          Description: This activity indicated sensitive operation of Azure Key Valut
          QueryDefinitions:
              SummarizeBy: ResourceId, OperationName, CallerIPAddress