{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "Get-SOCTasks",
        "description": "This playbook uses the SOCRA Watchlist to automatically enrich incidents generated by Microsoft Sentinel with Tasks to review and take. Tasks will be evaluated per Customer Organization and edited/modified per their standards of conduct.",
        "prerequisites": [
            "This playbook does a watchlist lookup using an API connection created with in the LogicApp of this playbook to the SOCRA Watchlist and writes the recommended actions to the working incident as a comment. Ensure you have deployed the SOCRA Watchlist prior to deploying this playbook."
        ],
        "postDeployment": [
            "After deploying the playbook, you must authorize the connections leveraged.",
            "1. Visit the playbook resource.",
            "2. Under \"Development Tools\" (located on the left), click \"API Connections\".",
            "3. Ensure each connection has been authorized."
        ],
        "entities": [],
        "tags": [],
        "support": {
            "tier": "community"
        },
        "comments": "This playbook will provide users with Recommended SOC Actions using a .csv file that they upload into a WatchList and give it the the Alias of SocRA. This also contains steps an Analyst should consider taking when an Analytic Detection has not been onboarded to the WatchList .csv file.",
        "author": {
            "name": "Rin Ure",
            "modified": "Nathan Swift"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "Get-SOCTasks",
            "type": "string"
        },
        "UserName": {
            "defaultValue": "<username>@<domain>",
            "type": "string"
        },
        "SubscriptionID": {
            "defaultValue": "<Subscription ID>",
            "type": "string"
        },
        "ResourceGroup": {
            "defaultValue": "<Resource Group>",
            "type": "string",
            "metadata": {
                "description": "Resource group of Workspace for Log Analytics where Sentinel is setup"
            }
        },
        "ResourceName": {
            "defaultValue": "<Log Analytics Workspace Name>",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Sentinel is setup"
            }
        },
        "ResourceType": {
            "defaultValue": "Log Analytics Workspace",
            "type": "string"
        }
    },
    "variables": {
        "AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('PlaybookName'))]",
        "AzureMonitorLogsConnectionName": "[concat('azuremonitorlogs-', parameters('PlaybookName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureSentinelConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[parameters('UserName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureMonitorLogsConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[parameters('UserName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuremonitorlogs')]"
                }
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('PlaybookName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
            ],
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Alert_-_Get_incident": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                            }
                        },
                        "Condition_2": {
                            "actions": {
                                "Add_comment_to_incident_(V3)": {
                                    "runAfter": {
                                        "For_each_2": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "body": {
                                            "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                            "message": "<p>Analytical Procedures have been added as tasks</p>"
                                        },
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/Incidents/Comment"
                                    },
                                    "description": "Update Comments on incident"
                                },
                                "For_each_2": {
                                    "foreach": "@body('Run_query_and_list_results_V2')?['value']",
                                    "actions": {
                                        "Add_task_to_incident": {
                                            "runAfter": {},
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                    "taskDescription": "<p>@{first(skip(split(item()?['value'],'-'),1))}</p>",
                                                    "taskTitle": "@{first(skip(split(item()?['value'],'-'),0))}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/CreateTask"
                                            },
                                            "description": "add a analytical procedure task to the Sentinel incident"
                                        }
                                    },
                                    "runAfter": {
                                        "Run_query_and_list_results_V2": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Foreach",
                                    "description": "for each analytical procedure add a task to the Sentinel incident",
                                    "runtimeConfiguration": {
                                        "concurrency": {
                                            "repetitions": 1
                                        }
                                    }
                                },
                                "Run_query_and_list_results_V2": {
                                    "runAfter": {},
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "body": {
                                            "query": "_GetWatchlist('SocRA') | where Alert == \"Generic Steps\"\n| project-away _DTItemId, LastUpdatedTimeUTC, SearchKey, Alert, Date\n| evaluate narrow()\n| where Value != \"\"\n| sort by Value asc",
                                            "timerange": {
                                                "relativeTimeRange": "Last hour"
                                            },
                                            "timerangetype": "2"
                                        },
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/queryDataV2",
                                        "queries": {
                                            "resourcegroups": "[parameters('ResourceGroup')]",
                                            "resourcename": "[parameters('ResourceName')]",
                                            "resourcetype": "[parameters('ResourceType')]",
                                            "subscriptions": "[parameters('SubscriptionID')]"
                                        }
                                    },
                                    "description": "Look up the generic analytical procedure tasks"
                                }
                            },
                            "runAfter": {
                                "Run_query_and_list_results": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Add_comment_to_incident_(V3)_2": {
                                        "runAfter": {
                                            "For_each": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "body": {
                                                "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                "message": "<p>Analytical Procedures have been added as tasks</p>"
                                            },
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "path": "/Incidents/Comment"
                                        },
                                        "description": "Update Comments on incident"
                                    },
                                    "For_each": {
                                        "foreach": "@body('Run_query_and_list_results_V2_2')?['value']",
                                        "actions": {
                                            "Add_task_to_incident_2": {
                                                "runAfter": {},
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "body": {
                                                        "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                                        "taskDescription": "<p>@{first(skip(split(item()?['value'],'-'),1))}</p>",
                                                        "taskTitle": "@{first(skip(split(item()?['value'],'-'),0))}"
                                                    },
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "path": "/Incidents/CreateTask"
                                                },
                                                "description": "add a analytical procedure task to the Sentinel incident"
                                            }
                                        },
                                        "runAfter": {
                                            "Run_query_and_list_results_V2_2": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Foreach",
                                        "description": "for each analytical procedure add a task to the Sentinel incident",
                                        "runtimeConfiguration": {
                                            "concurrency": {
                                                "repetitions": 1
                                            }
                                        }
                                    },
                                    "Run_query_and_list_results_V2_2": {
                                        "runAfter": {},
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "body": {
                                                "query": "_GetWatchlist('SocRA') | where Alert == \"@{triggerBody()?['AlertDisplayName']}\"\n| project-away _DTItemId, LastUpdatedTimeUTC, SearchKey, Alert, Date\n| evaluate narrow()\n| where Value != \"\"\n| sort by Value asc",
                                                "timerange": {
                                                    "relativeTimeRange": "Last hour"
                                                },
                                                "timerangetype": "Relative"
                                            },
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "path": "/queryDataV2",
                                            "queries": {
                                                "resourcegroups": "[parameters('ResourceGroup')]",
                                                "resourcename": "[parameters('ResourceName')]",
                                                "resourcetype": "[parameters('ResourceType')]",
                                                "subscriptions": "[parameters('SubscriptionID')]"
                                            }
                                        },
                                        "description": "Lookup the analytical procedure tasks for the alert name"
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@empty(body('Run_query_and_list_results')?['value'])",
                                            true
                                        ]
                                    }
                                ]
                            },
                            "type": "If",
                            "description": "If there was no alert match in SOCRA then leverage generic analytical procedure tasks"
                        },
                        "Run_query_and_list_results": {
                            "runAfter": {
                                "Alert_-_Get_incident": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "_GetWatchlist('SocRA') | where Alert == \"@{triggerBody()?['AlertDisplayName']}\"",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/queryData",
                                "queries": {
                                    "resourcegroups": "[parameters('ResourceGroup')]",
                                    "resourcename": "[parameters('ResourceName')]",
                                    "resourcetype": "[parameters('ResourceType')]",
                                    "subscriptions": "[parameters('SubscriptionID')]",
                                    "timerange": "@{utcNow()}"
                                }
                            },
                            "description": "Capture the SOCRA analytical procedures based on alert, used for matching by alert name"
                        }
                    }
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuremonitorlogs": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                                "connectionName": "[variables('AzureMonitorLogsConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuremonitorlogs')]"
                            },
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "connectionName": "[variables('AzureSentinelConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "[concat(parameters('ResourceName'), '/Microsoft.SecurityInsights/SocRA')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "kind": "",
            "properties": {
                "displayName": "SOC Recommended Actions",
                "watchlistAlias": "SocRA",
                "source": "SocRA.csv",
                "description": "SOC Recommended Actions per Alert for Analyst's to action on and Follow.",
                "provider": "Microsoft",
                "isDeleted": false,
                "labels": [],
                "defaultDuration": "P1000Y",
                "contentType": "Text/Csv",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Alert",
                "rawContent": "Alert,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10,A11,A12,A13,A14,A15,A16,A17,A18,A19,Date\r\nPowerShell dropped a Suspicious File on the Machine,1. - Investigate the machine timeline for any other indicators around the time of this alert.,\"2. - Validate contextual information about the relevant components such as file prevalence,  other machines it was observed on etc.\",\"3. - Run a full malware scan on the machine,  this may reveal additional related components.\",4. - Consider submitting the relevant file(s) for deep analysis for detailed behavioral information.,\"5. - If initial investigation confirms suspicions,  escalate and contact your incident response team for forensic analysis or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,,,,2/24/2021\r\nGeneric Steps,1. Group Events for Analysis - The Primary Analyst should review all events/Alerts in the Incident where necessary.  If analysis on any of the events/Alerts is expected to take longer than 5 to 15 minutes, the Primary Analyst will escalate the Incident to Open Incident by tagging it for review by the Secondary Analyst.,\"2. Understanding the Attack - The Primary Analyst should gather and understand the full context of the Incident.  Use Bookmarks to record the following information (this will be added to the Incident TimeLine as an annotation/evidence): Identify Source IP / Destination IP Addresses.\",\"3. Analyze and Assess the Impact of the Attack - The Analysts should investigate any Attack by using any/all internal and external tools and resources.\",4. Determine What Action is Needed - Depending on the severity of the event, an analyst may need to report the Incident in several manners.  The outcome of the analysis should prompt the analyst to perform one or more of the following actions.  Once one of the below actions are taken, the Incident should be tagged using the appropriate annotation/tagging as detailed in the Event Triage Workflow Procedures.\",,,,,,,,,,,,,,,2/24/2021\r\nInternal Brute-Force Attack,1. - Check with account owners to determine if the logon attempts were legitimate.,\"2. - Review processes responsible for the logon attempts. If the processes are unfamiliar and corresponding executables are not signed system files,  submit the files for deep analysis and review detailed behavioral information from the analysis results.\",3. - Review the machine timeline for any suspicious activities that have occurred around the time of the alert. Identify and review other affected machines.,\"4. - If the attempts were malicious,  review all successful attempts from the affected accounts. Contain and mitigate the breach—stop suspicious processes,  isolate affected machines,  decommission compromised accounts or reset their passwords,  block IP addresses and URLs,  and install security updates.\",\"5. - Escalate and contact your incident response team,  or contact Microsoft support for forensic analysis and remediation services.\",,,,,,,,,,,,,,,2/24/2021\r\n'WannaCrypt' ransomware was prevented,1. - Collect artifacts and determine scope.,\"2. - Review the machine timeline for suspicious activities that may have occurred before and after the time of the alert,  and record additional related artifacts (files,  IPs/URLs).\",3. - Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.,4. - Submit relevant files for deep analysis and review resulting detailed behavioral information.,5. - Submit undetected files to the MMPC malware portal.,6. - Initiate containment & mitigation.,7. - Contact the user to verify intent and initiate local remediation actions as needed.,8. - Update AV signatures and run a full scan. The scan might reveal and remove previously-undetected malware components.,\"9. - Ensure that the machine has the latest security updates. In particular,  ensure that you have installed the latest software,  web browser,  and Operating System versions.\",\"10. - If credential theft is suspected,  reset all relevant users passwords.\",11. - Block communication with relevant URLs or IPs at the organization’s perimeter.,\"12. - Escalate - Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,3/18/2021\r\nDevice tried to access a phishing site,1. - Investigate the machine timeline for any other indicators around the time of this alert.,\"2. - Validate contextual information about the relevant components such as file prevalence,  other machines it was observed on etc.\",\"3. - Run a full malware scan on the machine,  this may reveal additional related components.\",4. - Consider submitting the relevant file(s) for deep analysis for detailed behavioral information.,\"5. - If initial investigation confirms suspicions,  escalate and contact your incident response team for forensic analysis or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,,,,2/24/2021\r\nSuspicious PowerShell Command Line,1. - Examine the PowerShell command line to understand what commands were executed. Note: the content may need to be decoded if it is Base64-encoded.,\"2. - Search the script for more indicators to investigate - for example IP addresses (potential C&C servers),  target computers etc.\",3. - Explore the timeline of this and other related machines for additional suspect activities around the time of the alert.,4. - Look for the process that invoked this PowerShell run and their origin. Consider submitting any suspect files in the chain for deep analysis for detailed behavior information.,5. - Escalate and contact your incident response team for potential forensics analysis and remediation.,,,,,,,,,,,,,,,2/24/2021\r\n'Phonzy' malware was prevented,1. - Collect artifacts and determine scope.,\"2. - Review the machine timeline for suspicious activities that may have occurred before and after the time of the alert,  and record additional related artifacts (files,  IPs/URLs).\",3. - Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.,4. - Submit relevant files for deep analysis and review resulting detailed behavioral information.,5. - Submit undetected files to the MMPC malware portal.,6. - Initiate containment & mitigation.,7. - Contact the user to verify intent and initiate local remediation actions as needed.,8. - Update AV signatures and run a full scan. The scan might reveal and remove previously-undetected malware components.,\"9. - Ensure that the machine has the latest security updates. In particular,  ensure that you have installed the latest software,  web browser,  and Operating System versions.\",\"10. - If credential theft is suspected,  reset all relevant users passwords.\",11. - Block communication with relevant URLs or IPs at the organization’s perimeter.,\"12. - Escalate - Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,3/10/2021\r\nConnection to a custom network indicator,1. - Check the destination address. Note that this alert can be triggered by safe or reputable addresses in your custom indicator list.,\"2. - Review the process that initiated the connection. If the process is unfamiliar and the executable not a signed system file,  submit the file for deep analysis and review detailed behavioral information from the analysis results. Initiate an antivirus scan to find previously undetected malware.\",\"3. - If you've confirmed this activity to be malicious, contain and mitigate the breach. Stop suspicious processes, isolate affected machines, decommission compromised accounts or reset their passwords, block IP addresses and URLs, and install security updates.\",\"4. - Escalate - Contact your incident response team, or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,,,,,3/18/2021\r\nEmail reported by user as malware or phish,1. - Validate and scope the alert.,\"2. - Find related mailboxes,  sender addresses,  and files in the incident graph.\",3. - Validate the malware was removed from the users email.,4. - Confirm the scope by looking up the sender under Campains,5. - Open Campaign Report to validate findings.,6. - Save Campaign Report as Evidence to Incident.,7. - Escalate to your IR Team or Resolve by Soft Deleting any remaining Email with malware attached. ,,,,,,,,,,,,,2/26/2021\r\nPort Scan Detected,\"1. - Network scans may indicate legitimate activity,  for example a new network device or new functionality on a device. Scanning activity may also be malicious.\",\"2. - For example the source device performing the scan may be carrying out network reconnaissance in order to test for and leverage potential vulnerabilities. If this succeeds,  system configuration data and other critical information retrieved can be sent to attackers.\",\"3. - If the source device is an approved scanner,  define it as a Scanning Device.\",\"4. - Escalate and contact your incident response team,  or contact Microsoft support for forensic analysis and remediation services.\",,,,,,,,,,,,,,,,2/24/2021\r\nAdaptive application control policy violation was audited,1. - Review the list of applications that were run.,2. - Review the application control policy that is applied to this machine by visiting the Adaptive Application Controls section in the Azure Security Center portal.,\"3. - Review the list of existing rules in each of the rule collections (publisher/path/hash),  and identify the rules that have triggered an audit event for the above applications.\",\"4. - If you have identified a rule that should allow the above applications to run,  review the users that ran them.\",\"5. - In case you wish to allow them and change the application control policy applied to this machine policy group,  make sure to add them to the appropriate rules that you have identified in step #3. Otherwise contact the specific user and escalate this alert for further investigation.\",\"6. - If the above applications are not currently allowed by one of the rules that you have identified in step #3,  and in case that you wish to allow them,  make sure to add a new rule to this machine policy group.\",,,,,,,,,,,,,,2/24/2021\r\n'EICAR_Test_File' malware was prevented,1. - Collect artifacts and determine scope.,\"2. - Review the machine timeline for suspicious activities that may have occurred before and after the time of the alert,  and record additional related artifacts (files,  IPs/URLs).\",3. - Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.,4. - Submit relevant files for deep analysis and review resulting detailed behavioral information.,5. - Submit undetected files to the MMPC malware portal.,6. - Initiate containment & mitigation.,7. - Contact the user to verify intent and initiate local remediation actions as needed.,8. - Update AV signatures and run a full scan. The scan might reveal and remove previously-undetected malware components.,\"9. - Ensure that the machine has the latest security updates. In particular,  ensure that you have installed the latest software,  web browser,  and Operating System versions.\",\"10. - If credential theft is suspected,  reset all relevant users passwords.\",11. - Block communication with relevant URLs or IPs at the organization’s perimeter.,\"12. - Escalate - Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,3/18/2021\r\nInitiate containment & mitigation,1. - Record all relevant artifacts to be used in mitigation rules and as new threat intel.,2. - Contact the user to check if the observed behavior was intended.,3. - Update AV signatures and run a full scan. The scan might reveal and remove previously-undetected malware components.,\"4. - Ensure that the machine has the latest security updates. In particular,  ensure that you have installed the latest software,  web browser,  and Operating System versions.\",\"5. - If credential theft is suspected,  reset all relevant users passwords.\",6. - Disconnect the machine from the network to prevent any threat attack progression.,7. - Block communication with relevant URLs or IPs at the organization’s perimeter.,\"8. - If initial investigation confirms suspicions,  escalate and contact your incident response team for forensic analysis or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,2/24/2021\r\nAnonymous IP Address,\"1. - This risk event type indicates signins from an anonymous IP address (e.g. Tor browser,  anonymizer VPNs). Such IP addresses are commonly used by actors who want to hide their login telemetry (IP address,  location,  device,  etc.) for potentially malicious intent. For more information https://go.microsoft.com/fwlink/?linkid=2016442\",2. - Validate that the IP Address is Malicious.,3. - Run Playbook Get-IPReputation - This pulls down known malicious info about the IP from VirusTotal.,\"4. - If no results return,  IP is not listed. Validate the login with the User.\",\"5. - If results from VT are malicious,  run VT Query in Sentinel.\",\"6. - Create a Bookmark,  assign entities.\",7. - Attach Bookmark to current Incident.,8. - Make notes of what known IOC's are associated with the IP Address.,9. - Validate the login with the User if this step hasnt been done already.,\"10. - After validation,  if the login was malicious,  have the user reset their password.\",\"11. Escalate - Contact your incident response team, or contact Microsoft support for investigation and remediation services.\",,,,,,,,,2/24/2021\r\n'Genasom' ransomware was prevented,1. -  Collect artifacts and determine scope.,\"2. - Review the machine timeline for suspicious activities that may have occurred before and after the time of the alert,  and record additional related artifacts (files,  IPs/URLs).\",3. - Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.,4. - Submit relevant files for deep analysis and review resulting detailed behavioral information.,5. - Submit undetected files to the MMPC malware portal.,6. - Initiate containment & mitigation.,7. - Contact the user to verify intent and initiate local remediation actions as needed.,8. - Update AV signatures and run a full scan. The scan might reveal and remove previously-undetected malware components.,\"9. - Ensure that the machine has the latest security updates. In particular,  ensure that you have installed the latest software,  web browser,  and Operating System versions.\",\"10. - If credential theft is suspected,  reset all relevant users passwords.\",11. - Block communication with relevant URLs or IPs at the organization’s perimeter.,\"12. - Escalate - Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,3/18/2021\r\nSuspicious Attachment Opened,1. - Validate the alert.,2. - Inspect the attachment. Review the process that opened it and its behaviors.,3. - Check for other suspicious activities in the machine timeline.,\"4. - Locate unfamiliar processes in the process tree. Check files for prevalence,  their locations,  and digital signatures.\",5. - Submit relevant files for deep analysis and review file behaviors.,6. - Identify unusual system activity with system owners.,\"7. - Scope the incident. Find related machines,  network addresses,  and files in the incident graph.\",\"8. - Contain and mitigate the breach. Stop suspicious processes,  isolate affected machines,  decommission compromised accounts or reset passwords,  block IP addresses and URLs,  and install security updates.\",\"9. - Escalate Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,2/24/2021\r\nTraffic detected from IP addresses recommended for blocking,1. - Click the link: Investigate in Azure Defender.,2. - Review the IP addresses and determine if they should be communicating with the virtual machine.,\"3. - Enforce the hardening rule recommended by Security Center which will allow access only to recommended IP addresses. You can edit the rule's properties and change the IP addresses to be allowed,  or alternatively edit the Network Security Group's rules directly.\",\"4. - Escalate and contact your incident response team,  or contact Microsoft support for forensic analysis and remediation services.\",,,,,,,,,,,,,,,,2/25/2021\r\nSuspicious attachment opened,1. - Validate the alert.,2. - Inspect the attachment. Review the process that opened it and its behaviors.,3. - Check for other suspicious activities in the machine timeline.,\"4. - Locate unfamiliar processes in the process tree. Check files for prevalence,  their locations,  and digital signatures.\",5. - Submit relevant files for deep analysis and review file behaviors.,6. - Identify unusual system activity with system owners.,\"7. - Scope the incident. Find related machines,  network addresses,  and files in the incident graph.\",\"8. - Contain and mitigate the breach. Stop suspicious processes,  isolate affected machines,  decommission compromised accounts or reset passwords,  block IP addresses and URLs,  and install security updates.\",\"9. - Escalate to your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,3/10/2021\r\nSuspicious authentication activity,1. - Enforce the use of strong passwords and do not re-use them across multiple resources and services,\"2. - In case this is an Azure Virtual Machine,  set up an NSG allow list of only expected IP addresses or ranges.\",\"3. - In case this is an Azure Virtual Machine,  lock down access to it using network JIT\",\"4. - Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,,,,,3/10/2021\r\nA malicious file was detected based on indication provided by O365,1. - Validate the alert and scope the suspected breach.,\"2. - Find related machines,  network addresses,  and files in the incident graph.\",3. - Check for other suspicious activities in the machine timeline.,\"4. - Locate unfamiliar processes in the process tree. Check files for prevalence,  their locations,  and digital signatures.\",5. - Submit relevant files for deep analysis and review file behaviors.,6. - Identify unusual system activity with system owners.,\"7. - If you have validated the alert,  contain and mitigate the breach.\",\"8. - Record relevant artifacts,  including those you need in mitigation rules.\",9. - Stop suspicious processes. Block prevalent malware files across the network.,10. - Isolate affected machines.,\"11. - Identify potentially compromised accounts. If necessary,  reset passwords and decommission accounts.\",\"12. - Block relevant emails, websites, and IP addresses. Remove attack emails from mailboxes.\",13. - Update antimalware signatures and run full scans.,14. - Make sure the machine is completely updated and all your software has the latest patch.,\"15. - Deploy the latest security updates for Windows, web browsers, and other applications.\",\"16. - Escalate - Contact your incident response team, or contact Microsoft support for investigation and remediation services.\",17. - Aditional Actions to Consider Install and run Microsoft’s Malicious Software Removal Tool (see https://www.microsoft.com/download/malicious-software-removal-tool-details.aspx),18. - Aditional Actions to Consider Run Microsoft’s Autoruns utility and try to identify unknown applications that are configured to run at login (see https://technet.microsoft.com/sysinternals/bb963902.aspx).,\",19. - Aditional Actions to Consider - Run Process Explorer and try to identify unknown running processes (see https://technet.microsoft.com/sysinternals/bb896653.aspx)\",3/10/2021\r\nAn Uncommon File was Created and Added to a Run Key,1. - Examine the file in question. Do you recognize it?,2. - Check the machine timeline for the machine in question. Do you see evidence of a breach?,3. - Update AV signatures and run a full scan. This may uncover previously undetected indicators of compromise.,\"4. - If you determine this may be an attack,  reset all relevant user passwords,  disconnect the machine from the network to prevent any threat attack progression,  escalate,  and contact your incident response team for potential forensics analysis and remediation.\",5. - Work with your incident response team and Remove the registry key and file in question or contact Microsoft support for investigation and remediation services.,,,,,,,,,,,,,,,2/24/2021\r\nSign-in for different Locations than Subsidiaries,1. - Click https://portal.azure.com/?hubId=%2Fsubscriptions%2Fc70b37b1-1796-4c29-a35f-345ef020b2a6%2Fresourcegroups%2Fgbb_defenderforiot%2Fproviders%2Fmicrosoft.devices%2Fiothubs%2Fwestushub&alertType=IoT_PortScansDetection&startTime=2021-02-24T02%3A39%3A32.0000000Z&endTime=2021-02-24T02%3A39%3A32.0000000Z&DeviceId=192.168.1.80#blade/Microsoft_AAD_IAM/SecurityMenuBlade/RiskyUsers.,2. - Review the IP addresses and determine if typically logins using that IP.,3. - Validate the login with the User.,4. -  Confirm User has been Compromised.,5. - Escalate to your Incident Response Team or Resolve as False Positive and dismiss the Alert and downgrade the User Risk.,,,,,,,,,,,,,,,2/26/2021\r\nMDE detected malware,1. - Validate the alert and scope the suspected breach.,\"2. - Find related machines,  network addresses,  and files in the incident graph.\",3. - Check for other suspicious activities in the machine timeline.,\"4. - Locate unfamiliar processes in the process tree. Check files for prevalence,  their locations,  and digital signatures.\",5. - Submit relevant files for deep analysis and review file behaviors.,6. - Identify unusual system activity with system owners.,\"7. - If you have validated the alert,  contain and mitigate the breach.\",\"8. - Record relevant artifacts,  including those you need in mitigation rules.\",9. - Stop suspicious processes. Block prevalent malware files across the network.,10. - Isolate affected machines.,\"11. - Identify potentially compromised accounts. If necessary,  reset passwords and decommission accounts.\",\"12. - Block relevant emails, websites, and IP addresses. Remove attack emails from mailboxes.\",13. - Update antimalware signatures and run full scans.,14. - Make sure the machine is completely updated and all your software has the latest patch.,\"15. - Deploy the latest security updates for Windows, web browsers, and other applications.\",\"16. - Escalate - Contact your incident response team, or contact Microsoft support for investigation and remediation services. NOTE: If you don’t have an incident response team, contact Microsoft Support for architectural remediation and forensic.\",17. - Aditional Actions to Consider - Install and run Microsoft’s Malicious Software Removal Tool (see https://www.microsoft.com/download/malicious-software-removal-tool-details.aspx),18. - Aditional Actions to Consider Run Microsoft’s Autoruns utility and try to identify unknown applications that are configured to run at login (see https://technet.microsoft.com/sysinternals/bb963902.aspx).,19. - Aditional Actions to Consider Run Process Explorer and try to identify unknown running processes (see https://technet.microsoft.com/sysinternals/bb896653.aspx).,2/24/2021\r\nEmail messages containing malware removed after delivery,1. - Validate and scope the alert.,\"2. - Find related mailboxes,  sender addresses,  and files in the incident graph.\",3. - Validate the malware was removed from the users email.,4. - Confirm the scope by looking up the sender under Campains,5. - Open Campaign Report to validate findings.,6. - Save Campaign Report as Evidence to Incident.,7. - Escalate to your IR Team or Resolve by Soft Deleting any remaining Email with malware attached.,,,,,,,,,,,,,2/26/2021\r\nImpossible Travel Activity,1. - Validate and scope the alert.,2. -  Check the source of the failed logon attempts for the user. Contact system and account owners to identify unexpected activity.,3. - Check the location where the performed failed sign in activities came from. Check whether they originated outside of the users standard login location and how long before a login was noticed from their normal location. Within how many minutes?,\"4. - Check If the IP addresses are known and safe,  add them in the IP address range page to improve the accuracy of the alerts. Otherwise if Malicious,  add them to the ThreatIntelligence as Indicators/IOCs.\",\"5. - Escalate and contact your incident response team,  or contact Microsoft support for forensic analysis and remediation services.\",,,,,,,,,,,,,,,2/24/2021\r\nPassword spray attack against Azure AD application,\"1. - Use Cloud Authentication In the cloud,  we see billions of sign-ins to Microsoft systems every day. Our security detection algorithms allow us to detect and block attacks as they’re happening. Because these are real time detection and protection systems driven from the cloud,  they are available only when doing Azure AD authentication in the cloud (including Pass Through Authentication).\",\"2. - If your using AAD,  then your covered with Smart Lockout. If your using ADFS,  enable Smart Lockout - https://docs.microsoft.com/windows-server/identity/ad-fs/operations/configure-ad-fs-extranet-smart-lockout-protection.\",3. - Use Attack Simulator to proactively evaluate your security posture and make adjustments - https://techcommunity.microsoft.com/t5/microsoft-security-and/announcing-the-public-preview-of-attack-simulator-for-office-365/ba-p/162412.,\"4. - Work with your Identity Global Admin and Enable MFA. A password is the key to accessing an account, but in a successful password spray attack, the attacker has guessed the correct password. To stop them, we need to use something more than just a password to distinguish between the account owner and the attacker. The three ways to do this are below:,4a. Risk-based MFA.,4b. Always-on MFA.,4c. Azure MFA as Primary Auth.\",\"5. - NOTE: We strongly recommend enabling always-on multi-factor authentication for all admins in your organization, especially subscription owners and tenant admins. Seriously, go do this right now. For the best experience for the rest of your users, we recommend risk-based multi-factor authentication, which is available with Azure AD Premium P2 licenses. Otherwise, use Azure MFA for cloud authentication and ADFS. In ADFS, upgrade to ADFS on Windows Server 2016 to use Azure MFA as primary authentication, especially for all your extranet access.\",\"6. Escalate and contact your incident response team, or contact Microsoft support for forensic analysis and remediation services.\",,,,,,,,,,,,,,2/24/2021\r\nPost-delivery detection of suspicious attachment,1. - Validate the alert.,2. - Inspect the attachment. Review the process that opened it and its behaviors.,3. - Check for other suspicious activities in the machine timeline.,\"4. - Locate unfamiliar processes in the process tree. Check files for prevalence,  their locations,  and digital signatures.\",5. - Submit relevant files for deep analysis and review file behaviors.,6. - Identify unusual system activity with system owners.,\"7. - Scope the incident. Find related machines,  network addresses,  and files in the incident graph.\",\"8. - Contain and mitigate the breach. Stop suspicious processes,  isolate affected machines,  decommission compromised accounts or reset passwords,  block IP addresses and URLs,  and install security updates.\",\"9. - Escalate Contact your incident response team,  or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,3/18/2021\r\nAn Anamolous Scheduled Task was Created,\"1. - Validate the alert,  collect artifacts,  and determine scope.\",2. - Inspect the file or URL/IP for suspicious characteristics is it digitally signed? How prevalent is it? Where is it located? Do the domain registration and hosting history look normal?,3. - Review the machine timeline for suspicious activities that may have occurred before and after the time of the alert.,4. - Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.,5. - Submit relevant files for deep analysis and review resulting detailed behavioral information.,6. - If alert characteristics and machine behavioral evidence constitute a true positive escalate and contact your incident response team for potential forensic analysis and remediation or contact Microsoft support for investigation and remediation services.,,,,,,,,,,,,,,2/24/2021\r\nUnusual sequence of failed logons,1. -  Validate and scope the alert.,2. - Check the source of the failed logon attempts. Contact system and account owners to identify unexpected activity.​,3. - Check other machines for suspicious network communications from the same location.,4. - Check the timelines of all involved machines for other suspicious activities.​,\"5. - Check the process tree of all involved machines for unfamiliar processes. Check files for prevalence, their locations, and digital signatures.\",6. - Submit relevant files for deep analysis and review file behaviors.,\"7. - Contain and mitigate the breach. Stop suspicious processes, isolate affected machines, decommission compromised accounts or reset passwords, block IP addresses and URLs, and install security updates.\",\"8. - Escalate - Contact your incident response team, or contact Microsoft support for investigation and remediation services.\",,,,,,,,,,,,2/24/2021"
              },
            "apiVersion": "2022-08-01"
            }
    ]
}