Parser:
  Title: DNS activity ASIM parser for Azure Firewall
  Version: '0.4.0'
  LastUpdated: Dec 2, 2025
Product:
  Name: Azure Firewall
Normalization:
  Schema: Dns
  Version: '0.1.7'
References:
- Title: ASIM DNS Schema
  Link: https://aka.ms/ASimDnsDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing Azure Firewall logs to the ASIM Dns normalized schema.
ParserName: ASimDnsAzureFirewall
EquivalentBuiltInParser: _ASim_Dns_AzureFirewall
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let legacy_DNS_query=(disabled:bool=false){
    AzureDiagnostics | where not(disabled)
    // | where ResourceType == "AZUREFIREWALLS" -- Implicit in the next line
    | where Category == "AzureFirewallDnsProxy"
    | where msg_s startswith "DNS Request:"
    | project msg_s, TimeGenerated, ResourceId, SubscriptionId
    | parse msg_s with
        "DNS Request: " 
        SrcIpAddr:string ":" SrcPortNumber:int 
        " - " EventOriginalUid:string 
        " " DnsQueryTypeName:string 
        " " DnsQueryClassName:string
        " " DnsQuery:string
        ". " NetworkProtocol:string 
        " " SrcBytes:int 
        " " DnsDNSSECflag:bool 
        " " DnsDNSSECBufferSize:int 
        " " EventResultDetails:string 
        " " DnsFlags:string
        " " DstBytes:int
        " " DnsNetworkDuration:double
        "s"
    | project-away msg_s
    | extend
      EventResult = iff (EventResultDetails == "NOERROR", "Success", "Failure"),
      EventSubType = "response",
      DnsNetworkDuration = toint(DnsNetworkDuration*1000)     
  };
  let legacy_DNS_error=(disabled:bool=false) {
    AzureDiagnostics | where not(disabled)
    // | where ResourceType == "AZUREFIREWALLS" -- Implicit in the next line
    | where Category == "AzureFirewallDnsProxy"
    | project msg_s, TimeGenerated, ResourceId, SubscriptionId
    | where msg_s startswith " Error:"
    | parse msg_s with 
        " Error: " nu:string 
        " " DnsQuery:string 
        ". " DnsQueryTypeName:string 
        ": " op:string 
        " " NetworkProtocol:string
        " " SrcIpAddr:string ":" SrcPortNumber:int 
        "->" DstIpAddr:string ":" DstPortNumber:int  
        ": " EventResultOriginalDetails:string
    | project-away msg_s
    | extend 
      EventResult = "Failure",
      EventSubType = "request"
  };
  let AZFW_Dns = (disabled:bool=false) {
    AZFWDnsQuery
    | where not(disabled)
    | extend DnsNetworkDuration = toint(RequestDurationSecs * 1000) // Convert to ms
    | extend EventResultDetails = iff(ResponseCode == "0", "NA", ResponseCode) // ResponseCode of 0 indicates a request
    | project-rename
        EventMessage = ErrorMessage,
        SrcIpAddr = SourceIp,
        SrcPortNumber = SourcePort,
        DnsQuery = QueryName,
        DnsQueryType = QueryId,
        DnsQueryClassName = QueryClass,
        DnsFlags = ResponseFlags,
        NetworkProtocol = Protocol
    | extend
        EventSubType =  iff(ResponseCode == "0", "request", "response"),
        EventOriginalUid = _ItemId,
        EventResult = iff(ResponseCode == "NOERROR", "Success", "Failure"),
        DnsQueryTypeName = trim(":", QueryType),
        AdditionalFields = bag_pack(
            "DnssecOkBit", DnssecOkBit,
            "RequestSize", RequestSize,
            "EDNS0BufferSize", EDNS0BufferSize,
            "ResponseSize", ResponseSize,
            "SourceSystem", SourceSystem
        )
    | project-away 
        DnssecOkBit,
        EDNS0BufferSize,
        ErrorNumber,
        QueryType,
        RequestDurationSecs,
        RequestSize,
        ResponseCode,
        ResponseSize,
        SourceSystem,
        _ItemId,
        _TimeReceived
  };
  let DNS = (disabled:bool=false) {
    union 
      legacy_DNS_query (disabled),
      legacy_DNS_error (disabled),
      AZFW_Dns (disabled)
    | extend
        NetworkProtocol = toupper(NetworkProtocol),
        DvcId = coalesce(ResourceId, _ResourceId),
        DvcScopeId = coalesce(SubscriptionId, _SubscriptionId)
    | project-away 
        ResourceId,
        SubscriptionId
    | extend
        DvcIdType = "AzureResourceId",
        EventCount = int(1),
        EventStartTime = TimeGenerated,
        EventVendor = "Microsoft",
        EventProduct = "Azure Firewall",
        EventSchema = "Dns",
        EventSchemaVersion = "0.1.7",
        EventEndTime = TimeGenerated, 
        EventType = 'Query',
        DnsFlagsAuthenticated = DnsFlags has "aa",
        DnsFlagsAuthoritative = DnsFlags has "ad",
        DnsFlagsCheckingDisabled = DnsFlags has "cd",
        DnsFlagsRecursionAvailable = DnsFlags has "ra",
        DnsFlagsRecursionDesired = DnsFlags has "rd",
        DnsFlagsTruncates = DnsFlags has "tc"
    | extend
        // -- Aliases
        DnsResponseCodeName=EventResultDetails,
        Domain=DnsQuery,
        IpAddr=SrcIpAddr,
        Src=SrcIpAddr,
        SrcHostname=SrcIpAddr,
        Hostname=SrcIpAddr,
        Dst=DstIpAddr,
        Duration = DnsNetworkDuration,
        Dvc=DvcId
    | extend
        // -- Backward Compatibility
        Query = DnsQuery,
        QueryTypeName = DnsQueryTypeName,
        ResponseCodeName = DnsResponseCodeName,
        Flags = DnsFlags
  };
  DNS(disabled)