Parser:
  Title: DNS activity ASIM parser for Azure Firewall
  Version: '0.1.0'
  LastUpdated: Nov 19, 2025
Product:
  Name: Azure Firewall
Normalization:
  Schema: Dns
  Version: '0.1.7'
References:
- Title: ASIM DNS Schema
  Link: https://aka.ms/ASimDnsDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing the Azure Firewall logs to the ASIM DNS activity normalized schema.
ParserName: ASimDnsAZFW
EquivalentBuiltInParser: _ASim_Dns_AZFW
ParserParams:
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (
    disabled:bool = false
  )
  {
    AZFWDnsQuery
    | where not(disabled)
    // Extract Network Information
    | extend NetworkProtocol = toupper(Protocol)
    | extend DnsNetworkDuration = toint(RequestDurationSecs * 1000) // Convert to ms
    | extend EventResultDetails = iff(ResponseCode == "0", "NA", ResponseCode) // ResponseCode of 0 indicates a request
    | project-rename
        EventMessage = ErrorMessage,
        EventUid = _ItemId,
        Src = SourceIp,
        SrcPortNumber = SourcePort,
        DnsQuery = QueryName,
        DnsQueryType = QueryId,
        DnsQueryClassName = QueryClass,
        DnsResponseCode = ErrorNumber,
        DnsFlags = ResponseFlags
    | extend
        EventStartTime = TimeGenerated,
        EventEndTime = TimeGenerated,
        EventType = "Query",
        EventSubType =  iff(ResponseCode == "0", "request", "response"),
        EventSchema = "Dns",
        EventSchemaVersion = "0.1.7",
        EventVendor = "Microsoft",
        EventProduct = "Azure Firewall",
        EventCount = toint(1),
        EventOriginalUid = EventUid,
        EventResult = iff(ResponseCode == "NOERROR", "Success", "Failure"),
        DvcIdType = "AzureResourceId",
        SrcIpAddr = Src,
        SrcHostname = Src,
        Dvc = _ResourceId,
        DvcId = _ResourceId,
        DvcScopeId = _SubscriptionId,
        Hostname = Src,
        IpAddr = Src,
        Domain = DnsQuery,
        DnsResponseCodeName = EventResultDetails,
        DnsFlagsAuthenticated = DnsFlags has "aa",
        DnsFlagsAuthoritative = DnsFlags has "ad",
        DnsFlagsCheckingDisabled = DnsFlags has "cd",
        DnsFlagsRecursionAvailable = DnsFlags has "ra",
        DnsFlagsRecursionDesired = DnsFlags has "rd",
        DnsFlagsTruncated = DnsFlags has "tc",
        DnsQueryTypeName = trim(":", QueryType),
        Duration = DnsNetworkDuration,
        AdditionalFields = bag_pack(
            "DnssecOkBit", DnssecOkBit,
            "RequestSize", RequestSize,
            "EDNS0BufferSize", EDNS0BufferSize,
            "ResponseSize", ResponseSize,
            "SourceSystem", SourceSystem
        )
    | project
        EventStartTime,
        EventEndTime,
        EventType,
        EventSubType,
        EventSchema,
        EventSchemaVersion,
        EventVendor,
        EventProduct,
        EventCount,
        EventResultDetails,
        EventOriginalUid,
        EventUid,
        EventResult,
        Type,
        Src,
        SrcIpAddr,
        SrcPortNumber,
        SrcHostname,
        DnsQuery,
        DnsQueryType,
        DnsQueryTypeName,
        DnsQueryClassName,
        DnsResponseCode,
        DnsResponseCodeName,
        DnsFlags,
        DnsFlagsAuthenticated,
        DnsFlagsAuthoritative,
        DnsFlagsCheckingDisabled,
        DnsFlagsRecursionAvailable,
        DnsFlagsRecursionDesired,
        DnsFlagsTruncated,
        DnsNetworkDuration,
        Duration,
        Domain,
        NetworkProtocol,
        Dvc,
        DvcId,
        DvcIdType,
        DvcScopeId,
        Hostname,
        IpAddr,
        TimeGenerated,
        AdditionalFields,
        _BilledSize,
        _IsBillable,
        _ResourceId,
        _SubscriptionId,
        TenantId
  };
  parser (disabled = disabled)