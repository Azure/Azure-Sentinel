{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/vimDnsAZFW')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "DNS activity ASIM filtering parser for Azure Firewall",
        "category": "ASIM",
        "FunctionAlias": "vimDnsAZFW",
        "query": "let parser = (\n   starttime:datetime                = datetime(null)\n   , endtime:datetime                = datetime(null)\n   , srcipaddr:string                = '*'\n   , domain_has_any:dynamic          = dynamic([])\n   , responsecodename:string         = '*'\n   , response_has_ipv4:string        = '*'\n   , response_has_any_prefix:dynamic = dynamic([])\n   , eventtype:string                = 'Query'\n   , disabled:bool                   = false\n )\n {\n   AZFWDnsQuery\n   | where not(disabled)\n   // Pre-filtering\n   | where (isnull(starttime) or TimeGenerated >= starttime)\n       and (isnull(endtime) or TimeGenerated <= endtime)\n       and (srcipaddr == \"*\" or has_ipv4(SourceIp, srcipaddr)) \n       and (array_length(domain_has_any) == 0 or QueryName has_any (domain_has_any))\n       and (responsecodename == '*' or ResponseCode == responsecodename)\n       and (response_has_ipv4 == '*' or has_ipv4(SourceIp, response_has_ipv4))\n       and (array_length(response_has_any_prefix) == 0 or has_any_ipv4_prefix(SourceIp, response_has_any_prefix))\n       and (eventtype=='*' or eventtype in (\"Query\", \"lookup\")) // -- support both legacy and standard value\n   // Extract Network Information\n   | extend NetworkProtocol = toupper(Protocol)\n   | extend DnsNetworkDuration = toint(RequestDurationSecs * 1000) // Convert to ms\n   | extend EventResultDetails = iff(ResponseCode == \"0\", \"NA\", ResponseCode) // ResponseCode of 0 indicates a request\n   | project-rename\n       EventMessage = ErrorMessage,\n       EventUid = _ItemId,\n       Src = SourceIp,\n       SrcPortNumber = SourcePort,\n       DnsQuery = QueryName,\n       DnsQueryType = QueryId,\n       DnsQueryClassName = QueryClass,\n       DnsResponseCode = ErrorNumber,\n       DnsFlags = ResponseFlags\n   | extend\n       EventStartTime = TimeGenerated,\n       EventEndTime = TimeGenerated,\n       EventType = \"Query\",\n       EventSubType =  iff(ResponseCode == \"0\", \"request\", \"response\"),\n       EventSchema = \"Dns\",\n       EventSchemaVersion = \"0.1.7\",\n       EventVendor = \"Microsoft\",\n       EventProduct = \"Azure Firewall\",\n       EventCount = toint(1),\n       EventOriginalUid = EventUid,\n       EventResult = iff(ResponseCode == \"NOERROR\", \"Success\", \"Failure\"),\n       DvcIdType = \"AzureResourceId\",\n       SrcIpAddr = Src,\n       SrcHostname = Src,\n       Dvc = _ResourceId,\n       DvcId = _ResourceId,\n       DvcScopeId = _SubscriptionId,\n       Hostname = Src,\n       IpAddr = Src,\n       Domain = DnsQuery,\n       DnsResponseCodeName = EventResultDetails,\n       DnsFlagsAuthenticated = DnsFlags has \"aa\",\n       DnsFlagsAuthoritative = DnsFlags has \"ad\",\n       DnsFlagsCheckingDisabled = DnsFlags has \"cd\",\n       DnsFlagsRecursionAvailable = DnsFlags has \"ra\",\n       DnsFlagsRecursionDesired = DnsFlags has \"rd\",\n       DnsFlagsTruncated = DnsFlags has \"tc\",\n       DnsQueryTypeName = trim(\":\", QueryType),\n       Duration = DnsNetworkDuration,\n       AdditionalFields = bag_pack(\n           \"DnssecOkBit\", DnssecOkBit,\n           \"RequestSize\", RequestSize,\n           \"EDNS0BufferSize\", EDNS0BufferSize,\n           \"ResponseSize\", ResponseSize,\n           \"SourceSystem\", SourceSystem\n       )\n   | project\n       EventStartTime,\n       EventEndTime,\n       EventType,\n       EventSubType,\n       EventSchema,\n       EventSchemaVersion,\n       EventVendor,\n       EventProduct,\n       EventCount,\n       EventResultDetails,\n       EventOriginalUid,\n       EventUid,\n       EventResult,\n       Type,\n       Src,\n       SrcIpAddr,\n       SrcPortNumber,\n       SrcHostname,\n       DnsQuery,\n       DnsQueryType,\n       DnsQueryTypeName,\n       DnsQueryClassName,\n       DnsResponseCode,\n       DnsResponseCodeName,\n       DnsFlags,\n       DnsFlagsAuthenticated,\n       DnsFlagsAuthoritative,\n       DnsFlagsCheckingDisabled,\n       DnsFlagsRecursionAvailable,\n       DnsFlagsRecursionDesired,\n       DnsFlagsTruncated,\n       DnsNetworkDuration,\n       Duration,\n       Domain,\n       NetworkProtocol,\n       Dvc,\n       DvcId,\n       DvcIdType,\n       DvcScopeId,\n       Hostname,\n       IpAddr,\n       TimeGenerated,\n       AdditionalFields,\n       _BilledSize,\n       _IsBillable,\n       _ResourceId,\n       _SubscriptionId,\n       TenantId\n };\n parser (\n     starttime                 = starttime\n     , endtime                 = endtime\n     , srcipaddr               = srcipaddr\n     , domain_has_any          = domain_has_any\n     , responsecodename        = responsecodename\n     , response_has_ipv4       = response_has_ipv4\n     , response_has_any_prefix = response_has_any_prefix\n     , eventtype               = eventtype\n     , disabled                = disabled\n   )",
        "version": 1,
        "functionParameters": "starttime:datetime=datetime(null),endtime:datetime=datetime(null),srcipaddr:string='*',domain_has_any:dynamic=dynamic([]),responsecodename:string='*',response_has_ipv4:string='*',response_has_any_prefix:dynamic=dynamic([]),eventtype:string='Query',disabled:bool=False"
      }
    }
  ]
}