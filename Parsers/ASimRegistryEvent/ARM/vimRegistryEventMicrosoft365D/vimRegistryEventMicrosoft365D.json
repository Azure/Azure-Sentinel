{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/vimRegistryEventMicrosoft365D')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "Registry Event ASIM parser for Microsoft 365 Defender for Endpoint",
        "category": "ASIM",
        "FunctionAlias": "vimRegistryEventMicrosoft365D",
        "query": "let RegistryType = datatable (TypeCode: string, TypeName: string)\n  [\n  \"None\", \"Reg_None\",\n  \"String\", \"Reg_Sz\",\n  \"ExpandString\", \"Reg_Expand_Sz\",\n  \"Binary\", \"Reg_Binary\",\n  \"Dword\", \"Reg_DWord\",\n  \"MultiString\", \"Reg_Multi_Sz\",\n  \"QWord\", \"Reg_QWord\"\n];\nlet parser = (\n    starttime: datetime=datetime(null), \n    endtime: datetime=datetime(null),\n    eventtype_in: dynamic=dynamic([]),\n    actorusername_has_any: dynamic=dynamic([]),\n    registrykey_has_any: dynamic =dynamic([]),\n    registryvalue_has_any: dynamic =dynamic([]),\n    registrydata_has_any: dynamic =dynamic([]),\n    dvchostname_has_any: dynamic=dynamic([]),\n    disabled: bool=false\n    ) {\n    DeviceRegistryEvents\n    | where not(disabled)\n    | where (isnull(starttime) or TimeGenerated >= starttime) \n        and (isnull(endtime) or TimeGenerated <= endtime)\n    | where (array_length(eventtype_in) == 0 or ActionType in~ (eventtype_in)) and\n        (array_length(actorusername_has_any) == 0 or (InitiatingProcessAccountName has_any (actorusername_has_any)) or (InitiatingProcessAccountDomain has_any (actorusername_has_any)) or (strcat(InitiatingProcessAccountDomain, '\\\\', InitiatingProcessAccountName) has_any (actorusername_has_any))) and\n        ((array_length(registrykey_has_any)) == 0 or (RegistryKey has_any (registrykey_has_any)) or (PreviousRegistryKey has_any (registrykey_has_any))) and \n        ((array_length(registryvalue_has_any)) == 0 or (RegistryValueName has_any (registryvalue_has_any)) or (PreviousRegistryValueName has_any (registryvalue_has_any))) and \n        (array_length(registrydata_has_any) == 0 or RegistryValueData has_any (registrydata_has_any)) and\n        (array_length(dvchostname_has_any) == 0 or DeviceName has_any (dvchostname_has_any))\n    | extend\n        // Event\n        EventOriginalUid = tostring(ReportId), \n        EventCount = int(1), \n        EventProduct = 'M365 Defender for Endpoint', \n        EventVendor = 'Microsoft', \n        EventSchemaVersion = '0.1.0', \n        EventStartTime = TimeGenerated, \n        EventEndTime = TimeGenerated, \n        EventType = ActionType,\n        // Registry\n        RegistryKey = iff (ActionType in (\"RegistryKeyDeleted\", \"RegistryValueDeleted\"), PreviousRegistryKey, RegistryKey),\n        RegistryValue = iff (ActionType == \"RegistryValueDeleted\", PreviousRegistryValueName, RegistryValueName),\n        // RegistryValueType -- original name is fine \n        // RegistryValueData -- original name is fine \n        RegistryKeyModified = iff (ActionType == \"RegistryKeyRenamed\", PreviousRegistryKey, \"\"),\n        RegistryValueModified = iff (ActionType == \"RegistryValueSet\", PreviousRegistryValueName, \"\"),\n        // RegistryValueTypeModified -- Not provided by Defender\n        RegistryValueDataModified = PreviousRegistryValueData\n    | where ((array_length(registrykey_has_any)) == 0 or (RegistryKey has_any (registrykey_has_any))) and\n        ((array_length(registryvalue_has_any)) == 0 or (RegistryValue has_any (registryvalue_has_any)))\n    | lookup RegistryType on $left.RegistryValueType == $right.TypeCode\n    | extend RegistryValueType = TypeName\n    | project-away\n        TypeName,\n        PreviousRegistryKey,\n        PreviousRegistryValueName,\n        PreviousRegistryValueData\n    // Device\n    | extend\n        DvcHostname = DeviceName, \n        DvcId = DeviceId, \n        Dvc = DeviceName \n    // Users\n    | extend\n        ActorUsername = iff (InitiatingProcessAccountDomain == '', InitiatingProcessAccountName, strcat(InitiatingProcessAccountDomain, '\\\\', InitiatingProcessAccountName)), \n        ActorUsernameType = iff(InitiatingProcessAccountDomain == '', 'Simple', 'Windows'), \n        ActorUserIdType = 'SID'\n    //| project-away InitiatingProcessAccountDomain, InitiatingProcessAccountName\n    | project-rename\n        ActorUserId = InitiatingProcessAccountSid, \n        ActorUserAadId = InitiatingProcessAccountObjectId, \n        ActorUserUpn = InitiatingProcessAccountUpn\n    // Processes\n    | extend\n        ActingProcessId = tostring(InitiatingProcessId), \n        ParentProcessId = tostring(InitiatingProcessParentId) \n    | project-away InitiatingProcessId, InitiatingProcessParentId\n    | project-rename\n        ParentProcessName = InitiatingProcessParentFileName, \n        ParentProcessCreationTime = InitiatingProcessParentCreationTime, \n        ActingProcessName = InitiatingProcessFolderPath, \n        ActingProcessFileName = InitiatingProcessFileName,\n        ActingProcessCommandLine = InitiatingProcessCommandLine, \n        ActingProcessMD5 = InitiatingProcessMD5, \n        ActingProcessSHA1 = InitiatingProcessSHA1, //OK\n        ActingProcessSHA256 = InitiatingProcessSHA256, \n        ActingProcessIntegrityLevel = InitiatingProcessIntegrityLevel, \n        ActingProcessTokenElevation = InitiatingProcessTokenElevation, \n        ActingProcessCreationTime = InitiatingProcessCreationTime \n    // -- aliases\n    | extend \n        Username = ActorUsername,\n        UserId = ActorUserId,\n        UserIdType = ActorUserIdType,\n        User = ActorUsername,\n        CommandLine = ActingProcessCommandLine,\n        Process = ActingProcessName\n};\nparser (\n    starttime                = starttime,\n    endtime                  = endtime,\n    eventtype_in             = eventtype_in,\n    actorusername_has_any    = actorusername_has_any,\n    registrykey_has_any = registrykey_has_any,\n    registryvalue_has_any = registryvalue_has_any,\n    registrydata_has_any = registrydata_has_any,\n    dvchostname_has_any= dvchostname_has_any,\n    disabled                 = disabled\n)",
        "version": 1,
        "functionParameters": "starttime:datetime=datetime(null),endtime:datetime=datetime(null),eventtype_in:dynamic=dynamic([]),actorusername_has_any:dynamic=dynamic([]),registrykey_has_any:dynamic=dynamic([]),registryvalue_has_any:dynamic=dynamic([]),registrydata_has_any:dynamic=dynamic([]),dvchostname_has_any:dynamic=dynamic([]),disabled:bool=False"
      }
    }
  ]
}
