Parser:
  Title: Network Session ASIM filtering parser for NTANetAnalytics
  Version: '0.1.0'
  LastUpdated: Sep 25, 2025
Product:
  Name: Azure NTANetAnalytics
Normalization:
  Schema: NetworkSession
  Version: '0.2.6'
References:
- Title: ASIM Network Session Schema
  Link: https://aka.ms/ASimNetworkSessionDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports filters and normalizing the Traffic Analytics records for Flowlog enriched data to the ASIM NetworkSession normalized schema.
ParserName: vimNetworkSessionNTANetAnalytics
EquivalentBuiltInParser: _Im_NetworkSession_NTANetAnalytics
ParserParams:
  - Name: starttime
    Type: datetime
    Default: datetime(null)
  - Name: endtime
    Type: datetime
    Default: datetime(null)
  - Name: srcipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: dstipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: ipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: dstportnumber
    Type: int
    Default: int(null)
  - Name: hostname_has_any
    Type: dynamic
    Default: dynamic([])
  - Name: dvcaction
    Type: dynamic
    Default: dynamic([])
  - Name: eventresult
    Type: string
    Default: '*'
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (
    disabled: bool = false,
    starttime: datetime = datetime(null),
    endtime: datetime = datetime(null),
    srcipaddr_has_any_prefix: dynamic = dynamic([]),
    dstipaddr_has_any_prefix: dynamic = dynamic([]),
    ipaddr_has_any_prefix: dynamic = dynamic([]),
    dstportnumber: int = int(null),
    hostname_has_any: dynamic = dynamic([]),
    dvcaction: dynamic = dynamic([]),
    eventresult: string = "*"
  ) {
  // Pre-filter: Check if parser is disabled
  let src_or_any=set_union(srcipaddr_has_any_prefix, ipaddr_has_any_prefix); 
  let dst_or_any=set_union(dstipaddr_has_any_prefix, ipaddr_has_any_prefix);
  let DvcActionLookup=datatable(FlowStatus:string, DvcAction:string, EventResult: string, EventSeverity: string)
  [
      "Allowed", "Allow", "Success", "Informational",
      "Denied", "Deny", "Failure", "Low",
  ];
  let ProtocolLookup=datatable(L4Protocol:string, NetworkProtocol:string)
  [
      "T", "TCP",
      "U", "UDP",
      "TCP", "TCP",
      "UDP", "UDP",
      "ICMP", "ICMP",
  ];
  NTANetAnalytics
  | where not(disabled)
  // Pre-filter Time
  | where isnull(starttime) or FlowStartTime >= starttime
  | where isnull(endtime) or FlowStartTime <= endtime
  // Pre-filter FlowLogs in source schema
  | where SubType == "FlowLog"
  // Pre-filter DST Port Number
  | where isnull(dstportnumber) or DestPort == dstportnumber
  // Pre-filter DvcAction
  | lookup DvcActionLookup on FlowStatus
  | where array_length(dvcaction) == 0 or DvcAction has_any (dvcaction)
  // Pre-filter Event result
  | where eventresult == "*" or (eventresult == "Success" and EventResult == "Success") or (eventresult == "Failure" and EventResult == "Failure")
  // Pre-filter IPs
  | extend temp_SrcMatch = has_any_ipv4_prefix(SrcIp, src_or_any), temp_DstMatch = has_any_ipv4_prefix(DestIp, dst_or_any)
  | extend ASimMatchingIpAddr = case(
    array_length(src_or_any) == 0 and array_length(dst_or_any) == 0 ,"-",
    temp_SrcMatch and temp_DstMatch, "Both",
    temp_SrcMatch, "SrcIpAddr",
    temp_DstMatch, "DstIpAddr",
    "No match"
  )
  | where ASimMatchingIpAddr != "No match"
  // Pre-filter by hostname
  | extend
      temp_SrcHostMatch = SrcVm has_any(hostname_has_any) or SrcIp has_any(hostname_has_any),
      temp_DstHostMatch = DestVm has_any(hostname_has_any) or DestIp has_any(hostname_has_any)
  | extend ASimMatchingHostname = case(
      array_length(hostname_has_any) == 0, "-",
      temp_SrcHostMatch and temp_DstHostMatch, "Both",
      temp_SrcHostMatch, "SrcDomain",
      temp_DstHostMatch, "DstDomain",
      "No match"
    )
  | where ASimMatchingHostname != "No match" 
  | extend
      SrcHostname = case(isnotempty(SrcVm), extract(@"([^/]+)$", 1, SrcVm),""),
      DstHostname = case(isnotempty(DestVm), extract(@"([^/]+)$", 1, SrcVm),""),
      SrcPortNumber = toint(split(SrcPorts, "|")[0])
  | lookup ProtocolLookup on L4Protocol
  | extend
      EventCount = toint(iif(CompletedFlows != 0, CompletedFlows, 1)),
      EventType = "Flow",
      EventSchema = "NetworkSession",
      EventSchemaVersion = "0.2.6",
      EventProduct = "Azure NSG flows",
      EventVendor = "Microsoft",
      Dvc = "Azure NSG flows"
  | project-rename
      EventStartTime = FlowStartTime,
      EventEndTime = FlowEndTime,
      SrcIpAddr = SrcIp,
      DstIpAddr = DestIp,
      DstPortNumber = DestPort,
      SrcBytes = BytesSrcToDest,
      DstBytes = BytesDestToSrc,
      SrcPackets = PacketsSrcToDest,
      DstPackets = PacketsDestToSrc,
      SrcGeoCountry = Country,
      NetworkDirection = FlowDirection,
      SrcSubscriptionId = SrcSubscription,
      DstSubscriptionId = DestSubscription,
      EventUid = _ItemId,
      NetworkRuleName = AclRule,
      SrcInterfaceName = SrcNic,
      DstInterfaceName = DestNic
  // Map other values
  | extend 
      NetworkPackets = SrcPackets + DstPackets,
      NetworkBytes = SrcBytes + DstBytes,
      EventOriginalResultDetails = case(
          FlowType == "Malicious", "Malicious",
          FlowType == "Unknown", "Unknown",
          FlowType == "Unknown Private", "Unknown",
          ""),
      DstHostname = coalesce(DstHostname, DstIpAddr),
      SrcHostname = coalesce(SrcHostname, SrcIpAddr),
      NetworkApplicationProtocol = toupper(L7Protocol),
      Src = coalesce(SrcHostname, SrcIpAddr),
      Dst = coalesce(DstHostname, DstIpAddr),
      DstDvcScopeId = DstSubscriptionId,
      SrcDvcScopeId = SrcSubscriptionId,
      SrcZone = case(
          FlowType == "IntraVNet", "Internal",
          FlowType == "ExternalPublic", "Internet",
          FlowType == "AzurePublic", "Azure",
          FlowType == "InterVNet", "Internal",
          FlowType == "S2S", "S2S",
          FlowType == "P2S", "P2S",
          "Unknown"
      ),
      DstDvcId = case(NetworkDirection == "Inbound", TargetResourceId, ""),
      DstDvcIdType = case(NetworkDirection == "Inbound", "AzureResourceId", ""),
      SrcDvcId = case(NetworkDirection == "Outbound", TargetResourceId, ""),
      SrcDvcIdType = case(NetworkDirection == "Outbound", "AzureResourceId", ""),
      DstMacAddr = case(NetworkDirection == "Inbound", MacAddress, ""),
      SrcMacAddr = case(NetworkDirection == "Outbound", MacAddress, ""),
      Hostname = DstHostname,
      IpAddr = SrcIpAddr
  | project 
      EventStartTime,
      EventEndTime,
      EventSchema,
      TimeGenerated,
      SrcIpAddr,
      DstIpAddr,
      SrcHostname,
      DstHostname,
      DstPortNumber,
      NetworkDirection,
      SrcSubscriptionId,
      DstSubscriptionId,
      DstDvcScopeId = DstSubscriptionId,
      DstDvcScope = DstSubscriptionId,
      SrcDvcScopeId = SrcSubscriptionId,
      SrcDvcScope = SrcSubscriptionId,
      SrcInterfaceName,
      DstInterfaceName,
      SrcGeoCountry,
      DstPackets,
      SrcPackets,
      NetworkPackets,
      DstBytes,
      SrcBytes,
      NetworkBytes,
      NetworkRuleName,
      Type,
      EventUid,
      ASimMatchingIpAddr,
      ASimMatchingHostname,
      DvcAction,
      EventResult,
      EventSeverity,
      SrcPortNumber,
      NetworkProtocol,
      EventCount,
      EventType,
      EventSchemaVersion,
      EventProduct,
      EventVendor,
      Dvc,
      NetworkApplicationProtocol,
      Src,
      Dst,
      DstMacAddr,
      SrcMacAddr,
      Hostname,
      IpAddr,
      DstDvcId,
      DstDvcIdType,
      SrcDvcId,
      SrcDvcIdType,
      SrcZone
  };
  parser (
      starttime=starttime, 
      endtime=endtime, 
      srcipaddr_has_any_prefix=srcipaddr_has_any_prefix, 
      dstipaddr_has_any_prefix=dstipaddr_has_any_prefix, 
      ipaddr_has_any_prefix=ipaddr_has_any_prefix, 
      dstportnumber=dstportnumber, 
      hostname_has_any=hostname_has_any, 
      dvcaction=dvcaction,
      eventresult=eventresult,
      disabled=disabled
  )