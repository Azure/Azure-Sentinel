{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/ASimNetworkSessionNTANetAnalytics')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "Network Session ASIM parser for NTANetAnalytics",
        "category": "ASIM",
        "FunctionAlias": "ASimNetworkSessionNTANetAnalytics",
        "query": "let parser = (\n  disabled: bool = false\n) {\nlet DvcActionLookup=datatable(FlowStatus:string, DvcAction:string, EventResult: string, EventSeverity: string)\n[\n    \"Allowed\", \"Allow\", \"Success\", \"Informational\",\n    \"Denied\", \"Deny\", \"Failure\", \"Low\",\n];\nlet ProtocolLookup=datatable(L4Protocol:string, NetworkProtocol:string)\n[\n    \"T\", \"TCP\",\n    \"U\", \"UDP\",\n    \"TCP\", \"TCP\",\n    \"UDP\", \"UDP\",\n    \"ICMP\", \"ICMP\",\n];\nNTANetAnalytics\n| where not(disabled)\n| where SubType == \"FlowLog\"\n// Pre-filter DvcAction\n| lookup DvcActionLookup on FlowStatus\n| extend\n    SrcHostname = case(isnotempty(SrcVm), extract(@\"([^/]+)$\", 1, SrcVm),\"\"),\n    DstHostname = case(isnotempty(DestVm), extract(@\"([^/]+)$\", 1, SrcVm),\"\"),\n    SrcPortNumber = toint(split(SrcPorts, \"|\")[0])\n| lookup ProtocolLookup on L4Protocol\n| extend\n    EventCount = toint(iif(CompletedFlows != 0, CompletedFlows, 1)),\n    EventType = \"Flow\",\n    EventSchema = \"NetworkSession\",\n    EventSchemaVersion = \"0.2.6\",\n    EventProduct = \"Azure NSG flows\",\n    EventVendor = \"Microsoft\",\n    Dvc = \"Azure NSG flows\"\n| project-rename\n    EventStartTime = FlowStartTime,\n    EventEndTime = FlowEndTime,\n    SrcIpAddr = SrcIp,\n    DstIpAddr = DestIp,\n    DstPortNumber = DestPort,\n    SrcBytes = BytesSrcToDest,\n    DstBytes = BytesDestToSrc,\n    SrcPackets = PacketsSrcToDest,\n    DstPackets = PacketsDestToSrc,\n    SrcGeoCountry = Country,\n    NetworkDirection = FlowDirection,\n    SrcSubscriptionId = SrcSubscription,\n    DstSubscriptionId = DestSubscription,\n    EventUid = _ItemId,\n    NetworkRuleName = AclRule,\n    SrcInterfaceName = SrcNic,\n    DstInterfaceName = DestNic\n// Map other values\n| extend \n    NetworkPackets = SrcPackets + DstPackets,\n    NetworkBytes = SrcBytes + DstBytes,\n    EventOriginalResultDetails = case(\n        FlowType == \"Malicious\", \"Malicious\",\n        FlowType == \"Unknown\", \"Unknown\",\n        FlowType == \"Unknown Private\", \"Unknown\",\n        \"\"),\n    DstHostname = coalesce(DstHostname, DstIpAddr),\n    SrcHostname = coalesce(SrcHostname, SrcIpAddr),\n    NetworkApplicationProtocol = toupper(L7Protocol),\n    Src = coalesce(SrcHostname, SrcIpAddr),\n    Dst = coalesce(DstHostname, DstIpAddr),\n    DstDvcScopeId = DstSubscriptionId,\n    SrcDvcScopeId = SrcSubscriptionId,\n    SrcZone = case(\n        FlowType == \"IntraVNet\", \"Internal\",\n        FlowType == \"ExternalPublic\", \"Internet\",\n        FlowType == \"AzurePublic\", \"Azure\",\n        FlowType == \"InterVNet\", \"Internal\",\n        FlowType == \"S2S\", \"S2S\",\n        FlowType == \"P2S\", \"P2S\",\n        \"Unknown\"\n    ),\n    DstDvcId = case(NetworkDirection == \"Inbound\", TargetResourceId, \"\"),\n    DstDvcIdType = case(NetworkDirection == \"Inbound\", \"AzureResourceId\", \"\"),\n    SrcDvcId = case(NetworkDirection == \"Outbound\", TargetResourceId, \"\"),\n    SrcDvcIdType = case(NetworkDirection == \"Outbound\", \"AzureResourceId\", \"\"),\n    DstMacAddr = case(NetworkDirection == \"Inbound\", MacAddress, \"\"),\n    SrcMacAddr = case(NetworkDirection == \"Outbound\", MacAddress, \"\"),\n    Hostname = DstHostname,\n    IpAddr = SrcIpAddr\n| project \n    EventStartTime,\n    EventEndTime,\n    EventSchema,\n    TimeGenerated,\n    SrcIpAddr,\n    DstIpAddr,\n    SrcHostname,\n    DstHostname,\n    DstPortNumber,\n    NetworkDirection,\n    SrcSubscriptionId,\n    DstSubscriptionId,\n    DstDvcScopeId = DstSubscriptionId,\n    DstDvcScope = DstSubscriptionId,\n    SrcDvcScopeId = SrcSubscriptionId,\n    SrcDvcScope = SrcSubscriptionId,\n    SrcInterfaceName,\n    DstInterfaceName,\n    SrcGeoCountry,\n    DstPackets,\n    SrcPackets,\n    NetworkPackets,\n    DstBytes,\n    SrcBytes,\n    NetworkBytes,\n    NetworkRuleName,\n    Type,\n    EventUid,\n    DvcAction,\n    EventResult,\n    EventSeverity,\n    SrcPortNumber,\n    NetworkProtocol,\n    EventCount,\n    EventType,\n    EventSchemaVersion,\n    EventProduct,\n    EventVendor,\n    Dvc,\n    NetworkApplicationProtocol,\n    Src,\n    Dst,\n    DstMacAddr,\n    SrcMacAddr,\n    Hostname,\n    IpAddr,\n    DstDvcId,\n    DstDvcIdType,\n    SrcDvcId,\n    SrcDvcIdType,\n    SrcZone\n};\nparser(disabled=disabled)",
        "version": 1,
        "functionParameters": "disabled:bool=False"
      }
    }
  ]
}