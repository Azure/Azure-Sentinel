{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/vimNetworkSessionAzureVNet')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "Network Session ASIM filtering parser for Azure VNet flows",
        "category": "ASIM",
        "FunctionAlias": "vimNetworkSessionAzureVNet",
        "query": "let DvcActionLookup = datatable(FlowStatus:string, DvcAction:string, EventResult:string) [\n    'Allowed', 'Allow', 'Success',\n    'Denied', 'Deny', 'Failure',\n];\nlet NetworkDirectionLookup = datatable(FlowDirection:string, NetworkDirection:string, isOutBound:bool) [\n   'Inbound', 'Inbound', false,\n   'Outbound', 'Outbound', true\n];\nlet parser = (\n      starttime:datetime=datetime(null), \n      endtime:datetime=datetime(null),\n      srcipaddr_has_any_prefix:dynamic=dynamic([]), \n      dstipaddr_has_any_prefix:dynamic=dynamic([]), \n      ipaddr_has_any_prefix:dynamic=dynamic([]),\n      dstportnumber:int=int(null), \n      hostname_has_any:dynamic=dynamic([]), \n      dvcaction:dynamic=dynamic([]), \n      eventresult:string='*', \n      disabled:bool=false)\n{\n  let src_or_any=set_union(srcipaddr_has_any_prefix, ipaddr_has_any_prefix); \n  let dst_or_any=set_union(dstipaddr_has_any_prefix, ipaddr_has_any_prefix); \n  let prefilter = (T:(TimeGenerated:datetime, SrcIp:string, SrcPublicIPs:string, DestIp:string, DestPublicIPs:string, DestPort:real, FlowStatus:string, SrcVm:string, DestVm:string)) { \n    T\n    | where\n      (isnull(dstportnumber) or dstportnumber == toint(DestPort)) \n    | extend dataSrcIPs = strcat(SrcIp,\" \",SrcPublicIPs),\n             dataDstIPs = strcat(DestIp,\" \",DestPublicIPs)\n    | extend temp_isSrcMatch=has_any_ipv4_prefix(dataSrcIPs,src_or_any)\n           , temp_isDstMatch=has_any_ipv4_prefix(dataDstIPs,dst_or_any)\n    | extend ASimMatchingIpAddr = case(\n          array_length(src_or_any) == 0 and array_length(dst_or_any) == 0, \"-\" // match not requested: probably most common case\n          , (temp_isSrcMatch and temp_isDstMatch), \"Both\" // has to be checked before the individual \n          , temp_isSrcMatch, \"SrcIpAddr\"\n          , temp_isDstMatch, \"DstIpAddr\"\n          , \"No match\"\n        )\n    | where ASimMatchingIpAddr != \"No match\"\n    | extend temp_is_MatchSrcHostname = SrcVm has_any (hostname_has_any)\n            , temp_is_MatchDstHostname = DestVm has_any (hostname_has_any)\n    | extend ASimMatchingHostname = case(array_length(hostname_has_any) == 0 ,\"-\",\n                                temp_is_MatchSrcHostname and temp_is_MatchDstHostname, \"Both\",\n                                temp_is_MatchSrcHostname, \"SrcHostname\",\n                                temp_is_MatchDstHostname, \"DstHostname\",\n                                \"No match\"\n                              )\n    | where ASimMatchingHostname != \"No match\"\n    | project-away temp_*\n    | lookup DvcActionLookup on FlowStatus\n    | where array_length(dvcaction) == 0 or DvcAction in (dvcaction)\n    | where (eventresult=='*' or EventResult == eventresult)\n  }; // prefilter ends\n  let AzureNetworkAnalytics = \n    NTANetAnalytics\n    | where\n     (isnull(starttime) or TimeGenerated >= starttime)\n      and  (isnull(endtime) or TimeGenerated <= endtime)\n    | where not(disabled) and isnotempty(FlowType)\n    | lookup NetworkDirectionLookup on FlowDirection\n  ;\n  let NTANetAnalyticsInbound =\n    AzureNetworkAnalytics\n    | where not(isOutBound)\n    | invoke prefilter()\n    | project-rename\n        DstMacAddr = MacAddress\n    | extend\n        DstBytes = tolong(BytesSrcToDest), // -- size fields seem not to be populated for inbound\n        DstPackets = tolong(PacketsSrcToDest),\n        SrcBytes = tolong(BytesDestToSrc),\n        SrcPackets = tolong(PacketsDestToSrc),\n        //SrcInterfaceName = tostring(split(NIC_s, '/')[1]), //--need to update\n        SrcGeoCountry = toupper(Country)\n    | extend hostelements=split(DestVm,'/') \n    | extend \n        DstFQDN = strcat(hostelements[0], @\"\\\", hostelements[1]), \n        DstHostname = tostring(hostelements[1]), \n        DstDomain = tostring(hostelements[0]), \n        DstDomainType = \"ResourceGroup\"\n    | extend Hostname = DstHostname\n    | project-away hostelements, isOutBound\n  ;\n  let NTANetAnalyticsOutbound =\n    AzureNetworkAnalytics\n    | where isOutBound\n    | invoke prefilter()\n    | project-rename\n        SrcMacAddr = MacAddress\n    | extend\n        SrcBytes = tolong(BytesSrcToDest), \n        SrcPackets = tolong(PacketsSrcToDest),\n        DstBytes = tolong(BytesDestToSrc),\n        DstPackets = tolong(PacketsDestToSrc),\n        //DstInterfaceName = tostring(split(NIC_s, '/')[1]), //--need to update\n        DstGeoCountry = toupper(Country)\n    | extend hostelements=split(SrcVm,'/')\n    | extend \n        SrcFQDN = strcat(hostelements[0], @\"\\\", hostelements[1]),\n        SrcHostname = tostring(hostelements[1]),\n        SrcDomain = tostring(hostelements[0]),\n        SrcDomainType = \"ResourceGroup\"\n    | extend Hostname = SrcHostname\n    | project-away hostelements, isOutBound\n  ;\n  union NTANetAnalyticsInbound, NTANetAnalyticsOutbound\n  | project-rename\n      Dvc = NsgList,\n      DvcSubscriptionId = SrcSubscription, //--need to check\n      EventEndTime = FlowEndTime,\n      EventStartTime = FlowStartTime,\n      NetworkApplicationProtocol = L7Protocol,\n      NetworkRuleName = NsgRule,\n      NetworkSessionId = ConnectionName,\n      EventOriginalSubType = FlowType\n    | extend\n      DstPortNumber = toint(DestPort),\n      EventProduct = 'NSGFlow',\n      EventSchema = 'NetworkSession',\n      EventSchemaVersion='0.2.6',\n      EventSeverity = 'Informational', //??\n      EventType = 'Flow',\n      EventVendor = 'Microsoft',\n      EventCount = toint(AllowedInFlows+DeniedInFlows+AllowedOutFlows+DeniedOutFlows),\n      NetworkDuration = toint((((EventEndTime - datetime(1970-01-01)) / 1s) - ((EventStartTime - datetime(1970-01-01)) / 1s )) * 1000),\n      Rule = NetworkRuleName,\n      SessionId = NetworkSessionId\n    | lookup DvcActionLookup on FlowStatus  //--need to check\n    | extend \n      DstIpAddr = iff(isnotempty(DestIp),\n                      DestIp,\n                      split(DestPublicIps, '|')[0]),\n      Duration = NetworkDuration,\n      NetworkBytes = tolong(DstBytes + SrcBytes),\n      NetworkPackets = tolong(DstPackets + SrcPackets),\n      SrcIpAddr = iff(isnotempty(SrcIp),\n                      SrcIp,\n                      split(SrcPublicIps, '|')[0])\n    | extend\n      Dst = DstIpAddr,\n      IpAddr = SrcIpAddr,\n      Src = SrcIpAddr\n    | extend NetworkProtocol = L4Protocol\n    | project-keep\n      Src*,\n      Dst*,\n      Event*,\n      Dvc*,\n      Network*,\n      IpAddr,\n      Hostname,\n      Type,\n      Duration,\n      SessionId,\n      TimeGenerated\n  };\nparser (starttime, endtime, srcipaddr_has_any_prefix, dstipaddr_has_any_prefix, ipaddr_has_any_prefix, dstportnumber, hostname_has_any, dvcaction, eventresult, disabled)",
        "version": 1,
        "functionParameters": "starttime:datetime=datetime(null),endtime:datetime=datetime(null),srcipaddr_has_any_prefix:dynamic=dynamic([]),dstipaddr_has_any_prefix:dynamic=dynamic([]),ipaddr_has_any_prefix:dynamic=dynamic([]),dstportnumber:int=int(null),hostname_has_any:dynamic=dynamic([]),dvcaction:dynamic=dynamic([]),eventresult:string='*',disabled:bool=False"
      }
    }
  ]
}