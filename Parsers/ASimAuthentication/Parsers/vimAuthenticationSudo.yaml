Parser:
  Title: Authentication ASIM filtering parser for Syslog sudo
  Version: '0.2.0'
  LastUpdated: Jan 29, 2026
Product:
  Name: sudo
Normalization:
  Schema: Authentication
  Version: '0.1.4'
References:
- Title: ASIM Authentication Schema
  Link: https://aka.ms/ASimAuthenticationDoc
- Title: ASIM
  Link: https://aka.ms/AboutASIM
Description: |
  This ASIM parser supports normalizing Syslog sudo sign in logs to the ASIM Authentication schema.
ParserName: vimAuthenticationSudo
EquivalentBuiltInParser: _Im_Authentication_Sudo
ParserParams:
  - Name: starttime
    Type: datetime
    Default: datetime(null)
  - Name: endtime
    Type: datetime
    Default: datetime(null)
  - Name: username_has_any
    Type: dynamic
    Default: dynamic([])
  - Name: targetappname_has_any
    Type: dynamic
    Default: dynamic([])
  - Name: srcipaddr_has_any_prefix
    Type: dynamic
    Default: dynamic([])
  - Name: srchostname_has_any
    Type: dynamic
    Default: dynamic([])
  - Name: eventtype_in
    Type: dynamic
    Default: dynamic([])
  - Name: eventresultdetails_in
    Type: dynamic
    Default: dynamic([])
  - Name: eventresult
    Type: string
    Default: '*'
  - Name: disabled
    Type: bool
    Default: false
ParserQuery: |
  let parser = (starttime: datetime=datetime(null), 
    endtime: datetime=datetime(null), 
    username_has_any: dynamic = dynamic([]),
    targetappname_has_any: dynamic = dynamic([]),
    srcipaddr_has_any_prefix: dynamic = dynamic([]),
    srchostname_has_any: dynamic = dynamic([]),
    eventtype_in: dynamic = dynamic([]),
    eventresultdetails_in: dynamic = dynamic([]),
    eventresult: string = '*',
    disabled: bool=false) {
    let SeverityLevelLookup = datatable (SeverityLevel: string, EventSeverity: string)
    [
        "info", "Informational",
        "notice", "Informational",
        "alert", "Low",
        "error", "Medium",
        "err", "Medium",
        "critical", "High",
        "warning", "Low",
        "warn", "Low",
        "debug", "Informational",
        "crit", "High"
    ];
    let SudoLogs = Syslog
    | where not(disabled)
    | where ProcessName == "sudo"
    // Initial pre-filtering
    | where (isnull(starttime) or TimeGenerated >= starttime)
        and (isnull(endtime) or TimeGenerated <= endtime)
        and ((array_length(username_has_any) == 0) or SyslogMessage has_any (username_has_any))
        and (array_length(targetappname_has_any) == 0 or "sudo" in~ (targetappname_has_any))
        and ((array_length(srcipaddr_has_any_prefix) == 0) or has_any_ipv4_prefix(HostIP, srcipaddr_has_any_prefix))
        and ((array_length(srchostname_has_any) == 0) or HostName has_any (srchostname_has_any));
        // EventType, EventResult, EventResultDetails filtering done later in parser
    let SudoSignInAuthorized = () {
        SudoLogs
        | where ((array_length(eventtype_in) == 0) or "Logon" in~ (eventtype_in))
            and (eventresult == "*" or ('Success' == eventresult))
            and (array_length(eventresultdetails_in) == 0 or 'Other' in~ (eventresultdetails_in))
        | where SyslogMessage has 'TTY=' and 
            SyslogMessage has 'USER=' and
            SyslogMessage has 'COMMAND='
        | parse-kv SyslogMessage as (TTY: string, PWD: string, USER: string, COMMAND: string) with (pair_delimiter=' ', kv_delimiter='=')
        | project-rename TargetUsername = USER
        | extend
            EventResult                 = 'Success',
            EventType                   = 'Logon',
            ActorUsernameType           = 'Simple',
            ActorUsername               = extract(@'^(.*?):', 1, SyslogMessage),
            EventResultDetails          = 'Other',
            EventOriginalResultDetails = 'Connection authorized'
    };
    let SudoAuthenticationFailure = () {
        SudoLogs
        | where ((array_length(eventtype_in) == 0) or "Logon" in~ (eventtype_in))
          and (array_length(eventresultdetails_in) == 0 or 'No such user or password' in~ (eventresultdetails_in))
          and (eventresult == "*" or ('Failure' == eventresult))
        | where (SyslogMessage has 'user NOT in sudoers' or SyslogMessage has 'incorrect password attempts')
        | parse-kv SyslogMessage as (TTY: string, PWD: string, USER: string, COMMAND: string) with  (pair_delimiter=' ', kv_delimiter='=')
        | project-rename 
            TargetUsername = USER
        | extend
            EventResult                 = 'Failure',
            EventType                   = 'Logon',
            ActorUsername               = extract(@'^(.*?):', 1, SyslogMessage),
            ActorUsernameType           = 'Simple',
            EventResultDetails          = 'No such user or password',
            EventOriginalResultDetails  = 'User authentication failed'
    };
    let SudoDisconnect = () {
        SudoLogs
        | where ((array_length(eventtype_in) == 0) or "Logoff" in~ (eventtype_in))
          and (array_length(eventresultdetails_in) == 0 or 'Other' in~ (eventresultdetails_in))
          and (eventresult == "*" or ('Success' == eventresult))
        | where SyslogMessage has 'session closed for user '
        | parse SyslogMessage with * "for user " TargetUsername:string
        | extend
            EventResult                 = 'Success',
            EventType                   = 'Logoff',
            EventOriginalResultDetails = 'User session closed',
            EventResultDetails          = 'Other'
    };
    union isfuzzy=false 
        SudoSignInAuthorized(), 
        SudoAuthenticationFailure(),
        SudoDisconnect()
        | extend
            EventCount = int(1),
            EventStartTime = TimeGenerated,
            EventEndTime = TimeGenerated,
            EventSchema = "Authentication",
            EventSchemaVersion = "0.1.4",
            EventVendor = "Linux",
            EventProduct = "sudo",
            TargetUsernameType = "Simple",
            Type = "Syslog",
            ActingAppId = tostring(ProcessID)
        | extend
            SrcIpAddr = iff(ipv4_is_in_range(HostIP, "0.0.0.0/0"), HostIP, ""),
            TargetAppType = "Process"
        | lookup SeverityLevelLookup on SeverityLevel
        | project-rename
            SrcHostname = HostName,
            DvcHostname = Computer,
            EventOriginalSeverity = SeverityLevel,
            ActingAppName = ProcessName,
            EventUid = _ItemId
        // mapping ASimMatchingUsername
        | extend
          temp_isMatchTargetUsername = TargetUsername has_any(username_has_any),
          temp_isMatchActorUsername = ActorUsername has_any(username_has_any)
        | extend ASimMatchingUsername = case(
            array_length(username_has_any) == 0, "-",
            temp_isMatchTargetUsername and temp_isMatchActorUsername, "Both",
            temp_isMatchTargetUsername, "TargetUsername",
            temp_isMatchActorUsername, "ActorUsername",
            "No match")
        | extend
            TargetAppName = ActingAppName,
            Application = ActingAppName,
            User = TargetUsername,
            DvcIpAddr = SrcIpAddr,
            IpAddr = SrcIpAddr,
            Src = coalesce(SrcIpAddr, SrcHostname),
            Dvc = coalesce(SrcIpAddr, DvcHostname)
        | project
            TimeGenerated,
            EventCount,
            EventStartTime,
            EventEndTime,
            EventSchema,
            EventSchemaVersion,
            EventVendor,
            EventProduct,
            EventResult,
            EventType,
            ActorUsername,
            ActorUsernameType,
            EventResultDetails,
            EventOriginalResultDetails,
            TargetUsername,
            TargetUsernameType,
            Type,
            SrcIpAddr,
            SrcHostname,
            EventSeverity,
            DvcHostname,
            EventOriginalSeverity,
            ActingAppName,
            ActingAppId,
            EventUid,
            Src,
            Dvc,
            TargetAppName,
            TargetAppType,
            Application,
            User,
            DvcIpAddr,
            IpAddr,
            ASimMatchingUsername
  };
  parser(starttime=starttime,
      endtime=endtime,
      username_has_any=username_has_any,
      targetappname_has_any=targetappname_has_any,
      srcipaddr_has_any_prefix=srcipaddr_has_any_prefix,
      srchostname_has_any=srchostname_has_any,
      eventtype_in=eventtype_in,
      eventresultdetails_in=eventresultdetails_in,
      eventresult=eventresult,
      disabled=disabled)