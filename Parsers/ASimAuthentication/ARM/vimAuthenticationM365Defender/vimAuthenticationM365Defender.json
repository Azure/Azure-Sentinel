{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('Workspace')]",
      "location": "[parameters('WorkspaceRegion')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "vimAuthenticationM365Defender",
          "dependsOn": [
            "[concat('Microsoft.OperationalInsights/workspaces/', parameters('Workspace'))]"
          ],
          "properties": {
            "etag": "*",
            "displayName": "Authentication ASIM filtering parser for M365 Defender Device Logon Events",
            "category": "ASIM",
            "FunctionAlias": "vimAuthenticationM365Defender",
            "query": "let FaliureReason=datatable(EventOriginalResultDetails:string, EventResultDetails:string)[\n  'InvalidUserNameOrPassword','No such user or password'\n  ];\nlet AuthM365D=(starttime:datetime=datetime(null), endtime:datetime=datetime(null), targetusername_has:string=\"*\", disabled:bool=false){\n  DeviceLogonEvents  | where not(disabled)\n// ************************************************************************* \n//       <Prefilterring>\n// *************************************************************************\n| where \n  (isnull(starttime)   or TimeGenerated >= starttime) \n  and (isnull(endtime)     or TimeGenerated <= endtime) \n  and (targetusername_has=='*' or (AccountName has targetusername_has))\n// ************************************************************************* \n//       </Prefilterring>\n// ************************************************************************* \n  //\n  | project-rename \n     EventOriginalResultDetails=FailureReason \n  | extend \n  // ----  Event\n      EventSubType=iff(LogonType=='Remote interactive (RDP) logons','RemoteInteractive',LogonType)\n     , EventCount=int(1)\n     , EventStartTime=TimeGenerated\n     , EventEndTime=TimeGenerated\n     , EventOriginalType = LogonType\n     , EventProduct='M365 Defender for EndPoint'\n     ,  EventResult = case(ActionType =='LogonSuccess', 'Success'\n                          , ActionType=='LogonFailed', 'Failure'\n                          , ActionType=='LogonAttempted', 'NA'\n                          , 'NA')\n    , EventSchemaVersion='0.1.0'\n    , EventType='Logon'\n    , EventVendor ='Microsoft'\n   //  ----   Target and Actor Users\n   | project-rename \n       TargetUserId=AccountSid\n     , ActorUserId =InitiatingProcessAccountSid\n     , ActorUserUpn=InitiatingProcessAccountUpn\n     , ActorUserObjectId=InitiatingProcessAccountObjectId\n    | extend \n       TargetUserIdType ='SID'\n     , TargetUsername = strcat(AccountDomain,'\\\\',AccountName)\n     , TargetUsernameType='Windows'\n     , ActorUserIdType='SID'\n     , ActorUsername=coalesce(ActorUserUpn, strcat(InitiatingProcessAccountDomain,'\\\\',InitiatingProcessAccountName)) // InitiatingProcessAccountName\n     , ActorUsernameType=case(isnotempty( ActorUserUpn), 'Upn/Email'\n                              , isnotempty(InitiatingProcessAccountDomain), 'Windows'\n                              , 'Simple')\n     , TargetDvcHostname=tostring(split(DeviceName,'.')[0])\n     , TargetDvcFQDN=DeviceName\n    | project-rename \n      LogonProtocol=Protocol\n    , TargetDvcId=DeviceId\n    , SrcDvcIpAddr=RemoteIP\n    , OriginalEventUid=ReportId\n    , SrcDvcHostname=RemoteDeviceName \n  //\n  , ActingProcessCommandLine = InitiatingProcessCommandLine\n  , ActingProcessCreationTime=InitiatingProcessCreationTime\n  , ActingProcessPath=InitiatingProcessFolderPath\n  , ActingProcessMD5=InitiatingProcessMD5\n  , ActingProcessSHA1=InitiatingProcessSHA1\n  , ActingProcessSHA256= InitiatingProcessSHA256\n  , ActingProcessIntegrityLevel= InitiatingProcessIntegrityLevel\n  , ActingProcessTokenElevation=InitiatingProcessTokenElevation\n  , ParentProcessName=InitiatingProcessParentFileName\n  , ParentProcessCreationTime=InitiatingProcessParentCreationTime\n    | extend \n    ActingProcessId=tostring(InitiatingProcessId)\n    , ParentProcessId=tostring(InitiatingProcessParentId)\n    ,   ActingProcessName=iff(ActingProcessPath hassuffix InitiatingProcessFileName\n                          , ActingProcessPath\n                          , strcat(ActingProcessPath,'\\\\',InitiatingProcessFileName))\n    ,  TargetDvcHostnameType='FQDN'\n    , TargetDvcIdType='MDE'\n    , TargetPortNumber=RemotePort\n    , TargetSessionId = tostring(LogonId)\n    | lookup FaliureReason on EventOriginalResultDetails \n  // TargetUrl \n  // -----------  Alias\n    | extend \n      User=TargetUsername \n      , LogonTarget=TargetDvcHostname\n      , Dvc=TargetDvcHostname\n      };AuthM365D(starttime, endtime, targetusername_has, disabled)",
            "version": 1,
            "functionParameters": "starttime:datetime=datetime(null),endtime:datetime=datetime(null),targetusername_has:string='*',disabled:bool=False"
          }
        }
      ]
    }
  ]
}