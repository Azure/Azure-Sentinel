{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/vimAuditEventAWSCloudTrail')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "Audit Event ASIM filtering parser for AWS CloudTrail activity",
        "category": "ASIM",
        "FunctionAlias": "vimAuditEventAWSCloudTrail",
        "query": "let parser = (\n      starttime:datetime=datetime(null), \n      endtime:datetime=datetime(null),\n      srcipaddr_has_any_prefix:dynamic=dynamic([]), \n      eventresult:string='*',\n      actorusername_has_any:dynamic=dynamic([]),\n      eventtype_in:dynamic=dynamic([]),\n      operation_has_any:dynamic=dynamic([]),\n      object_has_any:dynamic=dynamic([]),\n      newvalue_has_any:dynamic=dynamic([]),\n      disabled:bool = false\n) {\nAWSCloudTrail\n| where not(disabled)\n| where\n    (isnull(starttime) or TimeGenerated >= starttime) \n    and (isnull(endtime) or TimeGenerated <= endtime)\n| where (array_length(newvalue_has_any) == 0)\n| where (array_length(srcipaddr_has_any_prefix) == 0 or has_any_ipv4_prefix(SourceIpAddress,srcipaddr_has_any_prefix))\n| where (array_length(actorusername_has_any) == 0 or UserIdentityUserName has_any (actorusername_has_any))\n| where (array_length(operation_has_any) == 0 or EventTypeName has_any (operation_has_any))\n| extend\n    EventSchema = 'AuditEvent',\n    EventSchemaVersion = '0.1.2',\n    EventSubType = EventName,\n    EventCount = int(1),\n    EventStartTime = TimeGenerated,\n    EventEndTime = TimeGenerated,\n    EventProduct = \"CloudTrail\",\n    EventVendor = \"AWS\",\n    Dvc = \"CloudTrail\",\n    Type = \"AWSCloudTrail\",\n    EventUid = AwsEventId,\n    EventMessage = ErrorMessage,\n    EventOriginalType = EventTypeName,\n    EventProductVersion = EventVersion,\n    EventResult = iff(isempty(ErrorMessage) == True and isempty(ErrorCode) == True, 'Success', 'Failure')\n    | where eventresult == \"*\" or (EventResult == eventresult)\n    | extend EventType = case (\n        EventName startswith \"Access\", \"Read\",\n        EventName startswith \"Abort\", \"Stop\",\n        EventName startswith \"Accept\", \"Enable\",\n        EventName startswith \"Activate\", \"Initialize\",\n        EventName startswith \"Add\", \"Create\",\n        EventName startswith \"Allocate\", \"Enable\",\n        EventName startswith \"Allow\", \"Enable\",\n        EventName startswith \"Alter\", \"Set\",\n        EventName startswith \"Analyze\", \"Read\",\n        EventName startswith \"Apply\", \"Set\",\n        EventName startswith \"Approve\", \"Enable\",\n        EventName startswith \"Archive\", \"Set\",\n        EventName startswith \"Assign\", \"Set\",\n        EventName startswith \"Associate\", \"Set\",\n        EventName startswith \"Assume\", \"Execute\",\n        EventName startswith \"Attach\", \"Set\",\n        EventName startswith \"Authenticate\", \"Execute\",\n        EventName startswith \"Authorize\", \"Execute\",\n        EventName startswith \"BackupDatabase\", \"Create\",\n        EventName startswith \"Build\", \"Initialize\",\n        EventName startswith \"Calculate\", \"Execute\",\n        EventName startswith \"Cancel\", \"Stop\",\n        EventName startswith \"Chat\", \"Execute\",\n        EventName startswith \"Check\", \"Read\",\n        EventName startswith \"Claim\", \"Execute\",\n        EventName startswith \"Classify\", \"Set\",\n        EventName startswith \"Clone\", \"Execute\",\n        EventName startswith \"Close\", \"Disable\",\n        EventName startswith \"Compare\", \"Execute\",\n        EventName startswith \"Configure\", \"Set\",\n        EventName startswith \"Confirm\", \"Execute\",\n        EventName startswith \"Continue\", \"Execute\",\n        EventName startswith \"Console\", \"Execute\",\n        EventName startswith \"Converse\", \"Execute\",\n        EventName startswith \"Copy\", \"Create\",\n        EventName startswith \"Create\", \"Create\",\n        EventName startswith \"Credential\", \"Execute\",\n        EventName startswith \"Deactivate\", \"Disable\",\n        EventName startswith \"Decrease\", \"Execute\",\n        EventName startswith \"Delete\", \"Delete\",\n        EventName startswith \"Decode\", \"Execute\",\n        EventName startswith \"Deliver\", \"Execute\",\n        EventName startswith \"Describe\", \"Read\",\n        EventName startswith \"Disable\", \"Disable\",\n        EventName startswith \"Disconnect\", \"Disable\",\n        EventName startswith \"Download\", \"Read\",\n        EventName startswith \"Enable\", \"Enable\",\n        EventName startswith \"End\", \"Stop\",\n        EventName startswith \"Export\", \"Execute\",\n        EventName startswith \"Change\", \"Set\",\n        EventName startswith \"Complete\", \"Execute\",\n        EventName startswith \"Convert\", \"Set\",\n        EventName startswith \"Decrypt\", \"Execute\",\n        EventName startswith \"Deregister\", \"Disable\",\n        EventName startswith \"Detect\", \"Execute\",\n        EventName startswith \"Detach\", \"Delete\",\n        EventName startswith \"Disassociate\", \"Disable\",\n        EventName startswith \"Discover\", \"Execute\",\n        EventName startswith \"Dispose\", \"Clear\",\n        EventName startswith \"Drop\", \"Delete\",\n        EventName startswith \"Encrypt\", \"Execute\",\n        EventName startswith \"Enter\", \"Initialize\",\n        EventName startswith \"Evaluate\", \"Execute\",\n        EventName startswith \"Execute\", \"Execute\",\n        EventName startswith \"Exit\", \"Stop\",\n        EventName startswith \"Expire\", \"Disable\",\n        EventName startswith \"Federate\", \"Execute\",\n        EventName startswith \"Git\", \"Execute\",\n        EventName startswith \"Group\", \"Set\",\n        EventName startswith \"Failover\", \"Other\",\n        EventName startswith \"Finalize\", \"Other\",\n        EventName startswith \"Find\", \"Read\",\n        EventName startswith \"Filter\", \"Read\",\n        EventName startswith \"Flush\", \"Execute\",\n        EventName startswith \"Forgot\", \"Execute\",\n        EventName startswith \"Generate\", \"Create\",\n        EventName startswith \"Get\", \"Read\",\n        EventName startswith \"Grant\", \"Enable\",\n        EventName startswith \"Head\", \"Read\",\n        EventName startswith \"Import\", \"Create\",\n        EventName startswith \"Increase\", \"Set\",\n        EventName startswith \"Index\", \"Execute\",\n        EventName startswith \"Infer\", \"Execute\",\n        EventName startswith \"Ingest\", \"Set\",\n        EventName startswith \"Initia\", \"Initialize\",\n        EventName startswith \"Invite\", \"Execute\",\n        EventName startswith \"Invoke\", \"Execute\",\n        EventName startswith \"IsMember\", \"Read\",\n        EventName startswith \"Issue\", \"Execute\",\n        EventName startswith \"JobStatus\", \"Other\",\n        EventName startswith \"Label\", \"Set\",\n        EventName startswith \"Leave\", \"Execute\",\n        EventName startswith \"List\", \"Read\",\n        EventName startswith \"Lock\", \"Execute\",\n        EventName startswith \"Log\", \"Execute\",\n        EventName startswith \"Lookup\", \"Read\",\n        EventName startswith \"Manage\", \"Execute\",\n        EventName startswith \"Mark\", \"Set\",\n        EventName startswith \"Merge\", \"Set\",\n        EventName startswith \"Meter\", \"Read\",\n        EventName startswith \"Migrate\", \"Execute\",\n        EventName startswith \"Modify\", \"Set\",\n        EventName startswith \"Monitor\", \"Execute\",\n        EventName startswith \"Move\", \"Set\",\n        EventName startswith \"New\", \"Initialize\",\n        EventName startswith \"Notify\", \"Execute\",\n        EventName startswith \"Open\", \"Execute\",\n        EventName startswith \"OptIn\", \"Execute\",\n        EventName startswith \"Override\", \"Execute\",\n        EventName startswith \"Patch\", \"Set\",\n        EventName startswith \"Pause\", \"Stop\",\n        EventName startswith \"Persist\", \"Execute\",\n        EventName startswith \"Poll\", \"Read\",\n        EventName startswith \"Predict\", \"Execute\",\n        EventName startswith \"Prepare\", \"Execute\",\n        EventName startswith \"Preview\", \"Read\",\n        EventName startswith \"Probe\", \"Execute\",\n        EventName startswith \"Process\", \"Execute\",\n        EventName startswith \"Promote\", \"Set\",\n        EventName startswith \"Provision\", \"Execute\",\n        EventName startswith \"Publish\", \"Create\",\n        EventName startswith \"Purchase\", \"Execute\",\n        EventName startswith \"Purge\", \"Delete\",\n        EventName startswith \"Put\", \"Set\",\n        EventName startswith \"Query\", \"Read\",\n        EventName startswith \"Read\", \"Read\",\n        EventName startswith \"Rebuild\", \"Execute\",\n        EventName startswith \"Reboot\", \"Start\",\n        EventName startswith \"Receive\", \"Execute\",\n        EventName startswith \"Record\", \"Record\",\n        EventName startswith \"ReEncrypt\", \"Execute\",\n        EventName startswith \"Redeem\", \"Execute\",\n        EventName startswith \"Redrive\", \"Other\",\n        EventName startswith \"Register\", \"Install\",\n        EventName startswith \"Reimport\", \"Set\",\n        EventName startswith \"Reject\", \"Disable\",\n        EventName startswith \"Release\", \"Execute\",\n        EventName startswith \"Reload\", \"Execute\",\n        EventName startswith \"Render\", \"Execute\",\n        EventName startswith \"Renew\", \"Execute\",\n        EventName startswith \"Replace\", \"Set\",\n        EventName startswith \"Report\", \"Execute\",\n        EventName startswith \"Request\", \"Initialize\",\n        EventName startswith \"Refresh\", \"Execute\",\n        EventName startswith \"Respond\", \"Execute\",\n        EventName startswith \"Resend\", \"Execute\",\n        EventName startswith \"Remove\", \"Clear\",\n        EventName startswith \"Replicate\", \"Create\",\n        EventName startswith \"Resize\", \"Set\",\n        EventName startswith \"Resolve\", \"Enable\",\n        EventName startswith \"Restart\", \"Initialize\",\n        EventName startswith \"Restore\", \"Enable\",\n        EventName startswith \"Resume\", \"Start\",\n        EventName startswith \"Retire\", \"Disable\",\n        EventName startswith \"Retrieve\", \"Read\",\n        EventName startswith \"Retry\", \"Execute\",\n        EventName startswith \"Revoke\", \"Disable\",\n        EventName startswith \"Rollback\", \"Execute\",\n        EventName startswith \"Rotate\", \"Set\",\n        EventName startswith \"Run\", \"Initialize\",\n        EventName startswith \"Save\", \"Set\",\n        EventName startswith \"Scan\", \"Read\",\n        EventName startswith \"Scheduled\", \"Other\",\n        EventName startswith \"Search\", \"Execute\",\n        EventName startswith \"Select\", \"Read\",\n        EventName startswith \"Send\", \"Execute\",\n        EventName startswith \"ServiceQuotas\", \"Other\",\n        EventName startswith \"Set\", \"Set\",\n        EventName startswith \"Sign\", \"Execute\",\n        EventName startswith \"Simulate\", \"Execute\",\n        EventName startswith \"Split\", \"Execute\",\n        EventName startswith \"Subscribe\", \"Execute\",\n        EventName startswith \"Start\", \"Start\",\n        EventName startswith \"Stream\", \"Execute\",\n        EventName startswith \"Stop\", \"Stop\",\n        EventName startswith \"Submit\", \"Execute\",\n        EventName startswith \"Suspend\", \"Stop\",\n        EventName startswith \"Swap\", \"Set\",\n        EventName startswith \"Switch\", \"Execute\",\n        EventName startswith \"Sync\", \"Execute\",\n        EventName startswith \"Synchronize\", \"Execute\",\n        EventName startswith \"TablesMaintenance\", \"Other\",\n        EventName startswith \"Tag\", \"Set\",\n        EventName startswith \"Terminate\", \"Stop\",\n        EventName startswith \"Test\", \"Execute\",\n        EventName startswith \"Transfer\", \"Execute\",\n        EventName startswith \"Translate\", \"Execute\",\n        EventName startswith \"Trigger\", \"Execute\",\n        EventName startswith \"Subscribe\", \"Execute\",\n        EventName startswith \"Synthesize\", \"Execute\",\n        EventName startswith \"Unassign\", \"Clear\",\n        EventName startswith \"Unauthorize\", \"Disable\",\n        EventName startswith \"Unlock\", \"Enable\",\n        EventName startswith \"Unsubscribe\", \"Disable\",\n        EventName startswith \"Untag\", \"Clear\",\n        EventName startswith \"Update\", \"Set\",\n        EventName startswith \"Upgrade\", \"Execute\",\n        EventName startswith \"Upload\", \"Create\",\n        EventName startswith \"UseConnection\", \"Execute\",\n        EventName startswith \"Validate\", \"Execute\",\n        EventName startswith \"Verify\", \"Execute\",\n        EventName startswith \"Wipe\", \"Delete\",\n        EventName contains_cs \"Add\", \"Create\",\n        EventName contains_cs \"Authentication\", \"Execute\",\n        EventName contains_cs \"Check\", \"Execute\",\n        EventName contains_cs \"Confirm\", \"Execute\",\n        EventName contains_cs \"Create\", \"Create\",\n        EventName contains_cs \"Describe\", \"Read\",\n        EventName contains_cs \"Delet\", \"Delete\",\n        EventName contains_cs \"Detect\", \"Execute\",\n        EventName contains_cs \"Disable\", \"Disable\",\n        EventName contains_cs \"Enable\", \"Enable\",\n        EventName contains_cs \"Execute\", \"Execute\",\n        EventName contains \"Get\", \"Read\",\n        EventName contains_cs \"GlobalSign\", \"Execute\",\n        EventName contains_cs \"Grant\", \"Execute\",\n        EventName contains_cs \"Import\", \"Create\",\n        EventName contains_cs \"Initiate\", \"Initialize\",\n        EventName contains_cs \"Link\", \"Set\",\n        EventName contains_cs \"List\", \"Read\",\n        EventName contains_cs \"Login\", \"Execute\",\n        EventName contains \"Post\", \"Set\",\n        EventName contains_cs \"Put\", \"Set\",\n        EventName contains_cs \"Remove\", \"Delete\", \n        EventName contains_cs \"Resend\", \"Execute\",\n        EventName contains_cs \"Reset\", \"Execute\",\n        EventName contains_cs \"Respond\", \"Execute\",\n        EventName contains_cs \"Set\", \"Set\",\n        EventName contains_cs \"Stop\", \"Stop\",\n        EventName contains_cs \"Usage\", \"Read\",\n        EventName contains_cs \"Validate\", \"Execute\",\n        EventName contains_cs \"Write\", \"Create\",\n        EventName contains_cs \"Update\", \"Set\",\n        EventName == \"action\", \"Other\",\n        EventName == \"BidEvictedEvent\", \"Other\",\n        EventName startswith \"Backup\", \"Other\",\n        EventName startswith \"Password\", \"Other\",\n        EventName startswith \"Rotation\", \"Other\",\n        EventName startswith \"PassRequest\", \"Other\",\n        EventName startswith \"PolicyExecution\", \"Other\",\n        EventName startswith \"Preflight\", \"Other\",\n        EventName startswith \"Replication\", \"Other\",\n        \"Other\"\n    )\n| where array_length(eventtype_in) == 0 or EventType in (eventtype_in)\n| extend OriginalObject = todynamic(todynamic(Resources)[0])\n| where (array_length(object_has_any) == 0 or tostring(OriginalObject['ARN']) has_any (object_has_any))\n| extend \n    Operation = EventName,\n    ObjectType = \"Cloud Resource\",\n    Object = tostring(OriginalObject['ARN']),\n    ObjectId = tostring(OriginalObject['ARN']),\n    OriginalObjectType = tostring(OriginalObject['type'])\n| extend\n    ActorUserId = UserIdentityArn,\n    ActorUserIdType = iff(isempty(UserIdentityArn), \"\", \"AWSId\"),\n    ActorScopeId = UserIdentityAccountId,\n    ActorUsername = UserIdentityUserName,\n    ActorUsernameType = iff(isempty(UserIdentityUserName), \"\", \"Simple\"),\n    ActorOriginalUserType = UserIdentityType,\n    HttpUserAgent = UserAgent,\n    SrcIpAddr = iff(ipv4_is_in_range(SourceIpAddress, \"0.0.0.0/0\"), SourceIpAddress, \"\"),\n    TargetDomain = tostring(todynamic(RequestParameters).Host)\n| extend TargetDomainType = iff(isempty(TargetDomain), \"\", \"FQDN\")\n| invoke _ASIM_ResolveSrcFQDN('EventSource')\n// Aliases\n| extend\n    IpAddr = SrcIpAddr,\n    Src = coalesce(SrcIpAddr, SrcHostname),\n    User = ActorUsername\n| extend AdditionalFields = bag_pack(\n    \"RequestParameters\", RequestParameters,\n    \"ResponseElements\", ResponseElements\n)\n| project\n    TimeGenerated,\n    EventSchema,\n    EventSchemaVersion,\n    EventType,\n    EventSubType,\n    EventCount,\n    EventStartTime,\n    EventEndTime,\n    EventProduct,\n    EventVendor,\n    EventResult,\n    Operation,\n    Object,\n    ObjectType,\n    ObjectId,\n    OriginalObjectType,\n    Dvc,\n    Type,\n    EventUid,\n    EventMessage,\n    EventOriginalType,\n    EventProductVersion,\n    ActorUserId,\n    ActorUserIdType,\n    ActorUsername,\n    ActorUsernameType,\n    ActorScopeId,\n    ActorOriginalUserType,\n    HttpUserAgent,\n    SrcIpAddr,\n    SrcFQDN,\n    IpAddr,\n    TargetDomain,\n    TargetDomainType,\n    Src,\n    User,\n    SrcHostname,\n    SrcDomainType,\n    SrcDomain,\n    AdditionalFields\n};\nparser\n(\n  starttime = starttime,\n  endtime = endtime,\n  srcipaddr_has_any_prefix = srcipaddr_has_any_prefix,\n  actorusername_has_any = actorusername_has_any,\n  eventtype_in = eventtype_in,\n  eventresult = eventresult,\n  operation_has_any = operation_has_any,\n  object_has_any=object_has_any,\n  newvalue_has_any=newvalue_has_any,\n  disabled=disabled\n)",
        "version": 1,
        "functionParameters": "starttime:datetime=datetime(null),endtime:datetime=datetime(null),srcipaddr_has_any_prefix:dynamic=dynamic([]),actorusername_has_any:dynamic=dynamic([]),operation_has_any:dynamic=dynamic([]),eventtype_in:dynamic=dynamic([]),eventresult:string='*',object_has_any:dynamic=dynamic([]),newvalue_has_any:dynamic=dynamic([]),disabled:bool=False"
      }
    }
  ]
}