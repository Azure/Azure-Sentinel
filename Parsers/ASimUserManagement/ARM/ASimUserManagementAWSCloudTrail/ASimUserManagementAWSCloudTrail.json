{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Workspace": {
      "type": "string",
      "metadata": {
        "description": "The Microsoft Sentinel workspace into which the function will be deployed. Has to be in the selected Resource Group."
      }
    },
    "WorkspaceRegion": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The region of the selected workspace. The default value will use the Region selection above."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('Workspace'), '/ASimUserManagementAWSCloudTrail')]",
      "location": "[parameters('WorkspaceRegion')]",
      "properties": {
        "etag": "*",
        "displayName": "User Management ASIM parser for AWS Cloud Trail",
        "category": "ASIM",
        "FunctionAlias": "ASimUserManagementAWSCloudTrail",
        "query": "let parser = (disabled: bool) {\nlet SupportedEventSources = dynamic([\n    \"iam.amazonaws.com\"\n]);\nlet IAMEventNameLookup = datatable(EventName: string, EventType: string)\n[\n    \"AddUserToGroup\", \"UserAddedToGroup\",\n    \"AttachGroupPolicy\", \"GroupModified\",\n    \"AttachUserPolicy\", \"UserModified\",\n    \"ChangePassword\", \"PasswordChanged\",\n    \"CreateGroup\", \"GroupCreated\",\n    \"CreateLoginProfile\", \"UserModified\",\n    \"CreateUser\", \"UserCreated\",\n    \"DeleteGroup\", \"GroupDeleted\",\n    \"DeleteGroupPolicy\", \"GroupModified\",\n    \"DeleteLoginProfile\", \"UserModified\",\n    \"DeleteRole\", \"UserDeleted\",\n    \"DeleteUser\", \"UserDeleted\",\n    \"DeleteUserPolicy\", \"UserModified\",\n    \"DetachGroupPolicy\", \"GroupModified\",\n    \"DetachRolePolicy\", \"UserModified\",\n    \"DetachUserPolicy\", \"UserModified\",\n    \"EnableMFADevice\", \"UserModified\",\n    \"GetGroup\", \"GroupRead\",\n    \"GetGroupPolicy\", \"GroupRead\",\n    \"GetLoginProfile\", \"UserRead\",\n    \"GetMFADevice\", \"UserRead\",\n    \"GetRole\", \"UserRead\",\n    \"GetUser\", \"UserRead\",\n    \"ListAttachedGroupPolicies\", \"GroupRead\",\n    \"ListAttachedRolePolicies\", \"UserRead\",\n    \"ListAttachedUserPolicies\", \"UserRead\",\n    \"ListGroups\", \"GroupEnumerated\",\n    \"ListGroupsForUser\", \"UserRead\",\n    \"ListMFADevices\", \"UserRead\",\n    \"ListRoles\", \"UserRead\",\n    \"ListUsers\", \"UserRead\",\n    \"PutGroupPolicy\", \"GroupModified\",\n    \"PutRolePolicy\", \"UserModified\",\n    \"PutUserPolicy\", \"UserModified\",\n    \"RemoveUserFromGroup\", \"UserRemovedFromGroup\",\n    \"TagRole\", \"UserModified\",\n    \"TagUser\", \"UserModified\",\n    \"UntagUser\", \"UserModified\",\n    \"UntagUser\", \"UserModified\",\n    \"UpdateGroup\", \"GroupModified\",\n    \"UpdateLoginProfile\", \"PasswordChanged\",\n    \"UpdateRole\", \"UserModified\",\n    \"UpdateRoleDescription\", \"UserModified\",\n    \"UpdateSigningCertificate\", \"PasswordChanged\",\n    \"UpdateSSHPublicKey\", \"PasswordChanged\",\n    \"UpdateUser\", \"UserModified\",\n    \"UploadSigningCertificate\", \"UserModified\",\n    \"UploadSSHPublicKey\", \"UserModified\"\n];\nAWSCloudTrail\n| where EventSource in (SupportedEventSources)\n| extend\n    Type = \"AWSCloudTrail\",\n    EventCount = int(1),\n    EventStartTime = TimeGenerated,\n    EventEndTime = TimeGenerated,\n    EventSeverity = \"Informational\",\n    EventSchema = \"UserManagement\",\n    EventSchemaVersion = \"0.1.2\",\n    EventVendor = \"AWS\",\n    EventProduct = \"CloudTrail\",\n    Dvc = \"CloudTrail\",\n    EventResult = iff(isempty(ErrorCode) and isempty(ErrorMessage), \"Success\", \"Failure\"),\n    EventMessage = ErrorMessage\n| lookup IAMEventNameLookup on EventName\n| extend EventType = coalesce(EventType, \"Other\")\n| project-rename\n    EventOriginalSubType = EventTypeName,\n    EventOriginalType = EventName,\n    EventUid = AwsEventId,\n    EventOriginalResultDetails = ErrorMessage,\n    EventProductVersion = EventVersion\n| project-rename\n    ActorUserId = UserIdentityAccountId,\n    ActorUsername = UserIdentityUserName,\n    ActorOriginalUserType = UserIdentityType,\n    HttpUserAgent = UserAgent\n| extend\n    ActorUserIdType = iff(isempty(ActorUserId), \"\", \"AWSId\"),\n    ActorUsernameType = iff(isempty(ActorUsername), \"\", \"Simple\"),\n    SrcIpAddr = iff(ipv4_is_in_range(SourceIpAddress, \"0.0.0.0/0\"), SourceIpAddress, \"\")\n| extend RequestParameters = todynamic(RequestParameters), ResponseElements = todynamic(ResponseElements)\n| extend\n    TargetUserId = coalesce(tostring(ResponseElements.user.userId), tostring(ResponseElements.role.roleId)),\n    TargetUsername = coalesce(tostring(RequestParameters.userName), tostring(RequestParameters.roleName)),\n    GroupId = tostring(ResponseElements.group.groupName),\n    GroupName = tostring(RequestParameters.groupName)\n| extend\n    TargetUserIdType = iff(isempty(TargetUserId), \"\", \"AWSId\"),\n    TargetUsernameType = iff(isempty(TargetUsername), \"\", \"Simple\"),\n    GroupIdType = iff(isempty(GroupId), \"\", \"AWSId\"),\n    GroupNameType = iff(isempty(GroupName), \"\", \"Simple\"),\n    GroupOriginalType = iff(isempty(GroupName), \"\", \"IAM Group\")\n| extend AdditionalFields = bag_pack(\n    \"ActorAccessKeyId\", UserIdentityAccessKeyId,\n    \"AWSRegion\", AWSRegion,\n    \"APIVersion\", APIVersion,\n    \"EventSource\", EventSource,\n    \"ManagementEvent\", ManagementEvent,\n    \"ReadOnly\", ReadOnly,\n    \"TargetUserARN\", coalesce(tostring(ResponseElements.user.arn), tostring(ResponseElements.role.arn)),\n    \"GroupARN\", tostring(ResponseElements.group.arn)\n)\n// Alias\n| extend\n    IpAddr = SrcIpAddr,\n    User = ActorUsername\n| project\n    TimeGenerated,\n    Type,\n    EventCount,\n    EventStartTime,\n    EventEndTime,\n    EventSeverity,\n    EventSchema,\n    EventSchemaVersion,\n    EventVendor,\n    EventProduct,\n    Dvc,\n    EventResult,\n    EventMessage,\n    EventType,\n    EventOriginalSubType,\n    EventOriginalType,\n    EventUid,\n    EventOriginalResultDetails,\n    EventProductVersion,\n    ActorUserId,\n    ActorUsername,\n    ActorOriginalUserType,\n    HttpUserAgent,\n    ActorUserIdType,\n    ActorUsernameType,\n    SrcIpAddr,\n    TargetUserIdType,\n    TargetUserId,\n    TargetUsername,\n    GroupId,\n    GroupName,\n    TargetUsernameType,\n    GroupIdType,\n    GroupNameType,\n    GroupOriginalType,\n    User,\n    IpAddr,\n    AdditionalFields\n};\nparser(disabled = disabled);",
        "version": 1,
        "functionParameters": "disabled:bool=False"
      }
    }
  ]
}