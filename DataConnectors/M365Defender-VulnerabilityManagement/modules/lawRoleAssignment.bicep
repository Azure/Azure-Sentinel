param LawName string
param PrincipalId string
param RoleName string
@description('Array of actions for the roleDefinition')
param Actions array = [
  'Microsoft.OperationalInsights/workspaces/read'
  'Microsoft.OperationalInsights/workspaces/query/read'
  'Microsoft.OperationalInsights/workspaces/analytics/query/action'
  'Microsoft.OperationalInsights/workspaces/search/action'
]

@description('Array of notActions for the roleDefinition')
param NotActions array = [
  'Microsoft.OperationalInsights/workspaces/sharedKeys/read'
]

var roleDescription = 'Provides access to query Sentinel Watchlists and alert rules. Also provides limited permissions to read workspace details and run a query in the workspace, but not to read data from any tables.'

var roleDefName = guid(resourceGroup().id, string(Actions), string(NotActions))

resource law 'Microsoft.OperationalInsights/workspaces@2022-10-01' existing = {
  name: LawName  
 }
 
 resource tableMDVMCveKb 'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMCVEKB_CL'
 }
 
 resource tableMDVMRecommendations 'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMRecommendations_CL'
 }
 
 resource tableMDVMVulnerabilitiesByDevice 'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMVulnerabilitiesByDevice_CL'
 }
 
 resource tableMDVMNistCveKb 'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMNistCveKb_CL'
 }
 
 resource tableMDVMNISTConfigurations 'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMNISTConfigurations_CL'
 }
 
 resource tableMDVMSecureConfigurationsByDevice'Microsoft.OperationalInsights/workspaces/tables@2022-10-01' existing = {
   parent: law
   name: 'MDVMSecureConfigurationsByDevice_CL'
 }

resource roleDef 'Microsoft.Authorization/roleDefinitions@2022-04-01' = {
  name: roleDefName
  properties: {
    roleName: RoleName
    description: roleDescription
    type: 'customRole'
    permissions: [
      {
        actions: Actions
        notActions: NotActions
      }
    ]
    assignableScopes: [
      resourceGroup().id
    ]
  }
}

resource roleAssignmentWorkspace 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(law.id, roleDef.id, PrincipalId)
  scope: law
  properties: {
    roleDefinitionId: roleDef.id
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

var roleIdReader = '/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7'

resource roleAssignmentMDVMCveKb 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMCveKb.id, roleIdReader, PrincipalId)
  scope: tableMDVMCveKb
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

resource roleMDVMVulnerabilitiesByDevice 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMVulnerabilitiesByDevice.id, roleIdReader, PrincipalId)
  scope: tableMDVMVulnerabilitiesByDevice
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

resource roleMDVMRecommendations 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMRecommendations.id, roleIdReader, PrincipalId)
  scope: tableMDVMRecommendations
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

resource roleMDVMNistCveKb 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMNistCveKb.id, roleIdReader, PrincipalId)
  scope: tableMDVMNistCveKb
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

resource roleMDVMSecureConfigurationsByDevice 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMSecureConfigurationsByDevice.id, roleIdReader, PrincipalId)
  scope: tableMDVMSecureConfigurationsByDevice
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

resource roleMDVMNISTConfigurations 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(tableMDVMNISTConfigurations.id, roleIdReader, PrincipalId)
  scope: tableMDVMNISTConfigurations
  properties: {
    roleDefinitionId: roleIdReader
    principalId: PrincipalId
    principalType: 'ServicePrincipal'
  }
}

