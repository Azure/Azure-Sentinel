@description('The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group.')
param VulnerabilityManagementWorkbookDisplayName string = 'Vulnerability Management'

@description('The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group.')
param CVEDetailsWorkbookDisplayName string = 'CVE Details'

@description('The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is \'workbook\'')
param VulnerabilityManagementWorkbookType string = 'workbook'

@description('The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is \'workbook\'')
param CVEDetailsWorkbookType string = 'workbook'

@description('The id of resource instance to which the workbook will be associated')
param VulnerabilityManagementSourceId string = 'azure monitor'

@description('The id of resource instance to which the workbook will be associated')
param CVEDetailsWorkbookSourceId string = 'azure monitor'

@description('The unique guid for this workbook instance')
param VulnerabilityManagementWorkbookId string = newGuid()

@description('The unique guid for this workbook instance')
param CVEDetailsWorkbookId string = newGuid()

var Location = resourceGroup().location

resource workbookId_resource 'microsoft.insights/workbooks@2021-03-08' = {
  name: VulnerabilityManagementWorkbookId
  location: Location
  kind: 'shared'
  properties: {
    displayName: VulnerabilityManagementWorkbookDisplayName
    serializedData: '{"version":"Notebook/1.0","items":[{"type":1,"content":{"json":"## Vulnerability Assessment Findings"},"name":"Headline"},{"type":9,"content":{"version":"KqlParameterItem/1.0","crossComponentResources":["{parameterWorkspace}"],"parameters":[{"id":"206f87e8-2616-4d26-a94f-a97eb4cee619","version":"KqlParameterItem/1.0","name":"Subscription","type":6,"isRequired":true,"multiSelect":true,"quote":"\'","delimiter":",","typeSettings":{"additionalResourceOptions":["value::all"],"includeAll":true,"showDefault":false},"timeContext":{"durationMs":86400000},"defaultValue":"value::all"},{"id":"9b26b351-9698-4bc4-ad30-014da469e5b7","version":"KqlParameterItem/1.0","name":"parameterSource","label":"Machine Source","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\r\\n    {\\"value\\": \\"MDVM\\", \\"selected\\": true},\\r\\n    {\\"value\\": \\"Qualys\\"}\\r\\n]"},{"id":"37f42b28-645f-423e-b4e8-522cda0ecebd","version":"KqlParameterItem/1.0","name":"parameterWorkspace","label":"MDVM Workspace","type":5,"isRequired":true,"query":"resources\\r\\n| where type contains \\"microsoft.operationalinsights/workspaces\\"\\r\\n| extend id = tolower(id)\\r\\n| summarize by id=tolower(id)\\r\\n| project id","crossComponentResources":["value::tenant"],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":1,"resourceType":"microsoft.resources/tenants","value":"/subscriptions/f8f0af71-4d06-4171-ac36-b63d91ca62ae/resourcegroups/rg-temp-mdvm21/providers/microsoft.operationalinsights/workspaces/wus3-law-mdvm21"},{"id":"72c1f396-5c97-49e1-b24d-87241589edf8","version":"KqlParameterItem/1.0","name":"parameterTimeZone","label":"MDVM Time Zone","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\r\\n  {\\"value\\": \\"UTC\\", \\"selected\\": true},\\r\\n  {\\"value\\": \\"US/Alaska\\"},\\r\\n  {\\"value\\":\\"US/Central\\"},\\r\\n  {\\"value\\":\\"US/Eastern\\"},\\r\\n  {\\"value\\":\\"US/Mountain\\"},\\r\\n  {\\"value\\":\\"US/Pacific\\"}\\r\\n]","value":"US/Mountain"},{"id":"d63896cf-3233-43db-97d9-787d9ebf543c","version":"KqlParameterItem/1.0","name":"parameterSnapshotTime","label":"MDVM Snapshot Time","type":2,"isRequired":true,"query":"MDVMRecommendations_CL\\r\\n| summarize min(TimeGenerated) by transactionId\\r\\n| order by min_TimeGenerated\\r\\n| project transactionId, Display=format_datetime(datetime_utc_to_local(min_TimeGenerated, \'{parameterTimeZone}\'),\'MM/dd/yyyy hh:mm:ss tt\'), Selected=\'True\'","crossComponentResources":["{parameterWorkspace}"],"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},{"id":"ae1f45ba-9275-44fe-a0b0-0f60ab5a8690","version":"KqlParameterItem/1.0","name":"Help","label":"Show Help","type":10,"description":"Show insturctions for using this workbook","isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\r\\n { \\"value\\": \\"Yes\\", \\"label\\": \\"Yes\\"},\\r\\n {\\"value\\": \\"No\\", \\"label\\": \\"No\\", \\"selected\\":true }\\r\\n]"}],"style":"above","queryType":0,"resourceType":"microsoft.resourcegraph/resources"},"name":"Parameters"},{"type":1,"content":{"json":"#### Welcome to vulnerability assessment findings workbook\\r\\nThis workbook is based on the following recommendations provided by Defender for Cloud:\\r\\n* [Machines should have vulnerability findings resolved](http://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/1195afff-c881-495e-9bc5-1486211ae03f)\\r\\n* [Container registry images should have vulnerability findings resolved](http://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/dbd0cb49-b563-45e7-9724-889e799fa648)\\r\\n* [SQL databases should have vulnerability findings resolved](http://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/82e20e14-edc5-4373-bfc4-f13121257c37)\\r\\n* [SQL servers on machines should have vulnerability findings resolved](http://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/f97aa83c-9b63-4f9a-99f6-b22c4398f936)","style":"info"},"conditionalVisibility":{"parameterName":"Help","comparison":"isEqualTo","value":"Yes"},"name":"Help"},{"type":1,"content":{"json":"---"},"name":"text - 2"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"81073874-f7e3-4b99-9bb2-6fac88e2b726","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Overview","subTarget":"OverviewTab","style":"link"},{"id":"414bfeff-09a7-499e-95fc-c3adbf05dff5","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Machines","subTarget":"MachinesTab","style":"link"},{"id":"d835a04d-17a7-4e50-b77a-9a8f0a8b3fba","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"Containers","subTarget":"ACRTab","style":"link"},{"id":"ca82a8a1-f3c8-439d-afa0-07707dedd555","cellValue":"SelectedTab","linkTarget":"parameter","linkLabel":"SQL","subTarget":"SQLTab","style":"link"}]},"name":"Tabs"},{"type":1,"content":{"json":"---"},"name":"text - 2 - Copy"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| summarize Count=dcount(deviceId) by osPlatform","size":4,"title":"Unhealthy machines","noDataMessage":"No unhealthy machines found","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"Count","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}]}},{"columnMatch":"ResourceType","formatter":16,"formatOptions":{"showIcon":true}}],"labelSettings":[{"columnId":"osPlatform","label":"Operating System"}]},"tileSettings":{"titleContent":{"columnMatch":"ResourceType","formatter":7,"formatOptions":{"linkTarget":"Resource"}},"leftContent":{"columnMatch":"count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true,"sortCriteriaField":"ResourceType","sortOrderField":1,"size":"auto"},"graphSettings":{"type":0,"topContent":{"columnMatch":"ResourceType","formatter":1},"centerContent":{"columnMatch":"count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"mapSettings":{"locInfo":"LatLong","sizeSettings":"count","sizeAggregation":"Sum","legendMetric":"count","legendAggregation":"Sum","itemColorSettings":{"type":"heatmap","colorAggregation":"Sum","nodeColorField":"count","heatmapPalette":"greenRed"}}},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"MDVM"}],"name":"Overview-MDVMCount"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| summarize Count = dcount(cveId) by vulnerabilitySeverityLevel","size":1,"title":"Distinct vulnerabilities by severity","noDataMessage":"No unhealthy machines found","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"seriesLabelSettings":[{"seriesName":"High","color":"redBright"},{"seriesName":"Medium","color":"yellow"},{"seriesName":"Low","color":"blueDark"},{"seriesName":"Critical","color":"redDark"}]}},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"MDVM"}],"name":"Overview-MDVMPie"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| extend deviceName = iff(azResourceId == \'\', iff(indexof(deviceName, \'.\') == -1, deviceName, tolower(substring(deviceName, 0, indexof(deviceName, \'.\')))), azResourceId)\\r\\n| summarize dcount(cveId) by deviceName, vulnerabilitySeverityLevel, cveId\\r\\n| summarize Total=count(vulnerabilitySeverityLevel), sevC=countif(vulnerabilitySeverityLevel==\'Critical\'), sevH=countif(vulnerabilitySeverityLevel==\'High\'), sevM=countif(vulnerabilitySeverityLevel==\'Medium\'), sevL=countif(vulnerabilitySeverityLevel==\'Low\') by deviceName\\r\\n| order by sevC desc\\r\\n| take 10","size":0,"title":"Vulnerabilities by severity per top 10 machines","noDataMessage":"No unhealthy machines found","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"sevC","formatter":4,"formatOptions":{"palette":"redDark"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"min":0,"palette":"redBright","compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"15ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"min":0,"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"min":0,"palette":"blueDark","customColumnWidthSetting":"15ch"}},{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"22ch"},"tooltipFormat":{"tooltip":"[\\"Total\\"] fndings in total"}}],"rowLimit":500,"labelSettings":[{"columnId":"sevC","label":"Critical"},{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"MDVM"}],"name":"Overview - MDVMTable "}]},"customWidth":"33","conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"MDVM"}],"name":"group - 30"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n| project ResourceType=tostring(split(id,\\"/\\").[6]), ResourceName=tostring(properties.resourceDetails.id)\\r\\n| summarize Count=dcount(ResourceName) by ResourceType","size":4,"title":"Unhealthy machines","noDataMessage":"No unhealthy machines found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"ResourceType","formatter":16,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}]}}]},"tileSettings":{"titleContent":{"columnMatch":"ResourceType","formatter":7,"formatOptions":{"linkTarget":"Resource"}},"leftContent":{"columnMatch":"count","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true,"sortCriteriaField":"ResourceType","sortOrderField":1,"size":"auto"},"graphSettings":{"type":0,"topContent":{"columnMatch":"ResourceType","formatter":1},"centerContent":{"columnMatch":"count","formatter":1,"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"mapSettings":{"locInfo":"LatLong","sizeSettings":"count","sizeAggregation":"Sum","legendMetric":"count","legendAggregation":"Sum","itemColorSettings":{"type":"heatmap","colorAggregation":"Sum","nodeColorField":"count","heatmapPalette":"greenRed"}}},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"Overview-VMCount"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n| extend VulId = tostring(properties.id), Severity = tostring(properties.status.severity), Status = tostring(properties.status.code)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize Count = dcount(VulId) by Severity","size":1,"title":"Distinct vulnerabilities by severity","noDataMessage":"No unhealthy machines found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"seriesLabelSettings":[{"seriesName":"High","color":"redBright"},{"seriesName":"Medium","color":"yellow"},{"seriesName":"Low","color":"blueDark"}]}},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"Overview-ServersPie"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n| project Resource = tostring(properties.resourceDetails.id), subscriptionId, Severity = tostring(properties.status.severity), Status = tostring(properties.status.code), VulnId = tostring(properties.id)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize dcount(VulnId) by Resource, Severity, VulnId\\r\\n| summarize Total=count(Severity), sevH=countif(Severity==\'High\'), sevM=countif(Severity==\'Medium\'), sevL=countif(Severity==\'Low\') by Resource\\r\\n| order by sevH desc","size":0,"title":"Vulnerabilities by severity per machine","noDataMessage":"No unhealthy machines found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"22ch"},"tooltipFormat":{"tooltip":"[\\"Total\\"] fndings in total"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"min":0,"palette":"redBright","compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"15ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"min":0,"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"min":0,"palette":"blueDark","customColumnWidthSetting":"15ch"}}],"rowLimit":500,"labelSettings":[{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"Overview - ServerTable"}]},"customWidth":"33","conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"group - 24"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n| project ResourceType=tolower(split(id,\\"/\\").[6]), resourceName=tolower(split(id,\\"/\\").[8]), Status = tostring(properties.status.code)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize Count=dcount(resourceName) by ResourceType","size":4,"title":"Unhealthy container registries","noDataMessage":"No unhealthy container registries found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"ResourceType","formatter":16,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}]}}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview-ContainerCount"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n| extend VulId = tostring(properties.id), Severity = tostring(properties.status.severity), Status = tostring(properties.status.code)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize Count = dcount(VulId) by Severity","size":1,"title":"Distinct vulnerabilities by severity","noDataMessage":"No unhealthy container registries found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"seriesLabelSettings":[{"seriesName":"Medium","color":"yellow"},{"seriesName":"High","color":"redBright"},{"seriesName":"Unknown","color":"blueDark"}]}},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview-ContainersPie"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n| project Resource = tolower(extract(@\'(?i)(.*?)/providers/Microsoft.Security/([^/]+)\', 1, id)), subscriptionId, Severity = tostring(properties.status.severity), Status = tostring(properties.status.code), VulnId = tostring(properties.id)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize dcount(VulnId) by Resource, Severity, VulnId\\r\\n| summarize Total=count(Severity), sevH=countif(Severity==\'High\'), sevM=countif(Severity==\'Medium\'), sevL=countif(Severity==\'Low\') by Resource\\r\\n| order by sevH desc","size":0,"title":"Vulnerabilities by severity per container registry","noDataMessage":"No unhealthy container registries found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"22ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"min":0,"palette":"redBright","compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"15ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"min":0,"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"min":0,"palette":"blueDark","customColumnWidthSetting":"15ch"}}],"labelSettings":[{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview - ACRTable"}]},"customWidth":"33","name":"group - 28"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n | where type == \\"microsoft.security/assessments\\"\\r\\n | where name == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or name == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project ResourceType=tolower(split(id,\\"/\\").[6]), resourceName=tolower(split(id,\\"/\\").[8])\\r\\n | summarize Count=dcount(resourceName) by ResourceType","size":4,"title":"Unhealthy SQL resources by type","noDataMessage":"No unhealthy SQL resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"table","gridSettings":{"formatters":[{"columnMatch":"ResourceType","formatter":16,"formatOptions":{"showIcon":true}},{"columnMatch":"Count","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}]}}]},"tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}}},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview-SQLCount"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n | where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n | extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n | where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project subassessmentKey=name, parse_json(properties) \\r\\n | extend VulnId = tostring(properties.id), description = tostring(properties.displayName), Severity = tostring(properties.status.severity), Status = tostring(properties.status.code)\\r\\n | where Status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by Severity","size":1,"title":"Distinct SQL vulnerabilities by severity","noDataMessage":"No unhealthy SQL resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"piechart","tileSettings":{"showBorder":false,"titleContent":{"columnMatch":"Column1","formatter":1},"leftContent":{"columnMatch":"IncidentCount","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"maximumSignificantDigits":3,"maximumFractionDigits":2}}}},"chartSettings":{"seriesLabelSettings":[{"seriesName":"Medium","color":"yellow"},{"seriesName":"High","color":"redBright"},{"seriesName":"Low","color":"blueDark"}]}},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview-SQLPie"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n | where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n | extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n | where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName)\\r\\n | where status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by Resource, severity, VulnId, description\\r\\n | summarize Total = count(dcount_VulnId), sevH=countif(severity==\'High\'), sevM=countif(severity==\'Medium\'), sevL=countif(severity==\'Low\') by Resource\\r\\n | order by sevH desc","size":0,"title":"Vulnerabilities by severity per SQL resource","noDataMessage":"No unhealthy SQL resources found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"22ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"min":0,"palette":"redBright","compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"15ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"min":0,"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"min":0,"palette":"blueDark","customColumnWidthSetting":"15ch"}}],"labelSettings":[{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]},"sortBy":[]},"customWidth":"33","conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"OverviewTab"},"name":"Overview - SQLTable"}]},"customWidth":"33","name":"group - 26"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), patchable = parse_json(properties.additionalData).patchable, cve = parse_json(properties.additionalData).cve, Source = tostring(properties.additionalData.source)\\r\\n | where Source == \'Built-in Qualys vulnerability assessment\'\\r\\n | where status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by ResourceGroup, Resource, severity, VulnId, description, tostring(patchable), tostring(cve)\\r\\n | summarize Total = count(dcount_VulnId), sevH=countif(severity==\'High\'), sevM=countif(severity==\'Medium\'), sevL=countif(severity==\'Low\'), patchAvailable = countif(patchable==\'true\'), CVEcount =countif(cve!=\'[]\') by ResourceGroup, Resource\\r\\n | order by sevH desc","size":0,"title":"Overview | Select a machine to view the list of vulnerabilities","exportFieldName":"Resource","exportParameterName":"selectedServer","exportDefaultValue":"All","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkColumn":"Resource","linkTarget":"Resource","showIcon":true,"customColumnWidthSetting":"30ch"}},{"columnMatch":"ResourceGroup","formatter":5},{"columnMatch":"Resource","formatter":5,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Total","formatter":1,"formatOptions":{"customColumnWidthSetting":"10ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"redBright","customColumnWidthSetting":"12ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"yellow","customColumnWidthSetting":"13ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark","customColumnWidthSetting":"10ch"}},{"columnMatch":"patchAvailable","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"pending","text":"{0}{1}"}],"compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"20ch"}},{"columnMatch":"CVEcount","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}],"customColumnWidthSetting":"10ch"}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["ResourceGroup"],"expandTopLevel":true,"finalBy":"Resource"},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"},{"columnId":"patchAvailable","label":"Available patches"},{"columnId":"CVEcount","label":"CVEs"}]},"sortBy":[]},"customWidth":"60","conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"MachinesTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"MachinesSummary"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n| extend Source = tostring(properties.additionalData.source)\\r\\n| where Source == \'Built-in Qualys vulnerability assessment\'\\r\\n| extend Category = tostring(properties.category), Status = tostring(properties.status.code)\\r\\n| where Status == \'Unhealthy\'\\r\\n| summarize count() by tostring(Category)","size":0,"title":"Vulnerabilities by category","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"tiles","gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":14,"formatOptions":{"linkTarget":null,"showIcon":true,"customColumnWidthSetting":"25ch"}},{"columnMatch":"ResourceGroup","formatter":5},{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Total","formatter":1,"formatOptions":{"customColumnWidthSetting":"10ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"red","customColumnWidthSetting":"10ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"orange","customColumnWidthSetting":"10ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark","customColumnWidthSetting":"10ch"}},{"columnMatch":"patchAvailable","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"pending","text":"{0}{1}"}],"compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"10ch"}},{"columnMatch":"CVEcount","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}],"customColumnWidthSetting":"10ch"}}],"hierarchySettings":{"treeType":1,"groupBy":["ResourceGroup"],"expandTopLevel":true}},"sortBy":[],"tileSettings":{"titleContent":{"columnMatch":"Category","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true}},"customWidth":"40","conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"MachinesTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"MachinesCategoryTiles"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Vulnerabilities","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"1195afff-c881-495e-9bc5-1486211ae03f\\"\\r\\n| project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), Status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), Patchable = parse_json(properties.additionalData).patchable, CVE = properties.additionalData.cve, Category = tostring(properties.category), TimeGenerated = tostring(properties.timeGenerated), Remediation = tostring(properties.remediation), Impact = tostring(properties.impact), Threat = tostring(properties.additionalData.threat), Source = tostring(properties.additionalData.source)\\r\\n| where Source == \'Built-in Qualys vulnerability assessment\'\\r\\n| where Status == \'Unhealthy\'\\r\\n| where \'{selectedServer}\' == \'All\' or Resource == \'{selectedServer}\'\\r\\n| project Severity, VulnId, Description, tostring(Patchable), Category, Resource, ResourceGroup, CVE, TimeGenerated, Remediation, Impact, Threat, Source\\r\\n| mv-expand CveExpand = split (CVE, \\"},\\") to typeof(string)\\r\\n| parse CveExpand with * \'\\"title\\":\\"\' singleCve \'\\"\' *\\r\\n| summarize CVEs = tostring(make_list(singleCve)) by Severity, VulnId, Description, tostring(Patchable), Category, Resource, ResourceGroup, TimeGenerated, Threat, Impact, Remediation","size":2,"title":"Use the search box to filter vulnerabilities by resource, resource group, CVE, severity, etc.","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"Severity","formatter":5},{"columnMatch":"VulnId","formatter":5},{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"25ch"}},{"columnMatch":"TimeGenerated","formatter":6,"formatOptions":{"customColumnWidthSetting":"25ch"}},{"columnMatch":"Remediation","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Severity"],"finalBy":"VulnId"}},"sortBy":[]},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"MachinesTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"Servers - FullListTable"}]},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"MachinesTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"Qualys"}],"name":"VulnerabilitiesView"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n| extend Category = tostring(properties.category), Status = tostring(properties.status.code)\\r\\n| where Status != \'Healthy\'\\r\\n| summarize count() by tostring(Category)","size":4,"title":"Vulnerabilities by category","noDataMessage":"No unhealthy registries found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"visualization":"tiles","tileSettings":{"titleContent":{"columnMatch":"Category","formatter":1},"leftContent":{"columnMatch":"count_","formatter":12,"formatOptions":{"palette":"auto"},"numberFormat":{"unit":17,"options":{"style":"decimal","useGrouping":false,"maximumFractionDigits":2,"maximumSignificantDigits":3}}},"showBorder":true}},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"ACRTab"},"name":"ACRCategoryTiles"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n | where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n | extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n | where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n | project Resource = tolower(extract(@\'(?i)(.*?)/providers/Microsoft.Security/([^/]+)\', 1, id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), patchable = parse_json(properties.additionalData).patchable, cve = parse_json(properties.additionalData).cve\\r\\n | where status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by ResourceGroup, Resource, severity, VulnId, description, tostring(patchable), tostring(cve)\\r\\n | summarize Total = count(dcount_VulnId), sevH=countif(severity==\'High\'), sevM=countif(severity==\'Medium\'), sevL=countif(severity==\'Low\'), patchAvailable = countif(patchable==\'true\'), CVEcount =countif(cve!=\'[]\') by ResourceGroup, Resource\\r\\n | order by sevH desc","size":0,"title":"Vulnerable container registries |  Select a container registry to view the list of vulnerabilities","noDataMessage":"No unhealthy registries found","exportFieldName":"Resource","exportParameterName":"selectedACR","exportDefaultValue":"All","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkColumn":"Resource","linkTarget":"Resource","showIcon":true,"customColumnWidthSetting":"30ch"}},{"columnMatch":"ResourceGroup","formatter":5},{"columnMatch":"Resource","formatter":5,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Total","formatter":1,"formatOptions":{"customColumnWidthSetting":"10ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"redBright","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark","customColumnWidthSetting":"10ch"}},{"columnMatch":"patchAvailable","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"pending","text":"{0}{1}"}],"compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"15ch"}},{"columnMatch":"CVEcount","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}],"customColumnWidthSetting":"10ch"}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["ResourceGroup"],"expandTopLevel":true,"finalBy":"Resource"},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"},{"columnId":"patchAvailable","label":"Available patches"},{"columnId":"CVEcount","label":"CVEs"}]},"sortBy":[]},"customWidth":"50","conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"ACRTab"},"name":"Containers - ACR Repos Table"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n | where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n | extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n | where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n | project Resource = tolower(extract(@\'(?i)(.*?)/providers/Microsoft.Security/([^/]+)\', 1, id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), description = tostring(parse_json(properties).displayName), patchable = parse_json(properties.additionalData).patchable, cve = parse_json(properties.additionalData).cve, Repo = tostring(parse_json(properties.additionalData).repositoryName), imageDigest = tostring(parse_json(properties.additionalData).imageDigest)\\r\\n | where status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by Resource, severity, VulnId, description, tostring(patchable), tostring(cve), Repo, imageDigest\\r\\n | summarize Total = count(dcount_VulnId), sevH=countif(severity==\'High\'), sevM=countif(severity==\'Medium\'), sevL=countif(severity==\'Low\'), patchAvailable = countif(patchable==\'true\'), CVEcount =countif(cve!=\'[]\') by Resource, Repo, imageDigest\\r\\n | order by sevH desc","size":0,"title":"Vulnerable images","noDataMessage":"No vulnerable images found","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true,"customColumnWidthSetting":"25ch"}},{"columnMatch":"Resource","formatter":5,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Repo","formatter":5},{"columnMatch":"imageDigest","formatter":0,"formatOptions":{"customColumnWidthSetting":"18ch"}},{"columnMatch":"Total","formatter":1,"formatOptions":{"customColumnWidthSetting":"10ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"redBright","customColumnWidthSetting":"12ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark","customColumnWidthSetting":"12ch"}},{"columnMatch":"patchAvailable","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"pending","text":"{0}{1}"}],"compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"14ch"}},{"columnMatch":"CVEcount","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}],"customColumnWidthSetting":"10ch"}}],"rowLimit":1000,"hierarchySettings":{"treeType":1,"groupBy":["Resource"],"expandTopLevel":true,"finalBy":"Repo"},"labelSettings":[{"columnId":"Repo","label":"Repository"},{"columnId":"imageDigest","label":"Image digest"},{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"},{"columnId":"patchAvailable","label":"Patch available"},{"columnId":"CVEcount","label":"CVEs"}]},"sortBy":[]},"customWidth":"50","conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"ACRTab"},"name":"Containers - ACRImages Table"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Vulnerabilities","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"dbd0cb49-b563-45e7-9724-889e799fa648\\"\\r\\n| project \\tsubscriptionId,\\r\\n\\t\\t\\tResource = tolower(extract(@\'(?i)(.*?)/providers/Microsoft.Security/([^/]+)\', 1, id)),\\r\\n\\t\\t\\tResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)),\\r\\n\\t\\t\\tVulnId = tostring(parse_json(properties).id),\\r\\n\\t\\t\\tPublishedTime=properties.additionalData.publishedTime,\\r\\n\\t\\t\\tTimeGenerated=properties.timeGenerated,\\r\\n\\t\\t\\tStatus = tostring(parse_json(properties).status.code),\\r\\n\\t\\t\\tSeverity=properties.status.severity,\\r\\n\\t\\t\\tPatchable=tostring(properties.additionalData.patchable),\\r\\n\\t\\t\\tIssue=properties.displayName,\\r\\n            Impact=tostring(properties.impact),\\r\\n\\t\\t\\tRepositoryName=tostring(properties.additionalData.repositoryName),\\r\\n\\t\\t\\tCVSS2Score = todouble(extract(\\"2.0\\\\\\":{\\\\\\"base\\\\\\":([^}]+)\\", 1, tostring(properties.additionalData.cvss))),\\r\\n\\t\\t\\tCVSS3Score = todouble(extract(\\"3.0\\\\\\":{\\\\\\"base\\\\\\":([^}]+)\\", 1, tostring(properties.additionalData.cvss))),\\r\\n\\t\\t\\tImageDigest=tostring(properties.additionalData.imageDigest)\\r\\n | where Status == \'Unhealthy\'\\r\\n | where \'{selectedACR}\' == \'All\' or Resource == \'{selectedACR}\'\\r\\n | project-away Status ","size":2,"title":"Use the search box to filter vulnerabilities by resource, resource group, CVE, severity, etc.","noDataMessage":"No unhealthy registries and images found","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"subscriptionId","formatter":15,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":0,"formatOptions":{"customColumnWidthSetting":"30ch"}},{"columnMatch":"PublishedTime","formatter":6},{"columnMatch":"TimeGenerated","formatter":6,"formatOptions":{"customColumnWidthSetting":"25ch"}},{"columnMatch":"Severity","formatter":5},{"columnMatch":"Issue","formatter":7,"formatOptions":{"linkTarget":"GenericDetails","linkIsContextBlade":true}},{"columnMatch":"timeGenerated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["RepositoryName"]},"labelSettings":[{"columnId":"subscriptionId","label":"Subscription name"},{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"VulnId","label":"Vulnerability ID"},{"columnId":"PublishedTime","label":"Published time"},{"columnId":"TimeGenerated","label":"Time generated"},{"columnId":"RepositoryName","label":"Repository name"},{"columnId":"CVSS2Score","label":"CVSS score 2.0"},{"columnId":"CVSS3Score","label":"CVSS score 3.0"},{"columnId":"ImageDigest","label":"Image digest"}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"ACRTab"},"name":"Containers - FullListTable"}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"ACRTab"},"name":"Containers - ACR Vulnerabilities Table"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), subscriptionId, severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id)\\r\\n | where status == \'Unhealthy\'\\r\\n | summarize Total = count(VulnId), sevH=countif(severity==\'High\'), sevM=countif(severity==\'Medium\'), sevL=countif(severity==\'Low\') by ResourceGroup, Resource\\r\\n | order by sevH desc","size":0,"title":"Vulnerable SQL resources | Select a resource to view the list of vulnerabilities","exportFieldName":"Resource","exportParameterName":"selectedSQL","exportDefaultValue":"All","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkColumn":"Resource","linkTarget":"Resource","showIcon":true,"customColumnWidthSetting":"30ch"}},{"columnMatch":"ResourceGroup","formatter":5},{"columnMatch":"Resource","formatter":5,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Total","formatter":1,"formatOptions":{"customColumnWidthSetting":"10ch"}},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"redBright","customColumnWidthSetting":"10ch"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark","customColumnWidthSetting":"10ch"}},{"columnMatch":"patchAvailable","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"pending","text":"{0}{1}"}],"compositeBarSettings":{"labelText":"","columnSettings":[]},"customColumnWidthSetting":"10ch"}},{"columnMatch":"CVEcount","formatter":18,"formatOptions":{"thresholdsOptions":"icons","thresholdsGrid":[{"operator":"Default","thresholdValue":null,"representation":"4","text":"{0}{1}"}],"customColumnWidthSetting":"10ch"}}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["ResourceGroup"],"expandTopLevel":true,"finalBy":"Resource"},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]},"sortBy":[]},"customWidth":"50","conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"SQLTab"},"name":"SQLSummary"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), Severity = tostring(parse_json(properties).status.severity), Status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Database = parse_json(properties.resourceDetails).id\\r\\n | where Status == \'Unhealthy\'\\r\\n | summarize dcount(VulnId) by Resource, Severity, VulnId, tostring(Database)\\r\\n | summarize Total = count(dcount_VulnId), sevH=countif(Severity==\'High\'), sevM=countif(Severity==\'Medium\'), sevL=countif(Severity==\'Low\') by Resource, Database\\r\\n | order by sevH desc","size":0,"title":"Vulnerable databases per server","queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Resource","formatter":5},{"columnMatch":"Database","formatter":5},{"columnMatch":"sevH","formatter":4,"formatOptions":{"palette":"redBright"}},{"columnMatch":"sevM","formatter":4,"formatOptions":{"palette":"yellow","customColumnWidthSetting":"15ch"}},{"columnMatch":"sevL","formatter":4,"formatOptions":{"palette":"blueDark"}}],"rowLimit":1000,"hierarchySettings":{"treeType":1,"groupBy":["Resource"],"expandTopLevel":true,"finalBy":"Database"},"labelSettings":[{"columnId":"sevH","label":"High"},{"columnId":"sevM","label":"Medium"},{"columnId":"sevL","label":"Low"}]}},"customWidth":"50","conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"SQLTab"},"name":"DatabaseSummary"},{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"d2a731c6-cfc4-43da-8886-ff60a47623a1","version":"KqlParameterItem/1.0","name":"GroupBy","label":"Group by","type":2,"isRequired":true,"typeSettings":{"additionalResourceOptions":[],"showDefault":false},"jsonData":"[\\r\\n    { \\"value\\":\\"resource\\", \\"label\\":\\"Resource\\", \\"selected\\":true },\\r\\n    { \\"value\\":\\"severity\\", \\"label\\":\\"Severity\\" },\\r\\n    { \\"value\\":\\"category\\", \\"label\\":\\"Category\\" },\\r\\n    { \\"value\\":\\"benchmark\\", \\"label\\":\\"Benchmark\\" }\\r\\n]","timeContext":{"durationMs":86400000}}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"SQLTab"},"name":"Grouping"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Vulnerabilities","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), Category = tostring(properties.category), TimeGenerated = tostring(properties.timeGenerated), Remediation = tostring(properties.remediation), Impact = tostring(properties.impact), Database = parse_json(properties.resourceDetails).id, Benchmarks = parse_json(properties.additionalData).benchmarks\\r\\n | mvexpand Benchmarks\\r\\n | extend Benchmark = parse_json(Benchmarks).benchmark \\r\\n | where status == \'Unhealthy\'\\r\\n | where \'{selectedSQL}\' == \'All\' or Resource == \'{selectedSQL}\'\\r\\n | project Severity, VulnId, Description, Category, Resource, Database, ResourceGroup, TimeGenerated, tostring(Benchmark), Remediation, Impact","size":2,"title":"Grouped by benchmark | Use the search box to filter vulnerabilities by resource, resource group, severity, etc.","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Database","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Benchmark"],"expandTopLevel":false},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"TimeGenerated","label":"Time generated"}]}},"conditionalVisibility":{"parameterName":"GroupBy","comparison":"isEqualTo","value":"benchmark"},"name":"GroupByBenchmark"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), Category = tostring(properties.category), TimeGenerated = tostring(properties.timeGenerated), Remediation = tostring(properties.remediation), Impact = tostring(properties.impact), Database = parse_json(properties.resourceDetails).id\\r\\n | where status == \'Unhealthy\'\\r\\n | where \'{selectedSQL}\' == \'All\' or Resource == \'{selectedSQL}\'\\r\\n | project Severity, VulnId, Description, Category, Resource, Database, ResourceGroup, TimeGenerated, Remediation, Impact","size":2,"title":"Grouped by resource | Use the search box to filter vulnerabilities by resource, resource group, severity, etc.","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"Database","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Resource"],"expandTopLevel":false},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"TimeGenerated","label":"Time generated"}]}},"conditionalVisibility":{"parameterName":"GroupBy","comparison":"isEqualTo","value":"resource"},"name":"GroupByResource"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), Category = tostring(properties.category), TimeGenerated = tostring(properties.timeGenerated), Remediation = tostring(properties.remediation), Impact = tostring(properties.impact), Database = parse_json(properties.resourceDetails).id\\r\\n | where status == \'Unhealthy\'\\r\\n | where \'{selectedSQL}\' == \'All\' or Resource == \'{selectedSQL}\'\\r\\n | project Severity, VulnId, Description, Category, Resource, Database, ResourceGroup, TimeGenerated, Remediation, Impact","size":2,"title":"Grouped by severity | Use the search box to filter vulnerabilities by resource, resource group, severity, etc.","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":0,"formatOptions":{"customColumnWidthSetting":"20ch"}},{"columnMatch":"Database","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Severity"],"expandTopLevel":false},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"TimeGenerated","label":"Time generated"}]}},"conditionalVisibility":{"parameterName":"GroupBy","comparison":"isEqualTo","value":"severity"},"name":"GroupBySeverity"},{"type":3,"content":{"version":"KqlItem/1.0","query":"securityresources\\r\\n| where type == \\"microsoft.security/assessments/subassessments\\"\\r\\n| extend assessmentKey = extract(\\".*assessments/(.+?)/.*\\",1,  id)\\r\\n| where assessmentKey == \\"f97aa83c-9b63-4f9a-99f6-b22c4398f936\\" or assessmentKey == \\"82e20e14-edc5-4373-bfc4-f13121257c37\\"\\r\\n | project Resource = tolower(extract(\\"([\\\\\\\\s\\\\\\\\S]*?)(/providers/Microsoft.Security.*)\\",1,id)), ResourceGroup = trim_end(\\"/\\",extract(\\".*resourceGroups/(.+?)/\\",0,id)), ResourceType = tolower(split(id,\\"/\\").[6]), subscriptionId, Severity = tostring(parse_json(properties).status.severity), status = tostring(parse_json(properties).status.code), VulnId = tostring(parse_json(properties).id), Description = tostring(parse_json(properties).displayName), Category = tostring(properties.category), TimeGenerated = tostring(properties.timeGenerated), Remediation = tostring(properties.remediation), Impact = tostring(properties.impact), Database = parse_json(properties.resourceDetails).id, Benchmarks = parse_json(properties.additionalData).benchmarks\\r\\n | mvexpand Benchmarks\\r\\n | extend Benchmark = parse_json(Benchmarks).benchmark \\r\\n | where status == \'Unhealthy\'\\r\\n | where \'{selectedSQL}\' == \'All\' or Resource == \'{selectedSQL}\'\\r\\n | project Severity, VulnId, Description, Category, Resource, Database, ResourceGroup, TimeGenerated, tostring(Benchmark), Remediation, Impact","size":2,"title":"Grouped by category | Use the search box to filter vulnerabilities by resource, resource group, severity, etc.","showExportToExcel":true,"queryType":1,"resourceType":"microsoft.resourcegraph/resources","crossComponentResources":["{Subscription}"],"gridSettings":{"formatters":[{"columnMatch":"$gen_group","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true,"customColumnWidthSetting":"40ch"}},{"columnMatch":"Database","formatter":13,"formatOptions":{"linkTarget":null,"showIcon":true}},{"columnMatch":"TimeGenerated","formatter":6}],"rowLimit":1000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["Category"],"expandTopLevel":false},"labelSettings":[{"columnId":"ResourceGroup","label":"Resource group"},{"columnId":"TimeGenerated","label":"Time generated"}]}},"conditionalVisibility":{"parameterName":"GroupBy","comparison":"isEqualTo","value":"category"},"name":"GroupByCategory"}]},"conditionalVisibility":{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"SQLTab"},"name":"SQLVulnerabilitiesGroup"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"2ef927e9-165e-40cd-87f0-f3af142807c5","cellValue":"parameterRecType","linkTarget":"parameter","linkLabel":"Vulnerability Assessment","subTarget":"va","style":"link","icon":"Chevron"},{"id":"cadad2bb-16b3-454b-ae52-e9dde7acf6ed","cellValue":"parameterRecType","linkTarget":"parameter","linkLabel":"Secure Configuration Assessment","subTarget":"sca","style":"link","icon":"Chevron"}]},"name":"links - 2"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMRecommendations_CL \\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| extend type = substring(recId, 0, indexof(recId, \'-\'))\\r\\n| extend publicExploit = tostring(publicExploit)\\r\\n| where type == \'{parameterRecType}\'\\r\\n| project recommendationCategory, recommendationName, subCategory, status,\\r\\n        publicExploit=iif(publicExploit == \'1\', \'true\', publicExploit), configScoreImpact, \\r\\n        ExposureScoreImpact=round(exposureImpact), severityScore, weaknesses, NumberOfExposedMachines=exposedMachinesCount, \\r\\n        TotalNumberOfMachines=totalMachineCount, RemediationType=remediationType, recId, url = strcat(\'https://security.microsoft.com/security-recommendations?search=\', recId)\\r\\n\\r\\n//url = strcat(\'https://security.microsoft.com/security-recommendations?recommendationId=\'","size":0,"title":"Recommendations","exportFieldName":"recId","exportParameterName":"parameterRecId","exportDefaultValue":"all","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"recommendationCategory","formatter":5},{"columnMatch":"publicExploit","formatter":18,"formatOptions":{"linkColumn":"url","linkTarget":"Url","thresholdsOptions":"icons","thresholdsGrid":[{"operator":"==","thresholdValue":"True","representation":"Sev0","text":"{0}{1}"},{"operator":"==","thresholdValue":"False","representation":"Sev2","text":"{0}{1}"},{"operator":"Default","thresholdValue":null,"representation":"Blank","text":"{0}{1}"}]}},{"columnMatch":"configScoreImpact","formatter":5},{"columnMatch":"ExposureScoreImpact","formatter":4,"formatOptions":{"palette":"red","linkColumn":"url","linkTarget":"Url"}},{"columnMatch":"severityScore","formatter":4,"formatOptions":{"palette":"red","linkColumn":"url","linkTarget":"Url","compositeBarSettings":{"labelText":"","columnSettings":[]}}},{"columnMatch":"url","formatter":5}],"rowLimit":10000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["recommendationCategory"],"expandTopLevel":true},"labelSettings":[{"columnId":"recommendationCategory","label":"Category"},{"columnId":"recommendationName","label":"Recommendation Name"},{"columnId":"subCategory","label":"Sub-Category"},{"columnId":"status","label":"Status"},{"columnId":"publicExploit","label":"Public Exploit"},{"columnId":"ExposureScoreImpact","label":"Exposure Score"},{"columnId":"severityScore","label":"Secure Score"},{"columnId":"weaknesses","label":"Weaknesses/Vulnerabilities"},{"columnId":"NumberOfExposedMachines","label":"Exposed Machines"},{"columnId":"TotalNumberOfMachines","label":"Total Machines"},{"columnId":"RemediationType","label":"Remediation"}]}},"name":"queryReccomendations"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where \'{parameterRecId}\' == \'all\' or recommendationReference == \'{parameterRecId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| extend deviceName = iff(azResourceId == \'\', strcat(\' \', iff(indexof(deviceName, \'.\') == -1, deviceName, tolower(substring(deviceName, 0, indexof(deviceName, \'.\'))))), strcat(\' \', iff(indexof(deviceName, \'.\') == -1, deviceName, tolower(substring(deviceName, 0, indexof(deviceName, \'.\'))))))\\r\\n| project cveId, vulnerabilitySeverityLevel, osPlatform = strcat(osPlatform, \' (\', osArchitecture, \')\'), softwareVendor = strcat(toupper(substring(softwareVendor, 0, 1)), substring(softwareVendor, 1, string_size(softwareVendor))), softwareName = strcat(toupper(substring(softwareName, 0, 1)), substring(softwareName, 1, string_size(softwareName))), softwareVersion, deviceName, lastSeenTimestamp, firstSeenTimestamp, vulnId, azResourceId","size":0,"title":"Associated Vulnerabilities","exportFieldName":"cveId","exportParameterName":"parameterCveId","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"cveId","formatter":7,"formatOptions":{"linkTarget":"WorkbookTemplate","linkIsContextBlade":true,"workbookContext":{"componentIdSource":"workbook","resourceIdsSource":"workbook","templateIdSource":"static","templateId":"${cveDetailsWorkbook.id}","typeSource":"workbook","gallerySource":"workbook","locationSource":"default","workbookName":"Vulnerability Information","passSpecificParams":true,"templateParameters":[{"name":"parameterWorkspace","source":"parameter","value":"parameterWorkspace"},{"name":"parameterSnapshotTime","source":"parameter","value":"parameterSnapshotTime"},{"name":"parameterCveId","source":"cell","value":""},{"name":"parameterVulnId","source":"column","value":"vulnId"}]}}},{"columnMatch":"vulnerabilitySeverityLevel","formatter":5},{"columnMatch":"deviceName","formatter":5},{"columnMatch":"vulnId","formatter":5},{"columnMatch":"azResourceId","formatter":5}],"rowLimit":10000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["vulnerabilitySeverityLevel","deviceName"]},"labelSettings":[{"columnId":"cveId","label":"CVE"},{"columnId":"vulnerabilitySeverityLevel","label":"Severity/Device"},{"columnId":"osPlatform","label":"Operating System"},{"columnId":"softwareVendor","label":"Software Vendor"},{"columnId":"softwareName","label":"Software Name"},{"columnId":"softwareVersion","label":"Version"},{"columnId":"deviceName","label":"Device"},{"columnId":"lastSeenTimestamp","label":"Last Seen"},{"columnId":"firstSeenTimestamp","label":"First Seen"}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"parameterRecType","comparison":"isEqualTo","value":"va"},"name":"queryAssociatedVulnerabilities"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMSecureConfigurationsByDevice_CL\\r\\n| where \'{parameterRecId}\' == \'all\' or recommendationReference == \'{parameterRecId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| extend deviceName = iff(azResourceId == \'\' or deviceName contains \'admin02\', strcat(\' \', iff(indexof(deviceName, \'.\') == -1, deviceName, tolower(substring(deviceName, 0, indexof(deviceName, \'.\'))))), strcat(\' \', iff(indexof(deviceName, \'.\') == -1, deviceName, tolower(substring(deviceName, 0, indexof(deviceName, \'.\'))))))\\r\\n| project deviceName, osPlatform, osVersion, configurationName, configurationCategory, configurationSubcategory, configurationImpact, isExpectedUserImpact ","size":0,"title":"Affected Devices","exportFieldName":"cveId","exportParameterName":"parameterCveId","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"rowLimit":10000,"filter":true,"hierarchySettings":{"treeType":1,"groupBy":["osPlatform"]},"labelSettings":[{"columnId":"deviceName","label":"Device"},{"columnId":"osPlatform","label":"Operating System"},{"columnId":"osVersion","label":"OS Version"},{"columnId":"configurationName","label":"Configuration Name"},{"columnId":"configurationCategory","label":"Category"},{"columnId":"configurationSubcategory","label":"Sub-Category"},{"columnId":"configurationImpact","label":"Impact"},{"columnId":"isExpectedUserImpact","label":"Expected User Impact"}]},"sortBy":[]},"conditionalVisibility":{"parameterName":"parameterRecType","comparison":"isEqualTo","value":"sca"},"name":"queryReccomendationScaDetails"}]},"conditionalVisibilities":[{"parameterName":"SelectedTab","comparison":"isEqualTo","value":"MachinesTab"},{"parameterName":"parameterSource","comparison":"isEqualTo","value":"MDVM"}],"name":"groupMachines"}],"isLocked":false,"fallbackResourceIds":["azure security center"],"fromTemplateId":"community-Workbooks/Azure Security Center/Vulnerabilities"}'
    version: '1.0'
    sourceId: VulnerabilityManagementSourceId
    category: VulnerabilityManagementWorkbookType
  }
}

resource cveDetailsWorkbook 'microsoft.insights/workbooks@2021-03-08' = {
  name: CVEDetailsWorkbookId
  location: Location
  kind: 'shared'
  properties: {
    displayName: CVEDetailsWorkbookDisplayName
    serializedData: '{"version":"Notebook/1.0","items":[{"type":9,"content":{"version":"KqlParameterItem/1.0","parameters":[{"id":"587462cc-87ae-49d5-b5c6-25ee367b6a25","version":"KqlParameterItem/1.0","name":"parameterCveId","type":1,"timeContext":{"durationMs":86400000},"value":"CVE-2008-2812"},{"id":"cf6469dc-34e9-4e23-bf1d-9cd5aedcfb23","version":"KqlParameterItem/1.0","name":"parameterWorkspace","type":5,"query":"resources\\r\\n| where type contains \\"microsoft.operationalinsights/workspaces\\"\\r\\n| extend id = tolower(id)\\r\\n| join kind=leftouter (\\r\\n    resources\\r\\n    | where type == \\"microsoft.operationsmanagement/solutions\\"\\r\\n    | extend solutionName = tostring(plan.product)\\r\\n    | where solutionName == \\"OMSGallery/SecurityInsights\\"\\r\\n    | extend wsRId = tolower(tostring(properties.workspaceResourceId))\\r\\n    | where solutionName contains \\"SecurityInsights\\"\\r\\n    ) on $left.id == $right.wsRId\\r\\n| summarize by id=tolower(id), tostring(solutionName)\\r\\n| project id","crossComponentResources":["value::tenant"],"typeSettings":{"resourceTypeFilter":{"microsoft.operationalinsights/workspaces":true},"additionalResourceOptions":[],"showDefault":false},"timeContext":{"durationMs":86400000},"queryType":1,"resourceType":"microsoft.resources/tenants","value":"/subscriptions/f8f0af71-4d06-4171-ac36-b63d91ca62ae/resourcegroups/rg-temp-mdvm21/providers/microsoft.operationalinsights/workspaces/wus3-law-mdvm21"},{"id":"c3879843-594f-4675-a7bf-edc31da3859c","version":"KqlParameterItem/1.0","name":"parameterJson","type":1,"timeContext":{"durationMs":86400000},"value":"{     \\"id\\": \\"CVE-1999-0095\\",     \\"sourceIdentifier\\": \\"cve@mitre.org\\",     \\"published\\": \\"1988-10-01T04:00:00.0000000Z\\",     \\"lastModified\\": \\"2019-06-11T20:29:00.2630000Z\\",     \\"vulnStatus\\": \\"Modified\\",     \\"descriptions\\": [         {             \\"lang\\": \\"en\\",             \\"value\\": \\"The debug command in Sendmail is enabled, allowing attackers to execute commands as root.\\"         },         {             \\"lang\\": \\"es\\",             \\"value\\": \\"El comando de depuracin de Sendmail est activado, permitiendo a atacantes ejecutar comandos como root.\\"         }     ],     \\"metrics\\": {         \\"cvssMetricV2\\": [             {                 \\"source\\": \\"nvd@nist.gov\\",                 \\"type\\": \\"Primary\\",                 \\"cvssData\\": {                     \\"version\\": \\"2.0\\",                     \\"vectorString\\": \\"AV:N/AC:L/Au:N/C:C/I:C/A:C\\",                     \\"confidentialityImpact\\": \\"COMPLETE\\",                     \\"integrityImpact\\": \\"COMPLETE\\",                     \\"availabilityImpact\\": \\"COMPLETE\\",                     \\"baseScore\\": 10.0,                     \\"baseSeverity\\": \\"HIGH\\",                     \\"accessVector\\": \\"NETWORK\\",                     \\"accessComplexity\\": \\"LOW\\",                     \\"authentication\\": \\"NONE\\"                 },                 \\"exploitabilityScore\\": 10.0,                 \\"impactScore\\": 10.0,                 \\"acInsufInfo\\": false,                 \\"obtainAllPrivilege\\": true,                 \\"obtainUserPrivilege\\": false,                 \\"obtainOtherPrivilege\\": false,                 \\"userInteractionRequired\\": false             }         ]     },     \\"weaknesses\\": [         {             \\"source\\": \\"nvd@nist.gov\\",             \\"type\\": \\"Primary\\",             \\"description\\": [                 {                     \\"lang\\": \\"en\\",                     \\"value\\": \\"NVD-CWE-Other\\"                 }             ]         }     ],     \\"configurations\\": [         {             \\"nodes\\": [                 {                     \\"operator\\": \\"OR\\",                     \\"negate\\": false,                     \\"cpeMatch\\": [                         {                             \\"vulnerable\\": true,                             \\"criteria\\": \\"cpe:2.3:a:eric_allman:sendmail:5.58:*:*:*:*:*:*:*\\",                             \\"matchCriteriaId\\": \\"1d07f493-9c8d-44a4-8652-f28b46cba27c\\"                         }                     ]                 }             ]         }     ],     \\"references\\": [         {             \\"source\\": \\"cve@mitre.org\\",             \\"url\\": \\"http://seclists.org/fulldisclosure/2019/Jun/16\\"         },         {             \\"source\\": \\"cve@mitre.org\\",             \\"url\\": \\"http://www.openwall.com/lists/oss-security/2019/06/05/4\\"         },         {             \\"source\\": \\"cve@mitre.org\\",             \\"url\\": \\"http://www.openwall.com/lists/oss-security/2019/06/06/1\\"         },         {             \\"source\\": \\"cve@mitre.org\\",             \\"url\\": \\"http://www.securityfocus.com/bid/1\\"         }     ] }"},{"id":"485f81d8-8463-46e0-a378-292ae0552199","version":"KqlParameterItem/1.0","name":"parameterSnapshotTime","label":"","type":1,"value":"2022-12-19T05:14:18Z"},{"id":"60182c6a-effe-4350-acac-cc42eb16bd6a","version":"KqlParameterItem/1.0","name":"parameterVulnId","type":1}],"style":"above","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces"},"conditionalVisibility":{"parameterName":"parameterHidden","comparison":"isEqualTo","value":"99999"},"name":"parameters - 1"},{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"6f1e0055-b314-426f-ab97-93f63a732b9b","cellValue":"parameterSource","linkTarget":"parameter","linkLabel":"MDVM","subTarget":"mdvm","preText":"MDVM","postText":"MDVM","style":"link"},{"id":"17b282f5-709b-4be3-950a-2488b5830fbe","cellValue":"parameterSource","linkTarget":"parameter","linkLabel":"NIST","subTarget":"nist","preText":"NIST","postText":"NIST","style":"link"}]},"name":"links - 4"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, descriptions, cveId) by cveId\\r\\n| project Description = descriptions[0].value\\r\\n","size":4,"title":"Description","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"visualization":"card","tileSettings":{"showBorder":false}},"name":"queryDescription"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, cisaVulnerabilityName, cisaRequiredAction, cisaActionDue, cisaExploitAdd, lastModified, published, sourceIdentifier, vulnStatus) by cveId\\r\\n| extend cisaName = cisaVulnerabilityName\\r\\n| extend cisaRequiredAction = cisaRequiredAction \\r\\n| extend cisaActionDue = format_datetime(todatetime(cisaActionDue), \'MM/dd/yyyy\')\\r\\n| extend cisaExploitAdd = format_datetime(todatetime(cisaExploitAdd), \'MM/dd/yyyy h:mm tt\')\\r\\n| extend lastModified = format_datetime(todatetime(lastModified), \'MM/dd/yyyy h:mm tt\')\\r\\n| extend published = format_datetime(todatetime(published), \'MM/dd/yyyy h:mm tt\')\\r\\n| extend sourceIdentifier = sourceIdentifier\\r\\n| extend vulnStatus = vulnStatus\\r\\n| extend attributes = pack(\\"Identifier\\", cveId, \\"CISA Name\\", cisaName, \\"Vulnerability Status\\", vulnStatus, \\"Published\\", published, \\"Last Modified\\", lastModified, \\"CISA Required Action\\", cisaRequiredAction, \\"CISA Exploit Add\\", cisaExploitAdd, \\"CISA Action Due\\", cisaActionDue)\\r\\n| mv-expand kind=array attributes\\r\\n| where attributes[1] != \'\'\\r\\n| project Attribute = attributes[0], Value = attributes[1]","size":1,"title":"Vulnerability Details","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"queryInformation"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Metrics","items":[{"type":11,"content":{"version":"LinkItem/1.0","style":"tabs","links":[{"id":"dc6f8629-3459-4283-a6e6-d55a95707cfa","cellValue":"parameterCvss","linkTarget":"parameter","linkLabel":"CVSS v3.1","subTarget":"31","preText":"CVSS 3.1","style":"link"},{"id":"e49d0b06-9efe-4509-a618-818606c7dd26","cellValue":"parameterCvss","linkTarget":"parameter","linkLabel":"CVSS v3.0","subTarget":"3","style":"link"},{"id":"4bf12b92-e6c7-45e0-8eb8-740ff64764ce","cellValue":"parameterCvss","linkTarget":"parameter","linkLabel":"CVSS v2","subTarget":"2","style":"link"}]},"name":"links - 5"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let q1 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV31[0]\\r\\n| project Data = metrics_cvssMetricV31_0;\\r\\n\\r\\nlet q2 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV31[0].cvssData\\r\\n| project Data = metrics_cvssMetricV31_0_cvssData;\\r\\n\\r\\nunion q1, q2\\r\\n| where Data[0] != \'cvssData\'\\r\\n| where Data[0] != \'version\'\\r\\n| where Data[0] != \'\'\\r\\n| project Attribute = strcat(toupper(substring(Data[0], 0, 1)), substring(Data[0], 1, string_size(Data[0]))), Value = Data[1]\\r\\n| order by Attribute asc","size":0,"noDataMessage":"There is no CVSS V3.1 information for this CVE.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"]},"conditionalVisibility":{"parameterName":"parameterCvss","comparison":"isEqualTo","value":"31"},"name":"queryMetricsV31"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let q1 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV30[0]\\r\\n| project Data = metrics_cvssMetricV30_0;\\r\\n\\r\\nlet q2 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV30[0].cvssData\\r\\n| project Data = metrics_cvssMetricV30_0_cvssData;\\r\\n\\r\\nunion q1, q2\\r\\n| where Data[0] != \'cvssData\'\\r\\n| where Data[0] != \'version\'\\r\\n| where Data[0] != \'\'\\r\\n| project Attribute = strcat(toupper(substring(Data[0], 0, 1)), substring(Data[0], 1, string_size(Data[0]))), Value = Data[1]\\r\\n| order by Attribute asc","size":0,"noDataMessage":"There is no CVSS V3.0 information for this CVE.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"]},"conditionalVisibility":{"parameterName":"parameterCvss","comparison":"isEqualTo","value":"3"},"name":"queryMetricsV3"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let q1 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV2[0]\\r\\n| project Data = metrics_cvssMetricV2_0;\\r\\n\\r\\nlet q2 = MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, metrics) by cveId\\r\\n| mv-expand kind=array metrics.cvssMetricV2[0].cvssData\\r\\n| project Data = metrics_cvssMetricV2_0_cvssData;\\r\\n\\r\\nunion q1, q2\\r\\n| where Data[0] != \'cvssData\'\\r\\n| where Data[0] != \'version\'\\r\\n| where Data[0] != \'\'\\r\\n| project Attribute = strcat(toupper(substring(Data[0], 0, 1)), substring(Data[0], 1, string_size(Data[0]))), Value = Data[1]\\r\\n| order by Attribute asc\\r\\n\\r\\n","size":0,"noDataMessage":"There is no CVSS V2 information for this CVE.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"]},"conditionalVisibility":{"parameterName":"parameterCvss","comparison":"isEqualTo","value":"2"},"name":"queryMetricsV2"}]},"name":"groupMetrics"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, references) by cveId\\r\\n| mv-expand references\\r\\n| mv-expand references.tags\\r\\n| project Source = references.source, Url = references.url, Tag = references_tags","size":1,"title":"References","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"Url","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"Tag","formatter":5}],"hierarchySettings":{"treeType":1,"groupBy":["Tag"],"expandTopLevel":false}}},"name":"queryReferences"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMNISTCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, weaknesses) by cveId\\r\\n| mv-expand weaknesses\\r\\n| project Description = weaknesses.description[0].value, Source = weaknesses.source, Type = weaknesses.type","size":4,"title":"Weaknesses","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"]},"name":"queryWeaknesses"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMNISTConfigurations_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize max(TimeGenerated) by cveId, configurationNumber, criteria, versionStartIncluding, versionStartExcluding, versionEndIncluding, versionEndExcluding, vulnerable, nodeOperator\\r\\n| extend criteriaSplit = split(criteria, \':\')\\r\\n| extend configurationNumber = iif(nodeOperator == \'AND\', strcat(\'Configuration \', configurationNumber, \' (AND)\'), strcat(\'Configuration \', configurationNumber))\\r\\n| extend version = \\r\\n    iif(criteriaSplit[5] == \'*\', \\r\\n        iif(versionStartIncluding != \'\' and versionEndExcluding != \'\', strcat(\'From (including): \', versionStartIncluding, \' - Up to (excluding): \', versionEndExcluding),\\r\\n        iif(versionStartExcluding != \'\' and versionEndIncluding != \'\', strcat(\'From (excluding): \', versionStartIncluding, \' - Up to (including): \', versionEndExcluding),\\r\\n        iif(versionStartIncluding != \'\' and versionEndIncluding != \'\', strcat(\'From (including): \', versionStartIncluding, \' - Up to (including): \', versionEndExcluding), \\r\\n        iif(versionStartExcluding != \'\' and versionEndExcluding != \'\', strcat(\'From (excluding): \', versionStartIncluding, \' - Up to (excluding): \', versionEndExcluding), \\r\\n        iif(versionEndExcluding != \'\', strcat(\'Up to (excluding): \', versionEndExcluding), \\r\\n        iif(versionEndIncluding != \'\', strcat(\'Up to (including): \', versionEndIncluding), \\r\\n        iif(versionStartIncluding != \'\', strcat(\'From (including): \', versionStartIncluding), \\r\\n        iif(versionStartExcluding != \'\', strcat(\'From (excluding): \', versionStartIncluding), criteriaSplit[5])))))))), \\r\\n    criteriaSplit[5])\\r\\n| project configurationNumber, criteria, vulnerable, version","size":0,"title":"Known Affected Software Configurations","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"configurationNumber","formatter":5}],"rowLimit":10000,"hierarchySettings":{"treeType":1,"groupBy":["configurationNumber"],"expandTopLevel":true},"labelSettings":[{"columnId":"configurationNumber","label":"Configuration"},{"columnId":"criteria","label":"Criteria"},{"columnId":"vulnerable","label":"Vulnerable"},{"columnId":"version","label":"Impacted Version(s)"}]}},"name":"queryConfigurations"}]},"conditionalVisibility":{"parameterName":"parameterSource","comparison":"isEqualTo","value":"nist"},"name":"groupNist"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, description) by cveId\\r\\n| project Description = description\\r\\n","size":4,"title":"Description","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"visualization":"card","tileSettings":{"showBorder":false}},"name":"queryDescription"},{"type":3,"content":{"version":"KqlItem/1.0","query":"let q1 = MDVMCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, cveId, description, updatedOn, publishedOn, exploitInKit, exploitVerified, publicExploit, severity) by cveId\\r\\n| join kind=leftouter (\\r\\n    MDVMVulnerabilitiesByDevice_CL\\r\\n    | where cveId == \'{parameterCveId}\'\\r\\n    | where transactionId == \'{parameterSnapshotTime}\'\\r\\n    | where vulnId == \'{parameterVulnId}\'\\r\\n) on cveId\\r\\n| extend lastModified = format_datetime(todatetime(updatedOn), \'MM/dd/yyyy h:mm tt\')\\r\\n| extend published = format_datetime(todatetime(publishedOn), \'MM/dd/yyyy h:mm tt\')\\r\\n| extend attributes = pack(\\"Identifier\\", cveId, \\"Severity\\", severity, \\"CVSS Score\\", cvssScore, \\"Published\\", published, \\"Last Modified\\", lastModified, \\"Update Available\\", securityUpdateAvailable, \\"Exploitability Level\\", exploitabilityLevel, \\"Exploit in Kit\\", exploitInKit, \\"Exploit Verified\\", exploitVerified, \\"Public Exploit\\", publicExploit)\\r\\n| mv-expand kind=array attributes\\r\\n| project Attribute = tostring(attributes[0]), tostring(Value = attributes[1]);\\r\\n\\r\\nlet q2 = MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| summarize deviceCount = count()\\r\\n| project Attribute = \'Affected Devices\', Value = tostring(deviceCount);\\r\\n\\r\\nlet q3 = MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| where vulnId == \'{parameterVulnId}\'\\r\\n| extend attributes = pack(\\"Recommended Security Update\\", iff(recommendedSecurityUpdate == \'\', \'No info available\', recommendedSecurityUpdate), \\"Recommended Security Update ID\\", iff(recommendedSecurityUpdateId == \'\', \'No info available\', recommendedSecurityUpdateId), \\"Recommended Security Update URL\\", iff(recommendedSecurityUpdateUrl == \'\', \'No info available\', recommendedSecurityUpdateUrl))\\r\\n| mv-expand kind=array attributes\\r\\n| project Attribute = tostring(attributes[0]), tostring(Value = attributes[1]);\\r\\n\\r\\nunion q1, q2, q3\\r\\n","size":0,"title":"Vulnerability Details","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"queryInformation"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| where vulnId == \'{parameterVulnId}\'\\r\\n| extend attributes = pack(\\"Device Name\\", deviceName, \\"Operating System\\", osPlatform, \\"OS Version\\", osVersion)\\r\\n| mv-expand kind=array attributes\\r\\n| project Attribute = attributes[0], Value = attributes[1]","size":4,"title":"Device Information","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"queryDeviceInformation"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| where vulnId == \'{parameterVulnId}\'\\r\\n| extend deviceUrl = strcat(\'https://security.microsoft.com/machines/\', deviceId, \'/overview\')\\r\\n| extend cveUrl = strcat(\'https://security.microsoft.com/vulnerabilities/vulnerability/\', cveId, \'/overview\')\\r\\n| extend softwareUrl = strcat(\'https://security.microsoft.com/vulnerability-management-inventories/applications/\', softwareVendor, \'-_-\', softwareName, \'/overview\')\\r\\n| extend attributes = pack(\\"Device\\", deviceUrl, \\"CVE\\", cveUrl, \\"Software Inventory\\", softwareUrl)\\r\\n| mv-expand kind=array attributes\\r\\n| project Location = attributes[0], URL = attributes[1]","size":4,"title":"Defender Links","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"URL","formatter":7,"formatOptions":{"linkTarget":"Url"}},{"columnMatch":"Value","formatter":7,"formatOptions":{"linkTarget":"Url"}}]},"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"queryDefenderLinks"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| where vulnId == \'{parameterVulnId}\'\\r\\n| extend attributes = pack(\\"Vendor\\", softwareVendor, \\"Name\\", softwareName, \\"Version\\", softwareVersion)\\r\\n| mv-expand kind=array attributes\\r\\n| project Attribute = attributes[0], Value = attributes[1]","size":4,"title":"Impacted Software","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"querySoftware"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMVulnerabilitiesByDevice_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where transactionId == \'{parameterSnapshotTime}\'\\r\\n| where vulnId == \'{parameterVulnId}\'\\r\\n| extend registryPaths = iif(array_length(registryPaths) == 0, todynamic(\'[\\"None\\"]\'), registryPaths)\\r\\n| mv-expand diskPaths\\r\\n| mv-expand registryPaths\\r\\n| extend evidence = pack(\\"Disk Path\\", diskPaths, \\"Registry Path\\", registryPaths)\\r\\n| mv-expand kind=array evidence\\r\\n| where evidence[1] != \'None\'\\r\\n| project Type = evidence[0], Value = evidence[1] ","size":4,"title":"Evidence","noDataMessage":"There is no evidence information at this time.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"Type","formatter":5},{"columnMatch":"Value","formatter":0,"formatOptions":{"customColumnWidthSetting":"80%"}}],"hierarchySettings":{"treeType":1,"groupBy":["Type"],"expandTopLevel":true}},"tileSettings":{"showBorder":false},"graphSettings":{"type":0}},"name":"queryEvidence"},{"type":12,"content":{"version":"NotebookGroup/1.0","groupType":"editable","title":"Exploits","items":[{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, exploitTypes) by cveId\\r\\n| mv-expand todynamic(exploitTypes)\\r\\n| project ExploitTypes = exploitTypes","size":4,"title":"Types","noDataMessage":"There is no exploit type information at this time.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"ExploitTypes","formatter":0,"formatOptions":{"customColumnWidthSetting":"100%"}}],"labelSettings":[{"columnId":"ExploitTypes","label":"Type"}]}},"customWidth":"30","name":"queryExploitsTypes"},{"type":3,"content":{"version":"KqlItem/1.0","query":"MDVMCVEKB_CL\\r\\n| where cveId == \'{parameterCveId}\'\\r\\n| where TimeGenerated > ago(730d)\\r\\n| summarize arg_max(TimeGenerated, exploitUris) by cveId\\r\\n| mv-expand todynamic(exploitUris)\\r\\n| project URL = exploitUris","size":1,"title":"References","noDataMessage":"There is no exploit reference information at this time.","queryType":0,"resourceType":"microsoft.operationalinsights/workspaces","crossComponentResources":["{parameterWorkspace}"],"gridSettings":{"formatters":[{"columnMatch":"URL","formatter":7,"formatOptions":{"linkTarget":"Url","customColumnWidthSetting":"100%"}}]},"tileSettings":{"titleContent":{},"leftContent":{"columnMatch":"URL"},"secondaryContent":{"columnMatch":"URL"},"showBorder":false}},"customWidth":"70","name":"queryExploits"}]},"name":"groupExploits"}]},"conditionalVisibility":{"parameterName":"parameterSource","comparison":"isEqualTo","value":"mdvm"},"name":"groupMDVM"}],"isLocked":false,"fallbackResourceIds":["azure monitor"]}'
    version: '1.0'
    sourceId: CVEDetailsWorkbookSourceId
    category: CVEDetailsWorkbookType
  }
}
