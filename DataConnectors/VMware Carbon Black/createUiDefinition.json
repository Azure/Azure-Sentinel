{
	"$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
	"handler": "Microsoft.Azure.CreateUIDef",
	"version": "0.1.2-preview",
	"parameters": {
		"config": {
			"isWizard": false,
			"basics": {
				"description": "",
				"subscription": {
					"resourceProviders": [
						"Microsoft.OperationsManagement/solutions",
						"Microsoft.OperationalInsights/workspaces/providers/alertRules",
						"Microsoft.Insights/workbooks",
						"Microsoft.Logic/workflows"
					]
				},
				"location": {
					"metadata": {
						"hidden": "Hiding location, we get it from the log analytics workspace"
					}
				},
				"resourceGroup": {
					"allowExisting": true
				}
			}
		},
		"basics": [
			{
				"name": "FunctionName",
				"type": "Microsoft.Common.TextBox",
				"label": "Function name",
				"toolTip": "The name of the function.",
				"defaultValue": "CarbonBlack",
				"constraints": {
					"required": true
				}
			},
			{
				"name": "WorkspaceId",
				"type": "Microsoft.Common.TextBox",
				"label": "Workspace Id",
				"toolTip": "WorkspaceId of the Sentinel workspace.",
				"defaultValue": "<workspaceId>",
				"constraints": {
					"required": true
				}
			},
			{
				"name": "WorkspaceKey",
				"type": "Microsoft.Common.TextBox",
				"label": "Workspace Key",
				"toolTip": "WorkspaceKey (primary key) of the Sentinel workspace.",
				"defaultValue": "<workspaceKey>",
				"constraints": {
					"required": true
				}
			},
			{
				"name": "LogTypes",
				"type": "Microsoft.Common.DropDown",
				"label": "Log Types",
				"placeholder": "",
				"defaultValue": "event",
				"toolTip": "",
				"multiselect": true,
				"selectAll": true,
				"filter": true,
				"filterPlaceholder": "Filter items ...",
				"multiLine": true,
				"defaultDescription": "Select log types...",
				"constraints": {
					"allowedValues": [
						{
							"label": "event",
							"description": "Supported with AWS S3",
							"value": "event"
						},
						{
							"label": "audit",
							"description": "Supported with API",
							"value": "audit"
						},
						{
							"label": "alert",
							"description": "Supported with SIEM API or AWS S3",
							"value": "alert"
						}
					],
					"required": true
				},
				"visible": true
			},
			{
				"name": "APICredentials",
				"type": "Microsoft.Common.Section",
				"label": "API Credentials",
				"elements": [
					{
						"name": "APIKey",
						"type": "Microsoft.Common.TextBox",
						"label": "API Key",
						"toolTip": "API Key",
						"defaultValue": "<apiKey>",
						"constraints": {
							"required": "[contains(basics('LogTypes'),'audit')]"
						}
					},
					{
						"name": "APIId",
						"type": "Microsoft.Common.TextBox",
						"label": "API Id",
						"toolTip": "API Id",
						"defaultValue": "<apiId>",
						"constraints": {
							"required": "[contains(basics('LogTypes'),'audit')]"
						}
					},
					{
						"name": "URI",
						"type": "Microsoft.Common.TextBox",
						"label": "Uri",
						"toolTip": "Uri",
						"defaultValue": "https://<API URL>",
						"constraints": {
							"required": "[contains(basics('LogTypes'),'audit')]"
						}
					}
				]
			},
			{
				"name": "SIEMAPICredentials",
				"type": "Microsoft.Common.Section",
				"label": "SIEM API Credentials",
				"elements": [
					{
						"name": "SIEMAPIKey",
						"type": "Microsoft.Common.TextBox",
						"label": "SIEM API Key",
						"toolTip": "SIEM API Key",
						"defaultValue": "",
						"constraints": {
							"required": "[and(contains(basics('LogTypes'),'alert'), or(equals(basics('S3BucketCredentials').s3BucketName,''),equals(basics('S3BucketCredentials').AWSAccessKeyId,''),equals(basics('S3BucketCredentials').AWSSecretAccessKey,'')))]"
						}
					},
					{
						"name": "SIEMAPIId",
						"type": "Microsoft.Common.TextBox",
						"label": "SIEM API Id",
						"toolTip": "SIEM API Id",
						"defaultValue": "",
						"constraints": {
							"required": "[and(contains(basics('LogTypes'),'alert'), or(equals(basics('S3BucketCredentials').s3BucketName,''),equals(basics('S3BucketCredentials').AWSAccessKeyId,''),equals(basics('S3BucketCredentials').AWSSecretAccessKey,'')))]"
						}
					},
					{
						"name": "TimeInterval",
						"type": "Microsoft.Common.TextBox",
						"label": "Time Interval",
						"toolTip": "Time Interval",
						"defaultValue": "5",
						"constraints": {
							"required": "[and(contains(basics('LogTypes'),'alert'), or(equals(basics('S3BucketCredentials').s3BucketName,''),equals(basics('S3BucketCredentials').AWSAccessKeyId,''),equals(basics('S3BucketCredentials').AWSSecretAccessKey,'')))]"
						}
					}
				]
			},
			{
				"name": "S3BucketCredentials",
				"type": "Microsoft.Common.Section",
				"label": "AWS S3 Bucket Credentials",
				"elements": [
					{
						"name": "CarbonBlackOrgKey",
						"type": "Microsoft.Common.TextBox",
						"label": "Carbon Black Org Key",
						"constraints": {
							"required": "[or(contains(basics('LogTypes'),'event'), and(contains(basics('LogTypes'),'alert'),or(equals(basics('SIEMAPICredentials').SIEMAPIKey,''),equals(basics('SIEMAPICredentials').SIEMAPIId,''))))]"
						}
					},
					{
						"name": "s3BucketName",
						"type": "Microsoft.Common.TextBox",
						"label": "S3 Bucket Name",
						"constraints": {
							"required": "[or(contains(basics('LogTypes'),'event'), and(contains(basics('LogTypes'),'alert'),or(equals(basics('SIEMAPICredentials').SIEMAPIKey,''),equals(basics('SIEMAPICredentials').SIEMAPIId,''))))]"
						}
					},
					{
						"name": "AWSAccessKeyId",
						"type": "Microsoft.Common.TextBox",
						"label": "AWS Access Key Id",
						"constraints": {
							"required": "[or(contains(basics('LogTypes'),'event'), and(contains(basics('LogTypes'),'alert'),or(equals(basics('SIEMAPICredentials').SIEMAPIKey,''),equals(basics('SIEMAPICredentials').SIEMAPIId,''))))]"
						}
					},
					{
						"name": "AWSSecretAccessKey",
						"type": "Microsoft.Common.TextBox",
						"label": "AWS Secret Access Key",
						"constraints": {
							"required": "[or(contains(basics('LogTypes'),'event'), and(contains(basics('LogTypes'),'alert'),or(equals(basics('SIEMAPICredentials').SIEMAPIKey,''),equals(basics('SIEMAPICredentials').SIEMAPIId,''))))]"
						}
					}
				],
				"visible": true
			}
		],
		"steps": [],
		"outputs": {
			"FunctionName": "[basics('FunctionName')]",
			"WorkspaceId": "[basics('WorkspaceId')]",
			"WorkspaceKey": "[basics('WorkspaceKey')]",
			"CarbonBlackLogTypes": "[basics('LogTypes')]",
			"APIKey": "[basics('APICredentials').APIKey]",
			"APIId": "[basics('APICredentials').APIId]",
			"Uri": "[basics('APICredentials').URI]",
			"SIEMApiKey": "[basics('SIEMAPICredentials').SIEMAPIKey]",
			"SIEMApiID": "[basics('SIEMAPICredentials').SIEMAPIId]",
			"TimeInterval": "[basics('SIEMAPICredentials').TimeInterval]",
			"CarbonBlackOrgKey": "[basics('S3BucketCredentials').CarbonBlackOrgKey]",
			"s3BucketName": "[basics('S3BucketCredentials').s3BucketName]",
			"AWSAccessKeyId": "[basics('S3BucketCredentials').AWSAccessKeyId]",
			"AWSSecretAccessKey": "[basics('S3BucketCredentials').AWSSecretAccessKey]"
		}
	}
}
