{
  "contentVersion": "1.0.0.0",
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "CloudGen WAN Service Workbook",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/9c7ebab4-5981-4c1c-a8bf-c1c60162fc34/resourceGroups/fbu-cgwan-vwan-rg/providers/Microsoft.OperationalInsights/workspaces/fbu-logAna",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region to deploy"
      }
    }
  },
  "variables": {
    "workbookContent": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "# CloudGen WAN Service Workbook\r\n",
            "style": "upsell"
          },
          "name": "text - 3"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "nav",
            "links": [
              {
                "id": "94d16ff9-c560-4019-9218-1a1c308183e8",
                "cellValue": "https://cloudgenwan.barracudanetworks.com/#/login",
                "linkTarget": "Url",
                "linkLabel": "CloudGen WAN Portal",
                "preText": "",
                "postText": "",
                "style": "link"
              }
            ]
          },
          "name": "links - 7"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "links": [
              {
                "id": "e7576bf4-2d6f-47dd-8be2-72aabcf319d1",
                "cellValue": "selectedTab",
                "linkTarget": "parameter",
                "linkLabel": "Overview",
                "subTarget": "overview",
                "style": "link"
              },
              {
                "id": "e57367fc-19d9-4e4e-95b4-1e9a6e31319b",
                "cellValue": "selectedTab",
                "linkTarget": "parameter",
                "linkLabel": "Gateways",
                "subTarget": "Gateways",
                "style": "link"
              },
              {
                "id": "42507a16-cf0b-407a-960a-7022d8d3bf53",
                "cellValue": "selectedTab",
                "linkTarget": "parameter",
                "linkLabel": "Sites",
                "subTarget": "Sites",
                "style": "link"
              },
              {
                "id": "343dcda6-5cbf-42b7-9d5e-2a5553ecf61e",
                "cellValue": "selectedTab",
                "linkTarget": "parameter",
                "linkLabel": "User",
                "subTarget": "User",
                "style": "link"
              },
              {
                "id": "f26f54f4-e067-4b8a-af85-d832e9bfe89e",
                "cellValue": "selectedTab",
                "linkTarget": "parameter",
                "linkLabel": "SD-WAN",
                "subTarget": "Sdwan",
                "style": "link"
              }
            ]
          },
          "name": "links - 0"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Overview",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "546c8ec1-0e51-4421-b854-f65d69f693e9",
                      "version": "KqlParameterItem/1.0",
                      "name": "SiteDevice",
                      "type": 5,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "Perf\r\n| where InstanceName ==  \"BNGF\" and Computer !contains \"cudanva-\" and TimeGenerated > ago(30d)\r\n | distinct Computer\r\n",
                      "typeSettings": {
                        "additionalResourceOptions": [
                          "value::all"
                        ],
                        "showDefault": false
                      },
                      "defaultValue": "value::all",
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "3d018838-9db1-4b95-b082-2fc32a2e6c7d",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeFrame",
                      "type": 4,
                      "value": {
                        "durationMs": 3600000
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 300000
                          },
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 14400000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 172800000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 1209600000
                          },
                          {
                            "durationMs": 2419200000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 5184000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 4"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf | where TimeGenerated > now() - 30d and TimeGenerated < now() and Computer in~ ({SiteDevice}) and ObjectName == \"Load\" | summarize heartbeat_per_hour=count() by bin_at(TimeGenerated, 1h, now() - 30d), Computer | extend available_per_hour=iff(heartbeat_per_hour>0, true, false) | summarize total_available_hours=countif(available_per_hour==true) by Computer | extend total_number_of_buckets=round((now()-(now() - 30d))/1h)+1 | extend availability_rate=round(total_available_hours*100/total_number_of_buckets,2) | project Computer, availability_rate",
                  "size": 1,
                  "title": "CloudGen WAN Device Availabilty (30Days)",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "total_available_hours",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "total_number_of_buckets",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "availability_rate",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      }
                    ],
                    "filter": true,
                    "labelSettings": [
                      {
                        "columnId": "availability_rate",
                        "label": "% Available"
                      }
                    ]
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "availability_rate",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 1,
                        "options": {
                          "style": "decimal",
                          "maximumFractionDigits": 2,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "showBorder": true,
                    "sortCriteriaField": "Computer",
                    "sortOrderField": 1,
                    "size": "auto"
                  },
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "availability_rate",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "name": "availability",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n| where host in~ ({SiteDevice}) | project TimeGenerated, host, toint(latencyavg), toint(latencymax), toint(latencymin), toint(bwdownmax), toint(bwupmax)\r\n| summarize  Max = round(max(latencymax),1), Min = round(min(latencymin),1), Average = round(avg(latencyavg),1), DMMbps = max(bwdownmax/1000), UPMbps = max(bwupmax/1000), DMKB = max(bwdownmax/8), UMKB = max(bwupmax/8)   by host\r\n//divide by 1000 to get Mbps, by 8 to get kilobytes ",
                  "size": 1,
                  "aggregation": 2,
                  "title": "CloudGen WAN Site Performance Summary (1h)",
                  "timeContext": {
                    "durationMs": 3600000
                  },
                  "exportFieldName": "latencyhost",
                  "exportParameterName": "host",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "table",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "Max",
                        "formatter": 0,
                        "formatOptions": {
                          "aggregation": "Max"
                        }
                      },
                      {
                        "columnMatch": "DMMbps",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      },
                      {
                        "columnMatch": "DMKB",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 46,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      {
                        "columnMatch": "UMKB",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 46,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      },
                      {
                        "columnMatch": "DM",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 12,
                          "options": {
                            "style": "decimal",
                            "useGrouping": false
                          }
                        }
                      },
                      {
                        "columnMatch": "UM",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 12,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      }
                    ],
                    "sortBy": [
                      {
                        "itemKey": "host",
                        "sortOrder": 2
                      }
                    ],
                    "labelSettings": [
                      {
                        "columnId": "Max",
                        "label": "Latency (Max)"
                      },
                      {
                        "columnId": "Min",
                        "label": "(Min)"
                      },
                      {
                        "columnId": "Average",
                        "label": "(Avg.)"
                      },
                      {
                        "columnId": "DMMbps",
                        "label": "Download Max (Mbps)"
                      },
                      {
                        "columnId": "UPMbps",
                        "label": "Upload Max (Mbps)"
                      },
                      {
                        "columnId": "DMKB",
                        "label": "Download Max (MB/s)"
                      },
                      {
                        "columnId": "UMKB",
                        "label": "Upload Max (MB/s)"
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "host",
                      "sortOrder": 2
                    }
                  ],
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "host",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "Max",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    },
                    "nodeIdField": "host",
                    "sourceIdField": "TimeGenerated",
                    "targetIdField": "Avg",
                    "graphOrientation": 3,
                    "showOrientationToggles": false,
                    "staticNodeSize": 100,
                    "hivesMargin": 5
                  },
                  "chartSettings": {
                    "xAxis": "TimeGenerated",
                    "showDataPoints": true,
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 23,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "name": "Site Statistics",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf | where ObjectName == \"Site_to_site_VPN_Tunnels_Up\" | where Computer in ({SiteDevice}) and Computer !contains \"nva-gw\" | project-rename Status = ObjectName | project-rename Firewall = Computer | summarize AggregatedValue = round(avg(CounterValue),1) by Firewall, Status | project-rename Qty = AggregatedValue",
                  "size": 1,
                  "title": "Up WAN connections by Device",
                  "color": "green",
                  "noDataMessage": "0",
                  "noDataMessageStyle": 4,
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "graph",
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "TableName",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "Count",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    },
                    "showBorder": false,
                    "rowLimit": 1
                  },
                  "graphSettings": {
                    "type": 2,
                    "topContent": {
                      "columnMatch": "Firewall",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "Qty",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "style": "decimal",
                          "maximumFractionDigits": 0,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "nodeIdField": "Firewall",
                    "graphOrientation": 3,
                    "showOrientationToggles": false,
                    "staticNodeSize": 100,
                    "colorSettings": {
                      "nodeColorField": "Qty",
                      "type": 3,
                      "thresholdsGrid": [
                        {
                          "operator": ">",
                          "thresholdValue": "1",
                          "representation": "green"
                        },
                        {
                          "operator": "<",
                          "thresholdValue": "1",
                          "representation": "redBright"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "greenDark"
                        }
                      ]
                    },
                    "hivesMargin": 5
                  },
                  "mapSettings": {
                    "locInfo": "LatLong",
                    "sizeSettings": "Qty",
                    "sizeAggregation": "Sum",
                    "legendMetric": "Qty",
                    "legendAggregation": "Sum",
                    "itemColorSettings": {
                      "type": "heatmap",
                      "colorAggregation": "Sum",
                      "nodeColorField": "Qty",
                      "heatmapPalette": "greenRed"
                    }
                  }
                },
                "customWidth": "50",
                "showPin": true,
                "name": "WANbyDevice",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 1,
                "content": {
                  "json": "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n12/01/2021 Added SDWAN Graphs\r\n\r\n\r\n\r\n\r\n\r\n",
                  "style": "info"
                },
                "name": "text - 1"
              },
              {
                "type": 1,
                "content": {
                  "json": "05/09/2022 Changed availability from Heartbeat to Perf",
                  "style": "info"
                },
                "name": "text - 7"
              },
              {
                "type": 1,
                "content": {
                  "json": "12/02/2021 Added TimeRange",
                  "style": "info"
                },
                "name": "text - 2"
              },
              {
                "type": 1,
                "content": {
                  "json": "version 0.5.1\r\nFelix Bueltmann",
                  "style": "upsell"
                },
                "name": "text - 5"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "selectedTab",
            "comparison": "isEqualTo",
            "value": "overview"
          },
          "name": "Overview",
          "styleSettings": {
            "showBorder": true
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "User",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "396342bb-be82-4c3a-828f-a1f2b91d7de6",
                      "version": "KqlParameterItem/1.0",
                      "name": "User",
                      "type": 2,
                      "query": "CommonSecurityLog\r\n| where  SourceUserName != \"\"\r\n| distinct SourceUserName\r\n",
                      "value": null,
                      "typeSettings": {
                        "showDefault": false
                      },
                      "timeContext": {
                        "durationMs": 2592000000
                      },
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "2cf10227-44f3-4b07-93fc-bc7eeaf3a717",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeRange",
                      "type": 4,
                      "value": {
                        "durationMs": 3600000
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 300000
                          },
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 1"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog\r\n| where  SourceUserName == '{User}' and Activity == \"Activity\"\r\n| parse AdditionalExtensions with * \"reason=\" Reason \";cat=\" Category \";trafficType=\" TrafficType \";deviceCustomString1=\" RuleName \";duration=\" Duration \";inPkts=\" ReceivedPackets \";outPkts=\" SentPackets \";protocol=\" Protocol \";application=\" Application \";target=\" Target \";content=\" Content\r\n| where Application != \"\"\r\n| summarize count() by Application\r\n| take 10",
                  "size": 0,
                  "title": "Top Applications",
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "piechart"
                },
                "customWidth": "50",
                "name": "query - 0",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog\r\n| where  SourceUserName == '{User}' and Activity == \"Activity\"\r\n| parse AdditionalExtensions with * \"reason=\" Reason \";cat=\" Category \";trafficType=\" TrafficType \";deviceCustomString1=\" RuleName \";duration=\" Duration \";inPkts=\" ReceivedPackets \";outPkts=\" SentPackets \";protocol=\" Protocol \";application=\" Application \";target=\" Target \";content=\" Content\r\n| where Category != \"\"\r\n| summarize count() by Category\r\n| take 10\r\n",
                  "size": 0,
                  "title": "Top Category",
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "piechart"
                },
                "customWidth": "50",
                "name": "query - 2",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog\r\n| where  SourceUserName == '{User}' and Activity == \"Activity\" \r\n| parse AdditionalExtensions with * \"reason=\" Reason \";cat=\" Category \";trafficType=\" TrafficType \";deviceCustomString1=\" RuleName \";duration=\" Duration \";inPkts=\" ReceivedPackets \";outPkts=\" SentPackets \";protocol=\" Protocol \";application=\" Application \";target=\" Target \";content=\" Content\r\n|where SimplifiedDeviceAction == \"Block\" or Reason == \"URL Domain Explicitly not Allowed by URL Categorization Policy\"\r\n| where TrafficType == \"IPRX\" or TrafficType == \"IFWD\" and SimplifiedDeviceAction != \"Remove\" and SimplifiedDeviceAction != \"Normal Operation\"\r\n| project  TimeGenerated,Computer,  SourceUserName, SourceIP, Reason, Category, Protocol, Application, Target, Content\r\n| order by TimeGenerated desc\r\n| take 100",
                  "size": 0,
                  "title": "Last 100 blocked connections",
                  "timeContextFromParameter": "TimeRange",
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "table",
                  "showExpandCollapseGrid": true,
                  "gridSettings": {
                    "rowLimit": 100,
                    "filter": true,
                    "sortBy": [
                      {
                        "itemKey": "Computer",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "Computer",
                      "sortOrder": 1
                    }
                  ]
                },
                "name": "query - 4",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog\r\n| where  SourceUserName == '{User}' and Activity == \"Activity\" \r\n| parse AdditionalExtensions with * \"reason=\" Reason \";cat=\" Category \";trafficType=\" TrafficType \";deviceCustomString1=\" RuleName \";duration=\" Duration \";inPkts=\" ReceivedPackets \";outPkts=\" SentPackets \";protocol=\" Protocol \";application=\" Application \";target=\" Target \";content=\" Content\r\n//|where SimplifiedDeviceAction == \"Block\" or Reason == \"URL Domain Explicitly not Allowed by URL Categorization Policy\"\r\n| where TrafficType == \"IPRX\" or TrafficType == \"IFWD\" and SimplifiedDeviceAction != \"Remove\" and SimplifiedDeviceAction != \"Normal Operation\"\r\n| project  Action = SimplifiedDeviceAction, TimeGenerated,Computer,  SourceUserName, SourceIP, DestinationIP, DestinationPort,  Reason, Category, Protocol, Application, Target, Content\r\n| order by TimeGenerated desc\r\n//| take 100",
                  "size": 0,
                  "title": "Recent Connections",
                  "timeContextFromParameter": "TimeRange",
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "gridSettings": {
                    "rowLimit": 500,
                    "filter": true,
                    "sortBy": [
                      {
                        "itemKey": "Category",
                        "sortOrder": 2
                      }
                    ]
                  },
                  "sortBy": [
                    {
                      "itemKey": "Category",
                      "sortOrder": 2
                    }
                  ]
                },
                "name": "query - 4",
                "styleSettings": {
                  "showBorder": true
                }
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "selectedTab",
            "comparison": "isEqualTo",
            "value": "User"
          },
          "name": "group - 1",
          "styleSettings": {
            "showBorder": true
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Sites",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "f1c9192c-1915-4fdd-b546-31a262493146",
                      "version": "KqlParameterItem/1.0",
                      "name": "SiteDevices",
                      "label": "Sites",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "Heartbeat | where ComputerEnvironment == \"Non-Azure\" or Computer contains \"nva-gw\" and TimeGenerated > ago(1h)\r\n | distinct Computer",
                      "value": [
                        "Frankfurt",
                        "Baltimore"
                      ],
                      "typeSettings": {
                        "showDefault": false
                      },
                      "timeContext": {
                        "durationMs": 86400000
                      },
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "807816ed-ac54-4852-8865-bef12c1f35cd",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeFrame",
                      "type": 4,
                      "value": {
                        "durationMs": 3600000
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 300000
                          },
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 14400000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 172800000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 1209600000
                          },
                          {
                            "durationMs": 2419200000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 5184000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 0"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf | where Computer in~ ({SiteDevices})  | where (ObjectName == \"Load\") | summarize sum(CounterValue) by Computer, bin(TimeGenerated, 5m) ",
                  "size": 1,
                  "aggregation": 2,
                  "title": "Load over time",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "areachart",
                  "tileSettings": {
                    "showBorder": false,
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "sum_CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "name": "Load over time",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "union Perf | where Computer in~ ({SiteDevices}) and ObjectName == \"temperature\" and TimeGenerated > now() -  120s and TimeGenerated < now()|  where CounterName == \"System_Temperature.value\"  | distinct Computer, CounterValue",
                  "size": 1,
                  "title": "CGW Site Device Temperature (Celsius)",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "total_available_hours",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "total_number_of_buckets",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "availability_rate",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      }
                    ],
                    "filter": true,
                    "labelSettings": [
                      {
                        "columnId": "availability_rate",
                        "label": "% Available"
                      }
                    ]
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 0,
                        "options": {
                          "style": "decimal",
                          "maximumFractionDigits": 2,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "showBorder": true,
                    "sortCriteriaField": "Computer",
                    "sortOrderField": 1,
                    "size": "auto"
                  },
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "availability_rate",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "availability - Copy",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "union Perf | where Computer in~ ({SiteDevices}) and ObjectName == \"temperature\" and TimeGenerated > now() -  120s and TimeGenerated < now()\r\n|  where CounterName == \"CPU_Temperature.value\"  | distinct Computer, CounterValue",
                  "size": 1,
                  "title": "CGW Site CPU Temperature (Celsius)",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "total_available_hours",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "total_number_of_buckets",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "availability_rate",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      }
                    ],
                    "filter": true,
                    "labelSettings": [
                      {
                        "columnId": "availability_rate",
                        "label": "% Available"
                      }
                    ]
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 0,
                        "options": {
                          "style": "decimal",
                          "useGrouping": false,
                          "maximumFractionDigits": 2,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "showBorder": true,
                    "sortCriteriaField": "Computer",
                    "sortOrderField": 1,
                    "size": "auto"
                  },
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "availability_rate",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "availability - Copy",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n| where Computer in~ ({SiteDevices})\r\n| distinct Computer, DeviceVersion\r\n",
                  "size": 0,
                  "title": "Firmware  Version",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "showRefreshButton": true,
                  "showExportToExcel": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "table",
                  "gridSettings": {
                    "rowLimit": 10,
                    "filter": true
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer"
                    },
                    "leftContent": {
                      "columnMatch": "DeviceVersion",
                      "numberFormat": {
                        "unit": 0,
                        "options": {
                          "style": "decimal",
                          "useGrouping": false
                        }
                      }
                    },
                    "showBorder": true
                  }
                },
                "customWidth": "50",
                "name": "Firmware  Version",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "union Perf \r\n| where Computer in~ ({SiteDevices}) and ObjectName == \"Memory\" and TimeGenerated > now() -  60s and TimeGenerated < now()\r\n|  where CounterName == \"Available MBytes Memory\"  \r\n| distinct Computer, CounterValue",
                  "size": 1,
                  "title": "Free Memory",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "gridSettings": {
                    "formatters": [
                      {
                        "columnMatch": "total_available_hours",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "total_number_of_buckets",
                        "formatter": 5
                      },
                      {
                        "columnMatch": "availability_rate",
                        "formatter": 0,
                        "numberFormat": {
                          "unit": 1,
                          "options": {
                            "style": "decimal"
                          }
                        }
                      }
                    ],
                    "filter": true,
                    "labelSettings": [
                      {
                        "columnId": "availability_rate",
                        "label": "% Available"
                      }
                    ]
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 4,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true,
                          "maximumFractionDigits": 2,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "showBorder": true,
                    "sortCriteriaField": "Computer",
                    "sortOrderField": 1,
                    "size": "auto"
                  },
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "centerContent": {
                      "columnMatch": "availability_rate",
                      "formatter": 1,
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "availability - Copy",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog \r\n| where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n| where host in~ ({SiteDevices}) and host !contains \"cudanva-gw\" | project toint(bwdownavg), toint(bwupavg), host, TimeGenerated | \r\nsummarize avg(bwdownavg/8), avg(bwupavg/8) by host ",
                  "size": 0,
                  "aggregation": 5,
                  "title": "Latest WAN Bandwidth Measurement",
                  "timeContextFromParameter": "TimeFrame",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "unstackedbar",
                  "chartSettings": {
                    "xAxis": "host",
                    "seriesLabelSettings": [
                      {
                        "seriesName": "avg_",
                        "label": "Download",
                        "color": "green"
                      },
                      {
                        "seriesName": "avg_1",
                        "label": "Upload",
                        "color": "greenDark"
                      }
                    ],
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 46,
                        "options": {
                          "style": "decimal",
                          "useGrouping": false
                        },
                        "missingSparkDataOption": "Zero"
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "WANBandwidth",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "union Perf | where Computer in~ ({SiteDevices})| where ObjectName == \"Connections_New\"",
                  "size": 0,
                  "title": "New Connections",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "timechart"
                },
                "customWidth": "50",
                "name": "query - 7",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf| where Computer in~ ({SiteDevices})  and ObjectName == \"Site_to_site_VPN_Tunnels_Up\" and TimeGenerated > now() - 260s and TimeGenerated < now() \r\n|where CounterName == \"Site_to_site_VPN_Tunnels_Up.value\"\r\n| distinct Computer, CounterValue",
                  "size": 0,
                  "title": "VPN Tunnels UP",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "gridSettings": {
                    "filter": true
                  },
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "style": "decimal",
                          "maximumFractionDigits": 2,
                          "maximumSignificantDigits": 3
                        }
                      }
                    },
                    "showBorder": false
                  }
                },
                "customWidth": "50",
                "name": "query - 1",
                "styleSettings": {
                  "showBorder": true
                }
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "selectedTab",
            "comparison": "isEqualTo",
            "value": "Sites"
          },
          "name": "Sites",
          "styleSettings": {
            "showBorder": true
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "SD-WAN",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "372ed53f-f892-4991-b6c6-1c108cd201ad",
                      "version": "KqlParameterItem/1.0",
                      "name": "SiteDevice",
                      "label": "Sites",
                      "type": 2,
                      "isRequired": true,
                      "query": "Heartbeat | where ComputerEnvironment == \"Non-Azure\" or Computer contains \"nva-gw\" and TimeGenerated > ago(1h)\r\n | distinct Computer",
                      "value": "Frankfurt",
                      "typeSettings": {
                        "showDefault": false
                      },
                      "timeContext": {
                        "durationMs": 86400000
                      },
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "600233e4-819d-4cc2-b4e7-cd479c9f93c4",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeFrame",
                      "type": 4,
                      "isRequired": true,
                      "value": {
                        "durationMs": 3600000
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 300000
                          },
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 14400000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 172800000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 1209600000
                          },
                          {
                            "durationMs": 2419200000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 5184000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 0 - Copy"
              },
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "18c45ebd-f05f-4f5d-9f0e-e896959bf9c3",
                      "version": "KqlParameterItem/1.0",
                      "name": "Transport",
                      "type": 2,
                      "isRequired": true,
                      "query": "CommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n | where host ==   '{SiteDevice}' \r\n| distinct tunnel",
                      "value": "FW2FW-wanhub-48309da4-0fa3-42b1-953e-b1b5ea165d29",
                      "typeSettings": {
                        "showDefault": false
                      },
                      "timeContext": {
                        "durationMs": 86400000
                      },
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 4"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "CommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n | where host ==  '{SiteDevice}' and tunnel == '{Transport}'\r\n| project TimeGenerated, host, toint(latencyavg), toint(latencymax), toint(latencymin) \r\n| summarize  latency = arg_max(latencymin, latencyavg) by bin(TimeGenerated, 2m) ",
                  "size": 0,
                  "title": "Latency",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "areachart",
                  "graphSettings": {
                    "type": 0
                  },
                  "chartSettings": {
                    "seriesLabelSettings": [
                      {
                        "seriesName": "latencyavg",
                        "label": "Latency",
                        "color": "blue"
                      }
                    ],
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 23,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true,
                          "maximumFractionDigits": 1
                        }
                      }
                    }
                  }
                },
                "name": "query - 1",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "\r\n\r\nCommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n| where host == '{SiteDevice}' and Activity == \"SdWanData\" //and Computer contains \"cudanva-a4ca4vleunpzy\"\r\n|  parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax\r\n|project TimeGenerated, host,  ingress=((toint(useupstdavg)  + toint(useupndavg))/8) //egress=(toint(usedownstdavg)+ toint(usedownndavg)),\r\n\r\n\r\n\r\n",
                  "size": 0,
                  "showAnnotations": true,
                  "title": "Download Bandwidth Utilisation",
                  "color": "orange",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "areachart",
                  "chartSettings": {
                    "customThresholdLineStyle": 1,
                    "showDataPoints": true,
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 46,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true,
                          "maximumFractionDigits": 1
                        }
                      }
                    }
                  }
                },
                "name": "query - 2",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "\r\n\r\nCommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\r\n| where host == '{SiteDevice}' and Activity == \"SdWanData\" //and Computer contains \"cudanva-a4ca4vleunpzy\"\r\n|  parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax\r\n|project TimeGenerated, host,  egress=((toint(usedownstdavg) + toint(usedownndavg))/8)\r\n",
                  "size": 0,
                  "showAnnotations": true,
                  "title": "Upstream Bandwidth Utilisation",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "areachart",
                  "chartSettings": {
                    "showDataPoints": true,
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 46,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true,
                          "maximumFractionDigits": 1
                        }
                      }
                    }
                  }
                },
                "name": "query - 3",
                "styleSettings": {
                  "showBorder": true
                }
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "selectedTab",
            "comparison": "isEqualTo",
            "value": "Sdwan"
          },
          "name": "sdwan",
          "styleSettings": {
            "showBorder": true
          }
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "Gateways",
            "items": [
              {
                "type": 9,
                "content": {
                  "version": "KqlParameterItem/1.0",
                  "parameters": [
                    {
                      "id": "d08d86c5-6a57-4dd5-8373-dee857890c17",
                      "version": "KqlParameterItem/1.0",
                      "name": "Gateways",
                      "type": 2,
                      "isRequired": true,
                      "multiSelect": true,
                      "quote": "'",
                      "delimiter": ",",
                      "query": "Heartbeat | where  Computer contains \"cudanva\" and TimeGenerated > ago(1d)\r\n | distinct Computer",
                      "value": [
                        "cudanva-a4ca4vleunpzy000000",
                        "cudanva-a4ca4vleunpzy000001"
                      ],
                      "timeContext": {
                        "durationMs": 86400000
                      },
                      "queryType": 0,
                      "resourceType": "microsoft.operationalinsights/workspaces"
                    },
                    {
                      "id": "03302896-8943-4a29-97ed-80d692bce3af",
                      "version": "KqlParameterItem/1.0",
                      "name": "TimeFrame",
                      "type": 4,
                      "isRequired": true,
                      "value": {
                        "durationMs": 3600000
                      },
                      "typeSettings": {
                        "selectableValues": [
                          {
                            "durationMs": 900000
                          },
                          {
                            "durationMs": 1800000
                          },
                          {
                            "durationMs": 3600000
                          },
                          {
                            "durationMs": 14400000
                          },
                          {
                            "durationMs": 43200000
                          },
                          {
                            "durationMs": 86400000
                          },
                          {
                            "durationMs": 172800000
                          },
                          {
                            "durationMs": 259200000
                          },
                          {
                            "durationMs": 604800000
                          },
                          {
                            "durationMs": 1209600000
                          },
                          {
                            "durationMs": 2419200000
                          },
                          {
                            "durationMs": 2592000000
                          },
                          {
                            "durationMs": 5184000000
                          },
                          {
                            "durationMs": 7776000000
                          }
                        ],
                        "allowCustom": true
                      }
                    }
                  ],
                  "style": "pills",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                "name": "parameters - 1"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": " \nCommonSecurityLog | where DeviceEventClassID == 400 | parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax | where toint(nbsamples) >= 300\n| where host in~ ({Gateways}) and Activity == \"SdWanData\" //and Computer contains \"cudanva-a4ca4vleunpzy\"\n//| where Activity == \"SdWanData\" and Computer contains \"cudanva-a4ca4vleunpzy\"\n|  parse AdditionalExtensions with \"tunnel=\" tunnel \";host=\" host \";transpstate=\" transportstate \";tstamp=\" tstamp \";nbsamples=\" nbsamples \";bwupmin=\" bwupmin \";bwupavg=\" bwupavg \";bwupmax=\" bwupmax \";bwdownmin=\" bwdownmin \";bwdownavg=\" bwdownavg \";bwdownmax=\" bwdownmax \";latencymin=\" latencymin \";latencyavg=\" latencyavg \";latencymax=\" latencymax \";useupstdmin=\" useupstdmin \";useupstdavg=\" useupstdavg \";useupstdmax=\" useupstdmax \";usedownstdmin=\" usedownstdmin \";usedownstdavg=\" usedownstdavg \";usedownstdmax=\" usedownstdmax \";useupndmin=\"  useupndmin \";useupndavg=\" useupndavg \";useupndmax=\" useupndmax \";usedownndmin=\" usedownndmin \";usedownndavg=\" usedownndavg \";usedownndmax=\" usedownndmax\n//| summarize usedownstdavg=countif(usedownstdavg==true) by Computer\n//| where TimeGenerated > now() - 120m\n|project TimeGenerated, host, egress=(toint(usedownstdavg)+ toint(usedownndavg)), ingress=(toint(useupstdavg) + toint(useupndavg))\n\n//| distinct Computer, bwdownavg, bwupavg, usedownstdavg, useupstdavg, usedownndavg, useupndavg",
                  "size": 1,
                  "showAnnotations": true,
                  "title": "GW Throughput",
                  "timeContextFromParameter": "TimeFrame",
                  "showRefreshButton": true,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "areachart",
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer"
                    },
                    "leftContent": {
                      "columnMatch": "useupstdmax"
                    },
                    "rightContent": {
                      "columnMatch": "usedownstdmax"
                    },
                    "showBorder": false,
                    "size": "auto"
                  },
                  "graphSettings": {
                    "type": 0,
                    "topContent": {
                      "columnMatch": "Computer"
                    },
                    "centerContent": {
                      "columnMatch": "usedownstdavg"
                    },
                    "rightContent": {
                      "columnMatch": "usedownndavg"
                    },
                    "hivesContent": {
                      "columnMatch": "bwdownavg",
                      "formatter": 1
                    },
                    "nodeIdField": "useupstdavg",
                    "sourceIdField": "useupstdavg",
                    "targetIdField": "usedownstdavg",
                    "graphOrientation": 3,
                    "showOrientationToggles": false,
                    "staticNodeSize": 100,
                    "groupByField": "bwdownavg",
                    "hivesMargin": 5
                  },
                  "chartSettings": {
                    "showLegend": true,
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 46,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true,
                          "minimumFractionDigits": 1,
                          "maximumFractionDigits": 1
                        },
                        "missingSparkDataOption": "Average"
                      }
                    }
                  }
                },
                "showPin": true,
                "name": "GW Throughput",
                "styleSettings": {
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf| where Computer  in~ ({Gateways})  and ObjectName == \"Site_to_site_VPN_Tunnels_Up\" and TimeGenerated > now() - 260s and TimeGenerated < now() \r\n|where CounterName == \"Site_to_site_VPN_Tunnels_Up.value\"\r\n| distinct Computer, CounterValue",
                  "size": 0,
                  "title": "Connected sides",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    },
                    "showBorder": false,
                    "sortCriteriaField": "CounterValue",
                    "sortOrderField": 2,
                    "size": "full"
                  }
                },
                "customWidth": "30",
                "name": "query - 2",
                "styleSettings": {
                  "margin": "20px",
                  "padding": "20px",
                  "showBorder": true
                }
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "Perf| where Computer  in~ ({Gateways})  and ObjectName == \"Client_to_site_VPN_Tunnels\" and TimeGenerated > now() - 120s and TimeGenerated < now() \r\n|where CounterName == \"Client_to_site_VPN_Tunnels.value\"\r\n| distinct Computer, CounterValue\r\n\r\n",
                  "size": 0,
                  "title": "Connected Remote Clients",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "visualization": "tiles",
                  "tileSettings": {
                    "titleContent": {
                      "columnMatch": "Computer",
                      "formatter": 1
                    },
                    "leftContent": {
                      "columnMatch": "CounterValue",
                      "formatter": 12,
                      "formatOptions": {
                        "palette": "auto"
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "maximumSignificantDigits": 3,
                          "maximumFractionDigits": 2
                        }
                      }
                    },
                    "showBorder": false,
                    "sortCriteriaField": "CounterValue",
                    "size": "full"
                  }
                },
                "customWidth": "30",
                "name": "query - 3",
                "styleSettings": {
                  "margin": "20px",
                  "padding": "20px",
                  "showBorder": true
                }
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "selectedTab",
            "comparison": "isEqualTo",
            "value": "Gateways"
          },
          "name": "Gateways",
          "styleSettings": {
            "showBorder": true
          }
        }
      ],
      "isLocked": false,
      "fallbackResourceIds": [
        "/subscriptions/9c7ebab4-5981-4c1c-a8bf-c1c60162fc34/resourceGroups/fbu-cgwan-vwan-rg/providers/Microsoft.OperationalInsights/workspaces/fbu-logAna"
      ]
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[parameters('location')]",
      "apiVersion": "2021-03-08",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookContent'))]",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  }
}
